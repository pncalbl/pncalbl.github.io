<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>pncalbl</title>
    <link>https://pncalbl.github.io/</link>
    
    <image>
      <url>https://www.gravatar.com/avatar/a8fa4407c843fcd53fbcbe238a6dd153</url>
      <title>pncalbl</title>
      <link>https://pncalbl.github.io/</link>
    </image>
    
    <atom:link href="https://pncalbl.github.io/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description></description>
    <pubDate>Fri, 20 May 2022 18:29:23 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>MiniKube å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2022/05/21/MiniKube%E5%AD%A6%E4%B9%A0/</link>
      <guid>https://pncalbl.github.io/2022/05/21/MiniKube%E5%AD%A6%E4%B9%A0/</guid>
      <pubDate>Fri, 20 May 2022 17:40:56 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;MiniKube-å­¦ä¹ &quot;&gt;&lt;a href=&quot;#MiniKube-å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;MiniKube å­¦ä¹ &quot;&gt;&lt;/a&gt;MiniKube å­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;1-å®‰è£…-minikube&quot;&gt;&lt;a href=&quot;#1-å®‰è£…</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="MiniKube-å­¦ä¹ "><a href="#MiniKube-å­¦ä¹ " class="headerlink" title="MiniKube å­¦ä¹ "></a>MiniKube å­¦ä¹ </h1><h2 id="1-å®‰è£…-minikube"><a href="#1-å®‰è£…-minikube" class="headerlink" title="1 å®‰è£… minikube"></a>1 å®‰è£… minikube</h2><h3 id="1-1-é…ç½®-linux-ç¯å¢ƒ"><a href="#1-1-é…ç½®-linux-ç¯å¢ƒ" class="headerlink" title="1.1 é…ç½® linux ç¯å¢ƒ"></a>1.1 é…ç½® linux ç¯å¢ƒ</h3><p>æˆ‘ä½¿ç”¨çš„æ˜¯ Manjaroï¼ŒåŸå› æ˜¯å›¾å½¢ç•Œé¢ç¾è§‚ï¼Œæ“ä½œç®€ä¾¿ï¼Œæœ€é‡è¦çš„æ˜¯å…·æœ‰å¼ºå¤§çš„åŒ…ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥æ–¹ä¾¿çš„ä¸‹è½½å’Œå®‰è£… dockerï¼Œminikubeï¼Œkubectlï¼Œkubeadmï¼Œkubeletâ€¦ è€Œä¸”ä¼šè‡ªåŠ¨æ¥è¿‘åŒ…çš„ä¾èµ–é—®é¢˜ã€‚</p><h3 id="1-2-é…ç½®-docker-ç¯å¢ƒ"><a href="#1-2-é…ç½®-docker-ç¯å¢ƒ" class="headerlink" title="1.2 é…ç½® docker ç¯å¢ƒ"></a>1.2 é…ç½® docker ç¯å¢ƒ</h3><p>åŒä¸Šè¿°ï¼Œç®€å•çš„åœ¨ Manjaro çš„åŒ…ç®¡ç†å™¨ä¸‹è½½ dockerï¼Œç„¶åç®€å•é…ç½®é•œåƒå’Œ<em>Docker daemon</em>(ä¿æŒåå°æ°¸ä¹…è¿è¡Œï¼Œå°±ä¸å¿…æ¯æ¬¡é‡å¯æ­¤æœåŠ¡ï¼Œä¸ç„¶dockerä¸ä¼šæ‰§è¡Œä»»ä½•å‘½ä»¤ã€‚)</p><h3 id="1-3-å¯åŠ¨å•èŠ‚ç‚¹é›†ç¾¤"><a href="#1-3-å¯åŠ¨å•èŠ‚ç‚¹é›†ç¾¤" class="headerlink" title="1.3 å¯åŠ¨å•èŠ‚ç‚¹é›†ç¾¤"></a>1.3 å¯åŠ¨å•èŠ‚ç‚¹é›†ç¾¤</h3><div class="code-wrapper"><pre><code class="hljs k8s">minikube start</code></pre></div><h3 id="1-4-å¯åŠ¨å¤šèŠ‚ç‚¹é›†ç¾¤"><a href="#1-4-å¯åŠ¨å¤šèŠ‚ç‚¹é›†ç¾¤" class="headerlink" title="1.4 å¯åŠ¨å¤šèŠ‚ç‚¹é›†ç¾¤"></a>1.4 å¯åŠ¨å¤šèŠ‚ç‚¹é›†ç¾¤</h3><div class="code-wrapper"><pre><code class="hljs k8s">minikube start -p test #åˆ›å»ºä¸»é›†ç¾¤minikube node add -p test #å¢åŠ èŠ‚ç‚¹minikube node list -p test #æŸ¥çœ‹èŠ‚ç‚¹minikube dashboard -p test #å¯åŠ¨ä¸»èŠ‚ç‚¹ä»ªè¡¨ç›˜</code></pre></div>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Distributed/">Distributed</category>
      
      
      <category domain="https://pncalbl.github.io/tags/k8s/">k8s</category>
      
      <category domain="https://pncalbl.github.io/tags/minikube/">minikube</category>
      
      
      <comments>https://pncalbl.github.io/2022/05/21/MiniKube%E5%AD%A6%E4%B9%A0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸç¬¬11å‘¨æ€»ç»“</title>
      <link>https://pncalbl.github.io/2021/11/14/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC11%E5%91%A8%E6%80%BB%E7%BB%93/</link>
      <guid>https://pncalbl.github.io/2021/11/14/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC11%E5%91%A8%E6%80%BB%E7%BB%93/</guid>
      <pubDate>Sun, 14 Nov 2021 12:16:09 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬11å‘¨æ€»ç»“&quot;&gt;&lt;a href=&quot;#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬11å‘¨æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬11å‘¨æ€»ç»“&quot;&gt;&lt;/a&gt;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬11å‘¨æ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å­¦ä¹ &quot;&gt;&lt;</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬11å‘¨æ€»ç»“"><a href="#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬11å‘¨æ€»ç»“" class="headerlink" title="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬11å‘¨æ€»ç»“"></a>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬11å‘¨æ€»ç»“</h1><h2 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h2><ul><li>è®¡ç®—æœºè‹±è¯­çš„è¿›ä¸€æ­¥å­¦ä¹ ï¼ŒVerilog-FPGA çš„å®éªŒå’Œæ§åˆ¶é€»è¾‘ã€‚</li><li>åµŒå…¥å¼ç³»ç»Ÿçš„è¿›ä¸€æ­¥å­¦ä¹ ï¼Œæ•°æ®åº“çš„æˆæƒæ§åˆ¶çš„å­¦ä¹ ã€‚</li></ul><h2 id="é¡¹ç›®"><a href="#é¡¹ç›®" class="headerlink" title="é¡¹ç›®"></a>é¡¹ç›®</h2><ul><li>å®Œå–„æˆ‘çš„åšå®¢é¡¹ç›®ï¼Œè¿›ä¸€æ­¥ä¸°å¯Œåšå®¢çš„å†…å®¹ç”Ÿæ€ã€‚</li></ul><h2 id="æ‰¾å®ä¹ "><a href="#æ‰¾å®ä¹ " class="headerlink" title="æ‰¾å®ä¹ "></a>æ‰¾å®ä¹ </h2><ul><li>é¢è¯•äº†ä¸¤ä¸ªå…¬å¸</li></ul><h2 id="è¯»ä¹¦"><a href="#è¯»ä¹¦" class="headerlink" title="è¯»ä¹¦"></a>è¯»ä¹¦</h2><ul><li>é˜…è¯»ã€Šè½¯æŠ€èƒ½2ï¼šè½¯ä»¶å¼€å‘è€…èŒä¸šç”Ÿæ¶¯æŒ‡å—ã€‹ï¼Œã€Š Spark ç¼–ç¨‹åŸºç¡€ã€‹ï¼Œã€ŠSpring æºç æ·±åº¦è§£æã€‹ã€‚</li><li>é˜…è¯»ã€Šå¤ªé˜³ç…§å¸¸å‡èµ·ï¼‰ã€‹ï¼Œã€Š80å¤©ç¯æ¸¸åœ°çƒã€‹ï¼Œã€Šå®‰å¨œÂ·å¡åˆ—å°¼å¨œã€‹ã€‚</li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Weekly/">Weekly</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/11/14/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC11%E5%91%A8%E6%80%BB%E7%BB%93/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸç¬¬10å‘¨æ€»ç»“</title>
      <link>https://pncalbl.github.io/2021/11/07/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC10%E5%91%A8%E6%80%BB%E7%BB%93/</link>
      <guid>https://pncalbl.github.io/2021/11/07/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC10%E5%91%A8%E6%80%BB%E7%BB%93/</guid>
      <pubDate>Sat, 06 Nov 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬10å‘¨æ€»ç»“&quot;&gt;&lt;a href=&quot;#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬10å‘¨æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬10å‘¨æ€»ç»“&quot;&gt;&lt;/a&gt;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬10å‘¨æ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å­¦ä¹ &quot;&gt;&lt;</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬10å‘¨æ€»ç»“"><a href="#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬10å‘¨æ€»ç»“" class="headerlink" title="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬10å‘¨æ€»ç»“"></a>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬10å‘¨æ€»ç»“</h1><h2 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h2><ul><li>è®¡ç®—æœºè‹±è¯­çš„è¿›ä¸€æ­¥å­¦ä¹ ï¼ŒVerilog-FPGA çš„å®éªŒå’Œæ§åˆ¶é€»è¾‘ã€‚</li><li>åµŒå…¥å¼ç³»ç»Ÿçš„è¿›ä¸€æ­¥å­¦ä¹ ï¼Œæ•°æ®åº“çš„Viewæ§åˆ¶çš„å­¦ä¹ ã€‚</li></ul><h2 id="é¡¹ç›®"><a href="#é¡¹ç›®" class="headerlink" title="é¡¹ç›®"></a>é¡¹ç›®</h2><ul><li>å®Œå–„æˆ‘çš„åšå®¢é¡¹ç›®ï¼Œè¿›ä¸€æ­¥ä¸°å¯Œåšå®¢çš„å†…å®¹ç”Ÿæ€ã€‚</li><li>æŠ•é€’å®ä¹ ç®€å†ã€‚</li></ul><h2 id="è¯»ä¹¦"><a href="#è¯»ä¹¦" class="headerlink" title="è¯»ä¹¦"></a>è¯»ä¹¦</h2><ul><li>é˜…è¯»ã€Šè½¯æŠ€èƒ½2ï¼šè½¯ä»¶å¼€å‘è€…èŒä¸šç”Ÿæ¶¯æŒ‡å—ã€‹ï¼Œã€Š Spark ç¼–ç¨‹åŸºç¡€ã€‹ï¼Œã€ŠSpring æºç æ·±åº¦è§£æã€‹ã€‚</li><li>é˜…è¯»ã€Šå¤ªé˜³ç…§å¸¸å‡èµ·ï¼‰ã€‹ï¼Œã€Š80å¤©ç¯æ¸¸åœ°çƒã€‹ï¼Œã€Šå®‰å¨œÂ·å¡åˆ—å°¼å¨œã€‹ã€‚</li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Weekly/">Weekly</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/11/07/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC10%E5%91%A8%E6%80%BB%E7%BB%93/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸç¬¬9å‘¨æ€»ç»“</title>
      <link>https://pncalbl.github.io/2021/10/31/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC9%E5%91%A8%E6%80%BB%E7%BB%93/</link>
      <guid>https://pncalbl.github.io/2021/10/31/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC9%E5%91%A8%E6%80%BB%E7%BB%93/</guid>
      <pubDate>Sat, 30 Oct 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬9å‘¨æ€»ç»“&quot;&gt;&lt;a href=&quot;#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬9å‘¨æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬9å‘¨æ€»ç»“&quot;&gt;&lt;/a&gt;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬9å‘¨æ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å­¦ä¹ &quot;&gt;&lt;a hr</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬9å‘¨æ€»ç»“"><a href="#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬9å‘¨æ€»ç»“" class="headerlink" title="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬9å‘¨æ€»ç»“"></a>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬9å‘¨æ€»ç»“</h1><h2 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h2><ul><li>è®¡ç®—æœºè‹±è¯­çš„è¿›ä¸€æ­¥å­¦ä¹ ï¼ŒVerilog-FPGA çš„å®éªŒå’Œæ§åˆ¶é€»è¾‘ã€‚</li><li>åµŒå…¥å¼ç³»ç»Ÿçš„è¿›ä¸€æ­¥å­¦ä¹ ï¼Œæ•°æ®åº“çš„å®‰å…¨æ§åˆ¶çš„å­¦ä¹ ã€‚</li></ul><h2 id="é¡¹ç›®"><a href="#é¡¹ç›®" class="headerlink" title="é¡¹ç›®"></a>é¡¹ç›®</h2><ul><li>ç»§ç»­å®Œå–„ coin-exchange è´§å¸äº¤æ˜“å¹³å°ï¼Œä¼šå‘˜ç³»ç»Ÿçš„ç™»å½•åŠŸèƒ½å®ç°ã€‚</li><li>å®Œå–„æˆ‘çš„åšå®¢é¡¹ç›®ï¼Œè¿›ä¸€æ­¥ä¸°å¯Œåšå®¢çš„å†…å®¹ç”Ÿæ€ã€‚</li><li>æŠ•é€’å®ä¹ ç®€å†ã€‚</li></ul><h2 id="è¯»ä¹¦"><a href="#è¯»ä¹¦" class="headerlink" title="è¯»ä¹¦"></a>è¯»ä¹¦</h2><ul><li>é˜…è¯»ã€Šè½¯æŠ€èƒ½2ï¼šè½¯ä»¶å¼€å‘è€…èŒä¸šç”Ÿæ¶¯æŒ‡å—ã€‹ï¼Œã€Š Spark ç¼–ç¨‹åŸºç¡€ã€‹ï¼Œã€ŠSpring æºç æ·±åº¦è§£æã€‹ã€‚</li><li>é˜…è¯»ã€Šå¤ªé˜³ç…§å¸¸å‡èµ·ï¼‰ã€‹ï¼Œã€Š80å¤©ç¯æ¸¸åœ°çƒã€‹ï¼Œã€Šå®‰å¨œÂ·å¡åˆ—å°¼å¨œã€‹ã€‚</li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Weekly/">Weekly</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/10/31/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC9%E5%91%A8%E6%80%BB%E7%BB%93/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Spring æºç å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/</link>
      <guid>https://pncalbl.github.io/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/</guid>
      <pubDate>Thu, 28 Oct 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Spring-æºç å­¦ä¹ &quot;&gt;&lt;a href=&quot;#Spring-æºç å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;Spring æºç å­¦ä¹ &quot;&gt;&lt;/a&gt;Spring æºç å­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;ä¸€ã€æ­å»ºé˜…è¯»ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ­å»ºé˜…è¯»ç¯å¢ƒ&quot;</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Spring-æºç å­¦ä¹ "><a href="#Spring-æºç å­¦ä¹ " class="headerlink" title="Spring æºç å­¦ä¹ "></a>Spring æºç å­¦ä¹ </h1><h2 id="ä¸€ã€æ­å»ºé˜…è¯»ç¯å¢ƒ"><a href="#ä¸€ã€æ­å»ºé˜…è¯»ç¯å¢ƒ" class="headerlink" title="ä¸€ã€æ­å»ºé˜…è¯»ç¯å¢ƒ"></a>ä¸€ã€æ­å»ºé˜…è¯»ç¯å¢ƒ</h2><h3 id="1-æ‹‰å–æºç "><a href="#1-æ‹‰å–æºç " class="headerlink" title="1 æ‹‰å–æºç "></a>1 æ‹‰å–æºç </h3><p><img src="/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/image-20211029215505730-16355157103411.png" alt="image-20211029215505730"></p><h6 id="æ³¨æ„ï¼šGit-æ‹‰å–åç›´æ¥ç”¨-IDEA-æ‰“å¼€ï¼Œä¸è¦ç€æ€¥æ„å»ºé¡¹ç›®ï¼Œå…ˆé…ç½®å¥½-Gradleã€‚"><a href="#æ³¨æ„ï¼šGit-æ‹‰å–åç›´æ¥ç”¨-IDEA-æ‰“å¼€ï¼Œä¸è¦ç€æ€¥æ„å»ºé¡¹ç›®ï¼Œå…ˆé…ç½®å¥½-Gradleã€‚" class="headerlink" title="æ³¨æ„ï¼šGit æ‹‰å–åç›´æ¥ç”¨ IDEA æ‰“å¼€ï¼Œä¸è¦ç€æ€¥æ„å»ºé¡¹ç›®ï¼Œå…ˆé…ç½®å¥½ Gradleã€‚"></a>æ³¨æ„ï¼šGit æ‹‰å–åç›´æ¥ç”¨ IDEA æ‰“å¼€ï¼Œä¸è¦ç€æ€¥æ„å»ºé¡¹ç›®ï¼Œå…ˆé…ç½®å¥½ Gradleã€‚</h6><h3 id="2-é…ç½®-Gradle-å›½å†…é•œåƒåŠ é€Ÿ"><a href="#2-é…ç½®-Gradle-å›½å†…é•œåƒåŠ é€Ÿ" class="headerlink" title="2 é…ç½® Gradle å›½å†…é•œåƒåŠ é€Ÿ"></a>2 é…ç½® Gradle å›½å†…é•œåƒåŠ é€Ÿ</h3><p><img src="/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/image-20211029215614490.png" alt="image-20211029215614490"></p><p>é™¤äº†æ¡†å‡ºçš„é•œåƒï¼Œå…¶ä»–é•œåƒæœ‰ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æ²¡æœ‰æŸä¸ªç‰ˆæœ¬çš„ä¾èµ–ï¼Œä¸‹è½½é€Ÿåº¦è¿‡æ…¢ã€‚</p><h3 id="3-æ·»åŠ ç¼ºå¤±çš„-jar-åŒ…"><a href="#3-æ·»åŠ ç¼ºå¤±çš„-jar-åŒ…" class="headerlink" title="3 æ·»åŠ ç¼ºå¤±çš„ jar åŒ…"></a>3 æ·»åŠ ç¼ºå¤±çš„ jar åŒ…</h3><h4 id="ç¼ºå¤±åŸå› ï¼š"><a href="#ç¼ºå¤±åŸå› ï¼š" class="headerlink" title="ç¼ºå¤±åŸå› ï¼š"></a>ç¼ºå¤±åŸå› ï¼š</h4><blockquote><p>  ä¸ºäº†é¿å…ç¬¬ä¸‰æ–¹ class çš„å†²çªï¼ŒSpring æŠŠæœ€æ–°çš„ cglib å’Œ objenesis ç»™é‡æ–°æ‰“åŒ…ï¼ˆrepackï¼‰äº†ï¼Œå®ƒå¹¶æ²¡æœ‰åœ¨æºç é‡Œæä¾›è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œè€Œæ˜¯ç›´æ¥å°†å…¶æ”¾åœ¨ jar åŒ…å½“ä¸­ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†æˆ‘ä»¬æ‹‰å–ä»£ç åå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚é‚£ä¹ˆä¸ºäº†é€šè¿‡ç¼–è¯‘ï¼Œæˆ‘ä»¬è¦æŠŠç¼ºå¤±çš„ jarè¡¥å›æ¥ã€‚</p></blockquote><h6 id="éœ€è¦å°†-build-libs-spring-cglib-repack-3-3-0-jar-æ–‡ä»¶å¤åˆ¶åˆ°å¤–é¢-libs-ç›®å½•-éœ€è¦æ‰‹åŠ¨åˆ›å»º"><a href="#éœ€è¦å°†-build-libs-spring-cglib-repack-3-3-0-jar-æ–‡ä»¶å¤åˆ¶åˆ°å¤–é¢-libs-ç›®å½•-éœ€è¦æ‰‹åŠ¨åˆ›å»º" class="headerlink" title="éœ€è¦å°† build/libs/spring-cglib-repack-3.3.0.jar æ–‡ä»¶å¤åˆ¶åˆ°å¤–é¢ libs ç›®å½•( éœ€è¦æ‰‹åŠ¨åˆ›å»º)"></a>éœ€è¦å°† build/libs/spring-cglib-repack-3.3.0.jar æ–‡ä»¶å¤åˆ¶åˆ°å¤–é¢ libs ç›®å½•( éœ€è¦æ‰‹åŠ¨åˆ›å»º)</h6><p><img src="/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/image-20211030002259440-16355245815262.png" alt="image-20211030002259440"></p><h2 id="äºŒã€æµ‹è¯•-Spring"><a href="#äºŒã€æµ‹è¯•-Spring" class="headerlink" title="äºŒã€æµ‹è¯• Spring"></a>äºŒã€æµ‹è¯• Spring</h2><h3 id="1-æ–°å»º-spring-mytest-æµ‹è¯•æ¨¡å—"><a href="#1-æ–°å»º-spring-mytest-æµ‹è¯•æ¨¡å—" class="headerlink" title="1 æ–°å»º spring-mytest æµ‹è¯•æ¨¡å—"></a>1 æ–°å»º spring-mytest æµ‹è¯•æ¨¡å—</h3><p><img src="/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/image-20211030004737472.png" alt="image-20211030004737472"></p><h3 id="2-ç¼–å†™æµ‹è¯•ç±»å’Œ-xml-æ–‡ä»¶"><a href="#2-ç¼–å†™æµ‹è¯•ç±»å’Œ-xml-æ–‡ä»¶" class="headerlink" title="2 ç¼–å†™æµ‹è¯•ç±»å’Œ xml æ–‡ä»¶"></a>2 ç¼–å†™æµ‹è¯•ç±»å’Œ xml æ–‡ä»¶</h3><h4 id="2-1-å¯¼å…¥-spring-context-æ¨¡å—"><a href="#2-1-å¯¼å…¥-spring-context-æ¨¡å—" class="headerlink" title="2.1 å¯¼å…¥ spring-context æ¨¡å—"></a>2.1 å¯¼å…¥ spring-context æ¨¡å—</h4><p><img src="/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/image-20211030004812976.png" alt="image-20211030004812976"></p><h4 id="2-2-æ–°å»º-User-ç±»"><a href="#2-2-æ–°å»º-User-ç±»" class="headerlink" title="2.2 æ–°å»º User ç±»"></a>2.2 æ–°å»º User ç±»</h4><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pncalbl.test;<span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> pncalbl</span><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/10/30 0:35</span><span class="hljs-comment"> * <span class="hljs-doctag">@e</span>-mail pncalbl@qq.com</span><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><span class="hljs-comment"> **/</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;   <span class="hljs-keyword">private</span> String username;   <span class="hljs-keyword">private</span> String address;   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;      <span class="hljs-keyword">return</span> username;   &#125;   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;      <span class="hljs-keyword">this</span>.username = username;   &#125;   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAddress</span><span class="hljs-params">()</span> </span>&#123;      <span class="hljs-keyword">return</span> address;   &#125;   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAddress</span><span class="hljs-params">(String address)</span> </span>&#123;      <span class="hljs-keyword">this</span>.address = address;   &#125;   <span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +            <span class="hljs-string">&quot;username=&#x27;&quot;</span> + username + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +            <span class="hljs-string">&quot;, address=&#x27;&quot;</span> + address + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +            <span class="hljs-string">&#x27;&#125;&#x27;</span>;   &#125;&#125;</code></pre></div><h4 id="2-3-æ–°å»º-beans-xml-æ–‡ä»¶"><a href="#2-3-æ–°å»º-beans-xml-æ–‡ä»¶" class="headerlink" title="2.3 æ–°å»º beans.xml æ–‡ä»¶"></a>2.3 æ–°å»º beans.xml æ–‡ä»¶</h4><div class="code-wrapper"><pre><code class="hljs xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;       xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;       xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd&quot;&gt;      &lt;bean class&#x3D;&quot;com.pncalbl.test.User&quot; id&#x3D;&quot;user&quot;&gt;      &lt;property name&#x3D;&quot;address&quot; value&#x3D;&quot;www.pnca.com&quot;&#x2F;&gt;      &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;pncalbl&quot;&#x2F;&gt;   &lt;&#x2F;bean&gt;&lt;&#x2F;beans&gt;</code></pre></div><h4 id="2-4-æ–°å»ºæµ‹è¯•ç±»"><a href="#2-4-æ–°å»ºæµ‹è¯•ç±»" class="headerlink" title="2.4 æ–°å»ºæµ‹è¯•ç±»"></a>2.4 æ–°å»ºæµ‹è¯•ç±»</h4><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pncalbl.test;<span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> pncalbl</span><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/10/30 0:44</span><span class="hljs-comment"> * <span class="hljs-doctag">@e</span>-mail pncalbl@qq.com</span><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><span class="hljs-comment"> **/</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;      ClassPathXmlApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">&quot;classpath:beans.xml&quot;</span>);      User bean = context.getBean(User.class);      System.out.println(<span class="hljs-string">&quot;User = &quot;</span> + bean);   &#125;&#125;</code></pre></div><h3 id="3-è¿è¡Œæµ‹è¯•ç±»"><a href="#3-è¿è¡Œæµ‹è¯•ç±»" class="headerlink" title="3 è¿è¡Œæµ‹è¯•ç±»"></a>3 è¿è¡Œæµ‹è¯•ç±»</h3><p><img src="/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/image-20211030005036922.png" alt="image-20211030005036922"></p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Java/">Java</category>
      
      <category domain="https://pncalbl.github.io/categories/Java/Spring/">Spring</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/10/29/Spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸç¬¬8å‘¨æ€»ç»“</title>
      <link>https://pncalbl.github.io/2021/10/24/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC8%E5%91%A8%E6%80%BB%E7%BB%93/</link>
      <guid>https://pncalbl.github.io/2021/10/24/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC8%E5%91%A8%E6%80%BB%E7%BB%93/</guid>
      <pubDate>Sat, 23 Oct 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬8å‘¨æ€»ç»“&quot;&gt;&lt;a href=&quot;#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬8å‘¨æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬8å‘¨æ€»ç»“&quot;&gt;&lt;/a&gt;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬8å‘¨æ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å­¦ä¹ &quot;&gt;&lt;a hr</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬8å‘¨æ€»ç»“"><a href="#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬8å‘¨æ€»ç»“" class="headerlink" title="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬8å‘¨æ€»ç»“"></a>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬8å‘¨æ€»ç»“</h1><h2 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h2><ul><li>è®¡ç®—æœºè‹±è¯­çš„è¿›ä¸€æ­¥å­¦ä¹ ï¼ŒVerilog-FPGA çš„å®éªŒå’Œæ§åˆ¶é€»è¾‘ã€‚</li><li>åµŒå…¥å¼ç³»ç»Ÿçš„è¿›ä¸€æ­¥å­¦ä¹ ï¼Œæ•°æ®åº“çš„  View è¯­å¥çš„å­¦ä¹ ã€‚</li></ul><h2 id="é¡¹ç›®"><a href="#é¡¹ç›®" class="headerlink" title="é¡¹ç›®"></a>é¡¹ç›®</h2><ul><li>ç»§ç»­å®Œå–„ coin-exchange è´§å¸äº¤æ˜“å¹³å°ï¼Œå®Œæˆåå°ç®¡ç†æ¨¡å—å¼€å‘ã€‚</li><li>å®Œå–„æˆ‘çš„åšå®¢é¡¹ç›®ï¼Œè¿›ä¸€æ­¥ä¸°å¯Œåšå®¢çš„å†…å®¹ç”Ÿæ€ã€‚</li><li>å®Œå–„å®ä¹ ç®€å†ã€‚</li></ul><h2 id="è¯»ä¹¦"><a href="#è¯»ä¹¦" class="headerlink" title="è¯»ä¹¦"></a>è¯»ä¹¦</h2><ul><li>é˜…è¯» ã€Šåƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°ã€‹ï¼Œã€ŠGoè¯­è¨€é«˜çº§ç¼–ç¨‹ã€‹ï¼Œã€Šè½¯æŠ€èƒ½2ï¼šè½¯ä»¶å¼€å‘è€…èŒä¸šç”Ÿæ¶¯æŒ‡å—ã€‹ï¼Œã€Šå‰‘æŒ‡Offerã€‹ã€‚</li><li>é˜…è¯»ã€ŠåŸºç£å±±ä¼¯çˆµï¼ˆå…¨é›†ï¼‰ã€‹ï¼Œã€Šå®‰å¨œÂ·å¡åˆ—å°¼å¨œï¼ˆç»å…¸è¯‘æ—ï¼‰ã€‹ï¼Œã€Šæˆ˜äº‰ä¸å’Œå¹³ï¼ˆå…¨é›†ï¼‰ã€‹ã€‚</li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Weekly/">Weekly</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/10/24/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC8%E5%91%A8%E6%80%BB%E7%BB%93/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸç¬¬7å‘¨æ€»ç»“</title>
      <link>https://pncalbl.github.io/2021/10/17/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC7%E5%91%A8%E6%80%BB%E7%BB%93/</link>
      <guid>https://pncalbl.github.io/2021/10/17/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC7%E5%91%A8%E6%80%BB%E7%BB%93/</guid>
      <pubDate>Sat, 16 Oct 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬7å‘¨æ€»ç»“&quot;&gt;&lt;a href=&quot;#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬7å‘¨æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬7å‘¨æ€»ç»“&quot;&gt;&lt;/a&gt;2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬7å‘¨æ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å­¦ä¹ &quot;&gt;&lt;a hr</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬7å‘¨æ€»ç»“"><a href="#2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ-ç¬¬7å‘¨æ€»ç»“" class="headerlink" title="2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬7å‘¨æ€»ç»“"></a>2021å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ ç¬¬7å‘¨æ€»ç»“</h1><h2 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h2><ul><li>è®¡ç®—æœºè‹±è¯­çš„è¿›ä¸€æ­¥å­¦ä¹ ï¼ŒVerilog-FPGA çš„å®éªŒå’Œæ§åˆ¶é€»è¾‘ã€‚</li><li>åµŒå…¥å¼ç³»ç»Ÿçš„è¿›ä¸€æ­¥å­¦ä¹ ï¼Œæ•°æ®åº“çš„ SQL è¯­å¥çš„å­¦ä¹ ã€‚</li></ul><h2 id="é¡¹ç›®"><a href="#é¡¹ç›®" class="headerlink" title="é¡¹ç›®"></a>é¡¹ç›®</h2><ul><li>ç»§ç»­å®Œå–„ coin-exchange è´§å¸äº¤æ˜“å¹³å°ï¼Œå®Œæˆä¸»ä½“é¡¹ç›®æ­å»ºï¼Œå®Œæˆå…¬å…±æ¨¡å—å’Œç½‘å…³ä¸æˆæƒç­‰åŸºç¡€æœåŠ¡çš„æ­å»ºã€‚</li><li>å®Œå–„æˆ‘çš„åšå®¢é¡¹ç›®ï¼Œè¿›ä¸€æ­¥ä¸°å¯Œåšå®¢çš„å†…å®¹ç”Ÿæ€ã€‚</li></ul><h2 id="è¯»ä¹¦"><a href="#è¯»ä¹¦" class="headerlink" title="è¯»ä¹¦"></a>è¯»ä¹¦</h2><ul><li>é˜…è¯» ã€Šåƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°ã€‹ï¼Œã€ŠEffective Debuggingã€‹ï¼Œã€ŠJenkins 2.xå®è·µæŒ‡å—ã€‹ï¼Œã€ŠGoè¯­è¨€é«˜çº§ç¼–ç¨‹ã€‹ï¼Œã€Šè½¯æŠ€èƒ½2ï¼šè½¯ä»¶å¼€å‘è€…èŒä¸šç”Ÿæ¶¯æŒ‡å—ã€‹ï¼Œã€Šå‰‘æŒ‡Offerã€‹ã€‚</li><li>é˜…è¯»ã€ŠåŸºç£å±±ä¼¯çˆµï¼ˆå…¨é›†ï¼‰ã€‹ï¼Œã€Šå®‰å¨œÂ·å¡åˆ—å°¼å¨œï¼ˆç»å…¸è¯‘æ—ï¼‰ã€‹ï¼Œã€Šæˆ˜äº‰ä¸å’Œå¹³ï¼ˆå…¨é›†ï¼‰ã€‹ï¼Œã€Šå°ç‹å­ï¼ˆè‹±æ–‡ç‰ˆï¼‰ã€‹ï¼Œã€Šæ ¼åˆ—ä½›æ¸¸è®°:Gulliverâ€™s Travelsï¼ˆè‹±æ–‡ç‰ˆï¼‰ã€‹ã€‚</li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Weekly/">Weekly</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/10/17/2021%E5%A4%A7%E4%B8%89%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F%E7%AC%AC7%E5%91%A8%E6%80%BB%E7%BB%93/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Chocolatey Note</title>
      <link>https://pncalbl.github.io/2021/09/05/choco-cli-Note/</link>
      <guid>https://pncalbl.github.io/2021/09/05/choco-cli-Note/</guid>
      <pubDate>Sat, 04 Sep 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;ç¬¬1ç« -ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç¬¬1ç« -ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬1ç«  ç®€ä»‹&quot;&gt;&lt;/a&gt;ç¬¬1ç«  ç®€ä»‹&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://chocolatey.org/&quot;&gt;&lt;a href=&quot;https://cho</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="ç¬¬1ç« -ç®€ä»‹"><a href="#ç¬¬1ç« -ç®€ä»‹" class="headerlink" title="ç¬¬1ç«  ç®€ä»‹"></a>ç¬¬1ç«  ç®€ä»‹</h1><p><a href="https://chocolatey.org/"><a href="https://chocolatey.org/">å·§å…‹åŠ›è½¯ä»¶|å·§å…‹åŠ› - Windows çš„åŒ…è£…ç»ç† (chocolatey.org)</a></a></p><p><a href="https://docs.chocolatey.org/en-us/">å·§å…‹åŠ›è½¯ä»¶æ–‡æ¡£|å·§å…‹åŠ› - çª—å£è½¯ä»¶ç®¡ç† (chocolatey.org)</a></p><p>Chocolatey æ˜¯ä¸€ç§è½¯ä»¶ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œä¸åŒäºæ‚¨åœ¨ Windows ä¸Šä½“éªŒè¿‡çš„ä»»ä½•å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚Chocolatey å¸¦æ¥äº†çœŸæ­£çš„åŒ…è£…ç®¡ç†æ¦‚å¿µï¼Œè®©æ‚¨èƒ½å¤Ÿå¯¹äº‹ç‰©è¿›è¡Œç‰ˆæœ¬åŒ–ã€ç®¡ç†ä¾èµ–æ€§å’Œå®‰è£…é¡ºåºã€æ›´å¥½çš„åº“å­˜ç®¡ç†ä»¥åŠå…¶ä»–åŠŸèƒ½ã€‚</p><p>Chocolatey æ˜¯ä¸€ç§è½¯ä»¶ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œä¸åŒäºæ‚¨åœ¨ Windows ä¸Šä½“éªŒè¿‡çš„ä»»ä½•å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚å®ƒä¾§é‡äºç®€å•æ€§ã€å®‰å…¨æ€§å’Œæ— é™å¯æ‰©å±•æ€§ã€‚æ‚¨åœ¨ PowerShell ä¸­ä¸ºä»»ä½•è½¯ä»¶ï¼ˆè€Œä¸ä»…ä»…æ˜¯å®‰è£…äººå‘˜ï¼‰ç¼–å†™ä¸€æ¬¡è½¯ä»¶éƒ¨ç½²ï¼Œç„¶åæ‚¨å¯ä»¥åœ¨ Windows çš„ä»»ä½•åœ°æ–¹éƒ¨ç½²è¯¥è½¯ä»¶ï¼Œå¹¶æä¾›ä»»ä½•è§£å†³æ–¹æ¡ˆæ¥ç®¡ç†ç³»ç»Ÿï¼ˆé…ç½®ç®¡ç†ã€ç«¯ç‚¹ç®¡ç†ç­‰ï¼‰ï¼Œå¹¶éšç€æ—¶é—´çš„æ¨ç§»è·Ÿè¸ªå’Œç®¡ç†è¯¥è½¯ä»¶çš„æ›´æ–°ã€‚åœ¨â€äº‘â€ä¸­æˆ–åœ¨å¸¦æœ‰å·§å…‹åŠ›çš„<a href="https://github.com/Microsoft/vsts-agent-docker/blob/f870fbf259a803c6a6d902e1c01f631936069d66/windows/servercore/10.0.14393/standard/VS2017/Dockerfile">Docker å®¹å™¨</a>ä¸­ç®¡ç†è½¯ä»¶ã€‚</p><h1 id="ç¬¬-2-ç« -chocolatey-è½¯ä»¶å®‰è£…"><a href="#ç¬¬-2-ç« -chocolatey-è½¯ä»¶å®‰è£…" class="headerlink" title="ç¬¬ 2 ç«  chocolatey è½¯ä»¶å®‰è£…"></a>ç¬¬ 2 ç«  chocolatey è½¯ä»¶å®‰è£…</h1><h2 id="1-chocolatey-cli-å‘½ä»¤è¡Œå·¥å…·"><a href="#1-chocolatey-cli-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="1 chocolatey cli å‘½ä»¤è¡Œå·¥å…·"></a>1 chocolatey cli å‘½ä»¤è¡Œå·¥å…·</h2><ul><li><p>ä½¿ç”¨ cmd.exe æ‰§è¡Œå®‰è£…è„šæœ¬</p><div class="code-wrapper"><pre><code class="hljs shell">@&quot;%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command &quot;[System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString(&#x27;https://community.chocolatey.org/install.ps1&#x27;))&quot; &amp;&amp; SET &quot;PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin&quot;</code></pre></div></li><li><p>ä½¿ç”¨ PowerShell.exe æ‰§è¡Œå®‰è£…è„šæœ¬</p><div class="code-wrapper"><pre><code class="hljs shell">Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString(&#x27;https://community.chocolatey.org/install.ps1&#x27;))</code></pre></div></li><li><p>å‡çº§ chocolatey</p><div class="code-wrapper"><pre><code class="hljs shell">choco upgrade chocolatey</code></pre></div></li><li><p>å¸è½½</p><div class="code-wrapper"><pre><code class="hljs shell">å¦‚æœæ‚¨å†³å®šä¸å–œæ¬¢å·§å…‹åŠ›ï¼Œåªéœ€åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆä»¥åŠå®ƒåˆ›å»ºçš„ç¯å¢ƒå˜é‡ï¼‰ï¼Œå³å¯å¸è½½å®ƒã€‚ç”±äºå®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰å®‰è£…åœ¨ç¨‹åºå’ŒåŠŸèƒ½ä¸­ï¼Œå› æ­¤æ‚¨ä¸å¿…æ‹…å¿ƒå®ƒä¼šå¼„ä¹±æ‚¨çš„æ³¨å†Œè¡¨ï¼ˆä½†æ˜¯ï¼Œå¯¹äºä½¿ç”¨ Chocolatey æˆ–æ‰‹åŠ¨å®‰è£…çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œæƒ…å†µå°±ä¸ä¸€æ ·äº†ï¼‰ã€‚å¤§éƒ¨åˆ†å·§å…‹åŠ›éƒ½åŒ…å«åœ¨æˆ–ä»»ä½•è¯„ä¼°ã€‚æ‚¨å¯ä»¥ç®€å•åœ°åˆ é™¤è¯¥æ–‡ä»¶å¤¹ã€‚C:\ProgramData\chocolatey$env:ChocolateyInstall</code></pre></div><blockquote><p>  ğŸ“<strong>æ³¨</strong></p><p>  æ‚¨å¯ä»¥é¦–å…ˆå¤‡åå­æ–‡ä»¶å¤¹ï¼Œä»¥é˜²æ‚¨å‘ç°åˆ é™¤å·§å…‹åŠ›çš„ä¸è‰¯ç»“æœã€‚è¯·è®°ä½ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªå·§å…‹åŠ›åŒ…éƒ½æ˜¯å®‰è£…åŒ…ï¼Œè¿™äº›å­æŠ˜ä¸­å¯èƒ½åŒ…å«ä¸€äº›æœªå®‰è£…çš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šä¸¢å¤±ã€‚å¤‡ä»½å°†å…è®¸æ‚¨æµ‹è¯•è¿™ä¸€æ–¹é¢ã€‚</p></blockquote></li></ul><h2 id="2-chocolatey-GUI-å›¾å½¢åŒ–å·¥å…·"><a href="#2-chocolatey-GUI-å›¾å½¢åŒ–å·¥å…·" class="headerlink" title="2 chocolatey GUI å›¾å½¢åŒ–å·¥å…·"></a>2 chocolatey GUI å›¾å½¢åŒ–å·¥å…·</h2><div class="code-wrapper"><pre><code class="hljs shell">choco install chocolateygui --install-directory &#x27;D:\Program Files\chocolateygui&#x27; -y # æœ€å®Œæ•´çš„æŒ‡å®šç›®å½•å®‰è£…choco install chocolateygui --dir &#x27;D:\Program Files\chocolateygui&#x27; -y# ç®€å†™çš„å‘½ä»¤choco install chocolateygui -y# é‡‡ç”¨é»˜è®¤å®‰è£…è·¯å¾„choco upgrade chocolateygui -y  # å‡çº§ chocolateyguiæ³¨ä¿®æ”¹å®‰è£…ç›®å½•éœ€è¦ä»˜è´¹å¯ä»¥é€šè¿‡ä¿®æ”¹ win é»˜è®¤å®‰è£…è·¯å¾„ï¼Œæ¥é¿å…å®‰è£…åœ¨ C:\Program Fileså»ºè®®æ”¹ä¸º D:\Program Files</code></pre></div><h1 id="ç¬¬-3-ç« -CLI-å‘½ä»¤"><a href="#ç¬¬-3-ç« -CLI-å‘½ä»¤" class="headerlink" title="ç¬¬ 3 ç«  CLI å‘½ä»¤"></a>ç¬¬ 3 ç«  CLI å‘½ä»¤</h1><h2 id="1-list-è½¯ä»¶åˆ—è¡¨"><a href="#1-list-è½¯ä»¶åˆ—è¡¨" class="headerlink" title="1 list - è½¯ä»¶åˆ—è¡¨"></a>1 list - è½¯ä»¶åˆ—è¡¨</h2><ul><li><p>ç”¨æ³•</p><div class="code-wrapper"><pre><code class="hljs shell">choco find &lt;filter&gt; [&lt;options/switches&gt;]choco list &lt;filter&gt; [&lt;options/switches&gt;]clist &lt;filter&gt; [&lt;options/switches&gt;]</code></pre></div></li></ul><ul><li><p>ä¾‹å­</p><div class="code-wrapper"><pre><code class="hljs shell">choco list --local-onlychoco list -lichoco list -laichoco list --page=0 --page-size=25choco search gitchoco search git --source=&quot;&#x27;https://somewhere/out/there&#x27;&quot;choco search bob -s &quot;&#x27;https://somewhere/protected&#x27;&quot; -u user -p pass</code></pre></div></li></ul><h2 id="2-install-å®‰è£…"><a href="#2-install-å®‰è£…" class="headerlink" title="2 install - å®‰è£…"></a>2 install - å®‰è£…</h2><ul><li><p>ç”¨æ³•</p><div class="code-wrapper"><pre><code class="hljs shell">choco install &lt;pkg|packages.config&gt; [&lt;pkg2&gt; &lt;pkgN&gt;] [&lt;options/switches&gt;]cinst &lt;pkg|packages.config&gt; [&lt;pkg2&gt; &lt;pkgN&gt;] [&lt;options/switches&gt;]</code></pre></div></li></ul><ul><li><p>ä¾‹å­</p><div class="code-wrapper"><pre><code class="hljs shell">choco install sysinternalschoco install notepadplusplus googlechrome atom 7zipchoco install notepadplusplus --force --force-dependencieschoco install notepadplusplus googlechrome atom 7zip -dvfychoco install git -y --params=&quot;&#x27;/GitAndUnixToolsOnPath /NoAutoCrlf&#x27;&quot;choco install git -y --params=&quot;&#x27;/GitAndUnixToolsOnPath /NoAutoCrlf&#x27;&quot; --install-arguments=&quot;&#x27;/DIR=C:\git&#x27;&quot;<span class="hljs-meta">#</span><span class="bash"> Params are package parameters, passed to the package</span><span class="hljs-meta">#</span><span class="bash"> Install args are installer arguments, appended to the silentArgs</span> <span class="hljs-meta">#</span><span class="bash">  <span class="hljs-keyword">in</span> the package <span class="hljs-keyword">for</span> the installer itself</span>choco install nodejs.install --version 0.10.35choco install git -s &quot;&#x27;https://somewhere/out/there&#x27;&quot;choco install git -s &quot;&#x27;https://somewhere/protected&#x27;&quot; -u user -p pass</code></pre></div></li></ul><h2 id="3-upgrade-å‡çº§"><a href="#3-upgrade-å‡çº§" class="headerlink" title="3 upgrade - å‡çº§"></a>3 upgrade - å‡çº§</h2><ul><li><p>ç”¨æ³•</p><div class="code-wrapper"><pre><code class="hljs shell">choco upgrade &lt;pkg|all&gt; [&lt;pkg2&gt; &lt;pkgN&gt;] [&lt;options/switches&gt;]cup &lt;pkg|all&gt; [&lt;pkg2&gt; &lt;pkgN&gt;] [&lt;options/switches&gt;]</code></pre></div></li></ul><ul><li><p>ä¾‹å­</p><div class="code-wrapper"><pre><code class="hljs shell">choco upgrade chocolateychoco upgrade notepadplusplus googlechrome atom 7zipchoco upgrade notepadplusplus googlechrome atom 7zip -dvfychoco upgrade git -y --params=&quot;&#x27;/GitAndUnixToolsOnPath /NoAutoCrlf&#x27;&quot;choco upgrade git -y --params=&quot;&#x27;/GitAndUnixToolsOnPath /NoAutoCrlf&#x27;&quot; --install-args=&quot;&#x27;/DIR=C:\git&#x27;&quot;<span class="hljs-meta">#</span><span class="bash"> Params are package parameters, passed to the package</span><span class="hljs-meta">#</span><span class="bash"> Install args are installer arguments, appended to the silentArgs</span> <span class="hljs-meta">#</span><span class="bash">  <span class="hljs-keyword">in</span> the package <span class="hljs-keyword">for</span> the installer itself</span>choco upgrade nodejs.install --version 0.10.35choco upgrade git -s &quot;&#x27;https://somewhere/out/there&#x27;&quot;choco upgrade git -s &quot;&#x27;https://somewhere/protected&#x27;&quot; -u user -p passchoco upgrade allchoco upgrade all --except=&quot;&#x27;skype,conemu&#x27;&quot;</code></pre></div></li></ul><h2 id="4-uninstall-å¸è½½"><a href="#4-uninstall-å¸è½½" class="headerlink" title="4 uninstall - å¸è½½"></a>4 uninstall - å¸è½½</h2><ul><li><p>ç”¨æ³•</p><div class="code-wrapper"><pre><code class="hljs shell">choco uninstall &lt;pkg|all&gt; [pkg2 pkgN] [options/switches]cuninst &lt;pkg|all&gt; [pkg2 pkgN] [options/switches]</code></pre></div></li></ul><ul><li><p>ä¾‹å­</p><div class="code-wrapper"><pre><code class="hljs shell">choco uninstall gitchoco uninstall notepadplusplus googlechrome atom 7zipchoco uninstall notepadplusplus googlechrome atom 7zip -dvchoco uninstall ruby --version 1.8.7.37402choco uninstall nodejs.install --all-versions</code></pre></div></li></ul><h2 id="5-download-ä¸‹è½½"><a href="#5-download-ä¸‹è½½" class="headerlink" title="5 download - ä¸‹è½½"></a>5 download - ä¸‹è½½</h2><ul><li><p>ç”¨æ³•</p><div class="code-wrapper"><pre><code class="hljs shell">choco download &lt;pkg&gt; [&lt;options/switches&gt;] [install_script_variable=value]Install script variables are values that are discovered in the  chocolateyInstall.ps1 (or a script it calls). When you find values there maybe don&#x27;t get found and replaced or they use a default  value and you want to provide a value for them to use instead, you can find them and then provide the value you want to pass instead. For example, in the Firefox package, it uses a default value of  &#x27;en-US&#x27; for `$locale`. If you want to change that, you can add  `locale` and a value, which will replace `$locale` in the script, e.g. `choco download firefox --internalize locale=en-GB`.</code></pre></div></li></ul><ul><li><p>ä¾‹å­</p><div class="code-wrapper"><pre><code class="hljs shell">choco download sysinternals<span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment">### [Chocolatey for Business](https://chocolatey.org/compare) / Chocolatey for MSP</span></span>choco download notepadplusplus --internalizechoco download notepadplusplus.install --internalize --resources-location \\server\sharechoco download notepadplusplus.install --internalize --resources-location http://somewhere/internal --append-useoriginallocationchoco download KB3033929 --internalize -internalize-all-urls --append-useoriginallocationchoco download firefox --internalize locale=es-AR</code></pre></div></li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Note/">Note</category>
      
      
      <category domain="https://pncalbl.github.io/tags/choco/">choco</category>
      
      <category domain="https://pncalbl.github.io/tags/win-software-management/">win software management</category>
      
      
      <comments>https://pncalbl.github.io/2021/09/05/choco-cli-Note/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Effective Debugging Note</title>
      <link>https://pncalbl.github.io/2021/09/02/Effective%20Debugging%20Note/</link>
      <guid>https://pncalbl.github.io/2021/09/02/Effective%20Debugging%20Note/</guid>
      <pubDate>Wed, 01 Sep 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;  æœ¬ç¯‡åšå®¢æºäº EffectiveDebugging:è½¯ä»¶å’Œç³»ç»Ÿè°ƒè¯•çš„66ä¸ªæœ‰æ•ˆæ–¹æ³• &lt;/p&gt;
&lt;p&gt;  ä½œè€…ï¼šè¿ªæ¬§ç±³è¿ªæ–¯Â·æ–¯å®¾å¥ˆé‡Œæ–¯&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;ç¬¬1ç« -å®è§‚ç­–ç•¥&quot;&gt;&lt;a href=&quot;#ç¬¬1ç« -å®è§‚ç­–ç•¥&quot;</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p>  æœ¬ç¯‡åšå®¢æºäº EffectiveDebugging:è½¯ä»¶å’Œç³»ç»Ÿè°ƒè¯•çš„66ä¸ªæœ‰æ•ˆæ–¹æ³• </p><p>  ä½œè€…ï¼šè¿ªæ¬§ç±³è¿ªæ–¯Â·æ–¯å®¾å¥ˆé‡Œæ–¯</p></blockquote><h1 id="ç¬¬1ç« -å®è§‚ç­–ç•¥"><a href="#ç¬¬1ç« -å®è§‚ç­–ç•¥" class="headerlink" title="ç¬¬1ç«  å®è§‚ç­–ç•¥"></a>ç¬¬1ç«  å®è§‚ç­–ç•¥</h1><h2 id="ç¬¬1æ¡ï¼šé€šè¿‡äº‹åŠ¡è¿½è¸ªç³»ç»Ÿå¤„ç†æ‰€æœ‰çš„é—®é¢˜"><a href="#ç¬¬1æ¡ï¼šé€šè¿‡äº‹åŠ¡è¿½è¸ªç³»ç»Ÿå¤„ç†æ‰€æœ‰çš„é—®é¢˜" class="headerlink" title="ç¬¬1æ¡ï¼šé€šè¿‡äº‹åŠ¡è¿½è¸ªç³»ç»Ÿå¤„ç†æ‰€æœ‰çš„é—®é¢˜"></a>ç¬¬1æ¡ï¼šé€šè¿‡äº‹åŠ¡è¿½è¸ªç³»ç»Ÿå¤„ç†æ‰€æœ‰çš„é—®é¢˜</h2><ul><li><p>é€šè¿‡äº‹åŠ¡è¿½è¸ªç³»ç»Ÿæ¥å¤„ç†æ‰€æœ‰çš„é—®é¢˜ã€‚</p></li><li><p>ç¡®ä¿æ¯é¡¹äº‹åŠ¡éƒ½èƒ½å¤Ÿä»¥çŸ­å°ã€è‡ªè¶³è€Œåˆæ­£ç¡®çš„èŒƒä¾‹ï¼ˆSSCCEï¼‰ï¼Œç²¾ç¡®åœ°æè¿°å‡ºè¯¥é—®é¢˜çš„é‡ç°æ–¹å¼ã€‚</p></li><li><p>å¯¹äº‹åŠ¡è¿›è¡Œåˆ†ç±»ï¼Œå¹¶æ ¹æ®æ¯é¡¹äº‹åŠ¡çš„ä¼˜å…ˆçº§ä¸ä¸¥é‡ç¨‹åº¦æ¥å®‰æ’å·¥ä½œã€‚</p></li><li><p>é€šè¿‡äº‹åŠ¡è¿½è¸ªç³»ç»Ÿæ¥è®°å½•è¿›åº¦ã€‚</p></li></ul><h2 id="ç¬¬2æ¡ï¼šåœ¨ç½‘ä¸Šç¡®åˆ‡åœ°æŸ¥è¯¢ä½ æ‰€é‡åˆ°çš„é—®é¢˜ï¼Œä»¥å¯»æ±‚è§£å†³é—®é¢˜çš„çµæ„Ÿ"><a href="#ç¬¬2æ¡ï¼šåœ¨ç½‘ä¸Šç¡®åˆ‡åœ°æŸ¥è¯¢ä½ æ‰€é‡åˆ°çš„é—®é¢˜ï¼Œä»¥å¯»æ±‚è§£å†³é—®é¢˜çš„çµæ„Ÿ" class="headerlink" title="ç¬¬2æ¡ï¼šåœ¨ç½‘ä¸Šç¡®åˆ‡åœ°æŸ¥è¯¢ä½ æ‰€é‡åˆ°çš„é—®é¢˜ï¼Œä»¥å¯»æ±‚è§£å†³é—®é¢˜çš„çµæ„Ÿ"></a>ç¬¬2æ¡ï¼šåœ¨ç½‘ä¸Šç¡®åˆ‡åœ°æŸ¥è¯¢ä½ æ‰€é‡åˆ°çš„é—®é¢˜ï¼Œä»¥å¯»æ±‚è§£å†³é—®é¢˜çš„çµæ„Ÿ</h2><ul><li>æŠŠé”™è¯¯æ¶ˆæ¯æ‰“ä¸ŠåŒå¼•å·ï¼Œä»¥ä¾¿åœ¨ç½‘ä¸Šå‡†ç¡®åœ°è¿›è¡Œæœç´¢ã€‚å¯ä»¥åœ¨<a href="https://searchcode.com/">æºä»£ç æœç´¢å¼•æ“ </a>å‡†ç¡®æœç´¢æœ‰å…³å…·ä½“ä»£ç çš„è§£å†³æ–¹æ¡ˆã€‚</li><li>è®¤çœŸæŸ¥çœ‹StackExchangeç³»åˆ—ç½‘ç«™ä¸Šé¢çš„å›ç­”ã€‚</li><li>å¦‚æœä¸Šè¿°ä¸¤ç§åŠæ³•éƒ½ä¸è§æ•ˆï¼Œé‚£ä½ å¯ä»¥è‡ªå·±æé—®æˆ–æäº¤äº‹åŠ¡ã€‚è‡ªå·±æé—®æ³¨æ„ï¼šå‡¡æ˜¯åœ¨è®ºå›å‘é—®ï¼Œéƒ½åº”è¯¥éµå¾ªè¯¥SSCCEåŸåˆ™ã€‚</li></ul><h2 id="ç¬¬3æ¡ï¼šç¡®ä¿å‰ç½®æ¡ä»¶ä¸åç½®æ¡ä»¶éƒ½èƒ½å¤Ÿå¾—åˆ°æ»¡è¶³"><a href="#ç¬¬3æ¡ï¼šç¡®ä¿å‰ç½®æ¡ä»¶ä¸åç½®æ¡ä»¶éƒ½èƒ½å¤Ÿå¾—åˆ°æ»¡è¶³" class="headerlink" title="ç¬¬3æ¡ï¼šç¡®ä¿å‰ç½®æ¡ä»¶ä¸åç½®æ¡ä»¶éƒ½èƒ½å¤Ÿå¾—åˆ°æ»¡è¶³"></a>ç¬¬3æ¡ï¼šç¡®ä¿å‰ç½®æ¡ä»¶ä¸åç½®æ¡ä»¶éƒ½èƒ½å¤Ÿå¾—åˆ°æ»¡è¶³</h2><ul><li>ä»”ç»†æ£€æŸ¥ä¾‹ç¨‹çš„å‰ç½®æ¡ä»¶ä¸åç½®æ¡ä»¶ã€‚</li><li>ä¾‹å¦‚ï¼šæ•°å­¦å‡½æ•°çš„å‚æ•°æ˜¯å¦åœ¨å…¶å®šä¹‰åŸŸä¹‹å†…ï¼Œæ•°æ®åº“å»ºè¡¨æ˜¯å¦æˆåŠŸï¼Œå¯ä»¥æ‰‹åŠ¨éªŒè¯ã€‚</li></ul><h2 id="ç¬¬4æ¡ï¼šä»å…·ä½“é—®é¢˜å…¥æ‰‹å‘ä¸Šè¿½æŸ¥bugï¼Œæˆ–ä»é«˜å±‚ç¨‹åºå…¥æ‰‹å‘ä¸‹è¿½æŸ¥bug"><a href="#ç¬¬4æ¡ï¼šä»å…·ä½“é—®é¢˜å…¥æ‰‹å‘ä¸Šè¿½æŸ¥bugï¼Œæˆ–ä»é«˜å±‚ç¨‹åºå…¥æ‰‹å‘ä¸‹è¿½æŸ¥bug" class="headerlink" title="ç¬¬4æ¡ï¼šä»å…·ä½“é—®é¢˜å…¥æ‰‹å‘ä¸Šè¿½æŸ¥bugï¼Œæˆ–ä»é«˜å±‚ç¨‹åºå…¥æ‰‹å‘ä¸‹è¿½æŸ¥bug"></a>ç¬¬4æ¡ï¼šä»å…·ä½“é—®é¢˜å…¥æ‰‹å‘ä¸Šè¿½æŸ¥bugï¼Œæˆ–ä»é«˜å±‚ç¨‹åºå…¥æ‰‹å‘ä¸‹è¿½æŸ¥bug</h2><ul><li>å¦‚æœèƒ½å¤Ÿæ˜ç¡®æŒ‡å‡ºæ•…éšœçš„åŸå› ï¼Œé‚£ä¹ˆåº”è¯¥ä»ä¸‹å¾€ä¸ŠæŸ¥æ‰¾é”™è¯¯ï¼Œä¾‹å¦‚ï¼Œåœ¨ç¨‹åºå´©æºƒã€ç¨‹åºå†»ç»“ä»¥åŠç¨‹åºå‘å‡ºé”™è¯¯æ¶ˆæ¯ç­‰æƒ…å†µä¸‹ï¼Œå°±åº”è¯¥å¦‚æ­¤ã€‚</li><li>å¦‚æœæ•…éšœçš„åŸå› å¾ˆéš¾é”å®šï¼Œé‚£ä¹ˆåº”è¯¥ä»ä¸Šå¾€ä¸‹æŸ¥æ‰¾é”™è¯¯ï¼Œä¾‹å¦‚ï¼Œåœ¨é‡åˆ°æ€§èƒ½é—®é¢˜ã€å®‰å…¨é—®é¢˜ä»¥åŠå¯é æ€§é—®é¢˜çš„æ—¶å€™ï¼Œå°±åº”è¯¥å¦‚æ­¤ã€‚</li></ul><h2 id="ç¬¬5æ¡ï¼šåœ¨èƒ½å¤Ÿæ­£å¸¸è¿ä½œçš„ç³»ç»Ÿä¸å‘ç”Ÿæ•…éšœçš„ç³»ç»Ÿä¹‹é—´å¯»æ‰¾å·®åˆ«"><a href="#ç¬¬5æ¡ï¼šåœ¨èƒ½å¤Ÿæ­£å¸¸è¿ä½œçš„ç³»ç»Ÿä¸å‘ç”Ÿæ•…éšœçš„ç³»ç»Ÿä¹‹é—´å¯»æ‰¾å·®åˆ«" class="headerlink" title="ç¬¬5æ¡ï¼šåœ¨èƒ½å¤Ÿæ­£å¸¸è¿ä½œçš„ç³»ç»Ÿä¸å‘ç”Ÿæ•…éšœçš„ç³»ç»Ÿä¹‹é—´å¯»æ‰¾å·®åˆ«"></a>ç¬¬5æ¡ï¼šåœ¨èƒ½å¤Ÿæ­£å¸¸è¿ä½œçš„ç³»ç»Ÿä¸å‘ç”Ÿæ•…éšœçš„ç³»ç»Ÿä¹‹é—´å¯»æ‰¾å·®åˆ«</h2><ul><li>åœ¨èƒ½å¤Ÿæ­£å¸¸è¿ä½œçš„ç³»ç»Ÿä¸å‡ºç°æ•…éšœçš„ç³»ç»Ÿä¹‹é—´å¯¹æ¯”ï¼Œæ‰¾å‡ºè¡Œä¸ºä¸Šçš„åŒºåˆ«ï¼Œä»¥æ±‚å‘ç°æ•…éšœçš„åŸå› ã€‚</li><li>å½±å“ç³»ç»Ÿè¡Œä¸ºçš„æ‰€æœ‰å› ç´ éƒ½è¦è€ƒè™‘åˆ°ï¼ŒåŒ…æ‹¬ä»£ç ã€è¾“å…¥ã€è°ƒç”¨æ—¶çš„å‚æ•°ã€ç¯å¢ƒå˜é‡ã€æœåŠ¡ä»¥åŠåŠ¨æ€é“¾æ¥åº“ã€‚</li></ul><h2 id="ç¬¬6æ¡ï¼šä½¿ç”¨è½¯ä»¶è‡ªèº«çš„è°ƒè¯•æœºåˆ¶"><a href="#ç¬¬6æ¡ï¼šä½¿ç”¨è½¯ä»¶è‡ªèº«çš„è°ƒè¯•æœºåˆ¶" class="headerlink" title="ç¬¬6æ¡ï¼šä½¿ç”¨è½¯ä»¶è‡ªèº«çš„è°ƒè¯•æœºåˆ¶"></a>ç¬¬6æ¡ï¼šä½¿ç”¨è½¯ä»¶è‡ªèº«çš„è°ƒè¯•æœºåˆ¶</h2><ul><li>æ‰¾å‡ºä½ æ­£åœ¨è°ƒè¯•çš„è¿™æ¬¾è½¯ä»¶æ‰€æ”¯æŒçš„è°ƒè¯•æœºåˆ¶ï¼Œå¹¶ä»¥æ­¤æ¥æ’æŸ¥ä½ æ‰€é‡åˆ°çš„é—®é¢˜ã€‚</li></ul><h2 id="ç¬¬7æ¡ï¼šè¯•ç€ç”¨å¤šç§å·¥å…·æ„å»ºè½¯ä»¶ï¼Œå¹¶å°†å…¶æ”¾åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹æ‰§è¡Œ"><a href="#ç¬¬7æ¡ï¼šè¯•ç€ç”¨å¤šç§å·¥å…·æ„å»ºè½¯ä»¶ï¼Œå¹¶å°†å…¶æ”¾åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹æ‰§è¡Œ" class="headerlink" title="ç¬¬7æ¡ï¼šè¯•ç€ç”¨å¤šç§å·¥å…·æ„å»ºè½¯ä»¶ï¼Œå¹¶å°†å…¶æ”¾åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹æ‰§è¡Œ"></a>ç¬¬7æ¡ï¼šè¯•ç€ç”¨å¤šç§å·¥å…·æ„å»ºè½¯ä»¶ï¼Œå¹¶å°†å…¶æ”¾åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹æ‰§è¡Œ</h2><ul><li>ç”¨å¤šç§ç¼–è¯‘å·¥å…·æ¥æ„å»ºè½¯ä»¶ï¼Œå¹¶å°†å…¶æ”¾åœ¨å„ç§å¹³å°ä¸­æ‰§è¡Œï¼Œå¯ä»¥ç»™è°ƒè¯•å·¥ä½œæä¾›å¾ˆå¤šæœ‰ä»·å€¼çš„æ€è·¯ã€‚</li><li>å¦‚æœé‡åˆ°äº†ä¸€ä¸ªå¾ˆéš¾è°ƒè¯•çš„ç®—æ³•ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘æ”¹ç”¨é«˜çº§è¯­è¨€å°†å…¶é‡æ–°å®ç°ä¸€éã€‚</li></ul><h2 id="ç¬¬8æ¡ï¼šæŠŠå·¥ä½œç„¦ç‚¹æ”¾åœ¨æœ€ä¸ºé‡è¦çš„é—®é¢˜ä¸Š"><a href="#ç¬¬8æ¡ï¼šæŠŠå·¥ä½œç„¦ç‚¹æ”¾åœ¨æœ€ä¸ºé‡è¦çš„é—®é¢˜ä¸Š" class="headerlink" title="ç¬¬8æ¡ï¼šæŠŠå·¥ä½œç„¦ç‚¹æ”¾åœ¨æœ€ä¸ºé‡è¦çš„é—®é¢˜ä¸Š"></a>ç¬¬8æ¡ï¼šæŠŠå·¥ä½œç„¦ç‚¹æ”¾åœ¨æœ€ä¸ºé‡è¦çš„é—®é¢˜ä¸Š</h2><ul><li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„é—®é¢˜éƒ½å€¼å¾—è§£å†³ã€‚</li><li>ä¿®å¤ä¼˜å…ˆçº§è¾ƒä½çš„é—®é¢˜å¯èƒ½ä¼šè€½è¯¯ä½ çš„æ—¶é—´ï¼Œä½¿ä½ æ— æ³•æ‹¿å‡ºæ›´å¤šæ—¶é—´å»å¤„ç†é‚£äº›æ›´ä¸ºç´§è¿«çš„äº‹åŠ¡ã€‚</li></ul><h1 id="ç¬¬2ç« -é€šç”¨çš„æ–¹æ³•ä¸åšæ³•"><a href="#ç¬¬2ç« -é€šç”¨çš„æ–¹æ³•ä¸åšæ³•" class="headerlink" title="ç¬¬2ç«  é€šç”¨çš„æ–¹æ³•ä¸åšæ³•"></a>ç¬¬2ç«  é€šç”¨çš„æ–¹æ³•ä¸åšæ³•</h1><h2 id="ç¬¬9æ¡ï¼šç›¸ä¿¡è‡ªå·±èƒ½å¤ŸæŠŠé—®é¢˜è°ƒè¯•å¥½"><a href="#ç¬¬9æ¡ï¼šç›¸ä¿¡è‡ªå·±èƒ½å¤ŸæŠŠé—®é¢˜è°ƒè¯•å¥½" class="headerlink" title="ç¬¬9æ¡ï¼šç›¸ä¿¡è‡ªå·±èƒ½å¤ŸæŠŠé—®é¢˜è°ƒè¯•å¥½"></a>ç¬¬9æ¡ï¼šç›¸ä¿¡è‡ªå·±èƒ½å¤ŸæŠŠé—®é¢˜è°ƒè¯•å¥½</h2><ul><li>ç¡®ä¿¡é—®é¢˜æ˜¯å¯ä»¥è¿½æŸ¥å¹¶è§£å†³çš„ã€‚</li><li>ç»™è°ƒè¯•å·¥ä½œç•™å‡ºè¶³å¤Ÿçš„æ—¶é—´ã€‚</li><li>å®‰æ’å¥½å·¥ä½œç¯å¢ƒï¼Œä½¿è‡ªå·±ä¸å—å¹²æ‰°ã€‚</li><li>é‡åˆ°éš¾é¢˜çš„æ—¶å€™å¯ä»¥å…ˆå»ç¡ä¸€è§‰ã€‚</li><li>ä¸è¦å½»åº•æ”¾å¼ƒã€‚</li><li>æŠ•å…¥ç²¾åŠ›å»å­¦ä¹ ç¯å¢ƒã€å·¥å…·åŠçŸ¥è¯†ã€‚</li></ul><h2 id="ç¬¬10æ¡ï¼šé«˜æ•ˆåœ°é‡ç°ç¨‹åºä¸­çš„é—®é¢˜"><a href="#ç¬¬10æ¡ï¼šé«˜æ•ˆåœ°é‡ç°ç¨‹åºä¸­çš„é—®é¢˜" class="headerlink" title="ç¬¬10æ¡ï¼šé«˜æ•ˆåœ°é‡ç°ç¨‹åºä¸­çš„é—®é¢˜"></a>ç¬¬10æ¡ï¼šé«˜æ•ˆåœ°é‡ç°ç¨‹åºä¸­çš„é—®é¢˜</h2><ul><li>å¦‚æœèƒ½å¤Ÿå‡†ç¡®é‡ç°ç¨‹åºä¸­çš„é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è°ƒè¯•è¿‡ç¨‹å°±ä¼šå¾—ä»¥ç®€åŒ–ã€‚</li><li>åˆ›å»ºä¸€ä¸ªç®€çŸ­ä¸”è‡ªè¶³çš„èŒƒä¾‹ï¼Œä»¥ä¾¿é‡ç°ç¨‹åºä¸­çš„é—®é¢˜ã€‚</li><li>è®¾æ³•åˆ›å»ºä¸€å¥—å¯ä»¥åˆ¶ä½œå‰¯æœ¬çš„æ‰§è¡Œç¯å¢ƒã€‚</li><li>é‡‡ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç»™ç‰¹å®šçš„è½¯ä»¶ç‰ˆæœ¬æ‰“ä¸Šæ ‡è®°ï¼Œä»¥ä¾¿æ ¹æ®æ­¤æ ‡è®°æ¥è·å–ä¸ä¹‹å¯¹åº”çš„ä»£ç ã€‚</li></ul><h2 id="ç¬¬11æ¡ï¼šä¿®æ”¹å®Œä»£ç ä¹‹åï¼Œè¦èƒ½å¤Ÿå°½å¿«çœ‹åˆ°ç»“æœ"><a href="#ç¬¬11æ¡ï¼šä¿®æ”¹å®Œä»£ç ä¹‹åï¼Œè¦èƒ½å¤Ÿå°½å¿«çœ‹åˆ°ç»“æœ" class="headerlink" title="ç¬¬11æ¡ï¼šä¿®æ”¹å®Œä»£ç ä¹‹åï¼Œè¦èƒ½å¤Ÿå°½å¿«çœ‹åˆ°ç»“æœ"></a>ç¬¬11æ¡ï¼šä¿®æ”¹å®Œä»£ç ä¹‹åï¼Œè¦èƒ½å¤Ÿå°½å¿«çœ‹åˆ°ç»“æœ</h2><ul><li>è®¾æ³•åœ¨ä¿®æ”¹ä»£ç ä¹‹åå°½å¿«çœ‹åˆ°å…¶ç»“æœï¼Œä»¥æå‡è°ƒè¯•çš„æ•ˆç‡ã€‚</li><li>é…ç½®ä¸€å¥—å¿«é€Ÿçš„è‡ªåŠ¨åŒ–æ„å»ºåŠéƒ¨ç½²æµç¨‹ã€‚</li><li>æµ‹è¯•è½¯ä»¶æ—¶ï¼Œè¦ä»¤å…¶å°½å¿«åœ°å°†æ•…éšœæš´éœ²å‡ºæ¥ã€‚</li></ul><h2 id="ç¬¬12æ¡ï¼šå°†å¤æ‚çš„æµ‹è¯•åœºæ™¯è‡ªåŠ¨åŒ–"><a href="#ç¬¬12æ¡ï¼šå°†å¤æ‚çš„æµ‹è¯•åœºæ™¯è‡ªåŠ¨åŒ–" class="headerlink" title="ç¬¬12æ¡ï¼šå°†å¤æ‚çš„æµ‹è¯•åœºæ™¯è‡ªåŠ¨åŒ–"></a>ç¬¬12æ¡ï¼šå°†å¤æ‚çš„æµ‹è¯•åœºæ™¯è‡ªåŠ¨åŒ–</h2><ul><li>é€šè¿‡è„šæœ¬è¯­è¨€æ¥è‡ªåŠ¨æ‰§è¡Œå¤æ‚çš„æµ‹è¯•ç”¨ä¾‹ã€‚</li></ul><h2 id="ç¬¬13æ¡ï¼šä½¿è‡ªå·±å°½å¯èƒ½å¤šåœ°è§‚å¯Ÿåˆ°ä¸è°ƒè¯•æœ‰å…³çš„æ•°æ®"><a href="#ç¬¬13æ¡ï¼šä½¿è‡ªå·±å°½å¯èƒ½å¤šåœ°è§‚å¯Ÿåˆ°ä¸è°ƒè¯•æœ‰å…³çš„æ•°æ®" class="headerlink" title="ç¬¬13æ¡ï¼šä½¿è‡ªå·±å°½å¯èƒ½å¤šåœ°è§‚å¯Ÿåˆ°ä¸è°ƒè¯•æœ‰å…³çš„æ•°æ®"></a>ç¬¬13æ¡ï¼šä½¿è‡ªå·±å°½å¯èƒ½å¤šåœ°è§‚å¯Ÿåˆ°ä¸è°ƒè¯•æœ‰å…³çš„æ•°æ®</h2><ul><li>å¦‚æœèƒ½å¤ŸåŒæ—¶çœ‹åˆ°æ¯”è¾ƒå¤šçš„æ•°æ®ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥æ›´åŠ ä¸“æ³¨åœ°è¿›è¡Œè°ƒè¯•ï¼Œä»è€Œæ‰¾åˆ°æ•°æ®æ‰€ä½“ç°å‡ºçš„æ¨¡å¼ä»¥åŠæ•°æ®ä¹‹é—´çš„ç›¸äº’å…³ç³»ã€‚</li><li>å°½å¯èƒ½åœ°å°†æ˜¾ç¤ºåŒºåŸŸæ‰©è‡³æœ€å¤§ã€‚</li><li>æŠŠç›¸å¯¹é™æ€çš„æ•°æ®æ‰“å°åˆ°çº¸ä¸Šã€‚</li></ul><h2 id="ç¬¬14æ¡ï¼šè€ƒè™‘å¯¹è½¯ä»¶è¿›è¡Œæ›´æ–°"><a href="#ç¬¬14æ¡ï¼šè€ƒè™‘å¯¹è½¯ä»¶è¿›è¡Œæ›´æ–°" class="headerlink" title="ç¬¬14æ¡ï¼šè€ƒè™‘å¯¹è½¯ä»¶è¿›è¡Œæ›´æ–°"></a>ç¬¬14æ¡ï¼šè€ƒè™‘å¯¹è½¯ä»¶è¿›è¡Œæ›´æ–°</h2><ul><li>åœ¨æ›´æ–°ä¹‹åçš„ç¯å¢ƒé‡Œé¢é‡æ–°å°è¯•ä½ æ‰€ç¼–å†™çš„ä»£ç ï¼Œçœ‹çœ‹è¿™æ¬¡ä¼šä¸ä¼šå‡ºé”™ã€‚</li><li>ä¸è¦å¯¹æ›´æ–°è½¯ä»¶æ‰€å¸¦æ¥çš„æ•ˆæœæŠ±æœ‰è¿‡é«˜çš„æœŸæœ›ã€‚</li><li>è¦è€ƒè™‘å› ç¬¬ä¸‰æ–¹ç»„ä»¶è€Œå¼•å‘bugçš„å¯èƒ½æ€§ã€‚</li></ul><h2 id="ç¬¬15æ¡ï¼šæŸ¥çœ‹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„æºä»£ç ï¼Œä»¥äº†è§£å…¶ç”¨æ³•"><a href="#ç¬¬15æ¡ï¼šæŸ¥çœ‹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„æºä»£ç ï¼Œä»¥äº†è§£å…¶ç”¨æ³•" class="headerlink" title="ç¬¬15æ¡ï¼šæŸ¥çœ‹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„æºä»£ç ï¼Œä»¥äº†è§£å…¶ç”¨æ³•"></a>ç¬¬15æ¡ï¼šæŸ¥çœ‹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„æºä»£ç ï¼Œä»¥äº†è§£å…¶ç”¨æ³•</h2><ul><li>å¦‚æœä½ ä¾èµ–æŸä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œé‚£ä¹ˆå°±åº”è¯¥è·å–å…¶æºä»£ç ã€‚</li><li>é€šè¿‡æŸ¥çœ‹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„æºä»£ç æ¢å¯»ä¸ç¬¬ä¸‰æ–¹APIåŠä¸€äº›å¥‡æ€ªçš„é”™è¯¯æ¶ˆæ¯æœ‰å…³çš„é—®é¢˜ã€‚</li><li>è¦å’Œç¬¬ä¸‰æ–¹ç¨‹åºåº“çš„debugç‰ˆæœ¬ç›¸é“¾æ¥ã€‚</li><li>åªæœ‰å½“å…¶ä»–åŠæ³•éƒ½ä¸å¯è¡Œçš„æ—¶å€™ï¼Œæ‰éœ€è¦å¯¹ç¬¬ä¸‰æ–¹çš„æºä»£ç è¿›è¡Œä¿®æ”¹ã€‚</li></ul><h2 id="ç¬¬16æ¡ï¼šä½¿ç”¨ä¸“é—¨çš„ç›‘æµ‹åŠæµ‹è¯•è®¾å¤‡"><a href="#ç¬¬16æ¡ï¼šä½¿ç”¨ä¸“é—¨çš„ç›‘æµ‹åŠæµ‹è¯•è®¾å¤‡" class="headerlink" title="ç¬¬16æ¡ï¼šä½¿ç”¨ä¸“é—¨çš„ç›‘æµ‹åŠæµ‹è¯•è®¾å¤‡"></a>ç¬¬16æ¡ï¼šä½¿ç”¨ä¸“é—¨çš„ç›‘æµ‹åŠæµ‹è¯•è®¾å¤‡</h2><ul><li>é€»è¾‘åˆ†æå™¨ã€æ€»çº¿åˆ†æå™¨æˆ–åè®®åˆ†æå™¨å¯ä»¥å¸®ä½ é”å®šæ¥è¿‘äºç¡¬ä»¶å±‚é¢çš„é—®é¢˜ã€‚</li><li>å¯ä»¥é€šè¿‡è‡ªåˆ¶çš„è®¾å¤‡æ¥æ¢æŸ¥ä¸ç¡¬ä»¶æœ‰å…³çš„é—®é¢˜ã€‚</li><li>å¯ä»¥é€šè¿‡å°†Wiresharkä¸ä»¥å¤ªç½‘é›†çº¿å™¨ç›¸ç»“åˆã€ä½¿ç”¨ç®¡ç†å‹äº¤æ¢æœºæˆ–è¿›è¡Œå‘½ä»¤è¡Œæ•è·ç­‰åŠæ³•æ¥ç›‘æµ‹ç½‘ç»œæ•°æ®åŒ…ã€‚</li></ul><h2 id="ç¬¬17æ¡ï¼šä½¿æ•…éšœæ›´åŠ çªå‡º"><a href="#ç¬¬17æ¡ï¼šä½¿æ•…éšœæ›´åŠ çªå‡º" class="headerlink" title="ç¬¬17æ¡ï¼šä½¿æ•…éšœæ›´åŠ çªå‡º"></a>ç¬¬17æ¡ï¼šä½¿æ•…éšœæ›´åŠ çªå‡º</h2><ul><li>è¿«ä½¿è½¯ä»¶å»æ‰§è¡Œé‚£äº›å¯ç–‘çš„è·¯å¾„ã€‚</li><li>æå‡æŸäº›æ•ˆæœçš„å¹…åº¦ï¼Œä»¤å…¶å˜å¾—æ›´åŠ çªå‡ºï¼Œä»¥ä¾¿äºæˆ‘ä»¬è¿›è¡Œç ”ç©¶ã€‚</li><li>å¯¹è½¯ä»¶åŠ å‹ï¼Œè¿«ä½¿å®ƒèµ°å‡ºèƒ½å¤Ÿä»å®¹åº”å¯¹è´Ÿè½½çš„é‚£ç§èˆ’é€‚çŠ¶æ€ã€‚</li><li>åœ¨ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿä¸­ä¸´æ—¶åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¹¶æŠŠæ‰€æœ‰çš„ä¿®æ”¹éƒ½æ”¾åœ¨è¿™ä¸ªåˆ†æ”¯ä¸Šé¢æ¥åšã€‚</li></ul><h2 id="ç¬¬18æ¡ï¼šä»è‡ªå·±çš„æ¡Œé¢è®¡ç®—æœºä¸Šè°ƒè¯•é‚£äº›ä¸å¤ªå¥½ç”¨çš„ç³»ç»Ÿ"><a href="#ç¬¬18æ¡ï¼šä»è‡ªå·±çš„æ¡Œé¢è®¡ç®—æœºä¸Šè°ƒè¯•é‚£äº›ä¸å¤ªå¥½ç”¨çš„ç³»ç»Ÿ" class="headerlink" title="ç¬¬18æ¡ï¼šä»è‡ªå·±çš„æ¡Œé¢è®¡ç®—æœºä¸Šè°ƒè¯•é‚£äº›ä¸å¤ªå¥½ç”¨çš„ç³»ç»Ÿ"></a>ç¬¬18æ¡ï¼šä»è‡ªå·±çš„æ¡Œé¢è®¡ç®—æœºä¸Šè°ƒè¯•é‚£äº›ä¸å¤ªå¥½ç”¨çš„ç³»ç»Ÿ</h2><ul><li>æŠŠè®¾å¤‡æ¨¡æ‹Ÿå™¨é…ç½®å¥½ï¼Œä»¥ä¾¿é€šè¿‡è®¡ç®—æœºå±å¹•å’Œé”®ç›˜æ¥è°ƒè¯•ç§»åŠ¨appã€‚</li><li>æ­å»ºshimæœºåˆ¶ï¼Œä»¥ä¾¿ä½¿ç”¨è‡ªå·±è®¡ç®—æœºä¸­çš„å·¥å…·æ¥è°ƒè¯•åµŒå…¥å¼ä»£ç ã€‚</li><li>ä¸ºè¿œç¨‹è®¿é—®åšå¥½å‡†å¤‡ï¼Œä»¥ä¾¿èƒ½å¤Ÿè¿œç¨‹è°ƒè¯•å®¢æˆ·çš„è®¡ç®—æœºã€‚</li><li>é…ç½®KVM over IPè®¾å¤‡ï¼Œä»¥ä¾¿è°ƒè¯•è¿œç¨‹æœåŠ¡å™¨ä¸Šé¢çš„é—®é¢˜ã€‚</li></ul><h2 id="ç¬¬19æ¡ï¼šä½¿è°ƒè¯•ä»»åŠ¡è‡ªåŠ¨åŒ–"><a href="#ç¬¬19æ¡ï¼šä½¿è°ƒè¯•ä»»åŠ¡è‡ªåŠ¨åŒ–" class="headerlink" title="ç¬¬19æ¡ï¼šä½¿è°ƒè¯•ä»»åŠ¡è‡ªåŠ¨åŒ–"></a>ç¬¬19æ¡ï¼šä½¿è°ƒè¯•ä»»åŠ¡è‡ªåŠ¨åŒ–</h2><ul><li>æŠŠå¯»æ‰¾ç¨‹åºæ•…éšœçš„è¿‡ç¨‹è‡ªåŠ¨åŒ–ï¼Œä½¿å¾—è®¡ç®—æœºå¤šè´¹ä¸€äº›åŠŸå¤«å»æœå¯»ï¼Œä»è€ŒèŠ‚çœä½ è‡ªå·±çš„å®è´µæ—¶é—´ã€‚</li></ul><h2 id="ç¬¬20æ¡ï¼šå¼€å§‹è°ƒè¯•ä¹‹å‰ä¸è°ƒè¯•å®Œæ¯•ä¹‹åéƒ½è¦æŠŠç¨‹åºæ¸…ç†å¹²å‡€"><a href="#ç¬¬20æ¡ï¼šå¼€å§‹è°ƒè¯•ä¹‹å‰ä¸è°ƒè¯•å®Œæ¯•ä¹‹åéƒ½è¦æŠŠç¨‹åºæ¸…ç†å¹²å‡€" class="headerlink" title="ç¬¬20æ¡ï¼šå¼€å§‹è°ƒè¯•ä¹‹å‰ä¸è°ƒè¯•å®Œæ¯•ä¹‹åéƒ½è¦æŠŠç¨‹åºæ¸…ç†å¹²å‡€"></a>ç¬¬20æ¡ï¼šå¼€å§‹è°ƒè¯•ä¹‹å‰ä¸è°ƒè¯•å®Œæ¯•ä¹‹åéƒ½è¦æŠŠç¨‹åºæ¸…ç†å¹²å‡€</h2><ul><li>åœ¨å¼€å§‹è°ƒè¯•é‡å¤§çš„bugä¹‹å‰ï¼Œå…ˆè¦ç¡®ä¿ä»£ç èƒ½å¤Ÿè¾¾åˆ°ä¸€å®šçš„æ•´æ´ç¨‹åº¦ã€‚</li><li>è°ƒè¯•å®Œæ¯•ä¹‹åï¼Œè¦æŠŠè°ƒè¯•è¿‡ç¨‹ä¸­å¯¹ä»£ç æ‰€åšçš„ä¸´æ—¶æ”¹åŠ¨è¿˜åŸå›å»ï¼Œå¹¶ä¸”è¦æŠŠé‚£äº›æœ‰ç”¨çš„ä»£ç æäº¤åˆ°ä»£ç åº“ã€‚</li></ul><h2 id="ç¬¬21æ¡ï¼šæŠŠå±äºåŒä¸€ä¸ªç±»å‹çš„æ‰€æœ‰é—®é¢˜å…¨éƒ½ä¿®å¤å¥½"><a href="#ç¬¬21æ¡ï¼šæŠŠå±äºåŒä¸€ä¸ªç±»å‹çš„æ‰€æœ‰é—®é¢˜å…¨éƒ½ä¿®å¤å¥½" class="headerlink" title="ç¬¬21æ¡ï¼šæŠŠå±äºåŒä¸€ä¸ªç±»å‹çš„æ‰€æœ‰é—®é¢˜å…¨éƒ½ä¿®å¤å¥½"></a>ç¬¬21æ¡ï¼šæŠŠå±äºåŒä¸€ä¸ªç±»å‹çš„æ‰€æœ‰é—®é¢˜å…¨éƒ½ä¿®å¤å¥½</h2><ul><li>ä¿®å¤äº†æŸä¸€ä¸ªé”™è¯¯ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯»æ‰¾å¹¶è§£å†³å…¶ä»–ç›¸ä¼¼çš„é”™è¯¯ï¼Œå¹¶è®¾æ³•ä¿è¯å°†æ¥ä¸ä¼šå†å‡ºç°æ­¤ç±»é”™è¯¯ã€‚</li></ul><h1 id="ç¬¬3ç« -é€šç”¨çš„å·¥å…·ä¸æŠ€æœ¯"><a href="#ç¬¬3ç« -é€šç”¨çš„å·¥å…·ä¸æŠ€æœ¯" class="headerlink" title="ç¬¬3ç«  é€šç”¨çš„å·¥å…·ä¸æŠ€æœ¯"></a>ç¬¬3ç«  é€šç”¨çš„å·¥å…·ä¸æŠ€æœ¯</h1><h2 id="ç¬¬22æ¡ï¼šç”¨Unixå‘½ä»¤è¡Œå·¥å…·å¯¹è°ƒè¯•æ•°æ®è¿›è¡Œåˆ†æ"><a href="#ç¬¬22æ¡ï¼šç”¨Unixå‘½ä»¤è¡Œå·¥å…·å¯¹è°ƒè¯•æ•°æ®è¿›è¡Œåˆ†æ" class="headerlink" title="ç¬¬22æ¡ï¼šç”¨Unixå‘½ä»¤è¡Œå·¥å…·å¯¹è°ƒè¯•æ•°æ®è¿›è¡Œåˆ†æ"></a>ç¬¬22æ¡ï¼šç”¨Unixå‘½ä»¤è¡Œå·¥å…·å¯¹è°ƒè¯•æ•°æ®è¿›è¡Œåˆ†æ</h2><ul><li>ç”¨Unixå‘½ä»¤æ¥è·å–ã€ç­›é€‰ã€å¤„ç†å¹¶æ±‡æ€»æ–‡æœ¬è®°å½•ï¼Œä»è€Œå®ç°å¯¹è°ƒè¯•æ•°æ®çš„åˆ†æã€‚</li><li>æŠŠUnixå‘½ä»¤ç”¨ç®¡é“è¿æ¥èµ·æ¥ï¼Œå¯ä»¥è¿…é€Ÿå®Œæˆå¾ˆå¤šå¤æ‚çš„åˆ†æä»»</li></ul><h2 id="ç¬¬23æ¡ï¼šæŒæ¡å‘½ä»¤è¡Œå·¥å…·çš„å„ç§é€‰é¡¹åŠä¹ æƒ¯ç”¨æ³•"><a href="#ç¬¬23æ¡ï¼šæŒæ¡å‘½ä»¤è¡Œå·¥å…·çš„å„ç§é€‰é¡¹åŠä¹ æƒ¯ç”¨æ³•" class="headerlink" title="ç¬¬23æ¡ï¼šæŒæ¡å‘½ä»¤è¡Œå·¥å…·çš„å„ç§é€‰é¡¹åŠä¹ æƒ¯ç”¨æ³•"></a>ç¬¬23æ¡ï¼šæŒæ¡å‘½ä»¤è¡Œå·¥å…·çš„å„ç§é€‰é¡¹åŠä¹ æƒ¯ç”¨æ³•</h2><ul><li>é€šè¿‡grepå‘½ä»¤çš„å„ç§é€‰é¡¹å¯¹æœç´¢çš„ç»“æœè¿›è¡Œé€æ­¥ç­›é€‰ã€‚</li><li>å¯¹ç¨‹åºçš„æ ‡å‡†é”™è¯¯ç«¯è¿›è¡Œé‡å®šå‘ï¼Œä»¥ä¾¿äºåˆ†æã€‚</li><li>ç”¨tail-få‘½ä»¤æ¥ç›‘æ§å†…å®¹æŒç»­å¢åŠ çš„æ—¥å¿—æ–‡ä»¶ã€‚</li></ul><h2 id="ç¬¬24æ¡ï¼šç”¨ç¼–è¾‘å™¨å¯¹è°ƒè¯•ç¨‹åºæ—¶æ‰€éœ€çš„æ•°æ®è¿›è¡Œæµè§ˆ"><a href="#ç¬¬24æ¡ï¼šç”¨ç¼–è¾‘å™¨å¯¹è°ƒè¯•ç¨‹åºæ—¶æ‰€éœ€çš„æ•°æ®è¿›è¡Œæµè§ˆ" class="headerlink" title="ç¬¬24æ¡ï¼šç”¨ç¼–è¾‘å™¨å¯¹è°ƒè¯•ç¨‹åºæ—¶æ‰€éœ€çš„æ•°æ®è¿›è¡Œæµè§ˆ"></a>ç¬¬24æ¡ï¼šç”¨ç¼–è¾‘å™¨å¯¹è°ƒè¯•ç¨‹åºæ—¶æ‰€éœ€çš„æ•°æ®è¿›è¡Œæµè§ˆ</h2><ul><li>ä½¿ç”¨ç¼–è¾‘å™¨çš„æœç´¢åŠŸèƒ½æ¥å¯»æ‰¾æ‹¼å†™æœ‰è¯¯çš„æ ‡è¯†ç¬¦ã€‚</li><li>å¯¹æ–‡æœ¬æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼Œä»¥çªå‡ºå…¶ä¸­çš„ä¸åŒç‚¹ã€‚</li><li>å¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼Œä»¤å…¶æ›´åŠ æ˜“è¯»ã€‚</li></ul><h2 id="ç¬¬25æ¡ï¼šä¼˜åŒ–å·¥ä½œç¯å¢ƒ"><a href="#ç¬¬25æ¡ï¼šä¼˜åŒ–å·¥ä½œç¯å¢ƒ" class="headerlink" title="ç¬¬25æ¡ï¼šä¼˜åŒ–å·¥ä½œç¯å¢ƒ"></a>ç¬¬25æ¡ï¼šä¼˜åŒ–å·¥ä½œç¯å¢ƒ</h2><ul><li>é€‚å½“åœ°é…ç½®è‡ªå·±æ‰€ç”¨çš„å·¥å…·ï¼Œä»¥æå‡å·¥ä½œæ•ˆç‡ã€‚</li><li>é€šè¿‡ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œåœ¨å„å°è®¡ç®—æœºä¹‹é—´å…±ç”¨åŒä¸€å¥—ç¯å¢ƒé…ç½®æ–¹æ¡ˆã€‚</li></ul><h2 id="ç¬¬26æ¡ï¼šç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿå¯»æ‰¾bugå‘ç”Ÿçš„åŸå› åŠç»è¿‡"><a href="#ç¬¬26æ¡ï¼šç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿå¯»æ‰¾bugå‘ç”Ÿçš„åŸå› åŠç»è¿‡" class="headerlink" title="ç¬¬26æ¡ï¼šç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿå¯»æ‰¾bugå‘ç”Ÿçš„åŸå› åŠç»è¿‡"></a>ç¬¬26æ¡ï¼šç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿå¯»æ‰¾bugå‘ç”Ÿçš„åŸå› åŠç»è¿‡</h2><ul><li>ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ¥æŸ¥çœ‹æ–‡ä»¶çš„ä¿®è®¢è®°å½•ï¼Œä»¥ç¡®å®šbugæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ã€ä»¥ä½•ç§æ–¹å¼å¼•å…¥çš„ã€‚</li><li>ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ¥æŸ¥çœ‹æ­£å¸¸è¿è¡Œçš„ç‰ˆæœ¬ä¸å‡ºç°æ•…éšœçš„ç‰ˆæœ¬ä¹‹é—´æœ‰ä½•åŒºåˆ«ã€‚</li></ul><h2 id="ç¬¬27æ¡ï¼šç”¨å·¥å…·ç›‘æµ‹ç”±å¤šä¸ªç‹¬ç«‹ç¨‹åºæ‰€æ„æˆçš„ç³»ç»Ÿ"><a href="#ç¬¬27æ¡ï¼šç”¨å·¥å…·ç›‘æµ‹ç”±å¤šä¸ªç‹¬ç«‹ç¨‹åºæ‰€æ„æˆçš„ç³»ç»Ÿ" class="headerlink" title="ç¬¬27æ¡ï¼šç”¨å·¥å…·ç›‘æµ‹ç”±å¤šä¸ªç‹¬ç«‹ç¨‹åºæ‰€æ„æˆçš„ç³»ç»Ÿ"></a>ç¬¬27æ¡ï¼šç”¨å·¥å…·ç›‘æµ‹ç”±å¤šä¸ªç‹¬ç«‹ç¨‹åºæ‰€æ„æˆçš„ç³»ç»Ÿ</h2><ul><li>è®¾å®šä¸€å¥—åŸºç¡€è®¾æ–½ç›‘æµ‹æœºåˆ¶ï¼Œä»¥æ£€æŸ¥ä½ æ‰€æä¾›çš„æœåŠ¡ä¸­çš„å„ä¸ªéƒ¨åˆ†ï¼Œæ˜¯å¦éƒ½åœ¨æ­£å¸¸åœ°è¿ä½œã€‚</li><li>ä½¿è‡ªå·±èƒ½å¤Ÿåœ¨æœåŠ¡å‘ç”Ÿæ•…éšœæ—¶è¿…é€Ÿå¾—åˆ°é€šçŸ¥ï¼Œä»¥ä¾¿åœ¨è¯¥çŠ¶æ€ä¸‹è°ƒè¯•ç³»ç»Ÿã€‚</li><li>æŸ¥é˜…æ•…éšœè®°å½•ï¼Œå¹¶è¯•ç€ä»ä¸­å‘ç°ä¸€äº›è§„å¾‹ï¼Œè¿™æ ·æˆ–è®¸èƒ½å¤Ÿå¸®åŠ©ä½ æ‰¾åˆ°é—®é¢˜çš„åŸå› ã€‚</li></ul><h1 id="ç¬¬4ç« -è°ƒè¯•å™¨çš„ä½¿ç”¨æŠ€å·§"><a href="#ç¬¬4ç« -è°ƒè¯•å™¨çš„ä½¿ç”¨æŠ€å·§" class="headerlink" title="ç¬¬4ç«  è°ƒè¯•å™¨çš„ä½¿ç”¨æŠ€å·§"></a>ç¬¬4ç«  è°ƒè¯•å™¨çš„ä½¿ç”¨æŠ€å·§</h1><h2 id="ç¬¬28æ¡ï¼šç¼–è¯‘ä»£ç æ—¶æŠŠç¬¦å·ä¿¡æ¯åŒ…å«è¿›æ¥ï¼Œä»¥ä¾¿äºè°ƒè¯•"><a href="#ç¬¬28æ¡ï¼šç¼–è¯‘ä»£ç æ—¶æŠŠç¬¦å·ä¿¡æ¯åŒ…å«è¿›æ¥ï¼Œä»¥ä¾¿äºè°ƒè¯•" class="headerlink" title="ç¬¬28æ¡ï¼šç¼–è¯‘ä»£ç æ—¶æŠŠç¬¦å·ä¿¡æ¯åŒ…å«è¿›æ¥ï¼Œä»¥ä¾¿äºè°ƒè¯•"></a>ç¬¬28æ¡ï¼šç¼–è¯‘ä»£ç æ—¶æŠŠç¬¦å·ä¿¡æ¯åŒ…å«è¿›æ¥ï¼Œä»¥ä¾¿äºè°ƒè¯•</h2><ul><li>å¯¹æ„å»ºç¨‹åºæ‰€ç”¨çš„é…ç½®é€‰é¡¹è¿›è¡Œè°ƒæ•´ï¼Œä½¿å¾—è°ƒè¯•ä¿¡æ¯çš„è¯¦ç»†ç¨‹åº¦ä¸ä½ çš„éœ€è¦ç›¸ç¬¦ã€‚</li><li>ç¦ç”¨ç¼–è¯‘å™¨çš„ä»£ç ä¼˜åŒ–åŠŸèƒ½ï¼Œä»¥ä¾¿ä½¿ç”Ÿæˆå‡ºæ¥çš„ä»£ç èƒ½å¤Ÿä¸ä½ æ‰€è¦è°ƒè¯•çš„ä»£ç ç›¸å¯¹åº”ã€‚</li></ul><h2 id="ç¬¬29æ¡ï¼šå¯¹ä»£ç è¿›è¡Œå•æ­¥è°ƒè¯•"><a href="#ç¬¬29æ¡ï¼šå¯¹ä»£ç è¿›è¡Œå•æ­¥è°ƒè¯•" class="headerlink" title="ç¬¬29æ¡ï¼šå¯¹ä»£ç è¿›è¡Œå•æ­¥è°ƒè¯•"></a>ç¬¬29æ¡ï¼šå¯¹ä»£ç è¿›è¡Œå•æ­¥è°ƒè¯•</h2><ul><li>é€šè¿‡å•æ­¥è°ƒè¯•æ¥æŸ¥çœ‹è¯­å¥çš„æ‰§è¡Œé¡ºåºåŠç¨‹åºçš„çŠ¶æ€ã€‚</li><li>ä¸ºäº†æå‡è°ƒè¯•é€Ÿåº¦ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç»è¿‡æŸäº›ä¸bugæ— å…³çš„éƒ¨åˆ†ï¼Œè€Œä¸ç”¨è¿›å…¥å…¶ä¸­ã€‚</li><li>å¦‚æœå‘ç°ç¨‹åºæ‰€ç»è¿‡çš„æŸä¸ªä¾‹ç¨‹æœ‰é—®é¢˜ï¼Œé‚£å°±ç»™è¯¥ä¾‹ç¨‹è®¾ç½®æ–­ç‚¹ï¼Œé‡æ–°è¿è¡Œç¨‹åºï¼Œå¹¶è¿›å…¥ä¾‹ç¨‹ä¸­è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œä»¥æ±‚ç¼©å°æœ‰å¾…æ’æŸ¥çš„èŒƒå›´ã€‚</li></ul><h2 id="ç¬¬30æ¡ï¼šè®¾ç½®ä»£ç æ–­ç‚¹å’Œæ•°æ®æ–­ç‚¹"><a href="#ç¬¬30æ¡ï¼šè®¾ç½®ä»£ç æ–­ç‚¹å’Œæ•°æ®æ–­ç‚¹" class="headerlink" title="ç¬¬30æ¡ï¼šè®¾ç½®ä»£ç æ–­ç‚¹å’Œæ•°æ®æ–­ç‚¹"></a>ç¬¬30æ¡ï¼šè®¾ç½®ä»£ç æ–­ç‚¹å’Œæ•°æ®æ–­ç‚¹</h2><ul><li>é€šè¿‡ä»£ç æ–­ç‚¹æ¥ç¼©å‡éœ€è¦å…³æ³¨çš„ä»£ç èŒƒå›´ã€‚</li><li>å¦‚æœæŸæ®µä»£ç ä¼šæ‰§è¡Œå¾ˆå¤šæ¬¡ï¼Œè€Œå…¶ä¸­åªæœ‰å°‘æ•°å‡ æ¬¡æ˜¯ä½ æ‰€å…³å¿ƒçš„ï¼Œé‚£ä¹ˆå°±å…ˆåœ¨å…¶æ‰§è¡Œè·¯å¾„çš„ä¸Šæ¸¸è®¾ç½®æ–­ç‚¹ï¼Œç­‰ç¨‹åºæš‚åœä¹‹åï¼Œå†ç»™è¿™æ®µä»£ç è®¾ç½®æ–­ç‚¹ã€‚</li><li>å¦‚æœè¦å¯¹éæ­£å¸¸é€€å‡ºçš„æƒ…å†µè¿›è¡Œè°ƒè¯•ï¼Œé‚£ä¹ˆå°±é’ˆå¯¹å¼‚å¸¸æˆ–é’ˆå¯¹ç¨‹åºåœ¨é€€å‡ºæ—¶æ‰€è°ƒç”¨çš„ä¾‹ç¨‹æ¥è®¾ç½®æ–­ç‚¹ã€‚</li><li>å¦‚æœç¨‹åºå¤±å»äº†å“åº”ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è°ƒè¯•å™¨é‡Œé¢ä»¤å…¶åœæ­¢æ‰§è¡Œã€‚</li><li>ç”¨æ•°æ®æ–­ç‚¹æ¥é”å®šé‚£äº›å¯¼è‡´å˜é‡å€¼æ„å¤–æ”¹å˜çš„bugã€‚</li></ul><h2 id="ç¬¬31æ¡ï¼šäº†è§£åå‘è°ƒè¯•åŠŸèƒ½"><a href="#ç¬¬31æ¡ï¼šäº†è§£åå‘è°ƒè¯•åŠŸèƒ½" class="headerlink" title="ç¬¬31æ¡ï¼šäº†è§£åå‘è°ƒè¯•åŠŸèƒ½"></a>ç¬¬31æ¡ï¼šäº†è§£åå‘è°ƒè¯•åŠŸèƒ½</h2><ul><li>äº†è§£åå‘è°ƒè¯•åŠŸèƒ½ã€‚</li></ul><h2 id="ç¬¬32æ¡ï¼šæŸ¥çœ‹ä¾‹ç¨‹ä¹‹é—´çš„ç›¸äº’è°ƒç”¨æƒ…å†µ"><a href="#ç¬¬32æ¡ï¼šæŸ¥çœ‹ä¾‹ç¨‹ä¹‹é—´çš„ç›¸äº’è°ƒç”¨æƒ…å†µ" class="headerlink" title="ç¬¬32æ¡ï¼šæŸ¥çœ‹ä¾‹ç¨‹ä¹‹é—´çš„ç›¸äº’è°ƒç”¨æƒ…å†µ"></a>ç¬¬32æ¡ï¼šæŸ¥çœ‹ä¾‹ç¨‹ä¹‹é—´çš„ç›¸äº’è°ƒç”¨æƒ…å†µ</h2><ul><li>æŸ¥çœ‹ç¨‹åºçš„æ ˆä¿¡æ¯ï¼Œä»¥äº†è§£å…¶æ‰§è¡ŒçŠ¶æ€ã€‚</li><li>å¦‚æœæ ˆä¿¡æ¯æ¯”è¾ƒä¹±ï¼Œé‚£è¯´æ˜ä»£ç å†™å¾—å¯èƒ½æœ‰é—®é¢˜ã€‚</li></ul><h2 id="ç¬¬33æ¡ï¼šæŸ¥çœ‹å˜é‡åŠè¡¨è¾¾å¼çš„å€¼ï¼Œä»¥å¯»æ‰¾ç¨‹åºä¸­çš„é”™è¯¯"><a href="#ç¬¬33æ¡ï¼šæŸ¥çœ‹å˜é‡åŠè¡¨è¾¾å¼çš„å€¼ï¼Œä»¥å¯»æ‰¾ç¨‹åºä¸­çš„é”™è¯¯" class="headerlink" title="ç¬¬33æ¡ï¼šæŸ¥çœ‹å˜é‡åŠè¡¨è¾¾å¼çš„å€¼ï¼Œä»¥å¯»æ‰¾ç¨‹åºä¸­çš„é”™è¯¯"></a>ç¬¬33æ¡ï¼šæŸ¥çœ‹å˜é‡åŠè¡¨è¾¾å¼çš„å€¼ï¼Œä»¥å¯»æ‰¾ç¨‹åºä¸­çš„é”™è¯¯</h2><ul><li>å¯¹é‡è¦çš„è¡¨è¾¾å¼è¿›è¡ŒéªŒè¯ï¼Œçœ‹çœ‹å®ƒä»¬çš„å€¼æ˜¯å¦æ­£ç¡®ã€‚</li><li>å¯¹è°ƒè¯•å™¨è¿›è¡Œè®¾ç½®ï¼Œä»¤å…¶èƒ½å¤Ÿåœ¨ç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŒç»­åœ°æ˜¾ç¤ºå‡ºè¡¨è¾¾å¼çš„å˜åŒ–æƒ…å†µã€‚</li><li>é€šè¿‡å±€éƒ¨å˜é‡æ¥äº†è§£ä¾‹ç¨‹çš„è¿è¡Œé€»è¾‘ã€‚</li><li>ç”¨æ•°æ®å¯è§†åŒ–æœºåˆ¶æ¥å±•ç¤ºå¤æ‚çš„æ•°æ®ç»“æ„ã€‚</li></ul><h2 id="ç¬¬34æ¡ï¼šäº†è§£æ€æ ·æŠŠè°ƒè¯•å™¨è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸Š"><a href="#ç¬¬34æ¡ï¼šäº†è§£æ€æ ·æŠŠè°ƒè¯•å™¨è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸Š" class="headerlink" title="ç¬¬34æ¡ï¼šäº†è§£æ€æ ·æŠŠè°ƒè¯•å™¨è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸Š"></a>ç¬¬34æ¡ï¼šäº†è§£æ€æ ·æŠŠè°ƒè¯•å™¨è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸Š</h2><ul><li>æŠŠè°ƒè¯•å™¨è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸Šé¢ï¼Œä»¥ä¾¿å¯¹å…¶è¿›è¡Œè°ƒè¯•ã€‚</li><li>é€šè¿‡è¿œç¨‹è°ƒè¯•æœºåˆ¶ï¼Œå¯¹è¿è¡Œåœ¨èµ„æºå—é™è®¾å¤‡ä¸Šé¢çš„åº”ç”¨ç¨‹åºè¿›è¡Œè°ƒè¯•ã€‚</li></ul><h2 id="ç¬¬35æ¡ï¼šäº†è§£æ€æ ·è¿ç”¨æ ¸å¿ƒè½¬å‚¨ä¿¡æ¯æ¥è¿›è¡Œè°ƒè¯•"><a href="#ç¬¬35æ¡ï¼šäº†è§£æ€æ ·è¿ç”¨æ ¸å¿ƒè½¬å‚¨ä¿¡æ¯æ¥è¿›è¡Œè°ƒè¯•" class="headerlink" title="ç¬¬35æ¡ï¼šäº†è§£æ€æ ·è¿ç”¨æ ¸å¿ƒè½¬å‚¨ä¿¡æ¯æ¥è¿›è¡Œè°ƒè¯•"></a>ç¬¬35æ¡ï¼šäº†è§£æ€æ ·è¿ç”¨æ ¸å¿ƒè½¬å‚¨ä¿¡æ¯æ¥è¿›è¡Œè°ƒè¯•</h2><ul><li>è·å–å¹¶æ£€è§†ç¨‹åºçš„å†…å­˜è½¬å‚¨ä¿¡æ¯ï¼Œä»¥ä¾¿å¯¹å‘ç”Ÿå´©æºƒå’Œå¤±å»å“åº”çš„åº”ç”¨ç¨‹åºè¿›è¡Œè°ƒè¯•ã€‚</li><li>æ‰“é€ ä¸€å¥—é”™è¯¯æŠ¥å‘Šç³»ç»Ÿï¼Œä»¥ä¾¿å¯¹å®¢æˆ·æ‰€å®‰è£…çš„åº”ç”¨ç¨‹åºè¿›è¡Œè°ƒè¯•ã€‚</li></ul><h2 id="ç¬¬36æ¡ï¼šæŠŠè°ƒè¯•å·¥å…·è®¾ç½®å¥½"><a href="#ç¬¬36æ¡ï¼šæŠŠè°ƒè¯•å·¥å…·è®¾ç½®å¥½" class="headerlink" title="ç¬¬36æ¡ï¼šæŠŠè°ƒè¯•å·¥å…·è®¾ç½®å¥½"></a>ç¬¬36æ¡ï¼šæŠŠè°ƒè¯•å·¥å…·è®¾ç½®å¥½</h2><ul><li>ä½¿ç”¨å¸¦æœ‰å›¾å½¢ç•Œé¢çš„è°ƒè¯•å™¨ã€‚</li><li>å¯¹gdbè¿›è¡Œé…ç½®ï¼Œä½¿å®ƒèƒ½å¤ŸæŠŠè¾“å…¥è¿‡çš„å‘½ä»¤ä¿å­˜ä¸‹æ¥ï¼Œå¹¶è®¾ç½®ä¸€å¥—ç¬¦åˆè‡ªå·±ä½¿ç”¨ä¹ æƒ¯çš„å¿«æ·é”®ã€‚</li><li>æŠŠå¸¸ç”¨çš„å‘½ä»¤æ”¾åœ¨gdbè„šæœ¬ä¸­ã€‚</li><li>ä¿®æ”¹å®Œæºä»£ç ä¹‹åï¼Œå¯ä»¥ä¸é‡æ–°å¯åŠ¨gdbï¼Œè€Œæ˜¯ç›´æ¥åœ¨gdbé‡Œé¢æ„å»ºç¨‹åºï¼Œä»¥ä¾¿ä¿ç•™ä½ åœ¨è¿™æ¬¡è°ƒè¯•ä¼šè¯ä¸­æ‰€è¾“å…¥è¿‡çš„å‘½ä»¤ã€‚</li></ul><h2 id="ç¬¬37æ¡ï¼šå­¦ä¼šæŸ¥çœ‹æ±‡ç¼–ä»£ç åŠåŸå§‹å†…å­˜"><a href="#ç¬¬37æ¡ï¼šå­¦ä¼šæŸ¥çœ‹æ±‡ç¼–ä»£ç åŠåŸå§‹å†…å­˜" class="headerlink" title="ç¬¬37æ¡ï¼šå­¦ä¼šæŸ¥çœ‹æ±‡ç¼–ä»£ç åŠåŸå§‹å†…å­˜"></a>ç¬¬37æ¡ï¼šå­¦ä¼šæŸ¥çœ‹æ±‡ç¼–ä»£ç åŠåŸå§‹å†…å­˜</h2><ul><li>æŸ¥çœ‹åæ±‡ç¼–åçš„æœºå™¨æŒ‡ä»¤ï¼Œä»¥äº†è§£ç¨‹åºä»£ç çš„åº•å±‚è¿ä½œæ–¹å¼ã€‚</li><li>æŸ¥çœ‹eaxæˆ–r0å¯„å­˜å™¨ï¼Œä»¥äº†è§£å‡½æ•°çš„è¿”å›å€¼ã€‚</li><li>æŸ¥çœ‹æ•°æ®åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºå½¢å¼ï¼Œä»¥äº†è§£å…¶åœ¨åº•å±‚çš„å­˜å‚¨æ–¹å¼ã€‚<ul><li>å°ç«¯åºï¼šIntelæ¶æ„ä»¥åŠå¤§å¤šæ•°ARM CPUï¼Œéƒ½é‡‡ç”¨è¿™ç§æ ¼å¼ã€‚</li><li>å¤§ç«¯åºï¼šå› ä¸ºTCP/IPç­‰é‡è¦çš„Internetåè®®ï¼Œä¼šé‡‡ç”¨è¿™ç§æ ¼å¼æ¥è¡¨ç¤ºæ•°æ®ï¼Œè€Œä¸”Javaåœ¨è¯»å–å’Œå†™å…¥äºŒè¿›åˆ¶æ•°æ®æ—¶ï¼Œä¹Ÿä¼šé‡‡ç”¨è¿™ç§æ ¼å¼æ¥è¿›è¡Œæ“ä½œã€‚</li></ul></li></ul><h1 id="ç¬¬5ç« -ç¼–ç¨‹æŠ€æœ¯"><a href="#ç¬¬5ç« -ç¼–ç¨‹æŠ€æœ¯" class="headerlink" title="ç¬¬5ç«  ç¼–ç¨‹æŠ€æœ¯"></a>ç¬¬5ç«  ç¼–ç¨‹æŠ€æœ¯</h1><h2 id="ç¬¬38æ¡ï¼šå¯¹å¯ç–‘çš„ä»£ç è¿›è¡Œè¯„å®¡ï¼Œå¹¶æ‰‹å·¥æ¼”ç»ƒè¿™äº›ä»£ç "><a href="#ç¬¬38æ¡ï¼šå¯¹å¯ç–‘çš„ä»£ç è¿›è¡Œè¯„å®¡ï¼Œå¹¶æ‰‹å·¥æ¼”ç»ƒè¿™äº›ä»£ç " class="headerlink" title="ç¬¬38æ¡ï¼šå¯¹å¯ç–‘çš„ä»£ç è¿›è¡Œè¯„å®¡ï¼Œå¹¶æ‰‹å·¥æ¼”ç»ƒè¿™äº›ä»£ç "></a>ç¬¬38æ¡ï¼šå¯¹å¯ç–‘çš„ä»£ç è¿›è¡Œè¯„å®¡ï¼Œå¹¶æ‰‹å·¥æ¼”ç»ƒè¿™äº›ä»£ç </h2><ul><li>æ£€æŸ¥ä»£ç é‡Œé¢æœ‰æ²¡æœ‰å¸¸è§çš„é”™è¯¯ã€‚</li><li>æ‰‹å·¥æ‰§è¡Œä»£ç ï¼Œä»¥éªŒè¯å…¶æ˜¯å¦æ­£ç¡®ã€‚</li><li>é€šè¿‡ç»˜å›¾æ¥è§£æå¤æ‚çš„æ•°æ®ç»“æ„ã€‚</li><li>åœ¨å¤§å‹çš„çº¸å¼ å’Œç™½æ¿ä¸Šé¢ï¼Œé€šè¿‡å„ç§é¢œè‰²çš„å›¾ç¤ºæ¥æ¼”ç®—å¤æ‚çš„é—®é¢˜ã€‚</li><li>åœ¨ç»˜å›¾çš„è¿‡ç¨‹ä¸­æ“ä½œå®ç‰©ï¼Œä»¥ä¾¿æ›´æ·±åœ°æŠ•å…¥åˆ°æ­£åœ¨ç ”ç©¶çš„é—®é¢˜ä¸­ã€‚</li></ul><h2 id="ç¬¬39æ¡ï¼šå®¡è¯»ä»£ç å¹¶ä¸åŒäº‹è®¨è®º"><a href="#ç¬¬39æ¡ï¼šå®¡è¯»ä»£ç å¹¶ä¸åŒäº‹è®¨è®º" class="headerlink" title="ç¬¬39æ¡ï¼šå®¡è¯»ä»£ç å¹¶ä¸åŒäº‹è®¨è®º"></a>ç¬¬39æ¡ï¼šå®¡è¯»ä»£ç å¹¶ä¸åŒäº‹è®¨è®º</h2><ul><li>æŠŠä»£ç è§£é‡Šç»™å°é»„é¸­å¬ã€‚</li><li>åšå¥½ä»£ç è¯„å®¡å·¥ä½œã€‚</li><li>é€šè¿‡è§’è‰²æ‰®æ¼”æ¥å¯¹æ¶‰åŠå¤šæ–¹çš„é—®é¢˜è¿›è¡Œè°ƒè¯•ã€‚</li></ul><h2 id="ç¬¬40æ¡ï¼šç»™è½¯ä»¶æ·»åŠ è°ƒè¯•æœºåˆ¶"><a href="#ç¬¬40æ¡ï¼šç»™è½¯ä»¶æ·»åŠ è°ƒè¯•æœºåˆ¶" class="headerlink" title="ç¬¬40æ¡ï¼šç»™è½¯ä»¶æ·»åŠ è°ƒè¯•æœºåˆ¶"></a>ç¬¬40æ¡ï¼šç»™è½¯ä»¶æ·»åŠ è°ƒè¯•æœºåˆ¶</h2><ul><li>ç»™ç¨‹åºæ·»åŠ ä¸€ä¸ªé€‰é¡¹ï¼Œä»¤å…¶èƒ½å¤Ÿè¿›å…¥è°ƒè¯•æ¨¡å¼ã€‚</li><li>æ·»åŠ ç›¸åº”çš„è°ƒè¯•å‘½ä»¤ï¼Œä½¿è°ƒè¯•è€…èƒ½å¤Ÿæ“æ§ç¨‹åºçš„çŠ¶æ€ã€è®°å½•å…¶æ‰€æ‰§è¡Œçš„æ“ä½œã€é™ä½å…¶åœ¨è¿è¡Œæ—¶çš„å¤æ‚ç¨‹åºã€è¿…é€Ÿåœ¨å…¶ç”¨æˆ·ç•Œé¢ä¹‹é—´è·³è½¬ï¼Œå¹¶å±•ç¤ºå¤æ‚çš„æ•°æ®ç»“æ„ã€‚</li><li>æ·»åŠ å‘½ä»¤è¡Œã€Webä»¥åŠä¸²è¡Œè¿æ¥ç­‰ç•Œé¢åŠæ¥å£ï¼Œä»¥ä¾¿å¯¹åµŒå…¥å¼è®¾å¤‡åŠæœåŠ¡å™¨è¿›è¡Œè°ƒè¯•ã€‚</li><li>åœ¨è°ƒè¯•æ¨¡å¼ä¸‹é€šè¿‡ä¸€äº›å‘½ä»¤æ¥æ¨¡æ‹Ÿé‚£äº›ä¸å¤–éƒ¨å› ç´ æœ‰å…³çš„é”™è¯¯ã€‚</li></ul><h2 id="ç¬¬41æ¡ï¼šæ·»åŠ æ—¥å¿—è¯­å¥"><a href="#ç¬¬41æ¡ï¼šæ·»åŠ æ—¥å¿—è¯­å¥" class="headerlink" title="ç¬¬41æ¡ï¼šæ·»åŠ æ—¥å¿—è¯­å¥"></a>ç¬¬41æ¡ï¼šæ·»åŠ æ—¥å¿—è¯­å¥</h2><ul><li>é€šè¿‡æ—¥å¿—è®°å½•è¯­å¥æ¥æ­å»ºä¸€å¥—å¯ä»¥æŒä¹…ç»´æŠ¤çš„åŸºç¡€è°ƒè¯•å¹³å°ã€‚</li><li>åº”è¯¥ç”¨ç°æœ‰çš„æ—¥å¿—æ¡†æ¶æ¥è®°å½•ï¼Œè€Œä¸è¦å»é‡æ–°åšä¸€å¥—æ¡†æ¶ã€‚</li><li>æ ¹æ®ä½ æ‰€å…³æ³¨çš„è¯é¢˜ä»¥åŠä½ æƒ³è¦è®°å½•çš„ç»†èŠ‚æ¥å¯¹æ—¥å¿—æ¡†æ¶è¿›è¡Œé…ç½®ã€‚</li></ul><h2 id="ç¬¬42æ¡ï¼šå¯¹è½¯ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•"><a href="#ç¬¬42æ¡ï¼šå¯¹è½¯ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•" class="headerlink" title="ç¬¬42æ¡ï¼šå¯¹è½¯ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•"></a>ç¬¬42æ¡ï¼šå¯¹è½¯ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•</h2><ul><li>é€šè¿‡å•å…ƒæµ‹è¯•æ¥æ£€æŸ¥å¯ç–‘çš„ä¾‹ç¨‹ï¼Œä»¥ä¾¿å‘ç°å…¶ä¸­çš„é”™è¯¯ã€‚</li><li>ä¸ºäº†æå‡æµ‹è¯•æ•ˆç‡ï¼Œæˆ‘ä»¬è¦é€‰ç”¨åˆé€‚çš„å•å…ƒæµ‹è¯•æ¡†æ¶ã€è¦é‡æ„äº§å“ä»£ç ï¼Œä½¿å…¶ä¾¿äºæ¥å—æµ‹è¯•ï¼Œå¹¶ä¸”è¦ä½¿æµ‹è¯•çš„æ‰§è¡Œå¾—ä»¥è‡ªåŠ¨åŒ–ã€‚</li></ul><h2 id="ç¬¬43æ¡ï¼šç”¨æ–­è¨€è¿›è¡Œè°ƒè¯•"><a href="#ç¬¬43æ¡ï¼šç”¨æ–­è¨€è¿›è¡Œè°ƒè¯•" class="headerlink" title="ç¬¬43æ¡ï¼šç”¨æ–­è¨€è¿›è¡Œè°ƒè¯•"></a>ç¬¬43æ¡ï¼šç”¨æ–­è¨€è¿›è¡Œè°ƒè¯•</h2><ul><li>ç”¨ä¸€äº›ä¸å•å…ƒæµ‹è¯•ç›¸äº’è¡¥å……çš„æ–­è¨€è¯­å¥æ¥æ›´åŠ ç²¾å‡†åœ°é”å®šä»£ç ä¸­çš„é”™è¯¯ã€‚</li><li>é€šè¿‡æ–­è¨€è¯­å¥æ¥è°ƒè¯•å¤æ‚çš„ç®—æ³•ï¼Œä»¥éªŒè¯å…¶å‰ç½®æ¡ä»¶ã€ä¸å˜æ¡ä»¶ä¸åç½®æ¡ä»¶æ˜¯å¦æˆç«‹ã€‚</li><li>åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œç”¨æ–­è¨€è¯­å¥æ¥è¡¨è¾¾è‡ªå·±å¯¹ä»£ç çš„ç†è§£ï¼Œå¹¶ç”¨å…¶æµ‹è¯•å¯ç–‘çš„ä»£ç ã€‚</li></ul><h2 id="ç¬¬44æ¡ï¼šæ”¹åŠ¨å—æµ‹ç¨‹åºï¼Œä»¥éªŒè¯è‡ªå·±çš„æ¨æƒ³"><a href="#ç¬¬44æ¡ï¼šæ”¹åŠ¨å—æµ‹ç¨‹åºï¼Œä»¥éªŒè¯è‡ªå·±çš„æ¨æƒ³" class="headerlink" title="ç¬¬44æ¡ï¼šæ”¹åŠ¨å—æµ‹ç¨‹åºï¼Œä»¥éªŒè¯è‡ªå·±çš„æ¨æƒ³"></a>ç¬¬44æ¡ï¼šæ”¹åŠ¨å—æµ‹ç¨‹åºï¼Œä»¥éªŒè¯è‡ªå·±çš„æ¨æƒ³</h2><ul><li>æ‰‹å·¥è®¾å®šä»£ç ä¸­çš„æŸäº›å€¼ï¼Œä»¥éªŒè¯å“ªäº›å–å€¼æ˜¯æ­£ç¡®çš„ï¼Œå“ªäº›å–å€¼æ˜¯é”™è¯¯çš„ã€‚</li><li>å¦‚æœæ‰¾ä¸åˆ°ä¿®æ”¹ä»£ç çš„æ­£ç¡®æ–¹æ³•ï¼Œå¯ä»¥è¯•ç€ç”¨å…¶ä»–çš„æ–¹å¼æ¥å®ç°å®ƒã€‚</li></ul><h2 id="ç¬¬45æ¡ï¼šå°½é‡ç¼©å°æ­£ç¡®èŒƒä¾‹ä¸é”™è¯¯ä»£ç ä¹‹é—´çš„å·®è·"><a href="#ç¬¬45æ¡ï¼šå°½é‡ç¼©å°æ­£ç¡®èŒƒä¾‹ä¸é”™è¯¯ä»£ç ä¹‹é—´çš„å·®è·" class="headerlink" title="ç¬¬45æ¡ï¼šå°½é‡ç¼©å°æ­£ç¡®èŒƒä¾‹ä¸é”™è¯¯ä»£ç ä¹‹é—´çš„å·®è·"></a>ç¬¬45æ¡ï¼šå°½é‡ç¼©å°æ­£ç¡®èŒƒä¾‹ä¸é”™è¯¯ä»£ç ä¹‹é—´çš„å·®è·</h2><p>é€æ¸ç¼©å‡ä½ è‡ªå·±çš„ä»£ç ï¼Œä½¿å…¶ä¸èŒƒä¾‹ä»£ç ç›¸ç¬¦ï¼Œæˆ–æ˜¯é€æ¸ä¿®æ”¹èŒƒä¾‹ä»£ç ï¼Œä½¿å…¶ä¸ä½ è‡ªå·±çš„ä»£ç ç›¸ç¬¦ï¼Œè¿™ä¸¤ç§åŠæ³•éƒ½å¯ä»¥ç”¨æ¥æŸ¥æ‰¾ç¨‹åºå‡ºé”™çš„åŸå› ã€‚</p><h2 id="ç¬¬46æ¡ï¼šç®€åŒ–å¯ç–‘ä»£ç "><a href="#ç¬¬46æ¡ï¼šç®€åŒ–å¯ç–‘ä»£ç " class="headerlink" title="ç¬¬46æ¡ï¼šç®€åŒ–å¯ç–‘ä»£ç "></a>ç¬¬46æ¡ï¼šç®€åŒ–å¯ç–‘ä»£ç </h2><ul><li>æœ‰é€‰æ‹©åœ°åˆ é™¤å¤§æ®µä»£ç ï¼Œä½¿é”™è¯¯å˜å¾—æ›´åŠ çªå‡ºã€‚</li><li>æŠŠå¤æ‚çš„è¯­å¥æˆ–å‡½æ•°æ‹†æˆå¤šä¸ªå°çš„éƒ¨åˆ†ï¼Œä»¥ä¾¿å•ç‹¬ç›‘æ§æˆ–æµ‹è¯•å…¶åŠŸèƒ½ã€‚</li><li>è€ƒè™‘å¼ƒç”¨é‚£äº›å¯èƒ½ä¼šå‡ºbugçš„å¤æ‚ç®—æ³•ï¼Œå¹¶æ”¹ç”¨ç®€å•ä¸€äº›çš„ç®—æ³•æ¥å®ç°ã€‚</li></ul><h2 id="ç¬¬47æ¡ï¼šå°†å¯ç–‘ä»£ç æ”¹ç”¨å¦å¤–ä¸€ç§ç¼–ç¨‹è¯­è¨€æ¥å†™"><a href="#ç¬¬47æ¡ï¼šå°†å¯ç–‘ä»£ç æ”¹ç”¨å¦å¤–ä¸€ç§ç¼–ç¨‹è¯­è¨€æ¥å†™" class="headerlink" title="ç¬¬47æ¡ï¼šå°†å¯ç–‘ä»£ç æ”¹ç”¨å¦å¤–ä¸€ç§ç¼–ç¨‹è¯­è¨€æ¥å†™"></a>ç¬¬47æ¡ï¼šå°†å¯ç–‘ä»£ç æ”¹ç”¨å¦å¤–ä¸€ç§ç¼–ç¨‹è¯­è¨€æ¥å†™</h2><ul><li>é‡‡ç”¨å¦å¤–ä¸€ç§è¡¨è¾¾èƒ½åŠ›æ›´å¼ºçš„è¯­è¨€æ¥æ”¹å†™é‚£äº›éš¾ä»¥ä¿®å¤çš„ä»£ç ï¼Œä»¥å‡å°‘å¯èƒ½å‡ºç°é—®é¢˜çš„è¯­å¥æ•°é‡ã€‚</li><li>æŠŠæœ‰bugçš„ä»£ç ç§»æ¤åˆ°æ›´å¥½çš„ç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œä»¥ä¾¿é‡‡ç”¨æ›´ä¸ºå¼ºå¤§çš„è°ƒè¯•å·¥å…·æ¥è§£å†³å…¶ä¸­çš„é—®é¢˜ã€‚</li><li>æŠŠæ–°çš„å®ç°æ–¹å¼å†™å¥½ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼æ¥å®ŒæˆåŸæœ‰çš„åŠŸèƒ½ï¼Œæˆ–æ˜¯å‚ç…§å®ƒæ¥ä¿®æ”¹æ—§çš„ä»£ç ã€‚</li></ul><h2 id="ç¬¬48æ¡ï¼šæ”¹å–„å¯ç–‘ä»£ç çš„å¯è¯»æ€§ä¸ç»“æ„"><a href="#ç¬¬48æ¡ï¼šæ”¹å–„å¯ç–‘ä»£ç çš„å¯è¯»æ€§ä¸ç»“æ„" class="headerlink" title="ç¬¬48æ¡ï¼šæ”¹å–„å¯ç–‘ä»£ç çš„å¯è¯»æ€§ä¸ç»“æ„"></a>ç¬¬48æ¡ï¼šæ”¹å–„å¯ç–‘ä»£ç çš„å¯è¯»æ€§ä¸ç»“æ„</h2><ul><li>ç”¨è¿è´¯çš„æ ¼å¼æ¥ä¿®æ•´ä»£ç ï¼Œä»¥å‡¸æ˜¾å…¶ä¸­çš„é”™è¯¯ã€‚</li><li>å¯¹ä»£ç è¿›è¡Œé‡æ„ï¼Œä»¥æ¶ˆé™¤é‚£äº›å“è´¨ä¸ä½³æˆ–æ¯«æ— ç”¨å¤„çš„å¤æ‚ç»“æ„ï¼Œä½¿æ½œè—åœ¨å…¶ä¸­çš„bugå¾—ä»¥æš´éœ²ã€‚</li></ul><h2 id="ç¬¬49æ¡ï¼šè¦æ¸…é™¤bugçš„æ ¹æºï¼Œè€Œä¸ä»…ä»…æ¶ˆé™¤å…¶ç—‡çŠ¶"><a href="#ç¬¬49æ¡ï¼šè¦æ¸…é™¤bugçš„æ ¹æºï¼Œè€Œä¸ä»…ä»…æ¶ˆé™¤å…¶ç—‡çŠ¶" class="headerlink" title="ç¬¬49æ¡ï¼šè¦æ¸…é™¤bugçš„æ ¹æºï¼Œè€Œä¸ä»…ä»…æ¶ˆé™¤å…¶ç—‡çŠ¶"></a>ç¬¬49æ¡ï¼šè¦æ¸…é™¤bugçš„æ ¹æºï¼Œè€Œä¸ä»…ä»…æ¶ˆé™¤å…¶ç—‡çŠ¶</h2><ul><li>ä¸è¦é‡‡ç”¨ä¸´æ—¶ä»£ç æ¥ç»•å¼€ç¨‹åºçš„è¡¨é¢ç—‡çŠ¶ï¼Œè€Œæ˜¯è¦æŸ¥æ‰¾bugçš„æ·±å±‚åŸå› å¹¶åŠ ä»¥ä¿®å¤ã€‚</li><li>å°½å¯èƒ½é‡‡ç”¨é€šç”¨çš„åŠæ³•æ¥å¤„ç†å¤æ‚çš„æƒ…å†µï¼Œè€Œä¸è¦åªä¿®å¤å…¶ä¸­çš„æŸäº›ç‰¹ä¾‹ã€‚</li></ul><h1 id="ç¬¬6ç« -ç¼–è¯‘æ—¶çš„è°ƒè¯•æŠ€æœ¯"><a href="#ç¬¬6ç« -ç¼–è¯‘æ—¶çš„è°ƒè¯•æŠ€æœ¯" class="headerlink" title="ç¬¬6ç«  ç¼–è¯‘æ—¶çš„è°ƒè¯•æŠ€æœ¯"></a>ç¬¬6ç«  ç¼–è¯‘æ—¶çš„è°ƒè¯•æŠ€æœ¯</h1><h2 id="ç¬¬50æ¡ï¼šå¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œæ£€è§†"><a href="#ç¬¬50æ¡ï¼šå¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œæ£€è§†" class="headerlink" title="ç¬¬50æ¡ï¼šå¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œæ£€è§†"></a>ç¬¬50æ¡ï¼šå¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œæ£€è§†</h2><ul><li>æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œä»¥ç†è§£æºä»£ç ä¸­ä¸ä¹‹å¯¹åº”çš„ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶é—®é¢˜ã€‚</li><li>é€šè¿‡ç¼–è¯‘å™¨çš„é€‰é¡¹æˆ–ç‰¹å®šçš„å·¥å…·ï¼ŒæŠŠè¿™äº›è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç å±•ç¤ºæˆæ˜“äºé˜…è¯»çš„å½¢å¼ã€‚</li></ul><h2 id="ç¬¬51æ¡ï¼šä½¿ç”¨é™æ€ç¨‹åºåˆ†æå·¥å…·"><a href="#ç¬¬51æ¡ï¼šä½¿ç”¨é™æ€ç¨‹åºåˆ†æå·¥å…·" class="headerlink" title="ç¬¬51æ¡ï¼šä½¿ç”¨é™æ€ç¨‹åºåˆ†æå·¥å…·"></a>ç¬¬51æ¡ï¼šä½¿ç”¨é™æ€ç¨‹åºåˆ†æå·¥å…·</h2><ul><li>æŸäº›ä¸“ç”¨çš„é™æ€ç¨‹åºåˆ†æå·¥å…·ï¼Œæœ‰å¯èƒ½ä¼šæ‰¾åˆ°å¾ˆå¤šæ½œåœ¨çš„bugï¼Œå…¶æ•°é‡è¦æ¯”ç¼–è¯‘å™¨æ‰€èƒ½ç»™å‡ºçš„è­¦å‘Šæ›´å¤šã€‚</li><li>æŠŠç¼–è¯‘å™¨é…ç½®å¥½ï¼Œä»¤å…¶èƒ½å¤Ÿå¯¹ç¨‹åºè¿›è¡Œé€‚å½“çš„åˆ†æï¼Œå¹¶æ‰¾å‡ºå…¶ä¸­çš„bugã€‚</li><li>è‡³å°‘è¦å°†ä¸€æ¬¾é™æ€ç¨‹åºåˆ†æå·¥å…·ï¼Œçº³å…¥ä½ çš„æ„å»ºæµç¨‹å’ŒæŒç»­é›†æˆæµç¨‹ä¸­ã€‚</li></ul><h2 id="ç¬¬52æ¡ï¼šå¯¹é¡¹ç›®è¿›è¡Œé…ç½®ï¼Œä»¤ç¨‹åºèƒ½å¤Ÿä»¥å›ºå®šçš„æ–¹å¼æ„å»ºå’Œæ‰§è¡Œ"><a href="#ç¬¬52æ¡ï¼šå¯¹é¡¹ç›®è¿›è¡Œé…ç½®ï¼Œä»¤ç¨‹åºèƒ½å¤Ÿä»¥å›ºå®šçš„æ–¹å¼æ„å»ºå’Œæ‰§è¡Œ" class="headerlink" title="ç¬¬52æ¡ï¼šå¯¹é¡¹ç›®è¿›è¡Œé…ç½®ï¼Œä»¤ç¨‹åºèƒ½å¤Ÿä»¥å›ºå®šçš„æ–¹å¼æ„å»ºå’Œæ‰§è¡Œ"></a>ç¬¬52æ¡ï¼šå¯¹é¡¹ç›®è¿›è¡Œé…ç½®ï¼Œä»¤ç¨‹åºèƒ½å¤Ÿä»¥å›ºå®šçš„æ–¹å¼æ„å»ºå’Œæ‰§è¡Œ</h2><p> å¯¹è½¯ä»¶çš„æ„å»ºæµç¨‹å’Œæ‰§è¡Œè¿‡ç¨‹è¿›è¡Œé…ç½®ï¼Œä½¿å…¶è¿è¡Œæ•ˆæœèƒ½å¤Ÿé‡ç°ã€‚</p><p> å¯¹è½¯ä»¶çš„æ„å»ºæµç¨‹å’Œæ‰§è¡Œè¿‡ç¨‹è¿›è¡Œé…ç½®ï¼Œä½¿å…¶è¿è¡Œæ•ˆæœèƒ½å¤Ÿé‡ç°ã€‚</p><h2 id="ç¬¬53æ¡ï¼šå¯¹è°ƒè¯•æ‰€ç”¨ç¨‹åºåº“åŠæ„å»ºä»£ç æ—¶æ‰€åº”æ‰§è¡Œçš„æ£€æŸ¥è¿›è¡Œé…ç½®"><a href="#ç¬¬53æ¡ï¼šå¯¹è°ƒè¯•æ‰€ç”¨ç¨‹åºåº“åŠæ„å»ºä»£ç æ—¶æ‰€åº”æ‰§è¡Œçš„æ£€æŸ¥è¿›è¡Œé…ç½®" class="headerlink" title="ç¬¬53æ¡ï¼šå¯¹è°ƒè¯•æ‰€ç”¨ç¨‹åºåº“åŠæ„å»ºä»£ç æ—¶æ‰€åº”æ‰§è¡Œçš„æ£€æŸ¥è¿›è¡Œé…ç½®"></a>ç¬¬53æ¡ï¼šå¯¹è°ƒè¯•æ‰€ç”¨ç¨‹åºåº“åŠæ„å»ºä»£ç æ—¶æ‰€åº”æ‰§è¡Œçš„æ£€æŸ¥è¿›è¡Œé…ç½®</h2><ul><li>åœ¨ä½ æ‰€å¤„çš„å¼€å‘ç¯å¢ƒä¸­ï¼Œæ‰¾å‡ºç¼–è¯‘å™¨å’Œç¨‹åºåº“æ‰€æ”¯æŒçš„è¿è¡Œæ—¶è°ƒè¯•åŠŸèƒ½ï¼Œå¹¶å¯ç”¨è¿™äº›åŠŸèƒ½ã€‚</li><li>å¦‚æœå¼€å‘ç¯å¢ƒé‡Œé¢æ²¡æœ‰è¿™æ ·çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘åœ¨æ„å»ºè½¯ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œçº³å…¥ä¸€äº›åŒ…å«è¯¥åŠŸèƒ½çš„ç¬¬ä¸‰æ–¹ç¨‹åºåº“ã€‚</li></ul><h1 id="ç¬¬7ç« -è¿è¡Œæ—¶çš„è°ƒè¯•æŠ€æœ¯"><a href="#ç¬¬7ç« -è¿è¡Œæ—¶çš„è°ƒè¯•æŠ€æœ¯" class="headerlink" title="ç¬¬7ç«  è¿è¡Œæ—¶çš„è°ƒè¯•æŠ€æœ¯"></a>ç¬¬7ç«  è¿è¡Œæ—¶çš„è°ƒè¯•æŠ€æœ¯</h1><h2 id="ç¬¬54æ¡ï¼šé€šè¿‡æ„å»ºæµ‹è¯•ç”¨ä¾‹æ¥å¯»æ‰¾é”™è¯¯"><a href="#ç¬¬54æ¡ï¼šé€šè¿‡æ„å»ºæµ‹è¯•ç”¨ä¾‹æ¥å¯»æ‰¾é”™è¯¯" class="headerlink" title="ç¬¬54æ¡ï¼šé€šè¿‡æ„å»ºæµ‹è¯•ç”¨ä¾‹æ¥å¯»æ‰¾é”™è¯¯"></a>ç¬¬54æ¡ï¼šé€šè¿‡æ„å»ºæµ‹è¯•ç”¨ä¾‹æ¥å¯»æ‰¾é”™è¯¯</h2><ul><li>åˆ›å»ºä¸€ä¸ªå¯é ä¸”æœ€ç®€çš„æµ‹è¯•ç”¨ä¾‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ æœ‰å¯èƒ½ä¼šå‘ç°ç¨‹åºä¸­çš„é—®é¢˜åŠå…¶è§£å†³åŠæ³•ã€‚</li><li>æŠŠæµ‹è¯•ç”¨ä¾‹ä½œä¸ºå•å…ƒæµ‹è¯•æˆ–å›å½’æµ‹è¯•ï¼ŒåµŒå…¥è½¯ä»¶ä¸­ã€‚</li></ul><h2 id="ç¬¬55æ¡ï¼šä»¤è½¯ä»¶åœ¨é‡åˆ°é—®é¢˜æ—¶å°½æ—©é€€å‡º"><a href="#ç¬¬55æ¡ï¼šä»¤è½¯ä»¶åœ¨é‡åˆ°é—®é¢˜æ—¶å°½æ—©é€€å‡º" class="headerlink" title="ç¬¬55æ¡ï¼šä»¤è½¯ä»¶åœ¨é‡åˆ°é—®é¢˜æ—¶å°½æ—©é€€å‡º"></a>ç¬¬55æ¡ï¼šä»¤è½¯ä»¶åœ¨é‡åˆ°é—®é¢˜æ—¶å°½æ—©é€€å‡º</h2><p>è°ƒè¯•ç¨‹åºçš„æ—¶å€™åº”è¯¥è®¾ç½®ä¸€äº›æœºå…³ï¼Œä½¿å¾—ç¨‹åºèƒ½å¤Ÿåœ¨åˆšåˆšæœ‰å‡ºé”™çš„è¿¹è±¡æ—¶ï¼Œå°±é€€å‡ºã€‚</p><h2 id="ç¬¬56æ¡ï¼šæ£€è§†åº”ç”¨ç¨‹åºçš„æ—¥å¿—æ–‡ä»¶"><a href="#ç¬¬56æ¡ï¼šæ£€è§†åº”ç”¨ç¨‹åºçš„æ—¥å¿—æ–‡ä»¶" class="headerlink" title="ç¬¬56æ¡ï¼šæ£€è§†åº”ç”¨ç¨‹åºçš„æ—¥å¿—æ–‡ä»¶"></a>ç¬¬56æ¡ï¼šæ£€è§†åº”ç”¨ç¨‹åºçš„æ—¥å¿—æ–‡ä»¶</h2><ul><li>é€šè¿‡æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æ¥å¯»æ‰¾åº”ç”¨ç¨‹åºå‡ºé”™çš„åŸå› ã€‚</li><li>æå‡åº”ç”¨ç¨‹åºåœ¨è®°å½•ä¿¡æ¯æ—¶æ‰€ç”¨çš„è¯¦ç»†ç¨‹åº¦ï¼Œä»¥ä¾¿æŠŠç¨‹åºå¤±è´¥çš„åŸå› è®°å½•ä¸‹æ¥ã€‚</li><li>å¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œé…ç½®åŠè¿‡æ»¤ï¼Œä»¥ç¼©å‡é—®é¢˜çš„æ’æŸ¥èŒƒå›´ã€‚</li></ul><h2 id="ç¬¬57æ¡ï¼šå¯¹ç³»ç»Ÿå’Œè¿›ç¨‹æ‰€æ‰§è¡Œçš„æ“ä½œè¿›è¡Œæ€§èƒ½è¯„æµ‹"><a href="#ç¬¬57æ¡ï¼šå¯¹ç³»ç»Ÿå’Œè¿›ç¨‹æ‰€æ‰§è¡Œçš„æ“ä½œè¿›è¡Œæ€§èƒ½è¯„æµ‹" class="headerlink" title="ç¬¬57æ¡ï¼šå¯¹ç³»ç»Ÿå’Œè¿›ç¨‹æ‰€æ‰§è¡Œçš„æ“ä½œè¿›è¡Œæ€§èƒ½è¯„æµ‹"></a>ç¬¬57æ¡ï¼šå¯¹ç³»ç»Ÿå’Œè¿›ç¨‹æ‰€æ‰§è¡Œçš„æ“ä½œè¿›è¡Œæ€§èƒ½è¯„æµ‹</h2><ul><li>æ£€æŸ¥CPUã€I/OåŠå†…å­˜çš„ä½¿ç”¨ç‡åŠé¥±å’Œåº¦ï¼Œä»¥ä¾¿åˆ†ææ€§èƒ½é—®é¢˜ã€‚</li><li>ç»™æœ‰é—®é¢˜çš„è¿›ç¨‹åšæ€§èƒ½åˆ†æï¼Œä»¥äº†è§£å…¶å¯¹CPUåŠå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œè¿›è€Œç¼©å°éœ€è¦æ’æŸ¥çš„ä»£ç èŒƒå›´ã€‚</li></ul><h2 id="ç¬¬58æ¡ï¼šè¿½è¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µ"><a href="#ç¬¬58æ¡ï¼šè¿½è¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µ" class="headerlink" title="ç¬¬58æ¡ï¼šè¿½è¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µ"></a>ç¬¬58æ¡ï¼šè¿½è¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µ</h2><ul><li>æˆ‘ä»¬å¯ä»¥åœ¨ä¸è®¿é—®æºä»£ç çš„å‰æä¸‹æ¥è¿½è¸ªç³»ç»Ÿä¸ç¨‹åºåº“çš„è°ƒç”¨æƒ…å†µï¼Œå¹¶ç›‘æµ‹ç¨‹åºçš„è¡Œä¸ºã€‚</li><li>è¦å­¦ä¼šä½¿ç”¨Windowsç³»ç»Ÿçš„Windows Performance Toolkitã€Linuxç³»ç»Ÿçš„Sys-temTapï¼Œä»¥åŠOS Xã€Solarisã€FreeBSDç³»ç»Ÿçš„Dtraceç­‰å·¥å…·ã€‚</li></ul><h2 id="ç¬¬59æ¡ï¼šä½¿ç”¨åŠ¨æ€ç¨‹åºåˆ†æå·¥å…·"><a href="#ç¬¬59æ¡ï¼šä½¿ç”¨åŠ¨æ€ç¨‹åºåˆ†æå·¥å…·" class="headerlink" title="ç¬¬59æ¡ï¼šä½¿ç”¨åŠ¨æ€ç¨‹åºåˆ†æå·¥å…·"></a>ç¬¬59æ¡ï¼šä½¿ç”¨åŠ¨æ€ç¨‹åºåˆ†æå·¥å…·</h2><p>ç”¨åŠ¨æ€ç¨‹åºåˆ†æå·¥å…·æ¥å¯»æ‰¾ä»£ç è¿è¡Œè¿‡ç¨‹ä¸­çš„å®é™…é—®é¢˜ã€‚</p><h1 id="ç¬¬8ç« -è°ƒè¯•å¤šçº¿ç¨‹çš„ä»£ç "><a href="#ç¬¬8ç« -è°ƒè¯•å¤šçº¿ç¨‹çš„ä»£ç " class="headerlink" title="ç¬¬8ç«  è°ƒè¯•å¤šçº¿ç¨‹çš„ä»£ç "></a>ç¬¬8ç«  è°ƒè¯•å¤šçº¿ç¨‹çš„ä»£ç </h1><h2 id="ç¬¬60æ¡ï¼šé€šè¿‡äº‹åè°ƒè¯•æ¥åˆ†ææ­»é”é—®é¢˜"><a href="#ç¬¬60æ¡ï¼šé€šè¿‡äº‹åè°ƒè¯•æ¥åˆ†ææ­»é”é—®é¢˜" class="headerlink" title="ç¬¬60æ¡ï¼šé€šè¿‡äº‹åè°ƒè¯•æ¥åˆ†ææ­»é”é—®é¢˜"></a>ç¬¬60æ¡ï¼šé€šè¿‡äº‹åè°ƒè¯•æ¥åˆ†ææ­»é”é—®é¢˜</h2><p>è¦æƒ³è°ƒè¯•æ­»é”é—®é¢˜ï¼Œå°±åº”è¯¥å¯¹æ­»é”çš„ç¨‹åºåšä¸€ä»½å¿«ç…§ï¼Œçœ‹çœ‹ç©¶ç«Ÿæœ‰å“ªäº›çº¿ç¨‹å’Œä»£ç ï¼Œåœ¨äº‰å¤ºåŒä¸€å¥—èµ„æºæ—¶é™·å…¥äº†åƒµå±€ã€‚</p><h2 id="ç¬¬61æ¡ï¼šæ•è·å¹¶é‡ç°"><a href="#ç¬¬61æ¡ï¼šæ•è·å¹¶é‡ç°" class="headerlink" title="ç¬¬61æ¡ï¼šæ•è·å¹¶é‡ç°"></a>ç¬¬61æ¡ï¼šæ•è·å¹¶é‡ç°</h2><p> è¦æƒ³æ¢æŸ¥é‚£ç§å¸¦æœ‰ä¸ç¡®å®šå› ç´ çš„å¹¶å‘é”™è¯¯ï¼Œé¦–å…ˆåº”è¯¥æŠŠæœ‰é—®é¢˜çš„æ‰§è¡Œè¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œç„¶åå¯¹è®°å½•åˆ°çš„ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œæ¥ä¸‹æ¥æ ¹æ®æ•è·åˆ°çš„è®°å½•æ–‡ä»¶ï¼Œåœ¨è°ƒè¯•å™¨é‡Œé¢å¯¹ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œé‡æ”¾ã€‚</p><h2 id="ç¬¬62æ¡ï¼šç”¨ä¸“é—¨çš„å·¥å…·æ¥æ¢æŸ¥æ­»é”ä¸ç«äº‰æ¡ä»¶é—®é¢˜"><a href="#ç¬¬62æ¡ï¼šç”¨ä¸“é—¨çš„å·¥å…·æ¥æ¢æŸ¥æ­»é”ä¸ç«äº‰æ¡ä»¶é—®é¢˜" class="headerlink" title="ç¬¬62æ¡ï¼šç”¨ä¸“é—¨çš„å·¥å…·æ¥æ¢æŸ¥æ­»é”ä¸ç«äº‰æ¡ä»¶é—®é¢˜"></a>ç¬¬62æ¡ï¼šç”¨ä¸“é—¨çš„å·¥å…·æ¥æ¢æŸ¥æ­»é”ä¸ç«äº‰æ¡ä»¶é—®é¢˜</h2><ul><li>ç”¨é™æ€åˆ†æå·¥å…·æ¥æ¢³ç†å¤šçº¿ç¨‹ä»£ç ï¼Œä»¥å¯»æ‰¾æœ‰å¯èƒ½å‘ç”Ÿçš„åŒæ­¥åŠé”å®šé”™è¯¯ã€‚</li><li>ç”¨åŠ¨æ€åˆ†æå·¥å…·æ¥è¿è¡Œå¤šçº¿ç¨‹ä»£ç ï¼Œä»¥å¯»æ‰¾å¯¹APIçš„è¯¯ç”¨ç°è±¡ï¼Œä»¥åŠæ½œåœ¨çš„æ­»é”ä¸æ•°æ®ç«äº‰é—®é¢˜ã€‚</li></ul><h2 id="ç¬¬63æ¡ï¼šæŠŠä¸ç¡®å®šçš„å› ç´ éš”ç¦»å‡ºæ¥ï¼Œæˆ–å°†å…¶ç§»é™¤"><a href="#ç¬¬63æ¡ï¼šæŠŠä¸ç¡®å®šçš„å› ç´ éš”ç¦»å‡ºæ¥ï¼Œæˆ–å°†å…¶ç§»é™¤" class="headerlink" title="ç¬¬63æ¡ï¼šæŠŠä¸ç¡®å®šçš„å› ç´ éš”ç¦»å‡ºæ¥ï¼Œæˆ–å°†å…¶ç§»é™¤"></a>ç¬¬63æ¡ï¼šæŠŠä¸ç¡®å®šçš„å› ç´ éš”ç¦»å‡ºæ¥ï¼Œæˆ–å°†å…¶ç§»é™¤</h2><ul><li>æŠŠå¹¶å‘ä»£ç ä¸å…¶ä»–ä»£ç éš”å¼€ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåˆ†åˆ«é’ˆå¯¹è¿™ä¸¤ä¸ªæ–¹é¢æ¥è¿ç”¨æœ€ä¸ºåˆé€‚çš„è°ƒè¯•å·¥å…·ä¸è°ƒè¯•æŠ€æœ¯ã€‚</li><li>åˆ›å»ºä¸€ä»½ä¸“ä¾›æµ‹è¯•ä¸è°ƒè¯•æ‰€ç”¨çš„é…ç½®æ–¹æ¡ˆï¼Œå¹¶é€šè¿‡æ¨¡æ‹Ÿå¯¹è±¡ç­‰æŠ€æœ¯ï¼ŒæŠŠä»£ç çš„è¡Œä¸ºå›ºå®šä¸‹æ¥ï¼Œä»è€Œä»¤ç¨‹åºåœ¨æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œéƒ½èƒ½å¤Ÿå±•ç¤ºå‡ºåŒæ ·çš„æ•ˆæœã€‚</li></ul><h2 id="ç¬¬64æ¡ï¼šæ£€æŸ¥èµ„æºäº‰ç”¨æƒ…å†µï¼Œä»¥è§£å†³ä¸å¯ä¼¸ç¼©æ€§æœ‰å…³çš„é—®é¢˜"><a href="#ç¬¬64æ¡ï¼šæ£€æŸ¥èµ„æºäº‰ç”¨æƒ…å†µï¼Œä»¥è§£å†³ä¸å¯ä¼¸ç¼©æ€§æœ‰å…³çš„é—®é¢˜" class="headerlink" title="ç¬¬64æ¡ï¼šæ£€æŸ¥èµ„æºäº‰ç”¨æƒ…å†µï¼Œä»¥è§£å†³ä¸å¯ä¼¸ç¼©æ€§æœ‰å…³çš„é—®é¢˜"></a>ç¬¬64æ¡ï¼šæ£€æŸ¥èµ„æºäº‰ç”¨æƒ…å†µï¼Œä»¥è§£å†³ä¸å¯ä¼¸ç¼©æ€§æœ‰å…³çš„é—®é¢˜</h2><p>ç”¨profilingå·¥å…·æ¥æ¢æŸ¥å¼•å‘ç«äº‰ç°è±¡çš„åŸå› ï¼Œä»¥è§£å†³å¤šçº¿ç¨‹ä»£ç ä¸­ä¸å¯ä¼¸ç¼©æ€§æœ‰å…³çš„é—®é¢˜ã€‚</p><h2 id="ç¬¬65æ¡ï¼šç”¨æ€§èƒ½è®¡æ•°å™¨å¯»æ‰¾ä¼ªå…±äº«é—®é¢˜"><a href="#ç¬¬65æ¡ï¼šç”¨æ€§èƒ½è®¡æ•°å™¨å¯»æ‰¾ä¼ªå…±äº«é—®é¢˜" class="headerlink" title="ç¬¬65æ¡ï¼šç”¨æ€§èƒ½è®¡æ•°å™¨å¯»æ‰¾ä¼ªå…±äº«é—®é¢˜"></a>ç¬¬65æ¡ï¼šç”¨æ€§èƒ½è®¡æ•°å™¨å¯»æ‰¾ä¼ªå…±äº«é—®é¢˜</h2><p>ç”¨profilingå·¥å…·æ¥ç›‘æ§æ€§èƒ½è®¡æ•°å™¨ï¼Œä»¥å¯»æ‰¾å¹¶è§£å†³ç¨‹åºä¸­çš„ä¼ªå…±äº«é—®é¢˜ã€‚</p><h2 id="ç¬¬66æ¡ï¼šè€ƒè™‘ç”¨æ›´ä¸ºé«˜çº§çš„æŠ½è±¡æœºåˆ¶æ¥é‡å†™ä»£ç "><a href="#ç¬¬66æ¡ï¼šè€ƒè™‘ç”¨æ›´ä¸ºé«˜çº§çš„æŠ½è±¡æœºåˆ¶æ¥é‡å†™ä»£ç " class="headerlink" title="ç¬¬66æ¡ï¼šè€ƒè™‘ç”¨æ›´ä¸ºé«˜çº§çš„æŠ½è±¡æœºåˆ¶æ¥é‡å†™ä»£ç "></a>ç¬¬66æ¡ï¼šè€ƒè™‘ç”¨æ›´ä¸ºé«˜çº§çš„æŠ½è±¡æœºåˆ¶æ¥é‡å†™ä»£ç </h2><p>ä¸ºäº†é¿å¼€å¹¶å‘æ–¹é¢çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ç”¨ç‰¹æ®Šçš„ç¼–ç¨‹è¯­è¨€ã€å¤„ç†æµç¨‹ã€å·¥å…·ã€æ¡†æ¶æˆ–ç¨‹åºåº“ç­‰æ›´ä¸ºé«˜çº§çš„åŠæ³•æ¥é‡æ–°å®ç°é‚£äº›å«æœ‰bugçš„å¹¶å‘ä»£ç ã€‚</p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Note/">Note</category>
      
      
      <category domain="https://pncalbl.github.io/tags/Debugging/">Debugging</category>
      
      <category domain="https://pncalbl.github.io/tags/Crash/">Crash</category>
      
      
      <comments>https://pncalbl.github.io/2021/09/02/Effective%20Debugging%20Note/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Java é¢è¯•</title>
      <link>https://pncalbl.github.io/2021/07/30/Java%E9%9D%A2%E8%AF%95/</link>
      <guid>https://pncalbl.github.io/2021/07/30/Java%E9%9D%A2%E8%AF%95/</guid>
      <pubDate>Thu, 29 Jul 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;ç¬¬ä¸€éƒ¨åˆ†-Java-å¹¶å‘ç¼–ç¨‹&quot;&gt;&lt;a href=&quot;#ç¬¬ä¸€éƒ¨åˆ†-Java-å¹¶å‘ç¼–ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬ä¸€éƒ¨åˆ† Java å¹¶å‘ç¼–ç¨‹&quot;&gt;&lt;/a&gt;ç¬¬ä¸€éƒ¨åˆ† Java å¹¶å‘ç¼–ç¨‹&lt;/h1&gt;&lt;h1 id=&quot;ç¬¬1ç« -è°ˆè°ˆVolatile&quot;&gt;&lt;</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="ç¬¬ä¸€éƒ¨åˆ†-Java-å¹¶å‘ç¼–ç¨‹"><a href="#ç¬¬ä¸€éƒ¨åˆ†-Java-å¹¶å‘ç¼–ç¨‹" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ† Java å¹¶å‘ç¼–ç¨‹"></a>ç¬¬ä¸€éƒ¨åˆ† Java å¹¶å‘ç¼–ç¨‹</h1><h1 id="ç¬¬1ç« -è°ˆè°ˆVolatile"><a href="#ç¬¬1ç« -è°ˆè°ˆVolatile" class="headerlink" title="ç¬¬1ç«  è°ˆè°ˆVolatile"></a>ç¬¬1ç«  è°ˆè°ˆVolatile</h1><h2 id="1-Volatileå’ŒJMMå†…å­˜æ¨¡å‹çš„å¯è§æ€§"><a href="#1-Volatileå’ŒJMMå†…å­˜æ¨¡å‹çš„å¯è§æ€§" class="headerlink" title="1 Volatileå’ŒJMMå†…å­˜æ¨¡å‹çš„å¯è§æ€§"></a>1 Volatileå’ŒJMMå†…å­˜æ¨¡å‹çš„å¯è§æ€§</h2><ul><li>JUCï¼ˆjava.util.concurrentï¼‰<ul><li>è¿›ç¨‹å’Œçº¿ç¨‹<ul><li>è¿›ç¨‹ï¼šåå°è¿è¡Œçš„ç¨‹åºï¼ˆæˆ‘ä»¬æ‰“å¼€çš„ä¸€ä¸ªè½¯ä»¶ï¼Œå°±æ˜¯è¿›ç¨‹ï¼‰</li><li>çº¿ç¨‹ï¼šè½»é‡çº§çš„è¿›ç¨‹ï¼Œå¹¶ä¸”ä¸€ä¸ªè¿›ç¨‹åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼ˆåŒåœ¨ä¸€ä¸ªè½¯ä»¶å†…ï¼ŒåŒæ—¶è¿è¡Œçª—å£ï¼Œå°±æ˜¯çº¿ç¨‹ï¼‰</li></ul></li><li>å¹¶å‘å’Œå¹¶è¡Œ<ul><li>å¹¶å‘ï¼šåŒæ—¶è®¿é—®æŸä¸ªä¸œè¥¿ï¼Œå°±æ˜¯å¹¶å‘</li><li>å¹¶è¡Œï¼šä¸€èµ·åšæŸäº›äº‹æƒ…ï¼Œå°±æ˜¯å¹¶è¡Œ</li></ul></li></ul></li><li>JUCä¸‹çš„ä¸‰ä¸ªåŒ…<ul><li>java.util.concurrent<ul><li>java.util.concurrent.atomic</li><li>java.util.concurrent.locks</li></ul></li></ul></li></ul><p>Volatileåœ¨æ—¥å¸¸çš„å•çº¿ç¨‹ç¯å¢ƒæ˜¯åº”ç”¨ä¸åˆ°çš„</p><ul><li>Volatileæ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„<code>è½»é‡çº§</code>çš„åŒæ­¥æœºåˆ¶ï¼ˆä¸‰å¤§ç‰¹æ€§ï¼‰<ul><li>ä¿è¯å¯è§æ€§</li><li>ä¸ä¿è¯åŸå­æ€§</li><li>ç¦æ­¢æŒ‡ä»¤é‡æ’</li></ul></li></ul><h3 id="1-1-è°ˆè°ˆå¯¹Volatileçš„ç†è§£"><a href="#1-1-è°ˆè°ˆå¯¹Volatileçš„ç†è§£" class="headerlink" title="1.1 è°ˆè°ˆå¯¹Volatileçš„ç†è§£"></a>1.1 è°ˆè°ˆå¯¹Volatileçš„ç†è§£</h3><h3 id="1-2-JMMæ˜¯ä»€ä¹ˆ"><a href="#1-2-JMMæ˜¯ä»€ä¹ˆ" class="headerlink" title="1.2 JMMæ˜¯ä»€ä¹ˆ"></a>1.2 JMMæ˜¯ä»€ä¹ˆ</h3><p>JMMæ˜¯Javaå†…å­˜æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯Java Memory Modelï¼Œç®€ç§°JMMï¼Œæœ¬èº«æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œå®ƒæè¿°çš„æ˜¯ä¸€ç»„è§„åˆ™æˆ–è§„èŒƒï¼Œé€šè¿‡è¿™ç»„è§„èŒƒå®šä¹‰äº†ç¨‹åºä¸­å„ä¸ªå˜é‡ï¼ˆåŒ…æ‹¬å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼‰çš„è®¿é—®æ–¹å¼</p><p>JMMå…³äºåŒæ­¥çš„è§„å®šï¼š</p><ul><li>çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„å€¼åˆ·æ–°å›ä¸»å†…å­˜</li><li>çº¿ç¨‹åŠ é”å‰ï¼Œå¿…é¡»è¯»å–ä¸»å†…å­˜çš„æœ€æ–°å€¼ï¼Œåˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜</li><li>åŠ é”å’Œè§£é”æ˜¯åŒä¸€æŠŠé”</li></ul><p>ç”±äºJVMè¿è¡Œç¨‹åºçš„å®ä½“æ˜¯çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹åˆ›å»ºæ—¶JVMéƒ½ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªå·¥ä½œå†…å­˜ï¼ˆæœ‰äº›åœ°æ–¹ç§°ä¸ºæ ˆç©ºé—´ï¼‰ï¼Œå·¥ä½œå†…å­˜æ˜¯æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®åŒºåŸŸï¼Œè€ŒJavaå†…å­˜æ¨¡å‹ä¸­è§„å®šæ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼Œä¸»å†…å­˜æ˜¯å…±äº«å†…å­˜åŒºåŸŸï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œ<code>ä½†çº¿ç¨‹å¯¹å˜é‡çš„æ“ä½œï¼ˆè¯»å–èµ‹å€¼ç­‰ï¼‰å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œé¦–å…ˆè¦å°†å˜é‡ä»ä¸»å†…å­˜æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ç©ºé—´ï¼Œç„¶åå¯¹å˜é‡è¿›è¡Œæ“ä½œï¼Œæ“ä½œå®Œæˆåå†å°†å˜é‡å†™ä¼šä¸»å†…å­˜</code>ï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå„ä¸ªçº¿ç¨‹ä¸­çš„å·¥ä½œå†…å­˜ä¸­å­˜å‚¨ç€ä¸»å†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬æ‹·è´ï¼Œå› æ­¤ä¸åŒçš„çº¿ç¨‹é—´æ— æ³•è®¿é—®å¯¹æ–¹çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼ˆä¼ å€¼ï¼‰å¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆï¼Œå…¶ç®€è¦è®¿é—®è¿‡ç¨‹ï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309153225758.png" alt="image-20200309153225758"></p><p>æ•°æ®ä¼ è¾“é€Ÿç‡ï¼šç¡¬ç›˜ &lt; å†…å­˜ &lt; &lt; cache &lt; CPU   </p><p>ä¸Šé¢æåˆ°äº†ä¸¤ä¸ªæ¦‚å¿µï¼šä¸»å†…å­˜  å’Œ å·¥ä½œå†…å­˜</p><ul><li><p>ä¸»å†…å­˜ï¼šå°±æ˜¯è®¡ç®—æœºçš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç»å¸¸æåˆ°çš„8Gå†…å­˜ï¼Œ16Gå†…å­˜</p></li><li><p>å·¥ä½œå†…å­˜ï¼šä½†æˆ‘ä»¬å®ä¾‹åŒ– new studentï¼Œé‚£ä¹ˆ age = 25 ä¹Ÿæ˜¯å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­</p><ul><li>å½“åŒæ—¶æœ‰ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—® studentä¸­çš„ageå˜é‡æ—¶ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ‹·è´ä¸€ä»½ï¼Œåˆ°å„è‡ªçš„å·¥ä½œå†…å­˜ï¼Œä»è€Œå®ç°äº†å˜é‡çš„æ‹·è´</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309154435933.png" alt="image-20200309154435933"></p></li></ul><p>å³ï¼šJMMå†…å­˜æ¨¡å‹çš„å¯è§æ€§ï¼ŒæŒ‡çš„æ˜¯å½“ä¸»å†…å­˜åŒºåŸŸä¸­çš„å€¼è¢«æŸä¸ªçº¿ç¨‹å†™å…¥æ›´æ”¹åï¼Œå…¶å®ƒçº¿ç¨‹ä¼šé©¬ä¸ŠçŸ¥æ™“æ›´æ”¹åçš„å€¼ï¼Œå¹¶é‡æ–°å¾—åˆ°æ›´æ”¹åçš„å€¼ã€‚</p><h3 id="1-3-ç¼“å­˜ä¸€è‡´æ€§"><a href="#1-3-ç¼“å­˜ä¸€è‡´æ€§" class="headerlink" title="1.3 ç¼“å­˜ä¸€è‡´æ€§"></a>1.3 ç¼“å­˜ä¸€è‡´æ€§</h3><p>ä¸ºä»€ä¹ˆè¿™é‡Œä¸»çº¿ç¨‹ä¸­æŸä¸ªå€¼è¢«æ›´æ”¹åï¼Œå…¶å®ƒçº¿ç¨‹èƒ½é©¬ä¸ŠçŸ¥æ™“å‘¢ï¼Ÿå…¶å®è¿™é‡Œæ˜¯ç”¨åˆ°äº†æ€»çº¿å—…æ¢æŠ€æœ¯</p><p>åœ¨è¯´å—…æ¢æŠ€æœ¯ä¹‹å‰ï¼Œé¦–å…ˆè°ˆè°ˆç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå°±æ˜¯å½“å¤šä¸ªå¤„ç†å™¨è¿ç®—ä»»åŠ¡éƒ½æ¶‰åŠåˆ°åŒä¸€å—ä¸»å†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªçš„ç¼“å­˜æ•°æ®ä¸ä¸€ã€‚</p><p>ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œéœ€è¦å„ä¸ªå¤„ç†å™¨è®¿é—®ç¼“å­˜æ—¶éƒ½éµå¾ªä¸€äº›åè®®ï¼Œåœ¨è¯»å†™æ—¶è¦æ ¹æ®åè®®è¿›è¡Œæ“ä½œï¼Œè¿™ç±»åè®®ä¸»è¦æœ‰MSIã€MESIç­‰ç­‰ã€‚</p><h4 id="1-MESI"><a href="#1-MESI" class="headerlink" title="1 MESI"></a>1 MESI</h4><p>å½“CPUå†™æ•°æ®æ—¶ï¼Œå¦‚æœå‘ç°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡ï¼Œå³åœ¨å…¶å®ƒCPUä¸­ä¹Ÿå­˜åœ¨è¯¥å˜é‡çš„å‰¯æœ¬ï¼Œä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶å®ƒCPUå°†è¯¥å†…å­˜å˜é‡çš„ç¼“å­˜è¡Œè®¾ç½®ä¸ºæ— æ•ˆï¼Œå› æ­¤å½“å…¶å®ƒCPUè¯»å–è¿™ä¸ªå˜é‡çš„æ—¶ï¼Œå‘ç°è‡ªå·±ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»å†…å­˜ä¸­é‡æ–°è¯»å–ã€‚</p><h4 id="2-æ€»çº¿å—…æ¢"><a href="#2-æ€»çº¿å—…æ¢" class="headerlink" title="2 æ€»çº¿å—…æ¢"></a>2 æ€»çº¿å—…æ¢</h4><p>é‚£ä¹ˆæ˜¯å¦‚ä½•å‘ç°æ•°æ®æ˜¯å¦å¤±æ•ˆå‘¢ï¼Ÿ</p><p>è¿™é‡Œæ˜¯ç”¨åˆ°äº†æ€»çº¿å—…æ¢æŠ€æœ¯ï¼Œå°±æ˜¯æ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜å€¼æ˜¯å¦è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±çš„ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»å†…å­˜ä¸­æŠŠæ•°æ®è¯»å–åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­ã€‚</p><h4 id="3-æ€»çº¿é£æš´"><a href="#3-æ€»çº¿é£æš´" class="headerlink" title="3 æ€»çº¿é£æš´"></a>3 æ€»çº¿é£æš´</h4><p>æ€»çº¿å—…æ¢æŠ€æœ¯æœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ</p><p>ç”±äºVolatileçš„MESIç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œéœ€è¦ä¸æ–­çš„ä»ä¸»å†…å­˜å—…æ¢å’ŒCASå¾ªç¯ï¼Œæ— æ•ˆçš„äº¤äº’ä¼šå¯¼è‡´æ€»çº¿å¸¦å®½è¾¾åˆ°å³°å€¼ã€‚å› æ­¤ä¸è¦å¤§é‡ä½¿ç”¨volatileå…³é”®å­—ï¼Œè‡³äºä»€ä¹ˆæ—¶å€™ä½¿ç”¨volatileã€ä»€ä¹ˆæ—¶å€™ç”¨é”ä»¥åŠSyschonizedéƒ½æ˜¯éœ€è¦æ ¹æ®å®é™…åœºæ™¯çš„ã€‚</p><h3 id="1-4-JMMçš„ç‰¹æ€§"><a href="#1-4-JMMçš„ç‰¹æ€§" class="headerlink" title="1.4 JMMçš„ç‰¹æ€§"></a>1.4 JMMçš„ç‰¹æ€§</h3><p>JMMçš„ä¸‰å¤§ç‰¹æ€§ï¼Œvolatileåªä¿è¯äº†ä¸¤ä¸ªï¼Œå³å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä¸æ»¡è¶³åŸå­æ€§</p><ul><li>å¯è§æ€§</li><li>åŸå­æ€§</li><li>æœ‰åºæ€§</li></ul><h3 id="1-5-å¯è§æ€§ä»£ç éªŒè¯"><a href="#1-5-å¯è§æ€§ä»£ç éªŒè¯" class="headerlink" title="1.5 å¯è§æ€§ä»£ç éªŒè¯"></a>1.5 å¯è§æ€§ä»£ç éªŒè¯</h3><p>ä½†æˆ‘ä»¬å¯¹äºæˆå‘˜å˜é‡æ²¡æœ‰æ·»åŠ ä»»ä½•ä¿®é¥°æ—¶ï¼Œæ˜¯æ— æ³•æ„ŸçŸ¥å…¶å®ƒçº¿ç¨‹ä¿®æ”¹åçš„å€¼</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.moxi.interview.study.thread;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Volatile Javaè™šæ‹Ÿæœºæä¾›çš„è½»é‡çº§åŒæ­¥æœºåˆ¶</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * å¯è§æ€§ï¼ˆåŠæ—¶é€šçŸ¥ï¼‰</span><span class="hljs-comment"> * ä¸ä¿è¯åŸå­æ€§</span><span class="hljs-comment"> * ç¦æ­¢æŒ‡ä»¤é‡æ’</span><span class="hljs-comment"> */</span><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å‡è®¾æ˜¯ä¸»ç‰©ç†å†…å­˜</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyData</span> </span>&#123;    <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addTo60</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">this</span>.number = <span class="hljs-number">60</span>;    &#125;&#125;<span class="hljs-comment">/**</span><span class="hljs-comment"> * éªŒè¯volatileçš„å¯è§æ€§</span><span class="hljs-comment"> * 1. å‡è®¾int number = 0ï¼Œ numberå˜é‡ä¹‹å‰æ²¡æœ‰æ·»åŠ volatileå…³é”®å­—ä¿®é¥°</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VolatileDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args [])</span> </span>&#123;        <span class="hljs-comment">// èµ„æºç±»</span>        MyData myData = <span class="hljs-keyword">new</span> MyData();        <span class="hljs-comment">// AAAçº¿ç¨‹ å®ç°äº†Runnableæ¥å£çš„ï¼Œlambdaè¡¨è¾¾å¼</span>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t come in&quot;</span>);            <span class="hljs-comment">// çº¿ç¨‹ç¡çœ 3ç§’ï¼Œå‡è®¾åœ¨è¿›è¡Œè¿ç®—</span>            <span class="hljs-keyword">try</span> &#123;                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-comment">// ä¿®æ”¹numberçš„å€¼</span>            myData.addTo60();            <span class="hljs-comment">// è¾“å‡ºä¿®æ”¹åçš„å€¼</span>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t update number value:&quot;</span> + myData.number);        &#125;, <span class="hljs-string">&quot;AAA&quot;</span>).start();        <span class="hljs-keyword">while</span>(myData.number == <span class="hljs-number">0</span>) &#123;            <span class="hljs-comment">// mainçº¿ç¨‹å°±ä¸€ç›´åœ¨è¿™é‡Œç­‰å¾…å¾ªç¯ï¼Œç›´åˆ°numberçš„å€¼ä¸ç­‰äºé›¶</span>        &#125;        <span class="hljs-comment">// æŒ‰é“ç†è¿™ä¸ªå€¼æ˜¯ä¸å¯èƒ½æ‰“å°å‡ºæ¥çš„ï¼Œå› ä¸ºä¸»çº¿ç¨‹è¿è¡Œçš„æ—¶å€™ï¼Œnumberçš„å€¼ä¸º0ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨å¾ªç¯</span>        <span class="hljs-comment">// å¦‚æœèƒ½è¾“å‡ºè¿™å¥è¯ï¼Œè¯´æ˜AAAçº¿ç¨‹åœ¨ç¡çœ 3ç§’åï¼Œæ›´æ–°çš„numberçš„å€¼ï¼Œé‡æ–°å†™å…¥åˆ°ä¸»å†…å­˜ï¼Œå¹¶è¢«mainçº¿ç¨‹æ„ŸçŸ¥åˆ°äº†</span>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t mission is over&quot;</span>);        <span class="hljs-comment">/**</span><span class="hljs-comment">         * æœ€åè¾“å‡ºç»“æœï¼š</span><span class="hljs-comment">         * AAA come in</span><span class="hljs-comment">         * AAA update number value:60</span><span class="hljs-comment">         * æœ€åçº¿ç¨‹æ²¡æœ‰åœæ­¢ï¼Œå¹¶è¡Œæ²¡æœ‰è¾“å‡º  mission is over è¿™å¥è¯ï¼Œè¯´æ˜æ²¡æœ‰ç”¨volatileä¿®é¥°çš„å˜é‡ï¼Œæ˜¯æ²¡æœ‰å¯è§æ€§</span><span class="hljs-comment">         */</span>    &#125;&#125;</code></pre></div><p>è¾“å‡ºç»“æœä¸º</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309162154191-1628001500488100.png" alt="image-20200309162154191">    </p><p>æœ€åçº¿ç¨‹æ²¡æœ‰åœæ­¢ï¼Œå¹¶è¡Œæ²¡æœ‰è¾“å‡º  mission is over è¿™å¥è¯ï¼Œè¯´æ˜æ²¡æœ‰ç”¨volatileä¿®é¥°çš„å˜é‡ï¼Œæ˜¯æ²¡æœ‰å¯è§æ€§</p><p>å½“æˆ‘ä»¬ä¿®æ”¹MyDataç±»ä¸­çš„æˆå‘˜å˜é‡æ—¶ï¼Œå¹¶ä¸”æ·»åŠ volatileå…³é”®å­—ä¿®é¥°</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å‡è®¾æ˜¯ä¸»ç‰©ç†å†…å­˜</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyData</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * volatile ä¿®é¥°çš„å…³é”®å­—ï¼Œæ˜¯ä¸ºäº†å¢åŠ  ä¸»çº¿ç¨‹å’Œçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å†…å­˜ä¸­çš„å€¼ï¼Œå…¶å®ƒçº¿ç¨‹ä¹Ÿèƒ½é©¬ä¸Šæ„ŸçŸ¥</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addTo60</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">this</span>.number = <span class="hljs-number">60</span>;    &#125;&#125;</code></pre></div><p>æœ€åè¾“å‡ºçš„ç»“æœä¸ºï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309162154191.png" alt="image-20200309162154191"></p><p>ä¸»çº¿ç¨‹ä¹Ÿæ‰§è¡Œå®Œæ¯•äº†ï¼Œè¯´æ˜volatileä¿®é¥°çš„å˜é‡ï¼Œæ˜¯å…·å¤‡JVMè½»é‡çº§åŒæ­¥æœºåˆ¶çš„ï¼Œèƒ½å¤Ÿæ„ŸçŸ¥å…¶å®ƒçº¿ç¨‹çš„ä¿®æ”¹åçš„å€¼ã€‚</p><h2 id="2-Volatileä¸ä¿è¯åŸå­æ€§"><a href="#2-Volatileä¸ä¿è¯åŸå­æ€§" class="headerlink" title="2 Volatileä¸ä¿è¯åŸå­æ€§"></a>2 Volatileä¸ä¿è¯åŸå­æ€§</h2><h3 id="2-1-å‰è¨€"><a href="#2-1-å‰è¨€" class="headerlink" title="2.1 å‰è¨€"></a>2.1 å‰è¨€</h3><p>é€šè¿‡å‰é¢å¯¹JMMçš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå„ä¸ªçº¿ç¨‹å¯¹ä¸»å†…å­˜ä¸­å…±äº«å˜é‡çš„æ“ä½œéƒ½æ˜¯å„ä¸ªçº¿ç¨‹å„è‡ªæ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜è¿›è¡Œæ“ä½œååœ¨å†™å›åˆ°ä¸»å†…å­˜ä¸­çš„ã€‚</p><p>è¿™å°±å¯èƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹AAAä¿®æ”¹äº†å…±äº«å˜é‡Xçš„å€¼ï¼Œä½†æ˜¯è¿˜æœªå†™å…¥ä¸»å†…å­˜æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹BBBåˆå¯¹ä¸»å†…å­˜ä¸­åŒä¸€å…±äº«å˜é‡Xè¿›è¡Œæ“ä½œï¼Œä½†æ­¤æ—¶Açº¿ç¨‹å·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡Xå¯¹çº¿ç¨‹Bæ¥è¯´æ˜¯ä¸å¯è§ï¼Œè¿™ç§å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿç°è±¡å°±é€ æˆäº†å¯è§æ€§é—®é¢˜ã€‚</p><h3 id="2-2-åŸå­æ€§"><a href="#2-2-åŸå­æ€§" class="headerlink" title="2.2 åŸå­æ€§"></a>2.2 åŸå­æ€§</h3><p>ä¸å¯åˆ†å‰²ï¼Œå®Œæ•´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ªçº¿ç¨‹æ­£åœ¨åšæŸä¸ªå…·ä½“ä¸šåŠ¡æ—¶ï¼Œä¸­é—´ä¸å¯ä»¥è¢«åŠ å¡æˆ–è€…è¢«åˆ†å‰²ï¼Œéœ€è¦å…·ä½“å®Œæˆï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚</p><p>æ•°æ®åº“ä¹Ÿç»å¸¸æåˆ°äº‹åŠ¡å…·å¤‡åŸå­æ€§</p><h3 id="2-3-ä»£ç æµ‹è¯•"><a href="#2-3-ä»£ç æµ‹è¯•" class="headerlink" title="2.3 ä»£ç æµ‹è¯•"></a>2.3 ä»£ç æµ‹è¯•</h3><p>ä¸ºäº†æµ‹è¯•volatileæ˜¯å¦ä¿è¯åŸå­æ€§ï¼Œæˆ‘ä»¬åˆ›å»ºäº†20ä¸ªçº¿ç¨‹ï¼Œç„¶åæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«å¾ªç¯1000æ¬¡ï¼Œæ¥è°ƒç”¨number++çš„æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java">MyData myData = <span class="hljs-keyword">new</span> MyData();<span class="hljs-comment">// åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹é‡Œé¢è¿›è¡Œ1000æ¬¡å¾ªç¯</span><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;    <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;        <span class="hljs-comment">// é‡Œé¢</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;            myData.addPlusPlus();        &#125;    &#125;, String.valueOf(i)).start();&#125;</code></pre></div><p>æœ€åé€šè¿‡ Thread.activeCount()ï¼Œæ¥æ„ŸçŸ¥20ä¸ªçº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œè¿™é‡Œåˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦å¤§äº2ï¼Œä¸ºä»€ä¹ˆæ˜¯2ï¼Ÿå› ä¸ºé»˜è®¤æ˜¯æœ‰ä¸¤ä¸ªçº¿ç¨‹çš„ï¼Œä¸€ä¸ªmainçº¿ç¨‹ï¼Œä¸€ä¸ªgcçº¿ç¨‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// éœ€è¦ç­‰å¾…ä¸Šé¢20ä¸ªçº¿ç¨‹éƒ½è®¡ç®—å®Œæˆåï¼Œåœ¨ç”¨mainçº¿ç¨‹å–å¾—æœ€ç»ˆçš„ç»“æœå€¼</span><span class="hljs-keyword">while</span>(Thread.activeCount() &gt; <span class="hljs-number">2</span>) &#123;    <span class="hljs-comment">// yieldè¡¨ç¤ºä¸æ‰§è¡Œ</span>    Thread.yield();&#125;</code></pre></div><p>ç„¶ååœ¨çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬åœ¨æŸ¥çœ‹numberçš„å€¼ï¼Œå‡è®¾volatileä¿è¯åŸå­æ€§çš„è¯ï¼Œé‚£ä¹ˆæœ€åè¾“å‡ºçš„å€¼åº”è¯¥æ˜¯</p><p>20 * 1000 = 20000,</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Volatile Javaè™šæ‹Ÿæœºæä¾›çš„è½»é‡çº§åŒæ­¥æœºåˆ¶</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * å¯è§æ€§ï¼ˆåŠæ—¶é€šçŸ¥ï¼‰</span><span class="hljs-comment"> * ä¸ä¿è¯åŸå­æ€§</span><span class="hljs-comment"> * ç¦æ­¢æŒ‡ä»¤é‡æ’</span><span class="hljs-comment"> */</span><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å‡è®¾æ˜¯ä¸»ç‰©ç†å†…å­˜</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyData</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * volatile ä¿®é¥°çš„å…³é”®å­—ï¼Œæ˜¯ä¸ºäº†å¢åŠ  ä¸»çº¿ç¨‹å’Œçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å†…å­˜ä¸­çš„å€¼ï¼Œå…¶å®ƒçº¿ç¨‹ä¹Ÿèƒ½é©¬ä¸Šæ„ŸçŸ¥</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addTo60</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">this</span>.number = <span class="hljs-number">60</span>;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ³¨æ„ï¼Œæ­¤æ—¶number å‰é¢æ˜¯åŠ äº†volatileä¿®é¥°</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addPlusPlus</span><span class="hljs-params">()</span> </span>&#123;        number ++;    &#125;&#125;<span class="hljs-comment">/**</span><span class="hljs-comment"> * éªŒè¯volatileçš„å¯è§æ€§</span><span class="hljs-comment"> * 1ã€ å‡è®¾int number = 0ï¼Œ numberå˜é‡ä¹‹å‰æ²¡æœ‰æ·»åŠ volatileå…³é”®å­—ä¿®é¥°</span><span class="hljs-comment"> * 2ã€æ·»åŠ äº†volatileï¼Œå¯ä»¥è§£å†³å¯è§æ€§é—®é¢˜</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * éªŒè¯volatileä¸ä¿è¯åŸå­æ€§</span><span class="hljs-comment"> * 1ã€åŸå­æ€§æŒ‡çš„æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VolatileDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args [])</span> </span>&#123;        MyData myData = <span class="hljs-keyword">new</span> MyData();        <span class="hljs-comment">// åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹é‡Œé¢è¿›è¡Œ1000æ¬¡å¾ªç¯</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                <span class="hljs-comment">// é‡Œé¢</span>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;                    myData.addPlusPlus();                &#125;            &#125;, String.valueOf(i)).start();        &#125;        <span class="hljs-comment">// éœ€è¦ç­‰å¾…ä¸Šé¢20ä¸ªçº¿ç¨‹éƒ½è®¡ç®—å®Œæˆåï¼Œåœ¨ç”¨mainçº¿ç¨‹å–å¾—æœ€ç»ˆçš„ç»“æœå€¼</span>        <span class="hljs-comment">// è¿™é‡Œåˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦å¤§äº2ï¼Œä¸ºä»€ä¹ˆæ˜¯2ï¼Ÿå› ä¸ºé»˜è®¤æ˜¯æœ‰ä¸¤ä¸ªçº¿ç¨‹çš„ï¼Œä¸€ä¸ªmainçº¿ç¨‹ï¼Œä¸€ä¸ªgcçº¿ç¨‹</span>        <span class="hljs-keyword">while</span>(Thread.activeCount() &gt; <span class="hljs-number">2</span>) &#123;            <span class="hljs-comment">// yieldè¡¨ç¤ºä¸æ‰§è¡Œ</span>            Thread.yield();        &#125;        <span class="hljs-comment">// æŸ¥çœ‹æœ€ç»ˆçš„å€¼</span>        <span class="hljs-comment">// å‡è®¾volatileä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆè¾“å‡ºçš„å€¼åº”è¯¥ä¸ºï¼š  20 * 1000 = 20000</span>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t finally number value: &quot;</span> + myData.number);    &#125;&#125;</code></pre></div><p>æœ€ç»ˆç»“æœæˆ‘ä»¬ä¼šå‘ç°ï¼Œnumberè¾“å‡ºçš„å€¼å¹¶æ²¡æœ‰20000ï¼Œè€Œä¸”æ˜¯æ¯æ¬¡è¿è¡Œçš„ç»“æœéƒ½ä¸ä¸€è‡´çš„ï¼Œè¿™è¯´æ˜äº†volatileä¿®é¥°çš„å˜é‡ä¸ä¿è¯åŸå­æ€§</p><p>ç¬¬ä¸€æ¬¡ï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309172900462.png" alt="image-20200309172900462"></p><p>ç¬¬äºŒæ¬¡ï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309172919295.png" alt="image-20200309172919295"></p><p>ç¬¬ä¸‰æ¬¡ï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309172929820.png" alt="image-20200309172929820"></p><h3 id="2-4-ä¸ºä»€ä¹ˆå‡ºç°æ•°å€¼ä¸¢å¤±"><a href="#2-4-ä¸ºä»€ä¹ˆå‡ºç°æ•°å€¼ä¸¢å¤±" class="headerlink" title="2.4 ä¸ºä»€ä¹ˆå‡ºç°æ•°å€¼ä¸¢å¤±"></a>2.4 ä¸ºä»€ä¹ˆå‡ºç°æ•°å€¼ä¸¢å¤±</h3><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309174220675.png" alt="image-20200309174220675"></p><p>å„è‡ªçº¿ç¨‹åœ¨å†™å…¥ä¸»å†…å­˜çš„æ—¶å€™ï¼Œå‡ºç°äº†æ•°æ®çš„ä¸¢å¤±ï¼Œè€Œå¼•èµ·çš„æ•°å€¼ç¼ºå¤±çš„é—®é¢˜</p><p>ä¸‹é¢æˆ‘ä»¬å°†ä¸€ä¸ªç®€å•çš„number++æ“ä½œï¼Œè½¬æ¢ä¸ºå­—èŠ‚ç æ–‡ä»¶ä¸€æ¢ç©¶ç«Ÿ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T1</span> </span>&#123;    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> n = <span class="hljs-number">0</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span> </span>&#123;        n++;    &#125;&#125;</code></pre></div><p>è½¬æ¢åçš„å­—èŠ‚ç æ–‡ä»¶</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">com</span>.<span class="hljs-title">moxi</span>.<span class="hljs-title">interview</span>.<span class="hljs-title">study</span>.<span class="hljs-title">thread</span>.<span class="hljs-title">T1</span> </span>&#123;  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> n;  <span class="hljs-keyword">public</span> com.moxi.interview.study.thread.T1();    Code:       <span class="hljs-number">0</span>: aload_0       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V       <span class="hljs-number">4</span>: aload_0       <span class="hljs-number">5</span>: iconst_0       6: putfield      #2                  // Field n:I       <span class="hljs-number">9</span>: <span class="hljs-keyword">return</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span>;    Code:       <span class="hljs-number">0</span>: aload_0       <span class="hljs-number">1</span>: dup       2: getfield      #2                  // Field n:I       <span class="hljs-number">5</span>: iconst_1       <span class="hljs-number">6</span>: iadd       7: putfield      #2                  // Field n:I      <span class="hljs-number">10</span>: <span class="hljs-keyword">return</span>&#125;</code></pre></div><p>è¿™é‡ŒæŸ¥çœ‹å­—èŠ‚ç çš„æ“ä½œï¼Œæ˜¯ç”¨åˆ°äº†IDEAçš„javapå‘½ä»¤</p><p>æˆ‘ä»¬é¦–å…ˆï¼Œä½¿ç”¨IDEAæä¾›çš„External Toolsï¼Œæ¥æ‰©å±•javapå‘½ä»¤</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309183026329.png" alt="image-20200309183026329"></p><p>å®Œæˆä¸Šè¿°æ“ä½œåï¼Œæˆ‘ä»¬åœ¨éœ€è¦æŸ¥çœ‹å­—èŠ‚ç çš„æ–‡ä»¶ä¸‹ï¼Œå³é”®é€‰æ‹© External Toolså³å¯</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309183115613.png" alt="image-20200309183115613"></p><p>å¦‚æœå‡ºç°äº†æ‰¾ä¸åˆ°æŒ‡å®šç±»ï¼Œé‚£æ˜¯å› ä¸ºæˆ‘ä»¬åˆ›å»ºçš„æ˜¯spring bootçš„mavené¡¹ç›®ï¼Œæˆ‘ä»¬ä¹‹å‰éœ€è¦æ‰§è¡Œmvn packageå‘½ä»¤ï¼Œè¿›è¡Œæ‰“åŒ…æ“ä½œï¼Œå°†å…¶ç¼–è¯‘æˆclassæ–‡ä»¶</p><p>ç§»åŠ¨åˆ°åº•éƒ¨ï¼Œæœ‰ä¸€ä»½å­—èŠ‚ç æŒ‡ä»¤å¯¹ç…§è¡¨ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œé˜…è¯»</p><p>ä¸‹é¢æˆ‘ä»¬å°±é’ˆå¯¹ add() è¿™ä¸ªæ–¹æ³•çš„å­—èŠ‚ç æ–‡ä»¶è¿›è¡Œåˆ†æ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span>;  Code:     <span class="hljs-number">0</span>: aload_0     <span class="hljs-number">1</span>: dup     2: getfield      #2    // Field n:I     <span class="hljs-number">5</span>: iconst_1     <span class="hljs-number">6</span>: iadd     7: putfield      #2    // Field n:I    <span class="hljs-number">10</span>: <span class="hljs-keyword">return</span></code></pre></div><p>æˆ‘ä»¬èƒ½å¤Ÿå‘ç° n++è¿™æ¡å‘½ä»¤ï¼Œè¢«æ‹†åˆ†æˆäº†3ä¸ªæŒ‡ä»¤</p><ul><li>æ‰§è¡Œ<code>getfield</code> ä»ä¸»å†…å­˜æ‹¿åˆ°åŸå§‹n</li><li>æ‰§è¡Œ<code>iadd</code> è¿›è¡ŒåŠ 1æ“ä½œ</li><li>æ‰§è¡Œ<code>putfileld</code> æŠŠç´¯åŠ åçš„å€¼å†™å›ä¸»å†…å­˜ </li></ul><p>å‡è®¾æˆ‘ä»¬æ²¡æœ‰åŠ  <code>synchronized</code>é‚£ä¹ˆç¬¬ä¸€æ­¥å°±å¯èƒ½å­˜åœ¨ç€ï¼Œä¸‰ä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡getfieldå‘½ä»¤ï¼Œæ‹¿åˆ°ä¸»å­˜ä¸­çš„ nå€¼ï¼Œç„¶åä¸‰ä¸ªçº¿ç¨‹ï¼Œå„è‡ªåœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡ŒåŠ 1æ“ä½œï¼Œä½†ä»–ä»¬å¹¶å‘è¿›è¡Œ  <code>iadd</code> å‘½ä»¤çš„æ—¶å€™ï¼Œå› ä¸ºåªèƒ½ä¸€ä¸ªè¿›è¡Œå†™ï¼Œæ‰€ä»¥å…¶å®ƒæ“ä½œä¼šè¢«æŒ‚èµ·ï¼Œå‡è®¾1çº¿ç¨‹ï¼Œå…ˆè¿›è¡Œäº†å†™æ“ä½œï¼Œåœ¨å†™å®Œåï¼Œvolatileçš„å¯è§æ€§ï¼Œåº”è¯¥éœ€è¦å‘Šè¯‰å…¶å®ƒä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸»å†…å­˜çš„å€¼å·²ç»è¢«ä¿®æ”¹äº†ï¼Œä½†æ˜¯å› ä¸ºå¤ªå¿«äº†ï¼Œå…¶å®ƒä¸¤ä¸ªçº¿ç¨‹ï¼Œé™†ç»­æ‰§è¡Œ <code>iadd</code>å‘½ä»¤ï¼Œè¿›è¡Œå†™å…¥æ“ä½œï¼Œè¿™å°±é€ æˆäº†å…¶ä»–çº¿ç¨‹æ²¡æœ‰æ¥å—åˆ°ä¸»å†…å­˜nçš„æ”¹å˜ï¼Œä»è€Œè¦†ç›–äº†åŸæ¥çš„å€¼ï¼Œå‡ºç°å†™ä¸¢å¤±ï¼Œè¿™æ ·ä¹Ÿå°±è®©æœ€ç»ˆçš„ç»“æœå°‘äº20000</p><h3 id="2-5-å¦‚ä½•è§£å†³"><a href="#2-5-å¦‚ä½•è§£å†³" class="headerlink" title="2.5 å¦‚ä½•è§£å†³"></a>2.5 å¦‚ä½•è§£å†³</h3><p>å› æ­¤è¿™ä¹Ÿè¯´æ˜ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ number ++ åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œè§£å†³çš„æ–¹æ³•æœ‰å“ªäº›å‘¢ï¼Ÿ</p><ul><li>åœ¨æ–¹æ³•ä¸ŠåŠ å…¥ synchronized</li></ul><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addPlusPlus</span><span class="hljs-params">()</span> </span>&#123;number ++;&#125;</code></pre></div><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309173315294.png" alt="image-20200309173315294"></p><p>æˆ‘ä»¬èƒ½å¤Ÿå‘ç°å¼•å…¥synchronizedå…³é”®å­—åï¼Œä¿è¯äº†è¯¥æ–¹æ³•æ¯æ¬¡åªèƒ½å¤Ÿä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè®¿é—®å’Œæ“ä½œï¼Œæœ€ç»ˆè¾“å‡ºçš„ç»“æœä¹Ÿå°±ä¸º20000</p><h3 id="2-6-å…¶å®ƒè§£å†³æ–¹æ³•"><a href="#2-6-å…¶å®ƒè§£å†³æ–¹æ³•" class="headerlink" title="2.6  å…¶å®ƒè§£å†³æ–¹æ³•"></a>2.6  å…¶å®ƒè§£å†³æ–¹æ³•</h3><p>ä¸Šé¢çš„æ–¹æ³•å¼•å…¥synchronizedï¼Œè™½ç„¶èƒ½å¤Ÿä¿è¯åŸå­æ€§ï¼Œä½†æ˜¯ä¸ºäº†è§£å†³number++ï¼Œè€Œå¼•å…¥é‡é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œæœ‰ç§ æ€é¸¡ç„‰ç”¨ç‰›åˆ€</p><p>é™¤äº†å¼•ç”¨synchronizedå…³é”®å­—å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨JUCä¸‹é¢çš„åŸå­åŒ…è£…ç±»ï¼Œå³åˆšåˆšçš„intç±»å‹çš„numberï¼Œå¯ä»¥ä½¿ç”¨AtomicIntegeræ¥ä»£æ›¿</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">     *  åˆ›å»ºä¸€ä¸ªåŸå­IntegeråŒ…è£…ç±»ï¼Œé»˜è®¤ä¸º0</span><span class="hljs-comment">      */</span>AtomicInteger atomicInteger = <span class="hljs-keyword">new</span> AtomicInteger();<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addAtomic</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-comment">// ç›¸å½“äº atomicInter ++</span>    atomicInteger.getAndIncrement();&#125;</code></pre></div><p>ç„¶ååŒç†ï¼Œç»§ç»­åˆšåˆšçš„æ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹é‡Œé¢è¿›è¡Œ1000æ¬¡å¾ªç¯</span><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;    <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;        <span class="hljs-comment">// é‡Œé¢</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;            myData.addPlusPlus();            myData.addAtomic();        &#125;    &#125;, String.valueOf(i)).start();&#125;</code></pre></div><p>æœ€åè¾“å‡º</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// å‡è®¾volatileä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆè¾“å‡ºçš„å€¼åº”è¯¥ä¸ºï¼š  20 * 1000 = 20000</span>System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t finally number value: &quot;</span> + myData.number);System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t finally atomicNumber value: &quot;</span> + myData.atomicInteger);</code></pre></div><p>ä¸‹é¢çš„ç»“æœï¼Œä¸€ä¸ªæ˜¯å¼•å…¥synchronizedï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨äº†åŸå­åŒ…è£…ç±»AtomicInteger</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200309205242622.png" alt="image-20200309205242622"></p><h2 id="3-Volatileç¦æ­¢æŒ‡ä»¤é‡æ’"><a href="#3-Volatileç¦æ­¢æŒ‡ä»¤é‡æ’" class="headerlink" title="3 Volatileç¦æ­¢æŒ‡ä»¤é‡æ’"></a>3 Volatileç¦æ­¢æŒ‡ä»¤é‡æ’</h2><p>è®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤é‡æ’ï¼Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p><div class="code-wrapper"><pre><code class="hljs clean">æºä»£ç  -&gt; ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’ -&gt; æŒ‡ä»¤å¹¶è¡Œçš„é‡æ’ -&gt; å†…å­˜ç³»ç»Ÿçš„é‡æ’ -&gt; æœ€ç»ˆæ‰§è¡ŒæŒ‡ä»¤</code></pre></div><p>å•çº¿ç¨‹ç¯å¢ƒé‡Œé¢ç¡®ä¿æœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºçš„ç»“æœä¸€è‡´</p><p>å¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶ï¼Œå¿…é¡»è¦è€ƒè™‘æŒ‡ä»¤ä¹‹é—´çš„<code>æ•°æ®ä¾èµ–æ€§</code></p><p>å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’çš„å­˜åœ¨ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œç»“æœæ— æ³•é¢„æµ‹ã€‚</p><h3 id="3-1-æŒ‡ä»¤é‡æ’-example-1"><a href="#3-1-æŒ‡ä»¤é‡æ’-example-1" class="headerlink" title="3.1 æŒ‡ä»¤é‡æ’ - example 1"></a>3.1 æŒ‡ä»¤é‡æ’ - example 1</h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mySort</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">int</span> x = <span class="hljs-number">11</span>;<span class="hljs-keyword">int</span> y = <span class="hljs-number">12</span>;x = x + <span class="hljs-number">5</span>;y = x * x;&#125;</code></pre></div><p>æŒ‰ç…§æ­£å¸¸å•çº¿ç¨‹ç¯å¢ƒï¼Œæ‰§è¡Œé¡ºåºæ˜¯ 1 2 3 4</p><p>ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯èƒ½å‡ºç°ä»¥ä¸‹çš„é¡ºåºï¼š</p><ul><li>2 1 3 4</li><li>1 3 2 4 </li></ul><p>ä¸Šè¿°çš„è¿‡ç¨‹å°±å¯ä»¥å½“åšæ˜¯æŒ‡ä»¤çš„é‡æ’ï¼Œå³å†…éƒ¨æ‰§è¡Œé¡ºåºï¼Œå’Œæˆ‘ä»¬çš„ä»£ç é¡ºåºä¸ä¸€æ ·</p><p>ä½†æ˜¯æŒ‡ä»¤é‡æ’ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼Œå³ä¸ä¼šå‡ºç°ä¸‹é¢çš„é¡ºåº</p><ul><li>4 3 2 1</li></ul><p>å› ä¸ºå¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’æ—¶å€™ï¼Œå¿…é¡»è€ƒè™‘åˆ°æŒ‡ä»¤ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§</p><p>å› ä¸ºæ­¥éª¤ 4ï¼šéœ€è¦ä¾èµ–äº yçš„ç”³æ˜ï¼Œä»¥åŠxçš„ç”³æ˜ï¼Œæ•…å› ä¸ºå­˜åœ¨æ•°æ®ä¾èµ–ï¼Œæ— æ³•é¦–å…ˆæ‰§è¡Œ</p><h4 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h4><p>int a,b,x,y = 0</p><table><thead><tr><th>çº¿ç¨‹1</th><th>çº¿ç¨‹2</th></tr></thead><tbody><tr><td>x = a;</td><td>y = b;</td></tr><tr><td>b = 1;</td><td>a = 2;</td></tr><tr><td></td><td></td></tr><tr><td>x = 0;  y = 0</td><td></td></tr></tbody></table><p>å› ä¸ºä¸Šé¢çš„ä»£ç ï¼Œä¸å­˜åœ¨æ•°æ®çš„ä¾èµ–æ€§ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯èƒ½å¯¹æ•°æ®è¿›è¡Œé‡æ’</p><table><thead><tr><th>çº¿ç¨‹1</th><th>çº¿ç¨‹2</th></tr></thead><tbody><tr><td>b = 1;</td><td>a = 2;</td></tr><tr><td>x = a;</td><td>y = b;</td></tr><tr><td></td><td></td></tr><tr><td>x = 2;  y = 1</td><td></td></tr></tbody></table><p>è¿™æ ·é€ æˆçš„ç»“æœï¼Œå’Œæœ€å¼€å§‹çš„å°±ä¸ä¸€è‡´äº†ï¼Œè¿™å°±æ˜¯å¯¼è‡´é‡æ’åï¼Œç»“æœå’Œæœ€å¼€å§‹çš„ä¸ä¸€æ ·ï¼Œå› æ­¤ä¸ºäº†é˜²æ­¢è¿™ç§ç»“æœå‡ºç°ï¼Œvolatileå°±è§„å®šç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</p><h3 id="3-2-æŒ‡ä»¤é‡æ’-example-2"><a href="#3-2-æŒ‡ä»¤é‡æ’-example-2" class="headerlink" title="3.2 æŒ‡ä»¤é‡æ’ - example 2"></a>3.2 æŒ‡ä»¤é‡æ’ - example 2</h3><p>æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ResortSeqDemo</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResortSeqDemo</span> </span>&#123;    <span class="hljs-keyword">int</span> a= <span class="hljs-number">0</span>;    <span class="hljs-keyword">boolean</span> flag = <span class="hljs-keyword">false</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method01</span><span class="hljs-params">()</span> </span>&#123;        a = <span class="hljs-number">1</span>;        flag = <span class="hljs-keyword">true</span>;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method02</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">if</span>(flag) &#123;            a = a + <span class="hljs-number">5</span>;            System.out.println(<span class="hljs-string">&quot;reValue:&quot;</span> + a);        &#125;    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬æŒ‰ç…§æ­£å¸¸çš„é¡ºåºï¼Œåˆ†åˆ«è°ƒç”¨method01()  å’Œ method02() é‚£ä¹ˆï¼Œæœ€ç»ˆè¾“å‡ºå°±æ˜¯ a = 6</p><p>ä½†æ˜¯å¦‚æœåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå› ä¸ºæ–¹æ³•1 å’Œ æ–¹æ³•2ï¼Œä»–ä»¬ä¹‹é—´ä¸èƒ½å­˜åœ¨æ•°æ®ä¾èµ–çš„é—®é¢˜ï¼Œå› æ­¤åŸå…ˆçš„é¡ºåºå¯èƒ½æ˜¯</p><div class="code-wrapper"><pre><code class="hljs java">a = <span class="hljs-number">1</span>;flag = <span class="hljs-keyword">true</span>;a = a + <span class="hljs-number">5</span>;System.out.println(<span class="hljs-string">&quot;reValue:&quot;</span> + a);</code></pre></div><p>ä½†æ˜¯åœ¨ç»è¿‡ç¼–è¯‘å™¨ï¼ŒæŒ‡ä»¤ï¼Œæˆ–è€…å†…å­˜çš„é‡æ’åï¼Œå¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs java">flag = <span class="hljs-keyword">true</span>;a = a + <span class="hljs-number">5</span>;System.out.println(<span class="hljs-string">&quot;reValue:&quot;</span> + a);a = <span class="hljs-number">1</span>;</code></pre></div><p>ä¹Ÿå°±æ˜¯å…ˆæ‰§è¡Œ flag = trueåï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹é©¬ä¸Šè°ƒç”¨æ–¹æ³•2ï¼Œæ»¡è¶³ flagçš„åˆ¤æ–­ï¼Œæœ€ç»ˆè®©a + 5ï¼Œç»“æœä¸º5ï¼Œè¿™æ ·åŒæ ·å‡ºç°äº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜</p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªç»“æœï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’çš„å­˜åœ¨ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œç»“æœæ— æ³•é¢„æµ‹ã€‚</p><p>è¿™æ ·å°±éœ€è¦é€šè¿‡volatileæ¥ä¿®é¥°ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§</p><h3 id="3-3-Volatileé’ˆå¯¹æŒ‡ä»¤é‡æ’åšäº†å•¥"><a href="#3-3-Volatileé’ˆå¯¹æŒ‡ä»¤é‡æ’åšäº†å•¥" class="headerlink" title="3.3 Volatileé’ˆå¯¹æŒ‡ä»¤é‡æ’åšäº†å•¥"></a>3.3 Volatileé’ˆå¯¹æŒ‡ä»¤é‡æ’åšäº†å•¥</h3><p>Volatileå®ç°ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ–ï¼Œä»è€Œé¿å…äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç¨‹åºå‡ºç°ä¹±åºæ‰§è¡Œçš„ç°è±¡</p><p>é¦–å…ˆäº†è§£ä¸€ä¸ªæ¦‚å¿µï¼Œå†…å­˜å±éšœï¼ˆMemory Barrierï¼‰åˆç§°å†…å­˜æ …æ ï¼Œæ˜¯ä¸€ä¸ªCPUæŒ‡ä»¤ï¼Œå®ƒçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p><ul><li>ä¿è¯ç‰¹å®šæ“ä½œçš„é¡ºåº</li><li>ä¿è¯æŸäº›å˜é‡çš„å†…å­˜å¯è§æ€§ï¼ˆåˆ©ç”¨è¯¥ç‰¹æ€§å®ç°volatileçš„å†…å­˜å¯è§æ€§ï¼‰</li></ul><p>ç”±äºç¼–è¯‘å™¨å’Œå¤„ç†å™¨éƒ½èƒ½æ‰§è¡ŒæŒ‡ä»¤é‡æ’çš„ä¼˜åŒ–ï¼Œå¦‚æœåœ¨æŒ‡ä»¤é—´æ’å…¥ä¸€æ¡Memory Barrieråˆ™ä¼šå‘Šè¯‰ç¼–è¯‘å™¨å’ŒCPUï¼Œä¸ç®¡ä»€ä¹ˆæŒ‡ä»¤éƒ½ä¸èƒ½å’Œè¿™æ¡Memory BarrieræŒ‡ä»¤é‡æ’åºï¼Œä¹Ÿå°±æ˜¯è¯´ <code>é€šè¿‡æ’å…¥å†…å­˜å±éšœç¦æ­¢åœ¨å†…å­˜å±éšœå‰åçš„æŒ‡ä»¤æ‰§è¡Œé‡æ’åºä¼˜åŒ–</code>ã€‚ å†…å­˜å±éšœå¦å¤–ä¸€ä¸ªä½œç”¨æ˜¯åˆ·æ–°å‡ºå„ç§CPUçš„ç¼“å­˜æ•°ï¼Œå› æ­¤ä»»ä½•CPUä¸Šçš„çº¿ç¨‹éƒ½èƒ½è¯»å–åˆ°è¿™äº›æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310162654437.png" alt="image-20200310162654437"></p><p>ä¹Ÿå°±æ˜¯è¿‡åœ¨Volatileçš„å†™ å’Œ è¯»çš„æ—¶å€™ï¼ŒåŠ å…¥å±éšœï¼Œé˜²æ­¢å‡ºç°æŒ‡ä»¤é‡æ’çš„</p><h3 id="3-4-çº¿ç¨‹å®‰å…¨è·å¾—ä¿è¯"><a href="#3-4-çº¿ç¨‹å®‰å…¨è·å¾—ä¿è¯" class="headerlink" title="3.4 çº¿ç¨‹å®‰å…¨è·å¾—ä¿è¯"></a>3.4 çº¿ç¨‹å®‰å…¨è·å¾—ä¿è¯</h3><p>å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿç°è±¡å¯¼è‡´çš„å¯è§æ€§é—®é¢˜</p><ul><li>å¯é€šè¿‡synchronizedæˆ–volatileå…³é”®å­—è§£å†³ï¼Œä»–ä»¬éƒ½å¯ä»¥ä½¿ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹åçš„å˜é‡ç«‹å³å¯¹å…¶å®ƒçº¿ç¨‹å¯è§</li></ul><p>å¯¹äºæŒ‡ä»¤é‡æ’å¯¼è‡´çš„å¯è§æ€§é—®é¢˜å’Œæœ‰åºæ€§é—®é¢˜</p><ul><li>å¯ä»¥ä½¿ç”¨volatileå…³é”®å­—è§£å†³ï¼Œå› ä¸ºvolatileå…³é”®å­—çš„å¦ä¸€ä¸ªä½œç”¨å°±æ˜¯ç¦æ­¢é‡æ’åºä¼˜åŒ–</li></ul><h3 id="3-5-æ€»çº¿å—…æ¢"><a href="#3-5-æ€»çº¿å—…æ¢" class="headerlink" title="3.5 æ€»çº¿å—…æ¢"></a>3.5 æ€»çº¿å—…æ¢</h3><h2 id="4-Volatileçš„åº”ç”¨"><a href="#4-Volatileçš„åº”ç”¨" class="headerlink" title="4 Volatileçš„åº”ç”¨"></a>4 Volatileçš„åº”ç”¨</h2><h3 id="å•ä¾‹æ¨¡å¼DCLä»£ç "><a href="#å•ä¾‹æ¨¡å¼DCLä»£ç " class="headerlink" title="å•ä¾‹æ¨¡å¼DCLä»£ç "></a>å•ä¾‹æ¨¡å¼DCLä»£ç </h3><p>é¦–å…ˆå›é¡¾ä¸€ä¸‹ï¼Œå•çº¿ç¨‹ä¸‹çš„å•ä¾‹æ¨¡å¼ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * SingletonDemoï¼ˆå•ä¾‹æ¨¡å¼ï¼‰</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingletonDemo</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingletonDemo instance = <span class="hljs-keyword">null</span>;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingletonDemo</span> <span class="hljs-params">()</span> </span>&#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æˆ‘æ˜¯æ„é€ æ–¹æ³•SingletonDemo&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingletonDemo <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>) &#123;            instance = <span class="hljs-keyword">new</span> SingletonDemo();        &#125;        <span class="hljs-keyword">return</span> instance;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// è¿™é‡Œçš„ == æ˜¯æ¯”è¾ƒå†…å­˜åœ°å€</span>        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());    &#125;&#125;</code></pre></div><p>æœ€åè¾“å‡ºçš„ç»“æœ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310164513408.png" alt="image-20200310164513408"></p><p>ä½†æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬çš„å•ä¾‹æ¨¡å¼æ˜¯å¦è¿˜æ˜¯åŒä¸€ä¸ªå¯¹è±¡äº†</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * SingletonDemoï¼ˆå•ä¾‹æ¨¡å¼ï¼‰</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingletonDemo</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingletonDemo instance = <span class="hljs-keyword">null</span>;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingletonDemo</span> <span class="hljs-params">()</span> </span>&#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æˆ‘æ˜¯æ„é€ æ–¹æ³•SingletonDemo&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingletonDemo <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>) &#123;            instance = <span class="hljs-keyword">new</span> SingletonDemo();        &#125;        <span class="hljs-keyword">return</span> instance;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                SingletonDemo.getInstance();            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><p>ä»ä¸‹é¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬é€šè¿‡SingletonDemo.getInstance() è·å–åˆ°çš„å¯¹è±¡ï¼Œå¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œè€Œæ˜¯è¢«ä¸‹é¢å‡ ä¸ªçº¿ç¨‹éƒ½è¿›è¡Œäº†åˆ›å»ºï¼Œé‚£ä¹ˆåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå•ä¾‹æ¨¡å¼å¦‚ä½•ä¿è¯å‘¢ï¼Ÿ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310164720940.png" alt="image-20200310164720940"></p><h4 id="1-è§£å†³æ–¹æ³•1"><a href="#1-è§£å†³æ–¹æ³•1" class="headerlink" title="1 è§£å†³æ–¹æ³•1"></a>1 è§£å†³æ–¹æ³•1</h4><p>å¼•å…¥synchronizedå…³é”®å­—</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> SingletonDemo <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>) &#123;        instance = <span class="hljs-keyword">new</span> SingletonDemo();    &#125;    <span class="hljs-keyword">return</span> instance;&#125;</code></pre></div><p>è¾“å‡ºç»“æœ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310164946940.png" alt="image-20200310164946940"></p><p>æˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼Œé€šè¿‡å¼•å…¥Synchronizedå…³é”®å­—ï¼Œèƒ½å¤Ÿè§£å†³é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å•ä¾‹æ¨¡å¼é—®é¢˜</p><p>ä½†æ˜¯synchronizedå±äºé‡é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œå®ƒåªå…è®¸ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®è·å–å®ä¾‹çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè€Œå‡ä½äº†å¹¶å‘æ€§ï¼Œå› æ­¤é‡‡ç”¨çš„æ¯”è¾ƒå°‘</p><h4 id="2-è§£å†³æ–¹æ³•2"><a href="#2-è§£å†³æ–¹æ³•2" class="headerlink" title="2 è§£å†³æ–¹æ³•2"></a>2 è§£å†³æ–¹æ³•2</h4><p>é€šè¿‡å¼•å…¥DCL   Double Check Lock   åŒç«¯æ£€é”æœºåˆ¶</p><p>å°±æ˜¯åœ¨è¿›æ¥å’Œå‡ºå»çš„æ—¶å€™ï¼Œè¿›è¡Œæ£€æµ‹</p><div class="code-wrapper"><pre><code class="hljs smali">public<span class="hljs-keyword"> static</span> SingletonDemo getInstance() &#123;    if(instance == null) &#123;        // åŒæ­¥ä»£ç æ®µçš„æ—¶å€™ï¼Œè¿›è¡Œæ£€æµ‹        synchronized (SingletonDemo.class) &#123;            if(instance == null) &#123;               <span class="hljs-built_in"> instance </span>=<span class="hljs-built_in"> new </span>SingletonDemo();            &#125;        &#125;    &#125;   <span class="hljs-built_in"> return </span>instance;&#125;</code></pre></div><p>æœ€åè¾“å‡ºçš„ç»“æœä¸ºï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310165703190.png" alt="image-20200310165703190"></p><p>ä»è¾“å‡ºç»“æœæ¥çœ‹ï¼Œç¡®å®èƒ½å¤Ÿä¿è¯å•ä¾‹æ¨¡å¼çš„æ­£ç¡®æ€§ï¼Œä½†æ˜¯ä¸Šé¢çš„æ–¹æ³•è¿˜æ˜¯å­˜åœ¨é—®é¢˜çš„</p><p>DCLï¼ˆåŒç«¯æ£€é”ï¼‰æœºåˆ¶ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸå› æ˜¯æœ‰æŒ‡ä»¤é‡æ’çš„å­˜åœ¨ï¼ŒåŠ å…¥volatileå¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’</p><p>åŸå› æ˜¯åœ¨æŸä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°ç¬¬ä¸€æ¬¡æ£€æµ‹çš„æ—¶å€™ï¼Œè¯»å–åˆ° instance ä¸ä¸ºnullï¼Œinstanceçš„å¼•ç”¨å¯¹è±¡å¯èƒ½æ²¡æœ‰å®Œæˆå®ä¾‹åŒ–ã€‚å› ä¸º instance = new SingletonDemo()ï¼›å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥è¿›è¡Œå®Œæˆï¼š</p><ul><li>memory = allocate();   // 1ã€åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´</li><li>instance(memory);   // 2ã€åˆå§‹åŒ–å¯¹è±¡</li><li>instance = memory;  // 3ã€è®¾ç½®instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶instance != null</li></ul><p>ä½†æ˜¯æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„ä¸‰ä¸ªæ­¥éª¤ï¼Œèƒ½å¤Ÿå‘ç°ï¼Œæ­¥éª¤2 å’Œ æ­¥éª¤3ä¹‹é—´ä¸å­˜åœ¨ æ•°æ®ä¾èµ–å…³ç³»ï¼Œè€Œä¸”æ— è®ºé‡æ’å‰ è¿˜æ˜¯é‡æ’åï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¿™ç§é‡æ’ä¼˜åŒ–æ˜¯å…è®¸çš„ã€‚</p><ul><li>memory = allocate();   // 1ã€åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´</li><li>instance = memory;  // 3ã€è®¾ç½®instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶instance != nullï¼Œä½†æ˜¯å¯¹è±¡è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆ</li><li>instance(memory);   // 2ã€åˆå§‹åŒ–å¯¹è±¡</li></ul><p>è¿™æ ·å°±ä¼šé€ æˆä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><p>ä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œåˆ°é‡æ’åçš„æ­¥éª¤2ï¼Œè¯•å›¾è·å–instanceçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°nullï¼Œå› ä¸ºå¯¹è±¡çš„åˆå§‹åŒ–è¿˜æ²¡æœ‰å®Œæˆï¼Œè€Œæ˜¯åœ¨é‡æ’åçš„æ­¥éª¤3æ‰å®Œæˆï¼Œå› æ­¤æ‰§è¡Œå•ä¾‹æ¨¡å¼çš„ä»£ç æ—¶å€™ï¼Œå°±ä¼šé‡æ–°åœ¨åˆ›å»ºä¸€ä¸ªinstanceå®ä¾‹</p><p><code>æŒ‡ä»¤é‡æ’åªä¼šä¿è¯ä¸²è¡Œè¯­ä¹‰çš„æ‰§è¡Œä¸€è‡´æ€§ï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œä½†å¹¶ä¸ä¼šå…³ç³»å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¸€è‡´æ€§</code></p><p>æ‰€ä»¥å½“ä¸€æ¡çº¿ç¨‹è®¿é—®instanceä¸ä¸ºnullæ—¶ï¼Œç”±äºinstanceå®ä¾‹æœªå¿…å·²åˆå§‹åŒ–å®Œæˆï¼Œè¿™å°±é€ æˆäº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</p><p>æ‰€ä»¥éœ€è¦å¼•å…¥volatileï¼Œæ¥ä¿è¯å‡ºç°æŒ‡ä»¤é‡æ’çš„é—®é¢˜ï¼Œä»è€Œä¿è¯å•ä¾‹æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨æ€§</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> SingletonDemo instance = <span class="hljs-keyword">null</span>;</code></pre></div><h4 id="3-æœ€ç»ˆä»£ç "><a href="#3-æœ€ç»ˆä»£ç " class="headerlink" title="3 æœ€ç»ˆä»£ç "></a>3 æœ€ç»ˆä»£ç </h4><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * SingletonDemoï¼ˆå•ä¾‹æ¨¡å¼ï¼‰</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingletonDemo</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> SingletonDemo instance = <span class="hljs-keyword">null</span>;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingletonDemo</span> <span class="hljs-params">()</span> </span>&#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æˆ‘æ˜¯æ„é€ æ–¹æ³•SingletonDemo&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingletonDemo <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-comment">// a åŒé‡æ£€æŸ¥åŠ é”å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¼šå‡ºç°æŸä¸ªçº¿ç¨‹è™½ç„¶è¿™é‡Œå·²ç»ä¸ºç©ºï¼Œä½†æ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç»æ‰§è¡Œåˆ°då¤„</span>            <span class="hljs-keyword">synchronized</span> (SingletonDemo.class) <span class="hljs-comment">//b</span>            &#123;            <span class="hljs-comment">//cä¸åŠ volitaleå…³é”®å­—çš„è¯æœ‰å¯èƒ½ä¼šå‡ºç°å°šæœªå®Œå…¨åˆå§‹åŒ–å°±è·å–åˆ°çš„æƒ…å†µã€‚åŸå› æ˜¯å†…å­˜æ¨¡å‹å…è®¸æ— åºå†™å…¥</span>                <span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>) &#123;                 <span class="hljs-comment">// d æ­¤æ—¶æ‰å¼€å§‹åˆå§‹åŒ–</span>                    instance = <span class="hljs-keyword">new</span> SingletonDemo();                &#125;            &#125;        &#125;        <span class="hljs-keyword">return</span> instance;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<span class="hljs-comment">//        // è¿™é‡Œçš„ == æ˜¯æ¯”è¾ƒå†…å­˜åœ°å€</span><span class="hljs-comment">//        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());</span><span class="hljs-comment">//        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());</span><span class="hljs-comment">//        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());</span><span class="hljs-comment">//        System.out.println(SingletonDemo.getInstance() == SingletonDemo.getInstance());</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                SingletonDemo.getInstance();            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><h1 id="ç¬¬2ç« -CASåº•å±‚åŸç†"><a href="#ç¬¬2ç« -CASåº•å±‚åŸç†" class="headerlink" title="ç¬¬2ç«  CASåº•å±‚åŸç†"></a>ç¬¬2ç«  CASåº•å±‚åŸç†</h1><h2 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1 æ¦‚å¿µ"></a>1 æ¦‚å¿µ</h2><p>CASçš„å…¨ç§°æ˜¯Compare-And-Swapï¼Œå®ƒæ˜¯CPUå¹¶å‘åŸè¯­</p><p>å®ƒçš„åŠŸèƒ½æ˜¯åˆ¤æ–­å†…å­˜æŸä¸ªä½ç½®çš„å€¼æ˜¯å¦ä¸ºé¢„æœŸå€¼ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ”¹ä¸ºæ–°çš„å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„</p><p>CASå¹¶å‘åŸè¯­ä½“ç°åœ¨Javaè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œï¼Œå†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨äºèŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h2 id="2-ä»£ç ä½¿ç”¨"><a href="#2-ä»£ç ä½¿ç”¨" class="headerlink" title="2 ä»£ç ä½¿ç”¨"></a>2 ä»£ç ä½¿ç”¨</h2><p>é¦–å…ˆè°ƒç”¨AtomicIntegeråˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼Œ å¹¶åˆå§‹åŒ–ä¸º5</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåŸå­ç±»</span>AtomicInteger atomicInteger = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">5</span>);</code></pre></div><p>ç„¶åè°ƒç”¨CASæ–¹æ³•ï¼Œä¼å›¾æ›´æ–°æˆ2019ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯5ï¼Œè¡¨ç¤ºæœŸæœ›å€¼ï¼Œç¬¬äºŒä¸ªå°±æ˜¯æˆ‘ä»¬è¦æ›´æ–°çš„å€¼</p><div class="code-wrapper"><pre><code class="hljs java">atomicInteger.compareAndSet(<span class="hljs-number">5</span>, <span class="hljs-number">2019</span>)</code></pre></div><p>ç„¶åå†æ¬¡ä½¿ç”¨äº†ä¸€ä¸ªæ–¹æ³•ï¼ŒåŒæ ·å°†å€¼æ”¹æˆ1024</p><div class="code-wrapper"><pre><code class="hljs java">atomicInteger.compareAndSet(<span class="hljs-number">5</span>, <span class="hljs-number">1024</span>)</code></pre></div><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * CASDemo</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * æ¯”è¾ƒå¹¶äº¤æ¢ï¼šcompareAndSet</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CASDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåŸå­ç±»</span>        AtomicInteger atomicInteger = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">5</span>);        <span class="hljs-comment">/**</span><span class="hljs-comment">         * ä¸€ä¸ªæ˜¯æœŸæœ›å€¼ï¼Œä¸€ä¸ªæ˜¯æ›´æ–°å€¼ï¼Œä½†æœŸæœ›å€¼å’ŒåŸæ¥çš„å€¼ç›¸åŒæ—¶ï¼Œæ‰èƒ½å¤Ÿæ›´æ”¹</span><span class="hljs-comment">         * å‡è®¾ä¸‰ç§’å‰ï¼Œæˆ‘æ‹¿çš„æ˜¯5ï¼Œä¹Ÿå°±æ˜¯expectä¸º5ï¼Œç„¶åæˆ‘éœ€è¦æ›´æ–°æˆ 2019</span><span class="hljs-comment">         */</span>        System.out.println(atomicInteger.compareAndSet(<span class="hljs-number">5</span>, <span class="hljs-number">2019</span>) + <span class="hljs-string">&quot;\t current data: &quot;</span> + atomicInteger.get());        System.out.println(atomicInteger.compareAndSet(<span class="hljs-number">5</span>, <span class="hljs-number">1024</span>) + <span class="hljs-string">&quot;\t current data: &quot;</span> + atomicInteger.get());    &#125;&#125;</code></pre></div><p>ä¸Šé¢ä»£ç çš„æ‰§è¡Œç»“æœä¸º</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310201327734.png" alt="image-20200310201327734"></p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ‰§è¡Œç¬¬ä¸€ä¸ªçš„æ—¶å€™ï¼ŒæœŸæœ›å€¼å’ŒåŸæœ¬å€¼æ˜¯æ»¡è¶³çš„ï¼Œå› æ­¤ä¿®æ”¹æˆåŠŸï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡åï¼Œä¸»å†…å­˜çš„å€¼å·²ç»ä¿®æ”¹æˆäº†2019ï¼Œä¸æ»¡è¶³æœŸæœ›å€¼ï¼Œå› æ­¤è¿”å›äº†falseï¼Œæœ¬æ¬¡å†™å…¥å¤±è´¥</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310201311367.png" alt="image-20200310201311367"></p><p>è¿™ä¸ªå°±ç±»ä¼¼äºSVNæˆ–è€…Gitçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœæ²¡æœ‰äººæ›´æ”¹è¿‡ï¼Œå°±èƒ½å¤Ÿæ­£å¸¸æäº¤ï¼Œå¦è€…éœ€è¦å…ˆå°†ä»£ç pullä¸‹æ¥ï¼Œåˆå¹¶ä»£ç åï¼Œç„¶åæäº¤</p><h2 id="3-CASåº•å±‚åŸç†"><a href="#3-CASåº•å±‚åŸç†" class="headerlink" title="3 CASåº•å±‚åŸç†"></a>3 CASåº•å±‚åŸç†</h2><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹çœ‹ atomicInteger.getAndIncrement()æ–¹æ³•çš„æºç </p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310203030720-162800144543982.png" alt="image-20200310203030720"></p><p>ä»è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ°ï¼Œåº•å±‚åˆè°ƒç”¨äº†ä¸€ä¸ªunsafeç±»çš„getAndAddIntæ–¹æ³•</p><h3 id="3-1-unsafeç±»"><a href="#3-1-unsafeç±»" class="headerlink" title="3.1 unsafeç±»"></a>3.1 unsafeç±»</h3><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310203350122.png" alt="image-20200310203350122"></p><p>Unsafeæ˜¯CASçš„æ ¸å¿ƒç±»ï¼Œç”±äºJavaæ–¹æ³•æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æ¥è®¿é—®ï¼ŒUnsafeç›¸å½“äºä¸€ä¸ªåé—¨ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šçš„å†…å­˜æ•°æ®ã€‚Unsafeç±»å­˜åœ¨sun.miscåŒ…ä¸­ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œå¯ä»¥åƒCçš„æŒ‡é’ˆä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ï¼Œå› ä¸ºJavaä¸­çš„CASæ“ä½œçš„æ‰§è¡Œä¾èµ–äºUnsafeç±»çš„æ–¹æ³•ã€‚</p><p><code>æ³¨æ„Unsafeç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯nativeä¿®é¥°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´unsafeç±»ä¸­çš„æ–¹æ³•éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”çš„ä»»åŠ¡</code></p><p>ä¸ºä»€ä¹ˆAtomicä¿®é¥°çš„åŒ…è£…ç±»ï¼Œèƒ½å¤Ÿä¿è¯åŸå­æ€§ï¼Œä¾é çš„å°±æ˜¯åº•å±‚çš„unsafeç±»</p><h3 id="3-2-å˜é‡valueOffset"><a href="#3-2-å˜é‡valueOffset" class="headerlink" title="3.2 å˜é‡valueOffset"></a>3.2 å˜é‡valueOffset</h3><p>è¡¨ç¤ºè¯¥å˜é‡å€¼åœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œå› ä¸ºUnsafeå°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®çš„ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310203030720.png" alt="image-20200310203030720"></p><p>ä»è¿™é‡Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œé€šè¿‡valueOffsetï¼Œç›´æ¥é€šè¿‡å†…å­˜åœ°å€ï¼Œè·å–åˆ°å€¼ï¼Œç„¶åè¿›è¡ŒåŠ 1çš„æ“ä½œ</p><h3 id="3-3-å˜é‡valueç”¨volatileä¿®é¥°"><a href="#3-3-å˜é‡valueç”¨volatileä¿®é¥°" class="headerlink" title="3.3 å˜é‡valueç”¨volatileä¿®é¥°"></a>3.3 å˜é‡valueç”¨volatileä¿®é¥°</h3><p>ä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200310210701761.png" alt="image-20200310210701761"></p><p>var5ï¼šå°±æ˜¯æˆ‘ä»¬ä»ä¸»å†…å­˜ä¸­æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­çš„å€¼(æ¯æ¬¡éƒ½è¦ä»ä¸»å†…å­˜æ‹¿åˆ°æœ€æ–°çš„å€¼åˆ°è‡ªå·±çš„æœ¬åœ°å†…å­˜ï¼Œç„¶åæ‰§è¡ŒcompareAndSwapInt()åœ¨å†å’Œä¸»å†…å­˜çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚å› ä¸ºçº¿ç¨‹ä¸å¯ä»¥ç›´æ¥è¶Šè¿‡é«˜é€Ÿç¼“å­˜ï¼Œç›´æ¥æ“ä½œä¸»å†…å­˜ï¼Œæ‰€ä»¥æ‰§è¡Œä¸Šè¿°æ–¹æ³•éœ€è¦æ¯”è¾ƒä¸€æ¬¡ï¼Œåœ¨æ‰§è¡ŒåŠ 1æ“ä½œ)</p><p>é‚£ä¹ˆæ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦æ¯”è¾ƒå·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼Œå’Œä¸»å†…å­˜ä¸­çš„å€¼è¿›è¡Œæ¯”è¾ƒ</p><p>å‡è®¾æ‰§è¡Œ compareAndSwapIntè¿”å›falseï¼Œé‚£ä¹ˆå°±ä¸€ç›´æ‰§è¡Œ whileæ–¹æ³•ï¼Œç›´åˆ°æœŸæœ›çš„å€¼å’ŒçœŸå®å€¼ä¸€æ ·</p><ul><li>val1ï¼šAtomicIntegerå¯¹è±¡æœ¬èº«</li><li>var2ï¼šè¯¥å¯¹è±¡å€¼å¾—å¼•ç”¨åœ°å€</li><li>var4ï¼šéœ€è¦å˜åŠ¨çš„æ•°é‡</li><li>var5ï¼šç”¨var1å’Œvar2æ‰¾åˆ°çš„å†…å­˜ä¸­çš„çœŸå®å€¼<ul><li>ç”¨è¯¥å¯¹è±¡å½“å‰çš„å€¼ä¸var5æ¯”è¾ƒ</li><li>å¦‚æœç›¸åŒï¼Œæ›´æ–°var5 + var4 å¹¶è¿”å›true</li><li>å¦‚æœä¸åŒï¼Œç»§ç»­å–å€¼ç„¶åå†æ¯”è¾ƒï¼Œç›´åˆ°æ›´æ–°å®Œæˆ</li></ul></li></ul><p>è¿™é‡Œæ²¡æœ‰ç”¨synchronizedï¼Œè€Œç”¨CASï¼Œè¿™æ ·æé«˜äº†å¹¶å‘æ€§ï¼Œä¹Ÿèƒ½å¤Ÿå®ç°ä¸€è‡´æ€§ï¼Œæ˜¯å› ä¸ºæ¯ä¸ªçº¿ç¨‹è¿›æ¥åï¼Œè¿›å…¥çš„do whileå¾ªç¯ï¼Œç„¶åä¸æ–­çš„è·å–å†…å­˜ä¸­çš„å€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæœ€æ–°ï¼Œç„¶ååœ¨è¿›è¡Œæ›´æ–°æ“ä½œã€‚</p><p>å‡è®¾çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶æ‰§è¡ŒgetAndIntæ“ä½œï¼ˆåˆ†åˆ«è·‘åœ¨ä¸åŒçš„CPUä¸Šï¼‰</p><ol><li>AtomicIntegeré‡Œé¢çš„valueåŸå§‹å€¼ä¸º3ï¼Œå³ä¸»å†…å­˜ä¸­AtomicIntegerçš„ value ä¸º3ï¼Œæ ¹æ®JMMæ¨¡å‹ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bå„è‡ªæŒæœ‰ä¸€ä»½ä»·å€¼ä¸º3çš„å‰¯æœ¬ï¼Œåˆ†åˆ«å­˜å‚¨åœ¨å„è‡ªçš„å·¥ä½œå†…å­˜</li><li>çº¿ç¨‹Aé€šè¿‡getIntVolatile(var1 , var2) æ‹¿åˆ°valueå€¼3ï¼Œè¿™æ—¶çº¿ç¨‹Aè¢«æŒ‚èµ·ï¼ˆè¯¥çº¿ç¨‹å¤±å»CPUæ‰§è¡Œæƒï¼‰</li><li>çº¿ç¨‹Bä¹Ÿé€šè¿‡getIntVolatile(var1, var2)æ–¹æ³•è·å–åˆ°valueå€¼ä¹Ÿæ˜¯3ï¼Œæ­¤æ—¶åˆšå¥½çº¿ç¨‹Bæ²¡æœ‰è¢«æŒ‚èµ·ï¼Œå¹¶æ‰§è¡Œäº†compareAndSwapIntæ–¹æ³•ï¼Œæ¯”è¾ƒå†…å­˜çš„å€¼ä¹Ÿæ˜¯3ï¼ŒæˆåŠŸä¿®æ”¹å†…å­˜å€¼ä¸º4ï¼Œçº¿ç¨‹Bæ‰“å®Œæ”¶å·¥ï¼Œä¸€åˆ‡OK</li><li>è¿™æ—¶çº¿ç¨‹Aæ¢å¤ï¼Œæ‰§è¡ŒCASæ–¹æ³•ï¼Œæ¯”è¾ƒå‘ç°è‡ªå·±æ‰‹é‡Œçš„æ•°å­—3å’Œä¸»å†…å­˜ä¸­çš„æ•°å­—4ä¸ä¸€è‡´ï¼Œè¯´æ˜è¯¥å€¼å·²ç»è¢«å…¶å®ƒçº¿ç¨‹æŠ¢å…ˆä¸€æ­¥ä¿®æ”¹è¿‡äº†ï¼Œé‚£ä¹ˆAçº¿ç¨‹æœ¬æ¬¡ä¿®æ”¹å¤±è´¥ï¼Œåªèƒ½å¤Ÿé‡æ–°è¯»å–ååœ¨æ¥ä¸€éäº†ï¼Œä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œdo while</li><li>çº¿ç¨‹Aé‡æ–°è·å–valueå€¼ï¼Œå› ä¸ºå˜é‡valueè¢«volatileä¿®é¥°ï¼Œæ‰€ä»¥å…¶å®ƒçº¿ç¨‹å¯¹å®ƒçš„ä¿®æ”¹ï¼Œçº¿ç¨‹Aæ€»èƒ½å¤Ÿçœ‹åˆ°ï¼Œçº¿ç¨‹Aç»§ç»­æ‰§è¡ŒcompareAndSwapIntè¿›è¡Œæ¯”è¾ƒæ›¿æ¢ï¼Œç›´åˆ°æˆåŠŸã€‚</li></ol><p>Unsafeç±» + CASæ€æƒ³ï¼š ä¹Ÿå°±æ˜¯è‡ªæ—‹ï¼Œè‡ªæˆ‘æ—‹è½¬</p><h2 id="4-åº•å±‚æ±‡ç¼–"><a href="#4-åº•å±‚æ±‡ç¼–" class="headerlink" title="4 åº•å±‚æ±‡ç¼–"></a>4 åº•å±‚æ±‡ç¼–</h2><p>Unsafeç±»ä¸­çš„compareAndSwapIntæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å®ç°ä½äºunsafe.cppä¸­</p><ul><li>å…ˆæƒ³åŠæ³•æ‹¿åˆ°å˜é‡valueåœ¨å†…å­˜ä¸­çš„åœ°å€</li><li>é€šè¿‡Atomic::cmpxchgå®ç°æ¯”è¾ƒæ›¿æ¢ï¼Œå…¶ä¸­å‚æ•°Xæ˜¯å³å°†æ›´æ–°çš„å€¼ï¼Œå‚æ•°eæ˜¯åŸå†…å­˜çš„å€¼</li></ul><h2 id="5-CASç¼ºç‚¹"><a href="#5-CASç¼ºç‚¹" class="headerlink" title="5 CASç¼ºç‚¹"></a>5 CASç¼ºç‚¹</h2><p>CASä¸åŠ é”ï¼Œä¿è¯ä¸€æ¬¡æ€§ï¼Œä½†æ˜¯éœ€è¦å¤šæ¬¡æ¯”è¾ƒ</p><ul><li>å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¤§ï¼ˆå› ä¸ºæ‰§è¡Œçš„æ˜¯do whileï¼Œå¦‚æœæ¯”è¾ƒä¸æˆåŠŸä¸€ç›´åœ¨å¾ªç¯ï¼Œæœ€å·®çš„æƒ…å†µï¼Œå°±æ˜¯æŸä¸ªçº¿ç¨‹ä¸€ç›´å–åˆ°çš„å€¼å’Œé¢„æœŸå€¼éƒ½ä¸ä¸€æ ·ï¼Œè¿™æ ·å°±ä¼šæ— é™å¾ªç¯ï¼‰</li><li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ<ul><li>å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œ</li><li>ä½†æ˜¯å¯¹äºå¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™åªèƒ½ç”¨é”æ¥ä¿è¯åŸå­æ€§</li></ul></li><li>å¼•å‡ºæ¥ABAé—®é¢˜ï¼Ÿ</li></ul><h2 id="6-ABAé—®é¢˜"><a href="#6-ABAé—®é¢˜" class="headerlink" title="6 ABAé—®é¢˜"></a>6 ABAé—®é¢˜</h2><h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7 æ€»ç»“"></a>7 æ€»ç»“</h2><h3 id="7-1-CAS"><a href="#7-1-CAS" class="headerlink" title="7.1 CAS"></a>7.1 CAS</h3><p>CASæ˜¯compareAndSwapï¼Œæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»ç‰©ç†å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ‰§è¡Œè§„å®šæ“ä½œï¼Œå¦è€…ç»§ç»­æ¯”è¾ƒç›´åˆ°ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„å€¼ä¸€è‡´ä¸ºæ­¢</p><h3 id="7-2-CASåº”ç”¨"><a href="#7-2-CASåº”ç”¨" class="headerlink" title="7.2 CASåº”ç”¨"></a>7.2 CASåº”ç”¨</h3><p>CASæœ‰3ä¸ªæ“ä½œæ•°ï¼Œå†…å­˜å€¼Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ›´æ–°å€¼Bã€‚å½“ä¸”ä»…å½“é¢„æœŸå€¼Aå’Œå†…å­˜å€¼Vç›¸åŒæ—¶ï¼Œå°†å†…å­˜å€¼Vä¿®æ”¹ä¸ºBï¼Œå¦è€…ä»€ä¹ˆéƒ½ä¸åš</p><h1 id="ç¬¬3ç« -åŸå­ç±»AtomicIntegerçš„ABAé—®é¢˜"><a href="#ç¬¬3ç« -åŸå­ç±»AtomicIntegerçš„ABAé—®é¢˜" class="headerlink" title="ç¬¬3ç«  åŸå­ç±»AtomicIntegerçš„ABAé—®é¢˜"></a>ç¬¬3ç«  åŸå­ç±»AtomicIntegerçš„ABAé—®é¢˜</h1><h2 id="1-è¿ç¯å¥—è·¯"><a href="#1-è¿ç¯å¥—è·¯" class="headerlink" title="1 è¿ç¯å¥—è·¯"></a>1 è¿ç¯å¥—è·¯</h2><p>ä»AtomicIntegerå¼•å‡ºä¸‹é¢çš„é—®é¢˜</p><p>CAS -&gt; Unsafe -&gt; CASåº•å±‚æ€æƒ³ -&gt; ABA -&gt; åŸå­å¼•ç”¨æ›´æ–° -&gt; å¦‚ä½•è§„é¿ABAé—®é¢˜</p><h2 id="2-ABAé—®é¢˜æ˜¯ä»€ä¹ˆ"><a href="#2-ABAé—®é¢˜æ˜¯ä»€ä¹ˆ" class="headerlink" title="2 ABAé—®é¢˜æ˜¯ä»€ä¹ˆ"></a>2 ABAé—®é¢˜æ˜¯ä»€ä¹ˆ</h2><p>ç‹¸çŒ«æ¢å¤ªå­</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200311212442057.png" alt="image-20200311212442057"></p><p>å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ˜¯T1 å’Œ T2ï¼Œç„¶åT1æ‰§è¡ŒæŸä¸ªæ“ä½œçš„æ—¶é—´ä¸º10ç§’ï¼ŒT2æ‰§è¡ŒæŸä¸ªæ—¶é—´çš„æ“ä½œæ˜¯2ç§’ï¼Œæœ€å¼€å§‹ABä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ä»ä¸»å†…å­˜ä¸­è·å–Aå€¼ï¼Œä½†æ˜¯å› ä¸ºBçš„æ‰§è¡Œé€Ÿåº¦æ›´å¿«ï¼Œä»–å…ˆæŠŠAçš„å€¼æ”¹æˆBï¼Œç„¶ååœ¨ä¿®æ”¹æˆAï¼Œç„¶åæ‰§è¡Œå®Œæ¯•ï¼ŒT1çº¿ç¨‹åœ¨10ç§’åï¼Œæ‰§è¡Œå®Œæ¯•ï¼Œåˆ¤æ–­å†…å­˜ä¸­çš„å€¼ä¸ºAï¼Œå¹¶ä¸”å’Œè‡ªå·±é¢„æœŸçš„å€¼ä¸€æ ·ï¼Œå®ƒå°±è®¤ä¸ºæ²¡æœ‰äººæ›´æ”¹äº†ä¸»å†…å­˜ä¸­çš„å€¼ï¼Œå°±å¿«ä¹çš„ä¿®æ”¹æˆBï¼Œä½†æ˜¯å®é™…ä¸Š å¯èƒ½ä¸­é—´ç»å†äº† ABCDEFA è¿™ä¸ªå˜æ¢ï¼Œä¹Ÿå°±æ˜¯ä¸­é—´çš„å€¼ç»å†äº†ç‹¸çŒ«æ¢å¤ªå­ã€‚</p><p>æ‰€ä»¥ABAé—®é¢˜å°±æ˜¯ï¼Œåœ¨è¿›è¡Œè·å–ä¸»å†…å­˜å€¼çš„æ—¶å€™ï¼Œè¯¥å†…å­˜å€¼åœ¨æˆ‘ä»¬å†™å…¥ä¸»å†…å­˜çš„æ—¶å€™ï¼Œå·²ç»è¢«ä¿®æ”¹äº†Næ¬¡ï¼Œä½†æ˜¯æœ€ç»ˆåˆæ”¹æˆåŸæ¥çš„å€¼äº†</p><h2 id="3-CASå¯¼è‡´ABAé—®é¢˜"><a href="#3-CASå¯¼è‡´ABAé—®é¢˜" class="headerlink" title="3 CASå¯¼è‡´ABAé—®é¢˜"></a>3 CASå¯¼è‡´ABAé—®é¢˜</h2><p>CASç®—æ³•å®ç°äº†ä¸€ä¸ªé‡è¦çš„å‰æï¼Œéœ€è¦å–å‡ºå†…å­˜ä¸­æŸæ—¶åˆ»çš„æ•°æ®ï¼Œå¹¶åœ¨å½“ä¸‹æ—¶åˆ»æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶é—´å·®ä¼šå¯¼è‡´æ•°æ®çš„å˜åŒ–ã€‚</p><p>æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹oneä»å†…å­˜ä½ç½®Vä¸­å–å‡ºAï¼Œè¿™æ—¶å€™å¦å¤–ä¸€ä¸ªçº¿ç¨‹twoä¹Ÿä»å†…å­˜ä¸­å–å‡ºAï¼Œå¹¶ä¸”çº¿ç¨‹twoè¿›è¡Œäº†ä¸€äº›æ“ä½œå°†å€¼å˜æˆäº†Bï¼Œç„¶åçº¿ç¨‹twoåˆå°†Vä½ç½®çš„æ•°æ®å˜æˆAï¼Œè¿™æ—¶å€™çº¿ç¨‹oneè¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯Aï¼Œç„¶åçº¿ç¨‹oneæ“ä½œæˆåŠŸ</p><p><code>å°½ç®¡çº¿ç¨‹oneçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ²¡æœ‰é—®é¢˜çš„</code></p><h2 id="4-ABAé—®é¢˜"><a href="#4-ABAé—®é¢˜" class="headerlink" title="4 ABAé—®é¢˜"></a>4 ABAé—®é¢˜</h2><p>CASåªç®¡å¼€å¤´å’Œç»“å°¾ï¼Œä¹Ÿå°±æ˜¯å¤´å’Œå°¾æ˜¯ä¸€æ ·ï¼Œé‚£å°±ä¿®æ”¹æˆåŠŸï¼Œä¸­é—´çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯èƒ½ä¼šè¢«äººä¿®æ”¹è¿‡</p><h2 id="5-åŸå­å¼•ç”¨"><a href="#5-åŸå­å¼•ç”¨" class="headerlink" title="5 åŸå­å¼•ç”¨"></a>5 åŸå­å¼•ç”¨</h2><p>åŸå­å¼•ç”¨å…¶å®å’ŒåŸå­åŒ…è£…ç±»æ˜¯å·®ä¸å¤šçš„æ¦‚å¿µï¼Œå°±æ˜¯å°†ä¸€ä¸ªjavaç±»ï¼Œç”¨åŸå­å¼•ç”¨ç±»è¿›è¡ŒåŒ…è£…èµ·æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±å…·å¤‡äº†åŸå­æ€§</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * åŸå­å¼•ç”¨</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;    String userName;    <span class="hljs-keyword">int</span> age;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String userName, <span class="hljs-keyword">int</span> age)</span> </span>&#123;        <span class="hljs-keyword">this</span>.userName = userName;        <span class="hljs-keyword">this</span>.age = age;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUserName</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> userName;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserName</span><span class="hljs-params">(String userName)</span> </span>&#123;        <span class="hljs-keyword">this</span>.userName = userName;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> age;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;        <span class="hljs-keyword">this</span>.age = age;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +                <span class="hljs-string">&quot;userName=&#x27;&quot;</span> + userName + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +                <span class="hljs-string">&quot;, age=&quot;</span> + age +                <span class="hljs-string">&#x27;&#125;&#x27;</span>;    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicReferenceDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        User z3 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;z3&quot;</span>, <span class="hljs-number">22</span>);        User l4 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;l4&quot;</span>, <span class="hljs-number">25</span>);        <span class="hljs-comment">// åˆ›å»ºåŸå­å¼•ç”¨åŒ…è£…ç±»</span>        AtomicReference&lt;User&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();        <span class="hljs-comment">// ç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å…±äº«å˜é‡ï¼Œä¸ºz3</span>        atomicReference.set(z3);        <span class="hljs-comment">// æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œå¦‚æœç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å€¼ä¸ºz3ï¼Œé‚£ä¹ˆäº¤æ¢æˆl4</span>        System.out.println(atomicReference.compareAndSet(z3, l4) + <span class="hljs-string">&quot;\t &quot;</span> + atomicReference.get().toString());        <span class="hljs-comment">// æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å€¼æ˜¯l4äº†ï¼Œä½†æ˜¯é¢„æœŸä¸ºz3ï¼Œå› æ­¤äº¤æ¢å¤±è´¥</span>        System.out.println(atomicReference.compareAndSet(z3, l4) + <span class="hljs-string">&quot;\t &quot;</span> + atomicReference.get().toString());    &#125;&#125;</code></pre></div><h3 id="5-1-åŸºäºåŸå­å¼•ç”¨çš„ABAé—®é¢˜"><a href="#5-1-åŸºäºåŸå­å¼•ç”¨çš„ABAé—®é¢˜" class="headerlink" title="5.1 åŸºäºåŸå­å¼•ç”¨çš„ABAé—®é¢˜"></a>5.1 åŸºäºåŸå­å¼•ç”¨çš„ABAé—®é¢˜</h3><p>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œç„¶åT1çº¿ç¨‹ï¼Œæ‰§è¡Œä¸€æ¬¡ABAçš„æ“ä½œï¼ŒT2çº¿ç¨‹åœ¨ä¸€ç§’åä¿®æ”¹ä¸»å†…å­˜çš„å€¼</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ABAé—®é¢˜çš„è§£å†³ï¼ŒAtomicStampedReference</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABADemo</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ™®é€šçš„åŸå­å¼•ç”¨åŒ…è£…ç±»</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">static</span> AtomicReference&lt;Integer&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-number">100</span>);    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-comment">// æŠŠ100 æ”¹æˆ 101 ç„¶ååœ¨æ”¹æˆ100ï¼Œä¹Ÿå°±æ˜¯ABA</span>            atomicReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">101</span>);            atomicReference.compareAndSet(<span class="hljs-number">101</span>, <span class="hljs-number">100</span>);        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">try</span> &#123;                <span class="hljs-comment">// ç¡çœ ä¸€ç§’ï¼Œä¿è¯t1çº¿ç¨‹ï¼Œå®Œæˆäº†ABAæ“ä½œ</span>                TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-comment">// æŠŠ100 æ”¹æˆ 101 ç„¶ååœ¨æ”¹æˆ100ï¼Œä¹Ÿå°±æ˜¯ABA</span>            System.out.println(atomicReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">2019</span>) + <span class="hljs-string">&quot;\t&quot;</span> + atomicReference.get());        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬å‘ç°ï¼Œå®ƒèƒ½å¤ŸæˆåŠŸçš„ä¿®æ”¹ï¼Œè¿™å°±æ˜¯ABAé—®é¢˜</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312154752973.png" alt="image-20200312154752973"></p><h2 id="6-è§£å†³ABAé—®é¢˜"><a href="#6-è§£å†³ABAé—®é¢˜" class="headerlink" title="6 è§£å†³ABAé—®é¢˜"></a>6 è§£å†³ABAé—®é¢˜</h2><p>æ–°å¢ä¸€ç§æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹ç‰ˆæœ¬å·ï¼Œç±»ä¼¼äºæ—¶é—´æˆ³çš„æ¦‚å¿µ</p><p>T1ï¼š  100 1                      2019 2</p><p>T2ï¼š  100 1     101 2       100  3</p><p>å¦‚æœT1ä¿®æ”¹çš„æ—¶å€™ï¼Œç‰ˆæœ¬å·ä¸º2ï¼Œè½åäºç°åœ¨çš„ç‰ˆæœ¬å·3ï¼Œæ‰€ä»¥è¦é‡æ–°è·å–æœ€æ–°å€¼ï¼Œè¿™é‡Œå°±æå‡ºäº†ä¸€ä¸ªä½¿ç”¨æ—¶é—´æˆ³ç‰ˆæœ¬å·ï¼Œæ¥è§£å†³ABAé—®é¢˜çš„æ€è·¯</p><h2 id="7-AtomicStampedReference"><a href="#7-AtomicStampedReference" class="headerlink" title="7 AtomicStampedReference"></a>7 AtomicStampedReference</h2><p>æ—¶é—´æˆ³åŸå­å¼•ç”¨ï¼Œæ¥è¿™é‡Œåº”ç”¨äºç‰ˆæœ¬å·çš„æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œéœ€è¦æ¯”è¾ƒæœŸæœ›å€¼å’Œå½“å‰å€¼ï¼Œä»¥åŠæœŸæœ›ç‰ˆæœ¬å·å’Œå½“å‰ç‰ˆæœ¬å·</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ABAé—®é¢˜çš„è§£å†³ï¼ŒAtomicStampedReference</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABADemo</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ™®é€šçš„åŸå­å¼•ç”¨åŒ…è£…ç±»</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">static</span> AtomicReference&lt;Integer&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-number">100</span>);    <span class="hljs-comment">// ä¼ é€’ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯åˆå§‹å€¼ï¼Œä¸€ä¸ªæ˜¯åˆå§‹ç‰ˆæœ¬å·</span>    <span class="hljs-keyword">static</span> AtomicStampedReference&lt;Integer&gt; atomicStampedReference = <span class="hljs-keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>);    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;============ä»¥ä¸‹æ˜¯ABAé—®é¢˜çš„äº§ç”Ÿ==========&quot;</span>);        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-comment">// æŠŠ100 æ”¹æˆ 101 ç„¶ååœ¨æ”¹æˆ100ï¼Œä¹Ÿå°±æ˜¯ABA</span>            atomicReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">101</span>);            atomicReference.compareAndSet(<span class="hljs-number">101</span>, <span class="hljs-number">100</span>);        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">try</span> &#123;                <span class="hljs-comment">// ç¡çœ ä¸€ç§’ï¼Œä¿è¯t1çº¿ç¨‹ï¼Œå®Œæˆäº†ABAæ“ä½œ</span>                TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-comment">// æŠŠ100 æ”¹æˆ 101 ç„¶ååœ¨æ”¹æˆ100ï¼Œä¹Ÿå°±æ˜¯ABA</span>            System.out.println(atomicReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">2019</span>) + <span class="hljs-string">&quot;\t&quot;</span> + atomicReference.get());        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();        System.out.println(<span class="hljs-string">&quot;============ä»¥ä¸‹æ˜¯ABAé—®é¢˜çš„è§£å†³==========&quot;</span>);        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-comment">// è·å–ç‰ˆæœ¬å·</span>            <span class="hljs-keyword">int</span> stamp = atomicStampedReference.getStamp();            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·&quot;</span> + stamp);            <span class="hljs-comment">// æš‚åœt3ä¸€ç§’é’Ÿ</span>            <span class="hljs-keyword">try</span> &#123;                TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-comment">// ä¼ å…¥4ä¸ªå€¼ï¼ŒæœŸæœ›å€¼ï¼Œæ›´æ–°å€¼ï¼ŒæœŸæœ›ç‰ˆæœ¬å·ï¼Œæ›´æ–°ç‰ˆæœ¬å·</span>            atomicStampedReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">101</span>, atomicStampedReference.getStamp(), atomicStampedReference.getStamp()+<span class="hljs-number">1</span>);            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç¬¬äºŒæ¬¡ç‰ˆæœ¬å·&quot;</span> + atomicStampedReference.getStamp());            atomicStampedReference.compareAndSet(<span class="hljs-number">101</span>, <span class="hljs-number">100</span>, atomicStampedReference.getStamp(), atomicStampedReference.getStamp()+<span class="hljs-number">1</span>);            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç¬¬ä¸‰æ¬¡ç‰ˆæœ¬å·&quot;</span> + atomicStampedReference.getStamp());        &#125;, <span class="hljs-string">&quot;t3&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-comment">// è·å–ç‰ˆæœ¬å·</span>            <span class="hljs-keyword">int</span> stamp = atomicStampedReference.getStamp();            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·&quot;</span> + stamp);            <span class="hljs-comment">// æš‚åœt4 3ç§’é’Ÿï¼Œä¿è¯t3çº¿ç¨‹ä¹Ÿè¿›è¡Œä¸€æ¬¡ABAé—®é¢˜</span>            <span class="hljs-keyword">try</span> &#123;                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-keyword">boolean</span> result = atomicStampedReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">2019</span>, stamp, stamp+<span class="hljs-number">1</span>);            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ä¿®æ”¹æˆåŠŸå¦ï¼š&quot;</span> + result + <span class="hljs-string">&quot;\t å½“å‰æœ€æ–°å®é™…ç‰ˆæœ¬å·ï¼š&quot;</span> + atomicStampedReference.getStamp());            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t å½“å‰å®é™…æœ€æ–°å€¼&quot;</span> + atomicStampedReference.getReference());        &#125;, <span class="hljs-string">&quot;t4&quot;</span>).start();    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœä¸ºï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312200434776.png" alt="image-20200312200434776"></p><p>æˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼Œçº¿ç¨‹t3ï¼Œåœ¨è¿›è¡ŒABAæ“ä½œåï¼Œç‰ˆæœ¬å·å˜æ›´æˆäº†3ï¼Œè€Œçº¿ç¨‹t4åœ¨è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œå°±å‡ºç°æ“ä½œå¤±è´¥äº†ï¼Œå› ä¸ºç‰ˆæœ¬å·å’Œå½“åˆæ‹¿åˆ°çš„ä¸ä¸€æ ·</p><h2 id="8-LongAdderï¼ˆCASæœºåˆ¶ä¼˜åŒ–ï¼‰"><a href="#8-LongAdderï¼ˆCASæœºåˆ¶ä¼˜åŒ–ï¼‰" class="headerlink" title="8 LongAdderï¼ˆCASæœºåˆ¶ä¼˜åŒ–ï¼‰"></a>8 LongAdderï¼ˆCASæœºåˆ¶ä¼˜åŒ–ï¼‰</h2><p>LongAdderæ˜¯java8ä¸ºæˆ‘ä»¬æä¾›çš„æ–°çš„ç±»ï¼Œè·ŸAtomicLongæœ‰ç›¸åŒçš„æ•ˆæœã€‚æ˜¯å¯¹CASæœºåˆ¶çš„ä¼˜åŒ–</p><div class="code-wrapper"><pre><code class="hljs axapta">LongAdderï¼š<span class="hljs-comment">//å˜é‡å£°æ˜</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LongAdder <span class="hljs-keyword">count</span> = <span class="hljs-keyword">new</span> LongAdder();<span class="hljs-comment">//å˜é‡æ“ä½œ</span><span class="hljs-keyword">count</span>.increment();<span class="hljs-comment">//å˜é‡å–å€¼</span><span class="hljs-keyword">count</span></code></pre></div><h3 id="ä¸ºä»€ä¹ˆæœ‰äº†AtomicLongè¿˜è¦æ–°å¢ä¸€ä¸ªLongAdderå‘¢"><a href="#ä¸ºä»€ä¹ˆæœ‰äº†AtomicLongè¿˜è¦æ–°å¢ä¸€ä¸ªLongAdderå‘¢" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰äº†AtomicLongè¿˜è¦æ–°å¢ä¸€ä¸ªLongAdderå‘¢"></a>ä¸ºä»€ä¹ˆæœ‰äº†AtomicLongè¿˜è¦æ–°å¢ä¸€ä¸ªLongAdderå‘¢</h3><p>åŸå› æ˜¯ï¼šCASåº•å±‚å®ç°æ˜¯åœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­åœ°å°è¯•ä¿®æ”¹ç›®æ ‡å€¼ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚å¦‚æœç«äº‰ä¸æ¿€çƒˆçš„æ—¶å€™ï¼Œä¿®æ”¹æˆåŠŸç‡å¾ˆé«˜ï¼Œå¦åˆ™å¤±è´¥ç‡å¾ˆé«˜ã€‚åœ¨å¤±è´¥çš„æ—¶å€™ï¼Œè¿™äº›é‡å¤çš„åŸå­æ€§æ“ä½œä¼šè€—è´¹æ€§èƒ½ã€‚ï¼ˆä¸åœçš„<strong>è‡ªæ—‹</strong>ï¼Œè¿›å…¥ä¸€ä¸ªæ— é™é‡å¤çš„å¾ªç¯ä¸­ï¼‰</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200429085540554.png" alt="image-20200429085540554"></p><p><strong>æ ¸å¿ƒæ€æƒ³ï¼šå°†çƒ­ç‚¹æ•°æ®åˆ†ç¦»ã€‚</strong></p><p>æ¯”å¦‚è¯´å®ƒå¯ä»¥å°†AtomicLongå†…éƒ¨çš„å†…éƒ¨æ ¸å¿ƒæ•°æ®valueåˆ†ç¦»æˆä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®æ—¶ï¼Œé€šè¿‡hashç­‰ç®—æ³•æ˜ å°„åˆ°å…¶ä¸­ä¸€ä¸ªæ•°å­—è¿›è¡Œè®¡æ•°ï¼Œè€Œæœ€ç»ˆçš„è®¡æ•°ç»“æœåˆ™ä¸ºè¿™ä¸ªæ•°ç»„çš„æ±‚å’Œç´¯åŠ ï¼Œå…¶ä¸­çƒ­ç‚¹æ•°æ®valueä¼šè¢«åˆ†ç¦»æˆå¤šä¸ªå•å…ƒçš„cellï¼Œæ¯ä¸ªcellç‹¬è‡ªç»´æŠ¤å†…éƒ¨çš„å€¼ã€‚å½“å‰å¯¹è±¡çš„å®é™…å€¼ç”±æ‰€æœ‰çš„cellç´¯è®¡åˆæˆï¼Œè¿™æ ·çƒ­ç‚¹å°±è¿›è¡Œäº†æœ‰æ•ˆåœ°åˆ†ç¦»ï¼Œå¹¶æé«˜äº†å¹¶è¡Œåº¦ã€‚è¿™ç›¸å½“äºå°†AtomicLongçš„å•ç‚¹çš„æ›´æ–°å‹åŠ›åˆ†æ‹…åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šã€‚åœ¨ä½å¹¶å‘çš„æ—¶å€™é€šè¿‡å¯¹baseçš„ç›´æ¥æ›´æ–°ï¼Œå¯ä»¥ä¿éšœå’ŒAtomicLongçš„æ€§èƒ½åŸºæœ¬ä¸€è‡´ã€‚è€Œåœ¨é«˜å¹¶å‘çš„æ—¶å€™é€šè¿‡åˆ†æ•£æé«˜äº†æ€§èƒ½ã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>&#123;    add(<span class="hljs-number">1L</span>);&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">long</span> x)</span> </span>&#123;    Cell[] as; <span class="hljs-keyword">long</span> b, v; <span class="hljs-keyword">int</span> m; Cell a;    <span class="hljs-keyword">if</span> ((as = cells) != <span class="hljs-keyword">null</span> || !casBase(b = base, b + x)) &#123;        <span class="hljs-keyword">boolean</span> uncontended = <span class="hljs-keyword">true</span>;        <span class="hljs-keyword">if</span> (as == <span class="hljs-keyword">null</span> || (m = as.length - <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||            (a = as[getProbe() &amp; m]) == <span class="hljs-keyword">null</span> ||            !(uncontended = a.cas(v = a.value, v + x)))            longAccumulate(x, <span class="hljs-keyword">null</span>, uncontended);    &#125;&#125;</code></pre></div><p>ä½†æ˜¯è¿™ä¸ªCASæœ‰æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿè‚¯å®šæ˜¯æœ‰çš„ã€‚æ¯”å¦‚è¯´å¤§é‡çš„çº¿ç¨‹åŒæ—¶å¹¶å‘ä¿®æ”¹ä¸€ä¸ªAtomicIntegerï¼Œå¯èƒ½æœ‰<strong>å¾ˆå¤šçº¿ç¨‹ä¼šä¸åœçš„è‡ªæ—‹</strong>ï¼Œè¿›å…¥ä¸€ä¸ªæ— é™é‡å¤çš„å¾ªç¯ä¸­ã€‚</p><p>è¿™äº›çº¿ç¨‹ä¸åœåœ°è·å–å€¼ï¼Œç„¶åå‘èµ·CASæ“ä½œï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªå€¼è¢«åˆ«äººæ”¹è¿‡äº†ï¼Œäºæ˜¯å†æ¬¡è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œè·å–å€¼ï¼Œå‘èµ·CASæ“ä½œåˆå¤±è´¥äº†ï¼Œå†æ¬¡è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚</p><p>åœ¨å¤§é‡çº¿ç¨‹é«˜å¹¶å‘æ›´æ–°AtomicIntegerçš„æ—¶å€™ï¼Œè¿™ç§é—®é¢˜å¯èƒ½ä¼šæ¯”è¾ƒæ˜æ˜¾ï¼Œå¯¼è‡´å¤§é‡çº¿ç¨‹ç©ºå¾ªç¯ï¼Œè‡ªæ—‹è½¬ï¼Œæ€§èƒ½å’Œæ•ˆç‡éƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ã€‚</p><p>äºæ˜¯ï¼Œå½“å½“å½“å½“ï¼ŒJava 8æ¨å‡ºäº†ä¸€ä¸ªæ–°çš„ç±»ï¼Œ<strong>LongAdder</strong>ï¼Œä»–å°±æ˜¯å°è¯•ä½¿ç”¨åˆ†æ®µCASä»¥åŠè‡ªåŠ¨åˆ†æ®µè¿ç§»çš„æ–¹å¼æ¥å¤§å¹…åº¦æå‡å¤šçº¿ç¨‹é«˜å¹¶å‘æ‰§è¡ŒCASæ“ä½œçš„æ€§èƒ½ï¼</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200429085141487.png" alt="image-20200429085141487"></p><p>åœ¨LongAdderçš„åº•å±‚å®ç°ä¸­ï¼Œé¦–å…ˆæœ‰ä¸€ä¸ªbaseå€¼ï¼Œåˆšå¼€å§‹å¤šçº¿ç¨‹æ¥ä¸åœçš„ç´¯åŠ æ•°å€¼ï¼Œéƒ½æ˜¯å¯¹baseè¿›è¡Œç´¯åŠ çš„ï¼Œæ¯”å¦‚åˆšå¼€å§‹ç´¯åŠ æˆäº†base = 5ã€‚</p><p>æ¥ç€å¦‚æœå‘ç°å¹¶å‘æ›´æ–°çš„çº¿ç¨‹æ•°é‡è¿‡å¤šï¼Œåœ¨å‘ç”Ÿç«äº‰çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰ä¸€ä¸ªCellæ•°ç»„ç”¨äºå°†ä¸åŒçº¿ç¨‹çš„æ“ä½œç¦»æ•£åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šå» ==(ä¼šæ ¹æ®éœ€è¦æ‰©å®¹ï¼Œæœ€å¤§ä¸ºCPUæ ¸ï¼‰==å°±ä¼šå¼€å§‹æ–½è¡Œ<strong>åˆ†æ®µCASçš„æœºåˆ¶</strong>ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ä¼šæä¸€ä¸ªCellæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„æ˜¯ä¸€ä¸ªæ•°å€¼åˆ†æ®µã€‚</p><p>è¿™æ—¶ï¼Œè®©å¤§é‡çš„çº¿ç¨‹åˆ†åˆ«å»å¯¹ä¸åŒCellå†…éƒ¨çš„valueå€¼è¿›è¡ŒCASç´¯åŠ æ“ä½œï¼Œè¿™æ ·å°±æŠŠCASè®¡ç®—å‹åŠ›åˆ†æ•£åˆ°äº†ä¸åŒçš„Cellåˆ†æ®µæ•°å€¼ä¸­äº†ï¼</p><p>è¿™æ ·å°±å¯ä»¥å¤§å¹…åº¦çš„é™ä½å¤šçº¿ç¨‹å¹¶å‘æ›´æ–°åŒä¸€ä¸ªæ•°å€¼æ—¶å‡ºç°çš„æ— é™å¾ªç¯çš„é—®é¢˜ï¼Œå¤§å¹…åº¦æå‡äº†å¤šçº¿ç¨‹å¹¶å‘æ›´æ–°æ•°å€¼çš„æ€§èƒ½å’Œæ•ˆç‡ï¼</p><p>è€Œä¸”ä»–å†…éƒ¨å®ç°äº†<strong>è‡ªåŠ¨åˆ†æ®µè¿ç§»çš„æœºåˆ¶</strong>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæŸä¸ªCellçš„valueæ‰§è¡ŒCASå¤±è´¥äº†ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨å»æ‰¾å¦å¤–ä¸€ä¸ªCellåˆ†æ®µå†…çš„valueå€¼è¿›è¡ŒCASæ“ä½œã€‚</p><p>è¿™æ ·ä¹Ÿè§£å†³äº†çº¿ç¨‹ç©ºæ—‹è½¬ã€è‡ªæ—‹ä¸åœç­‰å¾…æ‰§è¡ŒCASæ“ä½œçš„é—®é¢˜ï¼Œè®©ä¸€ä¸ªçº¿ç¨‹è¿‡æ¥æ‰§è¡ŒCASæ—¶å¯ä»¥å°½å¿«çš„å®Œæˆè¿™ä¸ªæ“ä½œã€‚</p><p>æœ€åï¼Œå¦‚æœä½ è¦ä»LongAdderä¸­è·å–å½“å‰ç´¯åŠ çš„æ€»å€¼ï¼Œå°±ä¼šæŠŠbaseå€¼å’Œæ‰€æœ‰Cellåˆ†æ®µæ•°å€¼åŠ èµ·æ¥è¿”å›ç»™ä½ ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200429085957778.png" alt="image-20200429085957778"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒLongAdderåˆ™æ˜¯å†…éƒ¨ç»´æŠ¤å¤šä¸ªCellå˜é‡ï¼Œæ¯ä¸ªCellé‡Œé¢æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„longå‹å˜é‡ï¼Œåœ¨åŒç­‰å¹¶å‘é‡çš„æƒ…å†µä¸‹ï¼Œäº‰å¤ºå•ä¸ªå˜é‡çš„çº¿ç¨‹ä¼šå‡å°‘ï¼Œè¿™æ˜¯å˜ç›¸çš„å‡å°‘äº†äº‰å¤ºå…±äº«èµ„æºçš„å¹¶å‘é‡ï¼Œå¦å¤–å¤šä¸ªçº¿ç¨‹åœ¨äº‰å¤ºåŒä¸€ä¸ªåŸå­å˜é‡æ—¶å€™ï¼Œ</p><p>å¦‚æœå¤±è´¥å¹¶ä¸æ˜¯è‡ªæ—‹CASé‡è¯•ï¼Œè€Œæ˜¯å°è¯•è·å–å…¶ä»–åŸå­å˜é‡çš„é”ï¼Œæœ€åå½“è·å–å½“å‰å€¼æ—¶å€™æ˜¯æŠŠæ‰€æœ‰å˜é‡çš„å€¼ç´¯åŠ åå†åŠ ä¸Šbaseçš„å€¼è¿”å›çš„ã€‚</p><p>LongAdderç»´æŠ¤äº†è¦ç»™å»¶è¿Ÿåˆå§‹åŒ–çš„åŸå­æ€§æ›´æ–°æ•°ç»„å’Œä¸€ä¸ªåŸºå€¼å˜é‡baseæ•°ç»„çš„å¤§å°ä¿æŒæ˜¯2çš„Næ¬¡æ–¹å¤§å°ï¼Œæ•°ç»„è¡¨çš„ä¸‹æ ‡ä½¿ç”¨æ¯ä¸ªçº¿ç¨‹çš„hashcodeå€¼çš„æ©ç è¡¨ç¤ºï¼Œæ•°ç»„é‡Œé¢çš„å˜é‡å®ä½“æ˜¯Cellç±»å‹ã€‚</p><p>Cell ç±»å‹æ˜¯Atomicçš„ä¸€ä¸ªæ”¹è¿›ï¼Œç”¨æ¥å‡å°‘ç¼“å­˜çš„äº‰ç”¨ï¼Œå¯¹äºå¤§å¤šæ•°åŸå­æ“ä½œå­—èŠ‚å¡«å……æ˜¯æµªè´¹çš„ï¼Œå› ä¸ºåŸå­æ“ä½œéƒ½æ˜¯æ— è§„å¾‹çš„åˆ†æ•£åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ï¼Œå¤šä¸ªåŸå­æ€§æ“ä½œå½¼æ­¤ä¹‹é—´æ˜¯æ²¡æœ‰æ¥è§¦çš„ï¼Œä½†æ˜¯åŸå­æ€§æ•°ç»„å…ƒç´ å½¼æ­¤ç›¸é‚»å­˜æ”¾å°†èƒ½ç»å¸¸å…±äº«ç¼“å­˜è¡Œï¼Œä¹Ÿå°±æ˜¯<strong>ä¼ªå…±äº«</strong>ã€‚æ‰€ä»¥è¿™åœ¨æ€§èƒ½ä¸Šæ˜¯ä¸€ä¸ªæå‡ã€‚ï¼ˆè¡¥å……ï¼šå¯ä»¥çœ‹åˆ°Cellç±»ç”¨Contendedæ³¨è§£ä¿®é¥°ï¼Œè¿™é‡Œä¸»è¦æ˜¯è§£å†³false sharing(ä¼ªå…±äº«çš„é—®é¢˜)ï¼Œä¸è¿‡ä¸ªäººè®¤ä¸ºä¼ªå…±äº«ç¿»è¯‘çš„ä¸æ˜¯å¾ˆå¥½ï¼Œæˆ–è€…åº”è¯¥æ˜¯é”™è¯¯çš„å…±äº«ï¼Œæ¯”å¦‚ä¸¤ä¸ªvolatileå˜é‡è¢«åˆ†é…åˆ°äº†åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªçš„æ›´æ–°åœ¨é«˜å¹¶å‘ä¸‹ä¼šç«äº‰ï¼Œæ¯”å¦‚çº¿ç¨‹Aå»æ›´æ–°å˜é‡aï¼Œçº¿ç¨‹Bå»æ›´æ–°å˜é‡bï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå˜é‡è¢«åˆ†é…åˆ°äº†åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå› æ­¤ä¼šé€ æˆæ¯ä¸ªçº¿ç¨‹éƒ½å»äº‰æŠ¢ç¼“å­˜è¡Œçš„æ‰€æœ‰æƒï¼Œä¾‹å¦‚Aè·å–äº†æ‰€æœ‰æƒç„¶åæ‰§è¡Œæ›´æ–°è¿™æ—¶ç”±äºvolatileçš„è¯­ä¹‰ä¼šé€ æˆå…¶åˆ·æ–°åˆ°ä¸»å­˜ï¼Œä½†æ˜¯ç”±äºå˜é‡bä¹Ÿè¢«ç¼“å­˜åˆ°åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå› æ­¤å°±ä¼šé€ æˆcache missï¼Œè¿™æ ·å°±ä¼šé€ æˆæå¤§çš„æ€§èƒ½æŸå¤±ï¼‰<br><strong>LongAdderçš„addæ“ä½œå›¾</strong></p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200429090249633.png" alt="image-20200429090249633"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ä»æœªå‡ºç°è¿‡å¹¶å‘å†²çªçš„æ—¶å€™ï¼ŒbaseåŸºæ•°æ‰ä¼šä½¿ç”¨åˆ°ï¼Œä¸€æ—¦å‡ºç°äº†å¹¶å‘å†²çªï¼Œä¹‹åæ‰€æœ‰çš„æ“ä½œéƒ½åªé’ˆå¯¹Cell[]æ•°ç»„ä¸­çš„å•å…ƒCellã€‚<br>å¦‚æœCell[]æ•°ç»„æœªåˆå§‹åŒ–ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„longAccumelateå»åˆå§‹åŒ–Cell[]ï¼Œå¦‚æœCell[]å·²ç»åˆå§‹åŒ–ä½†æ˜¯å†²çªå‘ç”Ÿåœ¨Cellå•å…ƒå†…ï¼Œåˆ™ä¹Ÿè°ƒç”¨çˆ¶ç±»çš„longAccumelateï¼Œæ­¤æ—¶å¯èƒ½å°±éœ€è¦å¯¹Cell[]æ‰©å®¹äº†ã€‚<br><strong>å¦å¤–ç”±äºCellså ç”¨å†…å­˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤§çš„ï¼Œæ‰€ä»¥ä¸€å¼€å§‹å¹¶ä¸åˆ›å»ºï¼Œè€Œæ˜¯åœ¨éœ€è¦æ—¶å€™å†åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§åŠ è½½ï¼Œå½“ä¸€å¼€å§‹æ²¡æœ‰ç©ºé—´æ—¶å€™ï¼Œæ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯æ“ä½œbaseå˜é‡ã€‚</strong></p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200429090556928.png" alt="image-20200429090556928"></p><p>å¦‚ä¸Šå›¾ä»£ç ï¼š<br>ä¾‹å¦‚32ã€64ä½æ“ä½œç³»ç»Ÿçš„ç¼“å­˜è¡Œå¤§å°ä¸ä¸€æ ·ï¼Œå› æ­¤JAVA8ä¸­å°±å¢åŠ äº†ä¸€ä¸ªæ³¨<code>@sun.misc.Contended</code>è§£ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜,ç”±JVMå»æ’å…¥è¿™äº›å˜é‡ï¼Œ<a href="http://xn--openjdk-hc5k25at0ntqhnpa7548b.java.net/jeps/142">å…·ä½“å¯ä»¥å‚è€ƒopenjdk.java.net/jeps/142</a> ï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´å¯¹è±¡æ˜¯ä¸è§„åˆ™çš„åˆ†é…åˆ°å†…å­˜ä¸­çš„ï¼Œä½†æ˜¯æ•°ç»„ç”±äºæ˜¯è¿ç»­çš„å†…å­˜ï¼Œå› æ­¤å¯èƒ½ä¼šå…±äº«ç¼“å­˜è¡Œï¼Œå› æ­¤è¿™é‡ŒåŠ ä¸€ä¸ªContendedæ³¨è§£ä»¥é˜²cellsæ•°ç»„å‘ç”Ÿä¼ªå…±äº«çš„æƒ…å†µã€‚</p><p>ä¸ºäº†é™ä½é«˜å¹¶å‘ä¸‹å¤šçº¿ç¨‹å¯¹ä¸€ä¸ªå˜é‡CASäº‰å¤ºå¤±è´¥åå¤§é‡çº¿ç¨‹ä¼šè‡ªæ—‹è€Œé€ æˆé™ä½å¹¶å‘æ€§èƒ½é—®é¢˜ï¼ŒLongAdderå†…éƒ¨é€šè¿‡æ ¹æ®å¹¶å‘è¯·æ±‚é‡æ¥ç»´æŠ¤å¤šä¸ªCellå…ƒç´ (ä¸€ä¸ªåŠ¨æ€çš„Cellæ•°ç»„)æ¥åˆ†æ‹…å¯¹å•ä¸ªå˜é‡è¿›è¡Œäº‰å¤ºèµ„æºã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200429090713078.png" alt="image-20200429090713078"></p><p>å¯ä»¥çœ‹åˆ°LongAdderç»§æ‰¿è‡ªStriped64ç±»ï¼ŒStriped64å†…éƒ¨ç»´æŠ¤ç€ä¸‰ä¸ªå˜é‡ï¼ŒLongAdderçš„çœŸå®å€¼å…¶å®å°±æ˜¯baseçš„å€¼ä¸Cellæ•°ç»„é‡Œé¢æ‰€æœ‰Cellå…ƒç´ å€¼çš„ç´¯åŠ ï¼Œbaseæ˜¯ä¸ªåŸºç¡€å€¼ï¼Œé»˜è®¤æ˜¯0ï¼ŒcellBusyç”¨æ¥å®ç°è‡ªæ—‹é”ï¼Œå½“åˆ›å»ºCellå…ƒç´ æˆ–è€…æ‰©å®¹Cellæ•°ç»„æ—¶å€™ç”¨æ¥è¿›è¡Œçº¿ç¨‹é—´çš„åŒæ­¥ã€‚</p><p>åœ¨æ— ç«äº‰ä¸‹ç›´æ¥æ›´æ–°baseï¼Œç±»ä¼¼AtomicLongé«˜å¹¶å‘ä¸‹ï¼Œä¼šå°†æ¯ä¸ªçº¿ç¨‹çš„æ“ä½œhashåˆ°ä¸åŒçš„cellsæ•°ç»„ä¸­ï¼Œä»è€Œå°†AtomicLongä¸­æ›´æ–°ä¸€ä¸ªvalueçš„è¡Œä¸ºä¼˜åŒ–ä¹‹åï¼Œåˆ†æ•£åˆ°å¤šä¸ªvalueä¸­<br>ä»è€Œé™ä½æ›´æ–°çƒ­ç‚¹ï¼Œè€Œéœ€è¦å¾—åˆ°å½“å‰å€¼çš„æ—¶å€™ï¼Œç›´æ¥ å°†æ‰€æœ‰cellä¸­çš„valueä¸baseç›¸åŠ å³å¯ï¼Œä½†æ˜¯è·ŸAtomicLong(compare and change -&gt; xadd)çš„CASä¸åŒï¼ŒincrementAndGetæ“ä½œåŠå…¶å˜ç§å¯ä»¥è¿”å›æ›´æ–°åçš„å€¼ï¼Œè€ŒLongAdderè¿”å›çš„æ˜¯voidã€‚</p><p>ç”±äºCellç›¸å¯¹æ¥è¯´æ¯”è¾ƒå å†…å­˜ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨æ‡’åŠ è½½çš„æ–¹å¼ï¼Œåœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹ç›´æ¥æ›´æ–°baseåŸŸï¼Œåœ¨ç¬¬ä¸€æ¬¡å‘ç”Ÿç«äº‰çš„æ—¶å€™(CASå¤±è´¥)å°±ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º2çš„cellsæ•°ç»„ï¼Œæ¯æ¬¡æ‰©å®¹éƒ½æ˜¯åŠ å€ï¼Œåªåˆ°è¾¾åˆ°CPUæ ¸æ•°ã€‚åŒæ—¶æˆ‘ä»¬çŸ¥é“æ‰©å®¹æ•°ç»„ç­‰è¡Œä¸ºéœ€è¦åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªé”ï¼Œè¿™é‡Œé€šè¿‡CASæ›´æ–°cellsBusyæ¥å®ç°ä¸€ä¸ªç®€å•çš„spin lockã€‚</p><p>æ•°ç»„è®¿é—®ç´¢å¼•æ˜¯é€šè¿‡Threadé‡Œçš„threadLocalRandomProbeåŸŸå–æ¨¡å®ç°çš„ï¼Œè¿™ä¸ªåŸŸæ˜¯ThreadLocalRandomæ›´æ–°çš„ï¼Œcellsçš„æ•°ç»„å¤§å°è¢«é™åˆ¶ä¸ºCPUçš„æ ¸æ•°ï¼Œå› ä¸ºå³ä½¿æœ‰è¶…è¿‡æ ¸æ•°ä¸ªçº¿ç¨‹å»æ›´æ–°ï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹ä¹Ÿåªä¼šå’Œä¸€ä¸ªCPUç»‘å®šï¼Œæ›´æ–°çš„æ—¶å€™é¡¶å¤šä¼šæœ‰cpuæ ¸æ•°ä¸ªçº¿ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦é€šè¿‡hashå°†ä¸åŒçº¿ç¨‹çš„æ›´æ–°è¡Œä¸ºç¦»æ•£åˆ°ä¸åŒçš„slotå³å¯ã€‚<br>æˆ‘ä»¬çŸ¥é“çº¿ç¨‹ã€çº¿ç¨‹æ± ä¼šè¢«å…³é—­æˆ–é”€æ¯ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½è¿™ä¸ªçº¿ç¨‹ä¹‹å‰å ç”¨çš„slotå°±ä¼šå˜æˆæ²¡äººç”¨çš„ï¼Œä½†æˆ‘ä»¬ä¹Ÿä¸èƒ½æ¸…é™¤æ‰ï¼Œå› ä¸ºä¸€èˆ¬webåº”ç”¨éƒ½æ˜¯é•¿æ—¶é—´è¿è¡Œçš„ï¼Œçº¿ç¨‹é€šå¸¸ä¹Ÿä¼šåŠ¨æ€åˆ›å»ºã€é”€æ¯ï¼Œå¾ˆå¯èƒ½ä¸€æ®µæ—¶é—´ååˆä¼šè¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œè€Œå¯¹äºçŸ­æ—¶é—´è¿è¡Œçš„ï¼Œä¾‹å¦‚å•å…ƒæµ‹è¯•ï¼Œæ¸…é™¤æ‰æœ‰å•¥æ„ä¹‰å‘¢ï¼Ÿ</p><h1 id="ç¬¬4ç« -Collectionçº¿ç¨‹ä¸å®‰å…¨çš„ä¸¾ä¾‹"><a href="#ç¬¬4ç« -Collectionçº¿ç¨‹ä¸å®‰å…¨çš„ä¸¾ä¾‹" class="headerlink" title="ç¬¬4ç«  Collectionçº¿ç¨‹ä¸å®‰å…¨çš„ä¸¾ä¾‹"></a>ç¬¬4ç«  Collectionçº¿ç¨‹ä¸å®‰å…¨çš„ä¸¾ä¾‹</h1><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1 å‰è¨€"></a>1 å‰è¨€</h2><p>1ã€å½“æˆ‘ä»¬æ‰§è¡Œä¸‹é¢è¯­å¥çš„æ—¶å€™ï¼Œåº•å±‚è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;();</code></pre></div><p>åº•å±‚åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œä¼´éšç€åˆå§‹å€¼ä¸º10</p><p>å½“æ‰§è¡Œaddæ–¹æ³•åï¼Œå¦‚æœè¶…è¿‡äº†10ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹çš„å¤§å°ä¸ºåŸå€¼çš„ä¸€åŠï¼Œä¹Ÿå°±æ˜¯5ä¸ªï¼Œä½¿ç”¨ä¸‹åˆ—æ–¹æ³•æ‰©å®¹</p><div class="code-wrapper"><pre><code class="hljs java">Arrays.copyOf(elementData, netCapacity)</code></pre></div><h2 id="2-å•çº¿ç¨‹ç¯å¢ƒä¸‹"><a href="#2-å•çº¿ç¨‹ç¯å¢ƒä¸‹" class="headerlink" title="2 å•çº¿ç¨‹ç¯å¢ƒä¸‹"></a>2 å•çº¿ç¨‹ç¯å¢ƒä¸‹</h2><p>å•çº¿ç¨‹ç¯å¢ƒçš„ArrayListæ˜¯ä¸ä¼šæœ‰é—®é¢˜çš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArrayListNotSafeDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        list.add(<span class="hljs-string">&quot;a&quot;</span>);        list.add(<span class="hljs-string">&quot;b&quot;</span>);        list.add(<span class="hljs-string">&quot;c&quot;</span>);        <span class="hljs-keyword">for</span>(String element : list) &#123;            System.out.println(element);        &#125;    &#125;&#125;</code></pre></div><h2 id="3-å¤šçº¿ç¨‹ç¯å¢ƒ"><a href="#3-å¤šçº¿ç¨‹ç¯å¢ƒ" class="headerlink" title="3 å¤šçº¿ç¨‹ç¯å¢ƒ"></a>3 å¤šçº¿ç¨‹ç¯å¢ƒ</h2><p>ä¸ºä»€ä¹ˆArrayListæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Ÿå› ä¸ºåœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œæ–¹æ³•ä¸Šä¸ºäº†ä¿è¯å¹¶å‘æ€§ï¼Œæ˜¯æ²¡æœ‰æ·»åŠ synchronizedä¿®é¥°ï¼Œæ‰€ä»¥å¹¶å‘å†™çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312202720715.png" alt="image-20200312202720715"></p><p>å½“æˆ‘ä»¬åŒæ—¶å¯åŠ¨30ä¸ªçº¿ç¨‹å»æ“ä½œListçš„æ—¶å€™</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * é›†åˆç±»çº¿ç¨‹ä¸å®‰å…¨ä¸¾ä¾‹</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArrayListNotSafeDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                list.add(UUID.randomUUID().toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>));                System.out.println(list);            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><p>è¿™ä¸ªæ—¶å€™å‡ºç°äº†é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯java.util.ConcurrentModificationException</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312205142763.png" alt="image-20200312205142763"></p><p>è¿™ä¸ªå¼‚å¸¸æ˜¯ å¹¶å‘ä¿®æ”¹çš„å¼‚å¸¸</p><h2 id="5-è§£å†³æ–¹æ¡ˆ"><a href="#5-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="5 è§£å†³æ–¹æ¡ˆ"></a>5 è§£å†³æ–¹æ¡ˆ</h2><h3 id="5-1-æ–¹æ¡ˆä¸€ï¼šVector"><a href="#5-1-æ–¹æ¡ˆä¸€ï¼šVector" class="headerlink" title="5.1 æ–¹æ¡ˆä¸€ï¼šVector"></a>5.1 æ–¹æ¡ˆä¸€ï¼šVector</h3><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯ä¸ç”¨ArrayListè¿™ç§ä¸å®‰å…¨çš„Listå®ç°ç±»ï¼Œè€Œé‡‡ç”¨Vectorï¼Œçº¿ç¨‹å®‰å…¨çš„</p><p>å…³äºVectorå¦‚ä½•å®ç°çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œæ˜¯åœ¨æ–¹æ³•ä¸ŠåŠ äº†é”ï¼Œå³synchronized</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312210401865.png" alt="image-20200312210401865"></p><p>è¿™æ ·å°±æ¯æ¬¡åªèƒ½å¤Ÿä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ï¼Œä½†æ˜¯å› ä¸ºåŠ é”äº†ï¼Œå¯¼è‡´å¹¶å‘æ€§åŸºäºä¸‹é™</p><h3 id="5-2-æ–¹æ¡ˆäºŒï¼šCollections-synchronized"><a href="#5-2-æ–¹æ¡ˆäºŒï¼šCollections-synchronized" class="headerlink" title="5.2 æ–¹æ¡ˆäºŒï¼šCollections.synchronized()"></a>5.2 æ–¹æ¡ˆäºŒï¼šCollections.synchronized()</h3><div class="code-wrapper"><pre><code class="hljs java">List&lt;String&gt; list = Collections.synchronizedList(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;());</code></pre></div><p>é‡‡ç”¨Collectionsé›†åˆå·¥å…·ç±»ï¼Œåœ¨ArrayListå¤–é¢åŒ…è£…ä¸€å±‚ åŒæ­¥ æœºåˆ¶</p><h3 id="5-3-æ–¹æ¡ˆä¸‰ï¼šé‡‡ç”¨JUCé‡Œé¢çš„æ–¹æ³•"><a href="#5-3-æ–¹æ¡ˆä¸‰ï¼šé‡‡ç”¨JUCé‡Œé¢çš„æ–¹æ³•" class="headerlink" title="5.3 æ–¹æ¡ˆä¸‰ï¼šé‡‡ç”¨JUCé‡Œé¢çš„æ–¹æ³•"></a>5.3 æ–¹æ¡ˆä¸‰ï¼šé‡‡ç”¨JUCé‡Œé¢çš„æ–¹æ³•</h3><p>CopyOnWriteArrayListï¼šå†™æ—¶å¤åˆ¶ï¼Œä¸»è¦æ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³</p><p>å†™æ—¶å¤åˆ¶ï¼ŒCopyOnWriteå®¹å™¨å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ï¼Œå¾€ä¸€ä¸ªå®¹å™¨ä¸­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨Object[]æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†Object[]è¿›è¡Œcopyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨object[] newElementsï¼Œç„¶åæ–°çš„å®¹å™¨Object[] newElementsé‡Œæ·»åŠ åŸå§‹ï¼Œæ·»åŠ å…ƒç´ å®Œåï¼Œåœ¨å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ setArray(newElements)ï¼›è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å¯¹copyOnWriteå®¹å™¨è¿›è¡Œå¹¶å‘çš„è¯» ï¼Œè€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸éœ€è¦æ·»åŠ ä»»ä½•å…ƒç´ ã€‚æ‰€ä»¥CopyOnWriteå®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯»å’Œå†™ä¸åŒçš„å®¹å™¨</p><p>å°±æ˜¯å†™çš„æ—¶å€™ï¼ŒæŠŠArrayListæ‰©å®¹ä¸€ä¸ªå‡ºæ¥ï¼Œç„¶åæŠŠå€¼å¡«å†™ä¸Šå»ï¼Œåœ¨é€šçŸ¥å…¶ä»–çš„çº¿ç¨‹ï¼ŒArrayListçš„å¼•ç”¨æŒ‡å‘æ‰©å®¹åçš„</p><p>æŸ¥çœ‹åº•å±‚addæ–¹æ³•æºç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        Object[] elements = getArray();        <span class="hljs-keyword">int</span> len = elements.length;        Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);        newElements[len] = e;        setArray(newElements);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();    &#125;&#125;</code></pre></div><p>é¦–å…ˆéœ€è¦åŠ é”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;lock.lock();</code></pre></div><p>ç„¶ååœ¨æœ«å°¾æ‰©å®¹ä¸€ä¸ªå•ä½</p><div class="code-wrapper"><pre><code class="hljs java">Object[] elements = getArray();<span class="hljs-keyword">int</span> len = elements.length;Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);</code></pre></div><p>ç„¶ååœ¨æŠŠæ‰©å®¹åçš„ç©ºé—´ï¼Œå¡«å†™ä¸Šéœ€è¦addçš„å†…å®¹</p><div class="code-wrapper"><pre><code class="hljs java">newElements[len] = e;</code></pre></div><p>æœ€åæŠŠå†…å®¹setåˆ°Arrayä¸­</p><h2 id="6-HashSetçº¿ç¨‹ä¸å®‰å…¨"><a href="#6-HashSetçº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="6 HashSetçº¿ç¨‹ä¸å®‰å…¨"></a>6 HashSetçº¿ç¨‹ä¸å®‰å…¨</h2><h3 id="CopyOnWriteArraySet"><a href="#CopyOnWriteArraySet" class="headerlink" title="CopyOnWriteArraySet"></a>CopyOnWriteArraySet</h3><p>åº•å±‚è¿˜æ˜¯ä½¿ç”¨CopyOnWriteArrayListè¿›è¡Œå®ä¾‹åŒ–</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312221602095.png" alt="image-20200312221602095"></p><h3 id="HashSetåº•å±‚ç»“æ„"><a href="#HashSetåº•å±‚ç»“æ„" class="headerlink" title="HashSetåº•å±‚ç»“æ„"></a>HashSetåº•å±‚ç»“æ„</h3><p>åŒç†HashSetçš„åº•å±‚ç»“æ„å°±æ˜¯HashMap</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200312221735178.png" alt="image-20200312221735178"></p><p>ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘è°ƒç”¨ HashSet.add()çš„æ–¹æ³•ï¼Œåªéœ€è¦ä¼ é€’ä¸€ä¸ªå…ƒç´ ï¼Œè€ŒHashMapæ˜¯éœ€è¦ä¼ é€’key-valueé”®å€¼å¯¹ï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹hashSetçš„addæ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<span class="hljs-keyword">return</span> map.put(e, PRESENT)==<span class="hljs-keyword">null</span>;&#125;</code></pre></div><p>æˆ‘ä»¬èƒ½å‘ç°ä½†æˆ‘ä»¬è°ƒç”¨addçš„æ—¶å€™ï¼Œå­˜å‚¨ä¸€ä¸ªå€¼è¿›å…¥mapä¸­ï¼Œåªæ˜¯ä½œä¸ºkeyè¿›è¡Œå­˜å‚¨ï¼Œè€Œvalueå­˜å‚¨çš„æ˜¯ä¸€ä¸ªObjectç±»å‹çš„å¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´HashSetåªå…³å¿ƒkeyï¼Œè€Œä¸å…³å¿ƒvalue</p><h2 id="7-HashMapçº¿ç¨‹ä¸å®‰å…¨"><a href="#7-HashMapçº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="7 HashMapçº¿ç¨‹ä¸å®‰å…¨"></a>7 HashMapçº¿ç¨‹ä¸å®‰å…¨</h2><p>åŒç†HashMapåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¹Ÿæ˜¯ä¸å®‰å…¨çš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;    Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            map.put(Thread.currentThread().getName(), UUID.randomUUID().toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>));            System.out.println(map);        &#125;, String.valueOf(i)).start();    &#125;&#125;</code></pre></div><h3 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h3><p>1ã€ä½¿ç”¨Collections.synchronizedMap(new HashMap&lt;&gt;());</p><p>2ã€ä½¿ç”¨ ConcurrentHashMap</p><div class="code-wrapper"><pre><code class="hljs java">Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();</code></pre></div><h1 id="ç¬¬5ç« -å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’"><a href="#ç¬¬5ç« -å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’" class="headerlink" title="ç¬¬5ç«  å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’"></a>ç¬¬5ç«  å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’</h1><h2 id="1-ä¸¾ä¾‹"><a href="#1-ä¸¾ä¾‹" class="headerlink" title="1 ä¸¾ä¾‹"></a>1 ä¸¾ä¾‹</h2><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>&#123;    <span class="hljs-keyword">private</span> Integer id;    <span class="hljs-keyword">private</span> String personName;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String personName)</span> </span>&#123;        <span class="hljs-keyword">this</span>.personName = personName;    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransferValueDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeValue1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;        age = <span class="hljs-number">30</span>;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeValue2</span><span class="hljs-params">(Person person)</span> </span>&#123;        person.setPersonName(<span class="hljs-string">&quot;XXXX&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeValue3</span><span class="hljs-params">(String str)</span> </span>&#123;        str = <span class="hljs-string">&quot;XXX&quot;</span>;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        TransferValueDemo test = <span class="hljs-keyword">new</span> TransferValueDemo();        <span class="hljs-comment">// å®šä¹‰åŸºæœ¬æ•°æ®ç±»å‹</span>        <span class="hljs-keyword">int</span> age = <span class="hljs-number">20</span>;        test.changeValue1(age);        System.out.println(<span class="hljs-string">&quot;age ----&quot;</span> + age);        <span class="hljs-comment">// å®ä¾‹åŒ–personç±»</span>        Person person = <span class="hljs-keyword">new</span> Person(<span class="hljs-string">&quot;abc&quot;</span>);        test.changeValue2(person);        System.out.println(<span class="hljs-string">&quot;personName-----&quot;</span> + person.getPersonName());        <span class="hljs-comment">// String</span>        String str = <span class="hljs-string">&quot;abc&quot;</span>;        test.changeValue3(str);        System.out.println(<span class="hljs-string">&quot;string-----&quot;</span> + str);    &#125;&#125;</code></pre></div><p>æœ€åè¾“å‡ºç»“æœ</p><div class="code-wrapper"><pre><code class="hljs shell">age ----20personName-----XXXXstring-----abc</code></pre></div><h2 id="2-changeValue1çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#2-changeValue1çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="2 changeValue1çš„æ‰§è¡Œè¿‡ç¨‹"></a>2 changeValue1çš„æ‰§è¡Œè¿‡ç¨‹</h2><p>å…«ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåœ¨æ ˆé‡Œé¢åˆ†é…å†…å­˜ï¼Œå±äºå€¼ä¼ é€’</p><p><code>æ ˆç®¡è¿è¡Œï¼Œå †ç®¡å­˜å‚¨</code></p><p>å½“ä»¬æ‰§è¡Œ changeValue1çš„æ—¶å€™ï¼Œå› ä¸ºintæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥ä¼ é€’çš„æ˜¯int = 20è¿™ä¸ªå€¼ï¼Œç›¸å½“äºä¼ é€’çš„æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œmainæ–¹æ³•é‡Œé¢çš„ageå¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¾“å‡ºçš„ç»“æœ ageè¿˜æ˜¯20ï¼Œå±äºå€¼ä¼ é€’</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200314185317851.png" alt="image-20200314185317851"></p><h2 id="3-changeValue2çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#3-changeValue2çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="3 changeValue2çš„æ‰§è¡Œè¿‡ç¨‹"></a>3 changeValue2çš„æ‰§è¡Œè¿‡ç¨‹</h2><p>å› ä¸ºPersonæ˜¯å±äºå¯¹è±¡ï¼Œä¼ é€’çš„æ˜¯å†…å­˜åœ°å€ï¼Œå½“æ‰§è¡ŒchangeValue2çš„æ—¶å€™ï¼Œä¼šæ”¹å˜å†…å­˜ä¸­çš„Personçš„å€¼ï¼Œå±äºå¼•ç”¨ä¼ é€’ï¼Œä¸¤ä¸ªæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘åŒä¸€ä¸ªåœ°å€</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200314185528034.png" alt="image-20200314185528034"></p><h2 id="4-changeValue3çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#4-changeValue3çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="4 changeValue3çš„æ‰§è¡Œè¿‡ç¨‹"></a>4 changeValue3çš„æ‰§è¡Œè¿‡ç¨‹</h2><p>Stringä¸å±äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œè¿˜æ˜¯abcå‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºStringçš„ç‰¹æ®Šæ€§ï¼Œå½“æˆ‘ä»¬æ‰§è¡ŒString str = â€œabcâ€çš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠ <code>abc</code> æ”¾å…¥å¸¸é‡æ± ä¸­</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200314190021466.png" alt="image-20200314190021466"></p><p>å½“æˆ‘ä»¬æ‰§è¡ŒchangeValue3çš„æ—¶å€™ï¼Œä¼šé‡æ–°æ–°å»ºä¸€ä¸ªxxxï¼Œå¹¶æ²¡æœ‰é”€æ¯abcï¼Œç„¶åæŒ‡å‘xxxï¼Œç„¶åæœ€åæˆ‘ä»¬è¾“å‡ºçš„æ˜¯mainä¸­çš„å¼•ç”¨ï¼Œè¿˜æ˜¯æŒ‡å‘çš„abcï¼Œå› æ­¤æœ€åè¾“å‡ºç»“æœè¿˜æ˜¯abc</p><h1 id="ç¬¬6ç« -Lock"><a href="#ç¬¬6ç« -Lock" class="headerlink" title="ç¬¬6ç«  Lock"></a>ç¬¬6ç«  Lock</h1><h2 id="1-Javaé”ä¹‹å…¬å¹³é”å’Œéå…¬å¹³é”"><a href="#1-Javaé”ä¹‹å…¬å¹³é”å’Œéå…¬å¹³é”" class="headerlink" title="1 Javaé”ä¹‹å…¬å¹³é”å’Œéå…¬å¹³é”"></a>1 Javaé”ä¹‹å…¬å¹³é”å’Œéå…¬å¹³é”</h2><h3 id="1-1-æ¦‚å¿µ"><a href="#1-1-æ¦‚å¿µ" class="headerlink" title="1.1 æ¦‚å¿µ"></a>1.1 æ¦‚å¿µ</h3><h4 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h4><p>æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œç±»ä¼¼äºæ’é˜Ÿä¹°é¥­ï¼Œå…ˆæ¥ååˆ°ï¼Œå…ˆæ¥å…ˆæœåŠ¡ï¼Œå°±æ˜¯å…¬å¹³çš„ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—</p><h4 id="éå…¬å¹³é”"><a href="#éå…¬å¹³é”" class="headerlink" title="éå…¬å¹³é”"></a>éå…¬å¹³é”</h4><p>æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºï¼Œå¹¶ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½ç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ï¼Œåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæœ‰å¯èƒ½é€ æˆä¼˜å…ˆçº§ç¿»è½¬ï¼Œæˆ–è€…é¥¥é¥¿çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯æŸä¸ªçº¿ç¨‹ä¸€ç›´å¾—ä¸åˆ°é”ï¼‰</p><h3 id="1-2-å¦‚ä½•åˆ›å»º"><a href="#1-2-å¦‚ä½•åˆ›å»º" class="headerlink" title="1.2 å¦‚ä½•åˆ›å»º"></a>1.2 å¦‚ä½•åˆ›å»º</h3><p>å¹¶å‘åŒ…ä¸­ReentrantLockçš„åˆ›å»ºå¯ä»¥æŒ‡å®šææ„å‡½æ•°çš„booleanç±»å‹æ¥å¾—åˆ°å…¬å¹³é”æˆ–è€…éå…¬å¹³é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">* åˆ›å»ºä¸€ä¸ªå¯é‡å…¥é”ï¼Œtrue è¡¨ç¤ºå…¬å¹³é”ï¼Œfalse è¡¨ç¤ºéå…¬å¹³é”ã€‚é»˜è®¤éå…¬å¹³é”</span><span class="hljs-comment">*/</span>Lock lock = <span class="hljs-keyword">new</span> ReentrantLock(<span class="hljs-keyword">true</span>);</code></pre></div><h3 id="1-3-ä¸¤è€…åŒºåˆ«"><a href="#1-3-ä¸¤è€…åŒºåˆ«" class="headerlink" title="1.3 ä¸¤è€…åŒºåˆ«"></a>1.3 ä¸¤è€…åŒºåˆ«</h3><p><strong>å…¬å¹³é”</strong>ï¼šå°±æ˜¯å¾ˆå…¬å¹³ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è·å–é”æ—¶ä¼šå…ˆæŸ¥çœ‹æ­¤é”ç»´æŠ¤çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœä¸ºç©ºï¼Œæˆ–è€…å½“å‰çº¿ç¨‹æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå°±å ç”¨é”ï¼Œå¦è€…å°±ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»¥åå®‰è£…FIFOçš„è§„åˆ™ä»é˜Ÿåˆ—ä¸­å–åˆ°è‡ªå·±</p><p><strong>éå…¬å¹³é”ï¼š</strong> éå…¬å¹³é”æ¯”è¾ƒç²—é²ï¼Œä¸Šæ¥å°±ç›´æ¥å°è¯•å æœ‰é”ï¼Œå¦‚æœå°è¯•å¤±è´¥ï¼Œå°±å†é‡‡ç”¨ç±»ä¼¼å…¬å¹³é”é‚£ç§æ–¹å¼ã€‚</p><h3 id="1-4-é¢˜å¤–è¯"><a href="#1-4-é¢˜å¤–è¯" class="headerlink" title="1.4 é¢˜å¤–è¯"></a>1.4 é¢˜å¤–è¯</h3><p>Java ReenttrantLocké€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šè¯¥é”æ˜¯å¦å…¬å¹³ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œå› ä¸ºéå…¬å¹³é”çš„ä¼˜ç‚¹åœ¨äºååé‡æ¯”å…¬å¹³é”å¤§ï¼Œ<code>å¯¹äºsynchronizedè€Œè¨€ï¼Œä¹Ÿæ˜¯ä¸€ç§éå…¬å¹³é”</code></p><h2 id="2-å¯é‡å…¥é”å’Œé€’å½’é”ReentrantLock"><a href="#2-å¯é‡å…¥é”å’Œé€’å½’é”ReentrantLock" class="headerlink" title="2 å¯é‡å…¥é”å’Œé€’å½’é”ReentrantLock"></a>2 å¯é‡å…¥é”å’Œé€’å½’é”ReentrantLock</h2><h3 id="2-1-æ¦‚å¿µ"><a href="#2-1-æ¦‚å¿µ" class="headerlink" title="2.1 æ¦‚å¿µ"></a>2.1 æ¦‚å¿µ</h3><p>å¯é‡å…¥é”å°±æ˜¯é€’å½’é”</p><p>æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–åˆ°è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼š<code>çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥çš„ä»£ç å—</code></p><p>ReentrantLock / Synchronized å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¯é‡å…¥é”</p><h3 id="2-2-ä»£ç "><a href="#2-2-ä»£ç " class="headerlink" title="2.2 ä»£ç "></a>2.2 ä»£ç </h3><p>å¯é‡å…¥é”å°±æ˜¯ï¼Œåœ¨ä¸€ä¸ªmethod1æ–¹æ³•ä¸­åŠ å…¥ä¸€æŠŠé”ï¼Œæ–¹æ³•2ä¹ŸåŠ é”äº†ï¼Œé‚£ä¹ˆä»–ä»¬æ‹¥æœ‰çš„æ˜¯åŒä¸€æŠŠé”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">()</span> </span>&#123;method2();&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span><span class="hljs-params">()</span> </span>&#123;&#125;</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦è¿›å…¥method1åï¼Œé‚£ä¹ˆå®ƒä¹Ÿèƒ½ç›´æ¥è¿›å…¥method2æ–¹æ³•ï¼Œå› ä¸ºä»–ä»¬æ‰€æ‹¥æœ‰çš„é”ï¼Œæ˜¯åŒä¸€æŠŠã€‚</p><h3 id="2-3-ä½œç”¨"><a href="#2-3-ä½œç”¨" class="headerlink" title="2.3 ä½œç”¨"></a>2.3 ä½œç”¨</h3><p>å¯é‡å…¥é”çš„æœ€å¤§ä½œç”¨å°±æ˜¯é¿å…æ­»é”</p><h3 id="2-4-å¯é‡å…¥é”éªŒè¯"><a href="#2-4-å¯é‡å…¥é”éªŒè¯" class="headerlink" title="2.4 å¯é‡å…¥é”éªŒè¯"></a>2.4 å¯é‡å…¥é”éªŒè¯</h3><h4 id="è¯æ˜Synchronized"><a href="#è¯æ˜Synchronized" class="headerlink" title="è¯æ˜Synchronized"></a>è¯æ˜Synchronized</h4><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å¯é‡å…¥é”ï¼ˆä¹Ÿå«é€’å½’é”ï¼‰</span><span class="hljs-comment"> * æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–åˆ°è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * ä¹Ÿå°±æ˜¯è¯´ï¼š`çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥çš„ä»£ç å—`</span><span class="hljs-comment"> */</span><span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Phone</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å‘é€çŸ­ä¿¡</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendSMS</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t invoked sendSMS()&quot;</span>);        <span class="hljs-comment">// åœ¨åŒæ­¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨å¦å¤–ä¸€ä¸ªåŒæ­¥æ–¹æ³•</span>        sendEmail();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å‘é‚®ä»¶</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendEmail</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        System.out.println(Thread.currentThread().getId() + <span class="hljs-string">&quot;\t invoked sendEmail()&quot;</span>);    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReenterLockDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Phone phone = <span class="hljs-keyword">new</span> Phone();        <span class="hljs-comment">// ä¸¤ä¸ªçº¿ç¨‹æ“ä½œèµ„æºåˆ—</span>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">try</span> &#123;                phone.sendSMS();            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                e.printStackTrace();            &#125;        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">try</span> &#123;                phone.sendSMS();            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                e.printStackTrace();            &#125;        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();    &#125;&#125;</code></pre></div><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªèµ„æºç±»phoneï¼Œæ‹¥æœ‰ä¸¤ä¸ªåŠ äº†synchronizedçš„åŒæ­¥æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯sendSMS å’Œ sendEmailï¼Œæˆ‘ä»¬åœ¨sendSMSæ–¹æ³•ä¸­ï¼Œè°ƒç”¨sendEmailã€‚æœ€ååœ¨ä¸»çº¿ç¨‹åŒæ—¶å¼€å¯äº†ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œæµ‹è¯•ï¼Œæœ€åå¾—åˆ°çš„ç»“æœä¸ºï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">t1 invoked sendSMS()t1 invoked sendEmail()t2 invoked sendSMS()t2 invoked sendEmail()</code></pre></div><p>è¿™å°±è¯´æ˜å½“ t1 çº¿ç¨‹è¿›å…¥sendSMSçš„æ—¶å€™ï¼Œæ‹¥æœ‰äº†ä¸€æŠŠé”ï¼ŒåŒæ—¶t2çº¿ç¨‹æ— æ³•è¿›å…¥ï¼Œç›´åˆ°t1çº¿ç¨‹æ‹¿ç€é”ï¼Œæ‰§è¡Œäº†sendEmail æ–¹æ³•åï¼Œæ‰é‡Šæ”¾é”ï¼Œè¿™æ ·t2æ‰èƒ½å¤Ÿè¿›å…¥</p><div class="code-wrapper"><pre><code class="hljs shell">t1 invoked sendSMS()      t1çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™t1 invoked sendEmail()    t1åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”t2 invoked sendSMS()      t2çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™t2 invoked sendEmail()    t2åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”</code></pre></div><h4 id="è¯æ˜ReentrantLock"><a href="#è¯æ˜ReentrantLock" class="headerlink" title="è¯æ˜ReentrantLock"></a>è¯æ˜ReentrantLock</h4><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Phone</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span></span>&#123;    Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * setè¿›å»çš„æ—¶å€™ï¼Œå°±åŠ é”ï¼Œè°ƒç”¨setæ–¹æ³•çš„æ—¶å€™ï¼Œèƒ½å¦è®¿é—®å¦å¤–ä¸€ä¸ªåŠ é”çš„setæ–¹æ³•</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getLock</span><span class="hljs-params">()</span> </span>&#123;        lock.lock();        <span class="hljs-keyword">try</span> &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t get Lock&quot;</span>);            setLock();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLock</span><span class="hljs-params">()</span> </span>&#123;        lock.lock();        <span class="hljs-keyword">try</span> &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t set Lock&quot;</span>);        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        getLock();    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReenterLockDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Phone phone = <span class="hljs-keyword">new</span> Phone();        <span class="hljs-comment">/**</span><span class="hljs-comment">         * å› ä¸ºPhoneå®ç°äº†Runnableæ¥å£</span><span class="hljs-comment">         */</span>        Thread t3 = <span class="hljs-keyword">new</span> Thread(phone, <span class="hljs-string">&quot;t3&quot;</span>);        Thread t4 = <span class="hljs-keyword">new</span> Thread(phone, <span class="hljs-string">&quot;t4&quot;</span>);        t3.start();        t4.start();    &#125;&#125;</code></pre></div><p>ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ReentrantLockè¿›è¡ŒéªŒè¯ï¼Œé¦–å…ˆèµ„æºç±»å®ç°äº†Runnableæ¥å£ï¼Œé‡å†™Runæ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨getæ–¹æ³•ï¼Œgetæ–¹æ³•åœ¨è¿›å…¥çš„æ—¶å€™ï¼Œå°±åŠ äº†é”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getLock</span><span class="hljs-params">()</span> </span>&#123;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t get Lock&quot;</span>);        setLock();    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();    &#125;&#125;</code></pre></div><p>ç„¶ååœ¨æ–¹æ³•é‡Œé¢ï¼Œåˆè°ƒç”¨å¦å¤–ä¸€ä¸ªåŠ äº†é”çš„setLockæ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLock</span><span class="hljs-params">()</span> </span>&#123;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t set Lock&quot;</span>);    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();    &#125;&#125;</code></pre></div><p>æœ€åè¾“å‡ºç»“æœæˆ‘ä»¬èƒ½å‘ç°ï¼Œç»“æœå’ŒåŠ synchronizedæ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯åœ¨å¤–å±‚çš„æ–¹æ³•è·å–é”ä¹‹åï¼Œçº¿ç¨‹èƒ½å¤Ÿç›´æ¥è¿›å…¥é‡Œå±‚</p><div class="code-wrapper"><pre><code class="hljs shell">t3 get Lockt3 set Lockt4 get Lockt4 set Lock</code></pre></div><p><strong>å½“æˆ‘ä»¬åœ¨getLockæ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</strong>  (é˜¿é‡Œé¢è¯•)</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getLock</span><span class="hljs-params">()</span> </span>&#123;    lock.lock();    lock.lock();    <span class="hljs-keyword">try</span> &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t get Lock&quot;</span>);        setLock();    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();        lock.unlock();    &#125;&#125;</code></pre></div><p>æœ€åå¾—åˆ°çš„ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºé‡Œé¢ä¸ç®¡æœ‰å‡ æŠŠé”ï¼Œå…¶å®ƒä»–ä»¬éƒ½æ˜¯åŒä¸€æŠŠé”ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨åŒä¸€ä¸ªé’¥åŒ™éƒ½èƒ½å¤Ÿæ‰“å¼€</p><p><strong>å½“æˆ‘ä»¬åœ¨getLockæ–¹æ³•åŠ ä¸¤æŠŠé”ï¼Œä½†æ˜¯åªè§£ä¸€æŠŠé”ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</strong></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getLock</span><span class="hljs-params">()</span> </span>&#123;    lock.lock();    lock.lock();    <span class="hljs-keyword">try</span> &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t get Lock&quot;</span>);        setLock();    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();        lock.unlock();    &#125;&#125;</code></pre></div><p>å¾—åˆ°ç»“æœ</p><div class="code-wrapper"><pre><code class="hljs pgsql">t3 <span class="hljs-keyword">get</span> <span class="hljs-keyword">Lock</span>t3 <span class="hljs-keyword">set</span> <span class="hljs-keyword">Lock</span></code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜æˆ‘ä»¬ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”</p><p><strong>å½“æˆ‘ä»¬åªåŠ ä¸€æŠŠé”ï¼Œä½†æ˜¯ç”¨ä¸¤æŠŠé”æ¥è§£é”çš„æ—¶å€™ï¼Œåˆä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</strong></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getLock</span><span class="hljs-params">()</span> </span>&#123;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t get Lock&quot;</span>);        setLock();    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();        lock.unlock();    &#125;&#125;</code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™</p><div class="code-wrapper"><pre><code class="hljs shell">t3 get Lockt3 set Lockt4 get Lockt4 set LockException in thread &quot;t3&quot; Exception in thread &quot;t4&quot; java.lang.IllegalMonitorStateExceptionat java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:151)at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1261)at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:457)at com.moxi.interview.study.thread.Phone.getLock(ReenterLockDemo.java:52)at com.moxi.interview.study.thread.Phone.run(ReenterLockDemo.java:67)at java.lang.Thread.run(Thread.java:745)java.lang.IllegalMonitorStateExceptionat java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:151)at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1261)at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:457)at com.moxi.interview.study.thread.Phone.getLock(ReenterLockDemo.java:52)at com.moxi.interview.study.thread.Phone.run(ReenterLockDemo.java:67)at java.lang.Thread.run(Thread.java:745)</code></pre></div><h2 id="3-Javaé”ä¹‹è‡ªæ—‹é”"><a href="#3-Javaé”ä¹‹è‡ªæ—‹é”" class="headerlink" title="3 Javaé”ä¹‹è‡ªæ—‹é”"></a>3 Javaé”ä¹‹è‡ªæ—‹é”</h2><p>è‡ªæ—‹é”ï¼šspinlockï¼Œæ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPU</p><p>åŸæ¥æåˆ°çš„æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œåº•å±‚ä½¿ç”¨çš„å°±æ˜¯è‡ªæ—‹ï¼Œè‡ªæ—‹å°±æ˜¯å¤šæ¬¡å°è¯•ï¼Œå¤šæ¬¡è®¿é—®ï¼Œä¸ä¼šé˜»å¡çš„çŠ¶æ€å°±æ˜¯è‡ªæ—‹ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200315154143781.png" alt="image-20200315154143781"></p><h3 id="3-1-ä¼˜ç¼ºç‚¹"><a href="#3-1-ä¼˜ç¼ºç‚¹" class="headerlink" title="3.1 ä¼˜ç¼ºç‚¹"></a>3.1 ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼šå¾ªç¯æ¯”è¾ƒè·å–ç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œæ²¡æœ‰ç±»ä¼¼äºwaitçš„é˜»å¡</p><p>ç¼ºç‚¹ï¼šå½“ä¸æ–­è‡ªæ—‹çš„çº¿ç¨‹è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œä¼šå› ä¸ºæ‰§è¡Œwhileå¾ªç¯ä¸æ–­çš„æ¶ˆè€—CPUèµ„æº</p><h3 id="3-2-æ‰‹å†™è‡ªæ—‹é”"><a href="#3-2-æ‰‹å†™è‡ªæ—‹é”" class="headerlink" title="3.2 æ‰‹å†™è‡ªæ—‹é”"></a>3.2 æ‰‹å†™è‡ªæ—‹é”</h3><p>é€šè¿‡CASæ“ä½œå®Œæˆè‡ªæ—‹é”ï¼ŒAçº¿ç¨‹å…ˆè¿›æ¥è°ƒç”¨myLockæ–¹æ³•è‡ªå·±æŒæœ‰é”5ç§’ï¼ŒBéšåè¿›æ¥å‘ç°å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œä¸æ˜¯nullï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°Aé‡Šæ”¾é”åBéšåæŠ¢åˆ°</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * æ‰‹å†™ä¸€ä¸ªè‡ªæ—‹é”</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * å¾ªç¯æ¯”è¾ƒè·å–ç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œæ²¡æœ‰ç±»ä¼¼äºwaitçš„é˜»å¡</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * é€šè¿‡CASæ“ä½œå®Œæˆè‡ªæ—‹é”ï¼ŒAçº¿ç¨‹å…ˆè¿›æ¥è°ƒç”¨myLockæ–¹æ³•è‡ªå·±æŒæœ‰é”5ç§’ï¼ŒBéšåè¿›æ¥å‘ç°å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œä¸æ˜¯nullï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°Aé‡Šæ”¾é”åBéšåæŠ¢åˆ°</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpinLockDemo</span> </span>&#123;    <span class="hljs-comment">// ç°åœ¨çš„æ³›å‹è£…çš„æ˜¯Threadï¼ŒåŸå­å¼•ç”¨çº¿ç¨‹</span>    AtomicReference&lt;Thread&gt;  atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myLock</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// è·å–å½“å‰è¿›æ¥çš„çº¿ç¨‹</span>        Thread thread = Thread.currentThread();        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t come in &quot;</span>);        <span class="hljs-comment">// å¼€å§‹è‡ªæ—‹ï¼ŒæœŸæœ›å€¼æ˜¯nullï¼Œæ›´æ–°å€¼æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ›´æ–°ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦è€…è‡ªæ—‹</span>        <span class="hljs-keyword">while</span>(!atomicReference.compareAndSet(<span class="hljs-keyword">null</span>, thread)) &#123;        &#125;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è§£é”</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myUnLock</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// è·å–å½“å‰è¿›æ¥çš„çº¿ç¨‹</span>        Thread thread = Thread.currentThread();        <span class="hljs-comment">// è‡ªå·±ç”¨å®Œäº†åï¼ŒæŠŠatomicReferenceå˜æˆnull</span>        atomicReference.compareAndSet(thread, <span class="hljs-keyword">null</span>);        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t invoked myUnlock()&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        SpinLockDemo spinLockDemo = <span class="hljs-keyword">new</span> SpinLockDemo();        <span class="hljs-comment">// å¯åŠ¨t1çº¿ç¨‹ï¼Œå¼€å§‹æ“ä½œ</span>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-comment">// å¼€å§‹å æœ‰é”</span>            spinLockDemo.myLock();            <span class="hljs-keyword">try</span> &#123;                TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-comment">// å¼€å§‹é‡Šæ”¾é”</span>            spinLockDemo.myUnLock();        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-comment">// è®©mainçº¿ç¨‹æš‚åœ1ç§’ï¼Œä½¿å¾—t1çº¿ç¨‹ï¼Œå…ˆæ‰§è¡Œ</span>        <span class="hljs-keyword">try</span> &#123;            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        <span class="hljs-comment">// 1ç§’åï¼Œå¯åŠ¨t2çº¿ç¨‹ï¼Œå¼€å§‹å ç”¨è¿™ä¸ªé”</span>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-comment">// å¼€å§‹å æœ‰é”</span>            spinLockDemo.myLock();            <span class="hljs-comment">// å¼€å§‹é‡Šæ”¾é”</span>            spinLockDemo.myUnLock();        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();    &#125;&#125;</code></pre></div><p>æœ€åè¾“å‡ºç»“æœ</p><div class="code-wrapper"><pre><code class="hljs isbl"><span class="hljs-variable">t1</span> <span class="hljs-variable">come</span> <span class="hljs-variable"><span class="hljs-keyword">in</span></span>.....ä¸€ç§’å.....<span class="hljs-variable">t2</span> <span class="hljs-variable">come</span> <span class="hljs-variable"><span class="hljs-keyword">in</span></span>.....äº”ç§’å.....<span class="hljs-variable">t1</span> <span class="hljs-variable">invoked</span> <span class="hljs-function"><span class="hljs-title">myUnlock</span>()</span><span class="hljs-variable">t2</span> <span class="hljs-variable">invoked</span> <span class="hljs-function"><span class="hljs-title">myUnlock</span>()</span></code></pre></div><p>é¦–å…ˆè¾“å‡ºçš„æ˜¯ t1     come in </p><p>ç„¶å1ç§’åï¼Œt2çº¿ç¨‹å¯åŠ¨ï¼Œå‘ç°é”è¢«t1å æœ‰ï¼Œæ‰€æœ‰ä¸æ–­çš„æ‰§è¡Œ compareAndSetæ–¹æ³•ï¼Œæ¥è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°t1é‡Šæ”¾é”åï¼Œä¹Ÿå°±æ˜¯5ç§’åï¼Œt2æˆåŠŸè·å–åˆ°é”ï¼Œç„¶åé‡Šæ”¾</p><h2 id="4-ç‹¬å é”ï¼ˆå†™é”ï¼‰-å…±äº«é”ï¼ˆè¯»é”ï¼‰-äº’æ–¥é”"><a href="#4-ç‹¬å é”ï¼ˆå†™é”ï¼‰-å…±äº«é”ï¼ˆè¯»é”ï¼‰-äº’æ–¥é”" class="headerlink" title="4 ç‹¬å é”ï¼ˆå†™é”ï¼‰ / å…±äº«é”ï¼ˆè¯»é”ï¼‰ / äº’æ–¥é”"></a>4 ç‹¬å é”ï¼ˆå†™é”ï¼‰ / å…±äº«é”ï¼ˆè¯»é”ï¼‰ / äº’æ–¥é”</h2><h3 id="4-1-æ¦‚å¿µ"><a href="#4-1-æ¦‚å¿µ" class="headerlink" title="4.1 æ¦‚å¿µ"></a>4.1 æ¦‚å¿µ</h3><p>ç‹¬å é”ï¼šæŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¯¹ReentrantLockå’ŒSynchronizedè€Œè¨€éƒ½æ˜¯ç‹¬å é”</p><p>å…±äº«é”ï¼šæŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹é”æŒæœ‰</p><p>å¯¹ReentrantReadWriteLockå…¶è¯»é”æ˜¯å…±äº«ï¼Œå…¶å†™é”æ˜¯ç‹¬å </p><p>å†™çš„æ—¶å€™åªèƒ½ä¸€ä¸ªäººå†™ï¼Œä½†æ˜¯è¯»çš„æ—¶å€™ï¼Œå¯ä»¥å¤šä¸ªäººåŒæ—¶è¯»</p><h3 id="4-2-ä¸ºä»€ä¹ˆä¼šæœ‰å†™é”å’Œè¯»é”"><a href="#4-2-ä¸ºä»€ä¹ˆä¼šæœ‰å†™é”å’Œè¯»é”" class="headerlink" title="4.2 ä¸ºä»€ä¹ˆä¼šæœ‰å†™é”å’Œè¯»é”"></a>4.2 ä¸ºä»€ä¹ˆä¼šæœ‰å†™é”å’Œè¯»é”</h3><p>åŸæ¥æˆ‘ä»¬ä½¿ç”¨ReentrantLockåˆ›å»ºé”çš„æ—¶å€™ï¼Œæ˜¯ç‹¬å é”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªè¯»å†™åˆ†ç¦»åœºæ™¯ï¼Œè¯»çš„æ—¶å€™æƒ³åŒæ—¶è¿›è¡Œï¼Œå› æ­¤åŸæ¥ç‹¬å é”çš„å¹¶å‘æ€§å°±æ²¡è¿™ä¹ˆå¥½äº†ï¼Œå› ä¸ºè¯»é”å¹¶ä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å¤šä¸ªäººå…±äº«è¯»</p><div class="code-wrapper"><pre><code class="hljs plain">å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™</code></pre></div><p>è¯»-è¯»ï¼šèƒ½å…±å­˜</p><p>è¯»-å†™ï¼šä¸èƒ½å…±å­˜</p><p>å†™-å†™ï¼šä¸èƒ½å…±å­˜</p><h3 id="4-3-ä»£ç å®ç°"><a href="#4-3-ä»£ç å®ç°" class="headerlink" title="4.3 ä»£ç å®ç°"></a>4.3 ä»£ç å®ç°</h3><p>å®ç°ä¸€ä¸ªè¯»å†™ç¼“å­˜çš„æ“ä½œï¼Œå‡è®¾å¼€å§‹æ²¡æœ‰åŠ é”çš„æ—¶å€™ï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯»å†™é”</span><span class="hljs-comment"> * å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œ</span><span class="hljs-comment"> * ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">import</span> java.util.HashMap;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCache</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();    <span class="hljs-comment">// private Lock lock = null;</span>    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å®šä¹‰å†™æ“ä½œ</span><span class="hljs-comment">     * æ»¡è¶³ï¼šåŸå­ + ç‹¬å </span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(String key, Object value)</span> </span>&#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ­£åœ¨å†™å…¥ï¼š&quot;</span> + key);        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’</span>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">300</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        map.put(key, value);        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t å†™å…¥å®Œæˆ&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ­£åœ¨è¯»å–:&quot;</span>);        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’</span>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">300</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        Object value = map.get(key);        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t è¯»å–å®Œæˆï¼š&quot;</span> + value);    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadWriteLockDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        MyCache myCache = <span class="hljs-keyword">new</span> MyCache();        <span class="hljs-comment">// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ5ä¸ªçº¿ç¨‹å†™</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;            <span class="hljs-comment">// lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final</span>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                myCache.put(tempInt + <span class="hljs-string">&quot;&quot;</span>, tempInt +  <span class="hljs-string">&quot;&quot;</span>);            &#125;, String.valueOf(i)).start();        &#125;        <span class="hljs-comment">// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ 5ä¸ªçº¿ç¨‹è¯»</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;            <span class="hljs-comment">// lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final</span>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                myCache.get(tempInt + <span class="hljs-string">&quot;&quot;</span>);            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬åˆ†åˆ«åˆ›å»º5ä¸ªçº¿ç¨‹å†™å…¥ç¼“å­˜</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ5ä¸ªçº¿ç¨‹å†™</span><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;    <span class="hljs-comment">// lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final</span>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;    <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;        myCache.put(tempInt + <span class="hljs-string">&quot;&quot;</span>, tempInt +  <span class="hljs-string">&quot;&quot;</span>);    &#125;, String.valueOf(i)).start();&#125;</code></pre></div><p>5ä¸ªçº¿ç¨‹è¯»å–ç¼“å­˜ï¼Œ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ 5ä¸ªçº¿ç¨‹è¯»</span><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;    <span class="hljs-comment">// lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final</span>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;    <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;        myCache.get(tempInt + <span class="hljs-string">&quot;&quot;</span>);    &#125;, String.valueOf(i)).start();&#125;</code></pre></div><p>æœ€åè¿è¡Œç»“æœï¼š</p><div class="code-wrapper"><pre><code class="hljs 1c"><span class="hljs-number">0</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">0</span><span class="hljs-number">4</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">4</span><span class="hljs-number">3</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">3</span><span class="hljs-number">1</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">1</span><span class="hljs-number">2</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">2</span><span class="hljs-number">0</span> æ­£åœ¨è¯»å–:<span class="hljs-number">1</span> æ­£åœ¨è¯»å–:<span class="hljs-number">2</span> æ­£åœ¨è¯»å–:<span class="hljs-number">3</span> æ­£åœ¨è¯»å–:<span class="hljs-number">4</span> æ­£åœ¨è¯»å–:<span class="hljs-number">2</span> å†™å…¥å®Œæˆ<span class="hljs-number">4</span> å†™å…¥å®Œæˆ<span class="hljs-number">4</span> è¯»å–å®Œæˆï¼š<span class="hljs-literal">null</span><span class="hljs-number">0</span> å†™å…¥å®Œæˆ<span class="hljs-number">3</span> è¯»å–å®Œæˆï¼š<span class="hljs-literal">null</span><span class="hljs-number">0</span> è¯»å–å®Œæˆï¼š<span class="hljs-literal">null</span><span class="hljs-number">1</span> å†™å…¥å®Œæˆ<span class="hljs-number">3</span> å†™å…¥å®Œæˆ<span class="hljs-number">1</span> è¯»å–å®Œæˆï¼š<span class="hljs-literal">null</span><span class="hljs-number">2</span> è¯»å–å®Œæˆï¼š<span class="hljs-literal">null</span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å†™å…¥çš„æ—¶å€™ï¼Œå†™æ“ä½œéƒ½æ²¡å…¶å®ƒçº¿ç¨‹æ‰“æ–­äº†ï¼Œè¿™å°±é€ æˆäº†ï¼Œè¿˜æ²¡å†™å®Œï¼Œå…¶å®ƒçº¿ç¨‹åˆå¼€å§‹å†™ï¼Œè¿™æ ·å°±é€ æˆæ•°æ®ä¸ä¸€è‡´</p><h3 id="4-4-è§£å†³æ–¹æ³•"><a href="#4-4-è§£å†³æ–¹æ³•" class="headerlink" title="4.4 è§£å†³æ–¹æ³•"></a>4.4 è§£å†³æ–¹æ³•</h3><p>ä¸Šé¢çš„ä»£ç æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œè¿™æ ·å°±ä¼šé€ æˆçº¿ç¨‹åœ¨è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œè¢«å…¶å®ƒçº¿ç¨‹é¢‘ç¹æ‰“æ–­ï¼Œä»è€Œä¸å…·å¤‡åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°è¯»å†™é”æ¥è§£å†³äº†</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">* åˆ›å»ºä¸€ä¸ªè¯»å†™é”</span><span class="hljs-comment">* å®ƒæ˜¯ä¸€ä¸ªè¯»å†™èä¸ºä¸€ä½“çš„é”ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è½¬æ¢</span><span class="hljs-comment">*/</span><span class="hljs-keyword">private</span> ReentrantReadWriteLock rwLock = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();</code></pre></div><p>å½“æˆ‘ä»¬åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå°±éœ€è¦è½¬æ¢æˆå†™é”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå†™é”</span>rwLock.writeLock().lock();<span class="hljs-comment">// å†™é” é‡Šæ”¾</span>rwLock.writeLock().unlock();</code></pre></div><p>å½“ä»¬åœ¨è¿›è¡Œè¯»æ“ä½œçš„æ—¶å€™ï¼Œåœ¨è½¬æ¢æˆè¯»é”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè¯»é”</span>rwLock.readLock().lock();<span class="hljs-comment">// è¯»é” é‡Šæ”¾</span>rwLock.readLock().unlock();</code></pre></div><p>è¿™é‡Œçš„è¯»é”å’Œå†™é”çš„åŒºåˆ«åœ¨äºï¼Œå†™é”ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œæ‰§è¡Œå†™æ“ä½œï¼Œè€Œè¯»é”æ˜¯å¤šä¸ªçº¿ç¨‹èƒ½å¤ŸåŒæ—¶è¿›å…¥ï¼Œè¿›è¡Œè¯»å–çš„æ“ä½œ</p><p>å®Œæ•´ä»£ç ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯»å†™é”</span><span class="hljs-comment"> * å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œ</span><span class="hljs-comment"> * ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">import</span> java.util.HashMap;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;<span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCache</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç¼“å­˜ä¸­çš„ä¸œè¥¿ï¼Œå¿…é¡»ä¿æŒå¯è§æ€§ï¼Œå› æ­¤ä½¿ç”¨volatileä¿®é¥°</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åˆ›å»ºä¸€ä¸ªè¯»å†™é”</span><span class="hljs-comment">     * å®ƒæ˜¯ä¸€ä¸ªè¯»å†™èä¸ºä¸€ä½“çš„é”ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è½¬æ¢</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> ReentrantReadWriteLock rwLock = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å®šä¹‰å†™æ“ä½œ</span><span class="hljs-comment">     * æ»¡è¶³ï¼šåŸå­ + ç‹¬å </span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(String key, Object value)</span> </span>&#123;        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå†™é”</span>        rwLock.writeLock().lock();        <span class="hljs-keyword">try</span> &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ­£åœ¨å†™å…¥ï¼š&quot;</span> + key);            <span class="hljs-keyword">try</span> &#123;                <span class="hljs-comment">// æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’</span>                TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">300</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            map.put(key, value);            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t å†™å…¥å®Œæˆ&quot;</span>);        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            <span class="hljs-comment">// å†™é” é‡Šæ”¾</span>            rwLock.writeLock().unlock();        &#125;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;        <span class="hljs-comment">// è¯»é”</span>        rwLock.readLock().lock();        <span class="hljs-keyword">try</span> &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ­£åœ¨è¯»å–:&quot;</span>);            <span class="hljs-keyword">try</span> &#123;                <span class="hljs-comment">// æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’</span>                TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">300</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            Object value = map.get(key);            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t è¯»å–å®Œæˆï¼š&quot;</span> + value);        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            <span class="hljs-comment">// è¯»é”é‡Šæ”¾</span>            rwLock.readLock().unlock();        &#125;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ¸…ç©ºç¼“å­˜</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clean</span><span class="hljs-params">()</span> </span>&#123;        map.clear();    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadWriteLockDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        MyCache myCache = <span class="hljs-keyword">new</span> MyCache();        <span class="hljs-comment">// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ5ä¸ªçº¿ç¨‹å†™</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) &#123;            <span class="hljs-comment">// lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final</span>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                myCache.put(tempInt + <span class="hljs-string">&quot;&quot;</span>, tempInt +  <span class="hljs-string">&quot;&quot;</span>);            &#125;, String.valueOf(i)).start();        &#125;        <span class="hljs-comment">// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ 5ä¸ªçº¿ç¨‹è¯»</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) &#123;            <span class="hljs-comment">// lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final</span>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                myCache.get(tempInt + <span class="hljs-string">&quot;&quot;</span>);            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœï¼š</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">1</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">1</span><span class="hljs-attribute">1</span> å†™å…¥å®Œæˆ<span class="hljs-attribute">2</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">2</span><span class="hljs-attribute">2</span> å†™å…¥å®Œæˆ<span class="hljs-attribute">3</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">3</span><span class="hljs-attribute">3</span> å†™å…¥å®Œæˆ<span class="hljs-attribute">4</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">4</span><span class="hljs-attribute">4</span> å†™å…¥å®Œæˆ<span class="hljs-attribute">5</span> æ­£åœ¨å†™å…¥ï¼š<span class="hljs-number">5</span><span class="hljs-attribute">5</span> å†™å…¥å®Œæˆ<span class="hljs-attribute">2</span> æ­£åœ¨è¯»å–:<span class="hljs-attribute">3</span> æ­£åœ¨è¯»å–:<span class="hljs-attribute">1</span> æ­£åœ¨è¯»å–:<span class="hljs-attribute">4</span> æ­£åœ¨è¯»å–:<span class="hljs-attribute">5</span> æ­£åœ¨è¯»å–:<span class="hljs-attribute">2</span> è¯»å–å®Œæˆï¼š<span class="hljs-number">2</span><span class="hljs-attribute">1</span> è¯»å–å®Œæˆï¼š<span class="hljs-number">1</span><span class="hljs-attribute">4</span> è¯»å–å®Œæˆï¼š<span class="hljs-number">4</span><span class="hljs-attribute">3</span> è¯»å–å®Œæˆï¼š<span class="hljs-number">3</span><span class="hljs-attribute">5</span> è¯»å–å®Œæˆï¼š<span class="hljs-number">5</span></code></pre></div><p>ä»è¿è¡Œç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå†™å…¥æ“ä½œæ˜¯ä¸€ä¸ªä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ‰§è¡Œçš„ï¼Œå¹¶ä¸”ä¸­é—´ä¸ä¼šè¢«æ‰“æ–­ï¼Œè€Œè¯»æ“ä½œçš„æ—¶å€™ï¼Œæ˜¯åŒæ—¶5ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œç„¶åå¹¶å‘è¯»å–æ“ä½œ</p><h2 id="5-ä¸ºä»€ä¹ˆSynchronizedæ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œå´èƒ½ä¿è¯æœ‰åºæ€§"><a href="#5-ä¸ºä»€ä¹ˆSynchronizedæ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œå´èƒ½ä¿è¯æœ‰åºæ€§" class="headerlink" title="5 ä¸ºä»€ä¹ˆSynchronizedæ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œå´èƒ½ä¿è¯æœ‰åºæ€§"></a>5 ä¸ºä»€ä¹ˆSynchronizedæ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œå´èƒ½ä¿è¯æœ‰åºæ€§</h2><h3 id="5-1-å‰è¨€"><a href="#5-1-å‰è¨€" class="headerlink" title="5.1 å‰è¨€"></a>5.1 å‰è¨€</h3><p>é¦–å…ˆæˆ‘ä»¬è¦åˆ†æä¸‹è¿™é“é¢˜ï¼Œè¿™ç®€å•çš„ä¸€ä¸ªé—®é¢˜ï¼Œå…¶å®é‡Œé¢è¿˜æ˜¯åŒ…å«äº†å¾ˆå¤šä¿¡æ¯çš„ï¼Œè¦æƒ³å›ç­”å¥½è¿™ä¸ªé—®é¢˜ï¼Œé¢è¯•è€…è‡³å°‘è¦çŸ¥é“ä¸€ä¸‹æ¦‚å¿µï¼š</p><ul><li>Javaå†…å­˜æ¨¡å‹</li><li>å¹¶å‘ç¼–ç¨‹æœ‰åºæ€§é—®é¢˜</li><li>æŒ‡ä»¤é‡æ’</li><li>synchronizedé”</li><li>å¯é‡å…¥é”</li><li>æ’å®ƒé”</li><li>as-if-serialè¯­ä¹‰</li><li>å•çº¿ç¨‹&amp;å¤šçº¿ç¨‹</li></ul><h3 id="5-2-æ ‡å‡†è§£ç­”"><a href="#5-2-æ ‡å‡†è§£ç­”" class="headerlink" title="5.2 æ ‡å‡†è§£ç­”"></a>5.2 æ ‡å‡†è§£ç­”</h3><p>ä¸ºäº†è¿›ä¸€æ­¥æå‡è®¡ç®—æœºå„æ–¹é¢èƒ½åŠ›ï¼Œåœ¨ç¡¬ä»¶å±‚é¢åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå¦‚å¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ç­‰ï¼Œä½†æ˜¯è¿™äº›æŠ€æœ¯çš„å¼•å…¥å°±ä¼šå¯¼è‡´æœ‰åºæ€§é—®é¢˜ã€‚</p><blockquote><p>å…ˆè§£é‡Šä»€ä¹ˆæ˜¯æœ‰åºæ€§é—®é¢˜ï¼Œä¹ŸçŸ¥é“æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„æœ‰åºæ€§é—®é¢˜</p></blockquote><p>æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œæœ€å¥½çš„è§£å†³æœ‰åºæ€§é—®é¢˜çš„åŠæ³•ï¼Œå°±æ˜¯ç¦æ­¢å¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ï¼Œå°±åƒvolatileä¸­ä½¿ç”¨å†…å­˜å±éšœä¸€æ ·ã€‚</p><blockquote><p>è¡¨æ˜ä½ çŸ¥é“å•¥æ˜¯æŒ‡ä»¤é‡æ’ï¼Œä¹ŸçŸ¥é“ä»–çš„å®ç°åŸç†</p></blockquote><p>ä½†æ˜¯ï¼Œè™½ç„¶å¾ˆå¤šç¡¬ä»¶éƒ½ä¼šä¸ºäº†ä¼˜åŒ–åšä¸€äº›é‡æ’ï¼Œä½†æ˜¯åœ¨Javaä¸­ï¼Œä¸ç®¡æ€ä¹ˆæ’åºï¼Œéƒ½ä¸èƒ½å½±å“å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚è¿™å°±æ˜¯as-if-serialè¯­ä¹‰ï¼Œæ‰€æœ‰ç¡¬ä»¶ä¼˜åŒ–çš„å‰æéƒ½æ˜¯å¿…é¡»éµå®ˆas-if-serialè¯­ä¹‰ã€‚</p><p>as-if-serialè¯­ä¹‰æŠŠ<strong>å•çº¿ç¨‹</strong>ç¨‹åºä¿æŠ¤äº†èµ·æ¥ï¼Œéµå®ˆas-if-serialè¯­ä¹‰çš„ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨å…±åŒä¸ºç¼–å†™å•çº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›å»ºäº†ä¸€ä¸ªå¹»è§‰ï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚as-if-serialè¯­ä¹‰ä½¿å•çº¿ç¨‹ç¨‹åºå‘˜æ— éœ€æ‹…å¿ƒé‡æ’åºä¼š å¹²æ‰°ä»–ä»¬ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒå†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p><blockquote><p>é‡ç‚¹ï¼è§£é‡Šä¸‹ä»€ä¹ˆæ˜¯as-if-serialè¯­ä¹‰ï¼Œå› ä¸ºè¿™æ˜¯è¿™é“é¢˜çš„ç¬¬ä¸€ä¸ªå…³é”®è¯ï¼Œç­”ä¸Šæ¥å°±å¯¹äº†ä¸€åŠäº†</p></blockquote><p>å†è¯´ä¸‹synchronizedï¼Œä»–æ˜¯Javaæä¾›çš„é”ï¼Œå¯ä»¥é€šè¿‡ä»–å¯¹Javaä¸­çš„å¯¹è±¡åŠ é”ï¼Œå¹¶ä¸”ä»–æ˜¯ä¸€ç§æ’ä»–çš„ã€å¯é‡å…¥çš„é”ã€‚</p><p>æ‰€ä»¥ï¼Œå½“æŸä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°ä¸€æ®µè¢«synchronizedä¿®é¥°çš„ä»£ç ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡ŒåŠ é”ï¼Œæ‰§è¡Œå®Œä¹‹åå†è¿›è¡Œè§£é”ã€‚åœ¨åŠ é”ä¹‹åï¼Œè§£é”ä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯æ— æ³•å†æ¬¡è·å¾—é”çš„ï¼Œåªæœ‰è¿™æ¡åŠ é”çº¿ç¨‹å¯ä»¥é‡å¤è·å¾—è¯¥é”ã€‚</p><blockquote><p>ä»‹ç»synchronizedçš„åŸç†ï¼Œè¿™æ˜¯æœ¬é¢˜çš„ç¬¬äºŒä¸ªå…³é”®ç‚¹ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬å°±å¯ä»¥æ‹¿æ»¡åˆ†äº†ã€‚</p></blockquote><p>synchronizedé€šè¿‡æ’ä»–é”çš„æ–¹å¼å°±ä¿è¯äº†åŒä¸€æ—¶é—´å†…ï¼Œè¢«synchronizedä¿®é¥°çš„ä»£ç æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ã€‚æ‰€ä»¥å‘¢ï¼Œè¿™å°±æ»¡è¶³äº†as-if-serialè¯­ä¹‰çš„ä¸€ä¸ªå…³é”®å‰æï¼Œé‚£å°±æ˜¯<strong>å•çº¿ç¨‹</strong>ï¼Œå› ä¸ºæœ‰as-if-serialè¯­ä¹‰ä¿è¯ï¼Œå•çº¿ç¨‹çš„æœ‰åºæ€§å°±å¤©ç„¶å­˜åœ¨äº†ã€‚</p><h1 id="ç¬¬7ç« -è®¡æ—¶å™¨å’Œä¿¡å·é‡"><a href="#ç¬¬7ç« -è®¡æ—¶å™¨å’Œä¿¡å·é‡" class="headerlink" title="ç¬¬7ç«  è®¡æ—¶å™¨å’Œä¿¡å·é‡"></a>ç¬¬7ç«  è®¡æ—¶å™¨å’Œä¿¡å·é‡</h1><h2 id="1-CountDownLatch"><a href="#1-CountDownLatch" class="headerlink" title="1 CountDownLatch"></a>1 CountDownLatch</h2><h3 id="1-1-æ¦‚å¿µ-1"><a href="#1-1-æ¦‚å¿µ-1" class="headerlink" title="1.1 æ¦‚å¿µ"></a>1.1 æ¦‚å¿µ</h3><p>è®©ä¸€äº›çº¿ç¨‹é˜»å¡ç›´åˆ°å¦ä¸€äº›çº¿ç¨‹å®Œæˆä¸€ç³»åˆ—æ“ä½œæ‰è¢«å”¤é†’</p><p>CountDownLatchä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•æ—¶ï¼Œè°ƒç”¨çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ã€‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨CountDownæ–¹æ³•ä¼šå°†è®¡æ•°å™¨å‡1ï¼ˆè°ƒç”¨CountDownæ–¹æ³•çš„çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼‰ï¼Œå½“è®¡æ•°å™¨çš„å€¼å˜æˆé›¶æ—¶ï¼Œå› è°ƒç”¨awaitæ–¹æ³•è¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œ</p><h3 id="1-2-åœºæ™¯"><a href="#1-2-åœºæ™¯" class="headerlink" title="1.2 åœºæ™¯"></a>1.2 åœºæ™¯</h3><p>ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå‡è®¾ä¸€ä¸ªè‡ªä¹ å®¤é‡Œæœ‰7ä¸ªäººï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯ç­é•¿ï¼Œç­é•¿çš„ä¸»è¦èŒè´£å°±æ˜¯åœ¨å…¶å®ƒ6ä¸ªåŒå­¦èµ°äº†åï¼Œå…³ç¯ï¼Œé”æ•™å®¤é—¨ï¼Œç„¶åèµ°äººï¼Œå› æ­¤ç­é•¿æ˜¯éœ€è¦æœ€åä¸€ä¸ªèµ°çš„ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤Ÿæ§åˆ¶ç­é•¿è¿™ä¸ªçº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªæ‰§è¡Œï¼Œè€Œå…¶å®ƒçº¿ç¨‹æ˜¯éšæœºæ‰§è¡Œçš„</p><h3 id="1-3-è§£å†³æ–¹æ¡ˆ"><a href="#1-3-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="1.3 è§£å†³æ–¹æ¡ˆ"></a>1.3 è§£å†³æ–¹æ¡ˆ</h3><p>è¿™ä¸ªæ—¶å€™å°±ç”¨åˆ°äº†CountDownLatchï¼Œè®¡æ•°å™¨äº†ã€‚æˆ‘ä»¬ä¸€å…±åˆ›å»º6ä¸ªçº¿ç¨‹ï¼Œç„¶åè®¡æ•°å™¨çš„å€¼ä¹Ÿè®¾ç½®æˆ6</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// è®¡æ•°å™¨</span>CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">6</span>);</code></pre></div><p>ç„¶åæ¯æ¬¡å­¦ç”Ÿçº¿ç¨‹æ‰§è¡Œå®Œï¼Œå°±è®©è®¡æ•°å™¨çš„å€¼å‡1</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">6</span>; i++) &#123;    <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤&quot;</span>);        countDownLatch.countDown();    &#125;, String.valueOf(i)).start();&#125;</code></pre></div><p>æœ€åæˆ‘ä»¬éœ€è¦é€šè¿‡CountDownLatchçš„awaitæ–¹æ³•æ¥æ§åˆ¶ç­é•¿ä¸»çº¿ç¨‹çš„æ‰§è¡Œï¼Œè¿™é‡Œ countDownLatch.await()å¯ä»¥æƒ³æˆæ˜¯ä¸€é“å¢™ï¼Œåªæœ‰å½“è®¡æ•°å™¨çš„å€¼ä¸º0çš„æ—¶å€™ï¼Œå¢™æ‰ä¼šæ¶ˆå¤±ï¼Œä¸»çº¿ç¨‹æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</p><div class="code-wrapper"><pre><code class="hljs java">countDownLatch.await();System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç­é•¿æœ€åå…³é—¨&quot;</span>);</code></pre></div><p>ä¸åŠ CountDownLatchçš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬å‘ç°mainçº¿ç¨‹æå‰å·²ç»æ‰§è¡Œå®Œæˆäº†</p><div class="code-wrapper"><pre><code class="hljs css"><span class="hljs-number">1</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">0</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-selector-tag">main</span> ç­é•¿æœ€åå…³é—¨<span class="hljs-number">2</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">3</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">4</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">5</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">6</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤</code></pre></div><p>å¼•å…¥CountDownLatchåçš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ä½mainæ–¹æ³•çš„æ‰§è¡Œï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯å‰æä»»åŠ¡çš„æ‰§è¡Œ</p><div class="code-wrapper"><pre><code class="hljs css"><span class="hljs-number">0</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">2</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">4</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">1</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">5</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">6</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-number">3</span> ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤<span class="hljs-selector-tag">main</span> ç­é•¿æœ€åå…³é—¨</code></pre></div><h3 id="1-4-å®Œæ•´ä»£ç "><a href="#1-4-å®Œæ•´ä»£ç " class="headerlink" title="1.4 å®Œæ•´ä»£ç "></a>1.4 å®Œæ•´ä»£ç </h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.moxi.interview.study.thread;<span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountDownLatchDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        <span class="hljs-comment">// è®¡æ•°å™¨</span>        CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">6</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">6</span>; i++) &#123;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ä¸Šå®Œè‡ªä¹ ï¼Œç¦»å¼€æ•™å®¤&quot;</span>);                countDownLatch.countDown();            &#125;, String.valueOf(i)).start();        &#125;        countDownLatch.await();        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç­é•¿æœ€åå…³é—¨&quot;</span>);    &#125;&#125;</code></pre></div><h2 id="2-CyclicBarrier"><a href="#2-CyclicBarrier" class="headerlink" title="2 CyclicBarrier"></a>2 CyclicBarrier</h2><h3 id="2-1-æ¦‚å¿µ-1"><a href="#2-1-æ¦‚å¿µ-1" class="headerlink" title="2.1 æ¦‚å¿µ"></a>2.1 æ¦‚å¿µ</h3><p>å’ŒCountDownLatchç›¸åï¼Œéœ€è¦é›†é½ä¸ƒé¢—é¾™ç ï¼Œå¬å”¤ç¥é¾™ã€‚ä¹Ÿå°±æ˜¯åšåŠ æ³•ï¼Œå¼€å§‹æ˜¯0ï¼ŒåŠ åˆ°æŸä¸ªå€¼çš„æ—¶å€™å°±æ‰§è¡Œ</p><p>CyclicBarrierçš„å­—é¢æ„æ€å°±æ˜¯å¯å¾ªç¯ï¼ˆcyclicï¼‰ä½¿ç”¨çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦æ±‚åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ï¼Œçº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡CyclicBarrierçš„awaitæ–¹æ³•</p><h3 id="2-2-æ¡ˆä¾‹"><a href="#2-2-æ¡ˆä¾‹" class="headerlink" title="2.2 æ¡ˆä¾‹"></a>2.2 æ¡ˆä¾‹</h3><p>é›†é½7ä¸ªé¾™ç ï¼Œå¬å”¤ç¥é¾™çš„Demoï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ›å»ºCyclicBarrier</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">* å®šä¹‰ä¸€ä¸ªå¾ªç¯å±éšœï¼Œå‚æ•°1ï¼šéœ€è¦ç´¯åŠ çš„å€¼ï¼Œå‚æ•°2 éœ€è¦æ‰§è¡Œçš„æ–¹æ³•</span><span class="hljs-comment">*/</span>CyclicBarrier cyclicBarrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">7</span>, () -&gt; &#123;System.out.println(<span class="hljs-string">&quot;å¬å”¤ç¥é¾™&quot;</span>);&#125;);</code></pre></div><p>ç„¶ååŒæ—¶ç¼–å†™ä¸ƒä¸ªçº¿ç¨‹ï¼Œè¿›è¡Œé¾™ç æ”¶é›†ï¼Œä½†ä¸€ä¸ªçº¿ç¨‹æ”¶é›†åˆ°äº†çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®©ä»–æ‰§è¡Œawaitæ–¹æ³•ï¼Œç­‰å¾…åˆ°7ä¸ªçº¿ç¨‹å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬å°±æ‰§è¡ŒåŸæ¥å®šä¹‰å¥½çš„æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; i++) &#123;    <span class="hljs-keyword">final</span> Integer tempInt = i;    <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ”¶é›†åˆ° ç¬¬&quot;</span> + tempInt + <span class="hljs-string">&quot;é¢—é¾™ç &quot;</span>);        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// å…ˆåˆ°çš„è¢«é˜»å¡ï¼Œç­‰å…¨éƒ¨çº¿ç¨‹å®Œæˆåï¼Œæ‰èƒ½æ‰§è¡Œæ–¹æ³•</span>            cyclicBarrier.await();        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">catch</span> (BrokenBarrierException e) &#123;            e.printStackTrace();        &#125;    &#125;, String.valueOf(i)).start();&#125;</code></pre></div><p>å®Œæ•´ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * CyclicBarrierå¾ªç¯å±éšœ</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CyclicBarrierDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">/**</span><span class="hljs-comment">         * å®šä¹‰ä¸€ä¸ªå¾ªç¯å±éšœï¼Œå‚æ•°1ï¼šéœ€è¦ç´¯åŠ çš„å€¼ï¼Œå‚æ•°2 éœ€è¦æ‰§è¡Œçš„æ–¹æ³•</span><span class="hljs-comment">         */</span>        CyclicBarrier cyclicBarrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">7</span>, () -&gt; &#123;            System.out.println(<span class="hljs-string">&quot;å¬å”¤ç¥é¾™&quot;</span>);        &#125;);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; i++) &#123;            <span class="hljs-keyword">final</span> Integer tempInt = i;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ”¶é›†åˆ° ç¬¬&quot;</span> + tempInt + <span class="hljs-string">&quot;é¢—é¾™ç &quot;</span>);                <span class="hljs-keyword">try</span> &#123;                    <span class="hljs-comment">// å…ˆåˆ°çš„è¢«é˜»å¡ï¼Œç­‰å…¨éƒ¨çº¿ç¨‹å®Œæˆåï¼Œæ‰èƒ½æ‰§è¡Œæ–¹æ³•</span>                    cyclicBarrier.await();                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                    e.printStackTrace();                &#125; <span class="hljs-keyword">catch</span> (BrokenBarrierException e) &#123;                    e.printStackTrace();                &#125;            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><h2 id="3-Semaphoreï¼šä¿¡å·é‡"><a href="#3-Semaphoreï¼šä¿¡å·é‡" class="headerlink" title="3 Semaphoreï¼šä¿¡å·é‡"></a>3 Semaphoreï¼šä¿¡å·é‡</h2><h3 id="3-1-æ¦‚å¿µ"><a href="#3-1-æ¦‚å¿µ" class="headerlink" title="3.1 æ¦‚å¿µ"></a>3.1 æ¦‚å¿µ</h3><p>ä¿¡å·é‡ä¸»è¦ç”¨äºä¸¤ä¸ªç›®çš„</p><ul><li>ä¸€ä¸ªæ˜¯ç”¨äºå…±äº«èµ„æºçš„äº’æ–¥ä½¿ç”¨</li><li>å¦ä¸€ä¸ªç”¨äºå¹¶å‘çº¿ç¨‹æ•°çš„æ§åˆ¶</li></ul><h3 id="3-2-ä»£ç "><a href="#3-2-ä»£ç " class="headerlink" title="3.2 ä»£ç "></a>3.2 ä»£ç </h3><p>æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªæŠ¢è½¦ä½çš„åœºæ™¯ï¼Œå‡è®¾ä¸€å…±æœ‰6ä¸ªè½¦ï¼Œ3ä¸ªåœè½¦ä½</p><p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆéœ€è¦å®šä¹‰ä¿¡å·é‡ä¸º3ï¼Œä¹Ÿå°±æ˜¯3ä¸ªåœè½¦ä½</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">* åˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ä¸º3ï¼Œé»˜è®¤æ˜¯false éå…¬å¹³é”ï¼Œ æ¨¡æ‹Ÿ3ä¸ªåœè½¦ä½</span><span class="hljs-comment">*/</span>Semaphore semaphore = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>, <span class="hljs-keyword">false</span>);</code></pre></div><p>ç„¶åæˆ‘ä»¬æ¨¡æ‹Ÿ6è¾†è½¦åŒæ—¶å¹¶å‘æŠ¢å åœè½¦ä½ï¼Œä½†ç¬¬ä¸€ä¸ªè½¦è¾†æŠ¢å åˆ°åœè½¦ä½åï¼Œä¿¡å·é‡éœ€è¦å‡1</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// ä»£è¡¨ä¸€è¾†è½¦ï¼Œå·²ç»å ç”¨äº†è¯¥è½¦ä½</span>semaphore.acquire(); <span class="hljs-comment">// æŠ¢å </span></code></pre></div><p>åŒæ—¶è½¦è¾†å‡è®¾éœ€è¦ç­‰å¾…3ç§’åï¼Œé‡Šæ”¾ä¿¡å·é‡</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ¯ä¸ªè½¦åœ3ç§’</span><span class="hljs-keyword">try</span> &#123;TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;e.printStackTrace();&#125;</code></pre></div><p>æœ€åè½¦è¾†ç¦»å¼€ï¼Œé‡Šæ”¾ä¿¡å·é‡</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// é‡Šæ”¾åœè½¦ä½</span>semaphore.release();</code></pre></div><h3 id="3-3-å®Œæ•´ä»£ç "><a href="#3-3-å®Œæ•´ä»£ç " class="headerlink" title="3.3 å®Œæ•´ä»£ç "></a>3.3 å®Œæ•´ä»£ç </h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ä¿¡å·é‡Demo</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: é™Œæºª</span><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2020-03-16-15:01</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SemaphoreDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">/**</span><span class="hljs-comment">         * åˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ä¸º3ï¼Œé»˜è®¤æ˜¯false éå…¬å¹³é”ï¼Œ æ¨¡æ‹Ÿ3ä¸ªåœè½¦ä½</span><span class="hljs-comment">         */</span>        Semaphore semaphore = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>, <span class="hljs-keyword">false</span>);        <span class="hljs-comment">// æ¨¡æ‹Ÿ6éƒ¨è½¦</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) &#123;            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                <span class="hljs-keyword">try</span> &#123;                    <span class="hljs-comment">// ä»£è¡¨ä¸€è¾†è½¦ï¼Œå·²ç»å ç”¨äº†è¯¥è½¦ä½</span>                    semaphore.acquire(); <span class="hljs-comment">// æŠ¢å </span>                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æŠ¢åˆ°è½¦ä½&quot;</span>);                    <span class="hljs-comment">// æ¯ä¸ªè½¦åœ3ç§’</span>                    <span class="hljs-keyword">try</span> &#123;                        TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç¦»å¼€è½¦ä½&quot;</span>);                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                    e.printStackTrace();                &#125; <span class="hljs-keyword">finally</span> &#123;                    <span class="hljs-comment">// é‡Šæ”¾åœè½¦ä½</span>                    semaphore.release();                &#125;            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs plain">0 æŠ¢åˆ°è½¦ä½2 æŠ¢åˆ°è½¦ä½1 æŠ¢åˆ°è½¦ä½2 ç¦»å¼€è½¦ä½1 ç¦»å¼€è½¦ä½3 æŠ¢åˆ°è½¦ä½0 ç¦»å¼€è½¦ä½4 æŠ¢åˆ°è½¦ä½5 æŠ¢åˆ°è½¦ä½4 ç¦»å¼€è½¦ä½3 ç¦»å¼€è½¦ä½5 ç¦»å¼€è½¦ä½</code></pre></div><p>çœ‹è¿è¡Œç»“æœèƒ½å¤Ÿå‘ç°ï¼Œ0 2 1 è½¦è¾†é¦–å…ˆæŠ¢å åˆ°äº†åœè½¦ä½ï¼Œç„¶åç­‰å¾…3ç§’åï¼Œç¦»å¼€ï¼Œç„¶ååé¢ 3 4 5 åˆæŠ¢åˆ°äº†è½¦ä½</p><h1 id="ç¬¬8ç« é˜»å¡é˜Ÿåˆ—"><a href="#ç¬¬8ç« é˜»å¡é˜Ÿåˆ—" class="headerlink" title="ç¬¬8ç« é˜»å¡é˜Ÿåˆ—"></a>ç¬¬8ç« é˜»å¡é˜Ÿåˆ—</h1><h2 id="1-æ¦‚å¿µ-1"><a href="#1-æ¦‚å¿µ-1" class="headerlink" title="1 æ¦‚å¿µ"></a>1 æ¦‚å¿µ</h2><h3 id="1-1-é˜Ÿåˆ—"><a href="#1-1-é˜Ÿåˆ—" class="headerlink" title="1.1 é˜Ÿåˆ—"></a>1.1 é˜Ÿåˆ—</h3><p>é˜Ÿåˆ—å°±å¯ä»¥æƒ³æˆæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä»ä¸€å¤´è¿›å…¥ï¼Œä¸€å¤´å‡ºå»ï¼Œæ’é˜Ÿä¹°é¥­</p><h3 id="1-2-é˜»å¡é˜Ÿåˆ—"><a href="#1-2-é˜»å¡é˜Ÿåˆ—" class="headerlink" title="1.2 é˜»å¡é˜Ÿåˆ—"></a>1.2 é˜»å¡é˜Ÿåˆ—</h3><p>BlockingQueue   é˜»å¡é˜Ÿåˆ—ï¼Œæ’é˜Ÿæ‹¥å µï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªé˜»å¡é˜Ÿåˆ—åœ¨æ•°æ®ç»“æ„ä¸­æ‰€èµ·çš„ä½œç”¨å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200316152120272.png" alt="image-20200316152120272"></p><p>çº¿ç¨‹1å¾€é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ï¼Œè€Œçº¿ç¨‹2ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤å…ƒç´ </p><ul><li><p><code>å½“é˜»å¡é˜Ÿåˆ—æ˜¯ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡</code></p><ul><li>å½“è›‹ç³•åº—çš„æŸœå­ç©ºçš„æ—¶å€™ï¼Œæ— æ³•ä»æŸœå­é‡Œé¢è·å–è›‹ç³•</li></ul></li><li><p><code>å½“é˜»å¡é˜Ÿåˆ—æ˜¯æ»¡æ—¶ï¼Œä»é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡</code></p><ul><li>å½“è›‹ç³•åº—çš„æŸœå­æ»¡çš„æ—¶å€™ï¼Œæ— æ³•ç»§ç»­å‘æŸœå­é‡Œé¢æ·»åŠ è›‹ç³•äº†</li></ul></li></ul><p>ä¹Ÿå°±æ˜¯è¯´ è¯•å›¾ä»ç©ºçš„é˜»å¡é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´ </p><p>åŒç†ï¼Œè¯•å›¾å¾€å·²ç»æ»¡çš„é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ æ–°å…ƒç´ çš„çº¿ç¨‹ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹å¾€æ»¡çš„é˜Ÿåˆ—ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œæˆ–è€…å®Œå…¨æ¸…ç©ºé˜Ÿåˆ—åï¼Œä½¿é˜Ÿåˆ—é‡æ–°å˜å¾—ç©ºé—²èµ·æ¥ï¼Œå¹¶åç»­æ–°å¢</p><h2 id="2-ä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ" class="headerlink" title="2 ä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ"></a>2 ä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ</h2><p>å»æµ·åº•æåƒé¥­ï¼Œå¤§å…æ»¡äº†ï¼Œéœ€è¦è¿›å€™å…ç­‰å¾…ï¼Œä½†æ˜¯è¿™äº›ç­‰å¾…çš„å®¢æˆ·èƒ½å¤Ÿå¯¹å•†å®¶å¸¦æ¥åˆ©æ¶¦ï¼Œå› æ­¤æˆ‘ä»¬éå¸¸æ¬¢è¿ä»–ä»¬é˜»å¡</p><p>åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“çš„é˜»å¡ï¼Œåœ¨æŸäº›æ¸…ç©ºä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨å”¤é†’</p><h3 id="ä¸ºä»€ä¹ˆéœ€è¦BlockingQueue"><a href="#ä¸ºä»€ä¹ˆéœ€è¦BlockingQueue" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦BlockingQueue"></a>ä¸ºä»€ä¹ˆéœ€è¦BlockingQueue</h3><p>å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™ä¸€åˆ‡BlockingQueueéƒ½å¸®ä½ ä¸€æ‰‹åŒ…åŠäº†</p><p>åœ¨concurrentåŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»è‡ªå·±å–æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚åº¦ã€‚</p><h2 id="3-æ¶æ„"><a href="#3-æ¶æ„" class="headerlink" title="3 æ¶æ„"></a>3 æ¶æ„</h2><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// ä½ ç”¨è¿‡Listé›†åˆç±»</span><span class="hljs-comment">// ArrayListé›†åˆç±»ç†Ÿæ‚‰ä¹ˆï¼Ÿ</span><span class="hljs-comment">// è¿˜ç”¨è¿‡ CopyOnWriteList  å’Œ BlockingQueue</span></code></pre></div><p>BlockingQueueé˜»å¡é˜Ÿåˆ—æ˜¯å±äºä¸€ä¸ªæ¥å£ï¼Œåº•ä¸‹æœ‰ä¸ƒä¸ªå®ç°ç±»</p><ul><li>ArrayBlockQueueï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li><li>LinkedBlockingQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œï¼ˆä½†æ˜¯é»˜è®¤å¤§å° Integer.MAX_VALUEï¼‰çš„é˜»å¡é˜Ÿåˆ—<ul><li>æœ‰ç•Œï¼Œä½†æ˜¯ç•Œé™éå¸¸å¤§ï¼Œç›¸å½“äºæ— ç•Œï¼Œå¯ä»¥å½“æˆæ— ç•Œ</li></ul></li><li>PriorityBlockQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>DelayQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—<ul><li>ç”Ÿäº§ä¸€ä¸ªï¼Œæ¶ˆè´¹ä¸€ä¸ªï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œä¸æ¶ˆè´¹ä¸ç”Ÿäº§</li></ul></li><li>LinkedTransferQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>LinkedBlockingDequeï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—</li></ul><p>è¿™é‡Œéœ€è¦æŒæ¡çš„æ˜¯ï¼šArrayBlockQueueã€LinkedBlockingQueueã€SynchronousQueue</p><h2 id="4-BlockingQueueæ ¸å¿ƒæ–¹æ³•"><a href="#4-BlockingQueueæ ¸å¿ƒæ–¹æ³•" class="headerlink" title="4 BlockingQueueæ ¸å¿ƒæ–¹æ³•"></a>4 BlockingQueueæ ¸å¿ƒæ–¹æ³•</h2><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200316154442756.png" alt="image-20200316154442756"></p><table><thead><tr><th>æŠ›å‡ºå¼‚å¸¸</th><th>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼šåœ¨å¾€é˜Ÿåˆ—ä¸­addæ’å…¥å…ƒç´ ä¼šæŠ›å‡º IIIegalStateExceptionï¼šQueue full                      å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼šå†å¾€é˜Ÿåˆ—ä¸­removeç§»é™¤å…ƒç´ ï¼Œä¼šæŠ›å‡ºNoSuchException</th></tr></thead><tbody><tr><td>ç‰¹æ®Šæ€§</td><td>æ’å…¥æ–¹æ³•ï¼ŒæˆåŠŸtrueï¼Œå¤±è´¥false       ç§»é™¤æ–¹æ³•ï¼šæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—å…ƒç´ ï¼Œé˜Ÿåˆ—æ²¡æœ‰å°±è¿”å›ç©º</td></tr><tr><td>ä¸€ç›´é˜»å¡</td><td>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…ç»§ç»­å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ç›´åˆ°putæ•°æ®orå“åº”ä¸­æ–­é€€å‡ºï¼Œ å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚</td></tr><tr><td>è¶…æ—¶é€€å‡º</td><td>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿé‡Œä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º</td></tr></tbody></table><h3 id="4-1-æŠ›å‡ºå¼‚å¸¸ç»„"><a href="#4-1-æŠ›å‡ºå¼‚å¸¸ç»„" class="headerlink" title="4.1 æŠ›å‡ºå¼‚å¸¸ç»„"></a>4.1 æŠ›å‡ºå¼‚å¸¸ç»„</h3><p>ä½†æ‰§è¡Œaddæ–¹æ³•ï¼Œå‘å·²ç»æ»¡çš„ArrayBlockingQueueä¸­æ·»åŠ å…ƒç´ æ—¶å€™ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// é˜»å¡é˜Ÿåˆ—ï¼Œéœ€è¦å¡«å…¥é»˜è®¤å€¼</span>BlockingQueue&lt;String&gt; blockingQueue = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">3</span>);System.out.println(blockingQueue.add(<span class="hljs-string">&quot;a&quot;</span>));System.out.println(blockingQueue.add(<span class="hljs-string">&quot;b&quot;</span>));System.out.println(blockingQueue.add(<span class="hljs-string">&quot;c&quot;</span>));System.out.println(blockingQueue.add(<span class="hljs-string">&quot;XXX&quot;</span>));</code></pre></div><p>è¿è¡Œåï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">true</span><span class="hljs-keyword">true</span><span class="hljs-keyword">true</span>Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.IllegalStateException: Queue fullat java.util.AbstractQueue.add(AbstractQueue.java:<span class="hljs-number">98</span>)at java.util.concurrent.ArrayBlockingQueue.add(ArrayBlockingQueue.java:<span class="hljs-number">312</span>)at com.moxi.interview.study.queue.BlockingQueueDemo.main(BlockingQueueDemo.java:<span class="hljs-number">25</span>)</code></pre></div><p>åŒæ—¶å¦‚æœæˆ‘ä»¬å¤šå–å‡ºå…ƒç´ çš„æ—¶å€™ï¼Œä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬å‡è®¾åªå­˜å‚¨äº†3ä¸ªå€¼ï¼Œä½†æ˜¯å–çš„æ—¶å€™ï¼Œå–äº†å››æ¬¡</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// é˜»å¡é˜Ÿåˆ—ï¼Œéœ€è¦å¡«å…¥é»˜è®¤å€¼</span>BlockingQueue&lt;String&gt; blockingQueue = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">3</span>);System.out.println(blockingQueue.add(<span class="hljs-string">&quot;a&quot;</span>));System.out.println(blockingQueue.add(<span class="hljs-string">&quot;b&quot;</span>));System.out.println(blockingQueue.add(<span class="hljs-string">&quot;c&quot;</span>));System.out.println(blockingQueue.remove());System.out.println(blockingQueue.remove());System.out.println(blockingQueue.remove());System.out.println(blockingQueue.remove());</code></pre></div><p>é‚£ä¹ˆå‡ºç°å¼‚å¸¸</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">true</span><span class="hljs-keyword">true</span><span class="hljs-keyword">true</span>abcException in thread <span class="hljs-string">&quot;main&quot;</span> java.util.NoSuchElementExceptionat java.util.AbstractQueue.remove(AbstractQueue.java:<span class="hljs-number">117</span>)at com.moxi.interview.study.queue.BlockingQueueDemo.main(BlockingQueueDemo.java:<span class="hljs-number">30</span>)</code></pre></div><h3 id="4-2-å¸ƒå°”ç±»å‹ç»„"><a href="#4-2-å¸ƒå°”ç±»å‹ç»„" class="headerlink" title="4.2 å¸ƒå°”ç±»å‹ç»„"></a>4.2 å¸ƒå°”ç±»å‹ç»„</h3><p>æˆ‘ä»¬ä½¿ç”¨ offerçš„æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ æ—¶å€™ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—æ»¡äº†åï¼Œä¼šè¿”å›falseï¼Œå¦è€…è¿”å›true</p><p>åŒæ—¶åœ¨å–çš„æ—¶å€™ï¼Œå¦‚æœé˜Ÿåˆ—å·²ç©ºï¼Œé‚£ä¹ˆä¼šè¿”å›null</p><div class="code-wrapper"><pre><code class="hljs java">BlockingQueue blockingQueue = <span class="hljs-keyword">new</span> ArrayBlockingQueue(<span class="hljs-number">3</span>);System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;a&quot;</span>));System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;b&quot;</span>));System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;c&quot;</span>));System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;d&quot;</span>));System.out.println(blockingQueue.poll());System.out.println(blockingQueue.poll());System.out.println(blockingQueue.poll());System.out.println(blockingQueue.poll());</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs livecodeserver"><span class="hljs-literal">true</span><span class="hljs-literal">true</span><span class="hljs-literal">true</span><span class="hljs-literal">false</span><span class="hljs-keyword">a</span>bc<span class="hljs-literal">null</span></code></pre></div><h3 id="4-3-é˜»å¡é˜Ÿåˆ—ç»„"><a href="#4-3-é˜»å¡é˜Ÿåˆ—ç»„" class="headerlink" title="4.3 é˜»å¡é˜Ÿåˆ—ç»„"></a>4.3 é˜»å¡é˜Ÿåˆ—ç»„</h3><p>æˆ‘ä»¬ä½¿ç”¨ putçš„æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ æ—¶å€™ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—æ»¡äº†åï¼Œæ·»åŠ æ¶ˆæ¯çš„çº¿ç¨‹ï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—å…ƒç´ å‡å°‘ï¼Œä¼šè¢«æ¸…ç©ºï¼Œæ‰ä¼šå”¤é†’</p><p>ä¸€èˆ¬åœ¨æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ¯”å¦‚RabbitMQä¸­ä¼šä½¿ç”¨åˆ°ï¼Œå› ä¸ºéœ€è¦ä¿è¯æ¶ˆæ¯ç™¾åˆ†ç™¾ä¸ä¸¢å¤±ï¼Œå› æ­¤åªæœ‰è®©å®ƒé˜»å¡</p><div class="code-wrapper"><pre><code class="hljs abnf">BlockingQueue&lt;String&gt; blockingQueue = new ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">3</span>)<span class="hljs-comment">;</span>blockingQueue.put(<span class="hljs-string">&quot;a&quot;</span>)<span class="hljs-comment">;</span>blockingQueue.put(<span class="hljs-string">&quot;b&quot;</span>)<span class="hljs-comment">;</span>blockingQueue.put(<span class="hljs-string">&quot;c&quot;</span>)<span class="hljs-comment">;</span>System.out.println(<span class="hljs-string">&quot;================&quot;</span>)<span class="hljs-comment">;</span>blockingQueue.take()<span class="hljs-comment">;</span>blockingQueue.take()<span class="hljs-comment">;</span>blockingQueue.take()<span class="hljs-comment">;</span>blockingQueue.take()<span class="hljs-comment">;</span></code></pre></div><p>åŒæ—¶ä½¿ç”¨takeå–æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœå†…å®¹ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¢«é˜»å¡</p><h3 id="4-4-ä¸è§ä¸æ•£ç»„"><a href="#4-4-ä¸è§ä¸æ•£ç»„" class="headerlink" title="4.4 ä¸è§ä¸æ•£ç»„"></a>4.4 ä¸è§ä¸æ•£ç»„</h3><p>offer( )  ï¼Œ poll åŠ æ—¶é—´</p><p>ä½¿ç”¨offeræ’å…¥çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šæ—¶é—´ï¼Œå¦‚æœ2ç§’è¿˜æ²¡æœ‰æ’å…¥ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒæ’å…¥</p><div class="code-wrapper"><pre><code class="hljs java">BlockingQueue&lt;String&gt; blockingQueue = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">3</span>);System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">2L</span>, TimeUnit.SECONDS));System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-number">2L</span>, TimeUnit.SECONDS));System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">2L</span>, TimeUnit.SECONDS));System.out.println(blockingQueue.offer(<span class="hljs-string">&quot;d&quot;</span>, <span class="hljs-number">2L</span>, TimeUnit.SECONDS));</code></pre></div><p>åŒæ—¶å–çš„æ—¶å€™ä¹Ÿè¿›è¡Œåˆ¤æ–­</p><div class="code-wrapper"><pre><code class="hljs java">System.out.println(blockingQueue.poll(<span class="hljs-number">2L</span>, TimeUnit.SECONDS));System.out.println(blockingQueue.poll(<span class="hljs-number">2L</span>, TimeUnit.SECONDS));System.out.println(blockingQueue.poll(<span class="hljs-number">2L</span>, TimeUnit.SECONDS));System.out.println(blockingQueue.poll(<span class="hljs-number">2L</span>, TimeUnit.SECONDS));</code></pre></div><p>å¦‚æœ2ç§’å†…å–ä¸å‡ºæ¥ï¼Œé‚£ä¹ˆå°±è¿”å›null</p><h2 id="5-SynchronousQueue"><a href="#5-SynchronousQueue" class="headerlink" title="5 SynchronousQueue"></a>5 SynchronousQueue</h2><p>SynchronousQueueæ²¡æœ‰å®¹é‡ï¼Œä¸å…¶ä»–BlockingQueueä¸åŒï¼ŒSynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨çš„BlockingQueueï¼Œæ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦è€…ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ </p><p>ä¸‹é¢æˆ‘ä»¬æµ‹è¯•SynchronousQueueæ·»åŠ å…ƒç´ çš„è¿‡ç¨‹</p><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ç”¨äºç”Ÿäº§ï¼Œä¸€ä¸ªçº¿ç¨‹ç”¨äºæ¶ˆè´¹</p><p>ç”Ÿäº§çš„çº¿ç¨‹åˆ†åˆ«putäº† Aã€Bã€Cè¿™ä¸‰ä¸ªå­—æ®µ</p><div class="code-wrapper"><pre><code class="hljs java">BlockingQueue&lt;String&gt; blockingQueue = <span class="hljs-keyword">new</span> SynchronousQueue&lt;&gt;();<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;    <span class="hljs-keyword">try</span> &#123;               System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t put A &quot;</span>);        blockingQueue.put(<span class="hljs-string">&quot;A&quot;</span>);               System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t put B &quot;</span>);        blockingQueue.put(<span class="hljs-string">&quot;B&quot;</span>);                        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t put C &quot;</span>);        blockingQueue.put(<span class="hljs-string">&quot;C&quot;</span>);                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;        e.printStackTrace();    &#125;&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();</code></pre></div><p>æ¶ˆè´¹çº¿ç¨‹ä½¿ç”¨takeï¼Œæ¶ˆè´¹é˜»å¡é˜Ÿåˆ—ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”æ¯æ¬¡æ¶ˆè´¹å‰ï¼Œéƒ½ç­‰å¾…5ç§’</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">new</span> Thread(() -&gt; &#123;    <span class="hljs-keyword">try</span> &#123;        <span class="hljs-keyword">try</span> &#123;            TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        blockingQueue.take();        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t take A &quot;</span>);        <span class="hljs-keyword">try</span> &#123;            TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        blockingQueue.take();        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t take B &quot;</span>);        <span class="hljs-keyword">try</span> &#123;            TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        blockingQueue.take();        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t take C &quot;</span>);    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;        e.printStackTrace();    &#125;&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();</code></pre></div><p>æœ€åç»“æœè¾“å‡ºä¸ºï¼š</p><div class="code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-built_in">t1</span> put A <span class="hljs-built_in">t2</span> take A <span class="hljs-number">5</span>ç§’å...<span class="hljs-built_in">t1</span> put <span class="hljs-keyword">B </span><span class="hljs-built_in">t2</span> take <span class="hljs-keyword">B </span><span class="hljs-number">5</span>ç§’å...<span class="hljs-built_in">t1</span> put C <span class="hljs-built_in">t2</span> take C</code></pre></div><p>æˆ‘ä»¬ä»æœ€åçš„è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡t1çº¿ç¨‹å‘é˜Ÿåˆ—ä¸­æ·»åŠ é˜»å¡é˜Ÿåˆ—æ·»åŠ å…ƒç´ åï¼Œt1è¾“å…¥çº¿ç¨‹å°±ä¼šç­‰å¾… t2æ¶ˆè´¹çº¿ç¨‹ï¼Œt2æ¶ˆè´¹åï¼Œt2å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…t1åœ¨å­˜å…¥ï¼Œä»è€Œå‘¨è€Œå¤å§‹ï¼Œå½¢æˆ ä¸€å­˜ä¸€å–çš„çŠ¶æ€</p><h2 id="6-é˜»å¡é˜Ÿåˆ—çš„ç”¨å¤„"><a href="#6-é˜»å¡é˜Ÿåˆ—çš„ç”¨å¤„" class="headerlink" title="6 é˜»å¡é˜Ÿåˆ—çš„ç”¨å¤„"></a>6 é˜»å¡é˜Ÿåˆ—çš„ç”¨å¤„</h2><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h3><p>ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹å…¶äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ªåŠ 1ï¼Œä¸€ä¸ªå‡1ï¼Œæ¥5è½®</p><p>å…³äºå¤šçº¿ç¨‹çš„æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦è®°ä½ä¸‹é¢å‡ å¥</p><ul><li>çº¿ç¨‹ æ“ä½œ èµ„æºç±»</li><li>åˆ¤æ–­ å¹²æ´» é€šçŸ¥</li><li>é˜²æ­¢è™šå‡å”¤é†’æœºåˆ¶</li></ul><p>æˆ‘ä»¬ä¸‹é¢å®ç°ä¸€ä¸ªç®€å•çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œé¦–å…ˆæœ‰èµ„æºç±»ShareData</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShareData</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;    <span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();    <span class="hljs-keyword">private</span> Condition condition = lock.newCondition();    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        <span class="hljs-comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span>        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number != <span class="hljs-number">0</span>) &#123;                <span class="hljs-comment">// ç­‰å¾…ä¸èƒ½ç”Ÿäº§</span>                condition.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            number++;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number);            <span class="hljs-comment">// é€šçŸ¥ å”¤é†’</span>            condition.signalAll();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        <span class="hljs-comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span>        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number == <span class="hljs-number">0</span>) &#123;                <span class="hljs-comment">// ç­‰å¾…ä¸èƒ½æ¶ˆè´¹</span>                condition.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            number--;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number);            <span class="hljs-comment">// é€šçŸ¥ å”¤é†’</span>            condition.signalAll();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;&#125;</code></pre></div><p>é‡Œé¢æœ‰ä¸€ä¸ªnumberå˜é‡ï¼ŒåŒæ—¶æä¾›äº†increment å’Œ decrementçš„æ–¹æ³•ï¼Œåˆ†åˆ«è®©number åŠ 1å’Œå‡1</p><p>ä½†æ˜¯æˆ‘ä»¬åœ¨è¿›è¡Œåˆ¤æ–­çš„æ—¶å€™ï¼Œä¸ºäº†é˜²æ­¢å‡ºç°è™šå‡å”¤é†’æœºåˆ¶ï¼Œä¸èƒ½ä½¿ç”¨ifæ¥è¿›è¡Œåˆ¤æ–­ï¼Œè€Œåº”è¯¥ä½¿ç”¨while</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ¤æ–­</span><span class="hljs-keyword">while</span>(number != <span class="hljs-number">0</span>) &#123;    <span class="hljs-comment">// ç­‰å¾…ä¸èƒ½ç”Ÿäº§</span>    condition.await();&#125;</code></pre></div><p>ä¸èƒ½ä½¿ç”¨ ifåˆ¤æ–­</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ¤æ–­</span><span class="hljs-keyword">if</span>(number != <span class="hljs-number">0</span>) &#123;    <span class="hljs-comment">// ç­‰å¾…ä¸èƒ½ç”Ÿäº§</span>    condition.await();&#125;</code></pre></div><p>å®Œæ•´ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”Ÿäº§è€…æ¶ˆè´¹è€… ä¼ ç»Ÿç‰ˆ</span><span class="hljs-comment"> * é¢˜ç›®ï¼šä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹å…¶äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ªåŠ 1ï¼Œä¸€ä¸ªå‡1ï¼Œæ¥5è½®</span><span class="hljs-comment"> */</span><span class="hljs-comment">/**</span><span class="hljs-comment"> * çº¿ç¨‹ æ“ä½œ èµ„æºç±»</span><span class="hljs-comment"> * åˆ¤æ–­ å¹²æ´» é€šçŸ¥</span><span class="hljs-comment"> * é˜²æ­¢è™šå‡å”¤é†’æœºåˆ¶</span><span class="hljs-comment"> */</span><span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShareData</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;    <span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();    <span class="hljs-keyword">private</span> Condition condition = lock.newCondition();    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        <span class="hljs-comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span>        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number != <span class="hljs-number">0</span>) &#123;                <span class="hljs-comment">// ç­‰å¾…ä¸èƒ½ç”Ÿäº§</span>                condition.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            number++;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number);            <span class="hljs-comment">// é€šçŸ¥ å”¤é†’</span>            condition.signalAll();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        <span class="hljs-comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span>        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number == <span class="hljs-number">0</span>) &#123;                <span class="hljs-comment">// ç­‰å¾…ä¸èƒ½æ¶ˆè´¹</span>                condition.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            number--;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number);            <span class="hljs-comment">// é€šçŸ¥ å”¤é†’</span>            condition.signalAll();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProdConsumerTraditionDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// é«˜å†…èšï¼Œä½è€¦åˆ    å†…èšæŒ‡çš„æ˜¯ï¼Œä¸€ä¸ªç©ºè°ƒï¼Œè‡ªèº«å¸¦æœ‰è°ƒèŠ‚æ¸©åº¦é«˜ä½çš„æ–¹æ³•</span>        ShareData shareData = <span class="hljs-keyword">new</span> ShareData();        <span class="hljs-comment">// t1çº¿ç¨‹ï¼Œç”Ÿäº§</span>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;                <span class="hljs-keyword">try</span> &#123;                    shareData.increment();                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                    e.printStackTrace();                &#125;            &#125;        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-comment">// t2çº¿ç¨‹ï¼Œæ¶ˆè´¹</span>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;                <span class="hljs-keyword">try</span> &#123;                    shareData.decrement();                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                    e.printStackTrace();                &#125;            &#125;        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();    &#125;&#125;</code></pre></div><p>æœ€åè¿è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬ä¸€ä¸ªè¿›è¡Œç”Ÿäº§ï¼Œä¸€ä¸ªè¿›è¡Œæ¶ˆè´¹</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">t1</span> <span class="hljs-number">1</span><span class="hljs-attribute">t2</span> <span class="hljs-number">0</span><span class="hljs-attribute">t1</span> <span class="hljs-number">1</span><span class="hljs-attribute">t2</span> <span class="hljs-number">0</span><span class="hljs-attribute">t1</span> <span class="hljs-number">1</span><span class="hljs-attribute">t2</span> <span class="hljs-number">0</span><span class="hljs-attribute">t1</span> <span class="hljs-number">1</span><span class="hljs-attribute">t2</span> <span class="hljs-number">0</span><span class="hljs-attribute">t1</span> <span class="hljs-number">1</span><span class="hljs-attribute">t2</span> <span class="hljs-number">0</span></code></pre></div><h2 id="7-ç”Ÿæˆè€…å’Œæ¶ˆè´¹è€…3-0"><a href="#7-ç”Ÿæˆè€…å’Œæ¶ˆè´¹è€…3-0" class="headerlink" title="7 ç”Ÿæˆè€…å’Œæ¶ˆè´¹è€…3.0"></a>7 ç”Ÿæˆè€…å’Œæ¶ˆè´¹è€…3.0</h2><p>åœ¨concurrentåŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»è‡ªå·±å»æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œåˆ™è¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„æ—¶é—´å¤æ‚åº¦</p><p>ç°åœ¨æˆ‘ä»¬ä½¿ç”¨æ–°ç‰ˆçš„é˜»å¡é˜Ÿåˆ—ç‰ˆç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä½¿ç”¨ï¼švolatileã€CASã€atomicIntegerã€BlockQueueã€çº¿ç¨‹äº¤äº’ã€åŸå­å¼•ç”¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”Ÿäº§è€…æ¶ˆè´¹è€…  é˜»å¡é˜Ÿåˆ—ç‰ˆ</span><span class="hljs-comment"> * ä½¿ç”¨ï¼švolatileã€CASã€atomicIntegerã€BlockQueueã€çº¿ç¨‹äº¤äº’ã€åŸå­å¼•ç”¨</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyResource</span> </span>&#123;    <span class="hljs-comment">// é»˜è®¤å¼€å¯ï¼Œè¿›è¡Œç”Ÿäº§æ¶ˆè´¹</span>    <span class="hljs-comment">// è¿™é‡Œç”¨åˆ°äº†volatileæ˜¯ä¸ºäº†ä¿æŒæ•°æ®çš„å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯å½“TLAGä¿®æ”¹æ—¶ï¼Œè¦é©¬ä¸Šé€šçŸ¥å…¶å®ƒçº¿ç¨‹è¿›è¡Œä¿®æ”¹</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">boolean</span> FLAG = <span class="hljs-keyword">true</span>;    <span class="hljs-comment">// ä½¿ç”¨åŸå­åŒ…è£…ç±»ï¼Œè€Œä¸ç”¨number++</span>    <span class="hljs-keyword">private</span> AtomicInteger atomicInteger = <span class="hljs-keyword">new</span> AtomicInteger();    <span class="hljs-comment">// è¿™é‡Œä¸èƒ½ä¸ºäº†æ»¡è¶³æ¡ä»¶ï¼Œè€Œå®ä¾‹åŒ–ä¸€ä¸ªå…·ä½“çš„SynchronousBlockingQueue</span>    BlockingQueue&lt;String&gt; blockingQueue = <span class="hljs-keyword">null</span>;    <span class="hljs-comment">// è€Œåº”è¯¥é‡‡ç”¨ä¾èµ–æ³¨å…¥é‡Œé¢çš„ï¼Œæ„é€ æ³¨å…¥æ–¹æ³•ä¼ å…¥</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyResource</span><span class="hljs-params">(BlockingQueue&lt;String&gt; blockingQueue)</span> </span>&#123;        <span class="hljs-keyword">this</span>.blockingQueue = blockingQueue;        <span class="hljs-comment">// æŸ¥è¯¢å‡ºä¼ å…¥çš„classæ˜¯ä»€ä¹ˆ</span>        System.out.println(blockingQueue.getClass().getName());    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç”Ÿäº§</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myProd</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        String data = <span class="hljs-keyword">null</span>;        <span class="hljs-keyword">boolean</span> retValue;        <span class="hljs-comment">// å¤šçº¿ç¨‹ç¯å¢ƒçš„åˆ¤æ–­ï¼Œä¸€å®šè¦ä½¿ç”¨whileè¿›è¡Œï¼Œé˜²æ­¢å‡ºç°è™šå‡å”¤é†’</span>        <span class="hljs-comment">// å½“FLAGä¸ºtrueçš„æ—¶å€™ï¼Œå¼€å§‹ç”Ÿäº§</span>        <span class="hljs-keyword">while</span>(FLAG) &#123;            data = atomicInteger.incrementAndGet() + <span class="hljs-string">&quot;&quot;</span>;            <span class="hljs-comment">// 2ç§’å­˜å…¥1ä¸ªdata</span>            retValue = blockingQueue.offer(data, <span class="hljs-number">2L</span>, TimeUnit.SECONDS);            <span class="hljs-keyword">if</span>(retValue) &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ’å…¥é˜Ÿåˆ—:&quot;</span> + data  + <span class="hljs-string">&quot;æˆåŠŸ&quot;</span> );            &#125; <span class="hljs-keyword">else</span> &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ’å…¥é˜Ÿåˆ—:&quot;</span> + data  + <span class="hljs-string">&quot;å¤±è´¥&quot;</span> );            &#125;            <span class="hljs-keyword">try</span> &#123;                TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t åœæ­¢ç”Ÿäº§ï¼Œè¡¨ç¤ºFLAG=falseï¼Œç”Ÿäº§ä»‹ç»&quot;</span>);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ¶ˆè´¹</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myConsumer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;        String retValue;        <span class="hljs-comment">// å¤šçº¿ç¨‹ç¯å¢ƒçš„åˆ¤æ–­ï¼Œä¸€å®šè¦ä½¿ç”¨whileè¿›è¡Œï¼Œé˜²æ­¢å‡ºç°è™šå‡å”¤é†’</span>        <span class="hljs-comment">// å½“FLAGä¸ºtrueçš„æ—¶å€™ï¼Œå¼€å§‹ç”Ÿäº§</span>        <span class="hljs-keyword">while</span>(FLAG) &#123;            <span class="hljs-comment">// 2ç§’å­˜å…¥1ä¸ªdata</span>            retValue = blockingQueue.poll(<span class="hljs-number">2L</span>, TimeUnit.SECONDS);            <span class="hljs-keyword">if</span>(retValue != <span class="hljs-keyword">null</span> &amp;&amp; retValue != <span class="hljs-string">&quot;&quot;</span>) &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ¶ˆè´¹é˜Ÿåˆ—:&quot;</span> + retValue  + <span class="hljs-string">&quot;æˆåŠŸ&quot;</span> );            &#125; <span class="hljs-keyword">else</span> &#123;                FLAG = <span class="hljs-keyword">false</span>;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ¶ˆè´¹å¤±è´¥ï¼Œé˜Ÿåˆ—ä¸­å·²ä¸ºç©ºï¼Œé€€å‡º&quot;</span> );                <span class="hljs-comment">// é€€å‡ºæ¶ˆè´¹é˜Ÿåˆ—</span>                <span class="hljs-keyword">return</span>;            &#125;        &#125;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åœæ­¢ç”Ÿäº§çš„åˆ¤æ–­</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">this</span>.FLAG = <span class="hljs-keyword">false</span>;    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProdConsumerBlockingQueueDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// ä¼ å…¥å…·ä½“çš„å®ç°ç±»ï¼Œ ArrayBlockingQueue</span>        MyResource myResource = <span class="hljs-keyword">new</span> MyResource(<span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="hljs-number">10</span>));        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç”Ÿäº§çº¿ç¨‹å¯åŠ¨&quot;</span>);            System.out.println(<span class="hljs-string">&quot;&quot;</span>);            System.out.println(<span class="hljs-string">&quot;&quot;</span>);            <span class="hljs-keyword">try</span> &#123;                myResource.myProd();                System.out.println(<span class="hljs-string">&quot;&quot;</span>);                System.out.println(<span class="hljs-string">&quot;&quot;</span>);            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                e.printStackTrace();            &#125;        &#125;, <span class="hljs-string">&quot;prod&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t æ¶ˆè´¹çº¿ç¨‹å¯åŠ¨&quot;</span>);            <span class="hljs-keyword">try</span> &#123;                myResource.myConsumer();            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                e.printStackTrace();            &#125;        &#125;, <span class="hljs-string">&quot;consumer&quot;</span>).start();        <span class="hljs-comment">// 5ç§’åï¼Œåœæ­¢ç”Ÿäº§å’Œæ¶ˆè´¹</span>        <span class="hljs-keyword">try</span> &#123;            TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        System.out.println(<span class="hljs-string">&quot;&quot;</span>);        System.out.println(<span class="hljs-string">&quot;&quot;</span>);        System.out.println(<span class="hljs-string">&quot;5ç§’ä¸­åï¼Œç”Ÿäº§å’Œæ¶ˆè´¹çº¿ç¨‹åœæ­¢ï¼Œçº¿ç¨‹ç»“æŸ&quot;</span>);        myResource.stop();    &#125;&#125;</code></pre></div><p>æœ€åè¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java">java.util.concurrent.ArrayBlockingQueueprod ç”Ÿäº§çº¿ç¨‹å¯åŠ¨consumer æ¶ˆè´¹çº¿ç¨‹å¯åŠ¨prod æ’å…¥é˜Ÿåˆ—:<span class="hljs-number">1</span>æˆåŠŸconsumer æ¶ˆè´¹é˜Ÿåˆ—:<span class="hljs-number">1</span>æˆåŠŸprod æ’å…¥é˜Ÿåˆ—:<span class="hljs-number">2</span>æˆåŠŸconsumer æ¶ˆè´¹é˜Ÿåˆ—:<span class="hljs-number">2</span>æˆåŠŸprod æ’å…¥é˜Ÿåˆ—:<span class="hljs-number">3</span>æˆåŠŸconsumer æ¶ˆè´¹é˜Ÿåˆ—:<span class="hljs-number">3</span>æˆåŠŸprod æ’å…¥é˜Ÿåˆ—:<span class="hljs-number">4</span>æˆåŠŸconsumer æ¶ˆè´¹é˜Ÿåˆ—:<span class="hljs-number">4</span>æˆåŠŸprod æ’å…¥é˜Ÿåˆ—:<span class="hljs-number">5</span>æˆåŠŸconsumer æ¶ˆè´¹é˜Ÿåˆ—:<span class="hljs-number">5</span>æˆåŠŸ<span class="hljs-number">5</span>ç§’ä¸­åï¼Œç”Ÿäº§å’Œæ¶ˆè´¹çº¿ç¨‹åœæ­¢ï¼Œçº¿ç¨‹ç»“æŸprod åœæ­¢ç”Ÿäº§ï¼Œè¡¨ç¤ºFLAG=<span class="hljs-keyword">false</span>ï¼Œç”Ÿäº§ä»‹ç»</code></pre></div><h1 id="ç¬¬9ç« -Synchronizedå’ŒLockçš„åŒºåˆ«"><a href="#ç¬¬9ç« -Synchronizedå’ŒLockçš„åŒºåˆ«" class="headerlink" title="ç¬¬9ç«  Synchronizedå’ŒLockçš„åŒºåˆ«"></a>ç¬¬9ç«  Synchronizedå’ŒLockçš„åŒºåˆ«</h1><h2 id="1-å‰è¨€-1"><a href="#1-å‰è¨€-1" class="headerlink" title="1 å‰è¨€"></a>1 å‰è¨€</h2><p>æ—©æœŸçš„æ—¶å€™æˆ‘ä»¬å¯¹çº¿ç¨‹çš„ä¸»è¦æ“ä½œä¸ºï¼š</p><ul><li>synchronized wait  notify</li></ul><p>ç„¶ååé¢å‡ºç°äº†æ›¿ä»£æ–¹æ¡ˆ</p><ul><li>lock await  signal</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317101210376.png" alt="image-20200317101210376"></p><h2 id="2-é—®é¢˜"><a href="#2-é—®é¢˜" class="headerlink" title="2 é—®é¢˜"></a>2 é—®é¢˜</h2><h3 id="synchronized-å’Œ-lock-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿç”¨æ–°çš„lockæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä¸¾ä¾‹è¯´æ˜"><a href="#synchronized-å’Œ-lock-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿç”¨æ–°çš„lockæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä¸¾ä¾‹è¯´æ˜" class="headerlink" title="synchronized å’Œ lock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿç”¨æ–°çš„lockæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä¸¾ä¾‹è¯´æ˜"></a>synchronized å’Œ lock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿç”¨æ–°çš„lockæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä¸¾ä¾‹è¯´æ˜</h3><ul><li>synchronized å’Œ lock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿç”¨æ–°çš„lockæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä¸¾ä¾‹è¯´æ˜</li></ul><p>1ï¼‰synchronizedå±äºJVMå±‚é¢ï¼Œå±äºjavaçš„å…³é”®å­—</p><ul><li>monitorenterï¼ˆåº•å±‚æ˜¯é€šè¿‡monitorå¯¹è±¡æ¥å®Œæˆï¼Œå…¶å®wait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–äºmonitorå¯¹è±¡ åªèƒ½åœ¨åŒæ­¥å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨ wait/ notifyç­‰æ–¹æ³•ï¼‰</li><li>Lockæ˜¯å…·ä½“ç±»ï¼ˆjava.util.concurrent.locks.Lockï¼‰æ˜¯apiå±‚é¢çš„é”</li></ul><p>2ï¼‰ä½¿ç”¨æ–¹æ³•ï¼š</p><ul><li><p>synchronizedï¼šä¸éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå½“synchronizedä»£ç æ‰§è¡Œåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®©çº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å ç”¨</p></li><li><p>ReentrantLockï¼šåˆ™éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œè‹¥æ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æ­»é”çš„ç°è±¡ï¼Œéœ€è¦lock() å’Œ unlock() é…ç½®try catchè¯­å¥æ¥å®Œæˆ</p></li></ul><p>3ï¼‰ç­‰å¾…æ˜¯å¦ä¸­æ–­</p><ul><li>synchronizedï¼šä¸å¯ä¸­æ–­ï¼Œé™¤éæŠ›å‡ºå¼‚å¸¸æˆ–è€…æ­£å¸¸è¿è¡Œå®Œæˆ</li><li>ReentrantLockï¼šå¯ä¸­æ–­ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶æ–¹æ³•<ul><li>è®¾ç½®è¶…æ—¶æ–¹æ³•ï¼Œtrylock(long timeout, TimeUnit unit)</li><li>lockInterrupible() æ”¾ä»£ç å—ä¸­ï¼Œè°ƒç”¨interrupt() æ–¹æ³•å¯ä»¥ä¸­æ–­</li></ul></li></ul><p>4ï¼‰åŠ é”æ˜¯å¦å…¬å¹³</p><ul><li>synchronizedï¼šéå…¬å¹³é”</li><li>ReentrantLockï¼šé»˜è®¤éå…¬å¹³é”ï¼Œæ„é€ å‡½æ•°å¯ä»¥ä¼ é€’booleanå€¼ï¼Œtrueä¸ºå…¬å¹³é”ï¼Œfalseä¸ºéå…¬å¹³é”</li></ul><p>5ï¼‰é”ç»‘å®šå¤šä¸ªæ¡ä»¶Condition</p><ul><li>synchronizedï¼šæ²¡æœ‰ï¼Œè¦ä¹ˆéšæœºï¼Œè¦ä¹ˆå…¨éƒ¨å”¤é†’</li><li>ReentrantLockï¼šç”¨æ¥å®ç°åˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ï¼Œå¯ä»¥ç²¾ç¡®å”¤é†’ï¼Œè€Œä¸æ˜¯åƒsynchronizedé‚£æ ·ï¼Œè¦ä¹ˆéšæœºï¼Œè¦ä¹ˆå…¨éƒ¨å”¤é†’</li></ul><h2 id="3-ä¸¾ä¾‹"><a href="#3-ä¸¾ä¾‹" class="headerlink" title="3 ä¸¾ä¾‹"></a>3 ä¸¾ä¾‹</h2><p>é’ˆå¯¹åˆšåˆšæåˆ°çš„åŒºåˆ«çš„ç¬¬5æ¡ï¼Œæˆ‘ä»¬æœ‰ä¸‹é¢è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯</p><div class="code-wrapper"><pre><code class="hljs java">é¢˜ç›®ï¼šå¤šçº¿ç¨‹ä¹‹é—´æŒ‰é¡ºåºè°ƒç”¨ï¼Œå®ç° A-&gt; B -&gt; C ä¸‰ä¸ªçº¿ç¨‹å¯åŠ¨ï¼Œè¦æ±‚å¦‚ä¸‹ï¼šAAæ‰“å°<span class="hljs-number">5</span>æ¬¡ï¼ŒBBæ‰“å°<span class="hljs-number">10</span>æ¬¡ï¼ŒCCæ‰“å°<span class="hljs-number">15</span>æ¬¡ç´§æ¥ç€AAæ‰“å°<span class="hljs-number">5</span>æ¬¡ï¼ŒBBæ‰“å°<span class="hljs-number">10</span>æ¬¡ï¼ŒCCæ‰“å°<span class="hljs-number">15</span>æ¬¡..æ¥<span class="hljs-number">10</span>è½®</code></pre></div><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œè¿™æ ·çš„åœºæ™¯åœ¨ä½¿ç”¨synchronizedæ¥å®Œæˆçš„è¯ï¼Œä¼šéå¸¸çš„å›°éš¾ï¼Œä½†æ˜¯ä½¿ç”¨lockå°±éå¸¸æ–¹ä¾¿äº†</p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªé“¾å¼å”¤é†’çš„æ“ä½œ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317105121435.png" alt="image-20200317105121435"></p><p>å½“Açº¿ç¨‹æ‰§è¡Œå®Œåï¼ŒBçº¿ç¨‹æ‰èƒ½æ‰§è¡Œï¼Œç„¶åBçº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼ŒCçº¿ç¨‹æ‰æ‰§è¡Œ</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªé‡å…¥é”</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªé‡å…¥é”</span><span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();</code></pre></div><p>ç„¶åå®šä¹‰ä¸‰ä¸ªæ¡ä»¶ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºé”çš„é’¥åŒ™ï¼Œé€šè¿‡å®ƒå°±å¯ä»¥è·å–åˆ°é”ï¼Œè¿›å…¥åˆ°æ–¹æ³•é‡Œé¢</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// è¿™ä¸‰ä¸ªç›¸å½“äºå¤‡ç”¨é’¥åŒ™</span><span class="hljs-keyword">private</span> Condition condition1 = lock.newCondition();<span class="hljs-keyword">private</span> Condition condition2 = lock.newCondition();<span class="hljs-keyword">private</span> Condition condition3 = lock.newCondition();</code></pre></div><p>ç„¶åå¼€å§‹è®°ä½é”çš„ä¸‰éƒ¨æ›²ï¼š åˆ¤æ–­   å¹²æ´»  å”¤é†’</p><p>è¿™é‡Œçš„åˆ¤æ–­ï¼Œä¸ºäº†é¿å…è™šå‡å”¤é†’ï¼Œä¸€å®šè¦é‡‡ç”¨  while</p><p>å¹²æ´»å°±æ˜¯æŠŠéœ€è¦çš„å†…å®¹ï¼Œæ‰“å°å‡ºæ¥</p><p>å”¤é†’çš„è¯ï¼Œå°±æ˜¯ä¿®æ”¹èµ„æºç±»çš„å€¼ï¼Œç„¶åç²¾å‡†å”¤é†’çº¿ç¨‹è¿›è¡Œå¹²æ´»ï¼šè¿™é‡ŒA å”¤é†’Bï¼Œ Bå”¤é†’Cï¼ŒCåˆå”¤é†’A</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print5</span><span class="hljs-params">()</span> </span>&#123;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        <span class="hljs-comment">// åˆ¤æ–­</span>        <span class="hljs-keyword">while</span>(number != <span class="hljs-number">1</span>) &#123;            <span class="hljs-comment">// ä¸ç­‰äº1ï¼Œéœ€è¦ç­‰å¾…</span>            condition1.await();        &#125;        <span class="hljs-comment">// å¹²æ´»</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number + <span class="hljs-string">&quot;\t&quot;</span> + i);        &#125;        <span class="hljs-comment">// å”¤é†’ ï¼ˆå¹²å®Œæ´»åï¼Œéœ€è¦é€šçŸ¥Bçº¿ç¨‹æ‰§è¡Œï¼‰</span>        number = <span class="hljs-number">2</span>;        <span class="hljs-comment">// é€šçŸ¥2å·å»å¹²æ´»äº†</span>        condition2.signal();    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;        e.printStackTrace();    &#125; <span class="hljs-keyword">finally</span> &#123;        lock.unlock();    &#125;</code></pre></div><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Synchronized å’Œ Lockçš„åŒºåˆ«</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShareResource</span> </span>&#123;    <span class="hljs-comment">// A 1   B 2   c 3</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">1</span>;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªé‡å…¥é”</span>    <span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();    <span class="hljs-comment">// è¿™ä¸‰ä¸ªç›¸å½“äºå¤‡ç”¨é’¥åŒ™</span>    <span class="hljs-keyword">private</span> Condition condition1 = lock.newCondition();    <span class="hljs-keyword">private</span> Condition condition2 = lock.newCondition();    <span class="hljs-keyword">private</span> Condition condition3 = lock.newCondition();    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print5</span><span class="hljs-params">()</span> </span>&#123;        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number != <span class="hljs-number">1</span>) &#123;                <span class="hljs-comment">// ä¸ç­‰äº1ï¼Œéœ€è¦ç­‰å¾…</span>                condition1.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number + <span class="hljs-string">&quot;\t&quot;</span> + i);            &#125;            <span class="hljs-comment">// å”¤é†’ ï¼ˆå¹²å®Œæ´»åï¼Œéœ€è¦é€šçŸ¥Bçº¿ç¨‹æ‰§è¡Œï¼‰</span>            number = <span class="hljs-number">2</span>;            <span class="hljs-comment">// é€šçŸ¥2å·å»å¹²æ´»äº†</span>            condition2.signal();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print10</span><span class="hljs-params">()</span> </span>&#123;        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number != <span class="hljs-number">2</span>) &#123;                <span class="hljs-comment">// ä¸ç­‰äº2ï¼Œéœ€è¦ç­‰å¾…</span>                condition2.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number + <span class="hljs-string">&quot;\t&quot;</span> + i);            &#125;            <span class="hljs-comment">// å”¤é†’ ï¼ˆå¹²å®Œæ´»åï¼Œéœ€è¦é€šçŸ¥Cçº¿ç¨‹æ‰§è¡Œï¼‰</span>            number = <span class="hljs-number">3</span>;            <span class="hljs-comment">// é€šçŸ¥2å·å»å¹²æ´»äº†</span>            condition3.signal();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print15</span><span class="hljs-params">()</span> </span>&#123;        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ¤æ–­</span>            <span class="hljs-keyword">while</span>(number != <span class="hljs-number">3</span>) &#123;                <span class="hljs-comment">// ä¸ç­‰äº3ï¼Œéœ€è¦ç­‰å¾…</span>                condition3.await();            &#125;            <span class="hljs-comment">// å¹²æ´»</span>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t &quot;</span> + number + <span class="hljs-string">&quot;\t&quot;</span> + i);            &#125;            <span class="hljs-comment">// å”¤é†’ ï¼ˆå¹²å®Œæ´»åï¼Œéœ€è¦é€šçŸ¥Cçº¿ç¨‹æ‰§è¡Œï¼‰</span>            number = <span class="hljs-number">1</span>;            <span class="hljs-comment">// é€šçŸ¥1å·å»å¹²æ´»äº†</span>            condition1.signal();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SyncAndReentrantLockDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        ShareResource shareResource = <span class="hljs-keyword">new</span> ShareResource();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;                    shareResource.print5();            &#125;        &#125;, <span class="hljs-string">&quot;A&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;                shareResource.print10();            &#125;        &#125;, <span class="hljs-string">&quot;B&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;                shareResource.print15();            &#125;        &#125;, <span class="hljs-string">&quot;C&quot;</span>).start();    &#125;&#125;</code></pre></div><h1 id="ç¬¬10ç« çº¿ç¨‹æ± "><a href="#ç¬¬10ç« çº¿ç¨‹æ± " class="headerlink" title="ç¬¬10ç« çº¿ç¨‹æ± "></a>ç¬¬10ç« çº¿ç¨‹æ± </h1><h2 id="1-å‰è¨€-2"><a href="#1-å‰è¨€-2" class="headerlink" title="1 å‰è¨€"></a>1 å‰è¨€</h2><p>è·å–å¤šçº¿ç¨‹çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æœ‰ä¸‰ç§ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯å®ç°Callableæ¥å£</p><ul><li>å®ç°Runnableæ¥å£</li><li>å®ç°Callableæ¥å£</li><li>å®ä¾‹åŒ–Threadç±»</li><li>ä½¿ç”¨çº¿ç¨‹æ± è·å–</li></ul><h2 id="2-Callableæ¥å£"><a href="#2-Callableæ¥å£" class="headerlink" title="2 Callableæ¥å£"></a>2 Callableæ¥å£</h2><p>Callableæ¥å£ï¼Œæ˜¯ä¸€ç§è®©çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œèƒ½å¤Ÿè¿”å›ç»“æœçš„</p><p>åœ¨è¯´åˆ°Callableæ¥å£çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æåˆ°Runnableæ¥å£</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å®ç°Runnableæ¥å£</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬çŸ¥é“ï¼Œå®ç°Runnableæ¥å£çš„æ—¶å€™ï¼Œéœ€è¦é‡å†™runæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨çš„æ–¹æ³•</p><p>åŒç†ï¼Œæˆ‘ä»¬å®ç°Callableæ¥å£ï¼Œä¹Ÿéœ€è¦å®ç°callæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦æœ‰è¿”å›å€¼ï¼Œè¿™ä¸ªCallableæ¥å£çš„åº”ç”¨åœºæ™¯ä¸€èˆ¬å°±åœ¨äºæ‰¹å¤„ç†ä¸šåŠ¡ï¼Œæ¯”å¦‚è½¬è´¦çš„æ—¶å€™ï¼Œéœ€è¦ç»™ä¸€ä¼šè¿”å›ç»“æœçš„çŠ¶æ€ç å›æ¥ï¼Œä»£è¡¨æœ¬æ¬¡æ“ä½œæˆåŠŸè¿˜æ˜¯å¤±è´¥</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Callableæœ‰è¿”å›å€¼</span><span class="hljs-comment"> * æ‰¹é‡å¤„ç†çš„æ—¶å€™ï¼Œéœ€è¦å¸¦è¿”å›å€¼çš„æ¥å£ï¼ˆä¾‹å¦‚æ”¯ä»˜å¤±è´¥çš„æ—¶å€™ï¼Œéœ€è¦è¿”å›é”™è¯¯çŠ¶æ€ï¼‰</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span>&lt;<span class="hljs-title">Integer</span>&gt; </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;come in Callable&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">1024</span>;    &#125;&#125;</code></pre></div><p>æœ€åæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯é€šè¿‡Threadçº¿ç¨‹ï¼Œ å°†MyThread2å®ç°Callableæ¥å£çš„ç±»åŒ…è£…èµ·æ¥</p><p>è¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ˜¯FutureTaskç±»ï¼Œä»–å®ç°äº†Runnableæ¥å£ï¼Œå¹¶ä¸”è¿˜éœ€è¦ä¼ é€’ä¸€ä¸ªå®ç°Callableæ¥å£çš„ç±»ä½œä¸ºæ„é€ å‡½æ•°</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// FutureTaskï¼šå®ç°äº†Runnableæ¥å£ï¼Œæ„é€ å‡½æ•°åˆéœ€è¦ä¼ å…¥ Callableæ¥å£</span><span class="hljs-comment">// è¿™é‡Œé€šè¿‡äº†FutureTaskæ¥è§¦äº†Callableæ¥å£</span>FutureTask&lt;Integer&gt; futureTask = <span class="hljs-keyword">new</span> FutureTask&lt;&gt;(<span class="hljs-keyword">new</span> MyThread2());</code></pre></div><p>ç„¶ååœ¨ç”¨Threadè¿›è¡Œå®ä¾‹åŒ–ï¼Œä¼ å…¥å®ç°Runnabnleæ¥å£çš„FutureTaskçš„ç±»</p><div class="code-wrapper"><pre><code class="hljs java">Thread t1 = <span class="hljs-keyword">new</span> Thread(futureTask, <span class="hljs-string">&quot;aaa&quot;</span>);t1.start();</code></pre></div><p>æœ€åé€šè¿‡ futureTask.get() è·å–åˆ°è¿”å›å€¼</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// è¾“å‡ºFutureTaskçš„è¿”å›å€¼</span>System.out.println(<span class="hljs-string">&quot;result FutureTask &quot;</span> + futureTask.get());</code></pre></div><p>è¿™å°±ç›¸å½“äºåŸæ¥æˆ‘ä»¬çš„æ–¹å¼æ˜¯mainæ–¹æ³•ä¸€æ¡é¾™ä¹‹å¿ƒï¼Œåé¢åœ¨å¼•å…¥Callableåï¼Œå¯¹äºæ‰§è¡Œæ¯”è¾ƒä¹…çš„çº¿ç¨‹ï¼Œå¯ä»¥å•ç‹¬æ–°å¼€ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œæœ€ååœ¨è¿›è¡Œæ±‡æ€»è¾“å‡º</p><p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ è¦æ±‚è·å¾—Callableçº¿ç¨‹çš„è®¡ç®—ç»“æœï¼Œå¦‚æœæ²¡æœ‰è®¡ç®—å®Œæˆå°±è¦å»å¼ºæ±‚ï¼Œä¼šå¯¼è‡´é˜»å¡ï¼Œç›´åˆ°è®¡ç®—å®Œæˆ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317152541284.png" alt="image-20200317152541284"></p><p>ä¹Ÿå°±æ˜¯è¯´ futureTask.get() éœ€è¦æ”¾åœ¨æœ€åæ‰§è¡Œï¼Œè¿™æ ·ä¸ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢ç®—æ³•ï¼Œä½¿ç”¨ç±»ä¼¼äºè‡ªæ—‹é”çš„æ–¹å¼æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¿è¡Œå®Œæ¯•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åˆ¤æ–­futureTaskæ˜¯å¦è®¡ç®—å®Œæˆ</span><span class="hljs-keyword">while</span>(!futureTask.isDone()) &#123;&#125;</code></pre></div><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ ä¸€ä¸ªFutureTaskçš„æ—¶å€™ï¼Œåªä¼šè®¡ç®—ä¸€æ¬¡</p><div class="code-wrapper"><pre><code class="hljs java">FutureTask&lt;Integer&gt; futureTask = <span class="hljs-keyword">new</span> FutureTask&lt;&gt;(<span class="hljs-keyword">new</span> MyThread2());<span class="hljs-comment">// å¼€å¯ä¸¤ä¸ªçº¿ç¨‹è®¡ç®—futureTask</span><span class="hljs-keyword">new</span> Thread(futureTask, <span class="hljs-string">&quot;AAA&quot;</span>).start();<span class="hljs-keyword">new</span> Thread(futureTask, <span class="hljs-string">&quot;BBB&quot;</span>).start();</code></pre></div><p>å¦‚æœæˆ‘ä»¬è¦ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¡ç®—ä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦è¿™æ ·å†™ï¼Œéœ€è¦å®šä¹‰ä¸¤ä¸ªfutureTask</p><div class="code-wrapper"><pre><code class="hljs java">FutureTask&lt;Integer&gt; futureTask = <span class="hljs-keyword">new</span> FutureTask&lt;&gt;(<span class="hljs-keyword">new</span> MyThread2());FutureTask&lt;Integer&gt; futureTask2 = <span class="hljs-keyword">new</span> FutureTask&lt;&gt;(<span class="hljs-keyword">new</span> MyThread2());<span class="hljs-comment">// å¼€å¯ä¸¤ä¸ªçº¿ç¨‹è®¡ç®—futureTask</span><span class="hljs-keyword">new</span> Thread(futureTask, <span class="hljs-string">&quot;AAA&quot;</span>).start();<span class="hljs-keyword">new</span> Thread(futureTask2, <span class="hljs-string">&quot;BBB&quot;</span>).start();</code></pre></div><h2 id="3-ThreadPoolExecutor"><a href="#3-ThreadPoolExecutor" class="headerlink" title="3 ThreadPoolExecutor"></a>3 ThreadPoolExecutor</h2><h3 id="3-1-ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± "><a href="#3-1-ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± " class="headerlink" title="3.1 ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± "></a>3.1 ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± </h3><p>çº¿ç¨‹æ± åšçš„ä¸»è¦å·¥ä½œå°±æ˜¯æ§åˆ¶è¿è¡Œçš„çº¿ç¨‹çš„æ•°é‡ï¼Œå¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°†ä»»åŠ¡æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åçº¿ç¨‹åˆ›å»ºåï¼Œå¯åŠ¨è¿™äº›ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æœ€å¤§æ•°é‡çš„çº¿ç¨‹æ’é˜Ÿç­‰å€™ï¼Œç­‰å…¶å®ƒçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚</p><p>å®ƒçš„ä¸»è¦ç‰¹ç‚¹ä¸ºï¼šçº¿ç¨‹å¤ç”¨ã€æ§åˆ¶æœ€å¤§å¹¶å‘æ•°ã€ç®¡ç†çº¿ç¨‹</p><p>çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ˜¯æ”¾å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­çš„</p><h3 id="3-2-çº¿ç¨‹æ± çš„å¥½å¤„"><a href="#3-2-çº¿ç¨‹æ± çš„å¥½å¤„" class="headerlink" title="3.2 çº¿ç¨‹æ± çš„å¥½å¤„"></a>3.2 çº¿ç¨‹æ± çš„å¥½å¤„</h3><p>å¤šæ ¸å¤„ç†çš„å¥½å¤„æ˜¯ï¼šçœç•¥çš„ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å¼€é”€</p><p>åŸæ¥æˆ‘ä»¬å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨ newå…³é”®å­—è¿›è¡Œåˆ›å»ºï¼Œåˆ°äº†Springåï¼Œæˆ‘ä»¬å­¦äº†IOCä¾èµ–æ³¨å…¥ï¼Œå‘ç°Springå¸®æˆ‘ä»¬å°†å¯¹è±¡å·²ç»åŠ è½½åˆ°äº†Springå®¹å™¨ä¸­ï¼Œåªéœ€è¦é€šè¿‡@Autowriteæ³¨è§£ï¼Œå°±èƒ½å¤Ÿè‡ªåŠ¨æ³¨å…¥ï¼Œä»è€Œä½¿ç”¨</p><p>å› æ­¤ä½¿ç”¨å¤šçº¿ç¨‹æœ‰ä¸‹åˆ—çš„å¥½å¤„</p><ul><li>é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œé™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—</li><li>æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±ç«‹å³æ‰§è¡Œ</li><li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— çº¿åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§</li></ul><h3 id="3-3-æ¶æ„è¯´æ˜"><a href="#3-3-æ¶æ„è¯´æ˜" class="headerlink" title="3.3 æ¶æ„è¯´æ˜"></a>3.3 æ¶æ„è¯´æ˜</h3><p>Javaä¸­çº¿ç¨‹æ± æ˜¯é€šè¿‡Executoræ¡†æ¶å®ç°çš„ï¼Œè¯¥æ¡†æ¶ä¸­ç”¨åˆ°äº†Executorï¼ŒExecutorsï¼ˆä»£è¡¨å·¥å…·ç±»ï¼‰ï¼ŒExecutorServiceï¼ŒThreadPoolExecutorè¿™å‡ ä¸ªç±»ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317175202647.png" alt="image-20200317175202647"></p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317175241007.png" alt="image-20200317175241007"></p><h3 id="3-4-åˆ›å»ºçº¿ç¨‹æ± "><a href="#3-4-åˆ›å»ºçº¿ç¨‹æ± " class="headerlink" title="3.4 åˆ›å»ºçº¿ç¨‹æ± "></a>3.4 åˆ›å»ºçº¿ç¨‹æ± </h3><ul><li>Executors.newFixedThreadPool(int i) ï¼šåˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ i ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± <ul><li>æ‰§è¡Œé•¿æœŸçš„ä»»åŠ¡ï¼Œæ€§èƒ½å¥½å¾ˆå¤š</li><li>åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹æ•°æœ€å¤§å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…</li></ul></li><li>Executors.newSingleThreadExecutorï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰1ä¸ªçº¿ç¨‹çš„ å•çº¿ç¨‹æ± <ul><li>ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„åœºæ™¯</li><li>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåºæ‰§è¡Œ</li></ul></li><li>Executors.newCacheThreadPool();  åˆ›å»ºä¸€ä¸ªå¯æ‰©å®¹çš„çº¿ç¨‹æ± <ul><li>æ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥çš„å°ç¨‹åºæˆ–è€…è´Ÿè½½æ•™è½»çš„æœåŠ¡å™¨</li><li>åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºæ–°çº¿ç¨‹</li></ul></li><li>Executors.newScheduledThreadPool(int corePoolSize)ï¼šçº¿ç¨‹æ± æ”¯æŒå®šæ—¶ä»¥åŠå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªcorePoolSizeä¸ºä¼ å…¥å‚æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºæ•´å½¢çš„æœ€å¤§æ•°çš„çº¿ç¨‹æ± </li></ul><p>å…·ä½“ä½¿ç”¨ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨Executorså·¥å…·ç±»ï¼Œè¿›è¡Œåˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ‹¥æœ‰5ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// ä¸€æ± 5ä¸ªå¤„ç†çº¿ç¨‹ï¼ˆç”¨æ± åŒ–æŠ€æœ¯ï¼Œä¸€å®šè¦è®°å¾—å…³é—­ï¼‰</span>ExecutorService threadPool = Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </span>ExecutorService threadPool = Executors.newSingleThreadExecutor();<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰Nä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œæ ¹æ®è°ƒåº¦åˆ›å»ºåˆé€‚çš„çº¿ç¨‹</span>ExecutorService threadPool = Executors.newCacheThreadPool();</code></pre></div><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„çš„åº”ç”¨åœºæ™¯</p><div class="code-wrapper"><pre><code class="hljs plain">æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥åŠç†ä¸šåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·å°±æ˜¯ä¸€ä¸ªæ¥è‡ªå¤–éƒ¨è¯·æ±‚çº¿ç¨‹</code></pre></div><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ threadPool.executeæ‰§è¡Œä¸šåŠ¡ï¼Œexecuteéœ€è¦ä¼ å…¥ä¸€ä¸ªå®ç°äº†Runnableæ¥å£çš„çº¿ç¨‹</p><div class="code-wrapper"><pre><code class="hljs java">threadPool.execute(() -&gt; &#123;System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç»™ç”¨æˆ·åŠç†ä¸šåŠ¡&quot;</span>);&#125;);</code></pre></div><p>ç„¶åæˆ‘ä»¬ä½¿ç”¨å®Œæ¯•åå…³é—­çº¿ç¨‹æ± </p><div class="code-wrapper"><pre><code class="hljs java">threadPool.shutdown();</code></pre></div><p>å®Œæ•´ä»£ç ä¸ºï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ç¬¬å››ç§è·å– / ä½¿ç”¨ Javaå¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œé€šè¿‡çº¿ç¨‹æ± </span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThreadPoolDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// Array  Arrays(è¾…åŠ©å·¥å…·ç±»)</span>        <span class="hljs-comment">// Collection Collections(è¾…åŠ©å·¥å…·ç±»)</span>        <span class="hljs-comment">// Executor Executors(è¾…åŠ©å·¥å…·ç±»)</span>        <span class="hljs-comment">// ä¸€æ± 5ä¸ªå¤„ç†çº¿ç¨‹ï¼ˆç”¨æ± åŒ–æŠ€æœ¯ï¼Œä¸€å®šè¦è®°å¾—å…³é—­ï¼‰</span>        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="hljs-number">5</span>);        <span class="hljs-comment">// æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥åŠç†ä¸šåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·å°±æ˜¯ä¸€ä¸ªæ¥è‡ªå¤–éƒ¨è¯·æ±‚çº¿ç¨‹</span>        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// å¾ªç¯åæ¬¡ï¼Œæ¨¡æ‹Ÿä¸šåŠ¡åŠç†ï¼Œè®©5ä¸ªçº¿ç¨‹å¤„ç†è¿™10ä¸ªè¯·æ±‚</span>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;                threadPool.execute(() -&gt; &#123;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç»™ç”¨æˆ·:&quot;</span> + tempInt + <span class="hljs-string">&quot; åŠç†ä¸šåŠ¡&quot;</span>);                &#125;);            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            threadPool.shutdown();        &#125;    &#125;&#125;</code></pre></div><p>æœ€åç»“æœï¼š</p><div class="code-wrapper"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">0</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">4</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">5</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">3</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">1</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">2</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">9</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">8</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">7</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">6</span> åŠç†ä¸šåŠ¡</code></pre></div><p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œä¸€å…±æœ‰5ä¸ªçº¿ç¨‹ï¼Œåœ¨ç»™10ä¸ªç”¨æˆ·åŠç†ä¸šåŠ¡</p><h3 id="3-5-åˆ›å»ºå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± "><a href="#3-5-åˆ›å»ºå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± " class="headerlink" title="3.5  åˆ›å»ºå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± "></a>3.5  åˆ›å»ºå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± </h3><p>Executors.newScheduledThreadPool(int corePoolSize)ï¼š</p><p><strong>çº¿ç¨‹æ± æ”¯æŒå®šæ—¶ä»¥åŠå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªcorePoolSizeä¸ºä¼ å…¥å‚æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºæ•´å½¢çš„æœ€å¤§æ•°çš„çº¿ç¨‹æ± </strong></p><p>åº•å±‚ä½¿ç”¨ ScheduledThreadPoolExecutor æ¥å®ç° ScheduledThreadPoolExecutor ä¸ºThreadPoolExecutorå­ç±»</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize)</span> </span>&#123;        <span class="hljs-keyword">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="hljs-number">0</span>, NANOSECONDS,              <span class="hljs-keyword">new</span> DelayedWorkQueue());&#125;</code></pre></div><h4 id="æ‰§è¡Œæ–¹æ³•"><a href="#æ‰§è¡Œæ–¹æ³•" class="headerlink" title="æ‰§è¡Œæ–¹æ³•"></a>æ‰§è¡Œæ–¹æ³•</h4><div class="code-wrapper"><pre><code class="hljs java">  <span class="hljs-comment">/**</span><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">   * commandï¼šæ‰§è¡Œçš„ä»»åŠ¡ Callableæˆ–Runnableæ¥å£å®ç°ç±»</span><span class="hljs-comment">* delayï¼šå»¶æ—¶æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´</span><span class="hljs-comment">* unitï¼šå»¶è¿Ÿæ—¶é—´å•ä½</span><span class="hljs-comment">   */</span>  <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command,                                     <span class="hljs-keyword">long</span> delay,                                     TimeUnit unit)</code></pre></div><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException   &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">     * commandï¼šæ‰§è¡Œçš„ä»»åŠ¡ Callableæˆ–Runnableæ¥å£å®ç°ç±»</span><span class="hljs-comment"> * initialDelay ç¬¬ä¸€æ¬¡æ‰§è¡Œä»»åŠ¡å»¶è¿Ÿæ—¶é—´</span><span class="hljs-comment"> * period è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„å‘¨æœŸï¼Œä»ä¸Šä¸€ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œæ—¶è®¡ç®—å»¶è¿Ÿå¤šå°‘å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯è¿˜ä¼šç­‰ä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸä¹‹åã€‚</span><span class="hljs-comment"> * unitï¼šå»¶è¿Ÿæ—¶é—´å•ä½</span><span class="hljs-comment">     */</span><span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, <span class="hljs-keyword">long</span> initialDelay, <span class="hljs-keyword">long</span> period, TimeUnit unit)</code></pre></div><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException   &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><span class="hljs-comment">     * commandï¼šæ‰§è¡Œçš„ä»»åŠ¡ Callableæˆ–Runnableæ¥å£å®ç°ç±»</span><span class="hljs-comment"> * initialDelay ç¬¬ä¸€æ¬¡æ‰§è¡Œä»»åŠ¡å»¶è¿Ÿæ—¶é—´</span><span class="hljs-comment"> * delayï¼šè¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„å‘¨æœŸï¼Œä»ä¸Šä¸€ä¸ªä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆæ—¶è®¡ç®—å»¶è¿Ÿå¤šå°‘å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</span><span class="hljs-comment"> * unitï¼šå»¶è¿Ÿæ—¶é—´å•ä½</span><span class="hljs-comment">     */</span><span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="hljs-keyword">long</span> initialDelay, <span class="hljs-keyword">long</span> delay, TimeUnit unit)</code></pre></div><h2 id="4-åº•å±‚å®ç°"><a href="#4-åº•å±‚å®ç°" class="headerlink" title="4 åº•å±‚å®ç°"></a>4 åº•å±‚å®ç°</h2><p>æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹æºç ï¼Œç‚¹å‡»äº†Executors.newSingleThreadExecutor å’Œ Executors.newFixedThreadPoolèƒ½å¤Ÿå‘ç°åº•å±‚éƒ½æ˜¯ä½¿ç”¨äº†ThreadPoolExecutor</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317182004293.png" alt="image-20200317182004293"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çº¿ç¨‹æ± çš„å†…éƒ¨ï¼Œè¿˜ä½¿ç”¨åˆ°äº†LinkedBlockingQueue é“¾è¡¨é˜»å¡é˜Ÿåˆ—</p><p>åŒæ—¶åœ¨æŸ¥çœ‹Executors.newCacheThreadPool çœ‹åˆ°åº•å±‚ç”¨çš„æ˜¯ SynchronousBlockingQueueé˜»å¡é˜Ÿåˆ—</p><p>æœ€åæŸ¥çœ‹ä¸€ä¸‹ï¼Œå®Œæ•´çš„ä¸‰ä¸ªåˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317183202992.png" alt="image-20200317183202992"></p><h2 id="5-çº¿ç¨‹æ± çš„é‡è¦å‚æ•°"><a href="#5-çº¿ç¨‹æ± çš„é‡è¦å‚æ•°" class="headerlink" title="5 çº¿ç¨‹æ± çš„é‡è¦å‚æ•°"></a>5 çº¿ç¨‹æ± çš„é‡è¦å‚æ•°</h2><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317183600957.png" alt="image-20200317183600957"></p><p>çº¿ç¨‹æ± åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œä¸€å…±æœ‰7å¤§å‚æ•°</p><ul><li>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­çš„å¸¸é©»æ ¸å¿ƒçº¿ç¨‹æ•°<ul><li>åœ¨åˆ›å»ºçº¿ç¨‹æ± åï¼Œå½“æœ‰è¯·æ±‚ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šå®‰æ’æ± ä¸­çš„çº¿ç¨‹å»æ‰§è¡Œè¯·æ±‚ä»»åŠ¡ï¼Œè¿‘ä¼¼ç†è§£ä¸ºä»Šæ—¥å½“å€¼çº¿ç¨‹</li><li>å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°corePoolSizeåï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„é˜Ÿåˆ—æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­</li></ul></li><li>maximumPoolSizeï¼šçº¿ç¨‹æ± èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ­¤å€¼å¿…é¡»å¤§äºç­‰äº1ã€<ul><li>ç›¸å½“æœ‰æ‰©å®¹åçš„çº¿ç¨‹æ•°ï¼Œè¿™ä¸ªçº¿ç¨‹æ± èƒ½å®¹çº³çš„æœ€å¤šçº¿ç¨‹æ•°</li></ul></li><li>keepAliveTimeï¼šå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´<ul><li>å½“çº¿ç¨‹æ± æ•°é‡è¶…è¿‡corePoolSizeæ—¶ï¼Œå½“ç©ºé—²æ—¶é—´è¾¾åˆ°keepAliveTimeå€¼æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹ä¼šè¢«é”€æ¯ï¼Œç›´åˆ°åªå‰©ä¸‹corePoolSizeä¸ªçº¿ç¨‹ä¸ºæ­¢</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶ï¼ŒkeepAliveTimeæ‰ä¼šèµ·ä½œç”¨</li></ul></li><li>unitï¼škeepAliveTimeçš„å•ä½</li><li>workQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æäº¤çš„ä½†æœªè¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆç±»ä¼¼äºé“¶è¡Œé‡Œé¢çš„å€™å®¢åŒºï¼‰<ul><li>LinkedBlockingQueueï¼šé“¾è¡¨é˜»å¡é˜Ÿåˆ—</li><li>SynchronousBlockingQueueï¼šåŒæ­¥é˜»å¡é˜Ÿåˆ—</li></ul></li><li>threadFactoryï¼šè¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹æ±  ä¸€èˆ¬ç”¨é»˜è®¤å³å¯</li><li>handlerï¼šæ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ˆmaximumPoolSize3ï¼‰æ—¶ï¼Œå¦‚ä½•æ¥æ‹’ç»è¯·æ±‚æ‰§è¡Œçš„Runnableçš„ç­–ç•¥</li></ul><p>å½“è¥ä¸šçª—å£å’Œé˜»å¡é˜Ÿåˆ—ä¸­éƒ½æ»¡äº†æ—¶å€™ï¼Œå°±éœ€è¦è®¾ç½®æ‹’ç»ç­–ç•¥</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200317201150197.png" alt="image-20200317201150197"></p><h2 id="6-æ‹’ç»ç­–ç•¥"><a href="#6-æ‹’ç»ç­–ç•¥" class="headerlink" title="6 æ‹’ç»ç­–ç•¥"></a>6 æ‹’ç»ç­–ç•¥</h2><p>ä»¥ä¸‹æ‰€æœ‰æ‹’ç»ç­–ç•¥éƒ½å®ç°äº†RejectedExecutionHandleræ¥å£</p><ul><li>AbortPolicyï¼šé»˜è®¤ï¼Œç›´æ¥æŠ›å‡ºRejectedExcutionExceptionå¼‚å¸¸ï¼Œé˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</li><li>DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè¿è¡Œä»»åŠ¡ä¸¢å¤±ï¼Œè¿™æ˜¯ä¸€ç§å¥½æ–¹æ¡ˆ</li><li>CallerRunsPolicyï¼šè¯¥ç­–ç•¥æ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…</li><li>DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ï¼Œç„¶åæŠŠå½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡</li></ul><h2 id="7-çº¿ç¨‹æ± åº•å±‚å·¥ä½œåŸç†"><a href="#7-çº¿ç¨‹æ± åº•å±‚å·¥ä½œåŸç†" class="headerlink" title="7 çº¿ç¨‹æ± åº•å±‚å·¥ä½œåŸç†"></a>7 çº¿ç¨‹æ± åº•å±‚å·¥ä½œåŸç†</h2><h3 id="çº¿ç¨‹æ± è¿è¡Œæ¶æ„å›¾"><a href="#çº¿ç¨‹æ± è¿è¡Œæ¶æ„å›¾" class="headerlink" title="çº¿ç¨‹æ± è¿è¡Œæ¶æ„å›¾"></a>çº¿ç¨‹æ± è¿è¡Œæ¶æ„å›¾</h3><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318154414717.png" alt="image-20200318154414717"></p><p>æ–‡å­—è¯´æ˜</p><ol><li><p>åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œç­‰å¾…æäº¤è¿‡æ¥çš„ä»»åŠ¡è¯·æ±‚</p></li><li><p>å½“è°ƒç”¨execute()æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå‡ºå¦‚ä¸‹åˆ¤æ–­</p><ol><li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ± æ•°é‡å°äºcorePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡</li><li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºcorePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—</li><li>å¦‚æœè¿™æ—¶å€™é˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äºmaximumPoolSizeï¼Œé‚£ä¹ˆè¿˜æ˜¯åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹likeè¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›</li><li>å¦‚æœé˜Ÿåˆ—æ»¡äº†å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºmaximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œæ‹’ç»ç­–ç•¥æ¥æ‰§è¡Œ</li></ol></li><li><p>å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ</p></li><li><p>å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšæ“ä½œä¸€å®šçš„æ—¶é—´(keepAliveTime)æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼š</p><ol><li>å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰</li><li>æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒä¼šæœ€ç»ˆæ”¶ç¼©åˆ°corePoolSizeçš„å¤§å°</li></ol></li></ol><p>ä»¥é¡¾å®¢å»é“¶è¡ŒåŠç†ä¸šåŠ¡ä¸ºä¾‹ï¼Œè°ˆè°ˆçº¿ç¨‹æ± çš„åº•å±‚å·¥ä½œåŸç†</p><ol><li>æœ€å¼€å§‹å‡è®¾æ¥äº†ä¸¤ä¸ªé¡¾å®¢ï¼Œå› ä¸ºcorePoolSizeä¸º2ï¼Œå› æ­¤è¿™ä¸¤ä¸ªé¡¾å®¢ç›´æ¥èƒ½å¤Ÿå»çª—å£åŠç†</li><li>åé¢åˆæ¥äº†ä¸‰ä¸ªé¡¾å®¢ï¼Œå› ä¸ºcorePoolå·²ç»è¢«é¡¾å®¢å ç”¨äº†ï¼Œå› æ­¤åªæœ‰å»å€™å®¢åŒºï¼Œä¹Ÿå°±æ˜¯é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…</li><li>åé¢çš„äººåˆé™†é™†ç»­ç»­æ¥äº†ï¼Œå€™å®¢åŒºå¯èƒ½ä¸å¤Ÿç”¨äº†ï¼Œå› æ­¤éœ€è¦ç”³è¯·å¢åŠ å¤„ç†è¯·æ±‚çš„çª—å£ï¼Œè¿™é‡Œçš„çª—å£æŒ‡çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œä»¥æ­¤æ¥è§£å†³çº¿ç¨‹ä¸å¤Ÿç”¨çš„é—®é¢˜</li><li>å‡è®¾å—ç†çª—å£å·²ç»è¾¾åˆ°æœ€å¤§æ•°ï¼Œå¹¶ä¸”è¯·æ±‚æ•°è¿˜æ˜¯ä¸æ–­é€’å¢ï¼Œæ­¤æ—¶å€™å®¢åŒºå’Œçº¿ç¨‹æ± éƒ½å·²ç»æ»¡äº†ï¼Œä¸ºäº†é˜²æ­¢å¤§é‡è¯·æ±‚å†²å®çº¿ç¨‹æ± ï¼Œå·²ç»éœ€è¦å¼€å¯æ‹’ç»ç­–ç•¥</li><li>ä¸´æ—¶å¢åŠ çš„çº¿ç¨‹ä¼šå› ä¸ºè¶…è¿‡äº†æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå°±ä¼šé”€æ¯ï¼Œæœ€åä»æœ€å¤§æ•°å‰Šå‡åˆ°æ ¸å¿ƒæ•°</li></ol><h2 id="8-ä¸ºä»€ä¹ˆä¸ç”¨é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Ÿ"><a href="#8-ä¸ºä»€ä¹ˆä¸ç”¨é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="8 ä¸ºä»€ä¹ˆä¸ç”¨é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Ÿ"></a>8 ä¸ºä»€ä¹ˆä¸ç”¨é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Ÿ</h2><p>çº¿ç¨‹æ± åˆ›å»ºçš„æ–¹æ³•æœ‰ï¼šå›ºå®šæ•°çš„ï¼Œå•ä¸€çš„ï¼Œå¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”è¯¥ä½¿ç”¨å“ªä¸ªï¼Ÿ</p><p>æˆ‘ä»¬ä¸€ä¸ªéƒ½ä¸ç”¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯ä½¿ç”¨è‡ªå·±è‡ªå®šä¹‰çš„</p><p>ä¸ºä»€ä¹ˆä¸ç”¨ Executors ä¸­JDKæä¾›çš„ï¼Ÿ</p><p>æ ¹æ®é˜¿é‡Œå·´å·´æ‰‹å†Œï¼šå¹¶å‘æ§åˆ¶è¿™ç« </p><ul><li>çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹<ul><li>ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ï¼Œå¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜</li></ul></li><li>çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨Executorså»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©<ul><li>Executorsè¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡å¼Šç«¯å¦‚ä¸‹ï¼š<ul><li>FixedThreadPoolå’ŒSingleThreadPoolï¼š<ul><li>è¿è¡Œçš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºï¼šInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOM</li></ul></li><li>CacheThreadPoolå’ŒScheduledThreadPool<ul><li>è¿è¡Œçš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºï¼šInteger.MAX_VALUEï¼Œçº¿ç¨‹æ•°ä¸Šé™å¤ªå¤§å¯¼è‡´oom</li></ul></li></ul></li></ul></li></ul><h2 id="9-æ‰‹å†™çº¿ç¨‹æ± "><a href="#9-æ‰‹å†™çº¿ç¨‹æ± " class="headerlink" title="9 æ‰‹å†™çº¿ç¨‹æ± "></a>9 æ‰‹å†™çº¿ç¨‹æ± </h2><h3 id="9-1-é‡‡ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥"><a href="#9-1-é‡‡ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥" class="headerlink" title="9.1 é‡‡ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥"></a>9.1 é‡‡ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥</h3><p>ä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œå› ä¸ºé»˜è®¤çš„Executorsåˆ›å»ºçš„çº¿ç¨‹æ± ï¼Œåº•å±‚éƒ½æ˜¯ä½¿ç”¨LinkBlockingQueueä½œä¸ºé˜»å¡é˜Ÿåˆ—çš„ï¼Œè€ŒLinkBlockingQueueè™½ç„¶æ˜¯æœ‰ç•Œçš„ï¼Œä½†æ˜¯å®ƒçš„ç•Œé™æ˜¯ Integer.MAX_VALUE å¤§æ¦‚æœ‰20å¤šäº¿ï¼Œå¯ä»¥ç›¸å½“æ˜¯æ— ç•Œçš„äº†ï¼Œå› æ­¤æˆ‘ä»¬è¦ä½¿ç”¨ThreadPoolExecutorè‡ªå·±æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œç„¶åæŒ‡å®šé˜»å¡é˜Ÿåˆ—çš„å¤§å°</p><p>ä¸‹é¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º2ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º5ï¼Œå¹¶ä¸”é˜»å¡é˜Ÿåˆ—æ•°ä¸º3çš„çº¿ç¨‹æ± </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ‰‹å†™çº¿ç¨‹æ± </span><span class="hljs-keyword">final</span> Integer corePoolSize = <span class="hljs-number">2</span>;<span class="hljs-keyword">final</span> Integer maximumPoolSize = <span class="hljs-number">5</span>;<span class="hljs-keyword">final</span> Long keepAliveTime = <span class="hljs-number">1L</span>;<span class="hljs-comment">// è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œåªæ”¹å˜äº†LinkBlockingQueueçš„é˜Ÿåˆ—å¤§å°</span>ExecutorService executorService = <span class="hljs-keyword">new</span> ThreadPoolExecutor(    corePoolSize,    maximumPoolSize,    keepAliveTime,    TimeUnit.SECONDS,    <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="hljs-number">3</span>),    Executors.defaultThreadFactory(),    <span class="hljs-keyword">new</span> ThreadPoolExecutor.AbortPolicy());</code></pre></div><p>ç„¶åä½¿ç”¨forå¾ªç¯ï¼Œæ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥è¿›è¡Œè¯·æ±‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥åŠç†ä¸šåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·å°±æ˜¯ä¸€ä¸ªæ¥è‡ªå¤–éƒ¨è¯·æ±‚çº¿ç¨‹</span><span class="hljs-keyword">try</span> &#123;    <span class="hljs-comment">// å¾ªç¯åæ¬¡ï¼Œæ¨¡æ‹Ÿä¸šåŠ¡åŠç†ï¼Œè®©5ä¸ªçº¿ç¨‹å¤„ç†è¿™10ä¸ªè¯·æ±‚</span>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> tempInt = i;        executorService.execute(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t ç»™ç”¨æˆ·:&quot;</span> + tempInt + <span class="hljs-string">&quot; åŠç†ä¸šåŠ¡&quot;</span>);        &#125;);    &#125;&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;    e.printStackTrace();&#125; <span class="hljs-keyword">finally</span> &#123;    executorService.shutdown();&#125;</code></pre></div><p>ä½†æ˜¯åœ¨ç”¨æˆ·æ‰§è¡Œåˆ°ç¬¬ä¹ä¸ªçš„æ—¶å€™ï¼Œè§¦å‘äº†å¼‚å¸¸ï¼Œç¨‹åºä¸­æ–­</p><div class="code-wrapper"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">0</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">6</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">5</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">1</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">4</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">7</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">2</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">3</span> åŠç†ä¸šåŠ¡java.util.concurrent.RejectedExecutionException: Task com.moxi.interview.study.thread.MyThreadPoolDemo$$Lambda$<span class="hljs-number">1</span>/<span class="hljs-number">1747585824</span>@4dd8dc3 rejected from java.util.concurrent.ThreadPoolExecutor@6d03e736[Running, pool size = <span class="hljs-number">5</span>, active threads = <span class="hljs-number">3</span>, queued tasks = <span class="hljs-number">0</span>, completed tasks = <span class="hljs-number">5</span>]at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:<span class="hljs-number">2047</span>)at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:<span class="hljs-number">823</span>)at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:<span class="hljs-number">1369</span>)at com.moxi.interview.study.thread.MyThreadPoolDemo.main(MyThreadPoolDemo.java:<span class="hljs-number">34</span>)</code></pre></div><p>è¿™æ˜¯å› ä¸ºè§¦å‘äº†æ‹’ç»ç­–ç•¥ï¼Œè€Œæˆ‘ä»¬è®¾ç½®çš„æ‹’ç»ç­–ç•¥æ˜¯é»˜è®¤çš„AbortPolicyï¼Œä¹Ÿå°±æ˜¯æŠ›å¼‚å¸¸çš„</p><p>è§¦å‘æ¡ä»¶æ˜¯ï¼Œè¯·æ±‚çš„çº¿ç¨‹å¤§äº é˜»å¡é˜Ÿåˆ—å¤§å° + æœ€å¤§çº¿ç¨‹æ•° = 8 çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬9ä¸ªçº¿ç¨‹æ¥è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ—¶ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ä»è€ŒæŠ¥é”™é€€å‡ºã€‚</p><h3 id="9-2-é‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥"><a href="#9-2-é‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥" class="headerlink" title="9.2 é‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥"></a>9.2 é‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥</h3><p>å½“æˆ‘ä»¬æ›´å¥½å…¶å®ƒçš„æ‹’ç»ç­–ç•¥æ—¶ï¼Œé‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥ï¼Œä¹Ÿç§°ä¸ºå›é€€ç­–ç•¥ï¼Œå°±æ˜¯æŠŠä»»åŠ¡ä¸¢å›åŸæ¥çš„è¯·æ±‚å¼€å¯çº¿ç¨‹ç€ï¼Œæˆ‘ä»¬çœ‹è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">0</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">7</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">6</span> åŠç†ä¸šåŠ¡main ç»™ç”¨æˆ·:<span class="hljs-number">8</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">5</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">1</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">9</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">4</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">3</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">2</span> åŠç†ä¸šåŠ¡</code></pre></div><p>æˆ‘ä»¬å‘ç°ï¼Œè¾“å‡ºçš„ç»“æœé‡Œé¢å‡ºç°äº†mainçº¿ç¨‹ï¼Œå› ä¸ºçº¿ç¨‹æ± å‡ºå‘äº†æ‹’ç»ç­–ç•¥ï¼ŒæŠŠä»»åŠ¡å›é€€åˆ°mainçº¿ç¨‹ï¼Œç„¶åmainçº¿ç¨‹å¯¹ä»»åŠ¡è¿›è¡Œå¤„ç†</p><h3 id="9-3-é‡‡ç”¨-DiscardPolicy-æ‹’ç»ç­–ç•¥"><a href="#9-3-é‡‡ç”¨-DiscardPolicy-æ‹’ç»ç­–ç•¥" class="headerlink" title="9.3 é‡‡ç”¨ DiscardPolicy æ‹’ç»ç­–ç•¥"></a>9.3 é‡‡ç”¨ DiscardPolicy æ‹’ç»ç­–ç•¥</h3><div class="code-wrapper"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">0</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">5</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">2</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">1</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">4</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">7</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">6</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">3</span> åŠç†ä¸šåŠ¡</code></pre></div><p>é‡‡ç”¨DiscardPolicyæ‹’ç»ç­–ç•¥ä¼šï¼Œçº¿ç¨‹æ± ä¼šè‡ªåŠ¨æŠŠåé¢çš„ä»»åŠ¡éƒ½ç›´æ¥ä¸¢å¼ƒï¼Œä¹Ÿä¸æŠ¥å¼‚å¸¸ï¼Œå½“ä»»åŠ¡æ— å…³ç´§è¦çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨è¿™ä¸ªæ–¹å¼</p><h3 id="9-4-é‡‡ç”¨DiscardOldestPolicyæ‹’ç»ç­–ç•¥"><a href="#9-4-é‡‡ç”¨DiscardOldestPolicyæ‹’ç»ç­–ç•¥" class="headerlink" title="9.4 é‡‡ç”¨DiscardOldestPolicyæ‹’ç»ç­–ç•¥"></a>9.4 é‡‡ç”¨DiscardOldestPolicyæ‹’ç»ç­–ç•¥</h3><div class="code-wrapper"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">0</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">6</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">4</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> ç»™ç”¨æˆ·:<span class="hljs-number">5</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> ç»™ç”¨æˆ·:<span class="hljs-number">1</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> ç»™ç”¨æˆ·:<span class="hljs-number">9</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> ç»™ç”¨æˆ·:<span class="hljs-number">8</span> åŠç†ä¸šåŠ¡pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> ç»™ç”¨æˆ·:<span class="hljs-number">7</span> åŠç†ä¸šåŠ¡</code></pre></div><p>è¿™ä¸ªç­–ç•¥å’Œåˆšåˆšå·®ä¸å¤šï¼Œä¼šæŠŠæœ€ä¹…çš„é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ›¿æ¢æ‰</p><h2 id="10-çº¿ç¨‹æ± çš„åˆç†å‚æ•°"><a href="#10-çº¿ç¨‹æ± çš„åˆç†å‚æ•°" class="headerlink" title="10 çº¿ç¨‹æ± çš„åˆç†å‚æ•°"></a>10 çº¿ç¨‹æ± çš„åˆç†å‚æ•°</h2><p>ç”Ÿäº§ç¯å¢ƒä¸­å¦‚ä½•é…ç½® corePoolSize å’Œ maximumPoolSize</p><p>è¿™ä¸ªæ˜¯æ ¹æ®å…·ä½“ä¸šåŠ¡æ¥é…ç½®çš„ï¼Œåˆ†ä¸ºCPUå¯†é›†å‹å’ŒIOå¯†é›†å‹</p><ul><li>CPUå¯†é›†å‹</li></ul><p>CPUå¯†é›†çš„æ„æ€æ˜¯è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„è¿ç®—ï¼Œè€Œæ²¡æœ‰é˜»å¡ï¼ŒCPUä¸€ç›´å…¨é€Ÿè¿è¡Œ</p><p>CPUå¯†é›†ä»»åŠ¡åªæœ‰åœ¨çœŸæ­£çš„å¤šæ ¸CPUä¸Šæ‰å¯èƒ½å¾—åˆ°åŠ é€Ÿï¼ˆé€šè¿‡å¤šçº¿ç¨‹ï¼‰</p><p>è€Œåœ¨å•æ ¸CPUä¸Šï¼Œæ— è®ºä½ å¼€å‡ ä¸ªæ¨¡æ‹Ÿçš„å¤šçº¿ç¨‹è¯¥ä»»åŠ¡éƒ½ä¸å¯èƒ½å¾—åˆ°åŠ é€Ÿï¼Œå› ä¸ºCPUæ€»çš„è¿ç®—èƒ½åŠ›å°±é‚£äº›</p><p>CPUå¯†é›†å‹ä»»åŠ¡é…ç½®å°½å¯èƒ½å°‘çš„çº¿ç¨‹æ•°é‡ï¼š</p><p>ä¸€èˆ¬å…¬å¼ï¼šCPUæ ¸æ•° + 1ä¸ªçº¿ç¨‹æ•°</p><ul><li>IOå¯†é›†å‹</li></ul><p>ç”±äºIOå¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚ CPUæ ¸æ•° * 2</p><p>IOå¯†é›†å‹ï¼Œå³è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„IOæ“ä½œï¼Œå³å¤§é‡çš„é˜»å¡</p><p>åœ¨å•çº¿ç¨‹ä¸Šè¿è¡ŒIOå¯†é›†å‹çš„ä»»åŠ¡ä¼šå¯¼è‡´æµªè´¹å¤§é‡çš„CPUè¿ç®—èƒ½åŠ›èŠ±è´¹åœ¨ç­‰å¾…ä¸Š</p><p>æ‰€ä»¥IOå¯†é›†å‹ä»»åŠ¡ä¸­ä½¿ç”¨å¤šçº¿ç¨‹å¯ä»¥å¤§å¤§çš„åŠ é€Ÿç¨‹åºçš„è¿è¡Œï¼Œå³ä½¿åœ¨å•æ ¸CPUä¸Šï¼Œè¿™ç§åŠ é€Ÿä¸»è¦å°±æ˜¯åˆ©ç”¨äº†è¢«æµªè´¹æ‰çš„é˜»å¡æ—¶é—´ã€‚</p><p>IOå¯†é›†æ—¶ï¼Œå¤§éƒ¨åˆ†çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œæ•…éœ€è¦å¤šé…ç½®çº¿ç¨‹æ•°ï¼š</p><p>å‚è€ƒå…¬å¼ï¼šCPUæ ¸æ•° / (1 - é˜»å¡ç³»æ•°)      é˜»å¡ç³»æ•°åœ¨0.8 ~ 0.9å·¦å³</p><p>ä¾‹å¦‚ï¼š8æ ¸CPUï¼š8/ (1 - 0.9) = 80ä¸ªçº¿ç¨‹æ•°</p><h1 id="ç¬¬11ç« -æ­»é”ç¼–ç åŠå®šä½åˆ†æ"><a href="#ç¬¬11ç« -æ­»é”ç¼–ç åŠå®šä½åˆ†æ" class="headerlink" title="ç¬¬11ç«  æ­»é”ç¼–ç åŠå®šä½åˆ†æ"></a>ç¬¬11ç«  æ­»é”ç¼–ç åŠå®šä½åˆ†æ</h1><h2 id="1-æ¦‚å¿µ-2"><a href="#1-æ¦‚å¿µ-2" class="headerlink" title="1 æ¦‚å¿µ"></a>1 æ¦‚å¿µ</h2><p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›å¹²æ¶‰é‚£ä»–ä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚å¦‚æœèµ„æºå……è¶³ï¼Œè¿›ç¨‹çš„èµ„æºè¯·æ±‚éƒ½èƒ½å¤Ÿå¾—åˆ°æ»¡è¶³ï¼Œæ­»é”å‡ºç°çš„å¯èƒ½æ€§å°±å¾ˆä½ï¼Œå¦åˆ™å°±ä¼šå› äº‰å¤ºæœ‰é™çš„èµ„æºè€Œé™·å…¥æ­»é”ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318175441578.png" alt="image-20200318175441578"></p><h2 id="2-äº§ç”Ÿæ­»é”çš„åŸå› "><a href="#2-äº§ç”Ÿæ­»é”çš„åŸå› " class="headerlink" title="2 äº§ç”Ÿæ­»é”çš„åŸå› "></a>2 äº§ç”Ÿæ­»é”çš„åŸå› </h2><ul><li>ç³»ç»Ÿèµ„æºä¸è¶³</li><li>è¿›ç¨‹è¿è¡Œæ¨è¿›çš„é¡ºåºä¸å¯¹</li><li>èµ„æºåˆ†é…ä¸å½“</li></ul><h2 id="3-æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶"><a href="#3-æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶" class="headerlink" title="3 æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶"></a>3 æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶</h2><ul><li>äº’æ–¥<ul><li>è§£å†³æ–¹æ³•ï¼šæŠŠäº’æ–¥çš„å…±äº«èµ„æºå°è£…æˆå¯åŒæ—¶è®¿é—®</li></ul></li><li>å æœ‰ä¸”ç­‰å¾…<ul><li>è§£å†³æ–¹æ³•ï¼šè¿›ç¨‹è¯·æ±‚èµ„æºæ—¶ï¼Œè¦æ±‚å®ƒä¸å æœ‰ä»»ä½•å…¶å®ƒèµ„æºï¼Œä¹Ÿå°±æ˜¯å®ƒå¿…é¡»ä¸€æ¬¡æ€§ç”³è¯·åˆ°æ‰€æœ‰çš„èµ„æºï¼Œè¿™ç§æ–¹å¼ä¼šå¯¼è‡´èµ„æºæ•ˆç‡ä½ã€‚</li></ul></li><li>éæŠ¢å å¼<ul><li>è§£å†³æ–¹æ³•ï¼šå¦‚æœè¿›ç¨‹ä¸èƒ½ç«‹å³åˆ†é…èµ„æºï¼Œè¦æ±‚å®ƒä¸å æœ‰ä»»ä½•å…¶ä»–èµ„æºï¼Œä¹Ÿå°±æ˜¯åªèƒ½å¤ŸåŒæ—¶è·å¾—æ‰€æœ‰éœ€è¦èµ„æºæ—¶ï¼Œæ‰æ‰§è¡Œåˆ†é…æ“ä½œ</li></ul></li><li>å¾ªç¯ç­‰å¾…<ul><li>è§£å†³æ–¹æ³•ï¼šå¯¹èµ„æºè¿›è¡Œæ’åºï¼Œè¦æ±‚è¿›ç¨‹æŒ‰é¡ºåºè¯·æ±‚èµ„æºã€‚</li></ul></li></ul><h2 id="4-æ­»é”ä»£ç "><a href="#4-æ­»é”ä»£ç " class="headerlink" title="4 æ­»é”ä»£ç "></a>4 æ­»é”ä»£ç </h2><p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªèµ„æºç±»ï¼Œç„¶åè®©ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«æŒæœ‰è‡ªå·±çš„é”ï¼ŒåŒæ—¶åœ¨å°è¯•è·å–åˆ«äººçš„ï¼Œå°±ä¼šå‡ºç°æ­»é”ç°è±¡</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * æ­»é”å°Demo</span><span class="hljs-comment"> * æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ</span><span class="hljs-comment"> * å› äº‰å¤ºèµ„æºè€Œé€ æˆä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œ</span><span class="hljs-comment"> * è‹¥æ— å¤–åŠ›å¹²æ¶‰é‚£ä»–ä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»</span><span class="hljs-comment"> */</span><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-comment">/**</span><span class="hljs-comment"> * èµ„æºç±»</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HoldLockThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span></span>&#123;    <span class="hljs-keyword">private</span> String lockA;    <span class="hljs-keyword">private</span> String lockB;    <span class="hljs-comment">// æŒæœ‰è‡ªå·±çš„é”ï¼Œè¿˜æƒ³å¾—åˆ°åˆ«äººçš„é”</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HoldLockThread</span><span class="hljs-params">(String lockA, String lockB)</span> </span>&#123;        <span class="hljs-keyword">this</span>.lockA = lockA;        <span class="hljs-keyword">this</span>.lockB = lockB;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">synchronized</span> (lockA) &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t è‡ªå·±æŒæœ‰&quot;</span> + lockA + <span class="hljs-string">&quot;\t å°è¯•è·å–ï¼š&quot;</span> + lockB);            <span class="hljs-keyword">try</span> &#123;                TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;            <span class="hljs-keyword">synchronized</span> (lockB) &#123;                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t è‡ªå·±æŒæœ‰&quot;</span> + lockB + <span class="hljs-string">&quot;\t å°è¯•è·å–ï¼š&quot;</span> + lockA);            &#125;        &#125;    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadLockDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        String lockA = <span class="hljs-string">&quot;lockA&quot;</span>;        String lockB = <span class="hljs-string">&quot;lockB&quot;</span>;        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> HoldLockThread(lockA, lockB), <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> HoldLockThread(lockB, lockA), <span class="hljs-string">&quot;t2&quot;</span>).start();    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœï¼Œmainçº¿ç¨‹æ— æ³•ç»“æŸ</p><div class="code-wrapper"><pre><code class="hljs java">t1 è‡ªå·±æŒæœ‰lockA å°è¯•è·å–ï¼šlockBt2 è‡ªå·±æŒæœ‰lockB å°è¯•è·å–ï¼šlockA</code></pre></div><h2 id="5-å¦‚ä½•æ’æŸ¥æ­»é”"><a href="#5-å¦‚ä½•æ’æŸ¥æ­»é”" class="headerlink" title="5 å¦‚ä½•æ’æŸ¥æ­»é”"></a>5 å¦‚ä½•æ’æŸ¥æ­»é”</h2><p>å½“æˆ‘ä»¬å‡ºç°æ­»é”çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦ä½¿ç”¨jpså‘½ä»¤æŸ¥çœ‹è¿è¡Œçš„ç¨‹åº</p><div class="code-wrapper"><pre><code class="hljs java">jps -l</code></pre></div><p>æˆ‘ä»¬èƒ½çœ‹åˆ°DeadLockDemoè¿™ä¸ªç±»ï¼Œä¸€ç›´åœ¨è¿è¡Œ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318181504703.png" alt="image-20200318181504703"></p><p>åœ¨ä½¿ç”¨jstackæŸ¥çœ‹å †æ ˆä¿¡æ¯</p><div class="code-wrapper"><pre><code class="hljs java">jstack  7560   # åé¢å‚æ•°æ˜¯ jpsè¾“å‡ºçš„è¯¥ç±»çš„pid</code></pre></div><p>å¾—åˆ°çš„ç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java">Found one Java-level deadlock:=============================<span class="hljs-string">&quot;t2&quot;</span>:  waiting to lock monitor <span class="hljs-number">0x000000001cfc0de8</span> (object <span class="hljs-number">0x000000076b696e80</span>, a java.lang.String),  which is held by <span class="hljs-string">&quot;t1&quot;</span><span class="hljs-string">&quot;t1&quot;</span>:  waiting to lock monitor <span class="hljs-number">0x000000001cfc3728</span> (object <span class="hljs-number">0x000000076b696eb8</span>, a java.lang.String),  which is held by <span class="hljs-string">&quot;t2&quot;</span>Java stack information <span class="hljs-keyword">for</span> the threads listed above:===================================================<span class="hljs-string">&quot;t2&quot;</span>:        at com.moxi.interview.study.Lock.HoldLockThread.run(DeadLockDemo.java:<span class="hljs-number">42</span>)        - waiting to lock &lt;<span class="hljs-number">0x000000076b696e80</span>&gt; (a java.lang.String)        - locked &lt;<span class="hljs-number">0x000000076b696eb8</span>&gt; (a java.lang.String)        at java.lang.Thread.run(Thread.java:<span class="hljs-number">745</span>)<span class="hljs-string">&quot;t1&quot;</span>:        at com.moxi.interview.study.Lock.HoldLockThread.run(DeadLockDemo.java:<span class="hljs-number">42</span>)        - waiting to lock &lt;<span class="hljs-number">0x000000076b696eb8</span>&gt; (a java.lang.String)        - locked &lt;<span class="hljs-number">0x000000076b696e80</span>&gt; (a java.lang.String)        at java.lang.Thread.run(Thread.java:<span class="hljs-number">745</span>)Found <span class="hljs-number">1</span> deadlock.</code></pre></div><p>é€šè¿‡æŸ¥çœ‹æœ€åä¸€è¡Œï¼Œæˆ‘ä»¬çœ‹åˆ°  Found 1 deadlockï¼Œå³å­˜åœ¨ä¸€ä¸ªæ­»é”</p><h1 id="ç¬¬äºŒéƒ¨åˆ†-JVM"><a href="#ç¬¬äºŒéƒ¨åˆ†-JVM" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ† JVM"></a>ç¬¬äºŒéƒ¨åˆ† JVM</h1><h1 id="ç¬¬-12-ç« -JVM"><a href="#ç¬¬-12-ç« -JVM" class="headerlink" title="ç¬¬ 12 ç«  JVM"></a>ç¬¬ 12 ç«  JVM</h1><h2 id="1-JVMä½“ç³»ç»“æ„"><a href="#1-JVMä½“ç³»ç»“æ„" class="headerlink" title="1 JVMä½“ç³»ç»“æ„"></a>1 JVMä½“ç³»ç»“æ„</h2><h3 id="1-1-æ¦‚è§ˆ"><a href="#1-1-æ¦‚è§ˆ" class="headerlink" title="1.1 æ¦‚è§ˆ"></a>1.1 æ¦‚è§ˆ</h3><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318182540332.png" alt="image-20200318182540332"></p><p>java gc ä¸»è¦å›æ”¶çš„æ˜¯ æ–¹æ³•åŒº å’Œ å †ä¸­çš„å†…å®¹</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318184401133.png" alt="image-20200318184401133"></p><h3 id="1-2-ç±»åŠ è½½å™¨"><a href="#1-2-ç±»åŠ è½½å™¨" class="headerlink" title="1.2 ç±»åŠ è½½å™¨"></a>1.2 ç±»åŠ è½½å™¨</h3><ul><li>ç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆ</li><li>åŒäº²å§”æ´¾æœºåˆ¶</li><li>Javaç±»åŠ è½½çš„æ²™ç®±å®‰å…¨æœºåˆ¶</li></ul><h3 id="1-3-å¸¸è§çš„åƒåœ¾å›æ”¶ç®—æ³•"><a href="#1-3-å¸¸è§çš„åƒåœ¾å›æ”¶ç®—æ³•" class="headerlink" title="1.3 å¸¸è§çš„åƒåœ¾å›æ”¶ç®—æ³•"></a>1.3 å¸¸è§çš„åƒåœ¾å›æ”¶ç®—æ³•</h3><ul><li>å¼•ç”¨è®¡æ•°</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318184508982.png" alt="image-20200318184508982"></p><p>åœ¨åŒç«¯å¾ªç¯ï¼Œäº’ç›¸å¼•ç”¨çš„æ—¶å€™ï¼Œå®¹æ˜“æŠ¥é”™ï¼Œç›®å‰å¾ˆå°‘ä½¿ç”¨è¿™ç§æ–¹å¼äº†</p><ul><li>å¤åˆ¶</li></ul><p>å¤åˆ¶ç®—æ³•åœ¨å¹´è½»ä»£çš„æ—¶å€™ï¼Œè¿›è¡Œä½¿ç”¨ï¼Œå¤åˆ¶æ—¶å€™æœ‰äº¤æ¢</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318184759295.png" alt="image-20200318184759295"></p><p><img src="images/image-20200318184820787.png" alt="image-20200318184820787"></p><p>ä¼˜ç‚¹ï¼šæ²¡æœ‰äº§ç”Ÿå†…å­˜ç¢ç‰‡</p><ul><li>æ ‡è®°æ¸…é™¤</li></ul><p>å…ˆæ ‡è®°ï¼Œåæ¸…é™¤ï¼Œç¼ºç‚¹æ˜¯ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œç”¨äºè€å¹´ä»£å¤šä¸€äº›</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318184944878.png" alt="image-20200318184944878"></p><ul><li>æ ‡è®°æ•´ç†</li></ul><p>æ ‡è®°æ¸…é™¤æ•´ç†</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318185100936.png" alt="image-20200318185100936"></p><p>ä½†æ˜¯éœ€è¦ä»˜å‡ºä»£ä»·ï¼Œå› ä¸ºç§»åŠ¨å¯¹è±¡éœ€è¦æˆæœ¬</p><h2 id="2-JVM-é¢è¯•é¢˜"><a href="#2-JVM-é¢è¯•é¢˜" class="headerlink" title="2 JVM é¢è¯•é¢˜"></a>2 JVM é¢è¯•é¢˜</h2><h3 id="2-1-æ˜¯ä¹ˆæ˜¯-GCRoots-èƒ½åšä»€ä¹ˆ"><a href="#2-1-æ˜¯ä¹ˆæ˜¯-GCRoots-èƒ½åšä»€ä¹ˆ" class="headerlink" title="2.1 æ˜¯ä¹ˆæ˜¯ GCRoots èƒ½åšä»€ä¹ˆ"></a>2.1 æ˜¯ä¹ˆæ˜¯ GCRoots èƒ½åšä»€ä¹ˆ</h3><h4 id="1-ä»€ä¹ˆæ˜¯åƒåœ¾"><a href="#1-ä»€ä¹ˆæ˜¯åƒåœ¾" class="headerlink" title="1 ä»€ä¹ˆæ˜¯åƒåœ¾"></a>1 ä»€ä¹ˆæ˜¯åƒåœ¾</h4><p>ç®€å•æ¥è¯´å°±æ˜¯å†…å­˜ä¸­å·²ç»ä¸å†è¢«ä½¿ç”¨çš„ç©ºé—´å°±æ˜¯åƒåœ¾</p><h4 id="2-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶"><a href="#2-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶" class="headerlink" title="2 å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶"></a>2 å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶</h4><h5 id="2-1-å¼•ç”¨è®¡æ•°æ³•"><a href="#2-1-å¼•ç”¨è®¡æ•°æ³•" class="headerlink" title="2.1 å¼•ç”¨è®¡æ•°æ³•"></a>2.1 å¼•ç”¨è®¡æ•°æ³•</h5><p>Javaä¸­ï¼Œå¼•ç”¨å’Œå¯¹è±¡æ˜¯æœ‰å…³è”çš„ã€‚å¦‚æœè¦æ“ä½œå¯¹è±¡åˆ™å¿…é¡»ç”¨å¼•ç”¨è¿›è¡Œã€‚</p><p>å› æ­¤ï¼Œå¾ˆæ˜¾ç„¶ä¸€ä¸ªç®€å•çš„åŠæ³•å°±æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ã€‚ç®€å•è¯´ï¼Œç»™å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨</p><p>æ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒï¼Œè®¡æ•°å™¨å€¼åŠ 1</p><p>æ¯å½“æœ‰ä¸€ä¸ªå¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å€¼å‡1</p><p>ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨å€¼ä¸ºé›¶çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯å¯å›æ”¶å¯¹è±¡ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆä¸»æµçš„Javaè™šæ‹Ÿæœºé‡Œé¢éƒ½æ²¡æœ‰é€‰ç”¨è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿå…¶ä¸­æœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚</p><p>è¯¥ç®—æ³•å­˜åœ¨ä½†ç›®å‰æ— äººç”¨äº†ï¼Œè§£å†³ä¸äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œäº†è§£å³å¯ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200318213301603.png" alt="image-20200318213301603"></p><h5 id="2-2-æšä¸¾æ ¹èŠ‚ç‚¹åšå¯è¾¾æ€§åˆ†æ"><a href="#2-2-æšä¸¾æ ¹èŠ‚ç‚¹åšå¯è¾¾æ€§åˆ†æ" class="headerlink" title="2.2 æšä¸¾æ ¹èŠ‚ç‚¹åšå¯è¾¾æ€§åˆ†æ"></a>2.2 æšä¸¾æ ¹èŠ‚ç‚¹åšå¯è¾¾æ€§åˆ†æ</h5><p>æ ¹æœç´¢è·¯å¾„ç®—æ³•</p><p>ä¸ºäº†è§£å†³å¼•ç”¨è®¡æ•°æ³•çš„å¾ªç¯å¼•ç”¨ä¸ªé—®é¢˜ï¼ŒJavaä½¿ç”¨äº†å¯è¾¾æ€§åˆ†æçš„æ–¹æ³•ï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200319113611244.png" alt="image-20200319113611244"></p><p>æ‰€è°“ GC Roots æˆ–è€…è¯´ Tracing Rootsçš„â€œæ ¹é›†åˆâ€ å°±æ˜¯ä¸€ç»„å¿…é¡»æ´»è·ƒçš„å¼•ç”¨</p><p>åŸºæœ¬æ€è·¯å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—åä¸º GC Rootsçš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™ä¸ªè¢«ç§°ä¸ºGC Rootsçš„å¯¹è±¡å¼€å§‹å‘ä¸‹æœç´¢ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™è¯´æ˜æ­¤å¯¹è±¡ä¸å¯ç”¨ã€‚ä¹Ÿå³ç»™å®šä¸€ä¸ªé›†åˆçš„å¼•ç”¨ä½œä¸ºæ ¹å‡ºå‘ï¼Œé€šè¿‡å¼•ç”¨å…³ç³»éå†å¯¹è±¡å›¾ï¼Œèƒ½è¢«éå†åˆ°çš„ï¼ˆå¯åˆ°è¾¾çš„ï¼‰å¯¹è±¡å°±è¢«åˆ¤å®šä¸ºå­˜æ´»ï¼Œæ²¡æœ‰è¢«éå†åˆ°çš„å¯¹è±¡å°±è¢«åˆ¤å®šä¸ºæ­»äº¡</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200319114526625.png" alt="image-20200319114526625"></p><p>å¿…é¡»ä»GC Rootså¯¹è±¡å¼€å§‹ï¼Œè¿™ä¸ªç±»ä¼¼äºlinuxçš„ /  ä¹Ÿå°±æ˜¯æ ¹ç›®å½•</p><p>è“è‰²éƒ¨åˆ†æ˜¯ä»GC Rootså‡ºå‘ï¼Œèƒ½å¤Ÿå¾ªç¯å¯è¾¾</p><p>è€Œç™½è‰²éƒ¨åˆ†ï¼Œä»GC Rootså‡ºå‘ï¼Œæ— æ³•åˆ°è¾¾</p><h5 id="2-3-ä¸€å¥è¯ç†è§£GC-Roots"><a href="#2-3-ä¸€å¥è¯ç†è§£GC-Roots" class="headerlink" title="2.3 ä¸€å¥è¯ç†è§£GC Roots"></a>2.3 ä¸€å¥è¯ç†è§£GC Roots</h5><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸‰ä¸ªå®ä½“ï¼Œåˆ†åˆ«æ˜¯ äººï¼Œç‹—ï¼Œæ¯›è¡£</p><p>ç„¶åä»–ä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ï¼šäºº ç‰µç€ ç‹—ï¼Œç‹—ç©¿ç€æ¯›è¡£ï¼Œä»–ä»¬ä¹‹é—´æ˜¯å¼ºè¿æ¥çš„å…³ç³»</p><p>æœ‰ä¸€å¤©äººæ¶ˆå¤±äº†ï¼Œåªå‰©ä¸‹ç‹—ç‹— å’Œ æ¯›è¡£ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒæŠŠäººæƒ³è±¡æˆ GC Rootsï¼Œå› ä¸º äºº å’Œ ç‹—ä¹‹é—´å¤±å»äº†ç»³å­è¿æ¥ï¼Œ</p><p>é‚£ä¹ˆç‹—å¯èƒ½è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯è¢«è­¦å¯ŸæŠ“èµ·æ¥ï¼Œè¢«é€åˆ°æµæµªç‹—å¯„å…»æ‰€</p><p>å‡è®¾ç‹—å’Œäººæœ‰å¼ºè¿æ¥çš„æ—¶å€™ï¼Œç‹—ç‹—å°±ä¸ä¼šè¢«å½“æˆæ˜¯æµæµªç‹—</p><h5 id="2-4-é‚£äº›å¯¹è±¡å¯ä»¥å½“åšGC-Roots"><a href="#2-4-é‚£äº›å¯¹è±¡å¯ä»¥å½“åšGC-Roots" class="headerlink" title="2.4 é‚£äº›å¯¹è±¡å¯ä»¥å½“åšGC Roots"></a>2.4 é‚£äº›å¯¹è±¡å¯ä»¥å½“åšGC Roots</h5><ul><li>è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡åŒºï¼Œä¹Ÿå«åšå±€éƒ¨å˜é‡è¡¨ï¼‰ä¸­çš„å¼•ç”¨å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„JNIï¼ˆNativeæ–¹æ³•ï¼‰çš„å¼•ç”¨å¯¹è±¡</li></ul><h5 id="2-5-ä»£ç è¯´æ˜"><a href="#2-5-ä»£ç è¯´æ˜" class="headerlink" title="2.5 ä»£ç è¯´æ˜"></a>2.5 ä»£ç è¯´æ˜</h5><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * åœ¨Javaä¸­ï¼Œå¯ä»¥ä½œä¸ºGC Rootsçš„å¯¹è±¡æœ‰ï¼š</span><span class="hljs-comment"> * - è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡åŒºï¼Œä¹Ÿå«åšå±€éƒ¨å˜é‡è¡¨ï¼‰ä¸­çš„å¼•ç”¨å¯¹è±¡</span><span class="hljs-comment"> * - æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</span><span class="hljs-comment"> * - æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</span><span class="hljs-comment"> * - æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„JNIï¼ˆNativeæ–¹æ³•ï¼‰çš„å¼•ç”¨å¯¹è±¡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GCRootDemo</span> </span>&#123;    <span class="hljs-comment">// æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</span>    <span class="hljs-comment">// private static GCRootDemo2 t2;</span>    <span class="hljs-comment">// æ–¹æ³•åŒºä¸­çš„å¸¸é‡å¼•ç”¨ï¼ŒGC Roots ä¹Ÿä¼šä»¥è¿™ä¸ªä¸ºèµ·ç‚¹ï¼Œè¿›è¡Œéå†</span>    <span class="hljs-comment">// private static final GCRootDemo3 t3 = new GCRootDemo3(8);</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m1</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// ç¬¬ä¸€ç§ï¼Œè™šæ‹Ÿæœºæ ˆä¸­çš„å¼•ç”¨å¯¹è±¡</span>        GCRootDemo t1 = <span class="hljs-keyword">new</span> GCRootDemo();        System.gc();        System.out.println(<span class="hljs-string">&quot;ç¬¬ä¸€æ¬¡GCå®Œæˆ&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        m1();    &#125;&#125;</code></pre></div><h3 id="2-2-JVMå‚æ•°è°ƒä¼˜"><a href="#2-2-JVMå‚æ•°è°ƒä¼˜" class="headerlink" title="2.2  JVMå‚æ•°è°ƒä¼˜"></a>2.2  JVMå‚æ•°è°ƒä¼˜</h3><h4 id="1-å‰è¨€-3"><a href="#1-å‰è¨€-3" class="headerlink" title="1 å‰è¨€"></a>1 å‰è¨€</h4><p>ä½ è¯´ä½ åšè¿‡JVMè°ƒä¼˜å’Œå‚æ•°é…ç½®ï¼Œè¯·é—®å¦‚ä½•ç›˜ç‚¹æŸ¥çœ‹JVMç³»ç»Ÿé»˜è®¤å€¼</p><p>ä½¿ç”¨jpså’Œjinfoè¿›è¡ŒæŸ¥çœ‹</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xmsï¼šåˆå§‹å †ç©ºé—´</span><span class="hljs-deletion">-Xmxï¼šå †æœ€å¤§å€¼</span><span class="hljs-deletion">-Xssï¼šæ ˆç©ºé—´</span></code></pre></div><p>-Xms å’Œ -Xmxæœ€å¥½è°ƒæ•´ä¸€è‡´ï¼Œé˜²æ­¢JVMé¢‘ç¹è¿›è¡Œæ”¶é›†å’Œå›æ”¶</p><h4 id="2-JVMå‚æ•°ç±»å‹"><a href="#2-JVMå‚æ•°ç±»å‹" class="headerlink" title="2 JVMå‚æ•°ç±»å‹"></a>2 JVMå‚æ•°ç±»å‹</h4><ul><li>æ ‡é…å‚æ•°ï¼ˆä»JDK1.0 - Java12éƒ½åœ¨ï¼Œå¾ˆç¨³å®šï¼‰<ul><li>-version</li><li>-help</li><li>java -showversion</li></ul></li><li>Xå‚æ•°ï¼ˆäº†è§£ï¼‰<ul><li>-Xintï¼šè§£é‡Šæ‰§è¡Œ</li><li>-Xcompï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨å°±ç¼–è¯‘æˆæœ¬åœ°ä»£ç </li><li>-Xmixedï¼šæ··åˆæ¨¡å¼</li></ul></li><li>XXå‚æ•°ï¼ˆé‡ç‚¹ï¼‰<ul><li>Booleanç±»å‹<ul><li>å…¬å¼ï¼š-XX:+ æˆ–è€…-æŸä¸ªå±æ€§   + è¡¨ç¤ºå¼€å¯ï¼Œ-è¡¨ç¤ºå…³é—­</li><li>Caseï¼š-XX:-PrintGCDetailsï¼šè¡¨ç¤ºå…³é—­äº†GCè¯¦æƒ…è¾“å‡º</li></ul></li><li>key-valueç±»å‹<ul><li>å…¬å¼ï¼š-XX:å±æ€§key=å±æ€§value</li><li>ä¸æ»¡æ„åˆå§‹å€¼ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤è°ƒæ•´</li><li>caseï¼šå¦‚ä½•ï¼š-XX:MetaspaceSize=21807104ï¼šæŸ¥çœ‹Javaå…ƒç©ºé—´çš„å€¼</li></ul></li></ul></li></ul><h4 id="3-æŸ¥çœ‹è¿è¡Œçš„Javaç¨‹åºï¼ŒJVMå‚æ•°æ˜¯å¦å¼€å¯ï¼Œå…·ä½“å€¼ä¸ºå¤šå°‘ï¼Ÿ"><a href="#3-æŸ¥çœ‹è¿è¡Œçš„Javaç¨‹åºï¼ŒJVMå‚æ•°æ˜¯å¦å¼€å¯ï¼Œå…·ä½“å€¼ä¸ºå¤šå°‘ï¼Ÿ" class="headerlink" title="3 æŸ¥çœ‹è¿è¡Œçš„Javaç¨‹åºï¼ŒJVMå‚æ•°æ˜¯å¦å¼€å¯ï¼Œå…·ä½“å€¼ä¸ºå¤šå°‘ï¼Ÿ"></a>3 æŸ¥çœ‹è¿è¡Œçš„Javaç¨‹åºï¼ŒJVMå‚æ•°æ˜¯å¦å¼€å¯ï¼Œå…·ä½“å€¼ä¸ºå¤šå°‘ï¼Ÿ</h4><p>é¦–å…ˆæˆ‘ä»¬è¿è¡Œä¸€ä¸ªHelloGCçš„javaç¨‹åº</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloGC</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        System.out.println(<span class="hljs-string">&quot;hello GC&quot;</span>);        Thread.sleep(Integer.MAX_VALUE);    &#125;&#125;</code></pre></div><p>ç„¶åä½¿ç”¨ä¸‹åˆ—å‘½ä»¤æŸ¥çœ‹å®ƒçš„é»˜è®¤å‚æ•°</p><div class="code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-keyword">jpsï¼šæŸ¥çœ‹javaçš„åå°è¿›ç¨‹</span><span class="hljs-keyword">jinfoï¼šæŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„javaç¨‹åº</span></code></pre></div><p>å…·ä½“ä½¿ç”¨ï¼š</p><div class="code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-keyword">jps </span>-lå¾—åˆ°è¿›ç¨‹å·</code></pre></div><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-number">12608</span> com.moxi.interview.study.GC.HelloGC<span class="hljs-number">15200</span> sun.tools.jps.Jps<span class="hljs-number">15296</span> org.jetbrains.idea.maven.server.RemoteMavenServer36<span class="hljs-number">4528</span><span class="hljs-number">12216</span> org.jetbrains.jps.cmdline.Launcher<span class="hljs-number">9772</span> org.jetbrains.kotlin.daemon.KotlinCompileDaemon</code></pre></div><p>æŸ¥çœ‹åˆ°HelloGCçš„è¿›ç¨‹å·ä¸ºï¼š12608</p><p>æˆ‘ä»¬ä½¿ç”¨jinfo -flag ç„¶åæŸ¥çœ‹æ˜¯å¦å¼€å¯PrintGCDetailsè¿™ä¸ªå‚æ•°</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">jinfo</span> -flag PrintGCDetails <span class="hljs-number">12608</span></code></pre></div><p>å¾—åˆ°çš„å†…å®¹ä¸º</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:-PrintGCDetails</span></code></pre></div><p>ä¸Šé¢æåˆ°äº†ï¼Œ-å·è¡¨ç¤ºå…³é—­ï¼Œå³æ²¡æœ‰å¼€å¯PrintGCDetailsè¿™ä¸ªå‚æ•°</p><p>ä¸‹é¢æˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨HelloGCçš„æ—¶å€™ï¼Œå¢åŠ  PrintGCDetailsè¿™ä¸ªå‚æ•°ï¼Œéœ€è¦åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™é…ç½®JVMå‚æ•°</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200319122922264.png" alt="image-20200319122922264"></p><p>ç„¶ååœ¨VM Optionsä¸­åŠ å…¥ä¸‹é¢çš„ä»£ç ï¼Œç°åœ¨+å·è¡¨ç¤ºå¼€å¯</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+PrintGCDetails</span></code></pre></div><p>ç„¶ååœ¨ä½¿ç”¨jinfoæŸ¥çœ‹æˆ‘ä»¬çš„é…ç½®</p><div class="code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-keyword">jps </span>-l<span class="hljs-keyword">jinfo </span>-flag PrintGCDetails <span class="hljs-number">13540</span></code></pre></div><p>å¾—åˆ°çš„ç»“æœä¸º</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+PrintGCDetails</span></code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°åŸæ¥çš„-å·å˜æˆäº†+å·ï¼Œè¯´æ˜æˆ‘ä»¬é€šè¿‡ VM Optionsé…ç½®çš„JVMå‚æ•°å·²ç»ç”Ÿæ•ˆäº†</p><p>ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ï¼Œä¼šæŠŠjvmçš„å…¨éƒ¨é»˜è®¤å‚æ•°è¾“å‡º</p><div class="code-wrapper"><pre><code class="hljs asciidoc">jinfo -flags <span class="hljs-strong">***</span></code></pre></div><h4 id="4-é¢˜å¤–è¯ï¼ˆå‘é¢˜ï¼‰"><a href="#4-é¢˜å¤–è¯ï¼ˆå‘é¢˜ï¼‰" class="headerlink" title="4 é¢˜å¤–è¯ï¼ˆå‘é¢˜ï¼‰"></a>4 é¢˜å¤–è¯ï¼ˆå‘é¢˜ï¼‰</h4><p>ä¸¤ä¸ªç»å…¸å‚æ•°ï¼š-Xms  å’Œ -Xmxï¼Œè¿™ä¸¤ä¸ªå‚æ•° å¦‚ä½•è§£é‡Š</p><p>è¿™ä¸¤ä¸ªå‚æ•°ï¼Œè¿˜æ˜¯å±äºXXå‚æ•°ï¼Œå› ä¸ºå–äº†åˆ«å</p><ul><li>-Xms  ç­‰ä»·äº -XX:InitialHeapSize  ï¼šåˆå§‹åŒ–å †å†…å­˜ï¼ˆé»˜è®¤åªä¼šç”¨æœ€å¤§ç‰©ç†å†…å­˜çš„64åˆ†1ï¼‰</li><li>-Xmx ç­‰ä»·äº -XX:MaxHeapSize    ï¼šæœ€å¤§å †å†…å­˜ï¼ˆé»˜è®¤åªä¼šç”¨æœ€å¤§ç‰©ç†å†…å­˜çš„4åˆ†1ï¼‰</li></ul><h4 id="5-æŸ¥çœ‹JVMé»˜è®¤å‚æ•°"><a href="#5-æŸ¥çœ‹JVMé»˜è®¤å‚æ•°" class="headerlink" title="5 æŸ¥çœ‹JVMé»˜è®¤å‚æ•°"></a>5 æŸ¥çœ‹JVMé»˜è®¤å‚æ•°</h4><ul><li><p>-XX:+PrintFlagsInitial</p><ul><li>ä¸»è¦æ˜¯æŸ¥çœ‹åˆå§‹é»˜è®¤å€¼</li><li>å…¬å¼<ul><li>java -XX:+PrintFlagsInitial -version</li><li>java -XX:+PrintFlagsInitialï¼ˆé‡è¦å‚æ•°ï¼‰</li></ul></li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200320212256284.png" alt="image-20200320212256284">   </p></li><li><p>-XX:+PrintFlagsFinalï¼šè¡¨ç¤ºä¿®æ”¹ä»¥åï¼Œæœ€ç»ˆçš„å€¼</p><div class="code-wrapper"><pre><code>ä¼šå°†JVMçš„å„ä¸ªç»“æœéƒ½è¿›è¡Œæ‰“å°å¦‚æœæœ‰  := è¡¨ç¤ºä¿®æ”¹è¿‡çš„ï¼Œ = è¡¨ç¤ºæ²¡æœ‰ä¿®æ”¹è¿‡çš„</code></pre></div></li></ul><h4 id="6-å·¥ä½œä¸­å¸¸ç”¨çš„JVMåŸºæœ¬é…ç½®å‚æ•°"><a href="#6-å·¥ä½œä¸­å¸¸ç”¨çš„JVMåŸºæœ¬é…ç½®å‚æ•°" class="headerlink" title="6 å·¥ä½œä¸­å¸¸ç”¨çš„JVMåŸºæœ¬é…ç½®å‚æ•°"></a>6 å·¥ä½œä¸­å¸¸ç”¨çš„JVMåŸºæœ¬é…ç½®å‚æ•°</h4><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200322163252777.png" alt="image-20200322163252777"></p><h5 id="6-1-æŸ¥çœ‹å †å†…å­˜"><a href="#6-1-æŸ¥çœ‹å †å†…å­˜" class="headerlink" title="6.1 æŸ¥çœ‹å †å†…å­˜"></a>6.1 æŸ¥çœ‹å †å†…å­˜</h5><p>æŸ¥çœ‹JVMçš„åˆå§‹åŒ–å †å†…å­˜ -Xms å’Œæœ€å¤§å †å†…å­˜ Xmx</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloGC</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        <span class="hljs-comment">// è¿”å›Javaè™šæ‹Ÿæœºä¸­å†…å­˜çš„æ€»é‡</span>        <span class="hljs-keyword">long</span> totalMemory = Runtime.getRuntime().totalMemory();        <span class="hljs-comment">// è¿”å›Javaè™šæ‹Ÿæœºä¸­è¯•å›¾ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡</span>        <span class="hljs-keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory();        System.out.println(<span class="hljs-string">&quot;TOTAL_MEMORY(-Xms) = &quot;</span> + totalMemory + <span class="hljs-string">&quot;(å­—èŠ‚)ã€&quot;</span> + (totalMemory / (<span class="hljs-keyword">double</span>)<span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>) + <span class="hljs-string">&quot;MB&quot;</span>);        System.out.println(<span class="hljs-string">&quot;MAX_MEMORY(-Xmx) = &quot;</span> + maxMemory + <span class="hljs-string">&quot;(å­—èŠ‚)ã€&quot;</span> + (maxMemory / (<span class="hljs-keyword">double</span>)<span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>) + <span class="hljs-string">&quot;MB&quot;</span>);    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœä¸ºï¼š</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">TOTAL_MEMORY</span>(-Xms) = <span class="hljs-number">257425408</span>(å­—èŠ‚)ã€<span class="hljs-number">245</span>.<span class="hljs-number">5</span>MB<span class="hljs-attribute">MAX_MEMORY</span>(-Xmx) = <span class="hljs-number">3790077952</span>(å­—èŠ‚)ã€<span class="hljs-number">3614</span>.<span class="hljs-number">5</span>MB</code></pre></div><p>-Xms åˆå§‹å †å†…å­˜ä¸ºï¼šç‰©ç†å†…å­˜çš„1/64          -Xmx æœ€å¤§å †å†…å­˜ä¸ºï¼šç³»ç»Ÿç‰©ç†å†…å­˜çš„ 1/4</p><h5 id="6-2-æ‰“å°JVMé»˜è®¤å‚æ•°"><a href="#6-2-æ‰“å°JVMé»˜è®¤å‚æ•°" class="headerlink" title="6.2 æ‰“å°JVMé»˜è®¤å‚æ•°"></a>6.2 æ‰“å°JVMé»˜è®¤å‚æ•°</h5><p>ä½¿ç”¨ <code>-XX:+PrintCommandLineFlags</code> æ‰“å°å‡ºJVMçš„é»˜è®¤çš„ç®€å•åˆå§‹åŒ–å‚æ•°</p><p>æ¯”å¦‚æˆ‘çš„æœºå™¨è¾“å‡ºä¸ºï¼š</p><div class="code-wrapper"><pre><code class="hljs routeros">-XX:<span class="hljs-attribute">InitialHeapSize</span>=266376000 -XX:<span class="hljs-attribute">MaxHeapSize</span>=4262016000 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC</code></pre></div><h5 id="6-3-ç”Ÿæ´»å¸¸ç”¨è°ƒä¼˜å‚æ•°"><a href="#6-3-ç”Ÿæ´»å¸¸ç”¨è°ƒä¼˜å‚æ•°" class="headerlink" title="6.3 ç”Ÿæ´»å¸¸ç”¨è°ƒä¼˜å‚æ•°"></a>6.3 ç”Ÿæ´»å¸¸ç”¨è°ƒä¼˜å‚æ•°</h5><ul><li>-Xmsï¼šåˆå§‹åŒ–å †å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼Œç­‰ä»·äº -XX:initialHeapSize</li><li>-Xmxï¼šæœ€å¤§å †å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼Œç­‰ä»·äº-XX:MaxHeapSize</li><li>-Xssï¼šè®¾è®¡å•ä¸ªçº¿ç¨‹æ ˆçš„å¤§å°ï¼Œä¸€èˆ¬é»˜è®¤ä¸º512K~1024Kï¼Œç­‰ä»·äº -XX:ThreadStackSize<ul><li>ä½¿ç”¨ jinfo -flag ThreadStackSize   ä¼šå‘ç° -XX:ThreadStackSize = 0</li><li>è¿™ä¸ªå€¼çš„å¤§å°æ˜¯å–å†³äºå¹³å°çš„</li><li>Linux/x64:1024KB</li><li>OS Xï¼š1024KB</li><li>Oracle Solarisï¼š1024KB</li><li>Windowsï¼šå–å†³äºè™šæ‹Ÿå†…å­˜çš„å¤§å°</li></ul></li><li>-Xmnï¼šè®¾ç½®å¹´è½»ä»£å¤§å°</li><li>-XX:MetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´å¤§å°<ul><li>å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ï¼Œä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œå› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚</li><li>-Xms10m -Xmx10m -XX:MetaspaceSize=1024m  -XX:+PrintFlagsFinal</li><li>ä½†æ˜¯é»˜è®¤çš„å…ƒç©ºé—´å¤§å°ï¼šåªæœ‰20å¤šM</li><li>ä¸ºäº†é˜²æ­¢åœ¨é¢‘ç¹çš„å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œè®©å…ƒç©ºé—´å‡ºç°OOMï¼Œå› æ­¤å¯ä»¥æŠŠå…ƒç©ºé—´è®¾ç½®çš„å¤§ä¸€äº›</li></ul></li><li>-XX:PrintGCDetailsï¼šè¾“å‡ºè¯¦ç»†GCæ”¶é›†æ—¥å¿—ä¿¡æ¯<ul><li>GC</li><li>Full GC</li></ul></li></ul><p>GCæ—¥å¿—æ”¶é›†æµç¨‹å›¾</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200322185639902.png" alt="image-20200322185639902"></p><p>æˆ‘ä»¬ä½¿ç”¨ä¸€æ®µä»£ç ï¼Œåˆ¶é€ å‡ºåƒåœ¾å›æ”¶çš„è¿‡ç¨‹</p><p>é¦–å…ˆæˆ‘ä»¬è®¾ç½®ä¸€ä¸‹ç¨‹åºçš„å¯åŠ¨é…ç½®:  è®¾ç½®åˆå§‹å †å†…å­˜ä¸º10Mï¼Œæœ€å¤§å †å†…å­˜ä¸º10M</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:+PrintGCDetails</span></code></pre></div><p>ç„¶åç”¨ä¸‹åˆ—ä»£ç ï¼Œåˆ›å»ºä¸€ä¸ª éå¸¸å¤§ç©ºé—´çš„byteç±»å‹æ•°ç»„</p><div class="code-wrapper"><pre><code class="hljs arduino"><span class="hljs-keyword">byte</span> [] byteArray = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];</code></pre></div><p>è¿è¡Œåï¼Œå‘ç°ä¼šå‡ºç°ä¸‹åˆ—é”™è¯¯ï¼Œè¿™å°±æ˜¯OOMï¼šjavaå†…å­˜æº¢å‡ºï¼Œä¹Ÿå°±æ˜¯å †ç©ºé—´ä¸è¶³</p><div class="code-wrapper"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.OutOfMemoryError</span>: Java heap spaceat com<span class="hljs-selector-class">.moxi</span><span class="hljs-selector-class">.interview</span><span class="hljs-selector-class">.study</span><span class="hljs-selector-class">.GC</span><span class="hljs-selector-class">.HelloGC</span><span class="hljs-selector-class">.main</span>(HelloGC<span class="hljs-selector-class">.java</span>:<span class="hljs-number">22</span>)</code></pre></div><p>åŒæ—¶è¿˜æ‰“å°å‡ºäº†GCåƒåœ¾å›æ”¶æ—¶å€™çš„è¯¦æƒ…</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">1972</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">1972</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">740</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0156109</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">480</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">740</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">772</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0007815</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">480</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">292</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">772</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3467</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3467</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0080505</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003035</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">630</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">630</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3467</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3467</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0058502</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-variable">Heap</span> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">80</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">3</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd143d8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">630</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">8</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff69dbd0</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3510</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4500</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">389</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">392</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span></code></pre></div><p>é—®é¢˜å‘ç”Ÿçš„åŸå› ï¼š</p><p>å› ä¸ºä»¬é€šè¿‡ -Xms10m  å’Œ -Xmx10m åªç»™Javaå †æ ˆè®¾ç½®äº†10Mçš„ç©ºé—´ï¼Œä½†æ˜¯åˆ›å»ºäº†50Mçš„å¯¹è±¡ï¼Œå› æ­¤å°±ä¼šå‡ºç°ç©ºé—´ä¸è¶³ï¼Œè€Œå¯¼è‡´å‡ºé”™</p><p>åŒæ—¶åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼šGC å’Œ Full GC</p><h5 id="6-4-GCåƒåœ¾æ”¶é›†"><a href="#6-4-GCåƒåœ¾æ”¶é›†" class="headerlink" title="6.4 GCåƒåœ¾æ”¶é›†"></a>6.4 GCåƒåœ¾æ”¶é›†</h5><p>GCåœ¨æ–°ç”ŸåŒº</p><div class="code-wrapper"><pre><code class="hljs json">[GC (Allocation Failure) [PSYoungGen: <span class="hljs-number">1972</span>K-&gt;<span class="hljs-number">504</span>K(<span class="hljs-number">2560</span>K)] <span class="hljs-number">1972</span>K-&gt;<span class="hljs-number">740</span>K(<span class="hljs-number">9728</span>K), <span class="hljs-number">0.0156109</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.03</span> secs]</code></pre></div><p>GC (Allocation Failure)ï¼šè¡¨ç¤ºåˆ†é…å¤±è´¥ï¼Œé‚£ä¹ˆå°±éœ€è¦è§¦å‘å¹´è½»ä»£ç©ºé—´ä¸­çš„å†…å®¹è¢«å›æ”¶</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">1972</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">1972</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">740</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0156109</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span></code></pre></div><p>å‚æ•°å¯¹åº”çš„å›¾ä¸ºï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200323124000865.png" alt="image-20200323124000865"></p><h5 id="6-6-Full-GCåƒåœ¾å›æ”¶"><a href="#6-6-Full-GCåƒåœ¾å›æ”¶" class="headerlink" title="6.6 Full GCåƒåœ¾å›æ”¶"></a>6.6 Full GCåƒåœ¾å›æ”¶</h5><p>Full GCå¤§éƒ¨åˆ†å‘ç”Ÿåœ¨å…»è€åŒº</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">630</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">648</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">630</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3467</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3467</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0058502</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span></code></pre></div><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200323125839653.png" alt="image-20200323125839653"></p><p>è§„å¾‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs clojure">[åç§°ï¼š GCå‰å†…å­˜å ç”¨ -&gt; GCåå†…å­˜å ç”¨ (è¯¥åŒºå†…å­˜æ€»å¤§å°)]</code></pre></div><p>å½“æˆ‘ä»¬å‡ºç°äº†è€å¹´ä»£éƒ½æ‰›ä¸ä½çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°OOMå¼‚å¸¸</p><h5 id="6-7-XX-SurvivorRatio"><a href="#6-7-XX-SurvivorRatio" class="headerlink" title="6.7 -XX:SurvivorRatio"></a>6.7 -XX:SurvivorRatio</h5><p>è°ƒèŠ‚æ–°ç”Ÿä»£ä¸­ eden å’Œ S0ã€S1çš„ç©ºé—´æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º -XX:SuriviorRatio=8ï¼ŒEden:S0:S1 = 8:1:1</p><p>åŠ å…¥è®¾ç½®æˆ -XX:SurvivorRatio=4ï¼Œåˆ™ä¸º Eden:S0:S1 = 4:1:1</p><p>SurvivorRatioå€¼å°±æ˜¯è®¾ç½®edenåŒºçš„æ¯”ä¾‹å å¤šå°‘ï¼ŒS0å’ŒS1ç›¸åŒ</p><p>Javaå †ä»GCçš„è§’åº¦è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£ï¼ˆEdenåŒºï¼ŒFrom SurvivoråŒºåˆTo SurvivoråŒºï¼‰å’Œè€å¹´ä»£</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200323130442088.png" alt="image-20200323130442088"></p><ul><li>edenã€SurvivorFromå¤åˆ¶åˆ°SurvivorToï¼Œå¹´é¾„ + 1</li></ul><p>é¦–å…ˆï¼Œå½“EdenåŒºæ»¡çš„æ—¶å€™ä¼šè§¦å‘ç¬¬ä¸€æ¬¡GCï¼ŒæŠŠè¿˜æ´»ç€çš„å¯¹è±¡æ‹·è´åˆ°SurvivorFromå»ï¼Œå½“EdenåŒºå†æ¬¡è§¦å‘GCçš„æ—¶å€™ä¼šæ‰«æEdenåŒºåˆFromåŒºåŸŸï¼Œå¯¹è¿™ä¸¤ä¸ªåŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œç»è¿‡è¿™æ¬¡å›æ”¶åè¿˜å­˜æ´»çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥å¤åˆ¶åˆ°ToåŒºåŸŸï¼ˆå¦‚æœå¯¹è±¡çš„å¹´é¾„å·²ç»åˆ°è¾¾è€å¹´çš„æ ‡å‡†ï¼Œåˆ™èµ‹å€¼åˆ°è€å¹´ä»£åŒºï¼‰ï¼Œé€šçŸ¥æŠŠè¿™äº›å¯¹è±¡çš„å¹´é¾„ + 1</p><ul><li>æ¸…ç©ºedenã€SurvivorFrom</li></ul><p>ç„¶åï¼Œæ¸…ç©ºedenï¼ŒSurvivorFromä¸­çš„å¯¹è±¡ï¼Œä¹Ÿå³å¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯to</p><ul><li>SurvivorToå’ŒSurvivorFromäº’æ¢</li></ul><p>æœ€åï¼ŒSurvivorToå’ŒSurvivorFromäº’æ¢ï¼ŒåŸSurvivorToæˆä¸ºä¸‹ä¸€æ¬¡GCæ—¶çš„SurvivorFromåŒºï¼Œéƒ¨åˆ†å¯¹è±¡ä¼šåœ¨Fromå’ŒToåŒºåŸŸä¸­å¤åˆ¶æ¥å¤åˆ¶å»ï¼Œå¦‚æ­¤äº¤æ¢15æ¬¡ï¼ˆç”±JVMå‚æ•°MaxTenuringThresholdå†³å®šï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤ä¸º15ï¼‰ï¼Œæœ€ç»ˆå¦‚æœè¿˜æ˜¯å­˜æ´»ï¼Œå°±å­˜å…¥è€å¹´ä»£</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200323150946414.png" alt="image-20200323150946414"></p><h5 id="6-8-XX-NewRatioï¼ˆäº†è§£ï¼‰"><a href="#6-8-XX-NewRatioï¼ˆäº†è§£ï¼‰" class="headerlink" title="6.8 -XX:NewRatioï¼ˆäº†è§£ï¼‰"></a>6.8 -XX:NewRatioï¼ˆäº†è§£ï¼‰</h5><p>é…ç½®å¹´è½»ä»£new å’Œè€å¹´ä»£old åœ¨å †ç»“æ„çš„å æ¯”</p><p>é»˜è®¤ï¼š -XX:NewRatio=2 æ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£2ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †çš„1/3</p><p>-XX:NewRatio=4ï¼šæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 4ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †çš„1/5ï¼ŒNewRadioå€¼å°±æ˜¯è®¾ç½®è€å¹´ä»£çš„å æ¯”ï¼Œå‰©ä¸‹çš„1ä¸ªæ–°ç”Ÿä»£</p><p>æ–°ç”Ÿä»£ç‰¹åˆ«å°ï¼Œä¼šé€ æˆé¢‘ç¹çš„è¿›è¡ŒGCæ”¶é›†</p><h5 id="6-9-XX-MaxTenuringThreshold"><a href="#6-9-XX-MaxTenuringThreshold" class="headerlink" title="6.9 -XX:MaxTenuringThreshold"></a>6.9 -XX:MaxTenuringThreshold</h5><p>è®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„ï¼ŒSurvivorToå’ŒSurvivorFromäº’æ¢ï¼ŒåŸSurvivorToæˆä¸ºä¸‹ä¸€æ¬¡GCæ—¶çš„SurvivorFromåŒºï¼Œéƒ¨åˆ†å¯¹è±¡ä¼šåœ¨Fromå’ŒToåŒºåŸŸä¸­å¤åˆ¶æ¥å¤åˆ¶å»ï¼Œå¦‚æ­¤äº¤æ¢15æ¬¡ï¼ˆç”±JVMå‚æ•°MaxTenuringThresholdå†³å®šï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤ä¸º15ï¼‰ï¼Œæœ€ç»ˆå¦‚æœè¿˜æ˜¯å­˜æ´»ï¼Œå°±å­˜å…¥è€å¹´ä»£</p><p>è¿™é‡Œå°±æ˜¯è°ƒæ•´è¿™ä¸ªæ¬¡æ•°çš„ï¼Œé»˜è®¤æ˜¯15ï¼Œå¹¶ä¸”è®¾ç½®çš„å€¼ åœ¨ 0~15ä¹‹é—´</p><p>æŸ¥çœ‹é»˜è®¤è¿›å…¥è€å¹´ä»£å¹´é¾„ï¼šjinfo -flag MaxTenuringThreshold 17344</p><p>-XX:MaxTenuringThreshold=0ï¼šè®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„ã€‚å¦‚æœè®¾ç½®ä¸º0çš„è¯ï¼Œåˆ™å¹´è½»å¯¹è±¡ä¸ç»è¿‡SurvivoråŒºï¼Œç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚å¯¹äºå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œå¯ä»¥æé«˜æ•ˆç‡ã€‚å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶ï¼Œè¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡å†å¹´è½»ä»£çš„å­˜æ´»æ—¶é—´ï¼Œå¢åŠ åœ¨å¹´è½»ä»£å³è¢«å›æ”¶çš„æ¦‚å¿µ</p><h3 id="2-3-Javaä¸­çš„å¼•ç”¨"><a href="#2-3-Javaä¸­çš„å¼•ç”¨" class="headerlink" title="2.3 Javaä¸­çš„å¼•ç”¨"></a>2.3 Javaä¸­çš„å¼•ç”¨</h3><h4 id="1-å‰è¨€-4"><a href="#1-å‰è¨€-4" class="headerlink" title="1 å‰è¨€"></a>1 å‰è¨€</h4><p>åœ¨åŸæ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ˆåˆ°ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–</p><div class="code-wrapper"><pre><code class="hljs java">Person p = <span class="hljs-keyword">new</span> Person()</code></pre></div><p>åœ¨ç­‰å·çš„å·¦è¾¹ï¼Œå°±æ˜¯ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå­˜å‚¨åœ¨æ ˆä¸­</p><p>è€Œç­‰å·å³è¾¹ï¼Œå°±æ˜¯å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å †ä¸­</p><p>å…¶å®è¿™æ ·çš„ä¸€ä¸ªå¼•ç”¨å…³ç³»ï¼Œå°±è¢«ç§°ä¸ºå¼ºå¼•ç”¨</p><h4 id="2-æ•´ä½“æ¶æ„"><a href="#2-æ•´ä½“æ¶æ„" class="headerlink" title="2 æ•´ä½“æ¶æ„"></a>2 æ•´ä½“æ¶æ„</h4><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200323155120778.png" alt="image-20200323155120778"></p><h4 id="3-å¼ºå¼•ç”¨"><a href="#3-å¼ºå¼•ç”¨" class="headerlink" title="3 å¼ºå¼•ç”¨"></a>3 å¼ºå¼•ç”¨</h4><p>å½“å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼ŒJVMå¼€å§‹åƒåœ¾å›æ”¶ï¼Œå¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œå°±ç®—æ˜¯å‡ºç°äº†OOMä¹Ÿä¸ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œæ‰“æ­»ä¹Ÿä¸å›æ”¶~ï¼</p><p>å¼ºå¼•ç”¨æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰ä¸€ä¸ªå¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾æ”¶é›†å™¨ä¸ä¼šç¢°è¿™ç§å¯¹è±¡ã€‚åœ¨Javaä¸­æœ€å¸¸è§çš„å°±æ˜¯å¼ºå¼•ç”¨ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å˜é‡å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«å¼ºå¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºå¯è¾¾çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸å¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„ï¼Œå³ä½¿è¯¥å¯¹è±¡ä»¥åæ°¸è¿œéƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼ŒJVMä¹Ÿä¸ä¼šå›æ”¶ï¼Œå› æ­¤å¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><p>å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨äºæˆ–è€…æ˜¾ç¤ºåœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸ºnullï¼Œä¸€èˆ¬å¯ä»¥è®¤ä¸ºå°±æ˜¯å¯ä»¥è¢«åƒåœ¾æ”¶é›†çš„äº†ï¼ˆå½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾å›æ”¶ç­–ç•¥ï¼‰</p><p>å¼ºå¼•ç”¨å°ä¾‹å­ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å¼ºå¼•ç”¨</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrongReferenceDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// è¿™æ ·å®šä¹‰çš„é»˜è®¤å°±æ˜¯å¼ºåº”ç”¨</span>        Object obj1 = <span class="hljs-keyword">new</span> Object();        <span class="hljs-comment">// ä½¿ç”¨ç¬¬äºŒä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘åˆšåˆšåˆ›å»ºçš„Objectå¯¹è±¡</span>        Object obj2 = obj1;        <span class="hljs-comment">// ç½®ç©º</span>        obj1 = <span class="hljs-keyword">null</span>;        <span class="hljs-comment">// åƒåœ¾å›æ”¶</span>        System.gc();        System.out.println(obj1);        System.out.println(obj2);    &#125;&#125;</code></pre></div><p>è¾“å‡ºç»“æœæˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼Œå³ä½¿ obj1 è¢«è®¾ç½®æˆäº†nullï¼Œç„¶åè°ƒç”¨gcè¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰å›æ”¶å®ä¾‹å‡ºæ¥çš„å¯¹è±¡ï¼Œobj2è¿˜æ˜¯èƒ½å¤ŸæŒ‡å‘è¯¥åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´åƒåœ¾å›æ”¶å™¨ï¼Œå¹¶æ²¡æœ‰å°†è¯¥å¯¹è±¡è¿›è¡Œåƒåœ¾å›æ”¶</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">null</span>java.lang.Object@14ae5a5</code></pre></div><h4 id="4-è½¯å¼•ç”¨"><a href="#4-è½¯å¼•ç”¨" class="headerlink" title="4 è½¯å¼•ç”¨"></a>4 è½¯å¼•ç”¨</h4><p>è½¯å¼•ç”¨æ˜¯ä¸€ç§ç›¸å¯¹å¼±åŒ–äº†ä¸€äº›çš„å¼•ç”¨ï¼Œéœ€è¦ç”¨Java.lang.ref.SoftReferenceç±»æ¥å®ç°ï¼Œå¯ä»¥è®©å¯¹è±¡è±å…ä¸€äº›åƒåœ¾æ”¶é›†ï¼Œå¯¹äºåªæœ‰è½¯å¼•ç”¨çš„å¯¹è±¡æ¥è®²ï¼š</p><ul><li>å½“ç³»ç»Ÿå†…å­˜å……è¶³æ—¶ï¼Œå®ƒä¸ä¼šè¢«å›æ”¶</li><li>å½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œå®ƒä¼šè¢«å›æ”¶</li></ul><p>è½¯å¼•ç”¨é€šå¸¸åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„ç¨‹åºä¸­ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±ç”¨åˆ°äº†è½¯å¼•ç”¨ï¼Œå†…å­˜å¤Ÿç”¨ çš„æ—¶å€™å°±ä¿ç•™ï¼Œä¸å¤Ÿç”¨å°±å›æ”¶</p><p>å…·ä½“ä½¿ç”¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * è½¯å¼•ç”¨</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SoftReferenceDemo</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å†…å­˜å¤Ÿç”¨çš„æ—¶å€™</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">softRefMemoryEnough</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¼ºåº”ç”¨</span>        Object o1 = <span class="hljs-keyword">new</span> Object();        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè½¯å¼•ç”¨</span>        SoftReference&lt;Object&gt; softReference = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(o1);        System.out.println(o1);        System.out.println(softReference.get());        o1 = <span class="hljs-keyword">null</span>;        <span class="hljs-comment">// æ‰‹åŠ¨GC</span>        System.gc();        System.out.println(o1);        System.out.println(softReference.get());    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * JVMé…ç½®ï¼Œæ•…æ„äº§ç”Ÿå¤§å¯¹è±¡å¹¶é…ç½®å°çš„å†…å­˜ï¼Œè®©å®ƒçš„å†…å­˜ä¸å¤Ÿç”¨äº†å¯¼è‡´OOMï¼Œçœ‹è½¯å¼•ç”¨çš„å›æ”¶æƒ…å†µ</span><span class="hljs-comment">     * -Xms5m -Xmx5m -XX:+PrintGCDetails</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">softRefMemoryNoEnough</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;========================&quot;</span>);        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¼ºåº”ç”¨</span>        Object o1 = <span class="hljs-keyword">new</span> Object();        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè½¯å¼•ç”¨</span>        SoftReference&lt;Object&gt; softReference = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(o1);        System.out.println(o1);        System.out.println(softReference.get());        o1 = <span class="hljs-keyword">null</span>;        <span class="hljs-comment">// æ¨¡æ‹ŸOOMè‡ªåŠ¨GC</span>        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ›å»º30Mçš„å¤§å¯¹è±¡</span>            <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">30</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            System.out.println(o1);            System.out.println(softReference.get());        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        softRefMemoryEnough();        softRefMemoryNoEnough();    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬å†™äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å†…å­˜å¤Ÿç”¨çš„æ—¶å€™ï¼Œä¸€ä¸ªæ˜¯å†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™</p><p>æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹å†…å­˜å¤Ÿç”¨çš„æ—¶å€™ï¼Œé¦–å…ˆè¾“å‡ºçš„æ˜¯ o1 å’Œ è½¯å¼•ç”¨çš„ softReferenceï¼Œæˆ‘ä»¬éƒ½èƒ½å¤Ÿçœ‹åˆ°å€¼</p><p>ç„¶åæˆ‘ä»¬æŠŠo1è®¾ç½®ä¸ºnullï¼Œæ‰§è¡Œæ‰‹åŠ¨GCåï¼Œæˆ‘ä»¬å‘ç°softReferenceçš„å€¼è¿˜å­˜åœ¨ï¼Œè¯´æ˜å†…å­˜å……è¶³çš„æ—¶å€™ï¼Œè½¯å¼•ç”¨çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶</p><div class="code-wrapper"><pre><code class="hljs java">java.lang.Object@14ae5a5java.lang.Object@14ae5a5[GC (System.gc()) [PSYoungGen: 1396K-&gt;504K(1536K)] 1504K-&gt;732K(5632K), <span class="hljs-number">0.0007842</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] [<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(System.gc()</span>) [PSYoungGen: 504K-&gt;0<span class="hljs-title">K</span><span class="hljs-params">(1536K)</span>] [ParOldGen: 228K-&gt;651<span class="hljs-title">K</span><span class="hljs-params">(4096K)</span>] 732K-&gt;651<span class="hljs-title">K</span><span class="hljs-params">(5632K)</span>, [Metaspace: 3480K-&gt;3480<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0058450 secs] [Times: user</span>=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] <span class="hljs-keyword">null</span>java.lang.Object@14ae5a5</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬çœ‹å½“å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†JVMå¯åŠ¨å‚æ•°é…ç½®ï¼Œç»™åˆå§‹åŒ–å †å†…å­˜ä¸º5M</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms5m -Xmx5m -XX:+PrintGCDetails</span></code></pre></div><p>ä½†æ˜¯åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª30Mçš„å¤§å¯¹è±¡</p><div class="code-wrapper"><pre><code class="hljs arduino"><span class="hljs-comment">// åˆ›å»º30Mçš„å¤§å¯¹è±¡</span><span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">30</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];</code></pre></div><p>è¿™å°±å¿…ç„¶ä¼šè§¦å‘åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸­é—´å‡ºç°çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ï¼Œæœ€åçœ‹ç»“æœæˆ‘ä»¬å‘ç°ï¼Œo1 å’Œ softReferenceéƒ½è¢«å›æ”¶äº†ï¼Œå› æ­¤è¯´æ˜ï¼Œè½¯å¼•ç”¨åœ¨å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å›æ”¶</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">Object</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">Object</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">31</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">160</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1536</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">682</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">811</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003603</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">160</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">96</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1536</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">811</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">747</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0006385</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">96</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1536</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">651</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">646</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4096</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">747</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">646</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3488</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3488</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0067976</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1536</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">646</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">646</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0004024</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1536</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">646</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">627</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4096</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">646</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">627</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3488</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3488</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0065506</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-variable">null</span><span class="hljs-variable">null</span></code></pre></div><h4 id="5-å¼±å¼•ç”¨"><a href="#5-å¼±å¼•ç”¨" class="headerlink" title="5 å¼±å¼•ç”¨"></a>5 å¼±å¼•ç”¨</h4><p>ä¸ç®¡å†…å­˜æ˜¯å¦å¤Ÿï¼Œåªè¦æœ‰GCæ“ä½œå°±ä¼šè¿›è¡Œå›æ”¶</p><p>å¼±å¼•ç”¨éœ€è¦ç”¨ <code>java.lang.ref.WeakReference</code> ç±»æ¥å®ç°ï¼Œå®ƒæ¯”è½¯å¼•ç”¨ç”Ÿå­˜æœŸæ›´çŸ­</p><p>å¯¹äºåªæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ¥è¯´ï¼Œåªè¦åƒåœ¾å›æ”¶æœºåˆ¶ä¸€è¿è¡Œï¼Œä¸ç®¡JVMçš„å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶è¯¥å¯¹è±¡å ç”¨çš„ç©ºé—´ã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å¼±å¼•ç”¨</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WeakReferenceDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Object o1 = <span class="hljs-keyword">new</span> Object();        WeakReference&lt;Object&gt; weakReference = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(o1);        System.out.println(o1);        System.out.println(weakReference.get());        o1 = <span class="hljs-keyword">null</span>;        System.gc();        System.out.println(o1);        System.out.println(weakReference.get());    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬çœ‹ç»“æœï¼Œèƒ½å¤Ÿå‘ç°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åˆ¶é€ å‡ºOOMå†…å­˜æº¢å‡ºï¼Œè€Œåªæ˜¯è°ƒç”¨äº†ä¸€ä¸‹GCæ“ä½œï¼Œåƒåœ¾å›æ”¶å°±æŠŠå®ƒç»™æ”¶é›†äº†</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">Object</span><span class="hljs-operator">@</span><span class="hljs-number">14</span><span class="hljs-variable">ae5a5</span><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">Object</span><span class="hljs-operator">@</span><span class="hljs-number">14</span><span class="hljs-variable">ae5a5</span><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">System</span><span class="hljs-operator">.</span><span class="hljs-variable">gc</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">5246</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">76288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">5246</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">251392</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0008236</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">System</span><span class="hljs-operator">.</span><span class="hljs-variable">gc</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">808</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">76288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">8</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">675</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">175104</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">816</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">675</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">251392</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3494</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3494</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0035953</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-variable">null</span><span class="hljs-variable">null</span></code></pre></div><h4 id="6-è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä½¿ç”¨åœºæ™¯"><a href="#6-è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="6 è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä½¿ç”¨åœºæ™¯"></a>6 è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä½¿ç”¨åœºæ™¯</h4><p>åœºæ™¯ï¼šå‡å¦‚æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦è¯»å–å¤§é‡çš„æœ¬åœ°å›¾ç‰‡</p><ul><li>å¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½</li><li>å¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œåˆå¯èƒ½é€ æˆå†…å­˜æº¢å‡º</li></ul><p>æ­¤æ—¶ä½¿ç”¨è½¯å¼•ç”¨å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜</p><p>è®¾è®¡æ€è·¯ï¼šä½¿ç”¨HashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡æ‰€å çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆåœ°é¿å…äº†OOMçš„é—®é¢˜</p><div class="code-wrapper"><pre><code class="hljs java">Map&lt;String, SoftReference&lt;String&gt;&gt; imageCache = <span class="hljs-keyword">new</span> HashMap&lt;String, SoftReference&lt;Bitmap&gt;&gt;();</code></pre></div><h5 id="WeakHashMapæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#WeakHashMapæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="WeakHashMapæ˜¯ä»€ä¹ˆï¼Ÿ"></a>WeakHashMapæ˜¯ä»€ä¹ˆï¼Ÿ</h5><p>æ¯”å¦‚ä¸€äº›å¸¸å¸¸å’Œåº•å±‚æ‰“äº¤é“çš„ï¼Œmybatisç­‰ï¼Œåº•å±‚éƒ½åº”ç”¨åˆ°äº†WeakHashMap</p><p>WeakHashMapå’ŒHashMapç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒçš„Keyæ˜¯ä½¿ç”¨äº†å¼±å¼•ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰§è¡ŒGCçš„æ—¶å€™ï¼ŒHashMapä¸­çš„keyä¼šè¿›è¡Œå›æ”¶ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä¾‹å­æ¥æµ‹è¯•ä¸€ä¸‹</p><p>æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯æ™®é€šçš„HashMapæ–¹æ³•</p><p>æˆ‘ä»¬è¾“å…¥ä¸€ä¸ªKey-Valueé”®å€¼å¯¹ï¼Œç„¶åè®©å®ƒçš„keyç½®ç©ºï¼Œç„¶ååœ¨æŸ¥çœ‹ç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myHashMap</span><span class="hljs-params">()</span> </span>&#123;    Map&lt;Integer, String&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();    Integer key = <span class="hljs-keyword">new</span> Integer(<span class="hljs-number">1</span>);    String value = <span class="hljs-string">&quot;HashMap&quot;</span>;    map.put(key, value);    System.out.println(map);    key = <span class="hljs-keyword">null</span>;    System.gc();    System.out.println(map);&#125;</code></pre></div><p>ç¬¬äºŒä¸ªæ˜¯ä½¿ç”¨äº†WeakHashMapï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * WeakHashMap</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WeakHashMapDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        myHashMap();        System.out.println(<span class="hljs-string">&quot;==========&quot;</span>);        myWeakHashMap();    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myHashMap</span><span class="hljs-params">()</span> </span>&#123;        Map&lt;Integer, String&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        Integer key = <span class="hljs-keyword">new</span> Integer(<span class="hljs-number">1</span>);        String value = <span class="hljs-string">&quot;HashMap&quot;</span>;        map.put(key, value);        System.out.println(map);        key = <span class="hljs-keyword">null</span>;        System.gc();        System.out.println(map);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myWeakHashMap</span><span class="hljs-params">()</span> </span>&#123;        Map&lt;Integer, String&gt; map = <span class="hljs-keyword">new</span> WeakHashMap&lt;&gt;();        Integer key = <span class="hljs-keyword">new</span> Integer(<span class="hljs-number">1</span>);        String value = <span class="hljs-string">&quot;WeakHashMap&quot;</span>;        map.put(key, value);        System.out.println(map);        key = <span class="hljs-keyword">null</span>;        System.gc();        System.out.println(map);    &#125;&#125;</code></pre></div><p>æœ€åè¾“å‡ºç»“æœä¸ºï¼š</p><div class="code-wrapper"><pre><code class="hljs java">&#123;<span class="hljs-number">1</span>=HashMap&#125;&#123;<span class="hljs-number">1</span>=HashMap&#125;==========&#123;<span class="hljs-number">1</span>=WeakHashMap&#125;&#123;&#125;</code></pre></div><p>ä»è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äºæ™®é€šçš„HashMapæ¥è¯´ï¼Œkeyç½®ç©ºå¹¶ä¸ä¼šå½±å“ï¼ŒHashMapçš„é”®å€¼å¯¹ï¼Œå› ä¸ºè¿™ä¸ªå±äºå¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚</p><p>ä½†æ˜¯WeakHashMapï¼Œåœ¨è¿›è¡ŒGCæ“ä½œåï¼Œå¼±å¼•ç”¨çš„å°±ä¼šè¢«å›æ”¶</p><h4 id="7-è™šå¼•ç”¨"><a href="#7-è™šå¼•ç”¨" class="headerlink" title="7 è™šå¼•ç”¨"></a>7 è™šå¼•ç”¨</h4><h5 id="7-1-æ¦‚å¿µ"><a href="#7-1-æ¦‚å¿µ" class="headerlink" title="7.1 æ¦‚å¿µ"></a>7.1 æ¦‚å¿µ</h5><p>è™šå¼•ç”¨åˆç§°ä¸ºå¹½çµå¼•ç”¨ï¼Œéœ€è¦<code>java.lang.ref.PhantomReference</code> ç±»æ¥å®ç°</p><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½¢åŒè™šè®¾ï¼Œä¸å…¶ä»–å‡ ç§å¼•ç”¨éƒ½ä¸åŒï¼Œè™šå¼•ç”¨å¹¶ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œå®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ä¹Ÿä¸èƒ½é€šè¿‡å®ƒè®¿é—®å¯¹è±¡ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ReferenceQueueè”åˆä½¿ç”¨ã€‚</p><p>è™šå¼•ç”¨çš„ä¸»è¦ä½œç”¨å’Œè·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€ï¼Œä»…ä»…æ˜¯æä¾›ä¸€ç§ç¡®ä¿å¯¹è±¡è¢«finalizeä»¥åï¼ŒåšæŸäº›äº‹æƒ…çš„æœºåˆ¶ã€‚</p><p>PhantomReferenceçš„getæ–¹æ³•æ€»æ˜¯è¿”å›nullï¼Œå› æ­¤æ— æ³•è®¿é—®å¯¹è±¡çš„å¼•ç”¨å¯¹è±¡ã€‚å…¶æ„ä¹‰åœ¨äºè¯´æ˜ä¸€ä¸ªå¯¹è±¡å·²ç»è¿›å…¥finalizationé˜¶æ®µï¼Œå¯ä»¥è¢«gcå›æ”¶ï¼Œç”¨æ¥å®ç°æ¯”finalizationæœºåˆ¶æ›´çµæ´»çš„å›æ”¶æ“ä½œ</p><p>æ¢å¥è¯è¯´ï¼Œè®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶çš„æ—¶å€™ï¼Œæ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥æˆ–è€…åç»­æ·»åŠ è¿›ä¸€æ­¥çš„å¤„ç†ï¼ŒJavaæŠ€æœ¯å…è®¸ä½¿ç”¨finalize()æ–¹æ³•åœ¨åƒåœ¾æ”¶é›†å™¨å°†å¯¹è±¡ä»å†…å­˜ä¸­æ¸…é™¤å‡ºå»ä¹‹å‰ï¼Œåšå¿…è¦çš„æ¸…ç†å·¥ä½œ</p><p>è¿™ä¸ªå°±ç›¸å½“äºSpring AOPé‡Œé¢çš„åç½®é€šçŸ¥</p><h5 id="7-2-åœºæ™¯"><a href="#7-2-åœºæ™¯" class="headerlink" title="7.2 åœºæ™¯"></a>7.2 åœºæ™¯</h5><p>ä¸€èˆ¬ç”¨äºåœ¨å›æ”¶æ—¶å€™åšé€šçŸ¥ç›¸å…³æ“ä½œ</p><h4 id="8-å¼•ç”¨é˜Ÿåˆ—-ReferenceQueue"><a href="#8-å¼•ç”¨é˜Ÿåˆ—-ReferenceQueue" class="headerlink" title="8 å¼•ç”¨é˜Ÿåˆ— ReferenceQueue"></a>8 å¼•ç”¨é˜Ÿåˆ— ReferenceQueue</h4><p>è½¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨ï¼Œè™šå¼•ç”¨åœ¨å›æ”¶ä¹‹å‰ï¼Œéœ€è¦åœ¨å¼•ç”¨é˜Ÿåˆ—ä¿å­˜ä¸€ä¸‹</p><p>æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„å¼±å¼•ç”¨æˆ–è€…è™šå¼•ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—</p><div class="code-wrapper"><pre><code class="hljs java">Object o1 = <span class="hljs-keyword">new</span> Object();<span class="hljs-comment">// åˆ›å»ºå¼•ç”¨é˜Ÿåˆ—</span>ReferenceQueue&lt;Object&gt; referenceQueue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;&gt;();<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨</span>WeakReference&lt;Object&gt; weakReference = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(o1, referenceQueue);</code></pre></div><p>é‚£ä¹ˆåœ¨è¿›è¡ŒGCå›æ”¶çš„æ—¶å€™ï¼Œå¼±å¼•ç”¨å’Œè™šå¼•ç”¨çš„å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ï¼Œä½†æ˜¯åœ¨å›æ”¶ä¹‹å‰ï¼Œå®ƒä¼šè¢«é€è‡³å¼•ç”¨é˜Ÿåˆ—ä¸­</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * è™šå¼•ç”¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhantomReferenceDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Object o1 = <span class="hljs-keyword">new</span> Object();        <span class="hljs-comment">// åˆ›å»ºå¼•ç”¨é˜Ÿåˆ—</span>        ReferenceQueue&lt;Object&gt; referenceQueue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;&gt;();        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨</span>        WeakReference&lt;Object&gt; weakReference = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(o1, referenceQueue);        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨</span><span class="hljs-comment">//        PhantomReference&lt;Object&gt; weakReference = new PhantomReference&lt;&gt;(o1, referenceQueue);</span>        System.out.println(o1);        System.out.println(weakReference.get());        <span class="hljs-comment">// å–é˜Ÿåˆ—ä¸­çš„å†…å®¹</span>        System.out.println(referenceQueue.poll());        o1 = <span class="hljs-keyword">null</span>;        System.gc();        System.out.println(<span class="hljs-string">&quot;æ‰§è¡ŒGCæ“ä½œ&quot;</span>);        <span class="hljs-keyword">try</span> &#123;            TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;            e.printStackTrace();        &#125;        System.out.println(o1);        System.out.println(weakReference.get());        <span class="hljs-comment">// å–é˜Ÿåˆ—ä¸­çš„å†…å®¹</span>        System.out.println(referenceQueue.poll());    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs angelscript">java.lang.<span class="hljs-symbol">Object@</span><span class="hljs-number">14</span>ae5a5java.lang.<span class="hljs-symbol">Object@</span><span class="hljs-number">14</span>ae5a5<span class="hljs-literal">null</span>æ‰§è¡ŒGCæ“ä½œ<span class="hljs-literal">null</span><span class="hljs-literal">null</span>java.lang.<span class="hljs-built_in">ref</span>.<span class="hljs-symbol">WeakReference@</span><span class="hljs-number">7f</span>3124</code></pre></div><p>ä»è¿™é‡Œæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œåœ¨è¿›è¡Œåƒåœ¾å›æ”¶åï¼Œæˆ‘ä»¬å¼±å¼•ç”¨å¯¹è±¡ï¼Œä¹Ÿè¢«è®¾ç½®æˆnullï¼Œä½†æ˜¯åœ¨é˜Ÿåˆ—ä¸­è¿˜èƒ½å¤Ÿå¯¼å‡ºè¯¥å¼•ç”¨çš„å®ä¾‹ï¼Œè¿™å°±è¯´æ˜åœ¨å›æ”¶ä¹‹å‰ï¼Œè¯¥å¼±å¼•ç”¨çš„å®ä¾‹è¢«æ”¾ç½®å¼•ç”¨é˜Ÿåˆ—ä¸­äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•ç”¨é˜Ÿåˆ—è¿›è¡Œä¸€äº›åç½®æ“ä½œ</p><h4 id="9-GCRootså’Œå››å¤§å¼•ç”¨å°æ€»ç»“"><a href="#9-GCRootså’Œå››å¤§å¼•ç”¨å°æ€»ç»“" class="headerlink" title="9 GCRootså’Œå››å¤§å¼•ç”¨å°æ€»ç»“"></a>9 GCRootså’Œå››å¤§å¼•ç”¨å°æ€»ç»“</h4><ul><li><p>çº¢è‰²éƒ¨åˆ†åœ¨åƒåœ¾å›æ”¶ä¹‹å¤–ï¼Œä¹Ÿå°±æ˜¯å¼ºå¼•ç”¨çš„</p></li><li><p>è“è‰²éƒ¨åˆ†ï¼šå±äºè½¯å¼•ç”¨ï¼Œåœ¨å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œæ‰å›æ”¶</p></li><li><p>è™šå¼•ç”¨å’Œå¼±å¼•ç”¨ï¼šæ¯æ¬¡åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œéƒ½ä¼šè¢«å¹²æ‰ï¼Œä½†æ˜¯å®ƒåœ¨å¹²æ‰ä¹‹å‰è¿˜ä¼šå­˜åœ¨å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•ç”¨é˜Ÿåˆ—è¿›è¡Œä¸€äº›é€šçŸ¥æœºåˆ¶</p></li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200324123829937.png" alt="image-20200324123829937"></p><h3 id="2-4-Javaå†…å­˜æº¢å‡ºOOM"><a href="#2-4-Javaå†…å­˜æº¢å‡ºOOM" class="headerlink" title="2.4 Javaå†…å­˜æº¢å‡ºOOM"></a>2.4 Javaå†…å­˜æº¢å‡ºOOM</h3><h4 id="1-ç»å…¸é”™è¯¯"><a href="#1-ç»å…¸é”™è¯¯" class="headerlink" title="1 ç»å…¸é”™è¯¯"></a>1 ç»å…¸é”™è¯¯</h4><p>JVMä¸­å¸¸è§çš„ä¸¤ä¸ªé”™è¯¯</p><p>StackoverFlowError ï¼šæ ˆæº¢å‡º</p><p>OutofMemoryError: java heap spaceï¼šå †æº¢å‡º</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹çš„é”™è¯¯</p><ul><li>java.lang.StackOverflowError</li><li>java.lang.OutOfMemoryErrorï¼šjava heap space</li><li>java.lang.OutOfMemoryErrorï¼šGC overhead limit exceeeded</li><li>java.lang.OutOfMemoryErrorï¼šDirect buffer memory</li><li>java.lang.OutOfMemoryErrorï¼šunable to create new native thread</li><li>java.lang.OutOfMemoryErrorï¼šMetaspace</li></ul><h4 id="2-æ¶æ„"><a href="#2-æ¶æ„" class="headerlink" title="2 æ¶æ„"></a>2 æ¶æ„</h4><p>OutOfMemoryErrorå’ŒStackOverflowErroræ˜¯å±äºErrorï¼Œä¸æ˜¯Exception</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200324144802828.png" alt="image-20200324144802828"></p><h4 id="3-StackoverFlowError"><a href="#3-StackoverFlowError" class="headerlink" title="3 StackoverFlowError"></a>3 StackoverFlowError</h4><p>å †æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬æœ‰æœ€ç®€å•çš„ä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œå°±ä¼šé€ æˆå †æ ˆæº¢å‡ºï¼Œä¹Ÿå°±æ˜¯æ·±åº¦çš„æ–¹æ³•è°ƒç”¨</p><p>æ ˆä¸€èˆ¬æ˜¯512Kï¼Œä¸æ–­çš„æ·±åº¦è°ƒç”¨ï¼Œç›´åˆ°æ ˆè¢«æ’‘ç ´</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackOverflowErrorDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        stackOverflowError();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ ˆä¸€èˆ¬æ˜¯512Kï¼Œä¸æ–­çš„æ·±åº¦è°ƒç”¨ï¼Œç›´åˆ°æ ˆè¢«æ’‘ç ´</span><span class="hljs-comment">     * Exception in thread &quot;main&quot; java.lang.StackOverflowError</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stackOverflowError</span><span class="hljs-params">()</span> </span>&#123;        stackOverflowError();    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java">Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.StackOverflowErrorat com.moxi.interview.study.oom.StackOverflowErrorDemo.stackOverflowError(StackOverflowErrorDemo.java:<span class="hljs-number">17</span>)</code></pre></div><h4 id="4-OutOfMemoryError"><a href="#4-OutOfMemoryError" class="headerlink" title="4 OutOfMemoryError"></a>4 OutOfMemoryError</h4><h5 id="4-1-java-heap-space"><a href="#4-1-java-heap-space" class="headerlink" title="4.1 java heap space"></a>4.1 java heap space</h5><p>åˆ›å»ºäº†å¾ˆå¤šå¯¹è±¡ï¼Œå¯¼è‡´å †ç©ºé—´ä¸å¤Ÿå­˜å‚¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Javaå †å†…å­˜ä¸è¶³</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaHeapSpaceDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// å †ç©ºé—´çš„å¤§å° -Xms10m -Xmx10m</span>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª 80Mçš„å­—èŠ‚æ•°ç»„</span>        <span class="hljs-keyword">byte</span> [] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">80</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª80Mçš„æ•°ç»„ï¼Œä¼šç›´æ¥å‡ºç°Java heap space</p><div class="code-wrapper"><pre><code class="hljs java">Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space</code></pre></div><h5 id="4-2-GC-overhead-limit-exceeded"><a href="#4-2-GC-overhead-limit-exceeded" class="headerlink" title="4.2 GC overhead limit exceeded"></a>4.2 GC overhead limit exceeded</h5><p>GCå›æ”¶æ—¶é—´è¿‡é•¿æ—¶ä¼šæŠ›å‡ºOutOfMemoryErrorï¼Œè¿‡é•¿çš„å®šä¹‰æ˜¯ï¼Œè¶…è¿‡äº†98%çš„æ—¶é—´ç”¨æ¥åšGCï¼Œå¹¶ä¸”å›æ”¶äº†ä¸åˆ°2%çš„å †å†…å­˜</p><p>è¿ç»­å¤šæ¬¡GCéƒ½åªå›æ”¶äº†ä¸åˆ°2%çš„æç«¯æƒ…å†µä¸‹ï¼Œæ‰ä¼šæŠ›å‡ºã€‚å‡è®¾ä¸æŠ›å‡ºGC overhead limit é”™è¯¯ä¼šé€ æˆä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><p>é‚£å°±æ˜¯GCæ¸…ç†çš„è¿™ç‚¹å†…å­˜å¾ˆå¿«ä¼šå†æ¬¡è¢«å¡«æ»¡ï¼Œè¿«ä½¿GCå†æ¬¡æ‰§è¡Œï¼Œè¿™æ ·å°±å½¢æˆäº†æ¶æ€§å¾ªç¯ï¼ŒCPUçš„ä½¿ç”¨ç‡ä¸€ç›´éƒ½æ˜¯100%ï¼Œè€ŒGCå´æ²¡æœ‰ä»»ä½•æˆæœã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200324150646260.png" alt="image-20200324150646260"></p><p>ä»£ç æ¼”ç¤ºï¼š</p><p>ä¸ºäº†æ›´å¿«çš„è¾¾åˆ°æ•ˆæœï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è®¾ç½®JVMå¯åŠ¨å‚æ•°</p><div class="code-wrapper"><pre><code class="hljs java">-Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m</code></pre></div><p>è¿™ä¸ªå¼‚å¸¸å‡ºç°çš„æ­¥éª¤å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸æ–­çš„åƒlistä¸­æ’å…¥Stringå¯¹è±¡ï¼Œç›´åˆ°å¯åŠ¨GCå›æ”¶</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * GC å›æ”¶è¶…æ—¶</span><span class="hljs-comment"> * JVMå‚æ•°é…ç½®: -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GCOverheadLimitDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;        List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;                list.add(String.valueOf(++i).intern());            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            System.out.println(<span class="hljs-string">&quot;***************i:&quot;</span> + i);            e.printStackTrace();            <span class="hljs-keyword">throw</span> e;        &#125; <span class="hljs-keyword">finally</span> &#123;        &#125;    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java">[<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Ergonomics)</span> [PSYoungGen: 2047K-&gt;2047<span class="hljs-title">K</span><span class="hljs-params">(2560K)</span>] [ParOldGen: 7106K-&gt;7106<span class="hljs-title">K</span><span class="hljs-params">(7168K)</span>] 9154K-&gt;9154<span class="hljs-title">K</span><span class="hljs-params">(9728K)</span>, [Metaspace: 3504K-&gt;3504<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0311093 secs] [Times: user</span>=<span class="hljs-number">0.13</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.03</span> secs] [<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Ergonomics)</span> [PSYoungGen: 2047K-&gt;0<span class="hljs-title">K</span><span class="hljs-params">(2560K)</span>] [ParOldGen: 7136K-&gt;667<span class="hljs-title">K</span><span class="hljs-params">(7168K)</span>] 9184K-&gt;667<span class="hljs-title">K</span><span class="hljs-params">(9728K)</span>, [Metaspace: 3540K-&gt;3540<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0058093 secs] [Times: user</span>=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] Heap PSYoungGen      total 2560K, used 114K [<span class="hljs-number">0x00000000ffd00000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)  eden space 2048K, <span class="hljs-number">5</span>% used [<span class="hljs-number">0x00000000ffd00000</span>,<span class="hljs-number">0x00000000ffd1c878</span>,<span class="hljs-number">0x00000000fff00000</span>)  from space 512K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000fff80000</span>,<span class="hljs-number">0x00000000fff80000</span>,<span class="hljs-number">0x0000000100000000</span>)  to   space 512K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000fff00000</span>,<span class="hljs-number">0x00000000fff00000</span>,<span class="hljs-number">0x00000000fff80000</span>) ParOldGen       total 7168K, used 667K [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ffd00000</span>, <span class="hljs-number">0x00000000ffd00000</span>)  object space 7168K, <span class="hljs-number">9</span>% used [<span class="hljs-number">0x00000000ff600000</span>,<span class="hljs-number">0x00000000ff6a6ff8</span>,<span class="hljs-number">0x00000000ffd00000</span>) Metaspace       used 3605K, capacity 4540K, committed 4864K, reserved 1056768K  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 399<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 428<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><span class="hljs-class">  </span><span class="hljs-class"> </span>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: GC overhead limit exceededat java.lang.Integer.toString(Integer.java:<span class="hljs-number">403</span>)at java.lang.String.valueOf(String.java:<span class="hljs-number">3099</span>)at com.moxi.interview.study.oom.GCOverheadLimitDemo.main(GCOverheadLimitDemo.java:<span class="hljs-number">18</span>)</code></pre></div><p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ° å¤šæ¬¡Full GCï¼Œå¹¶æ²¡æœ‰æ¸…ç†å‡ºç©ºé—´ï¼Œåœ¨å¤šæ¬¡æ‰§è¡ŒGCæ“ä½œåï¼Œå°±æŠ›å‡ºå¼‚å¸¸ GC overhead limit</p><h5 id="4-3-Direct-buffer-memory"><a href="#4-3-Direct-buffer-memory" class="headerlink" title="4.3 Direct buffer memory"></a>4.3 Direct buffer memory</h5><p>Netty + NIOï¼šè¿™æ˜¯ç”±äºNIOå¼•èµ·çš„</p><p>å†™NIOç¨‹åºçš„æ—¶å€™ç»å¸¸ä¼šä½¿ç”¨ByteBufferæ¥è¯»å–æˆ–å†™å…¥æ•°æ®ï¼Œè¿™æ˜¯ä¸€ç§åŸºäºé€šé“(Channel) ä¸ ç¼“å†²åŒº(Buffer)çš„I/Oæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨Javaå †é‡Œé¢çš„DirectByteBufferå¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨Javaå †å’ŒNativeå †ä¸­æ¥å›å¤åˆ¶æ•°æ®ã€‚</p><p>ByteBuffer.allocate(capability)ï¼šç¬¬ä¸€ç§æ–¹å¼æ˜¯åˆ†é…JVMå †å†…å­˜ï¼Œå±äºGCç®¡è¾–èŒƒå›´ï¼Œç”±äºéœ€è¦æ‹·è´æ‰€ä»¥é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢</p><p>ByteBuffer.allocteDirect(capability)ï¼šç¬¬äºŒç§æ–¹å¼æ˜¯åˆ†é…OSæœ¬åœ°å†…å­˜ï¼Œä¸å±äºGCç®¡è¾–èŒƒå›´ï¼Œç”±äºä¸éœ€è¦å†…å­˜çš„æ‹·è´ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å¯¹è¾ƒå¿«</p><p>ä½†å¦‚æœä¸æ–­åˆ†é…æœ¬åœ°å†…å­˜ï¼Œå †å†…å­˜å¾ˆå°‘ä½¿ç”¨ï¼Œé‚£ä¹ˆJVMå°±ä¸éœ€è¦æ‰§è¡ŒGCï¼ŒDirectByteBufferå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å€™æ€¼å†…å­˜å……è¶³ï¼Œä½†æœ¬åœ°å†…å­˜å¯èƒ½å·²ç»ä½¿ç”¨å…‰äº†ï¼Œå†æ¬¡å°è¯•åˆ†é…æœ¬åœ°å†…å­˜å°±ä¼šå‡ºç°OutOfMemoryErrorï¼Œé‚£ä¹ˆç¨‹åºå°±å¥”æºƒäº†ã€‚</p><p>ä¸€å¥è¯è¯´ï¼šæœ¬åœ°å†…å­˜ä¸è¶³ï¼Œä½†æ˜¯å †å†…å­˜å……è¶³çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜</p><p>æˆ‘ä»¬ä½¿ç”¨ -XX:MaxDirectMemorySize=5m é…ç½®èƒ½ä½¿ç”¨çš„å †å¤–ç‰©ç†å†…å­˜ä¸º5M</p><div class="code-wrapper"><pre><code class="hljs java">-Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m</code></pre></div><p>ç„¶åæˆ‘ä»¬ç”³è¯·ä¸€ä¸ª6Mçš„ç©ºé—´</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// åªè®¾ç½®äº†5Mçš„ç‰©ç†å†…å­˜ä½¿ç”¨ï¼Œä½†æ˜¯å´åˆ†é… 6Mçš„ç©ºé—´</span>ByteBuffer bb = ByteBuffer.allocateDirect(<span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);</code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œè¿è¡Œå°±ä¼šå‡ºç°é—®é¢˜äº†</p><div class="code-wrapper"><pre><code class="hljs java">é…ç½®çš„maxDirectMemoryï¼š<span class="hljs-number">5.</span>0MB[GC (System.gc()) [PSYoungGen: 2030K-&gt;488K(2560K)] 2030K-&gt;796K(9728K), <span class="hljs-number">0.0008326</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] [<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(System.gc()</span>) [PSYoungGen: 488K-&gt;0<span class="hljs-title">K</span><span class="hljs-params">(2560K)</span>] [ParOldGen: 308K-&gt;712<span class="hljs-title">K</span><span class="hljs-params">(7168K)</span>] 796K-&gt;712<span class="hljs-title">K</span><span class="hljs-params">(9728K)</span>, [Metaspace: 3512K-&gt;3512<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0052052 secs] [Times: user</span>=<span class="hljs-number">0.09</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Direct buffer memoryat java.nio.Bits.reserveMemory(Bits.java:<span class="hljs-number">693</span>)at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:<span class="hljs-number">123</span>)at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:<span class="hljs-number">311</span>)at com.moxi.interview.study.oom.DIrectBufferMemoryDemo.main(DIrectBufferMemoryDemo.java:<span class="hljs-number">19</span>)</code></pre></div><h5 id="4-4-unable-to-create-new-native-thread"><a href="#4-4-unable-to-create-new-native-thread" class="headerlink" title="4.4 unable to create new native thread"></a>4.4 unable to create new native thread</h5><p>ä¸èƒ½å¤Ÿåˆ›å»ºæ›´å¤šçš„æ–°çš„çº¿ç¨‹äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ›å»ºçº¿ç¨‹çš„ä¸Šé™è¾¾åˆ°äº†</p><p>åœ¨é«˜å¹¶å‘åœºæ™¯çš„æ—¶å€™ï¼Œä¼šåº”ç”¨åˆ°</p><p>é«˜å¹¶å‘è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼Œç»å¸¸ä¼šå‡ºç°å¦‚ä¸‹å¼‚å¸¸<code>java.lang.OutOfMemoryError:unable to create new native thread</code>ï¼Œå‡†ç¡®è¯´è¯¥native threadå¼‚å¸¸ä¸å¯¹åº”çš„å¹³å°æœ‰å…³</p><p>å¯¼è‡´åŸå› ï¼š</p><ul><li>åº”ç”¨åˆ›å»ºäº†å¤ªå¤šçº¿ç¨‹ï¼Œä¸€ä¸ªåº”ç”¨è¿›ç¨‹åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¶…è¿‡ç³»ç»Ÿæ‰¿è½½æé™</li><li>æœåŠ¡å™¨å¹¶ä¸å…è®¸ä½ çš„åº”ç”¨ç¨‹åºåˆ›å»ºè¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œlinuxç³»ç»Ÿé»˜è®¤è¿è¡Œå•ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºçš„çº¿ç¨‹ä¸º1024ä¸ªï¼Œå¦‚æœåº”ç”¨åˆ›å»ºè¶…è¿‡è¿™ä¸ªæ•°é‡ï¼Œå°±ä¼šæŠ¥ <code>java.lang.OutOfMemoryError:unable to create new native thread</code></li></ul><p>è§£å†³æ–¹æ³•ï¼š</p><ol><li>æƒ³åŠæ³•é™ä½ä½ åº”ç”¨ç¨‹åºåˆ›å»ºçº¿ç¨‹çš„æ•°é‡ï¼Œåˆ†æåº”ç”¨æ˜¯å¦çœŸçš„éœ€è¦åˆ›å»ºè¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ”¹ä»£ç å°†çº¿ç¨‹æ•°é™åˆ°æœ€ä½</li><li>å¯¹äºæœ‰çš„åº”ç”¨ï¼Œç¡®å®éœ€è¦åˆ›å»ºå¾ˆå¤šçº¿ç¨‹ï¼Œè¿œè¶…è¿‡linuxç³»ç»Ÿé»˜è®¤1024ä¸ªçº¿ç¨‹é™åˆ¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹linuxæœåŠ¡å™¨é…ç½®ï¼Œæ‰©å¤§linuxé»˜è®¤é™åˆ¶</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * æ— æ³•åˆ›å»ºæ›´å¤šçš„çº¿ç¨‹</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UnableCreateNewThreadDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; ; i++) &#123;            System.out.println(<span class="hljs-string">&quot;************** i = &quot;</span> + i);            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                <span class="hljs-keyword">try</span> &#123;                    TimeUnit.SECONDS.sleep(Integer.MAX_VALUE);                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                    e.printStackTrace();                &#125;            &#125;, String.valueOf(i)).start();        &#125;    &#125;&#125;</code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå‡ºç°ä¸‹åˆ—çš„é”™è¯¯ï¼Œçº¿ç¨‹æ•°å¤§æ¦‚åœ¨ 900å¤šä¸ª</p><div class="code-wrapper"><pre><code class="hljs java">Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: unable to cerate <span class="hljs-keyword">new</span> <span class="hljs-keyword">native</span> thread</code></pre></div><p>å¦‚ä½•æŸ¥çœ‹çº¿ç¨‹æ•°</p><div class="code-wrapper"><pre><code class="hljs java">ulimit -u</code></pre></div><h5 id="4-5-Metaspace"><a href="#4-5-Metaspace" class="headerlink" title="4.5 Metaspace"></a>4.5 Metaspace</h5><p>å…ƒç©ºé—´å†…å­˜ä¸è¶³ï¼ŒMatespaceå…ƒç©ºé—´åº”ç”¨çš„æ˜¯æœ¬åœ°å†…å­˜</p><p><code>-XX:MetaspaceSize</code> çš„å¤„ç†åŒ–å¤§å°ä¸º20M</p><h6 id="å…ƒç©ºé—´æ˜¯ä»€ä¹ˆ"><a href="#å…ƒç©ºé—´æ˜¯ä»€ä¹ˆ" class="headerlink" title="å…ƒç©ºé—´æ˜¯ä»€ä¹ˆ"></a>å…ƒç©ºé—´æ˜¯ä»€ä¹ˆ</h6><p>å…ƒç©ºé—´å°±æ˜¯æˆ‘ä»¬çš„æ–¹æ³•åŒºï¼Œå­˜æ”¾çš„æ˜¯ç±»æ¨¡æ¿ï¼Œç±»ä¿¡æ¯ï¼Œå¸¸é‡æ± ç­‰</p><p>Metaspaceæ˜¯æ–¹æ³•åŒºHotSpotä¸­çš„å®ç°ï¼Œå®ƒä¸æŒä¹…ä»£æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šMetaspaceå¹¶ä¸åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œä¹Ÿå³åœ¨java8ä¸­ï¼Œclass metadataï¼ˆthe virtual machines internal presentation of Java classï¼‰ï¼Œè¢«å­˜å‚¨åœ¨å«åšMatespaceçš„native memory</p><p>æ°¸ä¹…ä»£ï¼ˆjava8åèƒŒå…ƒç©ºé—´Metaspaceå–ä»£äº†ï¼‰å­˜æ”¾äº†ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯</li><li>å¸¸é‡æ± </li><li>é™æ€å˜é‡</li><li>å³æ—¶ç¼–è¯‘åçš„ä»£ç </li></ul><p>æ¨¡æ‹ŸMetaspaceç©ºé—´æº¢å‡ºï¼Œæˆ‘ä»¬ä¸æ–­ç”Ÿæˆç±» å¾€å…ƒç©ºé—´é‡ŒçŒè¾“ï¼Œç±»å æ®çš„ç©ºé—´æ€»ä¼šè¶…è¿‡MetaspaceæŒ‡å®šçš„ç©ºé—´å¤§å°</p><h6 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h6><p>åœ¨æ¨¡æ‹Ÿå¼‚å¸¸ç”Ÿæˆæ—¶å€™ï¼Œå› ä¸ºåˆå§‹åŒ–çš„å…ƒç©ºé—´ä¸º20Mï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨JVMå‚æ•°è°ƒæ•´å…ƒç©ºé—´çš„å¤§å°ï¼Œä¸ºäº†æ›´å¥½çš„æ•ˆæœ</p><div class="code-wrapper"><pre><code class="hljs java">-XX:MetaspaceSize=8m -XX:MaxMetaspaceSize=8m</code></pre></div><p>ä»£ç å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å…ƒç©ºé—´æº¢å‡º</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetaspaceOutOfMemoryDemo</span> </span>&#123;    <span class="hljs-comment">// é™æ€ç±»</span>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OOMTest</span> </span>&#123;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> </span>&#123;        <span class="hljs-comment">// æ¨¡æ‹Ÿè®¡æ•°å¤šå°‘æ¬¡ä»¥åå‘ç”Ÿå¼‚å¸¸</span>        <span class="hljs-keyword">int</span> i =<span class="hljs-number">0</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;                i++;                <span class="hljs-comment">// ä½¿ç”¨Springçš„åŠ¨æ€å­—èŠ‚ç æŠ€æœ¯</span>                Enhancer enhancer = <span class="hljs-keyword">new</span> Enhancer();                enhancer.setSuperclass(OOMTest.class);                enhancer.setUseCache(<span class="hljs-keyword">false</span>);                enhancer.setCallback(<span class="hljs-keyword">new</span> MethodInterceptor() &#123;                    <span class="hljs-meta">@Override</span>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">intercept</span><span class="hljs-params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;                        <span class="hljs-keyword">return</span> methodProxy.invokeSuper(o, args);                    &#125;                &#125;);            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            System.out.println(<span class="hljs-string">&quot;å‘ç”Ÿå¼‚å¸¸çš„æ¬¡æ•°:&quot;</span> + i);            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;        &#125;    &#125;&#125;</code></pre></div><p>ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</p><div class="code-wrapper"><pre><code class="hljs java">å‘ç”Ÿå¼‚å¸¸çš„æ¬¡æ•°: <span class="hljs-number">201</span>java.lang.OutOfMemoryError:Metaspace</code></pre></div><h3 id="2-5-åƒåœ¾æ”¶é›†å™¨"><a href="#2-5-åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="2.5 åƒåœ¾æ”¶é›†å™¨"></a>2.5 åƒåœ¾æ”¶é›†å™¨</h3><h4 id="1-GCåƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨å…³ç³»"><a href="#1-GCåƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨å…³ç³»" class="headerlink" title="1 GCåƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨å…³ç³»"></a>1 GCåƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨å…³ç³»</h4><blockquote><p>å¤©ä¸Šé£çš„ç†å¿µï¼Œè¦æœ‰è½åœ°çš„å®ç°ï¼ˆåƒåœ¾æ”¶é›†å™¨å°±æ˜¯GCåƒåœ¾å›æ”¶ç®—æ³•çš„å®ç°ï¼‰</p><p>GCç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®ºï¼Œåƒåœ¾æ”¶é›†å™¨å°±æ˜¯ç®—æ³•çš„è½åœ°å®ç°</p></blockquote><p>GCç®—æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§</p><ul><li>å¼•ç”¨è®¡æ•°ï¼ˆå‡ ä¹ä¸ç”¨ï¼Œæ— æ³•è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼‰</li><li>å¤åˆ¶æ‹·è´ï¼ˆç”¨äºæ–°ç”Ÿä»£ï¼‰</li><li>æ ‡è®°æ¸…é™¤ï¼ˆç”¨äºè€å¹´ä»£ï¼‰</li><li>æ ‡è®°æ•´ç†ï¼ˆç”¨äºè€å¹´ä»£ï¼‰</li></ul><p>å› ä¸ºç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰å®Œç¾çš„æ”¶é›†å™¨å‡ºç°ï¼Œæ›´æ²¡æœ‰ä¸‡èƒ½çš„æ”¶é›†å™¨ï¼Œåªæ˜¯é’ˆå¯¹å…·ä½“åº”ç”¨æœ€åˆé€‚çš„æ”¶é›†å™¨ï¼Œè¿›è¡Œåˆ†ä»£æ”¶é›†ï¼ˆé‚£ä¸ªä»£ç”¨ä»€ä¹ˆæ”¶é›†å™¨ï¼‰</p><h4 id="2-å››ç§ä¸»è¦çš„åƒåœ¾æ”¶é›†å™¨"><a href="#2-å››ç§ä¸»è¦çš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="2 å››ç§ä¸»è¦çš„åƒåœ¾æ”¶é›†å™¨"></a>2 å››ç§ä¸»è¦çš„åƒåœ¾æ”¶é›†å™¨</h4><ul><li>Serialï¼šä¸²è¡Œå›æ”¶  <code>-XX:+UseSeriallGC</code></li><li>Parallelï¼šå¹¶è¡Œå›æ”¶  <code>-XX:+UseParallelGC</code></li><li>CMSï¼šå¹¶å‘æ ‡è®°æ¸…é™¤</li><li>G1</li><li>ZGCï¼šï¼ˆjava 11 å‡ºç°çš„ï¼‰</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325084453631.png" alt="image-20200325084453631"></p><h5 id="2-1-Serial"><a href="#2-1-Serial" class="headerlink" title="2.1 Serial"></a>2.1 Serial</h5><p>ä¸²è¡Œåƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¸ºå•çº¿ç¨‹ç¯å¢ƒè®¾è®¡ä¸”å€¼ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œä¼šæš‚åœæ‰€æœ‰çš„ç”¨æˆ·çº¿ç¨‹ï¼Œåªæœ‰å½“åƒåœ¾å›æ”¶å®Œæˆæ—¶ï¼Œæ‰ä¼šé‡æ–°å”¤é†’ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥ä¸é€‚åˆæœåŠ¡å™¨ç¯å¢ƒ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325085320683.png" alt="image-20200325085320683"></p><h5 id="2-2-Parallel"><a href="#2-2-Parallel" class="headerlink" title="2.2 Parallel"></a>2.2 Parallel</h5><p>å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œå¤šä¸ªåƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œæ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œé€‚ç”¨äºç§‘å­¦è®¡ç®— / å¤§æ•°æ®å¤„ç†ç­‰å¼±äº¤äº’åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯è¯´Serial å’Œ Parallelå…¶å®æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡æ˜¯å¤šäº†å‡ ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹éƒ½ä¼šè¢«æš‚åœï¼Œä½†æ˜¯å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨å¤„ç†æ—¶é—´ï¼Œè‚¯å®šæ¯”ä¸²è¡Œçš„åƒåœ¾æ”¶é›†å™¨è¦æ›´çŸ­</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325085729428.png" alt="image-20200325085729428"></p><h5 id="2-3-CMS"><a href="#2-3-CMS" class="headerlink" title="2.3 CMS"></a>2.3 CMS</h5><p>å¹¶å‘æ ‡è®°æ¸…é™¤ï¼Œç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œå¯èƒ½æ˜¯äº¤æ›¿æ‰§è¡Œï¼‰ï¼Œä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œäº’è”ç½‘å…¬å¸éƒ½åœ¨ä½¿ç”¨ï¼Œé€‚ç”¨äºå“åº”æ—¶é—´æœ‰è¦æ±‚çš„åœºæ™¯ã€‚å¹¶å‘æ˜¯å¯ä»¥æœ‰äº¤äº’çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥ä¸€è¾¹è¿›è¡Œæ”¶é›†ï¼Œä¸€è¾¹æ‰§è¡Œåº”ç”¨ç¨‹åºã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325090858921.png" alt="image-20200325090858921"></p><h5 id="2-4-G1"><a href="#2-4-G1" class="headerlink" title="2.4 G1"></a>2.4 G1</h5><p>G1åƒåœ¾å›æ”¶å™¨å°†å †å†…å­˜åˆ†å‰²æˆä¸åŒåŒºåŸŸï¼Œç„¶åå¹¶å‘çš„è¿›è¡Œåƒåœ¾å›æ”¶</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325093222711.png" alt="image-20200325093222711"></p><h4 id="3-åƒåœ¾æ”¶é›†å™¨æ€»ç»“"><a href="#3-åƒåœ¾æ”¶é›†å™¨æ€»ç»“" class="headerlink" title="3 åƒåœ¾æ”¶é›†å™¨æ€»ç»“"></a>3 åƒåœ¾æ”¶é›†å™¨æ€»ç»“</h4><p>æ³¨æ„ï¼šå¹¶è¡Œåƒåœ¾å›æ”¶åœ¨å•æ ¸CPUä¸‹å¯èƒ½ä¼šæ›´æ…¢</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325091619082.png" alt="image-20200325091619082"></p><h4 id="4-æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨"><a href="#4-æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="4 æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨"></a>4 æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨</h4><p>ä½¿ç”¨ä¸‹é¢JVMå‘½ä»¤ï¼ŒæŸ¥çœ‹é…ç½®çš„åˆå§‹å‚æ•°</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+PrintCommandLineFlags</span></code></pre></div><p>ç„¶åè¿è¡Œä¸€ä¸ªç¨‹åºåï¼Œèƒ½å¤Ÿçœ‹åˆ°å®ƒçš„ä¸€äº›åˆå§‹é…ç½®ä¿¡æ¯</p><div class="code-wrapper"><pre><code class="hljs routeros">-XX:<span class="hljs-attribute">InitialHeapSize</span>=266376000 -XX:<span class="hljs-attribute">MaxHeapSize</span>=4262016000 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC</code></pre></div><p>ç§»åŠ¨åˆ°æœ€åä¸€å¥ï¼Œå°±èƒ½çœ‹åˆ° <code>-XX:+UseParallelGC</code> è¯´æ˜ä½¿ç”¨çš„æ˜¯å¹¶è¡Œåƒåœ¾å›æ”¶</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseParallelGC</span></code></pre></div><h4 id="5-é»˜è®¤åƒåœ¾æ”¶é›†å™¨æœ‰å“ªäº›"><a href="#5-é»˜è®¤åƒåœ¾æ”¶é›†å™¨æœ‰å“ªäº›" class="headerlink" title="5 é»˜è®¤åƒåœ¾æ”¶é›†å™¨æœ‰å“ªäº›"></a>5 é»˜è®¤åƒåœ¾æ”¶é›†å™¨æœ‰å“ªäº›</h4><p>Javaä¸­ä¸€å…±æœ‰7å¤§åƒåœ¾æ”¶é›†å™¨</p><ul><li>UserSerialGCï¼šä¸²è¡Œåƒåœ¾æ”¶é›†å™¨</li><li>UserParallelGCï¼šå¹¶è¡Œåƒåœ¾æ”¶é›†å™¨</li><li>UseConcMarkSweepGCï¼šï¼ˆCMSï¼‰å¹¶å‘æ ‡è®°æ¸…é™¤</li><li>UseParNewGCï¼šå¹´è½»ä»£çš„å¹¶è¡Œåƒåœ¾å›æ”¶å™¨</li><li>UseParallelOldGCï¼šè€å¹´ä»£çš„å¹¶è¡Œåƒåœ¾å›æ”¶å™¨</li><li>UseG1GCï¼šG1åƒåœ¾æ”¶é›†å™¨</li><li>UserSerialOldGCï¼šä¸²è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†å™¨ï¼ˆå·²ç»è¢«ç§»é™¤ï¼‰</li></ul><p>åº•å±‚æºç </p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325100653829-16280006180638.png" alt="image-20200325100653829"></p><h4 id="6-å„åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨èŒƒå›´"><a href="#6-å„åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨èŒƒå›´" class="headerlink" title="6 å„åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨èŒƒå›´"></a>6 å„åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨èŒƒå›´</h4><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325101451849.png" alt="image-20200325101451849"></p><p>æ–°ç”Ÿä»£ä½¿ç”¨çš„ï¼š</p><ul><li>Serial Copyingï¼š UserSerialGCï¼Œä¸²è¡Œåƒåœ¾å›æ”¶å™¨</li><li>Parallel Scavengeï¼šUserParallelGCï¼Œå¹¶è¡Œåƒåœ¾æ”¶é›†å™¨</li><li>ParNewï¼šUserParNewGCï¼Œæ–°ç”Ÿä»£å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨</li></ul><p>è€å¹´åŒºä½¿ç”¨çš„ï¼š</p><ul><li>Serial Oldï¼šUseSerialOldGCï¼Œè€å¹´ä»£ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨</li><li>Parallel Compactingï¼ˆParallel Oldï¼‰ï¼šUseParallelOldGCï¼Œè€å¹´ä»£å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨</li><li>CMSï¼šUseConcMarkSweppï¼Œå¹¶è¡Œæ ‡è®°æ¸…é™¤åƒåœ¾æ”¶é›†å™¨</li></ul><p>å„åŒºéƒ½èƒ½ä½¿ç”¨çš„ï¼š</p><p>G1ï¼šUseG1GCï¼ŒG1åƒåœ¾æ”¶é›†å™¨</p><p>åƒåœ¾æ”¶é›†å™¨å°±æ¥å…·ä½“å®ç°è¿™äº›GCç®—æ³•å¹¶å®ç°å†…å­˜å›æ”¶ï¼Œä¸åŒå‚å•†ï¼Œä¸åŒç‰ˆæœ¬çš„è™šæ‹Ÿæœºå®ç°å·®åˆ«å¾ˆå¤§ï¼ŒHotSpotä¸­åŒ…å«çš„æ”¶é›†å™¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325102329216.png" alt="image-20200325102329216"></p><h4 id="7-éƒ¨åˆ†å‚æ•°è¯´æ˜"><a href="#7-éƒ¨åˆ†å‚æ•°è¯´æ˜" class="headerlink" title="7 éƒ¨åˆ†å‚æ•°è¯´æ˜"></a>7 éƒ¨åˆ†å‚æ•°è¯´æ˜</h4><ul><li>DefNewï¼šDefault New Generation</li><li>Tenuredï¼šOld</li><li>ParNewï¼šParallel New Generation</li><li>PSYoungGenï¼šParallel Scavenge</li><li>ParOldGenï¼šParallel Old Generation</li></ul><h4 id="8-Javaä¸­çš„Serverå’ŒClientæ¨¡å¼"><a href="#8-Javaä¸­çš„Serverå’ŒClientæ¨¡å¼" class="headerlink" title="8  Javaä¸­çš„Serverå’ŒClientæ¨¡å¼"></a>8  Javaä¸­çš„Serverå’ŒClientæ¨¡å¼</h4><p>ä½¿ç”¨èŒƒå›´ï¼šä¸€èˆ¬ä½¿ç”¨Serveræ¨¡å¼ï¼ŒClientæ¨¡å¼åŸºæœ¬ä¸ä¼šä½¿ç”¨</p><p>æ“ä½œç³»ç»Ÿ</p><ul><li>32ä½çš„Windowæ“ä½œç³»ç»Ÿï¼Œä¸è®ºç¡¬ä»¶å¦‚ä½•éƒ½é»˜è®¤ä½¿ç”¨Clientçš„JVMæ¨¡å¼</li><li>32ä½çš„å…¶å®ƒæ“ä½œç³»ç»Ÿï¼Œ2Gå†…å­˜åŒæ—¶æœ‰2ä¸ªcpuä»¥ä¸Šç”¨Serveræ¨¡å¼ï¼Œä½äºè¯¥é…ç½®è¿˜æ˜¯Clientæ¨¡å¼</li><li>64ä½åªæœ‰Serveræ¨¡å¼</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325175208231.png" alt="image-20200325175208231"></p><h4 id="9-æ–°ç”Ÿä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨"><a href="#9-æ–°ç”Ÿä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="9 æ–°ç”Ÿä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨"></a>9 æ–°ç”Ÿä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨</h4><h5 id="9-1-ä¸²è¡ŒGC-Serial"><a href="#9-1-ä¸²è¡ŒGC-Serial" class="headerlink" title="9.1 ä¸²è¡ŒGC(Serial)"></a>9.1 ä¸²è¡ŒGC(Serial)</h5><p>ä¸²è¡ŒGCï¼ˆSerialï¼‰ï¼ˆSerial Copyingï¼‰</p><p>æ˜¯ä¸€ä¸ªå•çº¿ç¨‹å•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶å€™ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325175704604.png" alt="image-20200325175704604"></p><p>ä¸²è¡Œæ”¶é›†å™¨æ˜¯æœ€å¤è€ï¼Œæœ€ç¨³å®šä»¥åŠæ•ˆç‡é«˜çš„æ”¶é›†å™¨ï¼Œåªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å»å›æ”¶ä½†å…¶åœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿè¾ƒé•¿çš„åœé¡¿(Stop-The-World çŠ¶æ€)ã€‚ è™½ç„¶åœ¨æ”¶é›†åƒåœ¾è¿‡ç¨‹ä¸­éœ€è¦æš‚åœæ‰€æœ‰å…¶å®ƒçš„å·¥ä½œçº¿ç¨‹ï¼Œä½†æ˜¯å®ƒç®€å•é«˜æ•ˆï¼Œå¯¹äºé™å®šå•ä¸ªCPUç¯å¢ƒæ¥è¯´ï¼Œæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹åƒåœ¾æ”¶é›†æ•ˆç‡ï¼Œå› æ­¤Serialåƒåœ¾æ”¶é›†å™¨ä¾ç„¶æ˜¯Javaè™šæ‹Ÿæœºè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹é»˜è®¤çš„æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨</p><p>å¯¹åº”JVMå‚æ•°æ˜¯ï¼š-XX:+UseSerialGC</p><p>å¼€å¯åä¼šä½¿ç”¨ï¼šSerial(YoungåŒºç”¨) + Serial Old(OldåŒºç”¨) çš„æ”¶é›†å™¨ç»„åˆ</p><p>è¡¨ç¤ºï¼šæ–°ç”Ÿä»£ã€è€å¹´ä»£éƒ½ä¼šä½¿ç”¨ä¸²è¡Œå›æ”¶æ”¶é›†å™¨ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:PrintGCDetails -XX:+PrintConmandLineFlags -XX:+UseSerialGC</span></code></pre></div><h5 id="9-2-å¹¶è¡ŒGC-ParNew"><a href="#9-2-å¹¶è¡ŒGC-ParNew" class="headerlink" title="9.2 å¹¶è¡ŒGC(ParNew)"></a>9.2 å¹¶è¡ŒGC(ParNew)</h5><p>å¹¶è¡Œæ”¶é›†å™¨ï¼Œä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œåœ¨åƒåœ¾æ”¶é›†ï¼Œä¼šStop-the-Worldæš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ç›´åˆ°å®ƒæ”¶é›†ç»“æŸ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325191328733.png" alt="image-20200325191328733"></p><p>ParNewæ”¶é›†å™¨å…¶å®å°±æ˜¯Serialæ”¶é›†å™¨æ–°ç”Ÿä»£çš„å¹¶è¡Œå¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œæœ€å¸¸è§çš„åº”ç”¨åœºæ™¯æ—¶é…åˆè€å¹´ä»£çš„CMS GCå·¥ä½œï¼Œå…¶ä½™çš„è¡Œä¸ºå’ŒSerialæ”¶é›†å™¨å®Œå…¨ä¸€æ ·ï¼ŒParNewåƒåœ¾æ”¶é›†å™¨åœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­åŒæ ·ä¹Ÿè¦æš‚åœæ‰€æœ‰å…¶ä»–çš„å·¥ä½œçº¿ç¨‹ã€‚å®ƒæ˜¯å¾ˆå¤šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹æ–°ç”Ÿä»£çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ã€‚</p><p>å¸¸è§å¯¹åº”JVMå‚æ•°ï¼š-XX:+UseParNewGC     å¯åŠ¨ParNewæ”¶é›†å™¨ï¼Œåªå½±å“æ–°ç”Ÿä»£çš„æ”¶é›†ï¼Œä¸å½±å“è€å¹´ä»£</p><p>å¼€å¯ä¸Šè¿°å‚æ•°åï¼Œä¼šä½¿ç”¨ï¼šParNewï¼ˆYoungåŒºç”¨ï¼‰ + Serial Oldçš„æ”¶é›†å™¨ç»„åˆï¼Œæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:PrintGCDetails -XX:+PrintConmandLineFlags -XX:+UseParNewGC</span></code></pre></div><p>ä½†æ˜¯ä¼šå‡ºç°è­¦å‘Šï¼Œå³ ParNew å’Œ Serial Old è¿™æ ·æ­é…ï¼ŒJava8å·²ç»ä¸å†è¢«æ¨è</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325194316660.png" alt="image-20200325194316660"></p><p>å¤‡æ³¨ï¼š -XX:ParallelGCThreads   é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤å¼€å¯å’ŒCPUæ•°ç›®ç›¸åŒçš„çº¿ç¨‹æ•°</p><h5 id="9-3-å¹¶è¡Œå›æ”¶GCï¼ˆParallelï¼‰-ï¼ˆParallel-Scavengeï¼‰"><a href="#9-3-å¹¶è¡Œå›æ”¶GCï¼ˆParallelï¼‰-ï¼ˆParallel-Scavengeï¼‰" class="headerlink" title="9.3 å¹¶è¡Œå›æ”¶GCï¼ˆParallelï¼‰/ ï¼ˆParallel Scavengeï¼‰"></a>9.3 å¹¶è¡Œå›æ”¶GCï¼ˆParallelï¼‰/ ï¼ˆParallel Scavengeï¼‰</h5><p>å› ä¸ºSerial å’Œ ParNewéƒ½ä¸æ¨èä½¿ç”¨äº†ï¼Œå› æ­¤ç°åœ¨æ–°ç”Ÿä»£é»˜è®¤ä½¿ç”¨çš„æ˜¯Parallel Scavengeï¼Œä¹Ÿå°±æ˜¯æ–°ç”Ÿä»£å’Œè€å¹´ä»£éƒ½æ˜¯ä½¿ç”¨å¹¶è¡Œ</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325204437678.png" alt="image-20200325204437678"></p><p>Parallel Scavengeæ”¶é›†å™¨ç±»ä¼¼ParNewä¹Ÿæ˜¯ä¸€ä¸ªæ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨ï¼Œä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¹¶è¡Œçš„å¤šçº¿ç¨‹çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¿—ç§°ååé‡ä¼˜å…ˆæ”¶é›†å™¨ã€‚ä¸€å¥è¯ï¼šä¸²è¡Œæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„å¹¶è¡ŒåŒ–</p><p>å®ƒå…³æ³¨çš„é‡ç‚¹æ˜¯ï¼š</p><p>å¯æ§åˆ¶çš„ååé‡ï¼ˆThoughput = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ / (è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ + åƒåœ¾æ”¶é›†æ—¶é—´) ï¼‰ï¼Œä¹Ÿå³æ¯”å¦‚ç¨‹åºè¿è¡Œ100åˆ†é’Ÿï¼Œåƒåœ¾æ”¶é›†æ—¶é—´1åˆ†é’Ÿï¼Œååé‡å°±æ˜¯99%ã€‚é«˜ååé‡æ„å‘³ç€é«˜æ•ˆåˆ©ç”¨CPUæ—¶é—´ï¼Œå®ƒå¤šç”¨äºåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚</p><p>è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯ParallelScavengeæ”¶é›†å™¨ä¸ParNewæ”¶é›†å™¨çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚ï¼ˆè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ï¼šè™šæ‹Ÿæœºä¼šæ ¹æ®å½“å‰ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µæ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼ŒåŠ¨æ€è°ƒæ•´è¿™äº›å‚æ•°ä»¥æä¾›æœ€åˆé€‚çš„åœé¡¿æ—¶é—´( -XX:MaxGCPauseMills)ï¼‰æˆ–æœ€å¤§çš„ååé‡ã€‚</p><p>å¸¸ç”¨JVMå‚æ•°ï¼š-XX:+UseParallelGC æˆ– -XX:+UseParallelOldGCï¼ˆå¯äº’ç›¸æ¿€æ´»ï¼‰ä½¿ç”¨Parallel Scanvengeæ”¶é›†å™¨</p><p>å¼€å¯è¯¥å‚æ•°åï¼šæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:PrintGCDetails -XX:+PrintConmandLineFlags -XX:+UseParallelGC</span></code></pre></div><h4 id="10-è€å¹´ä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨"><a href="#10-è€å¹´ä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="10 è€å¹´ä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨"></a>10 è€å¹´ä»£ä¸‹çš„åƒåœ¾æ”¶é›†å™¨</h4><h5 id="10-1-ä¸²è¡ŒGCï¼ˆSerial-Oldï¼‰-Serial-MSC"><a href="#10-1-ä¸²è¡ŒGCï¼ˆSerial-Oldï¼‰-Serial-MSC" class="headerlink" title="10.1 ä¸²è¡ŒGCï¼ˆSerial Oldï¼‰ / (Serial MSC)"></a>10.1 ä¸²è¡ŒGCï¼ˆSerial Oldï¼‰ / (Serial MSC)</h5><p>Serial Oldæ˜¯Serialåƒåœ¾æ”¶é›†å™¨è€å¹´ä»£ç‰ˆæœ¬ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œè¿™ä¸ªæ”¶é›†å™¨ä¹Ÿä¸»è¦æ˜¯è¿è¡Œåœ¨Clienté»˜è®¤çš„Javaè™šæ‹Ÿæœºä¸­é»˜è®¤çš„è€å¹´ä»£åƒåœ¾æ”¶é›†å™¨</p><p>åœ¨Serveræ¨¡å¼ä¸‹ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼ˆäº†è§£ï¼Œç‰ˆæœ¬å·²ç»åˆ°8åŠä»¥åï¼‰</p><ul><li>åœ¨JDK1.5ä¹‹å‰ç‰ˆæœ¬ä¸­ä¸æ–°ç”Ÿä»£çš„Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼ˆParallel Scavenge + Serial Oldï¼‰</li><li>ä½œä¸ºè€å¹´ä»£ç‰ˆä¸­ä½¿ç”¨CMSæ”¶é›†å™¨çš„åå¤‡åƒåœ¾æ”¶é›†æ–¹æ¡ˆã€‚</li></ul><p>é…ç½®æ–¹æ³•ï¼š</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:PrintGCDetails -XX:+PrintConmandLineFlags -XX:+UseSerialOldlGC</span></code></pre></div><p>è¯¥åƒåœ¾æ”¶é›†å™¨ï¼Œç›®å‰å·²ç»ä¸æ¨èä½¿ç”¨äº†</p><h5 id="10-2-å¹¶è¡ŒGCï¼ˆParallel-Oldï¼‰-ï¼ˆParallel-MSCï¼‰"><a href="#10-2-å¹¶è¡ŒGCï¼ˆParallel-Oldï¼‰-ï¼ˆParallel-MSCï¼‰" class="headerlink" title="10.2 å¹¶è¡ŒGCï¼ˆParallel Oldï¼‰/ ï¼ˆParallel MSCï¼‰"></a>10.2 å¹¶è¡ŒGCï¼ˆParallel Oldï¼‰/ ï¼ˆParallel MSCï¼‰</h5><p>Parallel Oldæ”¶é›†å™¨æ˜¯Parallel Scavengeçš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œä½¿ç”¨å¤šçº¿ç¨‹çš„æ ‡è®°-æ•´ç†ç®—æ³•ï¼ŒParallel Oldæ”¶é›†å™¨åœ¨JDK1.6æ‰å¼€å§‹æä¾›ã€‚</p><p>åœ¨JDK1.6ä¹‹å‰ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨ParallelScavengeæ”¶é›†å™¨åªèƒ½æ­é…è€å¹´ä»£çš„Serial Oldæ”¶é›†å™¨ï¼Œåªèƒ½ä¿è¯æ–°ç”Ÿä»£çš„ååé‡ä¼˜å…ˆï¼Œæ— æ³•ä¿è¯æ•´ä½“çš„ååé‡ã€‚åœ¨JDK1.6ä»¥å‰(Parallel Scavenge + Serial Old)</p><p>Parallel Oldæ­£æ˜¯ä¸ºäº†åœ¨è€å¹´ä»£åŒæ ·æä¾›ååé‡ä¼˜å…ˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå¦‚æœç³»ç»Ÿå¯¹ååé‡è¦æ±‚æ¯”è¾ƒé«˜ï¼ŒJDK1.8åå¯ä»¥è€ƒè™‘æ–°ç”Ÿä»£Parallel Scavengeå’Œè€å¹´ä»£Parallel Old æ”¶é›†å™¨çš„æ­é…ç­–ç•¥ã€‚åœ¨JDK1.8åŠåï¼ˆParallel Scavenge + Parallel Oldï¼‰</p><p>JVMå¸¸ç”¨å‚æ•°ï¼š</p><div class="code-wrapper"><pre><code class="hljs oxygene">-XX +UseParallelOldGCï¼šä½¿ç”¨<span class="hljs-keyword">Parallel</span> <span class="hljs-keyword">Old</span>æ”¶é›†å™¨ï¼Œè®¾ç½®è¯¥å‚æ•°åï¼Œæ–°ç”Ÿä»£<span class="hljs-keyword">Parallel</span>+è€å¹´ä»£ <span class="hljs-keyword">Parallel</span> <span class="hljs-keyword">Old</span></code></pre></div><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325211525152.png" alt="image-20200325211525152"></p><p>ä½¿ç”¨è€å¹´ä»£å¹¶è¡Œæ”¶é›†å™¨ï¼š</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:PrintGCDetails -XX:+PrintConmandLineFlags -XX:+UseParallelOldlGC</span></code></pre></div><h5 id="10-3-å¹¶å‘æ ‡è®°æ¸…é™¤GCï¼ˆCMSï¼‰"><a href="#10-3-å¹¶å‘æ ‡è®°æ¸…é™¤GCï¼ˆCMSï¼‰" class="headerlink" title="10.3 å¹¶å‘æ ‡è®°æ¸…é™¤GCï¼ˆCMSï¼‰"></a>10.3 å¹¶å‘æ ‡è®°æ¸…é™¤GCï¼ˆCMSï¼‰</h5><p>CMSæ”¶é›†å™¨ï¼ˆConcurrent Mark Sweepï¼šå¹¶å‘æ ‡è®°æ¸…é™¤ï¼‰æ˜¯ä¸€ç§ä»¥æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨</p><p>é€‚åˆåº”ç”¨åœ¨äº’è”ç½‘æˆ–è€…B/Sç³»ç»Ÿçš„æœåŠ¡å™¨ä¸Šï¼Œè¿™ç±»åº”ç”¨å°¤å…¶é‡è§†æœåŠ¡å™¨çš„å“åº”é€Ÿåº¦ï¼Œå¸Œæœ›ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€çŸ­ã€‚</p><p>CMSéå¸¸é€‚åˆå †å†…å­˜å¤§ï¼ŒCPUæ ¸æ•°å¤šçš„æœåŠ¡å™¨ç«¯åº”ç”¨ï¼Œä¹Ÿæ˜¯G1å‡ºç°ä¹‹å‰å¤§å‹åº”ç”¨çš„é¦–é€‰æ”¶é›†å™¨ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325212836441.png" alt="image-20200325212836441"></p><p>Concurrent Mark Sweepï¼šå¹¶å‘æ ‡è®°æ¸…é™¤ï¼Œå¹¶å‘æ”¶é›†ä½åœé¡¿ï¼Œå¹¶å‘æŒ‡çš„æ˜¯ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·æ‰§è¡Œ</p><p>å¼€å¯è¯¥æ”¶é›†å™¨çš„JVMå‚æ•°ï¼š -XX:+UseConcMarkSweepGC  å¼€å¯è¯¥å‚æ•°åï¼Œä¼šè‡ªåŠ¨å°† -XX:+UseParNewGCæ‰“å¼€ï¼Œå¼€å¯è¯¥å‚æ•°åï¼Œä½¿ç”¨ParNew(young åŒºç”¨ï¼‰+ CMSï¼ˆOld åŒºç”¨ï¼‰ + Serial Old çš„æ”¶é›†å™¨ç»„åˆï¼ŒSerial Oldå°†ä½œä¸ºCMSå‡ºé”™çš„åå¤‡æ”¶é›†å™¨</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx10m -XX:+PrintGCDetails -XX:+UseConcMarkSweepGC</span></code></pre></div><h6 id="å››ä¸ªæ­¥éª¤"><a href="#å››ä¸ªæ­¥éª¤" class="headerlink" title="å››ä¸ªæ­¥éª¤"></a>å››ä¸ªæ­¥éª¤</h6><ul><li>åˆå§‹æ ‡è®°ï¼ˆCMS initial markï¼‰<ul><li>åªæ˜¯æ ‡è®°ä¸€ä¸ªGC Roots èƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä»ç„¶éœ€è¦æš‚åœæ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹</li></ul></li><li>å¹¶å‘æ ‡è®°ï¼ˆCMS concurrent markï¼‰å’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·<ul><li>è¿›è¡ŒGC Rootsè·Ÿè¸ªè¿‡ç¨‹ï¼Œå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦æš‚åœå·¥ä½œçº¿ç¨‹ã€‚ä¸»è¦æ ‡è®°è¿‡ç¨‹ï¼Œæ ‡è®°å…¨éƒ¨å¯¹è±¡</li></ul></li><li>é‡æ–°æ ‡è®°ï¼ˆCMS remarkï¼‰<ul><li>ä¸ºäº†ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œä»ç„¶éœ€è¦æš‚åœæ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç”±äºå¹¶å‘æ ‡è®°æ—¶ï¼Œç”¨æˆ·çº¿ç¨‹ä¾ç„¶è¿è¡Œï¼Œå› æ­¤åœ¨æ­£å¼æ¸…ç†å‰ï¼Œåœ¨åšä¿®æ­£</li></ul></li><li>å¹¶å‘æ¸…é™¤ï¼ˆCMS concurrent sweepï¼‰å’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·<ul><li>æ¸…é™¤GC Rootsä¸å¯è¾¾å¯¹è±¡ï¼Œå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦æš‚åœå·¥ä½œçº¿ç¨‹ã€‚åŸºäºæ ‡è®°ç»“æœï¼Œç›´æ¥æ¸…ç†å¯¹è±¡ï¼Œç”±äºè€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹ä¸­ï¼Œåƒåœ¾æ”¶é›†çº¿ç¨‹å¯ä»¥å’Œç”¨æˆ·ç°åœ¨ä¸€èµ·å¹¶å‘å·¥ä½œï¼Œæ‰€ä»¥æ€»ä½“ä¸Šæ¥çœ‹CMSæ”¶é›†å™¨çš„å†…å­˜å›æ”¶å’Œç”¨æˆ·çº¿ç¨‹æ˜¯ä¸€èµ·å¹¶å‘åœ°æ‰§è¡Œã€‚</li></ul></li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200325215401981-162800094846319.png" alt="image-20200325215401981"></p><p>ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ä½åœé¡¿</p><p>ç¼ºç‚¹ï¼šå¹¶å‘æ‰§è¡Œï¼Œå¯¹CPUèµ„æºå‹åŠ›å¤§ï¼Œé‡‡ç”¨çš„æ ‡è®°æ¸…é™¤ç®—æ³•ä¼šå¯¼è‡´å¤§é‡ç¢ç‰‡</p><p>ç”±äºå¹¶å‘è¿›è¡Œï¼ŒCMSåœ¨æ”¶é›†ä¸åº”ç”¨çº¿ç¨‹ä¼šåŒæ—¶å¢åŠ å¯¹å †å†…å­˜çš„å ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCMSå¿…é¡»åœ¨è€å¹´ä»£å †å†…å­˜ç”¨å°½ä¹‹å‰å®Œæˆåƒåœ¾å›æ”¶ï¼Œå¦åˆ™CMSå›æ”¶å¤±è´¥æ—¶ï¼Œå°†è§¦å‘æ‹…ä¿æœºåˆ¶ï¼Œä¸²è¡Œè€å¹´ä»£æ”¶é›†å™¨å°†ä¼šä»¥STWæ–¹å¼è¿›è¡Œä¸€æ¬¡GCï¼Œä»è€Œé€ æˆè¾ƒå¤§çš„åœé¡¿æ—¶é—´</p><p>æ ‡è®°æ¸…é™¤ç®—æ³•æ— æ³•æ•´ç†ç©ºé—´ç¢ç‰‡ï¼Œè€å¹´ä»£ç©ºé—´ä¼šéšç€åº”ç”¨æ—¶é•¿è¢«é€æ­¥è€—å°½ï¼Œæœ€åå°†ä¸å¾—ä¸é€šè¿‡æ‹…ä¿æœºåˆ¶å¯¹å †å†…å­˜è¿›è¡Œå‹ç¼©ï¼ŒCMSä¹Ÿæä¾›äº†å‚æ•° -XX:CMSFullGCSBeForeCompactionï¼ˆé»˜è®¤0ï¼Œå³æ¯æ¬¡éƒ½è¿›è¡Œå†…å­˜æ•´ç†ï¼‰æ¥æŒ‡å®šå¤šå°‘æ¬¡CMSæ”¶é›†ä¹‹åï¼Œè¿›è¡Œä¸€æ¬¡å‹ç¼©çš„Full GC</p><h4 id="11-ä¸ºä»€ä¹ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡æ•´ç®—æ³•"><a href="#11-ä¸ºä»€ä¹ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡æ•´ç®—æ³•" class="headerlink" title="11 ä¸ºä»€ä¹ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡æ•´ç®—æ³•"></a>11 ä¸ºä»€ä¹ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡æ•´ç®—æ³•</h4><h5 id="11-1-æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•"><a href="#11-1-æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•" class="headerlink" title="11.1 æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•"></a>11.1 æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•</h5><p>å› ä¸ºæ–°ç”Ÿä»£å¯¹è±¡çš„ç”Ÿå­˜æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œ80%çš„éƒ½è¦å›æ”¶çš„å¯¹è±¡ï¼Œé‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•åˆ™å†…å­˜ç¢ç‰‡åŒ–æ¯”è¾ƒä¸¥é‡ï¼Œé‡‡ç”¨å¤åˆ¶ç®—æ³•å¯ä»¥çµæ´»é«˜æ•ˆï¼Œä¸”ä¾¿ä¸æ•´ç†ç©ºé—´ã€‚</p><h5 id="11-2-è€å¹´ä»£é‡‡ç”¨æ ‡è®°æ•´ç†"><a href="#11-2-è€å¹´ä»£é‡‡ç”¨æ ‡è®°æ•´ç†" class="headerlink" title="11.2 è€å¹´ä»£é‡‡ç”¨æ ‡è®°æ•´ç†"></a>11.2 è€å¹´ä»£é‡‡ç”¨æ ‡è®°æ•´ç†</h5><p>æ ‡è®°æ•´ç†ç®—æ³•ä¸»è¦æ˜¯ä¸ºäº†è§£å†³æ ‡è®°æ¸…é™¤ç®—æ³•å­˜åœ¨å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œåˆè§£å†³äº†å¤åˆ¶ç®—æ³•ä¸¤ä¸ªSurvivoråŒºçš„é—®é¢˜ï¼Œå› ä¸ºè€å¹´ä»£çš„ç©ºé—´æ¯”è¾ƒå¤§ï¼Œä¸å¯èƒ½é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œç‰¹åˆ«å ç”¨å†…å­˜ç©ºé—´</p><h4 id="12-åƒåœ¾æ”¶é›†å™¨å¦‚ä½•é€‰æ‹©"><a href="#12-åƒåœ¾æ”¶é›†å™¨å¦‚ä½•é€‰æ‹©" class="headerlink" title="12 åƒåœ¾æ”¶é›†å™¨å¦‚ä½•é€‰æ‹©"></a>12 åƒåœ¾æ”¶é›†å™¨å¦‚ä½•é€‰æ‹©</h4><h5 id="ç»„åˆçš„é€‰æ‹©"><a href="#ç»„åˆçš„é€‰æ‹©" class="headerlink" title="ç»„åˆçš„é€‰æ‹©"></a>ç»„åˆçš„é€‰æ‹©</h5><ul><li>å•CPUæˆ–è€…å°å†…å­˜ï¼Œå•æœºç¨‹åº<ul><li>-XX:+UseSerialGC</li></ul></li><li>å¤šCPUï¼Œéœ€è¦æœ€å¤§çš„ååé‡ï¼Œå¦‚åå°è®¡ç®—å‹åº”ç”¨<ul><li>-XX:+UseParallelGCï¼ˆè¿™ä¸¤ä¸ªç›¸äº’æ¿€æ´»ï¼‰</li><li>-XX:+UseParallelOldGC</li></ul></li><li>å¤šCPUï¼Œè¿½æ±‚ä½åœé¡¿æ—¶é—´ï¼Œéœ€è¦å¿«é€Ÿå“åº”å¦‚äº’è”ç½‘åº”ç”¨<ul><li>-XX:+UseConcMarkSweepGC</li><li>-XX:+ParNewGC</li></ul></li></ul><table><thead><tr><th align="center">å‚æ•°</th><th align="center">æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨</th><th align="center">æ–°ç”Ÿä»£ç®—æ³•</th><th align="center">è€å¹´ä»£åƒåœ¾æ”¶é›†å™¨</th><th align="center">è€å¹´ä»£ç®—æ³•</th></tr></thead><tbody><tr><td align="center">-XX:+UseSerialGC</td><td align="center">SerialGC</td><td align="center">å¤åˆ¶</td><td align="center">SerialOldGC</td><td align="center">æ ‡è®°æ•´ç†</td></tr><tr><td align="center">-XX:+UseParNewGC</td><td align="center">ParNew</td><td align="center">å¤åˆ¶</td><td align="center">SerialOldGC</td><td align="center">æ ‡è®°æ•´ç†</td></tr><tr><td align="center">-XX:+UseParallelGC</td><td align="center">Parallel [Scavenge]</td><td align="center">å¤åˆ¶</td><td align="center">Parallel Old</td><td align="center">æ ‡è®°æ•´ç†</td></tr><tr><td align="center">-XX:+UseConcMarkSweepGC</td><td align="center">ParNew</td><td align="center">å¤åˆ¶</td><td align="center">CMS + Serial Oldçš„æ”¶é›†å™¨ç»„åˆï¼ŒSerial Oldä½œä¸ºCMSå‡ºé”™çš„åå¤‡æ”¶é›†å™¨</td><td align="center">æ ‡è®°æ¸…é™¤</td></tr><tr><td align="center">-XX:+UseG1GC</td><td align="center">G1æ•´ä½“ä¸Šé‡‡ç”¨æ ‡è®°æ•´ç†ç®—æ³•</td><td align="center">å±€éƒ¨å¤åˆ¶</td><td align="center"></td><td align="center"></td></tr></tbody></table><h4 id="13-G1åƒåœ¾æ”¶é›†å™¨"><a href="#13-G1åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="13 G1åƒåœ¾æ”¶é›†å™¨"></a>13 G1åƒåœ¾æ”¶é›†å™¨</h4><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326115120405.png" alt="image-20200326115120405"></p><h5 id="13-1-å¼€å¯G1åƒåœ¾æ”¶é›†å™¨"><a href="#13-1-å¼€å¯G1åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="13.1 å¼€å¯G1åƒåœ¾æ”¶é›†å™¨"></a>13.1 å¼€å¯G1åƒåœ¾æ”¶é›†å™¨</h5><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseG1GC</span></code></pre></div><h5 id="13-2-ä»¥å‰æ”¶é›†å™¨çš„ç‰¹ç‚¹"><a href="#13-2-ä»¥å‰æ”¶é›†å™¨çš„ç‰¹ç‚¹" class="headerlink" title="13.2 ä»¥å‰æ”¶é›†å™¨çš„ç‰¹ç‚¹"></a>13.2 ä»¥å‰æ”¶é›†å™¨çš„ç‰¹ç‚¹</h5><ul><li>å¹´è½»ä»£å’Œè€å¹´ä»£æ˜¯å„è‡ªç‹¬ç«‹ä¸”è¿ç»­çš„å†…å­˜å—</li><li>å¹´è½»ä»£æ”¶é›†ä½¿ç”¨å•eden + S0 + S1 è¿›è¡Œå¤åˆ¶ç®—æ³•</li><li>è€å¹´ä»£æ”¶é›†å¿…é¡»æ‰«æçæ•´ä¸ªè€å¹´ä»£åŒºåŸŸ</li><li>éƒ½æ˜¯ä»¥å°½å¯èƒ½å°‘è€Œå¿«é€Ÿåœ°æ‰§è¡ŒGCä¸ºè®¾è®¡åŸåˆ™</li></ul><h5 id="13-3-G1æ˜¯ä»€ä¹ˆ"><a href="#13-3-G1æ˜¯ä»€ä¹ˆ" class="headerlink" title="13.3 G1æ˜¯ä»€ä¹ˆ"></a>13.3 G1æ˜¯ä»€ä¹ˆ</h5><p>G1ï¼šGarbage-First æ”¶é›†å™¨ï¼Œæ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„æ”¶é›†å™¨ï¼Œåº”ç”¨åœ¨å¤šå¤„ç†å™¨å’Œå¤§å®¹é‡å†…å­˜ç¯å¢ƒä¸­ï¼Œåœ¨å®ç°é«˜ååé‡çš„åŒæ—¶ï¼Œå°½å¯èƒ½æ»¡è¶³åƒåœ¾æ”¶é›†æš‚åœæ—¶é—´çš„è¦æ±‚ã€‚å¦å¤–ï¼Œå®ƒè¿˜å…·æœ‰ä¸€ä¸‹ç‰¹å¾ï¼š</p><ul><li>åƒCMSæ”¶é›†å™¨ä¸€æ ·ï¼Œèƒ½ä¸åº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œ</li><li>æ•´ç†ç©ºé—²ç©ºé—´æ›´å¿«</li><li>éœ€è¦æ›´å¤šçš„æ—¶é—´æ¥é¢„æµ‹GCåœé¡¿æ—¶é—´</li><li>ä¸å¸Œæœ›ç‰ºç‰²å¤§é‡çš„ååé‡æ€§èƒ½</li><li>ä¸éœ€è¦æ›´å¤§çš„Java Heap</li></ul><p>G1æ”¶é›†å™¨è®¾è®¡ç›®æ ‡æ˜¯å–ä»£CMSæ”¶é›†å™¨ï¼Œå®ƒåŒCMSç›¸æ¯”ï¼Œåœ¨ä»¥ä¸‹æ–¹é¢è¡¨ç°çš„æ›´å‡ºè‰²</p><ul><li>G1æ˜¯ä¸€ä¸ªæœ‰æ•´ç†å†…å­˜è¿‡ç¨‹çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸ä¼šäº§ç”Ÿå¾ˆå¤šå†…å­˜ç¢ç‰‡ã€‚</li><li>G1çš„Stop The Worldï¼ˆSTWï¼‰æ›´å¯æ§ï¼ŒG1åœ¨åœé¡¿æ—¶é—´ä¸Šæ·»åŠ äº†é¢„æµ‹æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šæœŸæœ›åœé¡¿æ—¶é—´ã€‚</li></ul><p>CMSåƒåœ¾æ”¶é›†å™¨è™½ç„¶å‡å°‘äº†æš‚åœåº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶é—´ï¼Œä½†æ˜¯å®ƒè¿˜å­˜åœ¨ç€å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚äºæ˜¯ï¼Œä¸ºäº†å»é™¤å†…å­˜ç¢ç‰‡é—®é¢˜ï¼ŒåŒæ—¶åˆä¿ç•™CMSåƒåœ¾æ”¶é›†å™¨ä½æš‚åœæ—¶é—´çš„ä¼˜ç‚¹ï¼ŒJAVA7å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„åƒåœ¾æ”¶é›†å™¨-G1åƒåœ¾æ”¶é›†å™¨</p><p>G1æ˜¯åœ¨2012å¥¶å¥¶æ‰åœ¨JDK1.7ä¸­å¯ç”¨ï¼ŒOracleå®˜æ–¹è®¡åˆ’åœ¨JDK9ä¸­å°†G1å˜æˆé»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ä»¥æ›¿ä»£CMSï¼Œå®ƒæ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„æ”¶é›†å™¨ï¼Œä¸»è¦åº”ç”¨åœ¨å¤šCPUå’Œå¤§å†…å­˜æœåŠ¡å™¨ç¯å¢ƒä¸‹ï¼Œæå¤§å‡å°‘åƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´ï¼Œå…¨é¢æå‡æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œé€æ­¥æ›¿æ¢Java8ä»¥å‰çš„CMSæ”¶é›†å™¨</p><p>ä¸»è¦æ”¹å˜æ—¶ï¼šEdenï¼ŒSurvivorå’ŒTenuredç­‰å†…å­˜åŒºåŸŸä¸å†æ˜¯è¿ç»­äº†ï¼Œè€Œæ˜¯å˜æˆä¸€ä¸ªä¸ªå¤§å°ä¸€æ ·çš„regionï¼Œæ¯ä¸ªregionä»1Måˆ°32Mä¸ç­‰ã€‚ä¸€ä¸ªregionæœ‰å¯èƒ½å±äºEdenï¼ŒSurvivoræˆ–è€…Tenuredå†…å­˜åŒºåŸŸã€‚</p><h5 id="13-4-ç‰¹ç‚¹"><a href="#13-4-ç‰¹ç‚¹" class="headerlink" title="13.4 ç‰¹ç‚¹"></a>13.4 ç‰¹ç‚¹</h5><ul><li>G1èƒ½å……åˆ†åˆ©ç”¨å¤šCPUï¼Œå¤šæ ¸ç¯å¢ƒç¡¬ä»¶ä¼˜åŠ¿ï¼Œå°½é‡ç¼©çŸ­STW</li><li>G1æ•´ä½“ä¸Šé‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå±€éƒ¨æ˜¯é€šè¿‡å¤åˆ¶ç®—æ³•ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</li><li>å®è§‚ä¸Šçœ‹G1ä¹‹ä¸­ä¸å†åŒºåˆ†å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚æŠŠå†…å­˜åˆ’åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„å­åŒºåŸŸï¼ˆRegionï¼‰ï¼Œå¯ä»¥è¿‘ä¼¼ç†è§£ä¸ºä¸€ä¸ªå›´æ£‹çš„æ£‹ç›˜</li><li>G1æ”¶é›†å™¨é‡Œé¢å°†æ•´ä¸ªå†…å­˜åŒºåŸŸéƒ½æ··åˆåœ¨ä¸€èµ·äº†ï¼Œä½†å…¶æœ¬èº«ä¾ç„¶åœ¨å°èŒƒå›´å†…è¦è¿›è¡Œå¹´è½»ä»£å’Œè€å¹´ä»£çš„åŒºåˆ†ï¼Œä¿ç•™äº†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œä½†ä»–ä»¬ä¸å†æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œè€Œæ˜¯é€šè¿‡ä¸€éƒ¨åˆ†Regionçš„é›†åˆä¸”ä¸éœ€è¦Regionæ˜¯è¿ç»­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¾ç„¶ä¼šé‡‡å–ä¸åŒçš„GCæ–¹å¼æ¥å¤„ç†ä¸åŒçš„åŒºåŸŸ</li><li>G1è™½ç„¶ä¹Ÿæ˜¯åˆ†ä»£æ”¶é›†å™¨ï¼Œä½†æ•´ä¸ªå†…å­˜åˆ†åŒºä¸å­˜åœ¨ç‰©ç†ä¸Šçš„å¹´è½»ä»£å’Œè€å¹´ä»£çš„åŒºåˆ«ï¼Œä¹Ÿä¸éœ€è¦å®Œå…¨ç‹¬ç«‹çš„Survivorï¼ˆto spaceï¼‰å †åšå¤åˆ¶å‡†å¤‡ï¼ŒG1åªæœ‰é€»è¾‘ä¸Šçš„åˆ†ä»£æ¦‚å¿µï¼Œæˆ–è€…è¯´æ¯ä¸ªåˆ†åŒºéƒ½å¯èƒ½éšG1çš„è¿è¡Œåœ¨ä¸åŒä»£ä¹‹é—´å‰ååˆ‡æ¢ã€‚</li></ul><h5 id="13-5-åº•å±‚åŸç†"><a href="#13-5-åº•å±‚åŸç†" class="headerlink" title="13.5 åº•å±‚åŸç†"></a>13.5 åº•å±‚åŸç†</h5><p>RegionåŒºåŸŸåŒ–åƒåœ¾æ”¶é›†å™¨ï¼ŒåŒ–æ•´ä¸ºé›¶ï¼Œæ‰“ç ´äº†åŸæ¥æ–°ç”ŸåŒºå’Œè€å¹´åŒºçš„å£å’ï¼Œé¿å…äº†å…¨å†…å­˜æ‰«æï¼Œåªéœ€è¦æŒ‰ç…§åŒºåŸŸæ¥è¿›è¡Œæ‰«æå³å¯ã€‚</p><p>åŒºåŸŸåŒ–å†…å­˜åˆ’ç‰‡Regionï¼Œæ•´ä½“éä¸ºäº†ä¸€äº›åˆ—ä¸è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œé¿å…äº†å…¨å†…å­˜åŒºçš„GCæ“ä½œã€‚</p><p>æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ•´ä¸ªå †å†…å­˜åŒºåŸŸåˆ†æˆå¤§å°ç›¸åŒçš„å­åŒºåŸŸï¼ˆRegionï¼‰ï¼Œåœ¨JVMå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è®¾ç½®å­åŒºåŸŸå¤§å°</p><p>åœ¨å †çš„ä½¿ç”¨ä¸Šï¼ŒG1å¹¶ä¸è¦æ±‚å¯¹è±¡çš„å­˜å‚¨ä¸€å®šæ˜¯ç‰©ç†ä¸Šè¿ç»­çš„ï¼Œåªè¦é€»è¾‘ä¸Šè¿ç»­å³å¯ï¼Œæ¯ä¸ªåˆ†åŒºä¹Ÿä¸ä¼šå›ºå®šåœ°ä¸ºæŸä¸ªä»£æœåŠ¡ï¼Œå¯ä»¥æŒ‰éœ€åœ¨å¹´è½»ä»£å’Œè€å¹´ä»£ä¹‹é—´åˆ‡æ¢ã€‚å¯åŠ¨æ—¶å¯ä»¥é€šè¿‡å‚æ•°<code>-XX:G1HeapRegionSize=n</code> å¯æŒ‡å®šåˆ†åŒºå¤§å°ï¼ˆ1MB~32MBï¼Œä¸”å¿…é¡»æ˜¯2çš„å¹‚ï¼‰ï¼Œé»˜è®¤å°†æ•´å †åˆ’åˆ†ä¸º2048ä¸ªåˆ†åŒºã€‚</p><p>å¤§å°èŒƒå›´åœ¨1MB~32MBï¼Œæœ€å¤šèƒ½è®¾ç½®2048ä¸ªåŒºåŸŸï¼Œä¹Ÿå³èƒ½å¤Ÿæ”¯æŒçš„æœ€å¤§å†…å­˜ä¸ºï¼š32MB*2048 = 64Gå†…å­˜</p><p>RegionåŒºåŸŸåŒ–åƒåœ¾æ”¶é›†å™¨</p><h5 id="13-6-RegionåŒºåŸŸåŒ–åƒåœ¾æ”¶é›†å™¨"><a href="#13-6-RegionåŒºåŸŸåŒ–åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="13.6 RegionåŒºåŸŸåŒ–åƒåœ¾æ”¶é›†å™¨"></a>13.6 RegionåŒºåŸŸåŒ–åƒåœ¾æ”¶é›†å™¨</h5><p>G1å°†æ–°ç”Ÿä»£ã€è€å¹´ä»£çš„ç‰©ç†ç©ºé—´åˆ’åˆ†å–æ¶ˆäº†</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326120105859.png" alt="image-20200326120105859"></p><p>åŒæ—¶å¯¹å†…å­˜è¿›è¡Œäº†åŒºåŸŸåˆ’åˆ†</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326120130427.png" alt="image-20200326120130427"></p><p>G1ç®—æ³•å°†å †åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼ˆReignï¼‰ï¼Œå®ƒä»ç„¶å±äºåˆ†ä»£æ”¶é›†å™¨ï¼Œè¿™äº›Regionçš„ä¸€éƒ¨åˆ†åŒ…å«æ–°ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†ä¾ç„¶é‡‡ç”¨æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹çš„æ–¹å¼ï¼Œå°†å­˜æ´»å¯¹è±¡æ‹·è´åˆ°è€å¹´ä»£æˆ–è€…Survivorç©ºé—´</p><p>è¿™äº›Regionçš„ä¸€éƒ¨åˆ†åŒ…å«è€å¹´ä»£ï¼ŒG1æ”¶é›†å™¨é€šè¿‡å°†å¯¹è±¡ä»ä¸€ä¸ªåŒºåŸŸå¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåŒºåŸŸï¼Œå®Œæˆäº†æ¸…ç†å·¥ä½œã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨æ­£å¸¸çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒG1å®Œæˆäº†å †çš„å‹ç¼©ï¼ˆè‡³å°‘æ˜¯éƒ¨åˆ†å †çš„å‹ç¼©ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±ä¸ä¼šæœ‰CMSå†…å­˜ç¢ç‰‡çš„é—®é¢˜å­˜åœ¨äº†ã€‚</p><p>åœ¨G1ä¸­ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„åŒºåŸŸï¼Œå«åšHumongousï¼ˆå·¨å¤§çš„ï¼‰åŒºåŸŸï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å ç”¨äº†ç©ºé—´è¶…è¿‡äº†åˆ†åŒºå®¹é‡50%ä»¥ä¸Šï¼ŒG1æ”¶é›†å™¨å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå·¨å‹å¯¹è±¡ï¼Œè¿™äº›å·¨å‹å¯¹è±¡é»˜è®¤ç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ï¼Œä½†æ˜¯å¦‚æœä»–æ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å·¨å‹å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å·¨å‹å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå·¨å‹å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„HåŒºæ¥å­˜å‚¨ï¼Œä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚</p><h5 id="13-7-å›æ”¶æ­¥éª¤"><a href="#13-7-å›æ”¶æ­¥éª¤" class="headerlink" title="13.7 å›æ”¶æ­¥éª¤"></a>13.7 å›æ”¶æ­¥éª¤</h5><p>é’ˆå¯¹EdenåŒºè¿›è¡Œæ”¶é›†ï¼ŒEdenåŒºè€—å°½åä¼šè¢«è§¦å‘ï¼Œä¸»è¦æ˜¯å°åŒºåŸŸæ”¶é›† + å½¢æˆè¿ç»­çš„å†…å­˜å—ï¼Œé¿å…å†…ç¢ç‰‡</p><ul><li>EdenåŒºçš„æ•°æ®ç§»åŠ¨åˆ°SurvivoråŒºï¼ŒåŠ å…¥å‡ºç°SurvivoråŒºç©ºé—´ä¸å¤Ÿï¼ŒEdenåŒºæ•°æ®ä¼šæ™‹å‡åˆ°OldåŒº</li><li>SurvivoråŒºçš„æ•°æ®ç§»åŠ¨åˆ°æ–°çš„SurvivoråŒºï¼Œéƒ¨åˆ†æ•°æ®æ™‹å‡åˆ°OldåŒº</li><li>æœ€åEdenåŒºæ”¶æ‹¾å¹²å‡€äº†ï¼ŒGCç»“æŸï¼Œç”¨æˆ·çš„åº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œ</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326121409237.png" alt="image-20200326121409237"></p><p>å›æ”¶å®Œæˆå</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326121622208.png" alt="image-20200326121622208"></p><p>å°åŒºåŸŸæ”¶é›† + å½¢æˆè¿ç»­çš„å†…å­˜å—ï¼Œæœ€ååœ¨æ”¶é›†å®Œæˆåï¼Œå°±ä¼šå½¢æˆè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¿™æ ·å°±è§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜</p><h5 id="13-8-å››æ­¥è¿‡ç¨‹"><a href="#13-8-å››æ­¥è¿‡ç¨‹" class="headerlink" title="13.8 å››æ­¥è¿‡ç¨‹"></a>13.8 å››æ­¥è¿‡ç¨‹</h5><ul><li>åˆå§‹æ ‡è®°ï¼šåªæ ‡è®°GC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡</li><li>å¹¶å‘æ ‡è®°ï¼šè¿›è¡ŒGC Roots Tracingï¼ˆé“¾è·¯æ‰«æï¼‰çš„è¿‡ç¨‹</li><li>æœ€ç»ˆæ ‡è®°ï¼šä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ä¸ºç¨‹åºè¿è¡Œå¯¼è‡´æ ‡è®°å‘ç”Ÿå˜åŒ–çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡</li><li>ç­›é€‰å›æ”¶ï¼šæ ¹æ®æ—¶é—´æ¥è¿›è¡Œä»·å€¼æœ€å¤§åŒ–å›æ”¶</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326121914326.png" alt="image-20200326121914326"></p><h5 id="13-9-å‚æ•°é…ç½®"><a href="#13-9-å‚æ•°é…ç½®" class="headerlink" title="13.9 å‚æ•°é…ç½®"></a>13.9 å‚æ•°é…ç½®</h5><p>å¼€å‘äººå‘˜ä»…ä»…éœ€è¦ç”³æ˜ä»¥ä¸‹å‚æ•°å³å¯</p><p>ä¸‰æ­¥å½’çº³ï¼š<code>-XX:+UseG1GC  -Xmx32G  -XX:MaxGCPauseMillis=100</code></p><p>-XX:MaxGCPauseMillis=nï¼šæœ€å¤§GCåœé¡¿æ—¶é—´å•ä½æ¯«ç§’ï¼Œè¿™æ˜¯ä¸ªè½¯ç›®æ ‡ï¼ŒJVMå°½å¯èƒ½åœé¡¿å°äºè¿™ä¸ªæ—¶é—´</p><h5 id="13-10-G1å’ŒCMSæ¯”è¾ƒ"><a href="#13-10-G1å’ŒCMSæ¯”è¾ƒ" class="headerlink" title="13.10 G1å’ŒCMSæ¯”è¾ƒ"></a>13.10 G1å’ŒCMSæ¯”è¾ƒ</h5><ul><li>G1ä¸ä¼šäº§ç”Ÿå†…ç¢ç‰‡</li><li>æ˜¯å¯ä»¥ç²¾å‡†æ§åˆ¶åœé¡¿ã€‚è¯¥æ”¶é›†å™¨æ˜¯æŠŠæ•´ä¸ªå †ï¼ˆæ–°ç”Ÿä»£ã€è€å¹´ä»£ï¼‰åˆ’åˆ†æˆå¤šä¸ªå›ºå®šå¤§å°çš„åŒºåŸŸï¼Œæ¯æ¬¡æ ¹æ®å…è®¸åœé¡¿çš„æ—¶é—´å»æ”¶é›†åƒåœ¾æœ€å¤šçš„åŒºåŸŸã€‚</li></ul><h4 id="14SpringBootç»“åˆJVMGC"><a href="#14SpringBootç»“åˆJVMGC" class="headerlink" title="14SpringBootç»“åˆJVMGC"></a>14SpringBootç»“åˆJVMGC</h4><p>å¯åŠ¨å¾®æœåŠ¡æ—¶å€™ï¼Œå°±å¯ä»¥å¸¦ä¸ŠJVMå’ŒGCçš„å‚æ•°</p><ul><li>IDEAå¼€å‘å®Œå¾®æœåŠ¡å·¥ç¨‹</li><li>mavenè¿›è¡Œclean package</li><li>è¦æ±‚å¾®æœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼ŒåŒæ—¶é…ç½®æˆ‘ä»¬çš„JVM/GCçš„è°ƒä¼˜å‚æ•°<ul><li>æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å…·ä½“çš„ä¸šåŠ¡é…ç½®æˆ‘ä»¬å¯åŠ¨çš„JVMå‚æ•°</li></ul></li></ul><p>ä¾‹å¦‚ï¼š</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">java</span> -Xms<span class="hljs-number">1024</span>m -Xmx<span class="hljs-number">1024</span> -XX:UseG<span class="hljs-number">1</span>GC -jar   xxx.jar</code></pre></div><h1 id="ç¬¬-13-ç« -Linuxè¯Šæ–­åŸå› "><a href="#ç¬¬-13-ç« -Linuxè¯Šæ–­åŸå› " class="headerlink" title="ç¬¬ 13 ç«  Linuxè¯Šæ–­åŸå› "></a>ç¬¬ 13 ç«  Linuxè¯Šæ–­åŸå› </h1><h3 id="1-æ•´æœºï¼štopï¼ŒæŸ¥çœ‹æ•´æœºç³»ç»Ÿæ€§èƒ½"><a href="#1-æ•´æœºï¼štopï¼ŒæŸ¥çœ‹æ•´æœºç³»ç»Ÿæ€§èƒ½" class="headerlink" title="1 æ•´æœºï¼štopï¼ŒæŸ¥çœ‹æ•´æœºç³»ç»Ÿæ€§èƒ½"></a>1 æ•´æœºï¼štopï¼ŒæŸ¥çœ‹æ•´æœºç³»ç»Ÿæ€§èƒ½</h3><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326162329550.png" alt="image-20200326162329550"></p><p>ä½¿ç”¨topå‘½ä»¤çš„è¯ï¼Œé‡ç‚¹å…³æ³¨çš„æ˜¯ %CPUã€%MEM ã€load average ä¸‰ä¸ªæŒ‡æ ‡</p><ul><li>load averageä¸‰ä¸ªæŒ‡æ ‡ï¼šåˆ†åˆ«ä»£è¡¨1ã€5ã€15åˆ†é’Ÿçš„è´Ÿè½½æƒ…å†µ</li></ul><p>åœ¨è¿™ä¸ªå‘½ä»¤ä¸‹ï¼ŒæŒ‰1çš„è¯ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªCPUçš„å ç”¨æƒ…å†µ</p><p>uptimeï¼šç³»ç»Ÿæ€§èƒ½å‘½ä»¤çš„ç²¾ç®€ç‰ˆ</p><h3 id="2-CPUï¼švmstat"><a href="#2-CPUï¼švmstat" class="headerlink" title="2 CPUï¼švmstat"></a>2 CPUï¼švmstat</h3><ul><li>æŸ¥çœ‹CPUï¼ˆåŒ…å«ä½†æ˜¯ä¸é™äºï¼‰</li><li>æŸ¥çœ‹é¢å¤–<ul><li>æŸ¥çœ‹æ‰€æœ‰CPUæ ¸ä¿¡æ¯ï¼šmpstat -p ALL 2</li><li>æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨CPUçš„ç”¨é‡åˆ†è§£ä¿¡æ¯ï¼špidstat -u 1 -p è¿›ç¨‹ç¼–å·</li></ul></li></ul><p>å‘½ä»¤æ ¼å¼ï¼š<code>vmstat -n 2 3</code></p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326162803165.png" alt="image-20200326162803165"></p><p>ä¸€èˆ¬vmstatå·¥å…·çš„ä½¿ç”¨æ˜¯é€šè¿‡ä¸¤ä¸ªæ•°å­—å‚æ•°æ¥å®Œæˆçš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ®‹é˜³çš„æ—¶é—´é—´éš”æ•°ï¼ˆå•ä½ç§’ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é‡‡æ ·çš„æ¬¡æ•°</p><p><strong>procs</strong></p><div class="code-wrapper"><pre><code>rï¼šè¿è¡Œå’Œç­‰å¾…çš„CPUæ—¶é—´ç‰‡çš„è¿›ç¨‹æ•°ï¼ŒåŸåˆ™ä¸Š1æ ¸çš„CPUçš„è¿è¡Œé˜Ÿåˆ—ä¸è¦è¶…è¿‡2ï¼Œæ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œé˜Ÿåˆ—ä¸è¶…è¿‡æ€»æ ¸æ•°çš„2å€ï¼Œå¦åˆ™ä»£è¡¨ç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œæˆ‘ä»¬çœ‹è˜‘è‡åšå®¢æµ‹è¯•æœåŠ¡å™¨ï¼Œèƒ½å‘ç°éƒ½è¶…è¿‡äº†2ï¼Œè¯´æ˜ç°åœ¨å‹åŠ›è¿‡å¤§bï¼šç­‰å¾…èµ„æºçš„è¿›ç¨‹æ•°ï¼Œæ¯”å¦‚æ­£åœ¨ç­‰å¾…ç£ç›˜I/Oã€ç½‘ç»œI/Oç­‰</code></pre></div><p><strong>cpu</strong></p><div class="code-wrapper"><pre><code>usï¼šç”¨æˆ·è¿›ç¨‹æ¶ˆè€—CPUæ—¶é—´ç™¾åˆ†æ¯”ï¼Œuså€¼é«˜ï¼Œç”¨æˆ·è¿›ç¨‹æ¶ˆè€—CPUæ—¶é—´å¤šï¼Œå¦‚æœé•¿æœŸå¤§äº50%ï¼Œä¼˜åŒ–ç¨‹åºsyï¼šå†…æ ¸è¿›ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´ç™¾åˆ†æ¯”</code></pre></div><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326164521263.png" alt="image-20200326164521263"></p><div class="code-wrapper"><pre><code>us + sy å‚è€ƒå€¼ä¸º80%ï¼Œå¦‚æœus + sy å¤§äº80%ï¼Œè¯´æ˜å¯èƒ½å­˜åœ¨CPUä¸è¶³ï¼Œä»ä¸Šé¢çš„å›¾ç‰‡å¯ä»¥çœ‹å‡ºï¼Œus + syè¿˜æ²¡æœ‰è¶…è¿‡ç™¾åˆ†80ï¼Œå› æ­¤è¯´æ˜è˜‘è‡åšå®¢çš„CPUæ¶ˆè€—ä¸æ˜¯å¾ˆé«˜idï¼šå¤„äºç©ºé—²çš„CPUç™¾åˆ†æ¯”waï¼šç³»ç»Ÿç­‰å¾…IOçš„CPUæ—¶é—´ç™¾åˆ†æ¯”stï¼šæ¥è‡ªäºä¸€ä¸ªè™šæ‹Ÿæœºå·å–çš„CPUæ—¶é—´æ¯”</code></pre></div><h3 id="3-å†…å­˜ï¼šfree"><a href="#3-å†…å­˜ï¼šfree" class="headerlink" title="3 å†…å­˜ï¼šfree"></a>3 å†…å­˜ï¼šfree</h3><ul><li><p>åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜æ•°ï¼šfree -m</p></li><li><p>åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜/ç³»ç»Ÿç‰©ç†å†…å­˜ &gt; 70% å†…å­˜å……è¶³</p></li><li><p>åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜/ç³»ç»Ÿç‰©ç†å†…å­˜ &lt; 20% å†…å­˜ä¸è¶³ï¼Œéœ€è¦å¢åŠ å†…å­˜</p></li><li><p>20% &lt;  åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜/ç³»ç»Ÿç‰©ç†å†…å­˜ &lt; 70%ï¼Œè¡¨ç¤ºå†…å­˜åŸºæœ¬å¤Ÿç”¨</p></li></ul><p>free -hï¼šä»¥äººç±»èƒ½çœ‹æ‡‚çš„æ–¹å¼æŸ¥çœ‹ç‰©ç†å†…å­˜</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326170217637.png" alt="image-20200326170217637"></p><p>free -mï¼šä»¥MBä¸ºå•ä½ï¼ŒæŸ¥çœ‹ç‰©ç†å†…å­˜</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326165815071.png" alt="image-20200326165815071"></p><p>free -gï¼šä»¥GBä¸ºå•ä½ï¼ŒæŸ¥çœ‹ç‰©ç†å†…å­˜</p><h3 id="4-ç¡¬ç›˜ï¼šdf"><a href="#4-ç¡¬ç›˜ï¼šdf" class="headerlink" title="4 ç¡¬ç›˜ï¼šdf"></a>4 ç¡¬ç›˜ï¼šdf</h3><p>æ ¼å¼ï¼š<code>df -h  /</code>  (-hï¼šhumanï¼Œè¡¨ç¤ºä»¥äººç±»èƒ½çœ‹åˆ°çš„æ–¹å¼æ¢ç®—)</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326170318733.png" alt="image-20200326170318733"></p><ul><li>ç¡¬ç›˜IOï¼šiostat</li></ul><p>ç³»ç»Ÿæ…¢æœ‰ä¸¤ç§åŸå› å¼•èµ·çš„ï¼Œä¸€ä¸ªæ˜¯CPUé«˜ï¼Œä¸€ä¸ªæ˜¯å¤§é‡IOæ“ä½œ</p><p>æ ¼å¼ï¼š<code>iostat -xdk 2 3</code></p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326170522559.png" alt="image-20200326170522559"></p><p>ç£ç›˜å—è®¾å¤‡åˆ†å¸ƒï¼š</p><p>rkB /sï¼šæ¯ç§’è¯»å–æ•°æ®é‡kBï¼›</p><p>wkB/sï¼šæ¯ç§’å†™å…¥æ•°æ®é‡kBï¼›</p><p>svctm I/Oï¼šè¯·æ±‚çš„å¹³å‡æœåŠ¡æ—¶é—´ï¼Œå•ä½æ¯«ç§’</p><p>await I/Oï¼šè¯·æ±‚çš„å¹³å‡ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œå€¼è¶Šå°ï¼Œæ€§èƒ½è¶Šå¥½</p><p>utilï¼šä¸€ç§’é’Ÿæœ‰ç™¾åˆ†å‡ çš„æ—¶é—´ç”¨äºI/Oæ“ä½œã€‚æ¥è¿‘100%æ—¶ï¼Œè¡¨ç¤ºç£ç›˜å¸¦å®½è·‘æ»¡ï¼Œéœ€è¦ä¼˜åŒ–ç¨‹åºæˆ–è€…å¢åŠ ç£ç›˜ï¼›</p><p>rkB/sï¼ŒwkB/sæ ¹æ®ç³»ç»Ÿåº”ç”¨ä¸åŒä¼šæœ‰ä¸åŒçš„å€¼ï¼Œä½†æœ‰è§„å¾‹éµå¾ªï¼šé•¿æœŸã€è¶…å¤§æ•°æ®è¯»å†™ï¼Œè‚¯å®šä¸æ­£å¸¸ï¼Œéœ€è¦ä¼˜åŒ–ç¨‹åºè¯»å–ã€‚</p><p>svctmçš„å€¼ä¸awaitçš„å€¼å¾ˆæ¥è¿‘ï¼Œè¡¨ç¤ºå‡ ä¹æ²¡æœ‰I/Oç­‰å¾…ï¼Œç£ç›˜æ€§èƒ½å¥½ï¼Œå¦‚æœawaitçš„å€¼è¿œé«˜äºsvctmçš„å€¼ï¼Œåˆ™è¡¨ç¤ºI/Oé˜Ÿåˆ—ç­‰å¾…å¤ªé•¿ï¼Œéœ€è¦ä¼˜åŒ–ç¨‹åºæˆ–æ›´æ¢æ›´å¿«ç£ç›˜</p><h3 id="5-ç½‘ç»œIOï¼šifstat"><a href="#5-ç½‘ç»œIOï¼šifstat" class="headerlink" title="5 ç½‘ç»œIOï¼šifstat"></a>5 ç½‘ç»œIOï¼šifstat</h3><ul><li>é»˜è®¤æœ¬åœ°æ²¡æœ‰ï¼Œä¸‹è½½ifstat</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326171559406.png" alt="image-20200326171559406"></p><h3 id="6-ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨å˜æ…¢ï¼Œè¯Šæ–­æ€è·¯å’Œæ€§èƒ½è¯„ä¼°"><a href="#6-ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨å˜æ…¢ï¼Œè¯Šæ–­æ€è·¯å’Œæ€§èƒ½è¯„ä¼°" class="headerlink" title="6 ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨å˜æ…¢ï¼Œè¯Šæ–­æ€è·¯å’Œæ€§èƒ½è¯„ä¼°"></a>6 ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨å˜æ…¢ï¼Œè¯Šæ–­æ€è·¯å’Œæ€§èƒ½è¯„ä¼°</h3><p>è®°ä¸€æ¬¡å°è±¡æ·±åˆ»çš„æ•…éšœï¼Ÿ</p><p>ç»“åˆLinux å’Œ JDKå‘½ä»¤ä¸€èµ·åˆ†æï¼Œæ­¥éª¤å¦‚ä¸‹</p><ul><li><p>ä½¿ç”¨topå‘½ä»¤æ‰¾å‡ºCPUå æ¯”æœ€é«˜çš„</p></li><li><p>ps -ef æˆ–è€… jps è¿›ä¸€æ­¥å®šä½ï¼Œå¾—çŸ¥æ˜¯ä¸€ä¸ªæ€ä¹ˆæ ·çš„åå°ç¨‹åºå‡ºçš„é—®é¢˜</p></li><li><p>å®šä½åˆ°å…·ä½“çº¿ç¨‹æˆ–è€…ä»£ç </p><ul><li>ps -mp è¿›ç¨‹  -o THREADï¼Œtidï¼Œtime</li><li>å‚æ•°è§£é‡Š<ul><li>-mï¼šæ˜¾ç¤ºæ‰€æœ‰çš„çº¿ç¨‹</li><li>-pï¼špidè¿›ç¨‹ä½¿ç”¨CPUçš„æ—¶é—´</li><li>-oï¼šè¯¥å‚æ•°åæ˜¯ç”¨æˆ·è‡ªå®šä¹‰æ ¼å¼</li></ul></li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326173656164.png" alt="image-20200326173656164"></p></li><li><p>å°†éœ€è¦çš„çº¿ç¨‹IDè½¬æ¢ä¸º16è¿›åˆ¶æ ¼å¼ï¼ˆè‹±æ–‡å°å†™æ ¼å¼ï¼‰</p><ul><li>printf â€œ%x\nâ€ æœ‰é—®é¢˜çš„çº¿ç¨‹ID</li></ul></li><li><p>jstack è¿›ç¨‹ID | grep tidï¼ˆ16è¿›åˆ¶çº¿ç¨‹IDå°å†™è‹±æ–‡ï¼‰ -A60</p><p>ç²¾å‡†å®šä½åˆ°é”™è¯¯çš„åœ°æ–¹</p></li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326174107444.png" alt="image-20200326174107444"></p><h1 id="ç¬¬-14-ç« -Github-ä½¿ç”¨"><a href="#ç¬¬-14-ç« -Github-ä½¿ç”¨" class="headerlink" title="ç¬¬ 14 ç«  Github ä½¿ç”¨"></a>ç¬¬ 14 ç«  Github ä½¿ç”¨</h1><p>ä½¿ç”¨Githubä¼˜ç§€æ¡†æ¶ + æºç  æå‡è‡ªå·±</p><h2 id="1-å¸¸ç”¨è¯å«ä¹‰"><a href="#1-å¸¸ç”¨è¯å«ä¹‰" class="headerlink" title="1 å¸¸ç”¨è¯å«ä¹‰"></a>1 å¸¸ç”¨è¯å«ä¹‰</h2><ul><li><p>watchï¼šä¼šæŒç»­æ”¶åˆ°è¯¥é¡¹ç›®çš„åŠ¨æ€</p></li><li><p>forkï¼šå¤åˆ¶æŸä¸ªä»“åº“åˆ°è‡ªå·±çš„Githubä»“åº“ä¸­</p></li><li><p>starï¼šå¯ä»¥ç†è§£ä¸ºç‚¹èµ</p></li><li><p>cloneï¼šå°†é¡¹ç›®ä¸‹è½½è‡³æœ¬åœ°</p></li><li><p>followï¼šå…³æ³¨ä½ æ„Ÿå…´è¶£çš„ä½œè€…ï¼Œä¼šæ”¶åˆ°ä»–ä»¬çš„åŠ¨æ€</p><p>inå…³é”®å­—é™åˆ¶æœç´¢èŒƒå›´</p></li><li><p>å…¬å¼ï¼š<code>XXXå…³é”®å­— in:name æˆ– description æˆ– readme</code></p></li><li><p>xxx in:name   é¡¹ç›®åç§°å«æœ‰XXXçš„</p></li><li><p>xxx in:description   é¡¹ç›®æè¿°å«æœ‰XXXçš„</p></li><li><p>xxx in:readme   é¡¹ç›®çš„readmeæ–‡ä»¶ä¸­åŒ…å«XXXçš„</p></li><li><p>ç»„åˆä½¿ç”¨</p><ul><li>xxx   in:name,readme    é¡¹ç›®çš„åç§°å’Œreadmeä¸­åŒ…å«xxxçš„</li></ul></li></ul><h2 id="2-starsæˆ–forkæ•°é‡å…³é”®å­—æŸ¥æ‰¾"><a href="#2-starsæˆ–forkæ•°é‡å…³é”®å­—æŸ¥æ‰¾" class="headerlink" title="2 starsæˆ–forkæ•°é‡å…³é”®å­—æŸ¥æ‰¾"></a>2 starsæˆ–forkæ•°é‡å…³é”®å­—æŸ¥æ‰¾</h2><ul><li>å…¬å¼ï¼š<ul><li><code>xxxå…³é”®å­—  stars é€šé…ç¬¦</code>  :&gt;  æˆ–è€… :&gt;=</li><li>åŒºé—´èŒƒå›´æ•°å­—ï¼š  <code>stars:æ•°å­—1..æ•°å­—2</code></li></ul></li><li>æ¡ˆä¾‹<ul><li>æŸ¥æ‰¾starsæ•°å¤§äºç­‰äº5000çš„Springbooté¡¹ç›®ï¼šspringboot  stars:&gt;=5000</li><li>æŸ¥æ‰¾forksæ•°åœ¨1000~2000ä¹‹é—´çš„springbooté¡¹ç›®ï¼šspringboot forks:1000..5000</li></ul></li><li>ç»„åˆä½¿ç”¨<ul><li>æŸ¥æ‰¾starå¤§äº1000ï¼Œforkæ•°åœ¨500åˆ°1000ï¼š<code>springboot stars:&gt;1000 forks:500..1000</code></li></ul></li></ul><h2 id="3-awesomeåŠ å¼ºæœç´¢"><a href="#3-awesomeåŠ å¼ºæœç´¢" class="headerlink" title="3 awesomeåŠ å¼ºæœç´¢"></a>3 awesomeåŠ å¼ºæœç´¢</h2><ul><li>å…¬å¼ï¼š<code>awesome å…³é”®å­—</code>ï¼šawesomeç³»åˆ—ï¼Œä¸€èˆ¬ç”¨æ¥æ”¶é›†å­¦ä¹ ã€å·¥å…·ã€ä¹¦ç±ç±»ç›¸å…³çš„é¡¹ç›®</li><li>æœç´¢ä¼˜ç§€çš„redisç›¸å…³çš„é¡¹ç›®ï¼ŒåŒ…æ‹¬æ¡†æ¶ï¼Œæ•™ç¨‹ç­‰  awesome redis</li></ul><h2 id="4-é«˜äº®æ˜¾ç¤ºæŸè¡Œä»£ç "><a href="#4-é«˜äº®æ˜¾ç¤ºæŸè¡Œä»£ç " class="headerlink" title="4 é«˜äº®æ˜¾ç¤ºæŸè¡Œä»£ç "></a>4 é«˜äº®æ˜¾ç¤ºæŸè¡Œä»£ç </h2><ul><li>ä¸€è¡Œï¼šåœ°å€åé¢ç´§è·Ÿ  #L10<ul><li><code>https://github.com/moxi624/mogu_blog_v2/blob/master/mogu_admin/pom.xml#L13</code></li></ul></li><li>å¤šè¡Œï¼šåœ°å€åé¢ç´§è·Ÿ #Lx - #Ln<ul><li><code>https://github.com/moxi624/mogu_blog_v2/blob/master/mogu_admin/pom.xml#L13-L30</code></li></ul></li></ul><h2 id="5-é¡¹ç›®å†…æœç´¢"><a href="#5-é¡¹ç›®å†…æœç´¢" class="headerlink" title="5 é¡¹ç›®å†…æœç´¢"></a>5 é¡¹ç›®å†…æœç´¢</h2><ul><li>ä½¿ç”¨è‹±æ–‡å­—æ¯ <code>t</code> ,å¼€å¯é¡¹ç›®å†…æœç´¢</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200326212650322.png" alt="image-20200326212650322"></p><h2 id="6-æœç´¢æŸä¸ªåœ°åŒºå†…çš„å¤§ä½¬"><a href="#6-æœç´¢æŸä¸ªåœ°åŒºå†…çš„å¤§ä½¬" class="headerlink" title="6 æœç´¢æŸä¸ªåœ°åŒºå†…çš„å¤§ä½¬"></a>6 æœç´¢æŸä¸ªåœ°åŒºå†…çš„å¤§ä½¬</h2><ul><li>locationï¼šåœ°åŒº</li><li>languageï¼šè¯­è¨€</li><li>ä¾‹å¦‚ï¼š<code>location:beijing language:java</code></li></ul><h1 id="ç¬¬-15-ç« -ä¹è§‚é”å’Œæ‚²è§‚é”"><a href="#ç¬¬-15-ç« -ä¹è§‚é”å’Œæ‚²è§‚é”" class="headerlink" title="ç¬¬ 15 ç«  ä¹è§‚é”å’Œæ‚²è§‚é”"></a>ç¬¬ 15 ç«  ä¹è§‚é”å’Œæ‚²è§‚é”</h1><h2 id="1-ä¹è§‚é”"><a href="#1-ä¹è§‚é”" class="headerlink" title="1 ä¹è§‚é”"></a>1 ä¹è§‚é”</h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ä¹è§‚é”ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ååˆ†ä¹è§‚ï¼Œå®ƒæ€»æ˜¯è®¤ä¸ºä¸ä¼šå‡ºç°é—®é¢˜ï¼Œæ— è®ºå¹²ä»€ä¹ˆéƒ½ä¸å»ä¸Šé”~ï¼Œå¦‚æœå‡ºç°äº†é—®é¢˜ï¼Œå†æ¬¡æ›´æ–°å€¼æµ‹è¯•ï¼Œè¿™é‡Œä½¿ç”¨äº†versionå­—æ®µã€‚</p><p>ä¹Ÿå°±æ˜¯æ¯æ¬¡æ›´æ–°çš„æ—¶å€™åŒæ—¶ç»´æŠ¤ä¸€ä¸ªversionå­—æ®µ</p><h3 id="ä¹è§‚é”å®ç°æ–¹å¼"><a href="#ä¹è§‚é”å®ç°æ–¹å¼" class="headerlink" title="ä¹è§‚é”å®ç°æ–¹å¼"></a>ä¹è§‚é”å®ç°æ–¹å¼</h3><ul><li>å–å‡ºè®°å½•æ—¶ï¼Œè·å–å½“å‰çš„version</li><li>æ›´æ–°æ—¶ï¼Œå¸¦ä¸Šè¿™ä¸ªversion</li><li>æ‰§è¡Œæ›´æ–°æ—¶ï¼Œset version = newVersion where version = oldVersion</li><li>å¦‚æœversionä¸å¯¹ï¼Œå°±æ›´æ–°å¤±è´¥</li></ul><div class="code-wrapper"><pre><code class="hljs shell">ä¹è§‚é”ï¼š1ï¼šå…ˆæŸ¥è¯¢ï¼Œè·å¾—ç‰ˆæœ¬å· version =1-- A çº¿ç¨‹update user set name = &quot;é™Œæºª&quot;, version = version + 1 where id = 2 and version = 1-- B çº¿ç¨‹æŠ¢å…ˆå®Œæˆï¼Œè¿™ä¸ªæ—¶å€™Version = 2ï¼Œå¯¼è‡´Aä¿®æ”¹å¤±è´¥update user set name = &quot;é™Œæºª&quot;, version = version + 1 where id = 2 and version = 1</code></pre></div><h2 id="2-MybatisPlusä½¿ç”¨ä¹è§‚é”"><a href="#2-MybatisPlusä½¿ç”¨ä¹è§‚é”" class="headerlink" title="2 MybatisPlusä½¿ç”¨ä¹è§‚é”"></a>2 MybatisPlusä½¿ç”¨ä¹è§‚é”</h2><p>é¦–å…ˆéœ€è¦åœ¨æ•°æ®åº“å¢åŠ versionå­—å…¸ï¼Œé»˜è®¤ä¸º1</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200329172158610.png" alt="image-20200329172158610"></p><p>ç„¶ååœ¨å®ä½“ç±»å¢åŠ å¯¹åº”çš„å­—æ®µ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// ä¹è§‚é”Versionæ³¨è§£</span><span class="hljs-meta">@Version</span><span class="hljs-keyword">private</span> Integer version;</code></pre></div><p>æ³¨å†Œç»„ä»¶ï¼Œåœ¨MybatisPlusConfigä¸­é…ç½®</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ³¨å†Œä¹è§‚é”</span><span class="hljs-meta">@Bean</span><span class="hljs-function"><span class="hljs-keyword">public</span> OptimisticLockerInterceptor <span class="hljs-title">optimisticLockerInterceptor</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> OptimisticLockerInterceptor();&#125;</code></pre></div><h2 id="3-æ‚²è§‚é”"><a href="#3-æ‚²è§‚é”" class="headerlink" title="3 æ‚²è§‚é”"></a>3 æ‚²è§‚é”</h2><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ååˆ†æ‚²è§‚ï¼Œå®ƒæ€»æ˜¯è®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ— è®ºä»€ä¹ˆæ“ä½œéƒ½ä¼šä¸Šé”ï¼Œå†æ¬¡æ“ä½œ</p><h1 id="ç¬¬3éƒ¨åˆ†-æ¡†æ¶"><a href="#ç¬¬3éƒ¨åˆ†-æ¡†æ¶" class="headerlink" title="ç¬¬3éƒ¨åˆ† æ¡†æ¶"></a>ç¬¬3éƒ¨åˆ† æ¡†æ¶</h1><h1 id="ç¬¬16-ç« -Spring-æºç "><a href="#ç¬¬16-ç« -Spring-æºç " class="headerlink" title="ç¬¬16 ç«  Spring æºç "></a>ç¬¬16 ç«  Spring æºç </h1><h2 id="1-Springæºç æ–¹é¢çš„çŸ¥è¯†"><a href="#1-Springæºç æ–¹é¢çš„çŸ¥è¯†" class="headerlink" title="1 Springæºç æ–¹é¢çš„çŸ¥è¯†"></a>1 Springæºç æ–¹é¢çš„çŸ¥è¯†</h2><ul><li>Spring beançš„ç”Ÿå‘½å‘¨æœŸ</li><li>Spring å·¥å‚ï¼ŒSpringå®¹å™¨ï¼Œä¸Šä¸‹æ–‡ </li><li>Spring BeanPostprocessor</li><li>Spring å’Œ ä¸»æµæ¡†æ¶çš„æºç </li><li>Spring BeanFactory å’Œ FactoryBeançš„åŒºåˆ«</li></ul><h2 id="2-è°ˆè°ˆä½ å¯¹Springçš„ç†è§£"><a href="#2-è°ˆè°ˆä½ å¯¹Springçš„ç†è§£" class="headerlink" title="2 è°ˆè°ˆä½ å¯¹Springçš„ç†è§£"></a>2 è°ˆè°ˆä½ å¯¹Springçš„ç†è§£</h2><p>IOCã€AOPåªæ˜¯ä½œä¸ºSpring Frameworké‡Œé¢ä¸€éƒ¨åˆ†ï¼ŒåŒæ—¶è¿˜æœ‰è¿˜æœ‰eventsï¼Œresourcesï¼Œi18nï¼Œvalidationï¼Œdata bindingï¼Œtype conversionï¼ŒSpEL</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402092317669.png" alt="image-20200402092317669"></p><h2 id="3-Springä¸Šä¸‹æ–‡"><a href="#3-Springä¸Šä¸‹æ–‡" class="headerlink" title="3 Springä¸Šä¸‹æ–‡"></a>3 Springä¸Šä¸‹æ–‡</h2><p>ä»ä»£ç çº§åˆ«æ¥è¯´ï¼Œå°±æ˜¯æŒ‡Spring Context</p><p>ä»æºç çº§åˆ«ï¼Œä½†æˆ‘ä»¬åˆå§‹åŒ–Spring Contextçš„æ—¶å€™ï¼Œä¸€å †çš„Springç»„ä»¶å›´ç»•åœ¨ä¸€èµ·ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œè¿™ä¸ªçŠ¶æ€å°±è¢«ç§°ä¸ºSpringç¯å¢ƒ</p><h2 id="4-Springåˆå§‹åŒ–"><a href="#4-Springåˆå§‹åŒ–" class="headerlink" title="4 Springåˆå§‹åŒ–"></a>4 Springåˆå§‹åŒ–</h2><p>é¦–å…ˆéœ€è¦å¼•å…¥Springçš„ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬æš‚æ—¶åªæ˜¯åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåªéœ€è¦ç”¨åˆ°IOC</p><div class="code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.9.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div><p>ä¸ºäº†æ›´åŠ äº†è§£Springåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸‰ä¸ªç±»</p><p>1ã€AppConfig.javaï¼Œå¯ä»¥å½“æˆæ˜¯æ‰«æç±»ï¼Œä¹Ÿå°±æ˜¯é…ç½®æˆ‘ä»¬éœ€è¦æ‰«æçš„ç›®å½•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-meta">@ComponentScan(&quot;com.pnca.interview.study.spring&quot;)</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppConfig</span> </span>&#123;&#125;</code></pre></div><p>2ã€BeanTest.javaï¼Œæˆ‘ä»¬éœ€è¦è¢«æ‰«æåˆ°çš„Bean</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BeanTest</span> </span>&#123;&#125;</code></pre></div><p>3ã€Test.javaï¼Œå¯åŠ¨æµ‹è¯•ç±»</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// åˆå§‹åŒ–</span>        AnnotationConfigApplicationContext annotationConfigApplicationContext = <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(AppConfig.class);        System.out.println(annotationConfigApplicationContext.getBean(BeanTest.class));    &#125;&#125;</code></pre></div><p>æœ€åæˆ‘ä»¬é€šè¿‡æ³¨è§£çš„æ–¹å¼ï¼Œæ¥è·å–Spring IOCæ‰«æåˆ°çš„Beanï¼Œæœ€åæ‰“å°å‡ºæ¥</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402091642787.png" alt="image-20200402091642787"></p><p>tipï¼šIDEAç‚¹å‡»è¿›å»çš„æºç ç›®å½•ï¼Œå…¶å®æ˜¯IDEAåç¼–è¯‘å¾—åˆ°çš„ï¼Œå’ŒåŸæ¥çš„æºç ä¼šå­˜åœ¨ä¸€äº›å‡ºå…¥ï¼Œæ˜¯IDEAä¸“é—¨ä¼˜åŒ–è¿‡çš„ï¼Œå› æ­¤å¦‚æœä½ éœ€è¦ä¿®æ”¹æºç çš„è¯ï¼Œè¿˜æ˜¯éœ€è¦åœ¨å®˜ç½‘ä¸‹è½½å¯¹åº”çš„æºç åŒ…</p><div class="code-wrapper"><pre><code class="hljs http">https://github.com/spring-projects/spring-framework</code></pre></div><h2 id="5-SpringBeançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#5-SpringBeançš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="5 SpringBeançš„ç”Ÿå‘½å‘¨æœŸ"></a>5 SpringBeançš„ç”Ÿå‘½å‘¨æœŸ</h2><p>Springä¸­çš„Beanä¸å¯èƒ½æ˜¯ç›´æ¥newå…³é”®å­—åˆ›å»ºå‡ºæ¥çš„</p><ul><li>æŠŠç±»æ‰«æå‡ºæ¥ï¼ˆæ‰«æå‡ºæ¥ååšäº†ä»€ä¹ˆï¼Ÿï¼‰</li><li>æŠŠBeanå®ä¾‹åŒ–</li></ul><p>åˆå§‹åŒ–Springç¯å¢ƒæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡æ³¨è§£çš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡XMLçš„æ–¹å¼</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ–¹å¼1ï¼Œç›®å‰ç”¨çš„æ¯”è¾ƒå¤š</span>AnnotationConfigApplicationContext annotationConfigApplicationContext = <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(AppConfig.class)</code></pre></div><p>åŒæ—¶åœ¨è¿™ä¸ªæ–¹æ³•çš„å†…éƒ¨ï¼Œä½¿ç”¨äº†this()</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402100813001.png" alt="image-20200402100813001"></p><p>è°ƒç”¨AnnotationConfigApplicationContextæ— å‚æ„é€ æ–¹æ³•ï¼ŒåŒæ—¶å› ä¸ºè¯¥ç±»åˆç»§æ‰¿äº†ä¸€ä¸ªçˆ¶ç±» GenericApplicationContextï¼Œå­ç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿˜ä¼šè°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œåœ¨çˆ¶ç±»ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°å®ƒåˆå§‹åŒ–äº†ä¸€ä¸ªBeanFactoryï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç»å¸¸æåˆ°çš„Springå·¥å‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402100434794-16295172680416.png" alt="image-20200402100434794"></p><p>è¿™ä¸ªå·¥å‚æœ€é‡è¦çš„åŠŸèƒ½å°±æ˜¯äº§ç”ŸBean</p><p>åŒæ—¶åœ¨AnnotationConfigApplicationæ–¹æ³•çš„æœ€åï¼Œè¿˜æœ‰ä¸€ä¸ªrefresh()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªSpringæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„å†…éƒ¨ï¼ŒåŒæ—¶è°ƒç”¨äº†åå¤šä¸ªæ–¹æ³•ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯ invokeBeanFactoryPostProcessors()</p><div class="code-wrapper"><pre><code class="hljs java">invokeBeanFactoryPostProcessors() &#123;<span class="hljs-comment">// æ‰«æç±»ï¼š</span><span class="hljs-comment">// å¤„ç†äº†å„ç§importï¼šä¾‹å¦‚@import(&quot;xxx.xml&quot;), @MapperScanner, @CompoentScanner ..... </span>&#125;</code></pre></div><h3 id="æ™®é€šç±»çš„å®ä¾‹åŒ–"><a href="#æ™®é€šç±»çš„å®ä¾‹åŒ–" class="headerlink" title="æ™®é€šç±»çš„å®ä¾‹åŒ–"></a>æ™®é€šç±»çš„å®ä¾‹åŒ–</h3><p>æ™®é€šç±»çš„å®ä¾‹åŒ–ï¼Œå°±æ˜¯é€šè¿‡javacç¼–è¯‘æˆxxx.classæ–‡ä»¶ï¼Œç„¶åæŸä¸€å¤©é€šè¿‡newå…³é”®å­—è¿›è¡Œå®ä¾‹åŒ–ï¼ŒJVMå°±ä¼šæŠŠè¿™ä¸ªclassç±»åŠ è½½åˆ°JVMå†…å­˜ä¸­ï¼Œè¿™é‡Œé¢å°±æ¶‰åŠåˆ°äº†æ–¹æ³•åŒºï¼Œå †æ ˆå­˜å‚¨ç­‰ã€‚</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402101551621.png" alt="image-20200402101551621"></p><h3 id="Spring-Beanå®ä¾‹åŒ–è¿‡ç¨‹"><a href="#Spring-Beanå®ä¾‹åŒ–è¿‡ç¨‹" class="headerlink" title="Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹"></a>Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹</h3><ul><li><p>é¦–å…ˆSpringä¼šå°†å…¨éƒ¨çš„Classç±»ï¼Œé€šè¿‡classLoaderåŠ è½½åˆ°JVMä¸­</p></li><li><p>ç„¶ååœ¨é€šè¿‡æ‰«æï¼Œåˆ›å»ºå¾ˆå¤šBeanDefinitionï¼Œæˆ‘ä»¬é€šè¿‡åå°„å°†å¯¹åº”Classçš„ä¿¡æ¯å¡«å……åˆ°BeanDefinitionä¸­</p><ul><li><p>è¿™é‡Œçš„BeanDefinitionæ˜¯ç”¨æ¥æè¿°Beançš„ï¼Œä¹Ÿå°±æ˜¯Beançš„ä¸€äº›ä¿¡æ¯å­˜å‚¨</p><div class="code-wrapper"><pre><code class="hljs java">RootBeanDefinition rootBeanDefinition = <span class="hljs-keyword">new</span> RootBeanDefinition();rootBeanDefinition.setBeanClassName(<span class="hljs-string">&quot;BeanTest&quot;</span>);rootBeanDefinition.setBeanClass(BeanTest.class);rootBeanDefinition.setScope(<span class="hljs-string">&quot;prototype&quot;</span>);rootBeanDefinition.setLazyInit();</code></pre></div></li></ul></li></ul><ul><li>ç„¶ååœ¨æŠŠå¡«å……å¥½çš„BeanDefinitionä¸€ä¸ªä¸ªæ”¾å…¥åˆ°Mapä¸­ï¼ŒSpringæ‰«æäº†å‡ ä¸ªç±»ï¼ŒMapä¸­å°±æœ‰å‡ ä¸ªç±»ï¼Œè¿™ä¸ªMapè¢«ç§°ä¸º BeanDefinitionMap</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402102958645.png" alt="image-20200402102958645"></p><ul><li>æœ€åæˆ‘ä»¬å°†è¿™ä¸ªBeanDefinationMapæ”¾å…¥äº†Springå•ä¾‹æ± ä¸­</li></ul><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402104318234.png" alt="image-20200402104318234"></p><p>å®Œæ•´çš„åŠ è½½å›¾ï¼Œå·¦è¾¹çº¢è‰²éƒ¨åˆ†å°±æ˜¯Springçš„åŠ è½½è¿‡ç¨‹ï¼Œç„¶åå¼€æ”¾çš„åŸåˆ™ï¼Œå®ƒè¿˜æä¾›äº†å¾ˆå¤šæ‰©å±•æ¥å£ï¼Œè®©ä½ å¯ä»¥å¹²æ‰°åˆ°Sringçš„åŠ è½½è¿‡ç¨‹ï¼Œä½¿å¾—</p><p><img src="/2021/07/30/Java%E9%9D%A2%E8%AF%95/image-20200402104306006.png" alt="image-20200402104306006"></p><p>ä¾‹å¦‚ï¼Œå¾ˆå¤šéœ€è¦å¯¹Springè¿›è¡Œæ‰©å±•çš„ï¼Œä¾‹å¦‚Mybatisï¼Œå…¶å®éƒ½æ˜¯å®ç°äº† BeanFactoryPostProcessoræ¥å£</p><p>åœ¨æ‰§è¡Œæ‰«æçš„æ—¶å€™ï¼Œå®ƒä¼šæ‰«æSpring æä¾›çš„ BeanFactoryPostProcessorï¼Œä»¥åŠç¨‹åºå‘˜æ‰©å±•çš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBeanFactoryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BeanFactoryPostProcessor</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;    &#125;&#125;</code></pre></div>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Java/">Java</category>
      
      <category domain="https://pncalbl.github.io/categories/Java/Tool/">Tool</category>
      
      
      <category domain="https://pncalbl.github.io/tags/Java/">Java</category>
      
      
      <comments>https://pncalbl.github.io/2021/07/30/Java%E9%9D%A2%E8%AF%95/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>K8s å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2021/07/22/K8s%E5%AD%A6%E4%B9%A0/</link>
      <guid>https://pncalbl.github.io/2021/07/22/K8s%E5%AD%A6%E4%B9%A0/</guid>
      <pubDate>Wed, 21 Jul 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;ç¬¬1ç« -Kubernetesç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç¬¬1ç« -Kubernetesç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬1ç«  Kubernetesç®€ä»‹&quot;&gt;&lt;/a&gt;ç¬¬1ç«  Kubernetesç®€ä»‹&lt;/h1&gt;&lt;h2 id=&quot;1-æ¥æº&quot;&gt;&lt;a </description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="ç¬¬1ç« -Kubernetesç®€ä»‹"><a href="#ç¬¬1ç« -Kubernetesç®€ä»‹" class="headerlink" title="ç¬¬1ç«  Kubernetesç®€ä»‹"></a>ç¬¬1ç«  Kubernetesç®€ä»‹</h1><h2 id="1-æ¥æº"><a href="#1-æ¥æº" class="headerlink" title="1 æ¥æº"></a>1 æ¥æº</h2><p>bilibiliå°šç¡…è°·K8sè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1GT4y1A756">https://www.bilibili.com/video/BV1GT4y1A756</a></p><p>ä¸­æ–‡å®˜ç½‘ï¼š<a href="https://kubernetes.io/zh">https://kubernetes.io/zh</a></p><p>ä¸­æ–‡ç¤¾åŒºï¼š<a href="https://www.kubernetes.org.cn/">https://www.kubernetes.org.cn/</a></p><h2 id="2-ä»‹ç»"><a href="#2-ä»‹ç»" class="headerlink" title="2 ä»‹ç»"></a>2 ä»‹ç»</h2><p>K8sä¸»è¦è®²çš„å°±æ˜¯Kubernetesï¼Œé¦–å…ˆKubernetesé¦–å­—æ¯ä¸ºKï¼Œæœ«å°¾ä¸ºsï¼Œä¸­é—´ä¸€å…±æœ‰8ä¸ªå­—æ¯ï¼Œæ‰€ä»¥ç®€ç§°K8s</p><h2 id="3-å‰ç½®çŸ¥è¯†"><a href="#3-å‰ç½®çŸ¥è¯†" class="headerlink" title="3 å‰ç½®çŸ¥è¯†"></a>3 å‰ç½®çŸ¥è¯†</h2><ul><li>Linuxæ“ä½œç³»ç»Ÿ</li><li>Docker</li></ul><h2 id="4-è¯¾ç¨‹ç®€ä»‹"><a href="#4-è¯¾ç¨‹ç®€ä»‹" class="headerlink" title="4 è¯¾ç¨‹ç®€ä»‹"></a>4 è¯¾ç¨‹ç®€ä»‹</h2><ul><li><p>K8sæ¦‚å¿µå’Œæ¶æ„</p></li><li><p>ä»é›¶æ­å»ºK8sé›†ç¾¤</p><ul><li>åŸºäºå®¢æˆ·ç«¯å·¥å…·kubeadmæ­å»ºï¼ˆç®€å•ï¼Œæœ€å¤šåŠå°æ—¶ï¼‰</li><li>åŸºäºäºŒè¿›åˆ¶åŒ…æ–¹å¼ï¼ˆèƒ½çœ‹åˆ°å†…éƒ¨çš„æ¶æ„ï¼‰</li></ul></li><li><p>K8sæ ¸å¿ƒæ¦‚å¿µ</p><ul><li>Podï¼šK8sç®¡ç†çš„æœ€å°å•ä½çº§ï¼Œæ˜¯æ‰€æœ‰ä¸šåŠ¡ç±»å‹çš„åŸºç¡€</li><li>Controllerï¼šæ§åˆ¶å™¨ï¼Œæœ‰çŠ¶æ€ï¼Œæ— çŠ¶æ€ï¼Œä¸€æ¬¡ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ï¼Œå®ˆæŠ¤è¿›ç¨‹</li><li>Service Ingressï¼šå¯¹å¤–æš´éœ²ç«¯å£</li><li>RBACï¼šå®‰å…¨æœºåˆ¶ï¼Œæƒé™æ¨¡å‹</li><li>Helmï¼šä¸‹è½½æœºåˆ¶</li><li>æŒä¹…åŒ–å­˜å‚¨</li></ul></li><li><p>æ­å»ºé›†ç¾¤ç›‘æ§å¹³å°ç³»ç»Ÿ</p></li><li><p>ä»é›¶æ­å»ºé«˜å¯ç”¨K8sé›†ç¾¤</p></li><li><p>åœ¨é›†ç¾¤ç¯å¢ƒéƒ¨ç½²é¡¹ç›®</p></li></ul><h2 id="5-K8sæ¦‚å¿µå’Œç‰¹æ€§"><a href="#5-K8sæ¦‚å¿µå’Œç‰¹æ€§" class="headerlink" title="5 K8sæ¦‚å¿µå’Œç‰¹æ€§"></a>5 K8sæ¦‚å¿µå’Œç‰¹æ€§</h2><h3 id="5-1-éƒ¨ç½²å‘å±•å†ç¨‹"><a href="#5-1-éƒ¨ç½²å‘å±•å†ç¨‹" class="headerlink" title="5.1 éƒ¨ç½²å‘å±•å†ç¨‹"></a>5.1 éƒ¨ç½²å‘å±•å†ç¨‹</h3><p>æˆ‘ä»¬çš„é¡¹ç›®éƒ¨ç½²ä¹Ÿåœ¨ç»å†ä¸‹é¢çš„è¿™æ ·ä¸€ä¸ªå†ç¨‹</p><blockquote><p>ä¼ ç»Ÿéƒ¨ç½² -&gt; è™šæ‹ŸåŒ–éƒ¨ç½²æ—¶ä»£ -&gt; å®¹å™¨éƒ¨ç½²æ—¶ä»£</p></blockquote><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122104102715.png" alt="image-20201122104102715"></p><ul><li><strong>ä¼ ç»Ÿéƒ¨ç½²æ—¶ä»£</strong>ï¼šæ—©æœŸï¼Œç»„ç»‡åœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºã€‚æ— æ³•ä¸ºç‰©ç†æœåŠ¡å™¨ä¸­çš„åº”ç”¨ç¨‹åºå®šä¹‰èµ„æºè¾¹ç•Œï¼Œè¿™ä¼šå¯¼è‡´èµ„æºåˆ†é…é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°-ä¸€ä¸ªåº”ç”¨ç¨‹åºå ç”¨å¤§éƒ¨åˆ†èµ„æºçš„æƒ…å†µï¼Œç»“æœå¯èƒ½å¯¼è‡´å…¶ä»–åº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸‹é™ã€‚â€“ç§è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ä¸åŒçš„ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œæ¯ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†æ˜¯ç”±äºèµ„æºåˆ©ç”¨ä¸è¶³è€Œæ— æ³•æ‰©å±•ï¼Œå¹¶ä¸”ç»„ç»‡ç»´æŠ¤è®¸å¤šç‰©ç†æœåŠ¡å™¨çš„æˆæœ¬å¾ˆé«˜ã€‚</li><li><strong>è™šæ‹ŸåŒ–éƒ¨ç½²æ—¶ä»£</strong>ï¼šä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œå¼•å…¥äº†è™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œå®ƒå…è®¸æ‚¨åœ¨å•ä¸ªç‰©ç†æœåŠ¡å™¨çš„CPU.ä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚è™šæ‹ŸåŒ–åŠŸèƒ½å…è®¸åº”ç”¨ç¨‹åºåœ¨VMä¹‹é—´éš”ç¦»ï¼Œå¹¶æä¾›å®‰å…¨çº§åˆ«ï¼Œå› ä¸ºä¸€ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ä¿¡æ¯ä¸èƒ½è¢«å¦ä¸€åº”ç”¨ç¨‹åºè‡ªç”±åœ°è®¿é—®ã€‚å› ä¸ºè™šæ‹ŸåŒ–å¯ä»¥è½»æ¾åœ°æ·»åŠ æˆ–æ›´æ–°åº”ç”¨ç¨‹åºã€é™ä½ç¡¬ä»¶æˆæœ¬ç­‰ç­‰ï¼Œæ‰€ä»¥è™šæ‹ŸåŒ–å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨ç‰©ç†æœåŠ¡å™¨ä¸­çš„èµ„æºï¼Œå¹¶å¯ä»¥å®ç°æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚æ¯ä¸ªVMæ˜¯ä¸€å°å®Œæ•´çš„è®¡ç®—æœºï¼Œåœ¨è™šæ‹ŸåŒ–ç¡¬ä»¶ä¹‹ä¸Šè¿è¡Œæ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬å…¶è‡ªå·±çš„æ“ä½œç³»ç»Ÿã€‚</li><li><strong>å®¹å™¨éƒ¨ç½²æ—¶ä»£</strong>ï¼šå®¹å™¨ç±»ä¼¼äºVMï¼Œä½†æ˜¯å®ƒä»¬å…·æœ‰è½»é‡çº§çš„éš”ç¦»å±æ€§ï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ“ä½œç³»ç»Ÿ<br>ï¼ˆOSï¼‰ï¼Œå› æ­¤ï¼Œå®¹å™¨è¢«è®¤ä¸ºæ˜¯è½»é‡çº§çš„ã€‚å®¹å™¨ä¸VMç±»ä¼¼ï¼Œå…·æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰ã€‚ç”±äºå®ƒä»¬ä¸åŸºç¡€æ¶æ„åˆ†ç¦»ï¼Œå› æ­¤å¯ä»¥è·¨äº‘å’ŒOSåˆ†å‘è¿›è¡Œç§»æ¤ã€‚</li></ul><p>å®¹å™¨å› å…·æœ‰è®¸å¤šä¼˜åŠ¿è€Œå˜å¾—æµè¡Œèµ·æ¥ã€‚ä¸‹é¢åˆ—å‡ºäº†å®¹å™¨çš„ä¸€äº›å¥½å¤„ï¼š</p><ul><li>æ•æ·åº”ç”¨ç¨‹åºçš„åˆ›å»ºå’Œéƒ¨ç½²ï¼šä¸ä½¿ç”¨VMé•œåƒç›¸æ¯”ï¼Œæé«˜äº†å®¹å™¨é•œåƒåˆ›å»ºçš„ç®€ä¾¿æ€§å’Œæ•ˆç‡ã€‚</li><li>æŒç»­å¼€å‘ã€é›†æˆå’Œéƒ¨ç½²ï¼šé€šè¿‡ç®€å•çš„å›æ»šï¼ˆç”±äºé•œåƒä¸å¯å˜æ€§ï¼‰ï¼Œæä¾›å¯é ä¸”é¢‘ç¹çš„å®¹å™¨é•œåƒæ„å»ºå’Œéƒ¨ç½²ã€‚</li><li>å…³æ³¨å¼€å‘ä¸è¿ç»´çš„åˆ†ç¦»ï¼šåœ¨æ„å»º/æ—¶è€Œä¸æ˜¯åœ¨éƒ¨ç½²æ—¶åˆ›å»ºåº”ç”¨ç¨‹åºå®¹å™¨é•œåƒï¼Œå°†åº”ç”¨ç¨‹åºä¸åŸºç¡€æ¶æ„åˆ†ç¦»ã€‚</li><li>å¯è§‚å¯Ÿæ€§ï¼šä¸ä»…å¯ä»¥æ˜¾ç¤ºæ“ä½œç³»ç»Ÿçº§åˆ«çš„ä¿¡æ¯å’ŒæŒ‡æ ‡ï¼Œè¿˜å¯ä»¥æ˜¾ç¤ºåº”ç”¨ç¨‹åºçš„è¿è¡ŒçŠ¶å†µå’Œå…¶ä»–æŒ‡æ ‡ä¿¡å·ã€‚</li><li>è·¨å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§çš„ç¯å¢ƒä¸€è‡´æ€§ï¼šåœ¨ä¾¿æºå¼è®¡ç®—æœºä¸Šä¸åœ¨äº‘ä¸­ç›¸åŒåœ°è¿è¡Œã€‚</li><li>äº‘å’Œæ“ä½œç³»ç»Ÿåˆ†å‘çš„å¯ç§»æ¤æ€§ï¼šå¯åœ¨Ubuntuã€RHELã€RHELã€CoreOSã€æœ¬åœ°ã€Google Kubernetes Engineå’Œå…¶å®ƒä»»ä½•å…¶å®ƒåœ°æ–¹è¿è¡Œã€‚</li><li>ä»¥åº”ç”¨ç¨‹åºä¸ºä¸­å¿ƒçš„ç®¡ç†ï¼šæé«˜æŠ½è±¡çº§åˆ«ï¼Œä»åœ¨è™šæ‹Ÿç¡¬ä»¶ä¸Šè¿è¡ŒOSåˆ°ä½¿ç”¨é€»è¾‘èµ„æºåœ¨OSä¸Šè¿è¡Œåº”ç”¨ç¨‹åºã€‚</li><li>æ¾æ•£è€¦åˆã€åˆ†å¸ƒå¼ã€å¼¹æ€§ã€è§£æ”¾çš„å¾®æœåŠ¡ï¼šåº”ç”¨ç¨‹åºè¢«åˆ†è§£æˆè¾ƒå°çš„ç‹¬ç«‹éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€éƒ¨ç½²å’Œç®¡ç†-è€Œä¸æ˜¯åœ¨ä¸€å°å¤§å‹å•æœºä¸Šå™¨ä½“è¿è¡Œã€‚</li><li>èµ„æºéš”ç¦»ï¼šå¯é¢„æµ‹çš„åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚</li></ul><h3 id="5-2-K8sæ¦‚è¿°"><a href="#5-2-K8sæ¦‚è¿°" class="headerlink" title="5.2 K8sæ¦‚è¿°"></a>5.2 K8sæ¦‚è¿°</h3><p>kubernetesï¼Œç®€ç§°K8sï¼Œæ˜¯ç”¨8 ä»£æ›¿8 ä¸ªå­—ç¬¦â€œuberneteâ€è€Œæˆçš„ç¼©å†™ã€‚æ˜¯ä¸€ä¸ªå¼€æºçš„ï¼Œç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetes çš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetes æä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§æœºåˆ¶ã€‚</p><p>ä¼ ç»Ÿçš„åº”ç”¨éƒ¨ç½²æ–¹å¼æ˜¯é€šè¿‡æ’ä»¶æˆ–è„šæœ¬æ¥å®‰è£…åº”ç”¨ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯åº”ç”¨çš„è¿è¡Œã€é…ç½®ã€ç®¡ç†ã€æ‰€æœ‰ç”Ÿå­˜å‘¨æœŸå°†ä¸å½“å‰æ“ä½œç³»ç»Ÿç»‘å®šï¼Œè¿™æ ·åšå¹¶ä¸åˆ©äºåº”ç”¨çš„å‡çº§æ›´æ–°/å›æ»šç­‰æ“ä½œï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºè™šæ‹Ÿæœºçš„æ–¹å¼æ¥å®ç°æŸäº›åŠŸèƒ½ï¼Œä½†æ˜¯è™šæ‹Ÿæœºéå¸¸é‡ï¼Œå¹¶ä¸åˆ©äºå¯ç§»æ¤æ€§ã€‚</p><p>æ–°çš„æ–¹å¼æ˜¯é€šè¿‡éƒ¨ç½²å®¹å™¨æ–¹å¼å®ç°ï¼Œæ¯ä¸ªå®¹å™¨ä¹‹é—´äº’ç›¸éš”ç¦»ï¼Œæ¯ä¸ªå®¹å™¨æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®¹å™¨ä¹‹é—´è¿›ç¨‹ä¸ä¼šç›¸äº’å½±å“ï¼Œèƒ½åŒºåˆ†è®¡ç®—èµ„æºã€‚ç›¸å¯¹äºè™šæ‹Ÿæœºï¼Œå®¹å™¨èƒ½å¿«é€Ÿéƒ¨ç½²ï¼Œç”±äºå®¹å™¨ä¸åº•å±‚è®¾æ–½ã€æœºå™¨æ–‡ä»¶ç³»ç»Ÿè§£è€¦çš„ã€‚</p><blockquote><p>æ€»ç»“ï¼š</p><ul><li>K8sæ˜¯è°·æ­Œåœ¨2014å¹´å‘å¸ƒçš„å®¹å™¨åŒ–é›†ç¾¤ç®¡ç†ç³»ç»Ÿ</li><li>ä½¿ç”¨k8sè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨éƒ¨ç½²</li><li>ä½¿ç”¨k8såˆ©äºåº”ç”¨æ‰©å±•</li><li>k8sç›®æ ‡å®æ–½è®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨æ›´åŠ ç®€æ´å’Œé«˜æ•ˆ</li></ul></blockquote><h3 id="5-3-K8sæ¦‚è¿°"><a href="#5-3-K8sæ¦‚è¿°" class="headerlink" title="5.3 K8sæ¦‚è¿°"></a>5.3 K8sæ¦‚è¿°</h3><p>Kubernetes æ˜¯ä¸€ä¸ªè½»ä¾¿çš„å’Œå¯æ‰©å±•çš„å¼€æºå¹³å°ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–åº”ç”¨å’ŒæœåŠ¡ã€‚é€šè¿‡Kubernetes èƒ½å¤Ÿè¿›è¡Œåº”ç”¨çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œæ‰©ç¼©å®¹ã€‚åœ¨Kubernetes ä¸­ï¼Œä¼šå°†ç»„æˆåº”ç”¨çš„å®¹å™¨ç»„åˆæˆä¸€ä¸ªé€»è¾‘å•å…ƒä»¥æ›´æ˜“ç®¡ç†å’Œå‘ç°ã€‚</p><p>Kubernetes ç§¯ç´¯äº†ä½œä¸ºGoogle ç”Ÿäº§ç¯å¢ƒè¿è¡Œå·¥ä½œè´Ÿè½½15 å¹´çš„ç»éªŒï¼Œå¹¶å¸æ”¶äº†æ¥è‡ªäºç¤¾åŒºçš„æœ€ä½³æƒ³æ³•å’Œå®è·µã€‚</p><h3 id="5-4-K8såŠŸèƒ½"><a href="#5-4-K8såŠŸèƒ½" class="headerlink" title="5.4 K8såŠŸèƒ½"></a>5.4 K8såŠŸèƒ½</h3><h4 id="1-è‡ªåŠ¨è£…ç®±"><a href="#1-è‡ªåŠ¨è£…ç®±" class="headerlink" title="1 è‡ªåŠ¨è£…ç®±"></a>1 è‡ªåŠ¨è£…ç®±</h4><p>åŸºäºå®¹å™¨å¯¹åº”ç”¨è¿è¡Œç¯å¢ƒçš„èµ„æºé…ç½®è¦æ±‚è‡ªåŠ¨éƒ¨ç½²åº”ç”¨å®¹å™¨</p><h4 id="2-è‡ªæˆ‘ä¿®å¤-è‡ªæ„ˆèƒ½åŠ›"><a href="#2-è‡ªæˆ‘ä¿®å¤-è‡ªæ„ˆèƒ½åŠ›" class="headerlink" title="2 è‡ªæˆ‘ä¿®å¤(è‡ªæ„ˆèƒ½åŠ›)"></a>2 è‡ªæˆ‘ä¿®å¤(è‡ªæ„ˆèƒ½åŠ›)</h4><p>å½“å®¹å™¨å¤±è´¥æ—¶ï¼Œä¼šå¯¹å®¹å™¨è¿›è¡Œé‡å¯</p><p>å½“æ‰€éƒ¨ç½²çš„NodeèŠ‚ç‚¹æœ‰é—®é¢˜æ—¶ï¼Œä¼šå¯¹å®¹å™¨è¿›è¡Œé‡æ–°éƒ¨ç½²å’Œé‡æ–°è°ƒåº¦</p><p>å½“å®¹å™¨æœªé€šè¿‡ç›‘æ§æ£€æŸ¥æ—¶ï¼Œä¼šå…³é—­æ­¤å®¹å™¨ç›´åˆ°å®¹å™¨æ­£å¸¸è¿è¡Œæ—¶ï¼Œæ‰ä¼šå¯¹å¤–æä¾›æœåŠ¡</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20200928101336750.png" alt="image-20200928101336750"></p><p>å¦‚æœæŸä¸ªæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ä¸å“åº”äº†ï¼ŒKubernetesä¼šè‡ªåŠ¨åœ¨å…¶å®ƒçš„åœ°æ–¹åˆ›å»ºä¸€ä¸ª</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122112241092.png" alt="image-20201122112241092"></p><h4 id="3-æ°´å¹³æ‰©å±•"><a href="#3-æ°´å¹³æ‰©å±•" class="headerlink" title="3 æ°´å¹³æ‰©å±•"></a>3 æ°´å¹³æ‰©å±•</h4><p>é€šè¿‡ç®€å•çš„å‘½ä»¤ã€ç”¨æˆ·UI ç•Œé¢æˆ–åŸºäºCPU ç­‰èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¯¹åº”ç”¨å®¹å™¨è¿›è¡Œè§„æ¨¡æ‰©å¤§æˆ–è§„æ¨¡å‰ªè£</p><blockquote><p>å½“æˆ‘ä»¬æœ‰å¤§é‡çš„è¯·æ±‚æ¥ä¸´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¢åŠ å‰¯æœ¬æ•°é‡ï¼Œä»è€Œè¾¾åˆ°æ°´å¹³æ‰©å±•çš„æ•ˆæœ</p></blockquote><p>å½“é»„è‰²åº”ç”¨è¿‡åº¦å¿™ç¢Œï¼Œä¼šæ¥æ‰©å±•ä¸€ä¸ªåº”ç”¨</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122112301750.png" alt="image-20201122112301750"></p><h4 id="4-æœåŠ¡å‘ç°"><a href="#4-æœåŠ¡å‘ç°" class="headerlink" title="4 æœåŠ¡å‘ç°"></a>4 æœåŠ¡å‘ç°</h4><p>ç”¨æˆ·ä¸éœ€ä½¿ç”¨é¢å¤–çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå°±èƒ½å¤ŸåŸºäºKubernetes è‡ªèº«èƒ½åŠ›å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</p><blockquote><p>å¯¹å¤–æä¾›ç»Ÿä¸€çš„å…¥å£ï¼Œè®©å®ƒæ¥åšèŠ‚ç‚¹çš„è°ƒåº¦å’Œè´Ÿè½½å‡è¡¡ï¼Œ ç›¸å½“äºå¾®æœåŠ¡é‡Œé¢çš„ç½‘å…³ï¼Ÿ</p></blockquote><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20200928101711968.png" alt="image-20200928101711968"></p><h4 id="5-æ»šåŠ¨æ›´æ–°"><a href="#5-æ»šåŠ¨æ›´æ–°" class="headerlink" title="5 æ»šåŠ¨æ›´æ–°"></a>5 æ»šåŠ¨æ›´æ–°</h4><p>å¯ä»¥æ ¹æ®åº”ç”¨çš„å˜åŒ–ï¼Œå¯¹åº”ç”¨å®¹å™¨è¿è¡Œçš„åº”ç”¨ï¼Œè¿›è¡Œä¸€æ¬¡æ€§æˆ–æ‰¹é‡å¼æ›´æ–°</p><blockquote><p>æ·»åŠ åº”ç”¨çš„æ—¶å€™ï¼Œä¸æ˜¯åŠ è¿›å»å°±é©¬ä¸Šå¯ä»¥è¿›è¡Œä½¿ç”¨ï¼Œè€Œæ˜¯éœ€è¦åˆ¤æ–­è¿™ä¸ªæ·»åŠ è¿›å»çš„åº”ç”¨æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨</p></blockquote><h4 id="6-ç‰ˆæœ¬å›é€€"><a href="#6-ç‰ˆæœ¬å›é€€" class="headerlink" title="6 ç‰ˆæœ¬å›é€€"></a>6 ç‰ˆæœ¬å›é€€</h4><p>å¯ä»¥æ ¹æ®åº”ç”¨éƒ¨ç½²æƒ…å†µï¼Œå¯¹åº”ç”¨å®¹å™¨è¿è¡Œçš„åº”ç”¨ï¼Œè¿›è¡Œå†å²ç‰ˆæœ¬å³æ—¶å›é€€</p><blockquote><p>ç±»ä¼¼äºGitä¸­çš„å›æ»š</p></blockquote><h4 id="7-å¯†é’¥å’Œé…ç½®ç®¡ç†"><a href="#7-å¯†é’¥å’Œé…ç½®ç®¡ç†" class="headerlink" title="7 å¯†é’¥å’Œé…ç½®ç®¡ç†"></a>7 å¯†é’¥å’Œé…ç½®ç®¡ç†</h4><p>åœ¨ä¸éœ€è¦é‡æ–°æ„å»ºé•œåƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥éƒ¨ç½²å’Œæ›´æ–°å¯†é’¥å’Œåº”ç”¨é…ç½®ï¼Œç±»ä¼¼çƒ­éƒ¨ç½²ã€‚</p><h4 id="8-å­˜å‚¨ç¼–æ’"><a href="#8-å­˜å‚¨ç¼–æ’" class="headerlink" title="8 å­˜å‚¨ç¼–æ’"></a>8 å­˜å‚¨ç¼–æ’</h4><p>è‡ªåŠ¨å®ç°å­˜å‚¨ç³»ç»ŸæŒ‚è½½åŠåº”ç”¨ï¼Œç‰¹åˆ«å¯¹æœ‰çŠ¶æ€åº”ç”¨å®ç°æ•°æ®æŒä¹…åŒ–éå¸¸é‡è¦</p><p>å­˜å‚¨ç³»ç»Ÿå¯ä»¥æ¥è‡ªäºæœ¬åœ°ç›®å½•ã€ç½‘ç»œå­˜å‚¨(NFSã€Glusterã€Ceph ç­‰)ã€å…¬å…±äº‘å­˜å‚¨æœåŠ¡</p><h4 id="9-æ‰¹å¤„ç†"><a href="#9-æ‰¹å¤„ç†" class="headerlink" title="9 æ‰¹å¤„ç†"></a>9 æ‰¹å¤„ç†</h4><p>æä¾›ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ï¼›æ»¡è¶³æ‰¹é‡æ•°æ®å¤„ç†å’Œåˆ†æçš„åœºæ™¯</p><h2 id="6-K8sæ¶æ„ç»„ä»¶"><a href="#6-K8sæ¶æ„ç»„ä»¶" class="headerlink" title="6 K8sæ¶æ„ç»„ä»¶"></a>6 K8sæ¶æ„ç»„ä»¶</h2><h3 id="6-1-å®Œæ•´æ¶æ„å›¾"><a href="#6-1-å®Œæ•´æ¶æ„å›¾" class="headerlink" title="6.1 å®Œæ•´æ¶æ„å›¾"></a>6.1 å®Œæ•´æ¶æ„å›¾</h3><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20200928103059652.png" alt="image-20200928103059652"></p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20200928110124821.png" alt="image-20200928110124821"></p><h3 id="6-2-æ¶æ„ç»†èŠ‚"><a href="#6-2-æ¶æ„ç»†èŠ‚" class="headerlink" title="6.2 æ¶æ„ç»†èŠ‚"></a>6.2 æ¶æ„ç»†èŠ‚</h3><p>K8sæ¶æ„ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†ï¼šMasterï¼ˆä¸»æ§èŠ‚ç‚¹ï¼‰å’Œ nodeï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰</p><p>masterèŠ‚ç‚¹æ¶æ„å›¾</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122113057343.png" alt="image-20201122113057343"></p><p>NodeèŠ‚ç‚¹æ¶æ„å›¾</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122155629990.png" alt="image-20201122155629990"></p><p>k8s é›†ç¾¤æ§åˆ¶èŠ‚ç‚¹ï¼Œå¯¹é›†ç¾¤è¿›è¡Œè°ƒåº¦ç®¡ç†ï¼Œæ¥å—é›†ç¾¤å¤–ç”¨æˆ·å»é›†ç¾¤æ“ä½œè¯·æ±‚ï¼›</p><ul><li><p><strong>master</strong>ï¼šä¸»æ§èŠ‚ç‚¹</p><ul><li>API Serverï¼šé›†ç¾¤ç»Ÿä¸€å…¥å£ï¼Œä»¥restfulé£æ ¼è¿›è¡Œæ“ä½œï¼ŒåŒæ—¶äº¤ç»™etcdå­˜å‚¨<ul><li>æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶</li></ul></li><li>schedulerï¼šèŠ‚ç‚¹çš„è°ƒåº¦ï¼Œé€‰æ‹©nodeèŠ‚ç‚¹åº”ç”¨éƒ¨ç½²</li><li>controller-managerï¼šå¤„ç†é›†ç¾¤ä¸­å¸¸è§„åå°ä»»åŠ¡ï¼Œä¸€ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ§åˆ¶å™¨</li><li>etcdï¼šå­˜å‚¨ç³»ç»Ÿï¼Œç”¨äºä¿å­˜é›†ç¾¤ä¸­çš„ç›¸å…³æ•°æ®</li></ul></li><li><p><strong>Work node</strong>ï¼šå·¥ä½œèŠ‚ç‚¹</p><ul><li>Kubeletï¼šmasteræ´¾åˆ°nodeèŠ‚ç‚¹ä»£è¡¨ï¼Œç®¡ç†æœ¬æœºå®¹å™¨<ul><li>ä¸€ä¸ªé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»£ç†ï¼Œå®ƒä¿è¯å®¹å™¨éƒ½è¿è¡Œåœ¨Podä¸­</li><li>è´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volume(CSI) å’Œ ç½‘ç»œ(CNI)çš„ç®¡ç†</li></ul></li><li>kube-proxyï¼šæä¾›ç½‘ç»œä»£ç†ï¼Œè´Ÿè½½å‡è¡¡ç­‰æ“ä½œ</li></ul></li><li><p>å®¹å™¨è¿è¡Œç¯å¢ƒã€<strong>Container Runtime</strong>ã€‘</p><ul><li>å®¹å™¨è¿è¡Œç¯å¢ƒæ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶</li><li>Kubernetesæ”¯æŒå¤šä¸ªå®¹å™¨è¿è¡Œç¯å¢ƒï¼šDockerã€containerdã€cri-oã€rktletä»¥åŠä»»ä½•å®ç°Kubernetes CRI (å®¹å™¨è¿è¡Œç¯å¢ƒæ¥å£) çš„è½¯ä»¶ã€‚</li></ul></li><li><p>fluentdï¼šæ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒæœ‰åŠ©äºæå‡ é›†ç¾¤å±‚é¢æ—¥å¿—</p></li></ul><h2 id="7-K8sæ ¸å¿ƒæ¦‚å¿µ"><a href="#7-K8sæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="7 K8sæ ¸å¿ƒæ¦‚å¿µ"></a>7 K8sæ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="7-1-Pod"><a href="#7-1-Pod" class="headerlink" title="7.1 Pod"></a>7.1 Pod</h3><ul><li>Podæ˜¯K8sä¸­æœ€å°çš„å•å…ƒ</li><li>ä¸€ç»„å®¹å™¨çš„é›†åˆ</li><li>å…±äº«ç½‘ç»œã€ä¸€ä¸ªPodä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«åŒä¸€ç½‘ç»œã€‘</li><li>ç”Ÿå‘½å‘¨æœŸæ˜¯çŸ­æš‚çš„ï¼ˆæœåŠ¡å™¨é‡å¯åï¼Œå°±æ‰¾ä¸åˆ°äº†ï¼‰</li></ul><h3 id="7-2-Volume"><a href="#7-2-Volume" class="headerlink" title="7.2 Volume"></a>7.2 Volume</h3><ul><li>å£°æ˜åœ¨Podå®¹å™¨ä¸­å¯è®¿é—®çš„æ–‡ä»¶ç›®å½•</li><li>å¯ä»¥è¢«æŒ‚è½½åˆ°Podä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨æŒ‡å®šè·¯å¾„ä¸‹</li><li>æ”¯æŒå¤šç§åç«¯å­˜å‚¨æŠ½è±¡ã€æœ¬åœ°å­˜å‚¨ã€åˆ†å¸ƒå¼å­˜å‚¨ã€äº‘å­˜å‚¨ã€‘</li></ul><h3 id="7-3-Controller"><a href="#7-3-Controller" class="headerlink" title="7.3 Controller"></a>7.3 Controller</h3><ul><li>ç¡®ä¿é¢„æœŸçš„podå‰¯æœ¬æ•°é‡ã€ReplicaSetã€‘</li><li>æ— çŠ¶æ€åº”ç”¨éƒ¨ç½²ã€Depoltmentã€‘<ul><li>æ— çŠ¶æ€å°±æ˜¯æŒ‡ï¼Œä¸éœ€è¦ä¾èµ–äºç½‘ç»œæˆ–è€…ip</li></ul></li><li>æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²ã€StatefulSetã€‘<ul><li>æœ‰çŠ¶æ€éœ€è¦ç‰¹å®šçš„æ¡ä»¶</li></ul></li><li>ç¡®ä¿æ‰€æœ‰çš„nodeè¿è¡ŒåŒä¸€ä¸ªpod ã€DaemonSetã€‘</li><li>ä¸€æ¬¡æ€§ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ã€Jobå’ŒCronJobã€‘</li></ul><h3 id="7-4-Deployment"><a href="#7-4-Deployment" class="headerlink" title="7.4 Deployment"></a>7.4 Deployment</h3><ul><li>å®šä¹‰ä¸€ç»„Podå‰¯æœ¬æ•°ç›®ï¼Œç‰ˆæœ¬ç­‰</li><li>é€šè¿‡æ§åˆ¶å™¨ã€Controllerã€‘ç»´æŒPodæ•°ç›®ã€è‡ªåŠ¨å›å¤å¤±è´¥çš„Podã€‘</li><li>é€šè¿‡æ§åˆ¶å™¨ä»¥æŒ‡å®šçš„ç­–ç•¥æ§åˆ¶ç‰ˆæœ¬ã€æ»šåŠ¨å‡çº§ã€å›æ»šç­‰ã€‘</li></ul><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122161601349.png" alt="image-20201122161601349"></p><h3 id="7-5-Service"><a href="#7-5-Service" class="headerlink" title="7.5 Service"></a>7.5 Service</h3><ul><li>å®šä¹‰ä¸€ç»„podçš„è®¿é—®è§„åˆ™</li><li>Podçš„è´Ÿè½½å‡è¡¡ï¼Œæä¾›ä¸€ä¸ªæˆ–å¤šä¸ªPodçš„ç¨³å®šè®¿é—®åœ°å€</li><li>æ”¯æŒå¤šç§æ–¹å¼ã€ClusterIPã€NodePortã€LoadBalancerã€‘</li></ul><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122161132055.png" alt="image-20201122161132055"></p><p>å¯ä»¥ç”¨æ¥ç»„åˆpodï¼ŒåŒæ—¶å¯¹å¤–æä¾›æœåŠ¡</p><h3 id="7-6-Label"><a href="#7-6-Label" class="headerlink" title="7.6 Label"></a>7.6 Label</h3><p>labelï¼šæ ‡ç­¾ï¼Œç”¨äºå¯¹è±¡èµ„æºæŸ¥è¯¢ï¼Œç­›é€‰</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122161713638.png" alt="image-20201122161713638"></p><h3 id="7-7-Namespace"><a href="#7-7-Namespace" class="headerlink" title="7.7 Namespace"></a>7.7 Namespace</h3><p>å‘½åç©ºé—´ï¼Œé€»è¾‘éš”ç¦»</p><ul><li>ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„é€»è¾‘éš”ç¦»æœºåˆ¶ã€é‰´æƒã€èµ„æºã€‘</li><li>æ¯ä¸ªèµ„æºéƒ½å±äºä¸€ä¸ªnamespace</li><li>åŒä¸€ä¸ªnamespaceæ‰€æœ‰èµ„æºä¸èƒ½é‡å¤</li><li>ä¸åŒnamespaceå¯ä»¥èµ„æºåé‡å¤</li></ul><h3 id="7-8-API"><a href="#7-8-API" class="headerlink" title="7.8 API"></a>7.8 API</h3><p>æˆ‘ä»¬é€šè¿‡Kubernetesçš„APIæ¥æ“ä½œæ•´ä¸ªé›†ç¾¤</p><p>åŒæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl ã€uiã€curl æœ€ç»ˆå‘é€ http + json/yaml æ–¹å¼çš„è¯·æ±‚ç»™API Serverï¼Œç„¶åæ§åˆ¶æ•´ä¸ªK8sé›†ç¾¤ï¼ŒK8sä¸­æ‰€æœ‰çš„èµ„æºå¯¹è±¡éƒ½å¯ä»¥é‡‡ç”¨ yaml æˆ– json æ ¼å¼çš„æ–‡ä»¶å®šä¹‰æˆ–æè¿°</p><p>å¦‚ä¸‹ï¼šä½¿ç”¨yamléƒ¨ç½²ä¸€ä¸ªnginxçš„pod</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122162612448.png" alt="image-20201122162612448"></p><h2 id="8-å®Œæ•´æµç¨‹"><a href="#8-å®Œæ•´æµç¨‹" class="headerlink" title="8 å®Œæ•´æµç¨‹"></a>8 å®Œæ•´æµç¨‹</h2><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/1_Kubernetes%E7%AE%80%E4%BB%8B/images/image-20201122163512535.png" alt="image-20201122163512535"></p><ul><li>é€šè¿‡Kubectlæäº¤ä¸€ä¸ªåˆ›å»ºRCï¼ˆReplication Controllerï¼‰çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚é€šè¿‡APlserverå†™å…¥etcd</li><li>æ­¤æ—¶Controller Manageré€šè¿‡API Serverçš„ç›‘å¬èµ„æºå˜åŒ–çš„æ¥å£ç›‘å¬åˆ°æ­¤RCäº‹ä»¶</li><li>åˆ†æä¹‹åï¼Œå‘ç°å½“å‰é›†ç¾¤ä¸­è¿˜æ²¡æœ‰å®ƒæ‰€å¯¹åº”çš„Podå®ä¾‹</li><li>äºæ˜¯æ ¹æ®RCé‡Œçš„Podæ¨¡æ¿å®šä¹‰ä¸€ä¸ªç”ŸæˆPodå¯¹è±¡ï¼Œé€šè¿‡APIServerå†™å…¥etcd</li><li>æ­¤äº‹ä»¶è¢«Schedulerå‘ç°ï¼Œå®ƒç«‹å³æ‰§è¡Œæ‰§è¡Œä¸€ä¸ªå¤æ‚çš„è°ƒåº¦æµç¨‹ï¼Œä¸ºè¿™ä¸ªæ–°çš„Podé€‰å®šä¸€ä¸ªè½æˆ·çš„Nodeï¼Œç„¶åé€šè¿‡API Serverè®²è¿™ä¸€ç»“æœå†™å…¥etcdä¸­</li><li>ç›®æ ‡Nodeä¸Šè¿è¡Œçš„Kubeletè¿›ç¨‹é€šè¿‡APiserverç›‘æµ‹åˆ°è¿™ä¸ªâ€æ–°ç”Ÿçš„Podï¼Œå¹¶æŒ‰ç…§å®ƒçš„å®šä¹‰ï¼Œå¯åŠ¨è¯¥Podå¹¶ä»»åŠ³ä»»æ€¨åœ°è´Ÿè´£å®ƒçš„ä¸‹åŠç”Ÿï¼Œç›´åˆ°Podçš„ç”Ÿå‘½ç»“æŸ</li><li>éšåï¼Œæˆ‘ä»¬é€šè¿‡Kubectlæäº¤ä¸€ä¸ªæ–°çš„æ˜ å°„åˆ°è¯¥Podçš„Serviceçš„åˆ›å»ºè¯·æ±‚</li><li>ControllerManageré€šè¿‡Labelæ ‡ç­¾æŸ¥è¯¢åˆ°å…³è”çš„Podå®ä¾‹ï¼Œç„¶åç”ŸæˆServiceçš„Endpointsä¿¡æ¯ï¼Œå¹¶é€šè¿‡APIServerå†™å…¥åˆ°etodä¸­ï¼Œ</li><li>æ¥ä¸‹æ¥ï¼Œæ‰€æœ‰Nodeä¸Šè¿è¡Œçš„Proxyè¿›ç¨‹é€šè¿‡APIServeræŸ¥è¯¢å¹¶ç›‘å¬Serviceå¯¹è±¡ä¸å…¶å¯¹åº”çš„Endpontsä¿¡æ¯ï¼Œå»ºç«‹ä¸€ä¸ªè½¯ä»¶æ–¹å¼çš„è´Ÿè½½å‡è¡¡å™¨æ¥å®ç°Serviceè®¿é—®åˆ°åç«¯Podçš„æµé‡è½¬å‘åŠŸèƒ½</li></ul><h1 id="ç¬¬2ç« -æ­å»ºK8Sé›†ç¾¤"><a href="#ç¬¬2ç« -æ­å»ºK8Sé›†ç¾¤" class="headerlink" title="ç¬¬2ç«  æ­å»ºK8Sé›†ç¾¤"></a>ç¬¬2ç«  æ­å»ºK8Sé›†ç¾¤</h1><h2 id="1-æ­å»ºk8sç¯å¢ƒå¹³å°è§„åˆ’"><a href="#1-æ­å»ºk8sç¯å¢ƒå¹³å°è§„åˆ’" class="headerlink" title="1 æ­å»ºk8sç¯å¢ƒå¹³å°è§„åˆ’"></a>1 æ­å»ºk8sç¯å¢ƒå¹³å°è§„åˆ’</h2><h3 id="å•masteré›†ç¾¤"><a href="#å•masteré›†ç¾¤" class="headerlink" title="å•masteré›†ç¾¤"></a>å•masteré›†ç¾¤</h3><p>å•ä¸ªmasterèŠ‚ç‚¹ï¼Œç„¶åç®¡ç†å¤šä¸ªnodeèŠ‚ç‚¹</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/2_%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/images/image-20200928110456495.png" alt="image-20200928110456495"></p><h3 id="å¤šmasteré›†ç¾¤"><a href="#å¤šmasteré›†ç¾¤" class="headerlink" title="å¤šmasteré›†ç¾¤"></a>å¤šmasteré›†ç¾¤</h3><p>å¤šä¸ªmasterèŠ‚ç‚¹ï¼Œç®¡ç†å¤šä¸ªnodeèŠ‚ç‚¹ï¼ŒåŒæ—¶ä¸­é—´å¤šäº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„è¿‡ç¨‹</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/2_%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/images/image-20200928110543829.png" alt="image-20200928110543829"></p><h2 id="2-æœåŠ¡å™¨ç¡¬ä»¶é…ç½®è¦æ±‚"><a href="#2-æœåŠ¡å™¨ç¡¬ä»¶é…ç½®è¦æ±‚" class="headerlink" title="2 æœåŠ¡å™¨ç¡¬ä»¶é…ç½®è¦æ±‚"></a>2 æœåŠ¡å™¨ç¡¬ä»¶é…ç½®è¦æ±‚</h2><h3 id="2-1-æµ‹è¯•ç¯å¢ƒ"><a href="#2-1-æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="2.1 æµ‹è¯•ç¯å¢ƒ"></a>2.1 æµ‹è¯•ç¯å¢ƒ</h3><p>masterï¼š2æ ¸  4G  20G</p><p>nodeï¼š   4æ ¸  8G  40G</p><h3 id="2-2-ç”Ÿäº§ç¯å¢ƒ"><a href="#2-2-ç”Ÿäº§ç¯å¢ƒ" class="headerlink" title="2.2 ç”Ÿäº§ç¯å¢ƒ"></a>2.2 ç”Ÿäº§ç¯å¢ƒ</h3><p>masterï¼š8æ ¸  16G  100G</p><p>nodeï¼š   16æ ¸  64G  200G</p><p>ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetesé›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼</p><h3 id="2-3-kubeadm"><a href="#2-3-kubeadm" class="headerlink" title="2.3 kubeadm"></a>2.3 kubeadm</h3><p>kubeadmæ˜¯ä¸€ä¸ªK8Séƒ¨ç½²å·¥å…·ï¼Œæä¾›kubeadm init å’Œ kubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetesé›†ç¾¤</p><p>å®˜ç½‘åœ°å€ï¼š<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">ç‚¹æˆ‘ä¼ é€</a></p><h3 id="2-4-äºŒè¿›åˆ¶åŒ…"><a href="#2-4-äºŒè¿›åˆ¶åŒ…" class="headerlink" title="2.4 äºŒè¿›åˆ¶åŒ…"></a>2.4 äºŒè¿›åˆ¶åŒ…</h3><p>ä»githubä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆKubernetesé›†ç¾¤ã€‚</p><p>Kubeadmé™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚å¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½²Kubernetesé›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚</p><h2 id="3-Kubeadméƒ¨ç½²é›†ç¾¤"><a href="#3-Kubeadméƒ¨ç½²é›†ç¾¤" class="headerlink" title="3 Kubeadméƒ¨ç½²é›†ç¾¤"></a>3 Kubeadméƒ¨ç½²é›†ç¾¤</h2><p>kubeadm æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetes é›†ç¾¤çš„éƒ¨ç½²ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªMaster èŠ‚ç‚¹kubeadm init</li><li>å°†Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­$ kubeadm join &lt;Master èŠ‚ç‚¹çš„IP å’Œç«¯å£&gt;</li></ul><h2 id="4-å®‰è£…è¦æ±‚"><a href="#4-å®‰è£…è¦æ±‚" class="headerlink" title="4 å®‰è£…è¦æ±‚"></a>4 å®‰è£…è¦æ±‚</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶</p><ul><li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿä¸ºCentos7.X</li><li>ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šGAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30G</li><li>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š</li><li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ</li><li>ç¦æ­¢swapåˆ†åŒº</li></ul><h1 id="ç¬¬3ç« -ä½¿ç”¨kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤"><a href="#ç¬¬3ç« -ä½¿ç”¨kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤" class="headerlink" title="ç¬¬3ç«  ä½¿ç”¨kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤"></a>ç¬¬3ç«  ä½¿ç”¨kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤</h1><p>kubeadmæ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤çš„å·¥å…·ã€‚</p><p>è¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetesé›†ç¾¤çš„éƒ¨ç½²ï¼š</p><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ›å»ºä¸€ä¸ª Master èŠ‚ç‚¹</span>kubeadm init<span class="hljs-meta">#</span><span class="bash"> å°†ä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­</span>kubeadm join &lt;MasterèŠ‚ç‚¹çš„IPå’Œç«¯å£ &gt;</code></pre></div><h2 id="1-Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤"><a href="#1-Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤" class="headerlink" title="1 Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤"></a>1 Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤</h2><p>ä½¿ç”¨kubeadmæ–¹å¼æ­å»ºK8sé›†ç¾¤ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥</p><ul><li>å‡†å¤‡ä¸‰å°è™šæ‹Ÿæœºï¼ŒåŒæ—¶å®‰è£…æ“ä½œç³»ç»ŸCentOS 7.x</li><li>å¯¹ä¸‰ä¸ªå®‰è£…ä¹‹åçš„æ“ä½œç³»ç»Ÿè¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li><li>åœ¨ä¸‰ä¸ªèŠ‚ç‚¹å®‰è£… docker kubelet kubeadm kubectl</li><li>åœ¨masterèŠ‚ç‚¹æ‰§è¡Œkubeadm initå‘½ä»¤åˆå§‹åŒ–</li><li>åœ¨nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œ kubeadm joinå‘½ä»¤ï¼ŒæŠŠnodeèŠ‚ç‚¹æ·»åŠ åˆ°å½“å‰é›†ç¾¤</li><li>é…ç½®CNIç½‘ç»œæ’ä»¶ï¼Œç”¨äºèŠ‚ç‚¹ä¹‹é—´çš„è¿é€šã€å¤±è´¥äº†å¯ä»¥å¤šè¯•å‡ æ¬¡ã€‘</li><li>é€šè¿‡æ‹‰å–ä¸€ä¸ªnginxè¿›è¡Œæµ‹è¯•ï¼Œèƒ½å¦è¿›è¡Œå¤–ç½‘æµ‹è¯•</li></ul><h2 id="2-å®‰è£…è¦æ±‚"><a href="#2-å®‰è£…è¦æ±‚" class="headerlink" title="2 å®‰è£…è¦æ±‚"></a>2 å®‰è£…è¦æ±‚</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿ CentOS7.x-86_x64</li><li>ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šRAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤šã€æ³¨æ„masteréœ€è¦ä¸¤æ ¸ã€‘</li><li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒï¼Œå¦‚æœæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œéœ€è¦æå‰ä¸‹è½½é•œåƒå¹¶å¯¼å…¥èŠ‚ç‚¹</li><li>ç¦æ­¢swapåˆ†åŒº</li></ul><h2 id="3-å‡†å¤‡ç¯å¢ƒ"><a href="#3-å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="3 å‡†å¤‡ç¯å¢ƒ"></a>3 å‡†å¤‡ç¯å¢ƒ</h2><table><thead><tr><th>è§’è‰²</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>192.168.177.130</td></tr><tr><td>node1</td><td>192.168.177.131</td></tr><tr><td>node2</td><td>192.168.177.132</td></tr></tbody></table><p>ç„¶åå¼€å§‹åœ¨æ¯å°æœºå™¨ä¸Šæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># å…³é—­é˜²ç«å¢™</span>systemctl stop firewalldsystemctl <span class="hljs-built_in">disable</span> firewalld<span class="hljs-comment"># å…³é—­selinux</span><span class="hljs-comment"># æ°¸ä¹…å…³é—­</span>sed -i <span class="hljs-string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  <span class="hljs-comment"># ä¸´æ—¶å…³é—­</span>setenforce 0  <span class="hljs-comment"># å…³é—­swap</span><span class="hljs-comment"># ä¸´æ—¶</span>swapoff -a <span class="hljs-comment"># æ°¸ä¹…å…³é—­</span>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab<span class="hljs-comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºåã€masterèŠ‚ç‚¹ä¸Šæ“ä½œã€‘</span>hostnamectl set-hostname k8smaster<span class="hljs-comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºåã€node1èŠ‚ç‚¹æ“ä½œã€‘</span>hostnamectl set-hostname k8snode1<span class="hljs-comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºåã€node2èŠ‚ç‚¹æ“ä½œã€‘</span>hostnamectl set-hostname k8snode2<span class="hljs-comment"># åœ¨masteræ·»åŠ hosts</span>cat &gt;&gt; /etc/hosts &lt;&lt; <span class="hljs-string">EOF</span><span class="hljs-string">192.168.177.130 k8smaster</span><span class="hljs-string">192.168.177.131 k8snode1</span><span class="hljs-string">192.168.177.132 k8snode2</span><span class="hljs-string">EOF</span><span class="hljs-comment"># å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</span>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="hljs-string">EOF</span><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><span class="hljs-string">EOF</span><span class="hljs-comment"># ç”Ÿæ•ˆ</span>sysctl --system  <span class="hljs-comment"># æ—¶é—´åŒæ­¥</span>yum install ntpdate -yntpdate time.windows.com</code></pre></div><h2 id="4-å®‰è£…Docker-kubeadm-kubelet"><a href="#4-å®‰è£…Docker-kubeadm-kubelet" class="headerlink" title="4 å®‰è£…Docker/kubeadm/kubelet"></a>4 å®‰è£…Docker/kubeadm/kubelet</h2><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet ï¼ŒKubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Docker</p><h3 id="4-1-å®‰è£…Docker"><a href="#4-1-å®‰è£…Docker" class="headerlink" title="4.1 å®‰è£…Docker"></a>4.1 å®‰è£…Docker</h3><p>é¦–å…ˆé…ç½®ä¸€ä¸‹Dockerçš„é˜¿é‡Œyumæº</p><div class="code-wrapper"><pre><code class="hljs bash">cat &gt;/etc/yum.repos.d/docker.repo&lt;&lt;<span class="hljs-string">EOF</span><span class="hljs-string">[docker-ce-edge]</span><span class="hljs-string">name=Docker CE Edge - \$basearch</span><span class="hljs-string">baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7/\$basearch/edge</span><span class="hljs-string">enabled=1</span><span class="hljs-string">gpgcheck=1</span><span class="hljs-string">gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg</span><span class="hljs-string">EOF</span></code></pre></div><p>ç„¶åyumæ–¹å¼å®‰è£…docker</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># yumå®‰è£…</span>yum -y install docker-ce<span class="hljs-comment"># æŸ¥çœ‹dockerç‰ˆæœ¬</span>docker --version  <span class="hljs-comment"># å¯åŠ¨docker</span>systemctl <span class="hljs-built_in">enable</span> dockersystemctl start docker</code></pre></div><p>é…ç½®dockerçš„é•œåƒæº</p><div class="code-wrapper"><pre><code class="hljs bash">cat &gt;&gt; /etc/docker/daemon.json &lt;&lt; <span class="hljs-string">EOF</span><span class="hljs-string">&#123;</span><span class="hljs-string">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><span class="hljs-string">&#125;</span><span class="hljs-string">EOF</span></code></pre></div><p>ç„¶åé‡å¯docker</p><div class="code-wrapper"><pre><code class="hljs bash">systemctl restart docker</code></pre></div><h3 id="4-2-æ·»åŠ kubernetesè½¯ä»¶æº"><a href="#4-2-æ·»åŠ kubernetesè½¯ä»¶æº" class="headerlink" title="4.2 æ·»åŠ kubernetesè½¯ä»¶æº"></a>4.2 æ·»åŠ kubernetesè½¯ä»¶æº</h3><p>ç„¶åæˆ‘ä»¬è¿˜éœ€è¦é…ç½®ä¸€ä¸‹yumçš„k8sè½¯ä»¶æº</p><div class="code-wrapper"><pre><code class="hljs bash">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="hljs-string">EOF</span><span class="hljs-string">[kubernetes]</span><span class="hljs-string">name=Kubernetes</span><span class="hljs-string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><span class="hljs-string">enabled=1</span><span class="hljs-string">gpgcheck=0</span><span class="hljs-string">repo_gpgcheck=0</span><span class="hljs-string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><span class="hljs-string">EOF</span></code></pre></div><h3 id="4-3-å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"><a href="#4-3-å®‰è£…kubeadmï¼Œkubeletå’Œkubectl" class="headerlink" title="4.3 å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"></a>4.3 å®‰è£…kubeadmï¼Œkubeletå’Œkubectl</h3><p>ç”±äºç‰ˆæœ¬æ›´æ–°é¢‘ç¹ï¼Œè¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²ï¼š</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…kubeletã€kubeadmã€kubectlï¼ŒåŒæ—¶æŒ‡å®šç‰ˆæœ¬</span>yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0<span class="hljs-comment"># è®¾ç½®å¼€æœºå¯åŠ¨</span>systemctl <span class="hljs-built_in">enable</span> kubelet</code></pre></div><h2 id="5-éƒ¨ç½²Kubernetes-Masterã€masterèŠ‚ç‚¹ã€‘"><a href="#5-éƒ¨ç½²Kubernetes-Masterã€masterèŠ‚ç‚¹ã€‘" class="headerlink" title="5 éƒ¨ç½²Kubernetes Masterã€masterèŠ‚ç‚¹ã€‘"></a>5 éƒ¨ç½²Kubernetes Masterã€masterèŠ‚ç‚¹ã€‘</h2><p>åœ¨   192.168.177.130  æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯masterèŠ‚ç‚¹</p><div class="code-wrapper"><pre><code class="hljs bash">kubeadm init --apiserver-advertise-address=192.168.177.130 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.18.0 --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16</code></pre></div><p>ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€ï¼Œã€æ‰§è¡Œä¸Šè¿°å‘½ä»¤ä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºåå°å…¶å®å·²ç»åœ¨æ‹‰å–é•œåƒäº†ã€‘ï¼Œæˆ‘ä»¬ docker images å‘½ä»¤å³å¯æŸ¥çœ‹å·²ç»æ‹‰å–çš„é•œåƒ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20200929094302491.png" alt="image-20200929094302491"></p><p>å½“æˆ‘ä»¬å‡ºç°ä¸‹é¢çš„æƒ…å†µæ—¶ï¼Œè¡¨ç¤ºkubernetesçš„é•œåƒå·²ç»å®‰è£…æˆåŠŸ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20200929094620145.png" alt="image-20200929094620145"></p><p>ä½¿ç”¨kubectlå·¥å…· ã€masterèŠ‚ç‚¹æ“ä½œã€‘</p><div class="code-wrapper"><pre><code class="hljs bash">mkdir -p <span class="hljs-variable">$HOME</span>/.kubesudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/configsudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config</code></pre></div><p>æ‰§è¡Œå®Œæˆåï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼ŒæŸ¥çœ‹æˆ‘ä»¬æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get nodes</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20200929094933142.png" alt="image-20200929094933142"></p><p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œç›®å‰æœ‰ä¸€ä¸ªmasterèŠ‚ç‚¹å·²ç»è¿è¡Œäº†ï¼Œä½†æ˜¯è¿˜å¤„äºæœªå‡†å¤‡çŠ¶æ€</p><p>ä¸‹é¢æˆ‘ä»¬è¿˜éœ€è¦åœ¨NodeèŠ‚ç‚¹æ‰§è¡Œå…¶å®ƒçš„å‘½ä»¤ï¼Œå°†node1å’Œnode2åŠ å…¥åˆ°æˆ‘ä»¬çš„masterèŠ‚ç‚¹ä¸Š</p><h2 id="6-åŠ å…¥Kubernetes-Nodeã€SlaveèŠ‚ç‚¹ã€‘"><a href="#6-åŠ å…¥Kubernetes-Nodeã€SlaveèŠ‚ç‚¹ã€‘" class="headerlink" title="6 åŠ å…¥Kubernetes Nodeã€SlaveèŠ‚ç‚¹ã€‘"></a>6 åŠ å…¥Kubernetes Nodeã€SlaveèŠ‚ç‚¹ã€‘</h2><p>ä¸‹é¢æˆ‘ä»¬éœ€è¦åˆ° node1 å’Œ node2æœåŠ¡å™¨ï¼Œæ‰§è¡Œä¸‹é¢çš„ä»£ç å‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹</p><p>æ‰§è¡Œåœ¨kubeadm initè¾“å‡ºçš„kubeadm joinå‘½ä»¤ï¼š</p><blockquote><p>æ³¨æ„ï¼Œä»¥ä¸‹çš„å‘½ä»¤æ˜¯åœ¨masteråˆå§‹åŒ–å®Œæˆåï¼Œæ¯ä¸ªäººçš„éƒ½ä¸ä¸€æ ·ï¼ï¼ï¼éœ€è¦å¤åˆ¶è‡ªå·±ç”Ÿæˆçš„</p></blockquote><div class="code-wrapper"><pre><code class="hljs bash">kubeadm join 192.168.177.130:6443 --token 8j6ui9.gyr4i156u30y80xf \    --discovery-token-ca-cert-hash sha256:eda1380256a62d8733f4bddf926f148e57cf9d1a3a58fb45dd6e80768af5a500</code></pre></div><p>é»˜è®¤tokenæœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œå½“è¿‡æœŸä¹‹åï¼Œè¯¥tokenå°±ä¸å¯ç”¨äº†ã€‚è¿™æ—¶å°±éœ€è¦é‡æ–°åˆ›å»ºtokenï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs gauss">kubeadm <span class="hljs-built_in">token</span> <span class="hljs-keyword">create</span> --<span class="hljs-keyword">print</span>-join-command</code></pre></div><p>å½“æˆ‘ä»¬æŠŠä¸¤ä¸ªèŠ‚ç‚¹éƒ½åŠ å…¥è¿›æ¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥å»MasterèŠ‚ç‚¹ æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥çœ‹æƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get node</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113165358663.png" alt="image-20201113165358663"></p><h2 id="7-éƒ¨ç½²CNIç½‘ç»œæ’ä»¶"><a href="#7-éƒ¨ç½²CNIç½‘ç»œæ’ä»¶" class="headerlink" title="7 éƒ¨ç½²CNIç½‘ç»œæ’ä»¶"></a>7 éƒ¨ç½²CNIç½‘ç»œæ’ä»¶</h2><p>ä¸Šé¢çš„çŠ¶æ€è¿˜æ˜¯NotReadyï¼Œä¸‹é¢æˆ‘ä»¬éœ€è¦ç½‘ç»œæ’ä»¶ï¼Œæ¥è¿›è¡Œè”ç½‘è®¿é—®</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½ç½‘ç»œæ’ä»¶é…ç½®</span>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre></div><p>é»˜è®¤é•œåƒåœ°å€æ— æ³•è®¿é—®ï¼Œsedå‘½ä»¤ä¿®æ”¹ä¸ºdocker hubé•œåƒä»“åº“ã€‚</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># æ·»åŠ </span>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<span class="hljs-comment">##â‘ é¦–å…ˆä¸‹è½½v0.13.1-rc2-amd64 é•œåƒ</span><span class="hljs-comment">##å‚è€ƒåšå®¢ï¼šhttps://www.cnblogs.com/pyxuexi/p/14288591.html</span><span class="hljs-comment">##â‘¡ å¯¼å…¥é•œåƒï¼Œå‘½ä»¤ï¼Œï¼Œç‰¹åˆ«æç¤ºï¼Œ3ä¸ªæœºå™¨éƒ½éœ€è¦å¯¼å…¥ï¼Œ3ä¸ªæœºå™¨éƒ½éœ€è¦å¯¼å…¥ï¼Œ3ä¸ªæœºå™¨éƒ½éœ€è¦å¯¼å…¥ï¼Œ3ä¸ªæœºå™¨éƒ½éœ€è¦å¯¼å…¥ï¼Œé‡è¦çš„äº‹æƒ…è¯´3éã€‚ä¸ç„¶æŠ±é”™ã€‚å¦‚æœæ²¡æœ‰æ“ä½œï¼ŒæŠ¥é”™åï¼Œéœ€è¦åˆ é™¤èŠ‚ç‚¹ï¼Œé‡ç½®ï¼Œåœ¨å¯¼å…¥é•œåƒï¼Œé‡æ–°åŠ å…¥æ‰è¡Œã€‚æœ¬åœ°å°±æ˜¯è¿™æ ·æ“ä½œæˆåŠŸçš„ï¼</span>docker load &lt; flanneld-v0.13.1-rc2-amd64.docker<span class="hljs-comment">#####ä¸‹è½½æœ¬åœ°ï¼Œæ›¿æ¢å°†image: quay.io/coreos/flannel:v0.13.1-rc2 æ›¿æ¢ä¸º image: quay.io/coreos/flannel:v0.13.1-rc2-amd64</span><span class="hljs-comment"># æŸ¥çœ‹çŠ¶æ€ ã€kube-systemæ˜¯k8sä¸­çš„æœ€å°å•å…ƒã€‘</span>kubectl get pods -n kube-system</code></pre></div><p>è¿è¡Œåçš„ç»“æœ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113165929510.png" alt="image-20201113165929510"></p><p>è¿è¡Œå®Œæˆåï¼Œæˆ‘ä»¬æŸ¥çœ‹çŠ¶æ€å¯ä»¥å‘ç°ï¼Œå·²ç»å˜æˆäº†ReadyçŠ¶æ€äº†</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113194557147.png" alt="image-20201113194557147"></p><p>å¦‚æœä¸Šè¿°æ“ä½œå®Œæˆåï¼Œè¿˜å­˜åœ¨æŸä¸ªèŠ‚ç‚¹å¤„äºNotReadyçŠ¶æ€ï¼Œå¯ä»¥åœ¨Masterå°†è¯¥èŠ‚ç‚¹åˆ é™¤</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># masterèŠ‚ç‚¹å°†è¯¥èŠ‚ç‚¹åˆ é™¤</span><span class="hljs-comment">##20210223 yan æŸ¥é˜…èµ„æ–™æ·»åŠ ###kubectl drain k8snode1 --delete-local-data --force --ignore-daemonsets</span>kubectl delete node k8snode1 <span class="hljs-comment"># ç„¶ååˆ°k8snode1èŠ‚ç‚¹è¿›è¡Œé‡ç½®</span> kubeadm reset<span class="hljs-comment"># é‡ç½®å®Œååœ¨åŠ å…¥</span>kubeadm join 192.168.177.130:6443 --token 8j6ui9.gyr4i156u30y80xf     --discovery-token-ca-cert-hash sha256:eda1380256a62d8733f4bddf926f148e57cf9d1a3a58fb45dd6e80768af5a500</code></pre></div><h2 id="8-æµ‹è¯•kubernetesé›†ç¾¤"><a href="#8-æµ‹è¯•kubernetesé›†ç¾¤" class="headerlink" title="8 æµ‹è¯•kubernetesé›†ç¾¤"></a>8 æµ‹è¯•kubernetesé›†ç¾¤</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“K8Sæ˜¯å®¹å™¨åŒ–æŠ€æœ¯ï¼Œå®ƒå¯ä»¥è”ç½‘å»ä¸‹è½½é•œåƒï¼Œç”¨å®¹å™¨çš„æ–¹å¼è¿›è¡Œå¯åŠ¨</p><p>åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½nginx ã€ä¼šè”ç½‘æ‹‰å–nginxé•œåƒã€‘</span>kubectl create deployment nginx --image=nginx<span class="hljs-comment"># æŸ¥çœ‹çŠ¶æ€</span>kubectl get pod</code></pre></div><p>å¦‚æœæˆ‘ä»¬å‡ºç°RunningçŠ¶æ€çš„æ—¶å€™ï¼Œè¡¨ç¤ºå·²ç»æˆåŠŸè¿è¡Œäº†</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113203537028.png" alt="image-20201113203537028"></p><p>ä¸‹é¢æˆ‘ä»¬å°±éœ€è¦å°†ç«¯å£æš´éœ²å‡ºå»ï¼Œè®©å…¶å®ƒå¤–ç•Œèƒ½å¤Ÿè®¿é—®</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># æš´éœ²ç«¯å£</span>kubectl expose deployment nginx --port=80 --<span class="hljs-built_in">type</span>=NodePort<span class="hljs-comment"># æŸ¥çœ‹ä¸€ä¸‹å¯¹å¤–çš„ç«¯å£</span>kubectl get pod,svc</code></pre></div><p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæš´éœ²äº† 80ç«¯å£  åˆ° 30529ä¸Š</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113203840915.png" alt="image-20201113203840915"></p><p>æˆ‘ä»¬åˆ°æˆ‘ä»¬çš„å®¿ä¸»æœºæµè§ˆå™¨ä¸Šï¼Œè®¿é—®å¦‚ä¸‹åœ°å€</p><div class="code-wrapper"><pre><code class="hljs bash">http://192.168.177.130:30529/</code></pre></div><p>å‘ç°æˆ‘ä»¬çš„nginxå·²ç»æˆåŠŸå¯åŠ¨äº†</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113204056851.png" alt="image-20201113204056851"></p><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±æ­å»ºäº†ä¸€ä¸ªå•masterçš„k8sé›†ç¾¤</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/3_%E4%BD%BF%E7%94%A8kubeadm%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113204158884.png" alt="image-20201113204158884"></p><h2 id="9-é”™è¯¯æ±‡æ€»"><a href="#9-é”™è¯¯æ±‡æ€»" class="headerlink" title="9 é”™è¯¯æ±‡æ€»"></a>9 é”™è¯¯æ±‡æ€»</h2><h3 id="9-1-é”™è¯¯ä¸€"><a href="#9-1-é”™è¯¯ä¸€" class="headerlink" title="9.1 é”™è¯¯ä¸€"></a>9.1 é”™è¯¯ä¸€</h3><p>åœ¨æ‰§è¡ŒKubernetes  initæ–¹æ³•çš„æ—¶å€™ï¼Œå‡ºç°è¿™ä¸ªé—®é¢˜</p><div class="code-wrapper"><pre><code class="hljs bash">error execution phase preflight: [preflight] Some fatal errors occurred:[ERROR NumCPU]: the number of available CPUs 1 is less than the required 2</code></pre></div><p>æ˜¯å› ä¸ºVMwareè®¾ç½®çš„æ ¸æ•°ä¸º1ï¼Œè€ŒK8Séœ€è¦çš„æœ€ä½æ ¸æ•°åº”è¯¥æ˜¯2ï¼Œè°ƒæ•´æ ¸æ•°é‡å¯ç³»ç»Ÿå³å¯</p><h3 id="9-2-é”™è¯¯äºŒ"><a href="#9-2-é”™è¯¯äºŒ" class="headerlink" title="9.2 é”™è¯¯äºŒ"></a>9.2 é”™è¯¯äºŒ</h3><p>æˆ‘ä»¬åœ¨ç»™node1èŠ‚ç‚¹ä½¿ç”¨ kubernetes joinå‘½ä»¤çš„æ—¶å€™ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯</p><div class="code-wrapper"><pre><code class="hljs bash">error execution phase preflight: [preflight] Some fatal errors occurred:[ERROR Swap]: running with swap on is not supported. Please <span class="hljs-built_in">disable</span> swap</code></pre></div><p>é”™è¯¯åŸå› æ˜¯æˆ‘ä»¬éœ€è¦å…³é—­swap</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># å…³é—­swap</span><span class="hljs-comment"># ä¸´æ—¶</span>swapoff -a <span class="hljs-comment"># ä¸´æ—¶</span>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</code></pre></div><h3 id="9-3-é”™è¯¯ä¸‰"><a href="#9-3-é”™è¯¯ä¸‰" class="headerlink" title="9.3 é”™è¯¯ä¸‰"></a>9.3 é”™è¯¯ä¸‰</h3><p>åœ¨ç»™node1èŠ‚ç‚¹ä½¿ç”¨ kubernetes joinå‘½ä»¤çš„æ—¶å€™ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯</p><div class="code-wrapper"><pre><code class="hljs bash">The HTTP call equal to <span class="hljs-string">&#x27;curl -sSL http://localhost:10248/healthz&#x27;</span> failed with error: Get http://localhost:10248/healthz: dial tcp [::1]:10248: connect: connection refused</code></pre></div><p>è§£å†³æ–¹æ³•ï¼Œé¦–å…ˆéœ€è¦åˆ° master èŠ‚ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span>mkdir /etc/systemd/system/kubelet.service.d<span class="hljs-comment"># åˆ›å»ºæ–‡ä»¶</span>vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<span class="hljs-comment"># æ·»åŠ å¦‚ä¸‹å†…å®¹</span>Environment=<span class="hljs-string">&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true --fail-swap-on=false&quot;</span><span class="hljs-comment"># é‡ç½®</span>kubeadm reset</code></pre></div><p>ç„¶ååˆ é™¤åˆšåˆšåˆ›å»ºçš„é…ç½®ç›®å½•</p><div class="code-wrapper"><pre><code class="hljs bash">rm -rf <span class="hljs-variable">$HOME</span>/.kube</code></pre></div><p>ç„¶å åœ¨masteré‡æ–°åˆå§‹åŒ–</p><div class="code-wrapper"><pre><code class="hljs bash">kubeadm init --apiserver-advertise-address=202.193.57.11 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.18.0 --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16</code></pre></div><p>åˆå§‹å®Œæˆåï¼Œæˆ‘ä»¬å†åˆ° node1èŠ‚ç‚¹ï¼Œæ‰§è¡Œ kubeadm joinå‘½ä»¤ï¼ŒåŠ å…¥åˆ°master</p><div class="code-wrapper"><pre><code class="hljs bash">kubeadm join 202.193.57.11:6443 --token c7a7ou.z00fzlb01d76r37s \    --discovery-token-ca-cert-hash sha256:9c3f3cc3f726c6ff8bdff14e46b1a856e3b8a4cbbe30cab185f6c5ee453aeea5</code></pre></div><p>æ·»åŠ å®Œæˆåï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦æˆåŠŸæ·»åŠ </p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get nodes</code></pre></div><h3 id="9-4-é”™è¯¯å››"><a href="#9-4-é”™è¯¯å››" class="headerlink" title="9.4 é”™è¯¯å››"></a>9.4 é”™è¯¯å››</h3><p>æˆ‘ä»¬å†æ‰§è¡ŒæŸ¥çœ‹èŠ‚ç‚¹çš„æ—¶å€™ï¼Œ  kubectl get nodes ä¼šå‡ºç°é—®é¢˜</p><div class="code-wrapper"><pre><code class="hljs bash">Unable to connect to the server: x509: certificate signed by unknown authority (possibly because of <span class="hljs-string">&quot;crypto/rsa: verification error&quot;</span> <span class="hljs-keyword">while</span> trying to verify candidate authority certificate <span class="hljs-string">&quot;kubernetes&quot;</span>)</code></pre></div><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„é…ç½®æ–‡ä»¶è¿˜å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¿™äº›é…ç½®</p><div class="code-wrapper"><pre><code class="hljs bash">mkdir -p <span class="hljs-variable">$HOME</span>/.kubesudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/configsudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config</code></pre></div><p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æŠŠé…ç½®æ–‡ä»¶åˆ é™¤ï¼Œç„¶åé‡æ–°æ‰§è¡Œä¸€ä¸‹</p><div class="code-wrapper"><pre><code class="hljs bash">rm -rf <span class="hljs-variable">$HOME</span>/.kube</code></pre></div><p>ç„¶åå†æ¬¡åˆ›å»ºä¸€ä¸‹å³å¯</p><div class="code-wrapper"><pre><code class="hljs bash">mkdir -p <span class="hljs-variable">$HOME</span>/.kubesudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/configsudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config</code></pre></div><p>è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨æ‰§è¡Œ kubeadm reset çš„æ—¶å€™ï¼Œæ²¡æœ‰æŠŠ $HOME/.kube ç»™ç§»é™¤æ‰ï¼Œå†æ¬¡åˆ›å»ºæ—¶å°±ä¼šå‡ºç°é—®é¢˜äº†</p><h3 id="9-5-é”™è¯¯äº”"><a href="#9-5-é”™è¯¯äº”" class="headerlink" title="9.5 é”™è¯¯äº”"></a>9.5 é”™è¯¯äº”</h3><p>å®‰è£…çš„æ—¶å€™ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯</p><div class="code-wrapper"><pre><code class="hljs bash">Another app is currently holding the yum lock; waiting <span class="hljs-keyword">for</span> it to <span class="hljs-built_in">exit</span>...</code></pre></div><p>æ˜¯å› ä¸ºyumä¸Šé”å ç”¨ï¼Œè§£å†³æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs bash">yum -y install docker-ce</code></pre></div><h3 id="9-6-é”™è¯¯å…­"><a href="#9-6-é”™è¯¯å…­" class="headerlink" title="9.6 é”™è¯¯å…­"></a>9.6 é”™è¯¯å…­</h3><p>åœ¨ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼Œæ·»åŠ nodeèŠ‚ç‚¹åˆ°é›†ç¾¤ä¸Šçš„æ—¶å€™</p><div class="code-wrapper"><pre><code class="hljs bash">kubeadm join 192.168.177.130:6443 --token jkcz0t.3c40t0bqqz5g8wsb  --discovery-token-ca-cert-hash sha256:bc494eeab6b7bac64c0861da16084504626e5a95ba7ede7b9c2dc7571ca4c9e5</code></pre></div><p>ç„¶åå‡ºç°äº†è¿™ä¸ªé”™è¯¯</p><div class="code-wrapper"><pre><code class="hljs bash">[root@k8smaster ~]<span class="hljs-comment"># kubeadm join 192.168.177.130:6443 --token jkcz0t.3c40t0bqqz5g8wsb     --discovery-token-ca-cert-hash sha256:bc494eeab6b7bac64c0861da16084504626e5a95ba7ede7b9c2dc7571ca4c9e5</span>W1117 06:55:11.220907   11230 join.go:346] [preflight] WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not <span class="hljs-built_in">set</span>.[preflight] Running pre-flight checks[WARNING IsDockerSystemdCheck]: detected <span class="hljs-string">&quot;cgroupfs&quot;</span> as the Docker cgroup driver. The recommended driver is <span class="hljs-string">&quot;systemd&quot;</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/error execution phase preflight: [preflight] Some fatal errors occurred:[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not <span class="hljs-built_in">set</span> to 1[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`To see the stack trace of this error execute with --v=5 or higher</code></pre></div><p>å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒLinuxç³»ç»Ÿ<strong>é»˜è®¤æ˜¯ç¦æ­¢æ•°æ®åŒ…è½¬å‘</strong>çš„ã€‚æ‰€è°“<strong>è½¬å‘å³å½“ä¸»æœºæ‹¥æœ‰å¤šäºä¸€å—çš„ç½‘å¡æ—¶ï¼Œå…¶ä¸­ä¸€å—æ”¶åˆ°æ•°æ®åŒ…ï¼Œæ ¹æ®æ•°æ®åŒ…çš„ç›®çš„ipåœ°å€å°†åŒ…å‘å¾€æœ¬æœºå¦ä¸€ç½‘å¡ï¼Œè¯¥ç½‘å¡æ ¹æ®è·¯ç”±è¡¨ç»§ç»­å‘é€æ•°æ®åŒ…</strong>ã€‚è¿™é€šå¸¸å°±æ˜¯è·¯ç”±å™¨æ‰€è¦å®ç°çš„åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´  <strong>/proc/sys/net/ipv4/ip_forward</strong> æ–‡ä»¶çš„å€¼ä¸æ”¯æŒè½¬å‘</p><ul><li>0ï¼šç¦æ­¢</li><li>1ï¼šè½¬å‘</li></ul><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å€¼ä¿®æ”¹æˆ1å³å¯</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> â€œ1â€ &gt; /proc/sys/net/ipv4/ip_forward</code></pre></div><p>ä¿®æ”¹å®Œæˆåï¼Œé‡æ–°æ‰§è¡Œå‘½ä»¤å³å¯</p><h1 id="ç¬¬4ç« -ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤"><a href="#ç¬¬4ç« -ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤" class="headerlink" title="ç¬¬4ç«  ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤"></a>ç¬¬4ç«  ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤</h1><h2 id="1-å‡†å¤‡å·¥ä½œ"><a href="#1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="1 å‡†å¤‡å·¥ä½œ"></a>1 å‡†å¤‡å·¥ä½œ</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶</p><ul><li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»ŸCentOS 7.x</li><li>ç¡¬ä»¶é…ç½®ï¼š2GB ï¼Œ2ä¸ªCPUï¼Œç¡¬ç›˜30GB</li><li>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š</li><li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒï¼Œå¦‚æœæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œéœ€è¦æå‰ä¸‹è½½é•œåƒå¯¼å…¥èŠ‚ç‚¹</li><li>ç¦æ­¢swapåˆ†åŒº</li></ul><h2 id="2-æ­¥éª¤"><a href="#2-æ­¥éª¤" class="headerlink" title="2 æ­¥éª¤"></a>2 æ­¥éª¤</h2><ul><li>åˆ›å»ºå¤šå°è™šæ‹Ÿæœºï¼Œå®‰è£…Linuxç³»ç»Ÿ</li><li>æ“ä½œç³»ç»Ÿçš„åˆå§‹åŒ–</li><li>ä¸ºetcd å’Œ apiserver è‡ªç­¾è¯ä¹¦</li><li>éƒ¨ç½²etcdé›†ç¾¤</li><li>éƒ¨ç½²masterç»„ä»¶ã€å®‰è£…dockerã€kube-apiserverã€kube-controller-managerã€kube-schedulerã€etcdã€‘</li><li>éƒ¨ç½²nodeç»„ä»¶ã€å®‰è£…kubeletã€kube-proxyã€dockerã€etcdã€‘</li><li>éƒ¨ç½²é›†ç¾¤ç½‘ç»œ</li></ul><h2 id="3-å‡†å¤‡è™šæ‹Ÿæœº"><a href="#3-å‡†å¤‡è™šæ‹Ÿæœº" class="headerlink" title="3 å‡†å¤‡è™šæ‹Ÿæœº"></a>3 å‡†å¤‡è™šæ‹Ÿæœº</h2><p>é¦–å…ˆæˆ‘ä»¬å‡†å¤‡äº†ä¸¤å°è™šæ‹Ÿæœºï¼Œæ¥è¿›è¡Œå®‰è£…æµ‹è¯•</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th></tr></thead><tbody><tr><td>k8s_2_master</td><td>192.168.177.140</td></tr><tr><td>k8s_2_node</td><td>192.168.177.141</td></tr></tbody></table><h2 id="4-æ“ä½œç³»ç»Ÿçš„åˆå§‹åŒ–"><a href="#4-æ“ä½œç³»ç»Ÿçš„åˆå§‹åŒ–" class="headerlink" title="4 æ“ä½œç³»ç»Ÿçš„åˆå§‹åŒ–"></a>4 æ“ä½œç³»ç»Ÿçš„åˆå§‹åŒ–</h2><p>ç„¶åæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># å…³é—­é˜²ç«å¢™</span>systemctl stop firewalldsystemctl <span class="hljs-built_in">disable</span> firewalld<span class="hljs-comment"># å…³é—­selinux</span><span class="hljs-comment"># æ°¸ä¹…å…³é—­</span>sed -i <span class="hljs-string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  <span class="hljs-comment"># ä¸´æ—¶å…³é—­</span>setenforce 0  <span class="hljs-comment"># å…³é—­swap</span><span class="hljs-comment"># ä¸´æ—¶</span>swapoff -a <span class="hljs-comment"># æ°¸ä¹…å…³é—­</span>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab<span class="hljs-comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºåã€masterèŠ‚ç‚¹ä¸Šæ“ä½œã€‘</span>hostnamectl set-hostname k8s_2_master<span class="hljs-comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºåã€node1èŠ‚ç‚¹æ“ä½œã€‘</span>hostnamectl set-hostname k8s_2_node1<span class="hljs-comment"># åœ¨masteræ·»åŠ hosts</span>cat &gt;&gt; /etc/hosts &lt;&lt; <span class="hljs-string">EOF</span><span class="hljs-string">192.168.177.140 k8s_2_master</span><span class="hljs-string">192.168.177.141 k8s_2_node1</span><span class="hljs-string">EOF</span><span class="hljs-comment"># å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</span>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="hljs-string">EOF</span><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><span class="hljs-string">EOF</span><span class="hljs-comment"># ç”Ÿæ•ˆ</span>sysctl --system  <span class="hljs-comment"># æ—¶é—´åŒæ­¥</span>yum install ntpdate -yntpdate time.windows.com</code></pre></div><h2 id="5-éƒ¨ç½²Etcdé›†ç¾¤"><a href="#5-éƒ¨ç½²Etcdé›†ç¾¤" class="headerlink" title="5 éƒ¨ç½²Etcdé›†ç¾¤"></a>5 éƒ¨ç½²Etcdé›†ç¾¤</h2><p>Etcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼ŒKubernetesä½¿ç”¨Etcdè¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œæ‰€ä»¥å…ˆå‡†å¤‡ä¸€ä¸ªEtcdæ•°æ®åº“ï¼Œä¸ºäº†è§£å†³Etcdå•ç‚¹æ•…éšœï¼Œåº”é‡‡ç”¨é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œè¿™é‡Œä½¿ç”¨3å°ç»„å»ºé›†ç¾¤ï¼Œå¯å®¹å¿ä¸€å°æœºå™¨æ•…éšœï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨5å°ç»„ä»¶é›†ç¾¤ï¼Œå¯ä»¥å®¹å¿2å°æœºå™¨æ•…éšœ</p><h3 id="è‡ªç­¾è¯ä¹¦"><a href="#è‡ªç­¾è¯ä¹¦" class="headerlink" title="è‡ªç­¾è¯ä¹¦"></a>è‡ªç­¾è¯ä¹¦</h3><p>æåˆ°è¯ä¹¦ï¼Œæˆ‘ä»¬æƒ³åˆ°çš„å°±æ˜¯ä¸‹é¢è¿™ä¸ªæƒ…å†µ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/4_%E4%BD%BF%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113213116353.png" alt="image-20201113213116353"></p><p>è¿™ä¸ªhttpsè¯ä¹¦ï¼Œå…¶å®å°±æ˜¯æœåŠ¡å™¨é¢å‘ç»™ç½‘ç«™çš„ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå®‰å…¨å¯ä¿¡ä»»çš„ç½‘ç«™ã€‚</p><p>è€Œåœ¨æˆ‘ä»¬K8Sé›†ç¾¤çš„å†…éƒ¨ï¼Œå…¶å®ä¹Ÿæ˜¯æœ‰è¯ä¹¦çš„ï¼Œå¦‚æœä¸å¸¦è¯ä¹¦ï¼Œé‚£ä¹ˆè®¿é—®å°±ä¼šå—é™</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/4_%E4%BD%BF%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113213353267.png" alt="image-20201113213353267"></p><p>åŒæ—¶åœ¨é›†ç¾¤å†…éƒ¨ å’Œ å¤–éƒ¨çš„è®¿é—®ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ç­¾å‘è¯ä¹¦</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/4_%E4%BD%BF%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113213416013.png" alt="image-20201113213416013"></p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼ï¼Œé‚£ä¹ˆå°±éœ€è¦è‡ªå·±æ‰‹åŠ¨ç­¾å‘è¯ä¹¦ã€‚</p><p>è‡ªç­¾è¯ä¹¦ï¼šæˆ‘ä»¬å¯ä»¥æƒ³è±¡æˆåœ¨ä¸€å®¶å…¬å¸ä¸Šç­ï¼Œç„¶åä¼šé¢å‘ä¸€ä¸ªé—¨ç¦å¡ï¼ŒåŒæ—¶ä¸€èˆ¬é—¨ç¦å¡æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯å†…éƒ¨å‘˜å·¥çš„é—¨ç¦å¡ï¼Œå’Œå¤–éƒ¨è®¿å®¢é—¨ç¦å¡ã€‚è¿™ä¸¤ç§é—¨ç¦å¡çš„æƒé™å¯èƒ½ä¸åŒï¼Œå‘˜å·¥çš„é—¨ç¦å¡å¯ä»¥è¿›å…¥å…¬å¸çš„ä»»ä½•åœ°æ–¹ï¼Œè€Œè®¿å®¢çš„é—¨ç¦å¡æ˜¯å—é™çš„ï¼Œè¿™ä¸ªé—¨ç¦å¡å…¶å®å°±æ˜¯è‡ªç­¾è¯ä¹¦</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/4_%E4%BD%BF%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/images/image-20201113214234194.png" alt="image-20201113214234194"></p><h3 id="å‡†å¤‡cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·"><a href="#å‡†å¤‡cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·" class="headerlink" title="å‡†å¤‡cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·"></a>å‡†å¤‡cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·</h3><p>cfsslæ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨jsonæ–‡ä»¶ç”Ÿæˆè¯ä¹¦ï¼Œç›¸æ¯”openssl æ›´æ–¹ä¾¿ä½¿ç”¨ã€‚æ‰¾ä»»æ„ä¸€å°æœåŠ¡å™¨æ“ä½œï¼Œè¿™é‡Œç”¨MasterèŠ‚ç‚¹ã€‚</p><div class="code-wrapper"><pre><code class="hljs bash">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64mv cfssl_linux-amd64 /usr/<span class="hljs-built_in">local</span>/bin/cfsslmv cfssljson_linux-amd64 /usr/<span class="hljs-built_in">local</span>/bin/cfssljsonmv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</code></pre></div><h1 id="ç¬¬5ç« -Kubeadmå’ŒäºŒè¿›åˆ¶æ–¹å¼å¯¹æ¯”"><a href="#ç¬¬5ç« -Kubeadmå’ŒäºŒè¿›åˆ¶æ–¹å¼å¯¹æ¯”" class="headerlink" title="ç¬¬5ç«  Kubeadmå’ŒäºŒè¿›åˆ¶æ–¹å¼å¯¹æ¯”"></a>ç¬¬5ç«  Kubeadmå’ŒäºŒè¿›åˆ¶æ–¹å¼å¯¹æ¯”</h1><h2 id="1-Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤-1"><a href="#1-Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤-1" class="headerlink" title="1 Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤"></a>1 Kubeadmæ–¹å¼æ­å»ºK8Sé›†ç¾¤</h2><ul><li><p>å®‰è£…è™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºå®‰è£…Linuxæ“ä½œç³»ç»Ÿã€3å°è™šæ‹Ÿæœºã€‘</p></li><li><p>å¯¹æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ“ä½œ</p></li><li><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Dockerã€kubeadmã€kubeletã€kubectlã€åŒ…å«masterå’ŒslaveèŠ‚ç‚¹ã€‘</p><ul><li>å®‰è£…dockerã€ä½¿ç”¨yumï¼Œä¸æŒ‡å®šç‰ˆæœ¬é»˜è®¤å®‰è£…æœ€æ–°çš„dockerç‰ˆæœ¬</li><li>ä¿®æ”¹dockerä»“åº“åœ°å€ï¼Œyumæºåœ°å€ï¼Œæ”¹ä¸ºé˜¿é‡Œäº‘åœ°å€</li><li>å®‰è£…kubeadmï¼Œkubelet å’Œ kubectl<ul><li>k8så·²ç»å‘å¸ƒæœ€æ–°çš„1.19ç‰ˆæœ¬ï¼Œå¯ä»¥æŒ‡å®šç‰ˆæœ¬å®‰è£…ï¼Œä¸æŒ‡å®šå®‰è£…æœ€æ–°ç‰ˆæœ¬</li><li><code>yum install -y kubelet kubeadm kubectl</code></li></ul></li></ul></li><li><p>åœ¨masterèŠ‚ç‚¹æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤æ“ä½œ</p><ul><li><code>kubeadm init</code></li><li>é»˜è®¤æ‹‰å–é•œåƒåœ°å€ K8s.gcr.ioå›½å†…åœ°å€ï¼Œéœ€è¦ä½¿ç”¨å›½å†…åœ°å€</li></ul></li><li><p>å®‰è£…ç½‘ç»œæ’ä»¶(CNI)</p><ul><li><code>kubectl apply -f kube-flannel.yml</code></li><li></li></ul></li><li><p>åœ¨æ‰€æœ‰çš„nodeèŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨joinå‘½ä»¤ï¼ŒæŠŠnodeæ·»åŠ åˆ°masterèŠ‚ç‚¹ä¸Š</p></li><li><p>æµ‹è¯•kubernetesé›†ç¾¤</p></li></ul><h2 id="2-äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤"><a href="#2-äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤" class="headerlink" title="2 äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤"></a>2 äºŒè¿›åˆ¶æ–¹å¼æ­å»ºK8Sé›†ç¾¤</h2><ul><li>å®‰è£…è™šæ‹Ÿæœºå’Œæ“ä½œç³»ç»Ÿï¼Œå¯¹æ“ä½œç³»ç»Ÿè¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li><li>ç”Ÿæˆcfssl è‡ªç­¾è¯ä¹¦<ul><li><code>ca-key.pem</code>ã€<code>ca.pem</code></li><li><code>server-key.pem</code>ã€<code>server.pem</code></li></ul></li><li>éƒ¨ç½²Etcdé›†ç¾¤<ul><li>éƒ¨ç½²çš„æœ¬è´¨ï¼Œå°±æ˜¯æŠŠetcdé›†ç¾¤äº¤ç»™ systemd ç®¡ç†</li><li>æŠŠç”Ÿæˆçš„è¯ä¹¦å¤åˆ¶è¿‡æ¥ï¼Œå¯åŠ¨ï¼Œè®¾ç½®å¼€æœºå¯åŠ¨</li></ul></li><li>ä¸ºapiserverè‡ªç­¾è¯ä¹¦ï¼Œç”Ÿæˆè¿‡ç¨‹å’Œetcdç±»ä¼¼</li><li>éƒ¨ç½²masterç»„ä»¶ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶<ul><li>apiserver</li><li>controller-manager</li><li>scheduler</li><li>äº¤ç»™systemdç®¡ç†ï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨</li><li>å¦‚æœè¦å®‰è£…æœ€æ–°çš„1.19ç‰ˆæœ¬ï¼Œä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…</li></ul></li><li>éƒ¨ç½²nodeç»„ä»¶<ul><li>docker</li><li>kubelet</li><li>kube-proxyã€éœ€è¦æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·åŠ å…¥é›†ç¾¤ã€‘</li><li>äº¤ç»™systemdç®¡ç†ç»„ä»¶- ç»„ä»¶å¯åŠ¨ï¼Œè®¾ç½®å¼€æœºå¯åŠ¨</li></ul></li><li>æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯· å¹¶åŠ å…¥é›†ç¾¤</li><li>éƒ¨ç½²CNIç½‘ç»œæ’ä»¶</li><li>æµ‹è¯•Kubernetsé›†ç¾¤ã€å®‰è£…nginxæµ‹è¯•ã€‘</li></ul><h1 id="ç¬¬6ç« -Kubernetesé›†ç¾¤ç®¡ç†å·¥å…·kubectl"><a href="#ç¬¬6ç« -Kubernetesé›†ç¾¤ç®¡ç†å·¥å…·kubectl" class="headerlink" title="ç¬¬6ç«  Kubernetesé›†ç¾¤ç®¡ç†å·¥å…·kubectl"></a>ç¬¬6ç«  Kubernetesé›†ç¾¤ç®¡ç†å·¥å…·kubectl</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1 æ¦‚è¿°"></a>1 æ¦‚è¿°</h2><p>kubectlæ˜¯Kubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡kubectlèƒ½å¤Ÿå¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…å’Œéƒ¨ç½²</p><h2 id="2-å‘½ä»¤æ ¼å¼"><a href="#2-å‘½ä»¤æ ¼å¼" class="headerlink" title="2 å‘½ä»¤æ ¼å¼"></a>2 å‘½ä»¤æ ¼å¼</h2><p>å‘½ä»¤æ ¼å¼å¦‚ä¸‹</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl [<span class="hljs-built_in">command</span>] [<span class="hljs-built_in">type</span>] [name] [flags]</code></pre></div><p>å‚æ•°</p><ul><li>commandï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚createã€getã€describeã€delete</li><li>typeï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œèµ„æºç±»å‹æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå¼€å‘è€…èƒ½å¤Ÿä»¥å•æ•° ã€å¤æ•° å’Œ ç¼©ç•¥çš„å½¢å¼</li></ul><p>ä¾‹å¦‚ï¼š</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get pod pod1kubectl get pods pod1kubectl get po pod1</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/6_Kubernetes%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7kubectl/images/image-20201114095544185.png" alt="image-20201114095544185"></p><ul><li>nameï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°ä¹Ÿæ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå¦‚æœçœç•¥åç§°ï¼Œåˆ™ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„èµ„æºï¼Œä¾‹å¦‚</li></ul><div class="code-wrapper"><pre><code class="hljs bash">kubectl get pods</code></pre></div><ul><li>flagsï¼šæŒ‡å®šå¯é€‰çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼Œå¯ç”¨ -s æˆ–è€… -serverå‚æ•°æŒ‡å®šKubernetes API serverçš„åœ°å€å’Œç«¯å£</li></ul><h2 id="3-å¸¸è§å‘½ä»¤"><a href="#3-å¸¸è§å‘½ä»¤" class="headerlink" title="3 å¸¸è§å‘½ä»¤"></a>3 å¸¸è§å‘½ä»¤</h2><h3 id="3-1-kubectl-help-è·å–æ›´å¤šä¿¡æ¯"><a href="#3-1-kubectl-help-è·å–æ›´å¤šä¿¡æ¯" class="headerlink" title="3.1 kubectl help è·å–æ›´å¤šä¿¡æ¯"></a>3.1 kubectl help è·å–æ›´å¤šä¿¡æ¯</h3><p>é€šè¿‡ helpå‘½ä»¤ï¼Œèƒ½å¤Ÿè·å–å¸®åŠ©ä¿¡æ¯</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># è·å–kubectlçš„å‘½ä»¤</span>kubectl --<span class="hljs-built_in">help</span><span class="hljs-comment"># è·å–æŸä¸ªå‘½ä»¤çš„ä»‹ç»å’Œä½¿ç”¨</span>kubectl get --<span class="hljs-built_in">help</span></code></pre></div><h3 id="3-2-åŸºç¡€å‘½ä»¤"><a href="#3-2-åŸºç¡€å‘½ä»¤" class="headerlink" title="3.2 åŸºç¡€å‘½ä»¤"></a>3.2 åŸºç¡€å‘½ä»¤</h3><p>å¸¸è§çš„åŸºç¡€å‘½ä»¤</p><table><thead><tr><th align="center">å‘½ä»¤</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">create</td><td align="center">é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºèµ„æº</td></tr><tr><td align="center">expose</td><td align="center">å°†ä¸€ä¸ªèµ„æºå…¬å¼€ä¸ºä¸€ä¸ªæ–°çš„Service</td></tr><tr><td align="center">run</td><td align="center">åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªç‰¹å®šçš„é•œåƒ</td></tr><tr><td align="center">set</td><td align="center">åœ¨å¯¹è±¡ä¸Šè®¾ç½®ç‰¹å®šçš„åŠŸèƒ½</td></tr><tr><td align="center">get</td><td align="center">æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æº</td></tr><tr><td align="center">explain</td><td align="center">æ–‡æ¡£å‚è€ƒèµ„æ–™</td></tr><tr><td align="center">edit</td><td align="center">ä½¿ç”¨é»˜è®¤çš„ç¼–è¾‘å™¨ç¼–è¾‘ä¸€ä¸ªèµ„æº</td></tr><tr><td align="center">delete</td><td align="center">é€šè¿‡æ–‡ä»¶åï¼Œæ ‡å‡†è¾“å…¥ï¼Œèµ„æºåç§°æˆ–æ ‡ç­¾æ¥åˆ é™¤èµ„æº</td></tr></tbody></table><h3 id="3-3-éƒ¨ç½²å‘½ä»¤"><a href="#3-3-éƒ¨ç½²å‘½ä»¤" class="headerlink" title="3.3 éƒ¨ç½²å‘½ä»¤"></a>3.3 éƒ¨ç½²å‘½ä»¤</h3><table><thead><tr><th align="center">å‘½ä»¤</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">rollout</td><td align="center">ç®¡ç†èµ„æºçš„å‘å¸ƒ</td></tr><tr><td align="center">rolling-update</td><td align="center">å¯¹ç»™å®šçš„å¤åˆ¶æ§åˆ¶å™¨æ»šåŠ¨æ›´æ–°</td></tr><tr><td align="center">scale</td><td align="center">æ‰©å®¹æˆ–ç¼©å®¹Podæ•°é‡ï¼ŒDeploymentã€ReplicaSetã€RCæˆ–Job</td></tr><tr><td align="center">autoscale</td><td align="center">åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é€‰æ‹©æ‰©å®¹æˆ–ç¼©å®¹å¹¶è®¾ç½®Podæ•°é‡</td></tr></tbody></table><h3 id="3-4-é›†ç¾¤ç®¡ç†å‘½ä»¤"><a href="#3-4-é›†ç¾¤ç®¡ç†å‘½ä»¤" class="headerlink" title="3.4 é›†ç¾¤ç®¡ç†å‘½ä»¤"></a>3.4 é›†ç¾¤ç®¡ç†å‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>certificate</td><td>ä¿®æ”¹è¯ä¹¦èµ„æº</td></tr><tr><td>cluster-info</td><td>æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯</td></tr><tr><td>top</td><td>æ˜¾ç¤ºèµ„æº(CPU/M)</td></tr><tr><td>cordon</td><td>æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦</td></tr><tr><td>uncordon</td><td>æ ‡è®°èŠ‚ç‚¹å¯è¢«è°ƒåº¦</td></tr><tr><td>drain</td><td>é©±é€èŠ‚ç‚¹ä¸Šçš„åº”ç”¨ï¼Œå‡†å¤‡ä¸‹çº¿ç»´æŠ¤</td></tr><tr><td>taint</td><td>ä¿®æ”¹èŠ‚ç‚¹taintæ ‡è®°</td></tr><tr><td></td><td></td></tr></tbody></table><h3 id="3-5-æ•…éšœå’Œè°ƒè¯•å‘½ä»¤"><a href="#3-5-æ•…éšœå’Œè°ƒè¯•å‘½ä»¤" class="headerlink" title="3.5 æ•…éšœå’Œè°ƒè¯•å‘½ä»¤"></a>3.5 æ•…éšœå’Œè°ƒè¯•å‘½ä»¤</h3><table><thead><tr><th align="center">å‘½ä»¤</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">describe</td><td align="center">æ˜¾ç¤ºç‰¹å®šèµ„æºæˆ–èµ„æºç»„çš„è¯¦ç»†ä¿¡æ¯</td></tr><tr><td align="center">logs</td><td align="center">åœ¨ä¸€ä¸ªPodä¸­æ‰“å°ä¸€ä¸ªå®¹å™¨æ—¥å¿—ï¼Œå¦‚æœPodåªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨åç§°æ˜¯å¯é€‰çš„</td></tr><tr><td align="center">attach</td><td align="center">é™„åŠ åˆ°ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨</td></tr><tr><td align="center">exec</td><td align="center">æ‰§è¡Œå‘½ä»¤åˆ°å®¹å™¨</td></tr><tr><td align="center">port-forward</td><td align="center">è½¬å‘ä¸€ä¸ªæˆ–å¤šä¸ª</td></tr><tr><td align="center">proxy</td><td align="center">è¿è¡Œä¸€ä¸ªproxyåˆ°Kubernetes API Server</td></tr><tr><td align="center">cp</td><td align="center">æ‹·è´æ–‡ä»¶æˆ–ç›®å½•åˆ°å®¹å™¨ä¸­</td></tr><tr><td align="center">auth</td><td align="center">æ£€æŸ¥æˆæƒ</td></tr></tbody></table><h3 id="3-6-å…¶å®ƒå‘½ä»¤"><a href="#3-6-å…¶å®ƒå‘½ä»¤" class="headerlink" title="3.6 å…¶å®ƒå‘½ä»¤"></a>3.6 å…¶å®ƒå‘½ä»¤</h3><table><thead><tr><th align="center">å‘½ä»¤</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">apply</td><td align="center">é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥å¯¹èµ„æºåº”ç”¨é…ç½®</td></tr><tr><td align="center">patch</td><td align="center">ä½¿ç”¨è¡¥ä¸ä¿®æ”¹ã€æ›´æ–°èµ„æºçš„å­—æ®µ</td></tr><tr><td align="center">replace</td><td align="center">é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥æ›¿æ¢ä¸€ä¸ªèµ„æº</td></tr><tr><td align="center">convert</td><td align="center">ä¸åŒçš„APIç‰ˆæœ¬ä¹‹é—´è½¬æ¢é…ç½®æ–‡ä»¶</td></tr><tr><td align="center">label</td><td align="center">æ›´æ–°èµ„æºä¸Šçš„æ ‡ç­¾</td></tr><tr><td align="center">annotate</td><td align="center">æ›´æ–°èµ„æºä¸Šçš„æ³¨é‡Š</td></tr><tr><td align="center">completion</td><td align="center">ç”¨äºå®ç°kubectlå·¥å…·è‡ªåŠ¨è¡¥å…¨</td></tr><tr><td align="center">api-versions</td><td align="center">æ‰“å°å—æ”¯æŒçš„APIç‰ˆæœ¬</td></tr><tr><td align="center">config</td><td align="center">ä¿®æ”¹kubeconfigæ–‡ä»¶ï¼ˆç”¨äºè®¿é—®APIï¼Œæ¯”å¦‚é…ç½®è®¤è¯ä¿¡æ¯ï¼‰</td></tr><tr><td align="center">help</td><td align="center">æ‰€æœ‰å‘½ä»¤å¸®åŠ©</td></tr><tr><td align="center">plugin</td><td align="center">è¿è¡Œä¸€ä¸ªå‘½ä»¤è¡Œæ’ä»¶</td></tr><tr><td align="center">version</td><td align="center">æ‰“å°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç‰ˆæœ¬ä¿¡æ¯</td></tr></tbody></table><h3 id="3-7-ç›®å‰ä½¿ç”¨çš„å‘½ä»¤"><a href="#3-7-ç›®å‰ä½¿ç”¨çš„å‘½ä»¤" class="headerlink" title="3.7 ç›®å‰ä½¿ç”¨çš„å‘½ä»¤"></a>3.7 ç›®å‰ä½¿ç”¨çš„å‘½ä»¤</h3><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªnginxé•œåƒ</span>kubectl create deployment nginx --image=nginx<span class="hljs-comment"># å¯¹å¤–æš´éœ²ç«¯å£</span>kubectl expose deployment nginx --port=80 --<span class="hljs-built_in">type</span>=NodePort<span class="hljs-comment"># æŸ¥çœ‹èµ„æº</span>kubectl get pod, svc</code></pre></div><h1 id="ç¬¬7ç« -Kubernetesé›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£"><a href="#ç¬¬7ç« -Kubernetesé›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£" class="headerlink" title="ç¬¬7ç«  Kubernetesé›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£"></a>ç¬¬7ç«  Kubernetesé›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£</h1><h2 id="1-æ¦‚è¿°-1"><a href="#1-æ¦‚è¿°-1" class="headerlink" title="1 æ¦‚è¿°"></a>1 æ¦‚è¿°</h2><p>k8s é›†ç¾¤ä¸­å¯¹èµ„æºç®¡ç†å’Œèµ„æºå¯¹è±¡ç¼–æ’éƒ¨ç½²éƒ½å¯ä»¥é€šè¿‡å£°æ˜æ ·å¼ï¼ˆYAMLï¼‰æ–‡ä»¶æ¥è§£å†³ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æŠŠéœ€è¦å¯¹èµ„æºå¯¹è±¡æ“ä½œç¼–è¾‘åˆ°YAML æ ¼å¼æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æ–‡ä»¶å«åšèµ„æºæ¸…å•æ–‡ä»¶ï¼Œé€šè¿‡kubectl å‘½ä»¤ç›´æ¥ä½¿ç”¨èµ„æºæ¸…å•æ–‡ä»¶å°±å¯ä»¥å®ç°å¯¹å¤§é‡çš„èµ„æºå¯¹è±¡è¿›è¡Œç¼–æ’éƒ¨ç½²äº†ã€‚ä¸€èˆ¬åœ¨æˆ‘ä»¬å¼€å‘çš„æ—¶å€™ï¼Œéƒ½æ˜¯é€šè¿‡é…ç½®YAMLæ–‡ä»¶æ¥éƒ¨ç½²é›†ç¾¤çš„ã€‚</p><p>YAMLæ–‡ä»¶ï¼šå°±æ˜¯èµ„æºæ¸…å•æ–‡ä»¶ï¼Œç”¨äºèµ„æºç¼–æ’</p><h2 id="2-YAMLæ–‡ä»¶ä»‹ç»"><a href="#2-YAMLæ–‡ä»¶ä»‹ç»" class="headerlink" title="2 YAMLæ–‡ä»¶ä»‹ç»"></a>2 YAMLæ–‡ä»¶ä»‹ç»</h2><h3 id="2-1-YAMLæ¦‚è¿°"><a href="#2-1-YAMLæ¦‚è¿°" class="headerlink" title="2.1 YAMLæ¦‚è¿°"></a>2.1 YAMLæ¦‚è¿°</h3><p>YAML ï¼šä»æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ã€‚ä¸ºäº†å¼ºè°ƒè¿™ç§è¯­è¨€ä»¥æ•°æ®åšä¸ºä¸­å¿ƒï¼Œè€Œä¸æ˜¯ä»¥æ ‡è®°è¯­è¨€ä¸ºé‡ç‚¹ã€‚</p><p>YAML æ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜ï¼Œç”¨æ¥è¡¨è¾¾æ•°æ®åºåˆ—çš„æ ¼å¼ã€‚</p><h3 id="2-2-YAML-åŸºæœ¬è¯­æ³•"><a href="#2-2-YAML-åŸºæœ¬è¯­æ³•" class="headerlink" title="2.2 YAML åŸºæœ¬è¯­æ³•"></a>2.2 YAML åŸºæœ¬è¯­æ³•</h3><ul><li>ä½¿ç”¨ç©ºæ ¼åšä¸ºç¼©è¿›</li><li>ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯</li><li>ä½ç‰ˆæœ¬ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨Tab é”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼</li><li>ä½¿ç”¨#æ ‡è¯†æ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£é‡Šå™¨å¿½ç•¥</li><li>ä½¿ç”¨ â€” è¡¨ç¤ºæ–°çš„yamlæ–‡ä»¶å¼€å§‹</li></ul><h3 id="2-3-YAML-æ”¯æŒçš„æ•°æ®ç»“æ„"><a href="#2-3-YAML-æ”¯æŒçš„æ•°æ®ç»“æ„" class="headerlink" title="2.3 YAML æ”¯æŒçš„æ•°æ®ç»“æ„"></a>2.3 YAML æ”¯æŒçš„æ•°æ®ç»“æ„</h3><h4 id="å¯¹è±¡"><a href="#å¯¹è±¡" class="headerlink" title="å¯¹è±¡"></a>å¯¹è±¡</h4><p>é”®å€¼å¯¹çš„é›†åˆï¼Œåˆç§°ä¸ºæ˜ å°„(mapping) / å“ˆå¸Œï¼ˆhashesï¼‰ / å­—å…¸ï¼ˆdictionaryï¼‰</p><div class="code-wrapper"><pre><code class="hljs yaml"><span class="hljs-comment"># å¯¹è±¡ç±»å‹ï¼šå¯¹è±¡çš„ä¸€ç»„é”®å€¼å¯¹ï¼Œä½¿ç”¨å†’å·ç»“æ„è¡¨ç¤º</span><span class="hljs-attr">name:</span> <span class="hljs-string">Tom</span><span class="hljs-attr">age:</span> <span class="hljs-number">18</span><span class="hljs-comment"># yaml ä¹Ÿå…è®¸å¦ä¸€ç§å†™æ³•ï¼Œå°†æ‰€æœ‰é”®å€¼å¯¹å†™æˆä¸€ä¸ªè¡Œå†…å¯¹è±¡</span><span class="hljs-attr">hash:</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">Tom</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">18</span>&#125;</code></pre></div><h4 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h4><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># æ•°ç»„ç±»å‹ï¼šä¸€ç»„è¿è¯çº¿å¼€å¤´çš„è¡Œï¼Œæ„æˆä¸€ä¸ªæ•°ç»„</span>People- Tom- Jack<span class="hljs-comment"># æ•°ç»„ä¹Ÿå¯ä»¥é‡‡ç”¨è¡Œå†…è¡¨ç¤ºæ³•</span>People: [Tom, Jack]</code></pre></div><h2 id="3-YAMLæ–‡ä»¶ç»„æˆéƒ¨åˆ†"><a href="#3-YAMLæ–‡ä»¶ç»„æˆéƒ¨åˆ†" class="headerlink" title="3 YAMLæ–‡ä»¶ç»„æˆéƒ¨åˆ†"></a>3 YAMLæ–‡ä»¶ç»„æˆéƒ¨åˆ†</h2><p>ä¸»è¦åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯æ§åˆ¶å™¨çš„å®šä¹‰å’Œè¢«æ§åˆ¶çš„å¯¹è±¡</p><h3 id="3-1-æ§åˆ¶å™¨çš„å®šä¹‰"><a href="#3-1-æ§åˆ¶å™¨çš„å®šä¹‰" class="headerlink" title="3.1 æ§åˆ¶å™¨çš„å®šä¹‰"></a>3.1 æ§åˆ¶å™¨çš„å®šä¹‰</h3><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/7_Kubernetes%E9%9B%86%E7%BE%A4YAML%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/images/image-20201114110444032.png" alt="image-20201114110444032"></p><h3 id="3-2-è¢«æ§åˆ¶çš„å¯¹è±¡"><a href="#3-2-è¢«æ§åˆ¶çš„å¯¹è±¡" class="headerlink" title="3.2 è¢«æ§åˆ¶çš„å¯¹è±¡"></a>3.2 è¢«æ§åˆ¶çš„å¯¹è±¡</h3><p>åŒ…å«ä¸€äº› é•œåƒï¼Œç‰ˆæœ¬ã€ç«¯å£ç­‰</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/7_Kubernetes%E9%9B%86%E7%BE%A4YAML%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/images/image-20201114110600165.png" alt="image-20201114110600165"></p><h3 id="3-3-å±æ€§è¯´æ˜"><a href="#3-3-å±æ€§è¯´æ˜" class="headerlink" title="3.3 å±æ€§è¯´æ˜"></a>3.3 å±æ€§è¯´æ˜</h3><p>åœ¨ä¸€ä¸ªYAMLæ–‡ä»¶çš„æ§åˆ¶å™¨å®šä¹‰ä¸­ï¼Œæœ‰å¾ˆå¤šå±æ€§åç§°</p><table><thead><tr><th align="center">å±æ€§åç§°</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">apiVersion</td><td align="center">APIç‰ˆæœ¬</td></tr><tr><td align="center">kind</td><td align="center">èµ„æºç±»å‹</td></tr><tr><td align="center">metadata</td><td align="center">èµ„æºå…ƒæ•°æ®</td></tr><tr><td align="center">spec</td><td align="center">èµ„æºè§„æ ¼</td></tr><tr><td align="center">replicas</td><td align="center">å‰¯æœ¬æ•°é‡</td></tr><tr><td align="center">selector</td><td align="center">æ ‡ç­¾é€‰æ‹©å™¨</td></tr><tr><td align="center">template</td><td align="center">Podæ¨¡æ¿</td></tr><tr><td align="center">metadata</td><td align="center">Podå…ƒæ•°æ®</td></tr><tr><td align="center">spec</td><td align="center">Podè§„æ ¼</td></tr><tr><td align="center">containers</td><td align="center">å®¹å™¨é…ç½®</td></tr></tbody></table><h2 id="4-å¦‚ä½•å¿«é€Ÿç¼–å†™YAMLæ–‡ä»¶"><a href="#4-å¦‚ä½•å¿«é€Ÿç¼–å†™YAMLæ–‡ä»¶" class="headerlink" title="4 å¦‚ä½•å¿«é€Ÿç¼–å†™YAMLæ–‡ä»¶"></a>4 å¦‚ä½•å¿«é€Ÿç¼–å†™YAMLæ–‡ä»¶</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¾ˆå°‘è‡ªå·±æ‰‹å†™YAMLæ–‡ä»¶ï¼Œå› ä¸ºè¿™é‡Œé¢æ¶‰åŠåˆ°äº†å¾ˆå¤šå†…å®¹ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šå€ŸåŠ©å·¥å…·æ¥åˆ›å»º</p><h3 id="ä½¿ç”¨kubectl-createå‘½ä»¤"><a href="#ä½¿ç”¨kubectl-createå‘½ä»¤" class="headerlink" title="ä½¿ç”¨kubectl createå‘½ä»¤"></a>ä½¿ç”¨kubectl createå‘½ä»¤</h3><p>è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºèµ„æºæ²¡æœ‰éƒ¨ç½²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªYAMLé…ç½®æ–‡ä»¶</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># å°è¯•è¿è¡Œ,å¹¶ä¸ä¼šçœŸæ­£çš„åˆ›å»ºé•œåƒ</span>kubectl create deployment web --image=nginx -o yaml --dry-run</code></pre></div><p>æˆ–è€…æˆ‘ä»¬å¯ä»¥è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl create deployment web --image=nginx -o yaml --dry-run &gt; hello.yaml</code></pre></div><p>ç„¶åæˆ‘ä»¬å°±åœ¨æ–‡ä»¶ä¸­ç›´æ¥ä¿®æ”¹å³å¯</p><h3 id="ä½¿ç”¨kubectl-getå‘½ä»¤å¯¼å‡ºyamlæ–‡ä»¶"><a href="#ä½¿ç”¨kubectl-getå‘½ä»¤å¯¼å‡ºyamlæ–‡ä»¶" class="headerlink" title="ä½¿ç”¨kubectl getå‘½ä»¤å¯¼å‡ºyamlæ–‡ä»¶"></a>ä½¿ç”¨kubectl getå‘½ä»¤å¯¼å‡ºyamlæ–‡ä»¶</h3><p>å¯ä»¥é¦–å…ˆæŸ¥çœ‹ä¸€ä¸ªç›®å‰å·²ç»éƒ¨ç½²çš„é•œåƒ</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get deploy</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/7_Kubernetes%E9%9B%86%E7%BE%A4YAML%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/images/image-20201114113115649.png" alt="image-20201114113115649"></p><p>ç„¶åæˆ‘ä»¬å¯¼å‡º nginxçš„é…ç½®</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># æ³¨æ„ --exportåœ¨æ–°ç‰ˆæœ¬ä¸­å·²ç»è¢«å»é™¤äº†</span>kubectl get deploy nginx -o=yaml --<span class="hljs-built_in">export</span> &gt; nginx.yaml</code></pre></div><p>ç„¶åä¼šç”Ÿæˆä¸€ä¸ª <code>nginx.yaml</code> çš„é…ç½®æ–‡ä»¶</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/7_Kubernetes%E9%9B%86%E7%BE%A4YAML%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/images/image-20201114184538797.png" alt="image-20201114184538797"></p><h1 id="ç¬¬8ç« -Kubernetesæ ¸å¿ƒæŠ€æœ¯Pod"><a href="#ç¬¬8ç« -Kubernetesæ ¸å¿ƒæŠ€æœ¯Pod" class="headerlink" title="ç¬¬8ç«  Kubernetesæ ¸å¿ƒæŠ€æœ¯Pod"></a>ç¬¬8ç«  Kubernetesæ ¸å¿ƒæŠ€æœ¯Pod</h1><h2 id="1-Podæ¦‚è¿°"><a href="#1-Podæ¦‚è¿°" class="headerlink" title="1 Podæ¦‚è¿°"></a>1 Podæ¦‚è¿°</h2><p>Podæ˜¯K8Sç³»ç»Ÿä¸­å¯ä»¥åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ˜¯èµ„æºå¯¹è±¡æ¨¡å‹ä¸­ç”±ç”¨æˆ·åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°èµ„æºå¯¹è±¡æ¨¡å‹ï¼Œä¹Ÿæ˜¯åœ¨K8Sä¸Šè¿è¡Œå®¹å™¨åŒ–åº”ç”¨çš„èµ„æºå¯¹è±¡ï¼Œå…¶å®ƒçš„èµ„æºå¯¹è±¡éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘æˆ–è€…æ‰©å±•Podå¯¹è±¡åŠŸèƒ½çš„ï¼Œæ¯”å¦‚æ§åˆ¶å™¨å¯¹è±¡æ˜¯ç”¨æ¥ç®¡æ§Podå¯¹è±¡çš„ï¼ŒServiceæˆ–è€…Ingressèµ„æºå¯¹è±¡æ˜¯ç”¨æ¥æš´éœ²Podå¼•ç”¨å¯¹è±¡çš„ï¼ŒPersistentVolumeèµ„æºå¯¹è±¡æ˜¯ç”¨æ¥ä¸ºPodæä¾›å­˜å‚¨ç­‰ç­‰ï¼ŒK8Sä¸ä¼šç›´æ¥å¤„ç†å®¹å™¨ï¼Œè€Œæ˜¯Podï¼ŒPodæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªcontainerç»„æˆã€‚</p><p>Podæ˜¯Kubernetesçš„æœ€é‡è¦æ¦‚å¿µï¼Œæ¯ä¸€ä¸ªPodéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸º â€œæ ¹å®¹å™¨â€çš„Pauseå®¹å™¨ã€‚Pauseå®¹å™¨å¯¹åº”çš„é•œåƒå±äºKuberneteså¹³å°çš„ä¸€éƒ¨åˆ†ï¼Œé™¤äº†Pauseå®¹å™¨ï¼Œæ¯ä¸ªPodè¿˜åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„ç”¨æˆ·ä¸šåŠ¡å®¹å™¨ã€‚</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114185528215.png" alt="image-20201114185528215"></p><h3 id="PodåŸºæœ¬æ¦‚å¿µ"><a href="#PodåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="PodåŸºæœ¬æ¦‚å¿µ"></a>PodåŸºæœ¬æ¦‚å¿µ</h3><ul><li>æœ€å°éƒ¨ç½²çš„å•å…ƒ</li><li>Podé‡Œé¢æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆã€ä¸€ç»„å®¹å™¨çš„é›†åˆã€‘</li><li>ä¸€ä¸ªpodä¸­çš„å®¹å™¨æ˜¯å…±äº«ç½‘ç»œå‘½åç©ºé—´</li><li>Podæ˜¯çŸ­æš‚çš„</li><li>æ¯ä¸ªPodåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„ç”¨æˆ·ä¸šåŠ¡å®¹å™¨</li></ul><h3 id="Podå­˜åœ¨çš„æ„ä¹‰"><a href="#Podå­˜åœ¨çš„æ„ä¹‰" class="headerlink" title="Podå­˜åœ¨çš„æ„ä¹‰"></a>Podå­˜åœ¨çš„æ„ä¹‰</h3><ul><li>åˆ›å»ºå®¹å™¨ä½¿ç”¨dockerï¼Œä¸€ä¸ªdockerå¯¹åº”ä¸€ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªå®¹å™¨è¿è¡Œä¸€ä¸ªåº”ç”¨è¿›ç¨‹</li><li>Podæ˜¯å¤šè¿›ç¨‹è®¾è®¡ï¼Œè¿ç”¨å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªPodé‡Œé¢æœ‰å¤šä¸ªå®¹å™¨ï¼Œè€Œä¸€ä¸ªå®¹å™¨é‡Œé¢è¿è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åº</li></ul><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114190018948.png" alt="image-20201114190018948"></p><ul><li>Podçš„å­˜åœ¨æ˜¯ä¸ºäº†äº²å¯†æ€§åº”ç”¨<ul><li>ä¸¤ä¸ªåº”ç”¨ä¹‹é—´è¿›è¡Œäº¤äº’</li><li>ç½‘ç»œä¹‹é—´çš„è°ƒç”¨ã€é€šè¿‡127.0.0.1 æˆ– socketã€‘</li><li>ä¸¤ä¸ªåº”ç”¨ä¹‹é—´éœ€è¦é¢‘ç¹è°ƒç”¨</li></ul></li></ul><p>Podæ˜¯åœ¨K8Sé›†ç¾¤ä¸­è¿è¡Œéƒ¨ç½²åº”ç”¨æˆ–æœåŠ¡çš„æœ€å°å•å…ƒï¼Œå®ƒæ˜¯å¯ä»¥æ”¯æŒå¤šå®¹å™¨çš„ã€‚Podçš„è®¾è®¡ç†å¿µæ˜¯æ”¯æŒå¤šä¸ªå®¹å™¨åœ¨ä¸€ä¸ªPodä¸­å…±äº«ç½‘ç»œåœ°å€å’Œæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å’Œæ–‡ä»¶å…±äº«è¿™ç§ç®€å•é«˜æ•ˆçš„æ–¹å¼ç»„åˆå®ŒæˆæœåŠ¡ã€‚åŒæ—¶Podå¯¹å¤šå®¹å™¨çš„æ”¯æŒæ˜¯K8Sä¸­æœ€åŸºç¡€çš„è®¾è®¡ç†å¿µã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå„è‡ªå¼€å‘æ„å»ºè‡ªå·±çš„å®¹å™¨é•œåƒï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ç»„åˆæˆä¸€ä¸ªå¾®æœåŠ¡å¯¹å¤–æä¾›æœåŠ¡ã€‚</p><p>Podæ˜¯K8Sé›†ç¾¤ä¸­æ‰€æœ‰ä¸šåŠ¡ç±»å‹çš„åŸºç¡€ï¼Œå¯ä»¥æŠŠPodçœ‹ä½œè¿è¡Œåœ¨K8Sé›†ç¾¤ä¸Šçš„å°æœºå™¨äººï¼Œä¸åŒç±»å‹çš„ä¸šåŠ¡å°±éœ€è¦ä¸åŒç±»å‹çš„å°æœºå™¨äººå»æ‰§è¡Œã€‚ç›®å‰K8Sçš„ä¸šåŠ¡ä¸»è¦å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§</p><ul><li>é•¿æœŸä¼ºæœå‹ï¼šlong-running</li><li>æ‰¹å¤„ç†å‹ï¼šbatch</li><li>èŠ‚ç‚¹åå°æ”¯æ’‘å‹ï¼šnode-daemon</li><li>æœ‰çŠ¶æ€åº”ç”¨å‹ï¼šstateful application</li></ul><p>ä¸Šè¿°çš„å‡ ç§ç±»å‹ï¼Œåˆ†åˆ«å¯¹åº”çš„å°æœºå™¨äººæ§åˆ¶å™¨ä¸ºï¼šDeploymentã€Jobã€DaemonSet å’Œ StatefulSet  (åé¢å°†ä»‹ç»æ§åˆ¶å™¨)</p><h2 id="2-Podå®ç°æœºåˆ¶"><a href="#2-Podå®ç°æœºåˆ¶" class="headerlink" title="2 Podå®ç°æœºåˆ¶"></a>2 Podå®ç°æœºåˆ¶</h2><p>ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤å¤§æœºåˆ¶</p><ul><li>å…±äº«ç½‘ç»œ</li><li>å…±äº«å­˜å‚¨</li></ul><h3 id="å…±äº«ç½‘ç»œ"><a href="#å…±äº«ç½‘ç»œ" class="headerlink" title="å…±äº«ç½‘ç»œ"></a>å…±äº«ç½‘ç»œ</h3><p>å®¹å™¨æœ¬èº«ä¹‹é—´ç›¸äº’éš”ç¦»çš„ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ <strong>namespace</strong> å’Œ <strong>group</strong> è¿›è¡Œéš”ç¦»ï¼Œé‚£ä¹ˆPodé‡Œé¢çš„å®¹å™¨å¦‚ä½•å®ç°é€šä¿¡ï¼Ÿ</p><ul><li>é¦–å…ˆéœ€è¦æ»¡è¶³å‰ææ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯å®¹å™¨éƒ½åœ¨åŒä¸€ä¸ª<strong>namespace</strong>ä¹‹é—´</li></ul><p>å…³äºPodå®ç°åŸç†ï¼Œé¦–å…ˆä¼šåœ¨Podä¼šåˆ›å»ºä¸€ä¸ªæ ¹å®¹å™¨ï¼š <code>pauseå®¹å™¨</code>ï¼Œç„¶åæˆ‘ä»¬åœ¨åˆ›å»ºä¸šåŠ¡å®¹å™¨ ã€nginxï¼Œredis ç­‰ã€‘ï¼Œåœ¨æˆ‘ä»¬åˆ›å»ºä¸šåŠ¡å®¹å™¨çš„æ—¶å€™ï¼Œä¼šæŠŠå®ƒæ·»åŠ åˆ° <code>infoå®¹å™¨</code> ä¸­</p><p>è€Œåœ¨ <code>infoå®¹å™¨</code> ä¸­ä¼šç‹¬ç«‹å‡º  ipåœ°å€ï¼Œmacåœ°å€ï¼Œport ç­‰ä¿¡æ¯ï¼Œç„¶åå®ç°ç½‘ç»œçš„å…±äº«</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114190913859.png" alt="image-20201114190913859"></p><p>å®Œæ•´æ­¥éª¤å¦‚ä¸‹</p><ul><li>é€šè¿‡ Pause å®¹å™¨ï¼ŒæŠŠå…¶å®ƒä¸šåŠ¡å®¹å™¨åŠ å…¥åˆ°Pauseå®¹å™¨é‡Œï¼Œè®©æ‰€æœ‰ä¸šåŠ¡å®¹å™¨åœ¨åŒä¸€ä¸ªåç§°ç©ºé—´ä¸­ï¼Œå¯ä»¥å®ç°ç½‘ç»œå…±äº«</li></ul><h3 id="å…±äº«å­˜å‚¨"><a href="#å…±äº«å­˜å‚¨" class="headerlink" title="å…±äº«å­˜å‚¨"></a>å…±äº«å­˜å‚¨</h3><p>PodæŒä¹…åŒ–æ•°æ®ï¼Œä¸“é—¨å­˜å‚¨åˆ°æŸä¸ªåœ°æ–¹ä¸­</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114193124160.png" alt="image-20201114193124160"></p><p>ä½¿ç”¨ Volumnæ•°æ®å·è¿›è¡Œå…±äº«å­˜å‚¨ï¼Œæ¡ˆä¾‹å¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114193341993.png" alt="image-20201114193341993"></p><h2 id="3-Podé•œåƒæ‹‰å–ç­–ç•¥"><a href="#3-Podé•œåƒæ‹‰å–ç­–ç•¥" class="headerlink" title="3 Podé•œåƒæ‹‰å–ç­–ç•¥"></a>3 Podé•œåƒæ‹‰å–ç­–ç•¥</h2><p>æˆ‘ä»¬ä»¥å…·ä½“å®ä¾‹æ¥è¯´ï¼Œæ‹‰å–ç­–ç•¥å°±æ˜¯ <code>imagePullPolicy</code></p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114193605230.png" alt="image-20201114193605230"></p><p>æ‹‰å–ç­–ç•¥ä¸»è¦åˆ†ä¸ºäº†ä»¥ä¸‹å‡ ç§</p><ul><li>IfNotPresentï¼šé»˜è®¤å€¼ï¼Œé•œåƒåœ¨å®¿ä¸»æœºä¸Šä¸å­˜åœ¨æ‰æ‹‰å–</li><li>Alwaysï¼šæ¯æ¬¡åˆ›å»ºPodéƒ½ä¼šé‡æ–°æ‹‰å–ä¸€æ¬¡é•œåƒ</li><li>Neverï¼šPodæ°¸è¿œä¸ä¼šä¸»åŠ¨æ‹‰å–è¿™ä¸ªé•œåƒ</li></ul><h2 id="4-Podèµ„æºé™åˆ¶"><a href="#4-Podèµ„æºé™åˆ¶" class="headerlink" title="4 Podèµ„æºé™åˆ¶"></a>4 Podèµ„æºé™åˆ¶</h2><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬Podåœ¨è¿›è¡Œè°ƒåº¦çš„æ—¶å€™ï¼Œå¯ä»¥å¯¹è°ƒåº¦çš„èµ„æºè¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚æˆ‘ä»¬é™åˆ¶ Podè°ƒåº¦æ˜¯ä½¿ç”¨çš„èµ„æºæ˜¯ 2C4Gï¼Œé‚£ä¹ˆåœ¨è°ƒåº¦å¯¹åº”çš„nodeèŠ‚ç‚¹æ—¶ï¼Œåªä¼šå ç”¨å¯¹åº”çš„èµ„æºï¼Œå¯¹äºä¸æ»¡è¶³èµ„æºçš„èŠ‚ç‚¹ï¼Œå°†ä¸ä¼šè¿›è¡Œè°ƒåº¦</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114194057920.png" alt="image-20201114194057920"></p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>æˆ‘ä»¬åœ¨ä¸‹é¢çš„åœ°æ–¹è¿›è¡Œèµ„æºçš„é™åˆ¶</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114194245517.png" alt="image-20201114194245517"></p><p>è¿™é‡Œåˆ†äº†ä¸¤ä¸ªéƒ¨åˆ†</p><ul><li>requestï¼šè¡¨ç¤ºè°ƒåº¦æ‰€éœ€çš„èµ„æº</li><li>limitsï¼šè¡¨ç¤ºæœ€å¤§æ‰€å ç”¨çš„èµ„æº</li></ul><h2 id="5-Podé‡å¯æœºåˆ¶"><a href="#5-Podé‡å¯æœºåˆ¶" class="headerlink" title="5 Podé‡å¯æœºåˆ¶"></a>5 Podé‡å¯æœºåˆ¶</h2><p>å› ä¸ºPodä¸­åŒ…å«äº†å¾ˆå¤šä¸ªå®¹å™¨ï¼Œå‡è®¾æŸä¸ªå®¹å™¨å‡ºç°é—®é¢˜äº†ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Podé‡å¯æœºåˆ¶</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114194722125.png" alt="image-20201114194722125"></p><p>é‡å¯ç­–ç•¥ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§</p><ul><li>Alwaysï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºåï¼Œæ€»æ˜¯é‡å¯å®¹å™¨ï¼Œé»˜è®¤ç­–ç•¥ ã€nginxç­‰ï¼Œéœ€è¦ä¸æ–­æä¾›æœåŠ¡ã€‘</li><li>OnFailureï¼šå½“å®¹å™¨å¼‚å¸¸é€€å‡ºï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰æ—¶ï¼Œæ‰é‡å¯å®¹å™¨ã€‚</li><li>Neverï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºï¼Œä»ä¸é‡å¯å®¹å™¨ ã€æ‰¹é‡ä»»åŠ¡ã€‘</li></ul><h2 id="6-Podå¥åº·æ£€æŸ¥"><a href="#6-Podå¥åº·æ£€æŸ¥" class="headerlink" title="6 Podå¥åº·æ£€æŸ¥"></a>6 Podå¥åº·æ£€æŸ¥</h2><p>é€šè¿‡å®¹å™¨æ£€æŸ¥ï¼ŒåŸæ¥æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get pod</code></pre></div><p>ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œç¨‹åºå¯èƒ½å‡ºç°äº† <strong>Java</strong> å †å†…å­˜æº¢å‡ºï¼Œç¨‹åºè¿˜åœ¨è¿è¡Œï¼Œä½†æ˜¯ä¸èƒ½å¯¹å¤–æä¾›æœåŠ¡äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸èƒ½é€šè¿‡ å®¹å™¨æ£€æŸ¥æ¥åˆ¤æ–­æœåŠ¡æ˜¯å¦å¯ç”¨äº†</p><p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨åº”ç”¨å±‚é¢çš„æ£€æŸ¥</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># å­˜æ´»æ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†æ€æ­»å®¹å™¨ï¼Œæ ¹æ®Podçš„restartPolicyã€é‡å¯ç­–ç•¥ã€‘æ¥æ“ä½œ</span>livenessProbe<span class="hljs-comment"># å°±ç»ªæ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼ŒKubernetesä¼šæŠŠPodä»Service endpointsä¸­å‰”é™¤</span>readinessProbe</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114195807564.png" alt="image-20201114195807564"></p><p>Probeæ”¯æŒä»¥ä¸‹ä¸‰ç§æ£€æŸ¥æ–¹å¼</p><ul><li>http Getï¼šå‘é€HTTPè¯·æ±‚ï¼Œè¿”å›200 - 400 èŒƒå›´çŠ¶æ€ç ä¸ºæˆåŠŸ</li><li>execï¼šæ‰§è¡ŒShellå‘½ä»¤è¿”å›çŠ¶æ€ç æ˜¯0ä¸ºæˆåŠŸ</li><li>tcpSocketï¼šå‘èµ·TCP Socketå»ºç«‹æˆåŠŸ</li></ul><h2 id="7-Podè°ƒåº¦ç­–ç•¥"><a href="#7-Podè°ƒåº¦ç­–ç•¥" class="headerlink" title="7 Podè°ƒåº¦ç­–ç•¥"></a>7 Podè°ƒåº¦ç­–ç•¥</h2><h3 id="åˆ›å»ºPodæµç¨‹"><a href="#åˆ›å»ºPodæµç¨‹" class="headerlink" title="åˆ›å»ºPodæµç¨‹"></a>åˆ›å»ºPodæµç¨‹</h3><ul><li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªpodï¼Œç„¶ååˆ›å»ºä¸€ä¸ªAPI Server å’Œ Etcdã€æŠŠåˆ›å»ºå‡ºæ¥çš„ä¿¡æ¯å­˜å‚¨åœ¨etcdä¸­ã€‘</li><li>ç„¶ååˆ›å»º Schedulerï¼Œç›‘æ§API Serveræ˜¯å¦æœ‰æ–°çš„Podï¼Œå¦‚æœæœ‰çš„è¯ï¼Œä¼šé€šè¿‡è°ƒåº¦ç®—æ³•ï¼ŒæŠŠpodè°ƒåº¦æŸä¸ªnodeä¸Š</li><li>åœ¨nodeèŠ‚ç‚¹ï¼Œä¼šé€šè¿‡ <code>kubelet -- apiserver</code> è¯»å–etcd æ‹¿åˆ°åˆ†é…åœ¨å½“å‰nodeèŠ‚ç‚¹ä¸Šçš„podï¼Œç„¶åé€šè¿‡dockeråˆ›å»ºå®¹å™¨</li></ul><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114201611308.png" alt="image-20201114201611308"></p><h3 id="å½±å“Podè°ƒåº¦çš„å±æ€§"><a href="#å½±å“Podè°ƒåº¦çš„å±æ€§" class="headerlink" title="å½±å“Podè°ƒåº¦çš„å±æ€§"></a>å½±å“Podè°ƒåº¦çš„å±æ€§</h3><p>Podèµ„æºé™åˆ¶å¯¹Podçš„è°ƒåº¦ä¼šæœ‰å½±å“</p><h4 id="æ ¹æ®requestæ‰¾åˆ°è¶³å¤ŸnodeèŠ‚ç‚¹è¿›è¡Œè°ƒåº¦"><a href="#æ ¹æ®requestæ‰¾åˆ°è¶³å¤ŸnodeèŠ‚ç‚¹è¿›è¡Œè°ƒåº¦" class="headerlink" title="æ ¹æ®requestæ‰¾åˆ°è¶³å¤ŸnodeèŠ‚ç‚¹è¿›è¡Œè°ƒåº¦"></a>æ ¹æ®requestæ‰¾åˆ°è¶³å¤ŸnodeèŠ‚ç‚¹è¿›è¡Œè°ƒåº¦</h4><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114194245517.png" alt="image-20201114194245517"></p><h4 id="èŠ‚ç‚¹é€‰æ‹©å™¨æ ‡ç­¾å½±å“Podè°ƒåº¦"><a href="#èŠ‚ç‚¹é€‰æ‹©å™¨æ ‡ç­¾å½±å“Podè°ƒåº¦" class="headerlink" title="èŠ‚ç‚¹é€‰æ‹©å™¨æ ‡ç­¾å½±å“Podè°ƒåº¦"></a>èŠ‚ç‚¹é€‰æ‹©å™¨æ ‡ç­¾å½±å“Podè°ƒåº¦</h4><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114202456151.png" alt="image-20201114202456151"></p><p>å…³äºèŠ‚ç‚¹é€‰æ‹©å™¨ï¼Œå…¶å®å°±æ˜¯æœ‰ä¸¤ä¸ªç¯å¢ƒï¼Œç„¶åç¯å¢ƒä¹‹é—´æ‰€ç”¨çš„èµ„æºé…ç½®ä¸åŒ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114202643905.png" alt="image-20201114202643905"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œç»™æˆ‘ä»¬çš„èŠ‚ç‚¹æ–°å¢æ ‡ç­¾ï¼Œç„¶åèŠ‚ç‚¹é€‰æ‹©å™¨å°±ä¼šè¿›è¡Œè°ƒåº¦äº†</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl label node node1 env_role=prod</code></pre></div><h4 id="èŠ‚ç‚¹äº²å’Œæ€§"><a href="#èŠ‚ç‚¹äº²å’Œæ€§" class="headerlink" title="èŠ‚ç‚¹äº²å’Œæ€§"></a>èŠ‚ç‚¹äº²å’Œæ€§</h4><p>èŠ‚ç‚¹äº²å’Œæ€§ <strong>nodeAffinity</strong> å’Œ ä¹‹å‰nodeSelector åŸºæœ¬ä¸€æ ·çš„ï¼Œæ ¹æ®èŠ‚ç‚¹ä¸Šæ ‡ç­¾çº¦æŸæ¥å†³å®šPodè°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š</p><ul><li>ç¡¬äº²å’Œæ€§ï¼šçº¦æŸæ¡ä»¶å¿…é¡»æ»¡è¶³</li><li>è½¯äº²å’Œæ€§ï¼šå°è¯•æ»¡è¶³ï¼Œä¸ä¿è¯</li></ul><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114203433939.png" alt="image-20201114203433939"></p><p>æ”¯æŒå¸¸ç”¨æ“ä½œç¬¦ï¼šinã€NotInã€Existsã€Gtã€Ltã€DoesNotExists</p><p>åäº²å’Œæ€§ï¼šå°±æ˜¯å’Œäº²å’Œæ€§åˆšåˆšç›¸åï¼Œå¦‚ NotInã€DoesNotExistsç­‰</p><h2 id="8-æ±¡ç‚¹å’Œæ±¡ç‚¹å®¹å¿"><a href="#8-æ±¡ç‚¹å’Œæ±¡ç‚¹å®¹å¿" class="headerlink" title="8 æ±¡ç‚¹å’Œæ±¡ç‚¹å®¹å¿"></a>8 æ±¡ç‚¹å’Œæ±¡ç‚¹å®¹å¿</h2><h3 id="8-1-æ¦‚è¿°"><a href="#8-1-æ¦‚è¿°" class="headerlink" title="8.1 æ¦‚è¿°"></a>8.1 æ¦‚è¿°</h3><p>nodeSelector å’Œ NodeAffinityï¼Œéƒ½æ˜¯Prodè°ƒåº¦åˆ°æŸäº›èŠ‚ç‚¹ä¸Šï¼Œå±äºPodçš„å±æ€§ï¼Œæ˜¯åœ¨è°ƒåº¦çš„æ—¶å€™å®ç°çš„ã€‚</p><p>Taint æ±¡ç‚¹ï¼šèŠ‚ç‚¹ä¸åšæ™®é€šåˆ†é…è°ƒåº¦ï¼Œæ˜¯èŠ‚ç‚¹å±æ€§</p><h3 id="8-2-åœºæ™¯"><a href="#8-2-åœºæ™¯" class="headerlink" title="8.2 åœºæ™¯"></a>8.2 åœºæ™¯</h3><ul><li>ä¸“ç”¨èŠ‚ç‚¹ã€é™åˆ¶ipã€‘</li><li>é…ç½®ç‰¹å®šç¡¬ä»¶çš„èŠ‚ç‚¹ã€å›ºæ€ç¡¬ç›˜ã€‘</li><li>åŸºäºTainté©±é€ã€åœ¨node1ä¸æ”¾ï¼Œåœ¨node2æ”¾ã€‘</li></ul><h3 id="8-3-æŸ¥çœ‹æ±¡ç‚¹æƒ…å†µ"><a href="#8-3-æŸ¥çœ‹æ±¡ç‚¹æƒ…å†µ" class="headerlink" title="8.3 æŸ¥çœ‹æ±¡ç‚¹æƒ…å†µ"></a>8.3 æŸ¥çœ‹æ±¡ç‚¹æƒ…å†µ</h3><div class="code-wrapper"><pre><code class="hljs bash">kubectl describe node k8smaster | grep Taint</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114204124819.png" alt="image-20201114204124819"></p><p>æ±¡ç‚¹å€¼æœ‰ä¸‰ä¸ª</p><ul><li>NoScheduleï¼šä¸€å®šä¸è¢«è°ƒåº¦</li><li>PreferNoScheduleï¼šå°½é‡ä¸è¢«è°ƒåº¦ã€ä¹Ÿæœ‰è¢«è°ƒåº¦çš„å‡ ç‡ã€‘</li><li>NoExecuteï¼šä¸ä¼šè°ƒåº¦ï¼Œå¹¶ä¸”è¿˜ä¼šé©±é€Nodeå·²æœ‰Pod</li></ul><h3 id="8-4-æœªèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹"><a href="#8-4-æœªèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹" class="headerlink" title="8.4 æœªèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹"></a>8.4 æœªèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹</h3><div class="code-wrapper"><pre><code class="hljs bash">kubectl taint node [node] key=value:æ±¡ç‚¹çš„ä¸‰ä¸ªå€¼</code></pre></div><p>ä¸¾ä¾‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl taint node k8snode1 env_role=yes:NoSchedule</code></pre></div><h3 id="8-5-åˆ é™¤æ±¡ç‚¹"><a href="#8-5-åˆ é™¤æ±¡ç‚¹" class="headerlink" title="8.5 åˆ é™¤æ±¡ç‚¹"></a>8.5 åˆ é™¤æ±¡ç‚¹</h3><div class="code-wrapper"><pre><code class="hljs bash">kubectl taint node k8snode1 env_role:NoSchedule-</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114210022883.png" alt="image-20201114210022883"></p><h3 id="8-6-æ¼”ç¤º"><a href="#8-6-æ¼”ç¤º" class="headerlink" title="8.6 æ¼”ç¤º"></a>8.6 æ¼”ç¤º</h3><p>æˆ‘ä»¬ç°åœ¨åˆ›å»ºå¤šä¸ªPodï¼ŒæŸ¥çœ‹æœ€ååˆ†é…åˆ°Nodeä¸Šçš„æƒ…å†µ</p><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª nginx çš„pod</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl create deployment web --image=nginx</code></pre></div><p>ç„¶åä½¿ç”¨å‘½ä»¤æŸ¥çœ‹</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get pods -o wide</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114204917548.png" alt="image-20201114204917548"></p><p>æˆ‘ä»¬å¯ä»¥éå¸¸æ˜æ˜¾çš„çœ‹åˆ°ï¼Œè¿™ä¸ªPodå·²ç»è¢«åˆ†é…åˆ° k8snode1 èŠ‚ç‚¹ä¸Šäº†</p><p>ä¸‹é¢æˆ‘ä»¬æŠŠpodå¤åˆ¶5ä»½ï¼Œåœ¨æŸ¥çœ‹æƒ…å†µpodæƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl scale deployment web --replicas=5</code></pre></div><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå› ä¸ºmasterèŠ‚ç‚¹å­˜åœ¨æ±¡ç‚¹çš„æƒ…å†µï¼Œæ‰€ä»¥èŠ‚ç‚¹éƒ½è¢«åˆ†é…åˆ°äº† node1 å’Œ node2èŠ‚ç‚¹ä¸Š</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114205135282.png" alt="image-20201114205135282"></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼ŒæŠŠåˆšåˆšæˆ‘ä»¬åˆ›å»ºçš„podéƒ½åˆ é™¤</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl delete deployment web</code></pre></div><p>ç°åœ¨ç»™äº†æ›´å¥½çš„æ¼”ç¤ºæ±¡ç‚¹çš„ç”¨æ³•ï¼Œæˆ‘ä»¬ç°åœ¨ç»™ node1èŠ‚ç‚¹æ‰“ä¸Šæ±¡ç‚¹</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl taint node k8snode1 env_role=yes:NoSchedule</code></pre></div><p>ç„¶åæˆ‘ä»¬æŸ¥çœ‹æ±¡ç‚¹æ˜¯å¦æˆåŠŸæ·»åŠ </p><div class="code-wrapper"><pre><code class="hljs bash">kubectl describe node k8snode1 | grep Taint</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114205516154.png" alt="image-20201114205516154"></p><p>ç„¶åæˆ‘ä»¬åœ¨åˆ›å»ºä¸€ä¸ª pod</p><div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºnginx pod</span>kubectl create deployment web --image=nginx<span class="hljs-comment"># å¤åˆ¶äº”æ¬¡</span>kubectl scale deployment web --replicas=5</code></pre></div><p>ç„¶åæˆ‘ä»¬åœ¨è¿›è¡ŒæŸ¥çœ‹</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get pods -o wide</code></pre></div><p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ç°åœ¨æ‰€æœ‰çš„podéƒ½è¢«åˆ†é…åˆ°äº† k8snode2ä¸Šï¼Œå› ä¸ºåˆšåˆšæˆ‘ä»¬ç»™node1èŠ‚ç‚¹è®¾ç½®äº†æ±¡ç‚¹</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114205654867.png" alt="image-20201114205654867"></p><p>æœ€åæˆ‘ä»¬å¯ä»¥åˆ é™¤åˆšåˆšæ·»åŠ çš„æ±¡ç‚¹</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl taint node k8snode1 env_role:NoSchedule-</code></pre></div><h3 id="8-7-æ±¡ç‚¹å®¹å¿"><a href="#8-7-æ±¡ç‚¹å®¹å¿" class="headerlink" title="8.7 æ±¡ç‚¹å®¹å¿"></a>8.7 æ±¡ç‚¹å®¹å¿</h3><p>æ±¡ç‚¹å®¹å¿å°±æ˜¯æŸä¸ªèŠ‚ç‚¹å¯èƒ½è¢«è°ƒåº¦ï¼Œä¹Ÿå¯èƒ½ä¸è¢«è°ƒåº¦</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/8_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFPod/images/image-20201114210146123.png" alt="image-20201114210146123"></p><h1 id="ç¬¬9ç« -Kubernetesæ ¸å¿ƒæŠ€æœ¯-Controller"><a href="#ç¬¬9ç« -Kubernetesæ ¸å¿ƒæŠ€æœ¯-Controller" class="headerlink" title="ç¬¬9ç«  Kubernetesæ ¸å¿ƒæŠ€æœ¯-Controller"></a>ç¬¬9ç«  Kubernetesæ ¸å¿ƒæŠ€æœ¯-Controller</h1><h2 id="1-å†…å®¹"><a href="#1-å†…å®¹" class="headerlink" title="1 å†…å®¹"></a>1 å†…å®¹</h2><ul><li>ä»€ä¹ˆæ˜¯Controller</li><li>Podå’ŒControllerçš„å…³ç³»</li><li>Deploymentæ§åˆ¶å™¨åº”ç”¨åœºæ™¯</li><li>yamlæ–‡ä»¶å­—æ®µè¯´æ˜</li><li>Deploymentæ§åˆ¶å™¨éƒ¨ç½²åº”ç”¨</li><li>å‡çº§å›æ»š</li><li>å¼¹æ€§ä¼¸ç¼©</li></ul><h2 id="2-ä»€ä¹ˆæ˜¯Controller"><a href="#2-ä»€ä¹ˆæ˜¯Controller" class="headerlink" title="2 ä»€ä¹ˆæ˜¯Controller"></a>2 ä»€ä¹ˆæ˜¯Controller</h2><p>Controlleræ˜¯åœ¨é›†ç¾¤ä¸Šç®¡ç†å’Œè¿è¡Œå®¹å™¨çš„å¯¹è±¡ï¼ŒControlleræ˜¯å®é™…å­˜åœ¨çš„ï¼ŒPodæ˜¯è™šæ‹Ÿæœºçš„</p><h2 id="3-Podå’ŒControllerçš„å…³ç³»"><a href="#3-Podå’ŒControllerçš„å…³ç³»" class="headerlink" title="3 Podå’ŒControllerçš„å…³ç³»"></a>3 Podå’ŒControllerçš„å…³ç³»</h2><p>Podæ˜¯é€šè¿‡Controllerå®ç°åº”ç”¨çš„è¿ç»´ï¼Œæ¯”å¦‚å¼¹æ€§ä¼¸ç¼©ï¼Œæ»šåŠ¨å‡çº§ç­‰</p><p>Pod å’Œ Controllerä¹‹é—´æ˜¯é€šè¿‡labelæ ‡ç­¾æ¥å»ºç«‹å…³ç³»ï¼ŒåŒæ—¶Controlleråˆè¢«ç§°ä¸ºæ§åˆ¶å™¨å·¥ä½œè´Ÿè½½</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116092431237.png" alt="image-20201116092431237"></p><h2 id="4-Deploymentæ§åˆ¶å™¨åº”ç”¨"><a href="#4-Deploymentæ§åˆ¶å™¨åº”ç”¨" class="headerlink" title="4 Deploymentæ§åˆ¶å™¨åº”ç”¨"></a>4 Deploymentæ§åˆ¶å™¨åº”ç”¨</h2><ul><li>Deploymentæ§åˆ¶å™¨å¯ä»¥éƒ¨ç½²æ— çŠ¶æ€åº”ç”¨</li><li>ç®¡ç†Podå’ŒReplicaSet</li><li>éƒ¨ç½²ï¼Œæ»šåŠ¨å‡çº§ç­‰åŠŸèƒ½</li><li>åº”ç”¨åœºæ™¯ï¼šwebæœåŠ¡ï¼Œå¾®æœåŠ¡</li></ul><p>Deploymentè¡¨ç¤ºç”¨æˆ·å¯¹K8Sé›†ç¾¤çš„ä¸€æ¬¡æ›´æ–°æ“ä½œã€‚Deploymentæ˜¯ä¸€ä¸ªæ¯”RS( Replica Set, RS) åº”ç”¨æ¨¡å‹æ›´å¹¿çš„ API å¯¹è±¡ï¼Œå¯ä»¥æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œæ›´æ–°ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯æ»šåŠ¨å‡çº§ä¸€ä¸ªæœåŠ¡ã€‚æ»šåŠ¨å‡çº§ä¸€ä¸ªæœåŠ¡ï¼Œå®é™…æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„RSï¼Œç„¶åé€æ¸å°†æ–° RS ä¸­å‰¯æœ¬æ•°å¢åŠ åˆ°ç†æƒ³çŠ¶æ€ï¼Œå°†æ—§RSä¸­çš„å‰¯æœ¬æ•°å‡å°‘åˆ°0çš„å¤åˆæ“ä½œã€‚</p><p>è¿™æ ·ä¸€ä¸ªå¤åˆæ“ä½œç”¨ä¸€ä¸ªRSæ˜¯ä¸å¥½æè¿°çš„ï¼Œæ‰€ä»¥ç”¨ä¸€ä¸ªæ›´é€šç”¨çš„Deploymentæ¥æè¿°ã€‚ä»¥K8Sçš„å‘å±•æ–¹å‘ï¼Œæœªæ¥å¯¹æ‰€æœ‰é•¿æœŸä¼ºæœå‹çš„ä¸šåŠ¡çš„ç®¡ç†ï¼Œéƒ½ä¼šé€šè¿‡Deploymentæ¥ç®¡ç†ã€‚</p><h2 id="5-Deploymentéƒ¨ç½²åº”ç”¨"><a href="#5-Deploymentéƒ¨ç½²åº”ç”¨" class="headerlink" title="5 Deploymentéƒ¨ç½²åº”ç”¨"></a>5 Deploymentéƒ¨ç½²åº”ç”¨</h2><p>ä¹‹å‰æˆ‘ä»¬ä¹Ÿä½¿ç”¨Deploymentéƒ¨ç½²è¿‡åº”ç”¨ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º</p><div class="code-wrapper"><pre><code class="hljs bash">kubectrl create deployment web --image=nginx</code></pre></div><p>ä½†æ˜¯ä¸Šè¿°ä»£ç ä¸æ˜¯å¾ˆå¥½çš„è¿›è¡Œå¤ç”¨ï¼Œå› ä¸ºæ¯æ¬¡æˆ‘ä»¬éƒ½éœ€è¦é‡æ–°è¾“å…¥ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡YAMLè¿›è¡Œé…ç½®</p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨ä¸Šé¢çš„ä»£ç åˆ›å»ºä¸€ä¸ªé•œåƒã€åªæ˜¯å°è¯•ï¼Œä¸ä¼šåˆ›å»ºã€‘</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl create deployment web --image=nginx --dry-run -o yaml &gt; nginx.yaml</code></pre></div><p>ç„¶åè¾“å‡ºä¸€ä¸ªyamlé…ç½®æ–‡ä»¶ <code>nginx.yml</code> ï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤º</p><div class="code-wrapper"><pre><code class="hljs bash">apiVersion: apps/v1kind: Deploymentmetadata:  creationTimestamp: null  labels:    app: web  name: webspec:  replicas: 1  selector:    matchLabels:      app: web  strategy: &#123;&#125;  template:    metadata:      creationTimestamp: null      labels:        app: web    spec:      containers:      - image: nginx        name: nginx        resources: &#123;&#125;status: &#123;&#125;</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°çš„ selector å’Œ label å°±æ˜¯æˆ‘ä»¬Pod å’Œ Controllerä¹‹é—´å»ºç«‹å…³ç³»çš„æ¡¥æ¢</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116093638951.png" alt="image-20201116093638951"></p><h3 id="ä½¿ç”¨YAMLåˆ›å»ºPod"><a href="#ä½¿ç”¨YAMLåˆ›å»ºPod" class="headerlink" title="ä½¿ç”¨YAMLåˆ›å»ºPod"></a>ä½¿ç”¨YAMLåˆ›å»ºPod</h3><p>é€šè¿‡åˆšåˆšçš„ä»£ç ï¼Œæˆ‘ä»¬å·²ç»ç”Ÿæˆäº†YAMLæ–‡ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶å¿«é€Ÿåˆ›å»ºPodé•œåƒäº†</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl apply -f nginx.yaml</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116094046007.png" alt="image-20201116094046007"></p><p>ä½†æ˜¯å› ä¸ºè¿™ä¸ªæ–¹å¼åˆ›å»ºçš„ï¼Œæˆ‘ä»¬åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯¹å¤–æš´éœ²ç«¯å£</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl expose deployment web --port=80 --<span class="hljs-built_in">type</span>=NodePort --target-port=80 --name=web1</code></pre></div><p>å…³äºä¸Šè¿°å‘½ä»¤ï¼Œæœ‰å‡ ä¸ªå‚æ•°</p><ul><li>â€“portï¼šå°±æ˜¯æˆ‘ä»¬å†…éƒ¨çš„ç«¯å£å·</li><li>â€“target-portï¼šå°±æ˜¯æš´éœ²å¤–é¢è®¿é—®çš„ç«¯å£å·</li><li>â€“nameï¼šåç§°</li><li>â€“typeï¼šç±»å‹</li></ul><p>åŒç†ï¼Œæˆ‘ä»¬ä¸€æ ·å¯ä»¥å¯¼å‡ºå¯¹åº”çš„é…ç½®æ–‡ä»¶</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl expose deployment web --port=80 --<span class="hljs-built_in">type</span>=NodePort --target-port=80 --name=web1 -o yaml &gt; web1.yaml</code></pre></div><p>å¾—åˆ°çš„web1.yamlå¦‚ä¸‹æ‰€ç¤º</p><div class="code-wrapper"><pre><code class="hljs bash">apiVersion: v1kind: Servicemetadata:  creationTimestamp: <span class="hljs-string">&quot;2020-11-16T02:26:53Z&quot;</span>  labels:    app: web  managedFields:  - apiVersion: v1    fieldsType: FieldsV1    fieldsV1:      f:metadata:        f:labels:          .: &#123;&#125;          f:app: &#123;&#125;      f:spec:        f:externalTrafficPolicy: &#123;&#125;        f:ports:          .: &#123;&#125;          k:&#123;<span class="hljs-string">&quot;port&quot;</span>:80,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>&#125;:            .: &#123;&#125;            f:port: &#123;&#125;            f:protocol: &#123;&#125;            f:targetPort: &#123;&#125;        f:selector:          .: &#123;&#125;          f:app: &#123;&#125;        f:sessionAffinity: &#123;&#125;        f:<span class="hljs-built_in">type</span>: &#123;&#125;    manager: kubectl    operation: Update    time: <span class="hljs-string">&quot;2020-11-16T02:26:53Z&quot;</span>  name: web2  namespace: default  resourceVersion: <span class="hljs-string">&quot;113693&quot;</span>  selfLink: /api/v1/namespaces/default/services/web2  uid: d570437d-a6b4-4456-8dfb-950f09534516spec:  clusterIP: 10.104.174.145  externalTrafficPolicy: Cluster  ports:  - nodePort: 32639    port: 80    protocol: TCP    targetPort: 80  selector:    app: web  sessionAffinity: None  <span class="hljs-built_in">type</span>: NodePortstatus:  loadBalancer: &#123;&#125;</code></pre></div><p>ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹å¯¹å¤–æš´éœ²çš„æœåŠ¡</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl get pods,svc</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116104021357.png" alt="image-20201116104021357"></p><p>ç„¶åæˆ‘ä»¬è®¿é—®å¯¹åº”çš„urlï¼Œå³å¯çœ‹åˆ° nginxäº† <code>http://192.168.177.130:32639/</code></p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116104131968.png" alt="image-20201116104131968"></p><h2 id="6-å‡çº§å›æ»šå’Œå¼¹æ€§ä¼¸ç¼©"><a href="#6-å‡çº§å›æ»šå’Œå¼¹æ€§ä¼¸ç¼©" class="headerlink" title="6 å‡çº§å›æ»šå’Œå¼¹æ€§ä¼¸ç¼©"></a>6 å‡çº§å›æ»šå’Œå¼¹æ€§ä¼¸ç¼©</h2><ul><li>å‡çº§ï¼š  å‡è®¾ä»ç‰ˆæœ¬ä¸º1.14 å‡çº§åˆ° 1.15 ï¼Œè¿™å°±å«åº”ç”¨çš„å‡çº§ã€å‡çº§å¯ä»¥ä¿è¯æœåŠ¡ä¸ä¸­æ–­ã€‘</li><li>å›æ»šï¼šä»ç‰ˆæœ¬1.15 å˜æˆ 1.14ï¼Œè¿™å°±å«åº”ç”¨çš„å›æ»š</li><li>å¼¹æ€§ä¼¸ç¼©ï¼šæˆ‘ä»¬æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¥æ”¹å˜Podçš„æ•°é‡å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™å°±æ˜¯å¼¹æ€§ä¼¸ç¼©</li></ul><h3 id="åº”ç”¨å‡çº§å’Œå›æ»š"><a href="#åº”ç”¨å‡çº§å’Œå›æ»š" class="headerlink" title="åº”ç”¨å‡çº§å’Œå›æ»š"></a>åº”ç”¨å‡çº§å’Œå›æ»š</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª 1.14ç‰ˆæœ¬çš„Pod</p><div class="code-wrapper"><pre><code class="hljs bash">apiVersion: apps/v1kind: Deploymentmetadata:  creationTimestamp: null  labels:    app: web  name: webspec:  replicas: 1  selector:    matchLabels:      app: web  strategy: &#123;&#125;  template:    metadata:      creationTimestamp: null      labels:        app: web    spec:      containers:      - image: nginx:1.14        name: nginx        resources: &#123;&#125;status: &#123;&#125;</code></pre></div><p>æˆ‘ä»¬å…ˆæŒ‡å®šç‰ˆæœ¬ä¸º1.14ï¼Œç„¶åå¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„Pod</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl apply -f nginx.yaml</code></pre></div><p>åŒæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨docker imageså‘½ä»¤ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æˆåŠŸæ‹‰å–åˆ°äº†ä¸€ä¸ª 1.14ç‰ˆæœ¬çš„é•œåƒ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116105710966.png" alt="image-20201116105710966"></p><p>æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥å°†nginxä» 1.14 å‡çº§åˆ° 1.15</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl <span class="hljs-built_in">set</span> image deployment web nginx=nginx:1.15</code></pre></div><p>åœ¨æˆ‘ä»¬æ‰§è¡Œå®Œå‘½ä»¤åï¼Œèƒ½çœ‹åˆ°å‡çº§çš„è¿‡ç¨‹</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116105847069.png" alt="image-20201116105847069"></p><ul><li>é¦–å…ˆæ˜¯å¼€å§‹çš„nginx 1.14ç‰ˆæœ¬çš„Podåœ¨è¿è¡Œï¼Œç„¶å 1.15ç‰ˆæœ¬çš„åœ¨åˆ›å»º</li><li>ç„¶ååœ¨1.15ç‰ˆæœ¬åˆ›å»ºå®Œæˆåï¼Œå°±ä¼šæš‚åœ1.14ç‰ˆæœ¬</li><li>æœ€åæŠŠ1.14ç‰ˆæœ¬çš„Podç§»é™¤ï¼Œå®Œæˆæˆ‘ä»¬çš„å‡çº§</li></ul><p>æˆ‘ä»¬åœ¨ä¸‹è½½ 1.15ç‰ˆæœ¬ï¼Œå®¹å™¨å°±å¤„äºContainerCreatingçŠ¶æ€ï¼Œç„¶åä¸‹è½½å®Œæˆåï¼Œå°±ç”¨ 1.15ç‰ˆæœ¬å»æ›¿æ¢1.14ç‰ˆæœ¬äº†ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„å°±æ˜¯ï¼šå‡çº§å¯ä»¥ä¿è¯æœåŠ¡ä¸ä¸­æ–­</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116111614085.png" alt="image-20201116111614085"></p><p>æˆ‘ä»¬åˆ°æˆ‘ä»¬çš„node2èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹æˆ‘ä»¬çš„ docker images;</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116111315000.png" alt="image-20201116111315000"></p><p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‹‰å–åˆ°äº† 1.15ç‰ˆæœ¬çš„nginxäº†</p><h4 id="æŸ¥çœ‹å‡çº§çŠ¶æ€"><a href="#æŸ¥çœ‹å‡çº§çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹å‡çº§çŠ¶æ€"></a>æŸ¥çœ‹å‡çº§çŠ¶æ€</h4><p>ä¸‹é¢å¯ä»¥ï¼ŒæŸ¥çœ‹å‡çº§çŠ¶æ€</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl rollout status deployment web</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116112139645.png" alt="image-20201116112139645"></p><h4 id="æŸ¥çœ‹å†å²ç‰ˆæœ¬"><a href="#æŸ¥çœ‹å†å²ç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹å†å²ç‰ˆæœ¬"></a>æŸ¥çœ‹å†å²ç‰ˆæœ¬</h4><p>æˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹å†å²ç‰ˆæœ¬</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl rollout <span class="hljs-built_in">history</span> deployment web</code></pre></div><h4 id="åº”ç”¨å›æ»š"><a href="#åº”ç”¨å›æ»š" class="headerlink" title="åº”ç”¨å›æ»š"></a>åº”ç”¨å›æ»š</h4><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼Œå®Œæˆå›æ»šæ“ä½œï¼Œä¹Ÿå°±æ˜¯å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl rollout undo deployment web</code></pre></div><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æŸ¥çœ‹çŠ¶æ€</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl rollout status deployment web</code></pre></div><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201116112524601.png" alt="image-20201116112524601"></p><p>åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl rollout undo deployment web --to-revision=2</code></pre></div><h3 id="å¼¹æ€§ä¼¸ç¼©"><a href="#å¼¹æ€§ä¼¸ç¼©" class="headerlink" title="å¼¹æ€§ä¼¸ç¼©"></a>å¼¹æ€§ä¼¸ç¼©</h3><p>å¼¹æ€§ä¼¸ç¼©ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡å‘½ä»¤ä¸€ä¸‹åˆ›å»ºå¤šä¸ªå‰¯æœ¬</p><div class="code-wrapper"><pre><code class="hljs bash">kubectl scale deployment web --replicas=10</code></pre></div><p>èƒ½å¤Ÿæ¸…æ™°çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸€ä¸‹åˆ›å»ºäº†10ä¸ªå‰¯æœ¬</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/K8S/9_Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/images/image-20201117092841865.png" alt="image-20201117092841865"></p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Distributed/">Distributed</category>
      
      
      <category domain="https://pncalbl.github.io/tags/k8s/">k8s</category>
      
      
      <comments>https://pncalbl.github.io/2021/07/22/K8s%E5%AD%A6%E4%B9%A0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>JVM å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/</link>
      <guid>https://pncalbl.github.io/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/</guid>
      <pubDate>Mon, 19 Jul 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;ç¬¬ä¸€éƒ¨åˆ†-å†…å­˜ä¸åƒåœ¾å›æ”¶&quot;&gt;&lt;a href=&quot;#ç¬¬ä¸€éƒ¨åˆ†-å†…å­˜ä¸åƒåœ¾å›æ”¶&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬ä¸€éƒ¨åˆ† å†…å­˜ä¸åƒåœ¾å›æ”¶&quot;&gt;&lt;/a&gt;ç¬¬ä¸€éƒ¨åˆ† å†…å­˜ä¸åƒåœ¾å›æ”¶&lt;/h1&gt;&lt;h1 id=&quot;ç¬¬1ç« -JVMä¸Javaä½“ç³»ç»“æ„&quot;&gt;&lt;a href</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="ç¬¬ä¸€éƒ¨åˆ†-å†…å­˜ä¸åƒåœ¾å›æ”¶"><a href="#ç¬¬ä¸€éƒ¨åˆ†-å†…å­˜ä¸åƒåœ¾å›æ”¶" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ† å†…å­˜ä¸åƒåœ¾å›æ”¶"></a>ç¬¬ä¸€éƒ¨åˆ† å†…å­˜ä¸åƒåœ¾å›æ”¶</h1><h1 id="ç¬¬1ç« -JVMä¸Javaä½“ç³»ç»“æ„"><a href="#ç¬¬1ç« -JVMä¸Javaä½“ç³»ç»“æ„" class="headerlink" title="ç¬¬1ç«  JVMä¸Javaä½“ç³»ç»“æ„"></a>ç¬¬1ç«  JVMä¸Javaä½“ç³»ç»“æ„</h1><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1 å‰è¨€"></a>1 å‰è¨€</h2><p>ä½œä¸ºJavaå·¥ç¨‹å¸ˆçš„ä½ æ›¾è¢«ä¼¤å®³è¿‡å—ï¼Ÿä½ æ˜¯å¦ä¹Ÿé‡åˆ°è¿‡è¿™äº›é—®é¢˜ï¼Ÿ</p><p>è¿è¡Œç€çš„çº¿ä¸Šç³»ç»Ÿçªç„¶å¡æ­»ï¼Œç³»ç»Ÿæ— æ³•è®¿é—®ï¼Œç”šè‡³ç›´æ¥OOMMï¼</p><ul><li>æƒ³è§£å†³çº¿ä¸ŠJVM GCé—®é¢˜ï¼Œä½†å´æ— ä»ä¸‹æ‰‹ã€‚</li><li>æ–°é¡¹ç›®ä¸Šçº¿ï¼Œå¯¹å„ç§JVMå‚æ•°è®¾ç½®ä¸€è„¸èŒ«ç„¶ï¼Œç›´æ¥é»˜è®¤å§ç„¶åå°±JJäº†</li><li>æ¯æ¬¡é¢è¯•ä¹‹å‰éƒ½è¦é‡æ–°èƒŒä¸€éJVMçš„ä¸€äº›åŸç†æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œç„¶è€Œé¢è¯•å®˜å´ç»å¸¸é—®ä½ åœ¨å®é™…é¡¹ç›®ä¸­å¦‚ä½•è°ƒä¼˜VMå‚æ•°ï¼Œå¦‚ä½•è§£å†³GCã€OOMç­‰é—®é¢˜ï¼Œä¸€è„¸æ‡µé€¼ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704111417472.png" alt="image-20200704111417472"></p><p>å¤§éƒ¨åˆ†Javaå¼€å‘äººå‘˜ï¼Œé™¤ä¼šåœ¨é¡¹ç›®ä¸­ä½¿ç”¨åˆ°ä¸Javaå¹³å°ç›¸å…³çš„å„ç§é«˜ç²¾å°–æŠ€æœ¯ï¼Œå¯¹äºJavaæŠ€æœ¯çš„æ ¸å¿ƒJavaè™šæ‹Ÿæœºäº†è§£ç”šå°‘ã€‚</p><p>ä¸€äº›æœ‰ä¸€å®šå·¥ä½œç»éªŒçš„å¼€å‘äººå‘˜ï¼Œæ‰“å¿ƒçœ¼å„¿é‡Œè§‰å¾—SSMã€å¾®æœåŠ¡ç­‰ä¸Šå±‚æŠ€æœ¯æ‰æ˜¯é‡ç‚¹ï¼ŒåŸºç¡€æŠ€æœ¯å¹¶ä¸é‡è¦ï¼Œè¿™å…¶å®æ˜¯ä¸€ç§æœ¬æœ«å€’ç½®çš„â€œç—…æ€â€ã€‚å¦‚æœæˆ‘ä»¬æŠŠæ ¸å¿ƒç±»åº“çš„APIæ¯”åšæ•°å­¦å…¬å¼çš„è¯ï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºçš„çŸ¥è¯†å°±å¥½æ¯”å…¬å¼çš„æ¨å¯¼è¿‡ç¨‹ã€‚</p><p>è®¡ç®—æœºç³»ç»Ÿä½“ç³»å¯¹æˆ‘ä»¬æ¥è¯´è¶Šæ¥è¶Šè¿œï¼Œåœ¨ä¸äº†è§£åº•å±‚å®ç°æ–¹å¼çš„å‰æä¸‹ï¼Œé€šè¿‡é«˜çº§è¯­è¨€å¾ˆå®¹æ˜“ç¼–å†™ç¨‹åºä»£ç ã€‚ä½†äº‹å®ä¸Šè®¡ç®—æœºå¹¶ä¸è®¤è¯†é«˜çº§è¯­è¨€</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704112119729.png" alt="image-20200704112119729"></p><h2 id="2-æ¶æ„å¸ˆæ¯å¤©éƒ½åœ¨æ€è€ƒä»€ä¹ˆï¼Ÿ"><a href="#2-æ¶æ„å¸ˆæ¯å¤©éƒ½åœ¨æ€è€ƒä»€ä¹ˆï¼Ÿ" class="headerlink" title="2 æ¶æ„å¸ˆæ¯å¤©éƒ½åœ¨æ€è€ƒä»€ä¹ˆï¼Ÿ"></a>2 æ¶æ„å¸ˆæ¯å¤©éƒ½åœ¨æ€è€ƒä»€ä¹ˆï¼Ÿ</h2><ul><li>åº”è¯¥å¦‚ä½•è®©æˆ‘çš„ç³»ç»Ÿæ›´å¿«ï¼Ÿ</li><li>å¦‚ä½•é¿å…ç³»ç»Ÿå‡ºç°ç“¶é¢ˆï¼Ÿ</li></ul><p>çŸ¥ä¹ä¸Šæœ‰æ¡å¸–å­ï¼šåº”è¯¥å¦‚ä½•çœ‹æ‹›è˜ä¿¡æ¯ï¼Œç›´é€šå¹´è–ª50ä¸‡+ï¼Ÿ</p><ul><li>å‚ä¸ç°æœ‰ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–ï¼Œé‡æ„ï¼Œä¿è¯å¹³å°æ€§èƒ½å’Œç¨³å®šæ€§</li><li>æ ¹æ®ä¸šåŠ¡åœºæ™¯å’Œéœ€æ±‚ï¼Œå†³å®šæŠ€æœ¯æ–¹å‘ï¼ŒåšæŠ€æœ¯é€‰å‹</li><li>èƒ½å¤Ÿç‹¬ç«‹æ¶æ„å’Œè®¾è®¡æµ·é‡æ•°æ®ä¸‹é«˜å¹¶å‘åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆï¼Œæ»¡è¶³åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚</li><li>è§£å†³å„ç±»æ½œåœ¨ç³»ç»Ÿé£é™©ï¼Œæ ¸å¿ƒåŠŸèƒ½çš„æ¶æ„ä¸ä»£ç ç¼–å†™</li><li>åˆ†æç³»ç»Ÿç“¶é¢ˆï¼Œè§£å†³å„ç§ç–‘éš¾æ‚ç—‡ï¼Œæ€§èƒ½è°ƒä¼˜ç­‰</li></ul><h2 id="3-ä¸ºä»€ä¹ˆè¦å­¦ä¹ JVM"><a href="#3-ä¸ºä»€ä¹ˆè¦å­¦ä¹ JVM" class="headerlink" title="3 ä¸ºä»€ä¹ˆè¦å­¦ä¹ JVM"></a>3 ä¸ºä»€ä¹ˆè¦å­¦ä¹ JVM</h2><ul><li><p>é¢è¯•çš„éœ€è¦ï¼ˆBATJã€TMDï¼ŒPKQç­‰é¢è¯•éƒ½çˆ±é—®ï¼‰</p></li><li><p>ä¸­é«˜çº§ç¨‹åºå‘˜å¿…å¤‡æŠ€èƒ½</p><ul><li>é¡¹ç›®ç®¡ç†ã€è°ƒä¼˜çš„éœ€æ±‚</li></ul></li><li><p>è¿½æ±‚æå®¢çš„ç²¾ç¥</p><ul><li>æ¯”å¦‚ï¼šåƒåœ¾å›æ”¶ç®—æ³•ã€JITï¼ˆåŠæ—¶ç¼–è¯‘å™¨ï¼‰ã€åº•å±‚åŸç†</li></ul></li></ul><h2 id="4-Java-vs-C"><a href="#4-Java-vs-C" class="headerlink" title="4 Java vs C++"></a>4 Java vs C++</h2><p>åƒåœ¾æ”¶é›†æœºåˆ¶ä¸ºæˆ‘ä»¬æ‰“ç†äº†å¾ˆå¤šç¹ççš„å·¥ä½œï¼Œå¤§å¤§æé«˜äº†å¼€å‘çš„æ•ˆç‡ï¼Œä½†æ˜¯ï¼Œåƒåœ¾æ”¶é›†ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæ‡‚å¾—JVMå†…éƒ¨çš„å†…å­˜ç»“æ„ã€å·¥ä½œæœºåˆ¶ï¼Œæ˜¯è®¾è®¡é«˜æ‰©å±•æ€§åº”ç”¨å’Œè¯Šæ–­è¿è¡Œæ—¶é—®é¢˜çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯Javaå·¥ç¨‹å¸ˆè¿›é˜¶çš„å¿…å¤‡èƒ½åŠ›ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704112700211.png" alt="image-20200704112700211"></p><p>Cè¯­è¨€éœ€è¦è‡ªå·±æ¥åˆ†é…å†…å­˜å’Œå›æ”¶å†…å­˜ï¼ŒJavaå…¨éƒ¨äº¤ç»™JVMè¿›è¡Œåˆ†é…å’Œå›æ”¶ã€‚</p><h2 id="5-æ¨èä¹¦ç±"><a href="#5-æ¨èä¹¦ç±" class="headerlink" title="5 æ¨èä¹¦ç±"></a>5 æ¨èä¹¦ç±</h2><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704145340513.png" alt="image-20200704145340513"></p><h2 id="6-Javaç”Ÿæ€åœˆ"><a href="#6-Javaç”Ÿæ€åœˆ" class="headerlink" title="6 Javaç”Ÿæ€åœˆ"></a>6 Javaç”Ÿæ€åœˆ</h2><p>Javaæ˜¯ç›®å‰åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„è½¯ä»¶å¼€å‘å¹³å°ä¹‹ä¸€ã€‚éšç€Javaä»¥åŠJavaç¤¾åŒºçš„ä¸æ–­å£®å¤§Java ä¹Ÿæ—©å·²ä¸å†æ˜¯ç®€ç®€å•å•çš„ä¸€é—¨è®¡ç®—æœºè¯­è¨€äº†ï¼Œå®ƒæ›´æ˜¯ä¸€ä¸ªå¹³å°ã€ä¸€ç§æ–‡åŒ–ã€ä¸€ä¸ªç¤¾åŒºã€‚</p><ul><li><p>ä½œä¸ºä¸€ä¸ªå¹³å°ï¼ŒJavaè™šæ‹Ÿæœºæ‰®æ¼”ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨</p><ul><li>Groovyã€Scalaã€JRubyã€Kotlinç­‰éƒ½æ˜¯Javaå¹³å°çš„ä¸€éƒ¨åˆ†</li></ul></li><li><p>ä½œä¸ºç¯ç§æ–‡åŒ–ï¼ŒJavaå‡ ä¹æˆä¸ºäº†â€œå¼€æºâ€çš„ä»£åè¯ã€‚</p><ul><li>ç¬¬ä¸‰æ–¹å¼€æºè½¯ä»¶å’Œæ¡†æ¶ã€‚å¦‚Tomcatã€Strutsï¼ŒMyBatisï¼ŒSpringç­‰ã€‚</li><li>å°±è¿JDKå’ŒJVMè‡ªèº«ä¹Ÿæœ‰ä¸å°‘å¼€æºçš„å®ç°ï¼Œå¦‚openJDKã€Harmonyã€‚</li></ul></li><li><p>ä½œä¸ºä¸€ä¸ªç¤¾åŒºï¼ŒJavaæ‹¥æœ‰å…¨ä¸–ç•Œæœ€å¤šçš„æŠ€æœ¯æ‹¥æŠ¤è€…å’Œå¼€æºç¤¾åŒºæ”¯æŒï¼Œæœ‰æ•°ä¸æ¸…çš„è®ºå›å’Œèµ„æ–™ã€‚ä»æ¡Œé¢åº”ç”¨è½¯ä»¶ã€åµŒå…¥å¼å¼€å‘åˆ°ä¼ä¸šçº§åº”ç”¨ã€åå°æœåŠ¡å™¨ã€ä¸­é—´ä»¶ï¼Œéƒ½å¯ä»¥çœ‹åˆ°Javaçš„èº«å½±ã€‚å…¶åº”ç”¨å½¢å¼ä¹‹å¤æ‚ã€å‚ä¸äººæ•°ä¹‹ä¼—å¤šä¹Ÿä»¤äººå’‹èˆŒã€‚</p></li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704151731216.png" alt="image-20200704151731216"></p><p>æ¯ä¸ªè¯­è¨€éƒ½éœ€è¦è½¬æ¢æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œæœ€åè½¬æ¢çš„å­—èŠ‚ç æ–‡ä»¶éƒ½èƒ½é€šè¿‡Javaè™šæ‹Ÿæœºè¿›è¡Œè¿è¡Œå’Œå¤„ç†</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704152052489.png" alt="image-20200704152052489"></p><p>éšç€Java7çš„æ­£å¼å‘å¸ƒï¼ŒJavaè™šæ‹Ÿæœºçš„è®¾è®¡è€…ä»¬é€šè¿‡JSR-292è§„èŒƒåŸºæœ¬å®ç°åœ¨Javaè™šæ‹Ÿæœºå¹³å°ä¸Šè¿è¡ŒéJavaè¯­è¨€ç¼–å†™çš„ç¨‹åºã€‚</p><p>Javaè™šæ‹Ÿæœºæ ¹æœ¬ä¸å…³å¿ƒè¿è¡Œåœ¨å…¶å†…éƒ¨çš„ç¨‹åºåˆ°åº•æ˜¯ä½¿ç”¨ä½•ç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒåªå…³å¿ƒâ€œå­—èŠ‚ç â€æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´Javaè™šæ‹Ÿæœºæ‹¥æœ‰è¯­è¨€æ— å…³æ€§ï¼Œå¹¶ä¸ä¼šå•çº¯åœ°ä¸Javaè¯­è¨€â€œç»ˆèº«ç»‘å®šâ€ï¼Œåªè¦å…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ç»“æœæ»¡è¶³å¹¶åŒ…å«Javaè™šæ‹Ÿæœºçš„å†…éƒ¨æŒ‡ä»¤é›†ã€ç¬¦å·è¡¨ä»¥åŠå…¶ä»–çš„è¾…åŠ©ä¿¡æ¯ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå°±èƒ½å¤Ÿè¢«è™šæ‹Ÿæœºæ‰€è¯†åˆ«å¹¶è£…è½½è¿è¡Œã€‚</p><h2 id="7-å­—èŠ‚ç "><a href="#7-å­—èŠ‚ç " class="headerlink" title="7 å­—èŠ‚ç "></a>7 å­—èŠ‚ç </h2><p>æˆ‘ä»¬å¹³æ—¶è¯´çš„javaå­—èŠ‚ç ï¼ŒæŒ‡çš„æ˜¯ç”¨javaè¯­è¨€ç¼–è¯‘æˆçš„å­—èŠ‚ç ã€‚å‡†ç¡®çš„è¯´ä»»ä½•èƒ½åœ¨jvmå¹³å°ä¸Šæ‰§è¡Œçš„å­—èŠ‚ç æ ¼å¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥åº”è¯¥ç»Ÿç§°ä¸ºï¼šjvmå­—èŠ‚ç ã€‚</p><p>ä¸åŒçš„ç¼–è¯‘å™¨ï¼Œå¯ä»¥ç¼–è¯‘å‡ºç›¸åŒçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå­—èŠ‚ç æ–‡ä»¶ä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„JVMä¸Šè¿è¡Œã€‚</p><p>Javaè™šæ‹Ÿæœºä¸Javaè¯­è¨€å¹¶æ²¡æœ‰å¿…ç„¶çš„è”ç³»ï¼Œå®ƒåªä¸ç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼â€”Classæ–‡ä»¶æ ¼å¼æ‰€å…³è”ï¼ŒClassæ–‡ä»¶ä¸­åŒ…å«äº†Javaè™šæ‹ŸæœºæŒ‡ä»¤é›†ï¼ˆæˆ–è€…ç§°ä¸ºå­—èŠ‚ç ã€Bytecodesï¼‰å’Œç¬¦å·è¡¨ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–è¾…åŠ©ä¿¡æ¯ã€‚</p><h2 id="8-å¤šè¯­è¨€æ··åˆç¼–ç¨‹"><a href="#8-å¤šè¯­è¨€æ··åˆç¼–ç¨‹" class="headerlink" title="8 å¤šè¯­è¨€æ··åˆç¼–ç¨‹"></a>8 å¤šè¯­è¨€æ··åˆç¼–ç¨‹</h2><p>Javaå¹³å°ä¸Šçš„å¤šè¯­è¨€æ··åˆç¼–ç¨‹æ­£æˆä¸ºä¸»æµï¼Œé€šè¿‡ç‰¹å®šé¢†åŸŸçš„è¯­è¨€å»è§£å†³ç‰¹å®šé¢†åŸŸçš„é—®é¢˜æ˜¯å½“å‰è½¯ä»¶å¼€å‘åº”å¯¹æ—¥è¶‹å¤æ‚çš„é¡¹ç›®éœ€æ±‚çš„ä¸€ä¸ªæ–¹å‘ã€‚</p><p>è¯•æƒ³ä¸€ä¸‹ï¼Œåœ¨ä¸€ä¸ªé¡¹ç›®ä¹‹ä¸­ï¼Œå¹¶è¡Œå¤„ç†ç”¨clojureè¯­è¨€ç¼–å†™ï¼Œå±•ç¤ºå±‚ä½¿ç”¨JRuby/Railsï¼Œä¸­é—´å±‚åˆ™æ˜¯Javaï¼Œæ¯ä¸ªåº”ç”¨å±‚éƒ½å°†ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®Œæˆï¼Œè€Œä¸”ï¼Œæ¥å£å¯¹æ¯ä¸€å±‚çš„å¼€å‘è€…éƒ½æ˜¯é€æ˜çš„ï¼Œå„ç§è¯­è¨€ä¹‹é—´çš„äº¤äº’ä¸å­˜åœ¨ä»»ä½•å›°éš¾ï¼Œå°±åƒä½¿ç”¨è‡ªå·±è¯­è¨€çš„åŸç”ŸAPIä¸€æ ·æ–¹ä¾¿ï¼Œå› ä¸ºå®ƒä»¬æœ€ç»ˆéƒ½è¿è¡Œåœ¨ä¸€ä¸ªè™šæ‹Ÿæœºä¹‹ä¸Šã€‚</p><p>å¯¹è¿™äº›è¿è¡ŒäºJavaè™šæ‹Ÿæœºä¹‹ä¸Šã€Javaä¹‹å¤–çš„è¯­è¨€ï¼Œæ¥è‡ªç³»ç»Ÿçº§çš„ã€åº•å±‚çš„æ”¯æŒæ­£åœ¨è¿…é€Ÿå¢å¼ºï¼Œä»¥JSR-292ä¸ºæ ¸å¿ƒçš„ä¸€ç³»åˆ—é¡¹ç›®å’ŒåŠŸèƒ½æ”¹è¿›ï¼ˆå¦‚Da Vinci Machineé¡¹ç›®ã€Nashornå¼•æ“ã€InvokeDynamicæŒ‡ä»¤ã€java.lang.invokeåŒ…ç­‰ï¼‰ï¼Œæ¨åŠ¨Javaè™šæ‹Ÿæœºä»â€œJavaè¯­è¨€çš„è™šæ‹Ÿæœºâ€å‘ â€œå¤šè¯­è¨€è™šæ‹Ÿæœºâ€çš„æ–¹å‘å‘å±•ã€‚</p><h2 id="9-Javaå‘å±•çš„é‡å¤§äº‹ä»¶"><a href="#9-Javaå‘å±•çš„é‡å¤§äº‹ä»¶" class="headerlink" title="9 Javaå‘å±•çš„é‡å¤§äº‹ä»¶"></a>9 Javaå‘å±•çš„é‡å¤§äº‹ä»¶</h2><ul><li><p>1990å¹´ï¼Œåœ¨Sunè®¡ç®—æœºå…¬å¸ä¸­ï¼Œç”±Patrick Naughtonã€MikeSheridanåŠJames Goslingé¢†å¯¼çš„å°ç»„Green Teamï¼Œå¼€å‘å‡ºçš„æ–°çš„ç¨‹åºè¯­è¨€ï¼Œå‘½åä¸ºoakï¼ŒåæœŸå‘½åä¸ºJava</p></li><li><p>1995å¹´ï¼ŒSunæ­£å¼å‘å¸ƒJavaå’ŒHotJavaäº§å“ï¼ŒJavaé¦–æ¬¡å…¬å¼€äº®ç›¸ã€‚</p></li><li><p>1996å¹´1æœˆ23æ—¥sun Microsystemså‘å¸ƒäº†JDK 1.0ã€‚</p></li><li><p>1998å¹´ï¼ŒJDK1.2ç‰ˆæœ¬å‘å¸ƒã€‚åŒæ—¶ï¼Œsunå‘å¸ƒäº†JSP/Servletã€EJBè§„èŒƒï¼Œä»¥åŠå°†Javaåˆ†æˆäº†J2EEã€J2SEå’ŒJ2MEã€‚è¿™è¡¨æ˜äº†Javaå¼€å§‹å‘ä¼ä¸šã€æ¡Œé¢åº”ç”¨å’Œç§»åŠ¨è®¾å¤‡åº”ç”¨3å¤§é¢†åŸŸæŒºè¿›ã€‚</p></li><li><p>2000å¹´ï¼ŒJDK1.3å‘å¸ƒï¼ŒJava HotSpot Virtual Machineæ­£å¼å‘å¸ƒï¼Œæˆä¸ºJavaçš„é»˜è®¤è™šæ‹Ÿæœºã€‚</p></li><li><p>2002å¹´ï¼ŒJDK1.4å‘å¸ƒï¼Œå¤è€çš„Classicè™šæ‹Ÿæœºé€€å‡ºå†å²èˆå°ã€‚</p></li><li><p>2003å¹´å¹´åº•ï¼ŒJavaå¹³å°çš„scalaæ­£å¼å‘å¸ƒï¼ŒåŒå¹´Groovyä¹ŸåŠ å…¥äº†Javaé˜µè¥ã€‚</p></li><li><p>2004å¹´ï¼ŒJDK1.5å‘å¸ƒã€‚åŒæ—¶JDK1.5æ”¹åä¸ºJavaSE5.0ã€‚</p></li><li><p>2006å¹´ï¼ŒJDK6å‘å¸ƒã€‚åŒå¹´ï¼ŒJavaå¼€æºå¹¶å»ºç«‹äº†openJDKã€‚é¡ºç†æˆç« ï¼ŒHotspotè™šæ‹Ÿæœºä¹Ÿæˆä¸ºäº†openJDKä¸­çš„é»˜è®¤è™šæ‹Ÿæœºã€‚</p></li><li><p>2007å¹´ï¼ŒJavaå¹³å°è¿æ¥äº†æ–°ä¼™ä¼´Clojureã€‚</p></li><li><p>2008å¹´ï¼Œoracleæ”¶è´­äº†BEAï¼Œå¾—åˆ°äº†JRockitè™šæ‹Ÿæœºã€‚</p></li><li><p>2009å¹´ï¼ŒTwitterå®£å¸ƒæŠŠåå°å¤§éƒ¨åˆ†ç¨‹åºä»Rubyè¿ç§»åˆ°scalaï¼Œè¿™æ˜¯Javaå¹³å°çš„åˆä¸€æ¬¡å¤§è§„æ¨¡åº”ç”¨ã€‚</p></li><li><p>2010å¹´ï¼Œoracleæ”¶è´­äº†sunï¼Œè·å¾—Javaå•†æ ‡å’Œæœ€çœŸä»·å€¼çš„HotSpotè™šæ‹Ÿæœºã€‚æ­¤æ—¶ï¼Œoracleæ‹¥æœ‰å¸‚åœºå ç”¨ç‡æœ€é«˜çš„ä¸¤æ¬¾è™šæ‹ŸæœºHotSpotå’ŒJRockitï¼Œå¹¶è®¡åˆ’åœ¨æœªæ¥å¯¹å®ƒä»¬è¿›è¡Œæ•´åˆï¼šHotRockit</p></li><li><p>2011å¹´ï¼ŒJDK7å‘å¸ƒã€‚åœ¨JDK1.7u4ä¸­ï¼Œæ­£å¼å¯ç”¨äº†æ–°çš„åƒåœ¾å›æ”¶å™¨G1ã€‚</p></li><li><p>2017å¹´ï¼ŒJDK9å‘å¸ƒã€‚å°†G1è®¾ç½®ä¸ºé»˜è®¤Gcï¼Œæ›¿ä»£CMS</p></li><li><p>åŒå¹´ï¼ŒIBMçš„J9å¼€æºï¼Œå½¢æˆäº†ç°åœ¨çš„open J9ç¤¾åŒº</p></li><li><p>2018å¹´ï¼ŒAndroidçš„Javaä¾µæƒæ¡ˆåˆ¤å†³ï¼ŒGoogleèµ”å¿oracleè®¡88äº¿ç¾å…ƒ</p></li><li><p>åŒå¹´ï¼Œoracleå®£å‘ŠJavagEæˆä¸ºå†å²åè¯JDBCã€JMSã€Servletèµ äºˆEclipseåŸºé‡‘ä¼š</p></li><li><p>åŒå¹´ï¼ŒJDK11å‘å¸ƒï¼ŒLTSç‰ˆæœ¬çš„JDKï¼Œå‘å¸ƒé©å‘½æ€§çš„zGcï¼Œè°ƒæ•´JDKæˆæƒè®¸å¯</p></li><li><p>2019å¹´ï¼ŒJDK12å‘å¸ƒï¼ŒåŠ å…¥RedHaté¢†å¯¼å¼€å‘çš„shenandoah GC</p></li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704182035810.png" alt="image-20200704182035810"></p><p>åœ¨JDK11ä¹‹å‰ï¼ŒoracleJDKä¸­è¿˜ä¼šå­˜åœ¨ä¸€äº›openJDKä¸­æ²¡æœ‰çš„ã€é—­æºçš„åŠŸèƒ½ã€‚ä½†åœ¨JDK11ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºopenJDKå’ŒoracleJDKä»£ç å®è´¨ä¸Šå·²ç»å®Œå…¨ä¸€è‡´çš„ç¨‹åº¦ã€‚</p><h2 id="10-è™šæ‹Ÿæœºä¸Javaè™šæ‹Ÿæœº"><a href="#10-è™šæ‹Ÿæœºä¸Javaè™šæ‹Ÿæœº" class="headerlink" title="10 è™šæ‹Ÿæœºä¸Javaè™šæ‹Ÿæœº"></a>10 è™šæ‹Ÿæœºä¸Javaè™šæ‹Ÿæœº</h2><h3 id="10-1-è™šæ‹Ÿæœº"><a href="#10-1-è™šæ‹Ÿæœº" class="headerlink" title="10.1 è™šæ‹Ÿæœº"></a>10.1 è™šæ‹Ÿæœº</h3><p>æ‰€è°“è™šæ‹Ÿæœºï¼ˆVirtual Machineï¼‰ï¼Œå°±æ˜¯ä¸€å°è™šæ‹Ÿçš„è®¡ç®—æœºã€‚å®ƒæ˜¯ä¸€æ¬¾è½¯ä»¶ï¼Œç”¨æ¥æ‰§è¡Œä¸€ç³»åˆ—è™šæ‹Ÿè®¡ç®—æœºæŒ‡ä»¤ã€‚å¤§ä½“ä¸Šï¼Œè™šæ‹Ÿæœºå¯ä»¥åˆ†ä¸ºç³»ç»Ÿè™šæ‹Ÿæœºå’Œç¨‹åºè™šæ‹Ÿæœºã€‚</p><ul><li>å¤§åé¼é¼çš„Visual Boxï¼ŒMwareå°±å±äºç³»ç»Ÿè™šæ‹Ÿæœºï¼Œå®ƒä»¬å®Œå…¨æ˜¯å¯¹ç‰©ç†è®¡ç®—æœºçš„ä»¿çœŸï¼Œæä¾›äº†ä¸€ä¸ªå¯è¿è¡Œå®Œæ•´æ“ä½œç³»ç»Ÿçš„è½¯ä»¶å¹³å°ã€‚</li><li>ç¨‹åºè™šæ‹Ÿæœºçš„å…¸å‹ä»£è¡¨å°±æ˜¯Javaè™šæ‹Ÿæœºï¼Œå®ƒä¸“é—¨ä¸ºæ‰§è¡Œå•ä¸ªè®¡ç®—æœºç¨‹åºè€Œè®¾è®¡ï¼Œåœ¨Javaè™šæ‹Ÿæœºä¸­æ‰§è¡Œçš„æŒ‡ä»¤æˆ‘ä»¬ç§°ä¸ºJavaå­—èŠ‚ç æŒ‡ä»¤ã€‚</li></ul><p>æ— è®ºæ˜¯ç³»ç»Ÿè™šæ‹Ÿæœºè¿˜æ˜¯ç¨‹åºè™šæ‹Ÿæœºï¼Œåœ¨ä¸Šé¢è¿è¡Œçš„è½¯ä»¶éƒ½è¢«é™åˆ¶äºè™šæ‹Ÿæœºæä¾›çš„èµ„æºä¸­ã€‚</p><h3 id="10-2-Javaè™šæ‹Ÿæœº"><a href="#10-2-Javaè™šæ‹Ÿæœº" class="headerlink" title="10.2 Javaè™šæ‹Ÿæœº"></a>10.2 Javaè™šæ‹Ÿæœº</h3><p>Javaè™šæ‹Ÿæœºæ˜¯ä¸€å°æ‰§è¡ŒJavaå­—èŠ‚ç çš„è™šæ‹Ÿè®¡ç®—æœºï¼Œå®ƒæ‹¥æœ‰ç‹¬ç«‹çš„è¿è¡Œæœºåˆ¶ï¼Œå…¶è¿è¡Œçš„Javaå­—èŠ‚ç ä¹Ÿæœªå¿…ç”±Javaè¯­è¨€ç¼–è¯‘è€Œæˆã€‚</p><p>JVMå¹³å°çš„å„ç§è¯­è¨€å¯ä»¥å…±äº«Javaè™šæ‹Ÿæœºå¸¦æ¥çš„è·¨å¹³å°æ€§ã€ä¼˜ç§€çš„åƒåœ¾å›å™¨ï¼Œä»¥åŠå¯é çš„å³æ—¶ç¼–è¯‘å™¨ã€‚</p><p>JavaæŠ€æœ¯çš„æ ¸å¿ƒå°±æ˜¯Javaè™šæ‹Ÿæœºï¼ˆJVMï¼ŒJava Virtual Machineï¼‰ï¼Œå› ä¸ºæ‰€æœ‰çš„Javaç¨‹åºéƒ½è¿è¡Œåœ¨Javaè™šæ‹Ÿæœºå†…éƒ¨ã€‚</p><p>Javaè™šæ‹Ÿæœºå°±æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç çš„è¿è¡Œç¯å¢ƒï¼Œè´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œè§£é‡Š/ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚æ¯ä¸€æ¡JavaæŒ‡ä»¤ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒä¸­éƒ½æœ‰è¯¦ç»†å®šä¹‰ï¼Œå¦‚æ€ä¹ˆå–æ“ä½œæ•°ï¼Œæ€ä¹ˆå¤„ç†æ“ä½œæ•°ï¼Œå¤„ç†ç»“æœæ”¾åœ¨å“ªé‡Œã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ</li><li>è‡ªåŠ¨å†…å­˜ç®¡ç†</li><li>è‡ªåŠ¨åƒåœ¾å›æ”¶åŠŸèƒ½</li></ul><h2 id="11-JVMçš„ä½ç½®"><a href="#11-JVMçš„ä½ç½®" class="headerlink" title="11 JVMçš„ä½ç½®"></a>11 JVMçš„ä½ç½®</h2><p>JVMæ˜¯è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šçš„ï¼Œå®ƒä¸ç¡¬ä»¶æ²¡æœ‰ç›´æ¥çš„äº¤äº’</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704183048061.png" alt="image-20200704183048061"></p><p>Javaçš„ä½“ç³»ç»“æ„</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704183236169.png" alt="image-20200704183236169"></p><h2 id="12-JVMæ•´ä½“ç»“æ„"><a href="#12-JVMæ•´ä½“ç»“æ„" class="headerlink" title="12 JVMæ•´ä½“ç»“æ„"></a>12 JVMæ•´ä½“ç»“æ„</h2><ul><li>HotSpot VMæ˜¯ç›®å‰å¸‚é¢ä¸Šé«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ä»£è¡¨ä½œä¹‹ä¸€ã€‚</li><li>å®ƒé‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ã€‚</li><li>åœ¨ä»Šå¤©ï¼ŒJavaç¨‹åºçš„è¿è¡Œæ€§èƒ½æ—©å·²è„±èƒæ¢éª¨ï¼Œå·²ç»è¾¾åˆ°äº†å¯ä»¥å’ŒC/C++ç¨‹åºä¸€è¾ƒé«˜ä¸‹çš„åœ°æ­¥ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704183436495.png" alt="image-20200704183436495"></p><p>æ‰§è¡Œå¼•æ“åŒ…å«ä¸‰éƒ¨åˆ†ï¼šè§£é‡Šå™¨ï¼ŒåŠæ—¶ç¼–è¯‘å™¨ï¼Œåƒåœ¾å›æ”¶å™¨</p><h2 id="13-Javaä»£ç æ‰§è¡Œæµç¨‹"><a href="#13-Javaä»£ç æ‰§è¡Œæµç¨‹" class="headerlink" title="13 Javaä»£ç æ‰§è¡Œæµç¨‹"></a>13 Javaä»£ç æ‰§è¡Œæµç¨‹</h2><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200704210429535.png" alt="image-20200704210429535"></p><p>åªæ˜¯èƒ½ç”Ÿæˆè¢«Javaè™šæ‹Ÿæœºæ‰€èƒ½è§£é‡Šçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£ä¹ˆç†è®ºä¸Šå°±å¯ä»¥è‡ªå·±è®¾è®¡ä¸€å¥—ä»£ç äº†</p><h2 id="14-JVMçš„æ¶æ„æ¨¡å‹"><a href="#14-JVMçš„æ¶æ„æ¨¡å‹" class="headerlink" title="14 JVMçš„æ¶æ„æ¨¡å‹"></a>14 JVMçš„æ¶æ„æ¨¡å‹</h2><p>Javaç¼–è¯‘å™¨è¾“å…¥çš„æŒ‡ä»¤æµåŸºæœ¬ä¸Šæ˜¯ä¸€ç§åŸºäºæ ˆçš„æŒ‡ä»¤é›†æ¶æ„ï¼Œå¦å¤–ä¸€ç§æŒ‡ä»¤é›†æ¶æ„åˆ™æ˜¯åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†æ¶æ„ã€‚å…·ä½“æ¥è¯´ï¼šè¿™ä¸¤ç§æ¶æ„ä¹‹é—´çš„åŒºåˆ«ï¼š</p><p>åŸºäºæ ˆå¼æ¶æ„çš„ç‰¹ç‚¹</p><ul><li>è®¾è®¡å’Œå®ç°æ›´ç®€å•ï¼Œé€‚ç”¨äºèµ„æºå—é™çš„ç³»ç»Ÿï¼›</li><li>é¿å¼€äº†å¯„å­˜å™¨çš„åˆ†é…éš¾é¢˜ï¼šä½¿ç”¨é›¶åœ°å€æŒ‡ä»¤æ–¹å¼åˆ†é…ã€‚</li><li>æŒ‡ä»¤æµä¸­çš„æŒ‡ä»¤å¤§éƒ¨åˆ†æ˜¯é›¶åœ°å€æŒ‡ä»¤ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ä¾èµ–äºæ“ä½œæ ˆã€‚æŒ‡ä»¤é›†æ›´å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°ã€‚</li><li>ä¸éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œå¯ç§»æ¤æ€§æ›´å¥½ï¼Œæ›´å¥½å®ç°è·¨å¹³å°</li></ul><p>åŸºäºå¯„å­˜å™¨æ¶æ„çš„ç‰¹ç‚¹</p><ul><li>å…¸å‹çš„åº”ç”¨æ˜¯x86çš„äºŒè¿›åˆ¶æŒ‡ä»¤é›†ï¼šæ¯”å¦‚ä¼ ç»Ÿçš„PCä»¥åŠAndroidçš„Davlikè™šæ‹Ÿæœºã€‚</li><li>æŒ‡ä»¤é›†æ¶æ„åˆ™å®Œå…¨ä¾èµ–ç¡¬ä»¶ï¼Œå¯ç§»æ¤æ€§å·®</li><li>æ€§èƒ½ä¼˜ç§€å’Œæ‰§è¡Œæ›´é«˜æ•ˆ</li><li>èŠ±è´¹æ›´å°‘çš„æŒ‡ä»¤å»å®Œæˆä¸€é¡¹æ“ä½œã€‚</li><li>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŸºäºå¯„å­˜å™¨æ¶æ„çš„æŒ‡ä»¤é›†å¾€å¾€éƒ½ä»¥ä¸€åœ°å€æŒ‡ä»¤ã€äºŒåœ°å€æŒ‡ä»¤å’Œä¸‰åœ°å€æŒ‡ä»¤ä¸ºä¸»ï¼Œè€ŒåŸºäºæ ˆå¼æ¶æ„çš„æŒ‡ä»¤é›†å´æ˜¯ä»¥é›¶åœ°å€æŒ‡ä»¤ä¸ºä¸»æ–¹æ°´æ´‹</li></ul><h3 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>åŒæ ·æ‰§è¡Œ2+3è¿™ç§é€»è¾‘æ“ä½œï¼Œå…¶æŒ‡ä»¤åˆ†åˆ«å¦‚ä¸‹ï¼š</p><p>åŸºäºæ ˆçš„è®¡ç®—æµç¨‹ï¼ˆä»¥Javaè™šæ‹Ÿæœºä¸ºä¾‹ï¼‰ï¼š</p><div class="code-wrapper"><pre><code class="hljs bash">iconst_2 //å¸¸é‡2å…¥æ ˆistore_1iconst_3 // å¸¸é‡3å…¥æ ˆistore_2iload_1iload_2iadd //å¸¸é‡2/3å‡ºæ ˆï¼Œæ‰§è¡Œç›¸åŠ istore_0 // ç»“æœ5å…¥æ ˆ</code></pre></div><p>è€ŒåŸºäºå¯„å­˜å™¨çš„è®¡ç®—æµç¨‹</p><div class="code-wrapper"><pre><code class="hljs bash">mov eax,2 //å°†eaxå¯„å­˜å™¨çš„å€¼è®¾ä¸º1add eax,3 //ä½¿eaxå¯„å­˜å™¨çš„å€¼åŠ 3</code></pre></div><h3 id="å­—èŠ‚ç åç¼–è¯‘"><a href="#å­—èŠ‚ç åç¼–è¯‘" class="headerlink" title="å­—èŠ‚ç åç¼–è¯‘"></a>å­—èŠ‚ç åç¼–è¯‘</h3><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œç„¶åæŸ¥çœ‹ä¸€ä¸‹å­—èŠ‚ç çš„åç¼–è¯‘åçš„ç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> pncalbl</span><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/7/20 21:31</span><span class="hljs-comment"> * <span class="hljs-doctag">@e</span>-mail pncalbl@qq.com</span><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><span class="hljs-comment"> **/</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackStruTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>;    &#125;&#125;</code></pre></div><p>ç„¶åæˆ‘ä»¬æ‰¾åˆ°ç¼–è¯‘åçš„ classæ–‡ä»¶ï¼Œä½¿ç”¨ä¸‹åˆ—å‘½ä»¤è¿›è¡Œåç¼–è¯‘</p><div class="code-wrapper"><pre><code class="hljs bash">javap -v StackStruTest.class</code></pre></div><p>å¾—åˆ°çš„æ–‡ä»¶ä¸º:</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">public</span> static void main(java.lang.String[]);  <span class="hljs-attribute">descriptor</span>: ([Ljava/lang/String;)V  <span class="hljs-attribute">flags</span>: ACC_PUBLIC, ACC_STATIC  <span class="hljs-attribute">Code</span>:    <span class="hljs-attribute">stack</span>=<span class="hljs-number">2</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span>       <span class="hljs-attribute">0</span>: iconst_<span class="hljs-number">2</span>       <span class="hljs-attribute">1</span>: istore_<span class="hljs-number">1</span>       <span class="hljs-attribute">2</span>: iconst_<span class="hljs-number">3</span>       <span class="hljs-attribute">3</span>: istore_<span class="hljs-number">2</span>       <span class="hljs-attribute">4</span>: iload_<span class="hljs-number">1</span>       <span class="hljs-attribute">5</span>: iload_<span class="hljs-number">2</span>       <span class="hljs-attribute">6</span>: iadd       <span class="hljs-attribute">7</span>: istore_<span class="hljs-number">3</span>       <span class="hljs-attribute">8</span>: return    <span class="hljs-attribute">LineNumberTable</span>:      <span class="hljs-attribute">line</span> <span class="hljs-number">9</span>: <span class="hljs-number">0</span>      <span class="hljs-attribute">line</span> <span class="hljs-number">10</span>: <span class="hljs-number">2</span>      <span class="hljs-attribute">line</span> <span class="hljs-number">11</span>: <span class="hljs-number">4</span>      <span class="hljs-attribute">line</span> <span class="hljs-number">12</span>: <span class="hljs-number">8</span>    <span class="hljs-attribute">LocalVariableTable</span>:      <span class="hljs-attribute">Start</span>  Length  Slot  Name   Signature          <span class="hljs-attribute">0</span>       <span class="hljs-number">9</span>     <span class="hljs-number">0</span>  args  <span class="hljs-meta"> [Ljava/lang/String;</span><span class="hljs-meta">          2       7     1     i   I</span><span class="hljs-meta">          4       5     2     j   I</span><span class="hljs-meta">          8       1     3     k   I</span></code></pre></div><h2 id="15-æ€»ç»“"><a href="#15-æ€»ç»“" class="headerlink" title="15 æ€»ç»“"></a>15 æ€»ç»“</h2><p>ç”±äºè·¨å¹³å°æ€§çš„è®¾è®¡ï¼ŒJavaçš„æŒ‡ä»¤éƒ½æ˜¯æ ¹æ®æ ˆæ¥è®¾è®¡çš„ã€‚ä¸åŒå¹³å°CPUæ¶æ„ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½è®¾è®¡ä¸ºåŸºäºå¯„å­˜å™¨çš„ã€‚ä¼˜ç‚¹æ˜¯è·¨å¹³å°ï¼ŒæŒ‡ä»¤é›†å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°ï¼Œç¼ºç‚¹æ˜¯æ€§èƒ½ä¸‹é™ï¼Œå®ç°åŒæ ·çš„åŠŸèƒ½éœ€è¦æ›´å¤šçš„æŒ‡ä»¤ã€‚</p><p>æ—¶è‡³ä»Šæ—¥ï¼Œå°½ç®¡åµŒå…¥å¼å¹³å°å·²ç»ä¸æ˜¯Javaç¨‹åºçš„ä¸»æµè¿è¡Œå¹³å°äº†ï¼ˆå‡†ç¡®æ¥è¯´åº”è¯¥æ˜¯HotSpotVMçš„å®¿ä¸»ç¯å¢ƒå·²ç»ä¸å±€é™äºåµŒå…¥å¼å¹³å°äº†ï¼‰ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸å°†æ¶æ„æ›´æ¢ä¸ºåŸºäºå¯„å­˜å™¨çš„æ¶æ„å‘¢ï¼Ÿ</p><h3 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h3><ul><li>è·¨å¹³å°æ€§</li><li>æŒ‡ä»¤é›†å°</li><li>æŒ‡ä»¤å¤š</li><li>æ‰§è¡Œæ€§èƒ½æ¯”å¯„å­˜å™¨å·®</li></ul><h2 id="16-JVMç”Ÿå‘½å‘¨æœŸ"><a href="#16-JVMç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="16 JVMç”Ÿå‘½å‘¨æœŸ"></a>16 JVMç”Ÿå‘½å‘¨æœŸ</h2><h3 id="è™šæ‹Ÿæœºçš„å¯åŠ¨"><a href="#è™šæ‹Ÿæœºçš„å¯åŠ¨" class="headerlink" title="è™šæ‹Ÿæœºçš„å¯åŠ¨"></a>è™šæ‹Ÿæœºçš„å¯åŠ¨</h3><p>Javaè™šæ‹Ÿæœºçš„å¯åŠ¨æ˜¯é€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆbootstrap class loaderï¼‰åˆ›å»ºä¸€ä¸ªåˆå§‹ç±»ï¼ˆinitial classï¼‰æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªç±»æ˜¯ç”±è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æŒ‡å®šçš„ã€‚</p><h3 id="è™šæ‹Ÿæœºçš„æ‰§è¡Œ"><a href="#è™šæ‹Ÿæœºçš„æ‰§è¡Œ" class="headerlink" title="è™šæ‹Ÿæœºçš„æ‰§è¡Œ"></a>è™šæ‹Ÿæœºçš„æ‰§è¡Œ</h3><ul><li>ä¸€ä¸ªè¿è¡Œä¸­çš„Javaè™šæ‹Ÿæœºæœ‰ç€ä¸€ä¸ªæ¸…æ™°çš„ä»»åŠ¡ï¼šæ‰§è¡ŒJavaç¨‹åºã€‚</li><li>ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ä»–æ‰è¿è¡Œï¼Œç¨‹åºç»“æŸæ—¶ä»–å°±åœæ­¢ã€‚</li><li>æ‰§è¡Œä¸€ä¸ªæ‰€è°“çš„Javaç¨‹åºçš„æ—¶å€™ï¼ŒçœŸçœŸæ­£æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªå«åšJavaè™šæ‹Ÿæœºçš„è¿›ç¨‹ã€‚</li></ul><h3 id="è™šæ‹Ÿæœºçš„é€€å‡º"><a href="#è™šæ‹Ÿæœºçš„é€€å‡º" class="headerlink" title="è™šæ‹Ÿæœºçš„é€€å‡º"></a>è™šæ‹Ÿæœºçš„é€€å‡º</h3><p>æœ‰å¦‚ä¸‹çš„å‡ ç§æƒ…å†µï¼š</p><ul><li><p>ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ</p></li><li><p>ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢</p></li><li><p>ç”±äºæ“ä½œç³»ç»Ÿç”¨ç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢</p></li><li><p>æŸçº¿ç¨‹è°ƒç”¨Runtimeç±»æˆ–systemç±»çš„exitæ–¹æ³•ï¼Œæˆ–Runtimeç±»çš„haltæ–¹æ³•ï¼Œå¹¶ä¸”Javaå®‰å…¨ç®¡ç†å™¨ä¹Ÿå…è®¸è¿™æ¬¡exitæˆ–haltæ“ä½œã€‚</p></li><li><p>é™¤æ­¤ä¹‹å¤–ï¼ŒJNIï¼ˆJava Native Interfaceï¼‰è§„èŒƒæè¿°äº†ç”¨JNI Invocation APIæ¥åŠ è½½æˆ–å¸è½½ Javaè™šæ‹Ÿæœºæ—¶ï¼ŒJavaè™šæ‹Ÿæœºçš„é€€å‡ºæƒ…å†µã€‚</p></li></ul><h2 id="17-JVMå‘å±•å†ç¨‹"><a href="#17-JVMå‘å±•å†ç¨‹" class="headerlink" title="17 JVMå‘å±•å†ç¨‹"></a>17 JVMå‘å±•å†ç¨‹</h2><h3 id="Sun-Classic-VM"><a href="#Sun-Classic-VM" class="headerlink" title="Sun Classic VM"></a>Sun Classic VM</h3><ul><li>æ—©åœ¨1996å¹´Java1.0ç‰ˆæœ¬çš„æ—¶å€™ï¼ŒSunå…¬å¸å‘å¸ƒäº†ä¸€æ¬¾åä¸ºsun classic VMçš„Javaè™šæ‹Ÿæœºï¼Œå®ƒåŒæ—¶ä¹Ÿæ˜¯ä¸–ç•Œä¸Šç¬¬ä¸€æ¬¾å•†ç”¨Javaè™šæ‹Ÿæœºï¼ŒJDK1.4æ—¶å®Œå…¨è¢«æ·˜æ±°ã€‚</li><li>è¿™æ¬¾è™šæ‹Ÿæœºå†…éƒ¨åªæä¾›è§£é‡Šå™¨ã€‚ç°åœ¨è¿˜æœ‰åŠæ—¶ç¼–è¯‘å™¨ï¼Œå› æ­¤æ•ˆç‡æ¯”è¾ƒä½ï¼Œè€ŒåŠæ—¶ç¼–è¯‘å™¨ä¼šæŠŠçƒ­ç‚¹ä»£ç ç¼“å­˜èµ·æ¥ï¼Œé‚£ä¹ˆä»¥åä½¿ç”¨çƒ­ç‚¹ä»£ç çš„æ—¶å€™ï¼Œæ•ˆç‡å°±æ¯”è¾ƒé«˜ã€‚</li><li>å¦‚æœä½¿ç”¨JITç¼–è¯‘å™¨ï¼Œå°±éœ€è¦è¿›è¡Œå¤–æŒ‚ã€‚ä½†æ˜¯ä¸€æ—¦ä½¿ç”¨äº†JITç¼–è¯‘å™¨ï¼ŒJITå°±ä¼šæ¥ç®¡è™šæ‹Ÿæœºçš„æ‰§è¡Œç³»ç»Ÿã€‚è§£é‡Šå™¨å°±ä¸å†å·¥ä½œã€‚è§£é‡Šå™¨å’Œç¼–è¯‘å™¨ä¸èƒ½é…åˆå·¥ä½œã€‚</li><li>ç°åœ¨hotspotå†…ç½®äº†æ­¤è™šæ‹Ÿæœºã€‚</li></ul><h3 id="Exact-VM"><a href="#Exact-VM" class="headerlink" title="Exact VM"></a>Exact VM</h3><p>ä¸ºäº†è§£å†³ä¸Šä¸€ä¸ªè™šæ‹Ÿæœºé—®é¢˜ï¼Œjdk1.2æ—¶ï¼Œsunæä¾›äº†æ­¤è™šæ‹Ÿæœºã€‚<br>Exact Memory Managementï¼šå‡†ç¡®å¼å†…å­˜ç®¡ç†</p><ul><li>ä¹Ÿå¯ä»¥å«Non-Conservative/Accurate Memory Management</li><li>è™šæ‹Ÿæœºå¯ä»¥çŸ¥é“å†…å­˜ä¸­æŸä¸ªä½ç½®çš„æ•°æ®å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹ã€‚|</li></ul><p>å…·å¤‡ç°ä»£é«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ç»´å½¢</p><ul><li>çƒ­ç‚¹æ¢æµ‹ï¼ˆå¯»æ‰¾å‡ºçƒ­ç‚¹ä»£ç è¿›è¡Œç¼“å­˜ï¼‰</li><li>ç¼–è¯‘å™¨ä¸è§£é‡Šå™¨æ··åˆå·¥ä½œæ¨¡å¼</li></ul><p>åªåœ¨solariså¹³å°çŸ­æš‚ä½¿ç”¨ï¼Œå…¶ä»–å¹³å°ä¸Šè¿˜æ˜¯classic vmï¼Œè‹±é›„æ°”çŸ­ï¼Œç»ˆè¢«Hotspotè™šæ‹Ÿæœºæ›¿æ¢</p><h3 id="HotSpot-VM"><a href="#HotSpot-VM" class="headerlink" title="HotSpot VM"></a>HotSpot VM</h3><p>HotSpotå†å²</p><ul><li>æœ€åˆç”±ä¸€å®¶åä¸ºâ€œLongview Technologiesâ€çš„å°å…¬å¸è®¾è®¡</li><li>1997å¹´ï¼Œæ­¤å…¬å¸è¢«sunæ”¶è´­ï¼›2009å¹´ï¼ŒSunå…¬å¸è¢«ç”²éª¨æ–‡æ”¶è´­ã€‚</li><li>JDK1.3æ—¶ï¼ŒHotSpot VMæˆä¸ºé»˜è®¤è™šæ‹Ÿæœº</li></ul><p>ç›®å‰Hotspotå æœ‰ç»å¯¹çš„å¸‚åœºåœ°ä½ï¼Œç§°éœ¸æ­¦æ—ã€‚</p><ul><li>ä¸ç®¡æ˜¯ç°åœ¨ä»åœ¨å¹¿æ³›ä½¿ç”¨çš„JDK6ï¼Œè¿˜æ˜¯ä½¿ç”¨æ¯”ä¾‹è¾ƒå¤šçš„JDK8ä¸­ï¼Œé»˜è®¤çš„è™šæ‹Ÿæœºéƒ½æ˜¯HotSpot</li><li>Sun/oracle JDKå’ŒopenJDKçš„é»˜è®¤è™šæ‹Ÿæœº</li><li>å› æ­¤æœ¬è¯¾ç¨‹ä¸­é»˜è®¤ä»‹ç»çš„è™šæ‹Ÿæœºéƒ½æ˜¯HotSpotï¼Œç›¸å…³æœºåˆ¶ä¹Ÿä¸»è¦æ˜¯æŒ‡HotSpotçš„Gcæœºåˆ¶ã€‚ï¼ˆæ¯”å¦‚å…¶ä»–ä¸¤ä¸ªå•†ç”¨è™šæœºéƒ½æ²¡æœ‰æ–¹æ³•åŒºçš„æ¦‚å¿µï¼‰</li></ul><p>ä»æœåŠ¡å™¨ã€æ¡Œé¢åˆ°ç§»åŠ¨ç«¯ã€åµŒå…¥å¼éƒ½æœ‰åº”ç”¨ã€‚</p><p>åç§°ä¸­çš„HotSpotæŒ‡çš„å°±æ˜¯å®ƒçš„çƒ­ç‚¹ä»£ç æ¢æµ‹æŠ€æœ¯ã€‚</p><ul><li>é€šè¿‡è®¡æ•°å™¨æ‰¾åˆ°æœ€å…·ç¼–è¯‘ä»·å€¼ä»£ç ï¼Œè§¦å‘å³æ—¶ç¼–è¯‘æˆ–æ ˆä¸Šæ›¿æ¢</li><li>é€šè¿‡ç¼–è¯‘å™¨ä¸è§£é‡Šå™¨ååŒå·¥ä½œï¼Œåœ¨æœ€ä¼˜åŒ–çš„ç¨‹åºå“åº”æ—¶é—´ä¸æœ€ä½³æ‰§è¡Œæ€§èƒ½ä¸­å–å¾—å¹³è¡¡</li></ul><h3 id="JRockit"><a href="#JRockit" class="headerlink" title="JRockit"></a>JRockit</h3><p>ä¸“æ³¨äºæœåŠ¡å™¨ç«¯åº”ç”¨</p><ul><li>å®ƒå¯ä»¥ä¸å¤ªå…³æ³¨ç¨‹åºå¯åŠ¨é€Ÿåº¦ï¼Œå› æ­¤JRockitå†…éƒ¨ä¸åŒ…å«è§£æå™¨å®ç°ï¼Œå…¨éƒ¨ä»£ç éƒ½é å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åæ‰§è¡Œã€‚</li></ul><p>å¤§é‡çš„è¡Œä¸šåŸºå‡†æµ‹è¯•æ˜¾ç¤ºï¼ŒJRockit JVMæ˜¯ä¸–ç•Œä¸Šæœ€å¿«çš„JVMã€‚</p><ul><li>ä½¿ç”¨JRockitäº§å“ï¼Œå®¢æˆ·å·²ç»ä½“éªŒåˆ°äº†æ˜¾è‘—çš„æ€§èƒ½æé«˜ï¼ˆä¸€äº›è¶…è¿‡äº†70%ï¼‰å’Œç¡¬ä»¶æˆæœ¬çš„å‡å°‘ï¼ˆè¾¾50%ï¼‰ã€‚</li></ul><p>ä¼˜åŠ¿ï¼šå…¨é¢çš„Javaè¿è¡Œæ—¶è§£å†³æ–¹æ¡ˆç»„åˆ</p><ul><li>JRockité¢å‘å»¶è¿Ÿæ•æ„Ÿå‹åº”ç”¨çš„è§£å†³æ–¹æ¡ˆJRockit Real Timeæä¾›ä»¥æ¯«ç§’æˆ–å¾®ç§’çº§çš„JVMå“åº”æ—¶é—´ï¼Œé€‚åˆè´¢åŠ¡ã€å†›äº‹æŒ‡æŒ¥ã€ç”µä¿¡ç½‘ç»œçš„éœ€è¦</li><li>MissionControlæœåŠ¡å¥—ä»¶ï¼Œå®ƒæ˜¯ä¸€ç»„ä»¥æä½çš„å¼€é”€æ¥ç›‘æ§ã€ç®¡ç†å’Œåˆ†æç”Ÿäº§ç¯å¢ƒä¸­çš„åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚</li></ul><p>2008å¹´ï¼ŒJRockitè¢«oracleæ”¶è´­ã€‚</p><p>oracleè¡¨è¾¾äº†æ•´åˆä¸¤å¤§ä¼˜ç§€è™šæ‹Ÿæœºçš„å·¥ä½œï¼Œå¤§è‡´åœ¨JDK8ä¸­å®Œæˆã€‚æ•´åˆçš„æ–¹å¼æ˜¯åœ¨HotSpotçš„åŸºç¡€ä¸Šï¼Œç§»æ¤JRockitçš„ä¼˜ç§€ç‰¹æ€§ã€‚</p><p>é«˜æ–¯æ—ï¼šç›®å‰å°±èŒäºè°·æ­Œï¼Œç ”ç©¶äººå·¥æ™ºèƒ½å’Œæ°´ä¸‹æœºå™¨äºº</p><h3 id="IBMçš„J9"><a href="#IBMçš„J9" class="headerlink" title="IBMçš„J9"></a>IBMçš„J9</h3><p>å…¨ç§°ï¼šIBM Technology for Java Virtual Machineï¼Œç®€ç§°IT4Jï¼Œå†…éƒ¨ä»£å·ï¼šJ9</p><p>å¸‚åœºå®šä½ä¸HotSpotæ¥è¿‘ï¼ŒæœåŠ¡å™¨ç«¯ã€æ¡Œé¢åº”ç”¨ã€åµŒå…¥å¼ç­‰å¤šç”¨é€”VMå¹¿æ³›ç”¨äºIBMçš„å„ç§Javaäº§å“ã€‚</p><p>ç›®å‰ï¼Œæœ‰å½±å“åŠ›çš„ä¸‰å¤§å•†ç”¨è™šæ‹Ÿæœºä¹‹ä¸€ï¼Œä¹Ÿå·ç§°æ˜¯ä¸–ç•Œä¸Šæœ€å¿«çš„Javaè™šæ‹Ÿæœºã€‚</p><p>2017å¹´å·¦å³ï¼ŒIBMå‘å¸ƒäº†å¼€æºJ9VMï¼Œå‘½åä¸ºopenJ9ï¼Œäº¤ç»™EClipseåŸºé‡‘ä¼šç®¡ç†ï¼Œä¹Ÿç§°ä¸ºEclipse OpenJ9</p><p>OpenJDK   -&gt; æ˜¯JDKå¼€æºäº†ï¼ŒåŒ…æ‹¬äº†è™šæ‹Ÿæœº</p><h3 id="KVMå’ŒCDC-CLDC-Hotspot"><a href="#KVMå’ŒCDC-CLDC-Hotspot" class="headerlink" title="KVMå’ŒCDC / CLDC  Hotspot"></a>KVMå’ŒCDC / CLDC  Hotspot</h3><p>oracleåœ¨Java MEäº§å“çº¿ä¸Šçš„ä¸¤æ¬¾è™šæ‹Ÿæœºä¸ºï¼šCDC/CLDC HotSpot Implementation VM KVMï¼ˆKilobyteï¼‰æ˜¯CLDC-HIæ—©æœŸäº§å“ç›®å‰ç§»åŠ¨é¢†åŸŸåœ°ä½å°´å°¬ï¼Œæ™ºèƒ½æœºè¢«Angroidå’ŒioSäºŒåˆ†å¤©ä¸‹ã€‚</p><p>KVMç®€å•ã€è½»é‡ã€é«˜åº¦å¯ç§»æ¤ï¼Œé¢å‘æ›´ä½ç«¯çš„è®¾å¤‡ä¸Šè¿˜ç»´æŒè‡ªå·±çš„ä¸€ç‰‡å¸‚åœº</p><ul><li>æ™ºèƒ½æ§åˆ¶å™¨ã€ä¼ æ„Ÿå™¨</li><li>è€äººæ‰‹æœºã€ç»æµæ¬ å‘è¾¾åœ°åŒºçš„åŠŸèƒ½æ‰‹æœº</li></ul><p>æ‰€æœ‰çš„è™šæ‹Ÿæœºçš„åŸåˆ™ï¼šä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œã€‚</p><h3 id="Azul-VM"><a href="#Azul-VM" class="headerlink" title="Azul VM"></a>Azul VM</h3><p>å‰é¢ä¸‰å¤§â€œé«˜æ€§èƒ½Javaè™šæ‹Ÿæœºâ€ä½¿ç”¨åœ¨é€šç”¨ç¡¬ä»¶å¹³å°ä¸Šè¿™é‡ŒAzu1VWå’ŒBEALiquid VMæ˜¯ä¸ç‰¹å®šç¡¬ä»¶å¹³å°ç»‘å®šã€è½¯ç¡¬ä»¶é…åˆçš„ä¸“æœ‰è™šæ‹ŸæœºI</p><ul><li>é«˜æ€§èƒ½Javaè™šæ‹Ÿæœºä¸­çš„æˆ˜æ–—æœºã€‚</li></ul><p>Azul VMæ˜¯Azu1Systemså…¬å¸åœ¨HotSpotåŸºç¡€ä¸Šè¿›è¡Œå¤§é‡æ”¹è¿›ï¼Œè¿è¡ŒäºAzul Systemså…¬å¸çš„ä¸“æœ‰ç¡¬ä»¶Vegaç³»ç»Ÿä¸Šçš„avaè™šæ‹Ÿæœºã€‚</p><p>æ¯ä¸ªAzu1VMå®ä¾‹éƒ½å¯ä»¥ç®¡ç†è‡³å°‘æ•°åä¸ªCPUå’Œæ•°ç™¾GBå†…å­˜çš„ç¡¬ä»¶èµ„æºï¼Œå¹¶æä¾›åœ¨å·¨å¤§å†…å­˜èŒƒå›´å†…å®ç°å¯æ§çš„GCæ—¶é—´çš„åƒåœ¾æ”¶é›†å™¨ã€ä¸“æœ‰ç¡¬ä»¶ä¼˜åŒ–çš„çº¿ç¨‹è°ƒåº¦ç­‰ä¼˜ç§€ç‰¹æ€§ã€‚</p><p>2010å¹´ï¼ŒAzulSystemså…¬å¸å¼€å§‹ä»ç¡¬ä»¶è½¬å‘è½¯ä»¶ï¼Œå‘å¸ƒäº†è‡ªå·±çš„zing JVMï¼Œå¯ä»¥åœ¨é€šç”¨x86å¹³å°ä¸Šæä¾›æ¥è¿‘äºVegaç³»ç»Ÿçš„ç‰¹æ€§ã€‚</p><h3 id="Liquid-VM"><a href="#Liquid-VM" class="headerlink" title="Liquid VM"></a>Liquid VM</h3><p>é«˜æ€§èƒ½Javaè™šæ‹Ÿæœºä¸­çš„æˆ˜æ–—æœºã€‚</p><p>BEAå…¬å¸å¼€å‘çš„ï¼Œç›´æ¥è¿è¡Œåœ¨è‡ªå®¶Hypervisorç³»ç»Ÿä¸ŠLiquid VMå³æ˜¯ç°åœ¨çš„JRockit VEï¼ˆVirtual Editionï¼‰ï¼Œ</p><p>Liquid VMä¸éœ€è¦æ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œæˆ–è€…è¯´å®ƒè‡ªå·±æœ¬èº«å®ç°äº†ä¸€ä¸ªä¸“ç”¨æ“ä½œç³»ç»Ÿçš„å¿…è¦åŠŸèƒ½ï¼Œå¦‚çº¿ç¨‹è°ƒåº¦ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œæ”¯æŒç­‰ã€‚</p><p>éšç€JRockitè™šæ‹Ÿæœºç»ˆæ­¢å¼€å‘ï¼ŒLiquid vMé¡¹ç›®ä¹Ÿåœæ­¢äº†ã€‚</p><h3 id="Apache-Marmony"><a href="#Apache-Marmony" class="headerlink" title="Apache Marmony"></a>Apache Marmony</h3><p>Apacheä¹Ÿæ›¾ç»æ¨å‡ºè¿‡ä¸JDK1.5å’ŒJDK1.6å…¼å®¹çš„Javaè¿è¡Œå¹³å°Apache Harmonyã€‚</p><p>å®ƒæ˜¯IElfå’ŒInte1è”åˆå¼€å‘çš„å¼€æºJVMï¼Œå—åˆ°åŒæ ·å¼€æºçš„openJDKçš„å‹åˆ¶ï¼ŒSunåšå†³ä¸è®©Harmonyè·å¾—JCPè®¤è¯ï¼Œæœ€ç»ˆäº2011å¹´é€€å½¹ï¼ŒIBMè½¬è€Œå‚ä¸OpenJDK</p><p>è™½ç„¶ç›®å‰å¹¶æ²¡æœ‰Apache Harmonyè¢«å¤§è§„æ¨¡å•†ç”¨çš„æ¡ˆä¾‹ï¼Œä½†æ˜¯å®ƒçš„Javaç±»åº“ä»£ç å¸çº³è¿›äº†Android SDKã€‚</p><h3 id="Micorsoft-JVM"><a href="#Micorsoft-JVM" class="headerlink" title="Micorsoft JVM"></a>Micorsoft JVM</h3><p>å¾®è½¯ä¸ºäº†åœ¨IE3æµè§ˆå™¨ä¸­æ”¯æŒJava Appletsï¼Œå¼€å‘äº†Microsoft JVMã€‚</p><p>åªèƒ½åœ¨windowå¹³å°ä¸‹è¿è¡Œã€‚ä½†ç¡®æ˜¯å½“æ—¶Windowsä¸‹æ€§èƒ½æœ€å¥½çš„Java VMã€‚</p><p>1997å¹´ï¼Œsunä»¥ä¾µçŠ¯å•†æ ‡ã€ä¸æ­£å½“ç«äº‰ç½ªåæŒ‡æ§å¾®è½¯æˆåŠŸï¼Œèµ”äº†sunå¾ˆå¤šé’±ã€‚å¾®è½¯windowsXPSP3ä¸­æŠ¹æ‰äº†å…¶VMã€‚ç°åœ¨windowsä¸Šå®‰è£…çš„jdkéƒ½æ˜¯HotSpotã€‚</p><h3 id="Taobao-JVM"><a href="#Taobao-JVM" class="headerlink" title="Taobao JVM"></a>Taobao JVM</h3><p>ç”±AliJVMå›¢é˜Ÿå‘å¸ƒã€‚é˜¿é‡Œï¼Œå›½å†…ä½¿ç”¨Javaæœ€å¼ºå¤§çš„å…¬å¸ï¼Œè¦†ç›–äº‘è®¡ç®—ã€é‡‘èã€ç‰©æµã€ç”µå•†ç­‰ä¼—å¤šé¢†åŸŸï¼Œéœ€è¦è§£å†³é«˜å¹¶å‘ã€é«˜å¯ç”¨ã€åˆ†å¸ƒå¼çš„å¤åˆé—®é¢˜ã€‚æœ‰å¤§é‡çš„å¼€æºäº§å“ã€‚</p><p>åŸºäºopenJDKå¼€å‘äº†è‡ªå·±çš„å®šåˆ¶ç‰ˆæœ¬AlibabaJDKï¼Œç®€ç§°AJDKã€‚æ˜¯æ•´ä¸ªé˜¿é‡ŒJavaä½“ç³»çš„åŸºçŸ³ã€‚</p><p>åŸºäºopenJDK Hotspot VMå‘å¸ƒçš„å›½å†…ç¬¬ä¸€ä¸ªä¼˜åŒ–ã€æ·±åº¦å®šåˆ¶ä¸”å¼€æºçš„é«˜æ€§èƒ½æœåŠ¡å™¨ç‰ˆJavaè™šæ‹Ÿæœºã€‚</p><ul><li>åˆ›æ–°çš„GCIHï¼ˆGCinvisible heapï¼‰æŠ€æœ¯å®ç°äº†off-heapï¼Œå³å°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»åˆ°heapä¹‹å¤–ï¼Œå¹¶ä¸”Gcä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡Gcçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚</li><li>GCIHä¸­çš„å¯¹è±¡è¿˜èƒ½å¤Ÿåœ¨å¤šä¸ªJavaè™šæ‹Ÿæœºè¿›ç¨‹ä¸­å®ç°å…±äº«</li><li>ä½¿ç”¨crc32æŒ‡ä»¤å®ç°JvM intrinsicé™ä½JNIçš„è°ƒç”¨å¼€é”€</li><li>PMU hardwareçš„Java profiling toolå’Œè¯Šæ–­ååŠ©åŠŸèƒ½</li><li>é’ˆå¯¹å¤§æ•°æ®åœºæ™¯çš„ZenGc </li></ul><p>taobao vmåº”ç”¨åœ¨é˜¿é‡Œäº§å“ä¸Šæ€§èƒ½é«˜ï¼Œç¡¬ä»¶ä¸¥é‡ä¾èµ–inte1çš„cpuï¼ŒæŸå¤±äº†å…¼å®¹æ€§ï¼Œä½†æé«˜äº†æ€§èƒ½</p><p>ç›®å‰å·²ç»åœ¨æ·˜å®ã€å¤©çŒ«ä¸Šçº¿ï¼ŒæŠŠoracleå®˜æ–¹JvMç‰ˆæœ¬å…¨éƒ¨æ›¿æ¢äº†ã€‚</p><h3 id="Dalvik-VM"><a href="#Dalvik-VM" class="headerlink" title="Dalvik VM"></a>Dalvik VM</h3><p>è°·æ­Œå¼€å‘çš„ï¼Œåº”ç”¨äºAndroidç³»ç»Ÿï¼Œå¹¶åœ¨Android2.2ä¸­æä¾›äº†JITï¼Œå‘å±•è¿…çŒ›ã€‚</p><p>Dalvik yåªèƒ½ç§°ä½œè™šæ‹Ÿæœºï¼Œè€Œä¸èƒ½ç§°ä½œâ€œJavaè™šæ‹Ÿæœºâ€ï¼Œå®ƒæ²¡æœ‰éµå¾ª Javaè™šæ‹Ÿæœºè§„èŒƒ</p><p>ä¸èƒ½ç›´æ¥æ‰§è¡ŒJavaçš„Classæ–‡ä»¶</p><p>åŸºäºå¯„å­˜å™¨æ¶æ„ï¼Œä¸æ˜¯jvmçš„æ ˆæ¶æ„ã€‚</p><p>æ‰§è¡Œçš„æ˜¯ç¼–è¯‘ä»¥åçš„dexï¼ˆDalvik Executableï¼‰æ–‡ä»¶ã€‚æ‰§è¡Œæ•ˆç‡æ¯”è¾ƒé«˜ã€‚</p><ul><li>å®ƒæ‰§è¡Œçš„dexï¼ˆDalvik Executableï¼‰æ–‡ä»¶å¯ä»¥é€šè¿‡classæ–‡ä»¶è½¬åŒ–è€Œæ¥ï¼Œä½¿ç”¨Javaè¯­æ³•ç¼–å†™åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¤§éƒ¨åˆ†çš„Java APIç­‰ã€‚</li></ul><p>Android 5.0ä½¿ç”¨æ”¯æŒæå‰ç¼–è¯‘ï¼ˆAhead of Time Compilationï¼ŒAoTï¼‰çš„ART VMæ›¿æ¢Dalvik VMã€‚</p><h3 id="Graal-VM"><a href="#Graal-VM" class="headerlink" title="Graal VM"></a>Graal VM</h3><p>2018å¹´4æœˆï¼Œoracle Labså…¬å¼€äº†GraalvMï¼Œå·ç§° â€œRun Programs Faster Anywhereâ€ï¼Œå‹ƒå‹ƒé‡å¿ƒã€‚ä¸1995å¹´javaçš„â€write onceï¼Œrun anywhereâ€é¥ç›¸å‘¼åº”ã€‚</p><p>GraalVMåœ¨HotSpot VMåŸºç¡€ä¸Šå¢å¼ºè€Œæˆçš„è·¨è¯­è¨€å…¨æ ˆè™šæ‹Ÿæœºï¼Œå¯ä»¥ä½œä¸ºâ€œä»»ä½•è¯­è¨€â€<br>çš„è¿è¡Œå¹³å°ä½¿ç”¨ã€‚è¯­è¨€åŒ…æ‹¬ï¼šJavaã€Scalaã€Groovyã€Kotlinï¼›Cã€C++ã€Javascriptã€Rubyã€Pythonã€Rç­‰</p><p>æ”¯æŒä¸åŒè¯­è¨€ä¸­æ··ç”¨å¯¹æ–¹çš„æ¥å£å’Œå¯¹è±¡ï¼Œæ”¯æŒè¿™äº›è¯­è¨€ä½¿ç”¨å·²ç»ç¼–å†™å¥½çš„æœ¬åœ°åº“æ–‡ä»¶</p><p>å·¥ä½œåŸç†æ˜¯å°†è¿™äº›è¯­è¨€çš„æºä»£ç æˆ–æºä»£ç ç¼–è¯‘åçš„ä¸­é—´æ ¼å¼ï¼Œé€šè¿‡è§£é‡Šå™¨è½¬æ¢ä¸ºèƒ½è¢«Graal VMæ¥å—çš„ä¸­é—´è¡¨ç¤ºã€‚Graal VMæä¾›Truffleå·¥å…·é›†å¿«é€Ÿæ„å»ºé¢å‘ä¸€ç§æ–°è¯­è¨€çš„è§£é‡Šå™¨ã€‚åœ¨è¿è¡Œæ—¶è¿˜èƒ½è¿›è¡Œå³æ—¶ç¼–è¯‘ä¼˜åŒ–ï¼Œè·å¾—æ¯”åŸç”Ÿç¼–è¯‘å™¨æ›´ä¼˜ç§€çš„æ‰§è¡Œæ•ˆç‡ã€‚</p><p>å¦‚æœè¯´HotSpotæœ‰ä¸€å¤©çœŸçš„è¢«å–ä»£ï¼ŒGraalvmå¸Œæœ›æœ€å¤§ã€‚ä½†æ˜¯Javaçš„è½¯ä»¶ç”Ÿæ€æ²¡æœ‰ä¸æ¯«å˜åŒ–ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…·ä½“JVMçš„å†…å­˜ç»“æ„ï¼Œå…¶å®å–å†³äºå…¶å®ç°ï¼Œä¸åŒå‚å•†çš„JVMï¼Œæˆ–è€…åŒä¸€å‚å•†å‘å¸ƒçš„ä¸åŒç‰ˆæœ¬ï¼Œéƒ½æœ‰å¯èƒ½å­˜åœ¨ä¸€å®šå·®å¼‚ã€‚ä¸»è¦ä»¥oracle HotSpot VMä¸ºé»˜è®¤è™šæ‹Ÿæœºã€‚</p><h1 id="ç¬¬2ç« -ç±»åŠ è½½å­ç³»ç»Ÿ"><a href="#ç¬¬2ç« -ç±»åŠ è½½å­ç³»ç»Ÿ" class="headerlink" title="ç¬¬2ç«  ç±»åŠ è½½å­ç³»ç»Ÿ"></a>ç¬¬2ç«  ç±»åŠ è½½å­ç³»ç»Ÿ</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1 æ¦‚è¿°"></a>1 æ¦‚è¿°</h2><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705080719531.png" alt="image-20200705080719531"></p><p>å®Œæ•´å›¾å¦‚ä¸‹</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705080911284.png" alt="image-20200705080911284"></p><p>å¦‚æœè‡ªå·±æƒ³æ‰‹å†™ä¸€ä¸ªJavaè™šæ‹Ÿæœºçš„è¯ï¼Œä¸»è¦è€ƒè™‘å“ªäº›ç»“æ„å‘¢ï¼Ÿ</p><ul><li>ç±»åŠ è½½å™¨</li><li>æ‰§è¡Œå¼•æ“</li></ul><h2 id="2-ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨"><a href="#2-ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨" class="headerlink" title="2 ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨"></a>2 ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨</h2><p>ç±»åŠ è½½å™¨å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½Classæ–‡ä»¶ï¼Œclassæ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚</p><p>ClassLoaderåªè´Ÿè´£classæ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±Execution Engineå†³å®šã€‚</p><p>åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œæ–¹æ³•åŒºä¸­è¿˜ä¼šå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å­—å¸¸é‡ï¼ˆè¿™éƒ¨åˆ†å¸¸é‡ä¿¡æ¯æ˜¯Classæ–‡ä»¶ä¸­å¸¸é‡æ± éƒ¨åˆ†çš„å†…å­˜æ˜ å°„ï¼‰</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/2_%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F/images/image-20200705081813409.png" alt="image-20200705081813409"></p><ul><li>class fileå­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ°JVMå½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡ºnä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚</li><li>class fileåŠ è½½åˆ°JVMä¸­ï¼Œè¢«ç§°ä¸ºDNAå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ”¾åœ¨æ–¹æ³•åŒºã€‚</li><li>åœ¨.classæ–‡ä»¶-&gt;JVM-&gt;æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·ï¼ˆç±»è£…è½½å™¨Class Loaderï¼‰ï¼Œæ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705081913538.png" alt="image-20200705081913538"></p><h2 id="3-ç±»çš„åŠ è½½è¿‡ç¨‹"><a href="#3-ç±»çš„åŠ è½½è¿‡ç¨‹" class="headerlink" title="3 ç±»çš„åŠ è½½è¿‡ç¨‹"></a>3 ç±»çš„åŠ è½½è¿‡ç¨‹</h2><p>ä¾‹å¦‚ä¸‹é¢çš„ä¸€æ®µç®€å•çš„ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloLoader</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;æˆ‘å·²ç»è¢«åŠ è½½å•¦&quot;</span>);    &#125;&#125;</code></pre></div><p>å®ƒçš„åŠ è½½è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢?</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705082255746.png" alt="image-20200705082255746"></p><p>å®Œæ•´çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705082601441.png" alt="image-20200705082601441"></p><h2 id="4-åŠ è½½é˜¶æ®µ"><a href="#4-åŠ è½½é˜¶æ®µ" class="headerlink" title="4 åŠ è½½é˜¶æ®µ"></a>4 åŠ è½½é˜¶æ®µ</h2><p>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</p><p>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</p><p>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£</p><h3 id="4-1-åŠ è½½classæ–‡ä»¶çš„æ–¹å¼"><a href="#4-1-åŠ è½½classæ–‡ä»¶çš„æ–¹å¼" class="headerlink" title="4.1 åŠ è½½classæ–‡ä»¶çš„æ–¹å¼"></a>4.1 åŠ è½½classæ–‡ä»¶çš„æ–¹å¼</h3><ul><li>ä»æœ¬åœ°ç³»ç»Ÿä¸­ç›´æ¥åŠ è½½</li><li>é€šè¿‡ç½‘ç»œè·å–ï¼Œå…¸å‹åœºæ™¯ï¼šWeb Applet</li><li>ä»zipå‹ç¼©åŒ…ä¸­è¯»å–ï¼Œæˆä¸ºæ—¥åjarã€waræ ¼å¼çš„åŸºç¡€</li><li>è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨æœ€å¤šçš„æ˜¯ï¼šåŠ¨æ€ä»£ç†æŠ€æœ¯</li><li>ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œå…¸å‹åœºæ™¯ï¼šJSPåº”ç”¨ä»ä¸“æœ‰æ•°æ®åº“ä¸­æå–.classæ–‡ä»¶ï¼Œæ¯”è¾ƒå°‘è§</li><li>ä»åŠ å¯†æ–‡ä»¶ä¸­è·å–ï¼Œå…¸å‹çš„é˜²Classæ–‡ä»¶è¢«åç¼–è¯‘çš„ä¿æŠ¤æªæ–½</li></ul><h3 id="4-2-é“¾æ¥é˜¶æ®µ"><a href="#4-2-é“¾æ¥é˜¶æ®µ" class="headerlink" title="4.2 é“¾æ¥é˜¶æ®µ"></a>4.2 é“¾æ¥é˜¶æ®µ</h3><h4 id="éªŒè¯-Verify"><a href="#éªŒè¯-Verify" class="headerlink" title="éªŒè¯ Verify"></a>éªŒè¯ Verify</h4><p>ç›®çš„åœ¨äºç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚</p><p>ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼Œæ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚</p><blockquote><p>å·¥å…·ï¼šBinary VieweræŸ¥çœ‹</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705084038680.png" alt="image-20200705084038680"></p><p>å¦‚æœå‡ºç°ä¸åˆæ³•çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£ä¹ˆå°†ä¼šéªŒè¯ä¸é€šè¿‡</p><p>åŒæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å®‰è£…IDEAçš„æ’ä»¶ï¼Œæ¥æŸ¥çœ‹æˆ‘ä»¬çš„Classæ–‡ä»¶</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705090237078.png" alt="image-20200705090237078"></p><p>å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬ç¼–è¯‘å®Œä¸€ä¸ªclassæ–‡ä»¶åï¼Œç‚¹å‡»viewå³å¯æ˜¾ç¤ºæˆ‘ä»¬å®‰è£…çš„æ’ä»¶æ¥æŸ¥çœ‹å­—èŠ‚ç æ–¹æ³•äº†</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705090328171.png" alt="image-20200705090328171"></p><h3 id="4-3-å‡†å¤‡-Prepare"><a href="#4-3-å‡†å¤‡-Prepare" class="headerlink" title="4.3 å‡†å¤‡ Prepare"></a>4.3 å‡†å¤‡ Prepare</h3><p>ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼ã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloApp</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>;  <span class="hljs-comment">// å‡†å¤‡é˜¶æ®µä¸º0ï¼Œåœ¨ä¸‹ä¸ªé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–çš„æ—¶å€™æ‰æ˜¯1</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(a);    &#125;&#125;</code></pre></div><p>ä¸Šé¢çš„å˜é‡aåœ¨å‡†å¤‡é˜¶æ®µä¼šèµ‹åˆå§‹å€¼ï¼Œä½†ä¸æ˜¯1ï¼Œè€Œæ˜¯0ã€‚</p><p>è¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„staticï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–ï¼›</p><p>è¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­ã€‚</p><p>ä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç </p><h3 id="4-4-è§£æ-Resolve"><a href="#4-4-è§£æ-Resolve" class="headerlink" title="4.4 è§£æ Resolve"></a>4.4 è§£æ Resolve</h3><p>å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚</p><p>äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚</p><p>ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€Šjavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚</p><p>è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„CONSTANT Class infoã€CONSTANT Fieldref infoã€CONSTANT Methodref infoç­‰</p><h3 id="4-5-åˆå§‹åŒ–é˜¶æ®µ"><a href="#4-5-åˆå§‹åŒ–é˜¶æ®µ" class="headerlink" title="4.5 åˆå§‹åŒ–é˜¶æ®µ"></a>4.5 åˆå§‹åŒ–é˜¶æ®µ</h3><p>åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ³•<clinit>ï¼ˆï¼‰çš„è¿‡ç¨‹ã€‚</clinit></p><p>æ­¤æ–¹æ³•ä¸éœ€å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚</p><ul><li>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä»£ç ä¸­åŒ…å«staticå˜é‡çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰clinitæ–¹æ³•</li></ul><p>æ„é€ å™¨æ–¹æ³•ä¸­æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œã€‚</p><p><clinit>ï¼ˆï¼‰ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚ï¼ˆå…³è”ï¼šæ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„<init>ï¼ˆï¼‰ï¼‰è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„<clinit>ï¼ˆï¼‰æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„<clinit>ï¼ˆï¼‰å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚</clinit></clinit></init></clinit></p><ul><li>ä»»ä½•ä¸€ä¸ªç±»åœ¨å£°æ˜åï¼Œéƒ½æœ‰ç”Ÿæˆä¸€ä¸ªæ„é€ å™¨ï¼Œé»˜è®¤æ˜¯ç©ºå‚æ„é€ å™¨</li></ul><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassInitTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> num = <span class="hljs-number">1</span>;    <span class="hljs-keyword">static</span> &#123;        num = <span class="hljs-number">2</span>;        number = <span class="hljs-number">20</span>;        System.out.println(num);        System.out.println(number);  <span class="hljs-comment">//æŠ¥é”™ï¼Œéæ³•çš„å‰å‘å¼•ç”¨</span>    &#125;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">10</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(ClassInitTest.num); <span class="hljs-comment">// 2</span>        System.out.println(ClassInitTest.number); <span class="hljs-comment">// 10</span>    &#125;&#125;</code></pre></div><p>å…³äºæ¶‰åŠåˆ°çˆ¶ç±»æ—¶å€™çš„å˜é‡èµ‹å€¼è¿‡ç¨‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClinitTest1</span> </span>&#123;    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Father</span> </span>&#123;        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> A = <span class="hljs-number">1</span>;        <span class="hljs-keyword">static</span> &#123;            A = <span class="hljs-number">2</span>;        &#125;    &#125;    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span> </span>&#123;        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> b = A;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(Son.b);    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬è¾“å‡ºç»“æœä¸º 2ï¼Œä¹Ÿå°±æ˜¯è¯´é¦–å…ˆåŠ è½½ClinitTest1çš„æ—¶å€™ï¼Œä¼šæ‰¾åˆ°mainæ–¹æ³•ï¼Œç„¶åæ‰§è¡ŒSonçš„åˆå§‹åŒ–ï¼Œä½†æ˜¯Sonç»§æ‰¿äº†Fatherï¼Œå› æ­¤è¿˜éœ€è¦æ‰§è¡ŒFatherçš„åˆå§‹åŒ–ï¼ŒåŒæ—¶å°†Aèµ‹å€¼ä¸º2ã€‚æˆ‘ä»¬é€šè¿‡åç¼–è¯‘å¾—åˆ°Fatherçš„åŠ è½½è¿‡ç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬çœ‹åˆ°åŸæ¥çš„å€¼è¢«èµ‹å€¼æˆ1ï¼Œç„¶ååˆè¢«å¤åˆ¶æˆ2ï¼Œæœ€åè¿”å›</p><div class="code-wrapper"><pre><code class="hljs bash">iconst_1putstatic <span class="hljs-comment">#2 &lt;com/atguigu/java/chapter02/ClinitTest1$Father.A&gt;</span>iconst_2putstatic <span class="hljs-comment">#2 &lt;com/atguigu/java/chapter02/ClinitTest1$Father.A&gt;</span><span class="hljs-built_in">return</span></code></pre></div><p>è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„<clinit>ï¼ˆï¼‰æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚</clinit></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadThreadTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t çº¿ç¨‹t1å¼€å§‹&quot;</span>);            <span class="hljs-keyword">new</span> DeadThread();        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t çº¿ç¨‹t2å¼€å§‹&quot;</span>);            <span class="hljs-keyword">new</span> DeadThread();        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();    &#125;&#125;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadThread</span> </span>&#123;    <span class="hljs-keyword">static</span> &#123;        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">true</span>) &#123;            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t åˆå§‹åŒ–å½“å‰ç±»&quot;</span>);            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;            &#125;        &#125;    &#125;&#125;</code></pre></div><p>ä¸Šé¢çš„ä»£ç ï¼Œè¾“å‡ºç»“æœä¸º</p><div class="code-wrapper"><pre><code class="hljs mipsasm">çº¿ç¨‹<span class="hljs-built_in">t1</span>å¼€å§‹çº¿ç¨‹<span class="hljs-built_in">t2</span>å¼€å§‹çº¿ç¨‹<span class="hljs-built_in">t2</span> åˆå§‹åŒ–å½“å‰ç±»</code></pre></div><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºåˆå§‹åŒ–åï¼Œåªèƒ½å¤Ÿæ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–ï¼Œè¿™ä¹Ÿå°±æ˜¯åŒæ­¥åŠ é”çš„è¿‡ç¨‹</p><h2 id="5-ç±»åŠ è½½å™¨çš„åˆ†ç±»"><a href="#5-ç±»åŠ è½½å™¨çš„åˆ†ç±»" class="headerlink" title="5 ç±»åŠ è½½å™¨çš„åˆ†ç±»"></a>5 ç±»åŠ è½½å™¨çš„åˆ†ç±»</h2><p>JVMæ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ ã€‚åˆ†åˆ«ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆUser-Defined ClassLoaderï¼‰ã€‚</p><p>ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±»ClassLoaderçš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</p><p>æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æˆ‘ä»¬æœ€å¸¸è§çš„ç±»åŠ è½½å™¨å§‹ç»ˆåªæœ‰3ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705094149223.png" alt="image-20200705094149223"></p><p>è¿™é‡Œçš„å››è€…ä¹‹é—´æ˜¯åŒ…å«å…³ç³»ï¼Œä¸æ˜¯ä¸Šå±‚å’Œä¸‹å±‚ï¼Œä¹Ÿä¸æ˜¯å­ç³»ç»Ÿçš„ç»§æ‰¿å…³ç³»ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç±»ï¼Œè·å–å®ƒä¸åŒçš„åŠ è½½å™¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// è·å–ç³»ç»Ÿç±»åŠ è½½å™¨</span>        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();        System.out.println(systemClassLoader);        <span class="hljs-comment">// è·å–å…¶ä¸Šå±‚çš„ï¼šæ‰©å±•ç±»åŠ è½½å™¨</span>        ClassLoader extClassLoader = systemClassLoader.getParent();        System.out.println(extClassLoader);        <span class="hljs-comment">// è¯•å›¾è·å– æ ¹åŠ è½½å™¨</span>        ClassLoader bootstrapClassLoader = extClassLoader.getParent();        System.out.println(bootstrapClassLoader);        <span class="hljs-comment">// è·å–è‡ªå®šä¹‰åŠ è½½å™¨</span>        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();        System.out.println(classLoader);                <span class="hljs-comment">// è·å–Stringç±»å‹çš„åŠ è½½å™¨</span>        ClassLoader classLoader1 = String.class.getClassLoader();        System.out.println(classLoader1);    &#125;&#125;</code></pre></div><p>å¾—åˆ°çš„ç»“æœï¼Œä»ç»“æœå¯ä»¥çœ‹å‡º æ ¹åŠ è½½å™¨æ— æ³•ç›´æ¥é€šè¿‡ä»£ç è·å–ï¼ŒåŒæ—¶ç›®å‰ç”¨æˆ·ä»£ç æ‰€ä½¿ç”¨çš„åŠ è½½å™¨ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚åŒæ—¶æˆ‘ä»¬é€šè¿‡è·å–Stringç±»å‹çš„åŠ è½½å™¨ï¼Œå‘ç°æ˜¯nullï¼Œé‚£ä¹ˆè¯´æ˜Stringç±»å‹æ˜¯é€šè¿‡æ ¹åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Javaçš„æ ¸å¿ƒç±»åº“éƒ½æ˜¯ä½¿ç”¨æ ¹åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ã€‚</p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">sun</span>.misc.Launcher$AppClassLoader@<span class="hljs-number">18</span>b<span class="hljs-number">4</span>aac<span class="hljs-number">2</span><span class="hljs-attribute">sun</span>.misc.Launcher$ExtClassLoader@<span class="hljs-number">1540</span>e<span class="hljs-number">19</span>d<span class="hljs-attribute">null</span><span class="hljs-attribute">sun</span>.misc.Launcher$AppClassLoader@<span class="hljs-number">18</span>b<span class="hljs-number">4</span>aac<span class="hljs-number">2</span><span class="hljs-attribute">null</span></code></pre></div><h3 id="5-1-è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨"><a href="#5-1-è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨" class="headerlink" title="5.1 è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨"></a>5.1 è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨</h3><h4 id="å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap-ClassLoaderï¼‰"><a href="#å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap-ClassLoaderï¼‰" class="headerlink" title="å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap ClassLoaderï¼‰"></a>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap ClassLoaderï¼‰</h4><ul><li>è¿™ä¸ªç±»åŠ è½½ä½¿ç”¨C/C++è¯­è¨€å®ç°çš„ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ã€‚</li><li>å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“ï¼ˆJAVAHOME/jre/1ib/rt.jarã€resources.jaræˆ–sun.boot.class.pathè·¯å¾„ä¸‹çš„å†…å®¹ï¼‰ï¼Œç”¨äºæä¾›JVMè‡ªèº«éœ€è¦çš„ç±»</li><li>å¹¶ä¸ç»§æ‰¿è‡ªava.lang.ClassLoaderï¼Œæ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚</li><li>åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨ã€‚</li><li>å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootstrapå¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸ºjavaã€javaxã€sunç­‰å¼€å¤´çš„ç±»</li></ul><h3 id="5-2-æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension-ClassLoaderï¼‰"><a href="#5-2-æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension-ClassLoaderï¼‰" class="headerlink" title="5.2 æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰"></a>5.2 æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰</h3><ul><li>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$ExtClassLoaderå®ç°ã€‚</li><li>æ´¾ç”ŸäºClassLoaderç±»</li><li>çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨</li><li>ä»java.ext.dirsç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä»JDKçš„å®‰è£…ç›®å½•çš„jre/1ib/extå­ç›®å½•ï¼ˆæ‰©å±•ç›®å½•ï¼‰ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„JARæ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ã€‚</li></ul><h3 id="5-3-åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰"><a href="#5-3-åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰" class="headerlink" title="5.3 åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰"></a>5.3 åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰</h3><ul><li>javIè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.LaunchersAppClassLoaderå®ç°</li><li>æ´¾ç”ŸäºClassLoaderç±»</li><li>çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨</li><li>å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–ç³»ç»Ÿå±æ€§java.class.pathæŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“</li><li>è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJavaåº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½</li><li>é€šè¿‡classLoader#getSystemclassLoaderï¼ˆï¼‰æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨</li></ul><h3 id="5-4-ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#5-4-ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="5.4 ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>5.4 ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h3><p>åœ¨Javaçš„æ—¥å¸¸åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼Œåœ¨å¿…è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼ã€‚<br>ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ</p><ul><li>éš”ç¦»åŠ è½½ç±»</li><li>ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼</li><li>æ‰©å±•åŠ è½½æº</li><li>é˜²æ­¢æºç æ³„æ¼</li></ul><p>ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°æ­¥éª¤ï¼š</p><ul><li>å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±»ava.1ang.ClassLoaderç±»çš„æ–¹å¼ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚</li><li>åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ClassLoaderç±»å¹¶é‡å†™1oadClassï¼ˆï¼‰æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½ç±»ï¼Œä½†æ˜¯åœ¨JDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›–1oadclassï¼ˆï¼‰æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘å†™åœ¨findclassï¼ˆï¼‰æ–¹æ³•ä¸­</li><li>åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿URIClassLoaderç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™findclassï¼ˆï¼‰æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚</li></ul><h3 id="5-5-æŸ¥çœ‹æ ¹åŠ è½½å™¨æ‰€èƒ½åŠ è½½çš„ç›®å½•"><a href="#5-5-æŸ¥çœ‹æ ¹åŠ è½½å™¨æ‰€èƒ½åŠ è½½çš„ç›®å½•" class="headerlink" title="5.5 æŸ¥çœ‹æ ¹åŠ è½½å™¨æ‰€èƒ½åŠ è½½çš„ç›®å½•"></a>5.5 æŸ¥çœ‹æ ¹åŠ è½½å™¨æ‰€èƒ½åŠ è½½çš„ç›®å½•</h3><p>åˆšåˆšæˆ‘ä»¬é€šè¿‡æ¦‚å¿µäº†è§£åˆ°äº†ï¼Œæ ¹åŠ è½½å™¨åªèƒ½å¤ŸåŠ è½½ java /libç›®å½•ä¸‹çš„classï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢ä»£ç éªŒè¯ä¸€ä¸‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderTest1</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;*********å¯åŠ¨ç±»åŠ è½½å™¨************&quot;</span>);        <span class="hljs-comment">// è·å–BootstrapClassLoader èƒ½å¤ŸåŠ è½½çš„APIçš„è·¯å¾„</span>        URL[] urls = sun.misc.Launcher.getBootstrapClassPath().getURLs();        <span class="hljs-keyword">for</span> (URL url : urls) &#123;            System.out.println(url.toExternalForm());        &#125;        <span class="hljs-comment">// ä»ä¸Šé¢è·¯å¾„ä¸­ï¼Œéšæ„é€‰æ‹©ä¸€ä¸ªç±»ï¼Œæ¥çœ‹çœ‹ä»–çš„ç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆï¼šå¾—åˆ°çš„æ˜¯nullï¼Œè¯´æ˜æ˜¯  æ ¹åŠ è½½å™¨</span>        ClassLoader classLoader = Provider.class.getClassLoader();    &#125;&#125;</code></pre></div><p>å¾—åˆ°çš„ç»“æœ</p><div class="code-wrapper"><pre><code class="hljs gradle">*********å¯åŠ¨ç±»åŠ è½½å™¨************<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/resources.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/rt.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/sunrsasign.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/jsse.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/jce.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/charsets.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>lib/jfr.jar<span class="hljs-keyword">file</span>:<span class="hljs-regexp">/E:/</span>Software<span class="hljs-regexp">/JDK1.8/</span>Java<span class="hljs-regexp">/jre/</span>classes<span class="hljs-keyword">null</span></code></pre></div><h3 id="5-6-å…³äºClassLoader"><a href="#5-6-å…³äºClassLoader" class="headerlink" title="5.6 å…³äºClassLoader"></a>5.6 å…³äºClassLoader</h3><p>ClassLoaderç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ªClassLoaderï¼ˆä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705103516138.png" alt="image-20200705103516138"></p><p>sun.misc.Launcher å®ƒæ˜¯ä¸€ä¸ªjavaè™šæ‹Ÿæœºçš„å…¥å£åº”ç”¨</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705103636003.png" alt="image-20200705103636003"></p><p>è·å–ClassLoaderçš„é€”å¾„</p><ul><li>è·å–å½“å‰ClassLoaderï¼šclazz.getClassLoader()</li><li>è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ClassLoaderï¼šThread.currentThread().getContextClassLoader()</li><li>è·å–ç³»ç»Ÿçš„ClassLoaderï¼šClassLoader.getSystemClassLoader()</li><li>è·å–è°ƒç”¨è€…çš„ClassLoaderï¼šDriverManager.getCallerClassLoader()</li></ul><h2 id="6-åŒäº²å§”æ´¾æœºåˆ¶"><a href="#6-åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="6 åŒäº²å§”æ´¾æœºåˆ¶"></a>6 åŒäº²å§”æ´¾æœºåˆ¶</h2><p>Javaè™šæ‹Ÿæœºå¯¹classæ–‡ä»¶é‡‡ç”¨çš„æ˜¯æŒ‰éœ€åŠ è½½çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶æ‰ä¼šå°†å®ƒçš„classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ç”Ÿæˆclasså¯¹è±¡ã€‚è€Œä¸”åŠ è½½æŸä¸ªç±»çš„classæ–‡ä»¶æ—¶ï¼ŒJavaè™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³æŠŠè¯·æ±‚äº¤ç”±çˆ¶ç±»å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚</p><h3 id="6-1-å·¥ä½œåŸç†"><a href="#6-1-å·¥ä½œåŸç†" class="headerlink" title="6.1 å·¥ä½œåŸç†"></a>6.1 å·¥ä½œåŸç†</h3><ul><li>å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œï¼›</li><li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼›</li><li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705105151258.png" alt="image-20200705105151258"></p><h3 id="6-2-åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹"><a href="#6-2-åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹" class="headerlink" title="6.2 åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹"></a>6.2 åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹</h3><p>å½“æˆ‘ä»¬åŠ è½½jdbc.jar ç”¨äºå®ç°æ•°æ®åº“è¿æ¥çš„æ—¶å€™ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ jdbc.jaræ˜¯åŸºäºSPIæ¥å£è¿›è¡Œå®ç°çš„ï¼Œæ‰€ä»¥åœ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šè¿›è¡ŒåŒäº²å§”æ´¾ï¼Œæœ€ç»ˆä»æ ¹åŠ è½½å™¨ä¸­åŠ è½½ SPIæ ¸å¿ƒç±»ï¼Œç„¶ååœ¨åŠ è½½SPIæ¥å£ç±»ï¼Œæ¥ç€åœ¨è¿›è¡Œåå‘å§”æ´¾ï¼Œé€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨è¿›è¡Œå®ç°ç±» jdbc.jarçš„åŠ è½½ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705105810107.png" alt="image-20200705105810107"></p><h3 id="6-3-æ²™ç®±å®‰å…¨æœºåˆ¶"><a href="#6-3-æ²™ç®±å®‰å…¨æœºåˆ¶" class="headerlink" title="6.3 æ²™ç®±å®‰å…¨æœºåˆ¶"></a>6.3 æ²™ç®±å®‰å…¨æœºåˆ¶</h3><p>è‡ªå®šä¹‰stringç±»ï¼Œä½†æ˜¯åœ¨åŠ è½½è‡ªå®šä¹‰Stringç±»çš„æ—¶å€™ä¼šç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶ï¼ˆrt.jaråŒ…ä¸­java\lang\String.classï¼‰ï¼ŒæŠ¥é”™ä¿¡æ¯è¯´æ²¡æœ‰mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯rt.jaråŒ…ä¸­çš„stringç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹javaæ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ï¼Œè¿™å°±æ˜¯æ²™ç®±å®‰å…¨æœºåˆ¶ã€‚</p><h3 id="6-4-åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜åŠ¿"><a href="#6-4-åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜åŠ¿" class="headerlink" title="6.4 åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜åŠ¿"></a>6.4 åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜åŠ¿</h3><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒåŒäº²æœºåˆ¶å¯ä»¥</p><ul><li>é¿å…ç±»çš„é‡å¤åŠ è½½</li><li>ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹<ul><li>è‡ªå®šä¹‰ç±»ï¼šjava.lang.String</li><li>è‡ªå®šä¹‰ç±»ï¼šjava.lang.ShkStartï¼ˆæŠ¥é”™ï¼šé˜»æ­¢åˆ›å»º java.langå¼€å¤´çš„ç±»ï¼‰</li></ul></li></ul><h2 id="7-å…¶å®ƒ"><a href="#7-å…¶å®ƒ" class="headerlink" title="7 å…¶å®ƒ"></a>7 å…¶å®ƒ</h2><h3 id="å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ç›¸åŒ"><a href="#å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ç›¸åŒ" class="headerlink" title="å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ç›¸åŒ"></a>å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ç›¸åŒ</h3><p>åœ¨JVMä¸­è¡¨ç¤ºä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼š</p><ul><li>ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…åã€‚</li><li>åŠ è½½è¿™ä¸ªç±»çš„ClassLoaderï¼ˆæŒ‡ClassLoaderå®ä¾‹å¯¹è±¡ï¼‰å¿…é¡»ç›¸åŒã€‚</li></ul><p>æ¢å¥è¯è¯´ï¼Œåœ¨JvMä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡ï¼ˆclasså¯¹è±¡ï¼‰æ¥æºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½å®ƒä»¬çš„ClassLoaderå®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„ã€‚</p><p>JVMå¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆJVMä¼šå°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ä¿å­˜åœ¨æ–¹æ³•åŒºä¸­ã€‚å½“è§£æä¸€ä¸ªç±»å‹åˆ°å¦ä¸€ä¸ªç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼ŒJVMéœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ã€‚</p><h3 id="ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨"><a href="#ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨" class="headerlink" title="ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨"></a>ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨</h3><p>Javaç¨‹åºå¯¹ç±»çš„ä½¿ç”¨æ–¹å¼åˆ†ä¸ºï¼šç‹åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨ã€‚<br>ä¸»åŠ¨ä½¿ç”¨ï¼Œåˆåˆ†ä¸ºä¸ƒç§æƒ…å†µï¼š</p><ul><li>åˆ›å»ºç±»çš„å®ä¾‹</li><li>è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼</li><li>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•I</li><li>åå°„ï¼ˆæ¯”å¦‚ï¼šClass.forNameï¼ˆâ€com.atguigu.Testâ€ï¼‰ï¼‰</li><li>åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»</li><li>Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»</li><li>JDK7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒï¼š</li><li>java.lang.invoke.MethodHandleå®ä¾‹çš„è§£æç»“æœREF getStaticã€REF putStaticã€REF invokeStaticå¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–</li></ul><p>é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨Javaç±»çš„æ–¹å¼éƒ½è¢«çœ‹ä½œæ˜¯å¯¹ç±»çš„è¢«åŠ¨ä½¿ç”¨ï¼Œéƒ½ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ã€‚</p><h1 id="ç¬¬3ç« -è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°åŠçº¿ç¨‹"><a href="#ç¬¬3ç« -è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°åŠçº¿ç¨‹" class="headerlink" title="ç¬¬3ç«   è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°åŠçº¿ç¨‹"></a>ç¬¬3ç«   è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°åŠçº¿ç¨‹</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬èŠ‚ä¸»è¦è®²çš„æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾è¿™éƒ¨åˆ†ï¼Œå®ƒæ˜¯åœ¨ç±»åŠ è½½å®Œæˆåçš„é˜¶æ®µ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705111640511.png" alt="image-20200705111640511"></p><p>å½“æˆ‘ä»¬é€šè¿‡å‰é¢çš„ï¼šç±»çš„åŠ è½½-&gt; éªŒè¯ -&gt; å‡†å¤‡ -&gt; è§£æ -&gt; åˆå§‹åŒ– è¿™å‡ ä¸ªé˜¶æ®µå®Œæˆåï¼Œå°±ä¼šç”¨åˆ°æ‰§è¡Œå¼•æ“å¯¹æˆ‘ä»¬çš„ç±»è¿›è¡Œä½¿ç”¨ï¼ŒåŒæ—¶æ‰§è¡Œå¼•æ“å°†ä¼šä½¿ç”¨åˆ°æˆ‘ä»¬è¿è¡Œæ—¶æ•°æ®åŒº</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705111843003.png" alt="image-20200705111843003"></p><p>ä¹Ÿå°±æ˜¯å¤§å¨åšé¥­ï¼Œæˆ‘ä»¬æŠŠå¤§å¨åé¢çš„ä¸œè¥¿ï¼ˆåˆ‡å¥½çš„èœï¼Œåˆ€ï¼Œè°ƒæ–™ï¼‰ï¼Œæ¯”ä½œæ˜¯è¿è¡Œæ—¶æ•°æ®åŒºã€‚è€Œå¨å¸ˆå¯ä»¥ç±»æ¯”äºæ‰§è¡Œå¼•æ“ï¼Œå°†é€šè¿‡å‡†å¤‡çš„ä¸œè¥¿è¿›è¡Œåˆ¶ä½œæˆç²¾ç¾çš„èœå“</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705112036630.png" alt="image-20200705112036630"></p><p>å†…å­˜æ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’ŒCPUçš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡ŒJVMå†…å­˜å¸ƒå±€è§„å®šäº†Javaåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚ä¸åŒçš„JVMå¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨ç€éƒ¨åˆ†å·®å¼‚ã€‚ç»“åˆJVMè™šæ‹Ÿæœºè§„èŒƒï¼Œæ¥æ¢è®¨ä¸€ä¸‹ç»å…¸çš„JVMå†…å­˜å¸ƒå±€ã€‚</p><blockquote><p>æˆ‘ä»¬é€šè¿‡ç£ç›˜æˆ–è€…ç½‘ç»œIOå¾—åˆ°çš„æ•°æ®ï¼Œéƒ½éœ€è¦å…ˆåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åCPUä»å†…å­˜ä¸­è·å–æ•°æ®è¿›è¡Œè¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´å†…å­˜å……å½“äº†CPUå’Œç£ç›˜ä¹‹é—´çš„æ¡¥æ¢</p></blockquote><p>è¿è¡Œæ—¶æ•°æ®åŒºçš„å®Œæ•´å›¾</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705112416101.png" alt="image-20200705112416101"></p><p>Javaè™šæ‹Ÿæœºå®šä¹‰äº†è‹¥å¹²ç§ç¨‹åºè¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œå…¶ä¸­æœ‰ä¸€äº›ä¼šéšç€è™šæ‹Ÿæœºå¯åŠ¨è€Œåˆ›å»ºï¼Œéšç€è™šæ‹Ÿæœºé€€å‡ºè€Œé”€æ¯ã€‚å¦å¤–ä¸€äº›åˆ™æ˜¯ä¸çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™äº›ä¸çº¿ç¨‹å¯¹åº”çš„æ•°æ®åŒºåŸŸä¼šéšç€çº¿ç¨‹å¼€å§‹å’Œç»“æŸè€Œåˆ›å»ºå’Œé”€æ¯ã€‚</p><p>ç°è‰²çš„ä¸ºå•ç‹¬çº¿ç¨‹ç§æœ‰çš„ï¼Œçº¢è‰²çš„ä¸ºå¤šä¸ªçº¿ç¨‹å…±äº«çš„ã€‚å³ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹ï¼šç‹¬ç«‹åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€æ ˆã€æœ¬åœ°æ ˆã€‚</li><li>çº¿ç¨‹é—´å…±äº«ï¼šå †ã€å †å¤–å†…å­˜ï¼ˆæ°¸ä¹…ä»£æˆ–å…ƒç©ºé—´ã€ä»£ç ç¼“å­˜ï¼‰</li></ul><p>!<img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705112601211.png" alt="image-20200705112601211"></p><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><p>çº¿ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºé‡Œçš„è¿è¡Œå•å…ƒã€‚JVMå…è®¸ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œçš„æ‰§è¡Œã€‚<br>åœ¨Hotspot JVMé‡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¸æ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ç›´æ¥æ˜ å°„ã€‚</p><ul><li>å½“ä¸€ä¸ªJavaçº¿ç¨‹å‡†å¤‡å¥½æ‰§è¡Œä»¥åï¼Œæ­¤æ—¶ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ä¹ŸåŒæ—¶åˆ›å»ºã€‚Javaçº¿ç¨‹æ‰§è¡Œç»ˆæ­¢åï¼Œæœ¬åœ°çº¿ç¨‹ä¹Ÿä¼šå›æ”¶ã€‚</li></ul><p>æ“ä½œç³»ç»Ÿè´Ÿè´£æ‰€æœ‰çº¿ç¨‹çš„å®‰æ’è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªå¯ç”¨çš„CPUä¸Šã€‚ä¸€æ—¦æœ¬åœ°çº¿ç¨‹åˆå§‹åŒ–æˆåŠŸï¼Œå®ƒå°±ä¼šè°ƒç”¨Javaçº¿ç¨‹ä¸­çš„runï¼ˆï¼‰æ–¹æ³•ã€‚</p><h3 id="JVMç³»ç»Ÿçº¿ç¨‹"><a href="#JVMç³»ç»Ÿçº¿ç¨‹" class="headerlink" title="JVMç³»ç»Ÿçº¿ç¨‹"></a>JVMç³»ç»Ÿçº¿ç¨‹</h3><p>å¦‚æœä½ ä½¿ç”¨consoleæˆ–è€…æ˜¯ä»»ä½•ä¸€ä¸ªè°ƒè¯•å·¥å…·ï¼Œéƒ½èƒ½çœ‹åˆ°åœ¨åå°æœ‰è®¸å¤šçº¿ç¨‹åœ¨è¿è¡Œã€‚è¿™äº›åå°çº¿ç¨‹ä¸åŒ…æ‹¬è°ƒç”¨public static void mainï¼ˆString[]ï¼‰çš„mainçº¿ç¨‹ä»¥åŠæ‰€æœ‰è¿™ä¸ªmainçº¿ç¨‹è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹ã€‚|<br>è¿™äº›ä¸»è¦çš„åå°ç³»ç»Ÿçº¿ç¨‹åœ¨Hotspot JVMé‡Œä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªï¼š</p><ul><li>è™šæ‹Ÿæœºçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹çš„æ“ä½œæ˜¯éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹æ‰ä¼šå‡ºç°ã€‚è¿™äº›æ“ä½œå¿…é¡»åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å‘ç”Ÿçš„åŸå› æ˜¯ä»–ä»¬éƒ½éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹ï¼Œè¿™æ ·å †æ‰ä¸ä¼šå˜åŒ–ã€‚è¿™ç§çº¿ç¨‹çš„æ‰§è¡Œç±»å‹åŒ…æ‹¬â€stop-the-worldâ€çš„åƒåœ¾æ”¶é›†ï¼Œçº¿ç¨‹æ ˆæ”¶é›†ï¼Œçº¿ç¨‹æŒ‚èµ·ä»¥åŠåå‘é”æ’¤é”€ã€‚</li><li>å‘¨æœŸä»»åŠ¡çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹æ˜¯æ—¶é—´å‘¨æœŸäº‹ä»¶çš„ä½“ç°ï¼ˆæ¯”å¦‚ä¸­æ–­ï¼‰ï¼Œä»–ä»¬ä¸€èˆ¬ç”¨äºå‘¨æœŸæ€§æ“ä½œçš„è°ƒåº¦æ‰§è¡Œã€‚</li><li>GCçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹å¯¹åœ¨JVMé‡Œä¸åŒç§ç±»çš„åƒåœ¾æ”¶é›†è¡Œä¸ºæä¾›äº†æ”¯æŒã€‚</li><li>ç¼–è¯‘çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå°†å­—èŠ‚ç ç¼–è¯‘æˆåˆ°æœ¬åœ°ä»£ç ã€‚</li><li>ä¿¡å·è°ƒåº¦çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹æ¥æ”¶ä¿¡å·å¹¶å‘é€ç»™JVMï¼Œåœ¨å®ƒå†…éƒ¨é€šè¿‡è°ƒç”¨é€‚å½“çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><h1 id="ç¬¬4ç« -ç¨‹åºè®¡æ•°å™¨"><a href="#ç¬¬4ç« -ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¬¬4ç«  ç¨‹åºè®¡æ•°å™¨"></a>ç¬¬4ç«  ç¨‹åºè®¡æ•°å™¨</h1><h2 id="1-ä»‹ç»"><a href="#1-ä»‹ç»" class="headerlink" title="1 ä»‹ç»"></a>1 ä»‹ç»</h2><p>JVMä¸­çš„ç¨‹åºè®¡æ•°å¯„å­˜å™¨ï¼ˆProgram Counter Registerï¼‰ä¸­ï¼ŒRegisterçš„å‘½åæºäºCPUçš„å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤ç›¸å…³çš„ç°åœºä¿¡æ¯ã€‚CPUåªæœ‰æŠŠæ•°æ®è£…è½½åˆ°å¯„å­˜å™¨æ‰èƒ½å¤Ÿè¿è¡Œã€‚è¿™é‡Œï¼Œå¹¶éæ˜¯å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼Œæˆ–è®¸å°†å…¶ç¿»è¯‘ä¸ºPCè®¡æ•°å™¨ï¼ˆæˆ–æŒ‡ä»¤è®¡æ•°å™¨ï¼‰ä¼šæ›´åŠ è´´åˆ‡ï¼ˆä¹Ÿç§°ä¸ºç¨‹åºé’©å­ï¼‰ï¼Œå¹¶ä¸”ä¹Ÿä¸å®¹æ˜“å¼•èµ·ä¸€äº›ä¸å¿…è¦çš„è¯¯ä¼šã€‚JVMä¸­çš„PCå¯„å­˜å™¨æ˜¯å¯¹ç‰©ç†PCå¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705155551919.png" alt="image-20200705155551919"></p><p>å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®°ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸã€‚</p><p>åœ¨JVMè§„èŒƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚</p><p>ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ã€‚ç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„Javaæ–¹æ³•çš„JVMæŒ‡ä»¤åœ°å€ï¼›æˆ–è€…ï¼Œå¦‚æœæ˜¯åœ¨æ‰§è¡Œnativeæ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼ï¼ˆundefnedï¼‰ã€‚</p><p>å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p><p>å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•outotMemoryErroræƒ…å†µçš„åŒºåŸŸã€‚</p><h2 id="2-ä½œç”¨"><a href="#2-ä½œç”¨" class="headerlink" title="2 ä½œç”¨"></a>2 ä½œç”¨</h2><p>PCå¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705155728557.png" alt="image-20200705155728557"></p><h2 id="3-ä»£ç æ¼”ç¤º"><a href="#3-ä»£ç æ¼”ç¤º" class="headerlink" title="3 ä»£ç æ¼”ç¤º"></a>3 ä»£ç æ¼”ç¤º</h2><p>æˆ‘ä»¬é¦–å…ˆå†™ä¸€ä¸ªç®€å•çš„ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PCRegisterTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">int</span> i = <span class="hljs-number">10</span>;        <span class="hljs-keyword">int</span> j = <span class="hljs-number">20</span>;        <span class="hljs-keyword">int</span> k = i + j;    &#125;&#125;</code></pre></div><p>ç„¶åå°†ä»£ç è¿›è¡Œç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œæˆ‘ä»¬å†æ¬¡æŸ¥çœ‹ ï¼Œå‘ç°åœ¨å­—èŠ‚ç çš„å·¦è¾¹æœ‰ä¸€ä¸ªè¡Œå·æ ‡è¯†ï¼Œå®ƒå…¶å®å°±æ˜¯æŒ‡ä»¤åœ°å€ï¼Œç”¨äºæŒ‡å‘å½“å‰æ‰§è¡Œåˆ°å“ªé‡Œã€‚</p><div class="code-wrapper"><pre><code class="hljs bash">0: bipush        102: istore_13: bipush        205: istore_26: iload_17: iload_28: iadd9: istore_310: <span class="hljs-built_in">return</span></code></pre></div><p>é€šè¿‡PCå¯„å­˜å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å½“å‰ç¨‹åºæ‰§è¡Œåˆ°å“ªä¸€æ­¥äº† </p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705161007423.png" alt="image-20200705161007423"></p><h2 id="4-ä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ"><a href="#4-ä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ" class="headerlink" title="4 ä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ"></a>4 ä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</h2><p>å› ä¸ºCPUéœ€è¦ä¸åœçš„åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™åˆ‡æ¢å›æ¥ä»¥åï¼Œå°±å¾—çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚</p><p>JVMçš„å­—èŠ‚ç è§£é‡Šå™¨å°±éœ€è¦é€šè¿‡æ”¹å˜PCå¯„å­˜å™¨çš„å€¼æ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705161409533.png" alt="image-20200705161409533"></p><h2 id="5-PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆè¢«è®¾å®šä¸ºç§æœ‰çš„ï¼Ÿ"><a href="#5-PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆè¢«è®¾å®šä¸ºç§æœ‰çš„ï¼Ÿ" class="headerlink" title="5 PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆè¢«è®¾å®šä¸ºç§æœ‰çš„ï¼Ÿ"></a>5 PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆè¢«è®¾å®šä¸ºç§æœ‰çš„ï¼Ÿ</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“æ‰€è°“çš„å¤šçº¿ç¨‹åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´æ®µå†…åªä¼šæ‰§è¡Œå…¶ä¸­æŸä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•ï¼ŒCPUä¼šä¸åœåœ°åšä»»åŠ¡åˆ‡æ¢ï¼Œè¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿä¸ºäº†èƒ½å¤Ÿå‡†ç¡®åœ°è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæœ€å¥½çš„åŠæ³•è‡ªç„¶æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œè¿™æ ·ä¸€æ¥å„ä¸ªçº¿ç¨‹ä¹‹é—´ä¾¿å¯ä»¥è¿›è¡Œç‹¬ç«‹è®¡ç®—ï¼Œä»è€Œä¸ä¼šå‡ºç°ç›¸äº’å¹²æ‰°çš„æƒ…å†µã€‚</p><p>ç”±äºCPUæ—¶é—´ç‰‡è½®é™åˆ¶ï¼Œä¼—å¤šçº¿ç¨‹åœ¨å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨ä¸­çš„ä¸€ä¸ªå†…æ ¸ï¼Œåªä¼šæ‰§è¡ŒæŸä¸ªçº¿ç¨‹ä¸­çš„ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>è¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿæ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºåï¼Œéƒ½ä¼šäº§ç”Ÿè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆå¸§ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705161812542.png" alt="image-20200705161812542"></p><h2 id="6-CPUæ—¶é—´ç‰‡"><a href="#6-CPUæ—¶é—´ç‰‡" class="headerlink" title="6 CPUæ—¶é—´ç‰‡"></a>6 CPUæ—¶é—´ç‰‡</h2><p>CPUæ—¶é—´ç‰‡å³CPUåˆ†é…ç»™å„ä¸ªç¨‹åºçš„æ—¶é—´ï¼Œæ¯ä¸ªçº¿ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ã€‚</p><p>åœ¨å®è§‚ä¸Šï¼šä¿„ä»¬å¯ä»¥åŒæ—¶æ‰“å¼€å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªç¨‹åºå¹¶è¡Œä¸æ‚–ï¼ŒåŒæ—¶è¿è¡Œã€‚</p><p>ä½†åœ¨å¾®è§‚ä¸Šï¼šç”±äºåªæœ‰ä¸€ä¸ªCPUï¼Œä¸€æ¬¡åªèƒ½å¤„ç†ç¨‹åºè¦æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚ä½•å¤„ç†å…¬å¹³ï¼Œä¸€ç§æ–¹æ³•å°±æ˜¯å¼•å…¥æ—¶é—´ç‰‡ï¼Œæ¯ä¸ªç¨‹åºè½®æµæ‰§è¡Œã€‚</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/4_%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8/images/image-20200705161849557.png" alt="image-20200705161849557"></p><h1 id="ç¬¬5ç« -è™šæ‹Ÿæœºæ ˆ"><a href="#ç¬¬5ç« -è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="ç¬¬5ç«  è™šæ‹Ÿæœºæ ˆ"></a>ç¬¬5ç«  è™šæ‹Ÿæœºæ ˆ</h1><h2 id="1-è™šæ‹Ÿæœºæ ˆæ¦‚è¿°"><a href="#1-è™šæ‹Ÿæœºæ ˆæ¦‚è¿°" class="headerlink" title="1 è™šæ‹Ÿæœºæ ˆæ¦‚è¿°"></a>1 è™šæ‹Ÿæœºæ ˆæ¦‚è¿°</h2><p>ç”±äºè·¨å¹³å°æ€§çš„è®¾è®¡ï¼ŒJavaçš„æŒ‡ä»¤éƒ½æ˜¯æ ¹æ®æ ˆæ¥è®¾è®¡çš„ã€‚ä¸åŒå¹³å°CPUæ¶æ„ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½è®¾è®¡ä¸ºåŸºäºå¯„å­˜å™¨çš„ã€‚<br>ä¼˜ç‚¹æ˜¯è·¨å¹³å°ï¼ŒæŒ‡ä»¤é›†å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°ï¼Œç¼ºç‚¹æ˜¯æ€§èƒ½ä¸‹é™ï¼Œå®ç°åŒæ ·çš„åŠŸèƒ½éœ€è¦æ›´å¤šçš„æŒ‡ä»¤ã€‚</p><p>æœ‰ä¸å°‘Javaå¼€å‘äººå‘˜ä¸€æåˆ°Javaå†…å­˜ç»“æ„ï¼Œå°±ä¼šéå¸¸ç²—ç²’åº¦åœ°å°†JVMä¸­çš„å†…å­˜åŒºç†è§£ä¸ºä»…æœ‰Javaå †ï¼ˆheapï¼‰å’ŒJavaæˆ˜ï¼ˆstackï¼‰ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</p><p>é¦–å…ˆæ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨çš„å•ä½</p><ul><li>æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚</li><li>å †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ï¼Œæ”¾å“ªé‡Œ</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705163928652.png" alt="image-20200705163928652"></p><h3 id="1-1-Javaè™šæ‹Ÿæœºæ ˆæ˜¯ä»€ä¹ˆ"><a href="#1-1-Javaè™šæ‹Ÿæœºæ ˆæ˜¯ä»€ä¹ˆ" class="headerlink" title="1.1 Javaè™šæ‹Ÿæœºæ ˆæ˜¯ä»€ä¹ˆ"></a>1.1 Javaè™šæ‹Ÿæœºæ ˆæ˜¯ä»€ä¹ˆ</h3><p>Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stackï¼‰ï¼Œæ—©æœŸä¹Ÿå«Javaæ ˆã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§ï¼ˆStack Frameï¼‰ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„Javaæ–¹æ³•è°ƒç”¨ã€‚</p><blockquote><p>æ˜¯çº¿ç¨‹ç§æœ‰çš„</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705164722033.png" alt="image-20200705164722033"></p><h3 id="1-2-ç”Ÿå‘½å‘¨æœŸ"><a href="#1-2-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="1.2 ç”Ÿå‘½å‘¨æœŸ"></a>1.2 ç”Ÿå‘½å‘¨æœŸ</h3><p>ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ç»“æŸäº†ï¼Œè¯¥è™šæ‹Ÿæœºæ ˆä¹Ÿé”€æ¯äº†</p><h3 id="1-3-ä½œç”¨"><a href="#1-3-ä½œç”¨" class="headerlink" title="1.3 ä½œç”¨"></a>1.3 ä½œç”¨</h3><p>ä¸»ç®¡Javaç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚</p><blockquote><p>å±€éƒ¨å˜é‡ï¼Œå®ƒæ˜¯ç›¸æ¯”äºæˆå‘˜å˜é‡æ¥è¯´çš„ï¼ˆæˆ–å±æ€§ï¼‰</p><p>åŸºæœ¬æ•°æ®ç±»å‹å˜é‡ VS  å¼•ç”¨ç±»å‹å˜é‡ï¼ˆç±»ã€æ•°ç»„ã€æ¥å£ï¼‰</p></blockquote><h3 id="1-4-æ ˆçš„ç‰¹ç‚¹"><a href="#1-4-æ ˆçš„ç‰¹ç‚¹" class="headerlink" title="1.4 æ ˆçš„ç‰¹ç‚¹"></a>1.4 æ ˆçš„ç‰¹ç‚¹</h3><p>æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨ã€‚JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼š</p><ul><li>æ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€è¿›æ ˆï¼ˆå…¥æ ˆã€å‹æ ˆï¼‰</li><li>æ‰§è¡Œç»“æŸåçš„å‡ºæ ˆå·¥ä½œ</li></ul><p>å¯¹äºæ ˆæ¥è¯´ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜ï¼ˆæ ˆå­˜åœ¨æº¢å‡ºçš„æƒ…å†µï¼‰</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705165025382.png" alt="image-20200705165025382"></p><h3 id="1-5-å¼€å‘ä¸­é‡åˆ°å“ªäº›å¼‚å¸¸ï¼Ÿ"><a href="#1-5-å¼€å‘ä¸­é‡åˆ°å“ªäº›å¼‚å¸¸ï¼Ÿ" class="headerlink" title="1.5 å¼€å‘ä¸­é‡åˆ°å“ªäº›å¼‚å¸¸ï¼Ÿ"></a>1.5 å¼€å‘ä¸­é‡åˆ°å“ªäº›å¼‚å¸¸ï¼Ÿ</h3><p>æ ˆä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸</p><p>Java è™šæ‹Ÿæœºè§„èŒƒå…è®¸Javaæ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…æ˜¯å›ºå®šä¸å˜çš„ã€‚</p><p>å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„Javaè™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸€ä¸ªçº¿ç¨‹çš„Javaè™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡Javaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªStackoverflowError å¼‚å¸¸ã€‚</p><p>å¦‚æœJavaè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£Javaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª outofMemoryError å¼‚å¸¸ã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackErrorTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">1</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        System.out.println(count++);        main(args);    &#125;&#125;</code></pre></div><p>å½“æ ˆæ·±åº¦è¾¾åˆ°9872çš„æ—¶å€™ï¼Œå°±å‡ºç°æ ˆå†…å­˜ç©ºé—´ä¸è¶³</p><h3 id="1-6-è®¾ç½®æ ˆå†…å­˜å¤§å°"><a href="#1-6-è®¾ç½®æ ˆå†…å­˜å¤§å°" class="headerlink" title="1.6 è®¾ç½®æ ˆå†…å­˜å¤§å°"></a>1.6 è®¾ç½®æ ˆå†…å­˜å¤§å°</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•° -Xssé€‰é¡¹æ¥è®¾ç½®çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´ï¼Œæ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦</p><div class="code-wrapper"><pre><code class="hljs shell">-Xss1m-Xss1k</code></pre></div><h2 id="2-æ ˆçš„å­˜å‚¨å•ä½"><a href="#2-æ ˆçš„å­˜å‚¨å•ä½" class="headerlink" title="2 æ ˆçš„å­˜å‚¨å•ä½"></a>2 æ ˆçš„å­˜å‚¨å•ä½</h2><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥æ ˆå¸§ï¼ˆStack Frameï¼‰çš„æ ¼å¼å­˜åœ¨ã€‚</p><p>åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚</p><p>æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚</p><h3 id="2-1-æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ"><a href="#2-1-æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1 æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ"></a>2.1 æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ</h3><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥æ ˆå¸§ï¼ˆStack Frameï¼‰çš„æ ¼å¼å­˜åœ¨ã€‚åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆé¢œï¼ˆStack Frameï¼‰ã€‚æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚</p><blockquote><p>OOPçš„åŸºæœ¬æ¦‚å¿µï¼šç±»å’Œå¯¹è±¡</p><p>ç±»ä¸­åŸºæœ¬ç»“æ„ï¼šfieldï¼ˆå±æ€§ã€å­—æ®µã€åŸŸï¼‰ã€method</p></blockquote><p>JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å¯¹æ ˆå¸§çš„å‹æ ˆå’Œå‡ºæ ˆï¼Œéµå¾ªâ€œå…ˆè¿›åå‡ºâ€/â€œåè¿›å…ˆå‡ºâ€åŸåˆ™ã€‚</p><p>åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆæ ˆé¡¶æ ˆå¸§ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸ºå½“å‰æ ˆå¸§ï¼ˆCurrent Frameï¼‰ï¼Œä¸å½“å‰æ ˆå¸§ç›¸å¯¹åº”çš„æ–¹æ³•å°±æ˜¯å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯å½“å‰ç±»ï¼ˆCurrent Classï¼‰ã€‚</p><p>æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚</p><p>å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œæˆä¸ºæ–°çš„å½“å‰å¸§ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705203142545.png" alt="image-20200705203142545"></p><p>ä¸‹é¢å†™ä¸€ä¸ªç®€å•çš„ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackFrameTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        method01();    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">method01</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;æ–¹æ³•1çš„å¼€å§‹&quot;</span>);        <span class="hljs-keyword">int</span> i = method02();        System.out.println(<span class="hljs-string">&quot;æ–¹æ³•1çš„ç»“æŸ&quot;</span>);        <span class="hljs-keyword">return</span> i;    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">method02</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;æ–¹æ³•2çš„å¼€å§‹&quot;</span>);        <span class="hljs-keyword">int</span> i = method03();;        System.out.println(<span class="hljs-string">&quot;æ–¹æ³•2çš„ç»“æŸ&quot;</span>);        <span class="hljs-keyword">return</span> i;    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">method03</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;æ–¹æ³•3çš„å¼€å§‹&quot;</span>);        <span class="hljs-keyword">int</span> i = <span class="hljs-number">30</span>;        System.out.println(<span class="hljs-string">&quot;æ–¹æ³•3çš„ç»“æŸ&quot;</span>);        <span class="hljs-keyword">return</span> i;    &#125;&#125;</code></pre></div><p>è¾“å‡ºç»“æœä¸º</p><div class="code-wrapper"><pre><code class="hljs bash">æ–¹æ³•1çš„å¼€å§‹æ–¹æ³•2çš„å¼€å§‹æ–¹æ³•3çš„å¼€å§‹æ–¹æ³•3çš„ç»“æŸæ–¹æ³•2çš„ç»“æŸæ–¹æ³•1çš„ç»“æŸ</code></pre></div><p>æ»¡è¶³æ ˆå…ˆè¿›åå‡ºçš„æ¦‚å¿µï¼Œé€šè¿‡Ideaçš„ DEBUGï¼Œèƒ½å¤Ÿçœ‹åˆ°æ ˆä¿¡æ¯</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705203916023.png" alt="image-20200705203916023"></p><h3 id="2-2-æ ˆè¿è¡ŒåŸç†"><a href="#2-2-æ ˆè¿è¡ŒåŸç†" class="headerlink" title="2.2 æ ˆè¿è¡ŒåŸç†"></a>2.2 æ ˆè¿è¡ŒåŸç†</h3><p>ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¹‹ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§ã€‚</p><p>å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§ã€‚</p><p>Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤ï¼›å¦å¤–ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚</p><h3 id="2-3-æ ˆå¸§çš„å†…éƒ¨ç»“æ„"><a href="#2-3-æ ˆå¸§çš„å†…éƒ¨ç»“æ„" class="headerlink" title="2.3 æ ˆå¸§çš„å†…éƒ¨ç»“æ„"></a>2.3 æ ˆå¸§çš„å†…éƒ¨ç»“æ„</h3><p>æ¯ä¸ªæ ˆå¸§ä¸­å­˜å‚¨ç€ï¼š</p><ul><li>å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰</li><li>æ“ä½œæ•°æ ˆï¼ˆoperand Stackï¼‰ï¼ˆæˆ–è¡¨è¾¾å¼æ ˆï¼‰</li><li>åŠ¨æ€é“¾æ¥ï¼ˆDynamicLinkingï¼‰ï¼ˆæˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ï¼‰</li><li>æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼ˆæˆ–æ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–è€…å¼‚å¸¸é€€å‡ºçš„å®šä¹‰ï¼‰</li><li>ä¸€äº›é™„åŠ ä¿¡æ¯</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705204836977.png" alt="image-20200705204836977"></p><p>å¹¶è¡Œæ¯ä¸ªçº¿ç¨‹ä¸‹çš„æ ˆéƒ½æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±å„è‡ªçš„æ ˆï¼Œå¹¶ä¸”æ¯ä¸ªæ ˆé‡Œé¢éƒ½æœ‰å¾ˆå¤šæ ˆå¸§ï¼Œæ ˆå¸§çš„å¤§å°ä¸»è¦ç”±å±€éƒ¨å˜é‡è¡¨ å’Œ æ“ä½œæ•°æ ˆå†³å®šçš„</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705205443993.png" alt="image-20200705205443993"></p><h2 id="3-å±€éƒ¨å˜é‡è¡¨"><a href="#3-å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="3 å±€éƒ¨å˜é‡è¡¨"></a>3 å±€éƒ¨å˜é‡è¡¨</h2><p>å±€éƒ¨å˜é‡è¡¨ï¼šLocal Variablesï¼Œè¢«ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨</p><p>å®šä¹‰ä¸ºä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡è¿™äº›æ•°æ®ç±»å‹åŒ…æ‹¬å„ç±»åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceï¼‰ï¼Œä»¥åŠreturnAddressç±»å‹ã€‚</p><p>ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜</p><p>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šä¸‹æ¥çš„ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesæ•°æ®é¡¹ä¸­ã€‚åœ¨æ–¹æ³•è¿è¡ŒæœŸé—´æ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„ã€‚</p><p>æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æ¬¡æ•°ç”±æ ˆçš„å¤§å°å†³å®šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ˆè¶Šå¤§ï¼Œæ–¹æ³•åµŒå¥—è°ƒç”¨æ¬¡æ•°è¶Šå¤šã€‚å¯¹ä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒçš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¶Šå¤šï¼Œä½¿å¾—å±€éƒ¨å˜é‡è¡¨è†¨èƒ€ï¼Œå®ƒçš„æ ˆå¸§å°±è¶Šå¤§ï¼Œä»¥æ»¡è¶³æ–¹æ³•è°ƒç”¨æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯å¢å¤§çš„éœ€æ±‚ã€‚è¿›è€Œå‡½æ•°è°ƒç”¨å°±ä¼šå ç”¨æ›´å¤šçš„æ ˆç©ºé—´ï¼Œå¯¼è‡´å…¶åµŒå¥—è°ƒç”¨æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚</p><p>å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯ã€‚</p><h3 id="3-1-å…³äºSlotçš„ç†è§£"><a href="#3-1-å…³äºSlotçš„ç†è§£" class="headerlink" title="3.1 å…³äºSlotçš„ç†è§£"></a>3.1 å…³äºSlotçš„ç†è§£</h3><p>å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„index0å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦-1çš„ç´¢å¼•ç»“æŸã€‚</p><p>å±€éƒ¨å˜é‡è¡¨ï¼Œæœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slotï¼ˆå˜é‡æ§½ï¼‰å±€éƒ¨å˜é‡è¡¨ä¸­å­˜æ”¾ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ8ç§ï¼‰ï¼Œå¼•ç”¨ç±»å‹ï¼ˆreferenceï¼‰ï¼ŒreturnAddressç±»å‹çš„å˜é‡ã€‚</p><p>åœ¨å±€éƒ¨å˜é‡è¡¨é‡Œï¼Œ32ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ªslotï¼ˆåŒ…æ‹¬returnAddressç±»å‹ï¼‰ï¼Œ64ä½çš„ç±»å‹ï¼ˆ1ongå’Œdoubleï¼‰å ç”¨ä¸¤ä¸ªslotã€‚</p><blockquote><p>byteã€shortã€char åœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºintï¼Œbooleanä¹Ÿè¢«è½¬æ¢ä¸ºintï¼Œ0è¡¨ç¤ºfalseï¼Œé0è¡¨ç¤ºtrueã€‚<br>1ongå’Œdoubleåˆ™å æ®ä¸¤ä¸ªslotã€‚</p></blockquote><p>JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼</p><p>å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼šæŒ‰ç…§é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªslotä¸Š</p><p>å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚ï¼ˆæ¯”å¦‚ï¼šè®¿é—®1ongæˆ–doub1eç±»å‹å˜é‡ï¼‰</p><p>å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„s1otå¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åˆ—ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705212454445.png" alt="image-20200705212454445"></p><h3 id="3-2-Slotçš„é‡å¤åˆ©ç”¨"><a href="#3-2-Slotçš„é‡å¤åˆ©ç”¨" class="headerlink" title="3.2 Slotçš„é‡å¤åˆ©ç”¨"></a>3.2 Slotçš„é‡å¤åˆ©ç”¨</h3><p>æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200705213106749.png" alt="image-20200705213106749"></p><h3 id="3-3-é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”"><a href="#3-3-é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”" class="headerlink" title="3.3 é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”"></a>3.3 é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”</h3><p>å˜é‡çš„åˆ†ç±»ï¼š</p><ul><li>æŒ‰æ•°æ®ç±»å‹åˆ†ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å¼•ç”¨æ•°æ®ç±»å‹</li><li>æŒ‰ç±»ä¸­å£°æ˜çš„ä½ç½®åˆ†ï¼šæˆå‘˜å˜é‡ï¼ˆç±»å˜é‡ï¼Œå®ä¾‹å˜é‡ï¼‰ã€å±€éƒ¨å˜é‡<ul><li>ç±»å˜é‡ï¼šlinkingçš„paperé˜¶æ®µï¼Œç»™ç±»å˜é‡é»˜è®¤èµ‹å€¼ï¼Œinité˜¶æ®µç»™ç±»å˜é‡æ˜¾ç¤ºèµ‹å€¼å³é™æ€ä»£ç å—</li><li>å®ä¾‹å˜é‡ï¼šéšç€å¯¹è±¡åˆ›å»ºï¼Œä¼šåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼</li><li>å±€éƒ¨å˜é‡ï¼šåœ¨ä½¿ç”¨å‰å¿…é¡»è¿›è¡Œæ˜¾å¼èµ‹å€¼ï¼Œä¸ç„¶ç¼–è¯‘ä¸é€šè¿‡ã€‚</li></ul></li></ul><p>å‚æ•°è¡¨åˆ†é…å®Œæ¯•ä¹‹åï¼Œå†æ ¹æ®æ–¹æ³•ä½“å†…å®šä¹‰çš„å˜é‡çš„é¡ºåºå’Œä½œç”¨åŸŸåˆ†é…ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ç±»å˜é‡è¡¨æœ‰ä¸¤æ¬¡åˆå§‹åŒ–çš„æœºä¼šï¼Œç¬¬ä¸€æ¬¡æ˜¯åœ¨â€œå‡†å¤‡é˜¶æ®µâ€ï¼Œæ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¯¹ç±»å˜é‡è®¾ç½®é›¶å€¼ï¼Œå¦ä¸€æ¬¡åˆ™æ˜¯åœ¨â€œåˆå§‹åŒ–â€é˜¶æ®µï¼Œèµ‹äºˆç¨‹åºå‘˜åœ¨ä»£ç ä¸­å®šä¹‰çš„åˆå§‹å€¼ã€‚</p><p>å’Œç±»å˜é‡åˆå§‹åŒ–ä¸åŒçš„æ˜¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¸å­˜åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦å®šä¹‰äº†å±€éƒ¨å˜é‡åˆ™å¿…é¡»äººä¸ºçš„åˆå§‹åŒ–ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ã€‚</p><p>åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„éƒ¨åˆ†å°±æ˜¯å‰é¢æåˆ°çš„å±€éƒ¨å˜é‡è¡¨ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’ã€‚</p><p>å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ã€‚</p><h2 id="4-æ“ä½œæ•°æ ˆ"><a href="#4-æ“ä½œæ•°æ ˆ" class="headerlink" title="4 æ“ä½œæ•°æ ˆ"></a>4 æ“ä½œæ•°æ ˆ</h2><h3 id="4-1-æ¦‚å¿µ"><a href="#4-1-æ¦‚å¿µ" class="headerlink" title="4.1 æ¦‚å¿µ"></a>4.1 æ¦‚å¿µ</h3><p>æ“ä½œæ•°æ ˆï¼šOperand Stack</p><p>æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ ˆå¸§é™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨ä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªåè¿›å…ˆå‡ºï¼ˆLast - In - First -Outï¼‰çš„ <strong>æ“ä½œæ•°æ ˆ</strong>ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸º <strong>è¡¨è¾¾å¼æ ˆ</strong>ï¼ˆExpression Stackï¼‰</p><p>æ“ä½œæ•°æ ˆï¼Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆï¼ˆpushï¼‰å’Œ å‡ºæ ˆï¼ˆpopï¼‰</p><ul><li>æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆ</li><li>æ¯”å¦‚ï¼šæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œ</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706090618332.png" alt="image-20200706090618332"></p><p>ä»£ç ä¸¾ä¾‹</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706090833697.png" alt="image-20200706090833697"></p><p>æ“ä½œæ•°æ ˆï¼Œä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ã€‚</p><p>æ“ä½œæ•°æ ˆå°±æ˜¯JVMæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ã€‚.</p><blockquote><p>è¿™ä¸ªæ—¶å€™æ•°ç»„æ˜¯æœ‰é•¿åº¦çš„ï¼Œå› ä¸ºæ•°ç»„ä¸€æ—¦åˆ›å»ºï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯å˜çš„</p></blockquote><p>æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§ä¸­ï¼Œä¸ºmaxstackçš„å€¼ã€‚</p><p>æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å¯ä»¥ä»»æ„çš„Javaæ•°æ®ç±»å‹</p><ul><li>32bitçš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦</li><li>64bitçš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦</li></ul><p>æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®</p><p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p><p>æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘å™¨æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯ã€‚|</p><p>å¦å¤–ï¼Œæˆ‘ä»¬è¯´Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆã€‚</p><h3 id="4-2-ä»£ç è¿½è¸ª"><a href="#4-2-ä»£ç è¿½è¸ª" class="headerlink" title="4.2 ä»£ç è¿½è¸ª"></a>4.2 ä»£ç è¿½è¸ª</h3><p>æˆ‘ä»¬ç»™å®šä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddOperation</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">byte</span> i = <span class="hljs-number">15</span>;    <span class="hljs-keyword">int</span> j = <span class="hljs-number">8</span>;    <span class="hljs-keyword">int</span> k = i + j;&#125;</code></pre></div><p>ä½¿ç”¨javap å‘½ä»¤åç¼–è¯‘classæ–‡ä»¶ï¼š javap -v ç±»å.class</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706092610730.png" alt="image-20200706092610730"></p><blockquote><p>byteã€shortã€charã€boolean å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨intå‹æ¥è¿›è¡Œä¿å­˜çš„</p><p>ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡bipushå¯¹æ“ä½œæ•° 15 å’Œ  8è¿›è¡Œå…¥æ ˆæ“ä½œ</p><p>åŒæ—¶ä½¿ç”¨çš„æ˜¯ iaddæ–¹æ³•è¿›è¡Œç›¸åŠ æ“ä½œï¼Œi -&gt; ä»£è¡¨çš„å°±æ˜¯ intï¼Œä¹Ÿå°±æ˜¯intç±»å‹çš„åŠ æ³•æ“ä½œ</p></blockquote><p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>é¦–å…ˆæ‰§è¡Œç¬¬ä¸€æ¡è¯­å¥ï¼ŒPCå¯„å­˜å™¨æŒ‡å‘çš„æ˜¯0ï¼Œä¹Ÿå°±æ˜¯æŒ‡ä»¤åœ°å€ä¸º0ï¼Œç„¶åä½¿ç”¨bipushè®©æ“ä½œæ•°15å…¥æ ˆã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706093131621.png" alt="image-20200706093131621"></p><p>æ‰§è¡Œå®Œåï¼Œè®©PC + 1ï¼ŒæŒ‡å‘ä¸‹ä¸€è¡Œä»£ç ï¼Œä¸‹ä¸€è¡Œä»£ç å°±æ˜¯å°†æ“ä½œæ•°æ ˆçš„å…ƒç´ å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨1çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å±€éƒ¨å˜é‡è¡¨çš„å·²ç»å¢åŠ äº†ä¸€ä¸ªå…ƒç´ </p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706093251302.png" alt="image-20200706093251302"></p><blockquote><p>ä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡è¡¨ä¸æ˜¯ä»0å¼€å§‹çš„å‘¢ï¼Ÿ</p><p>å…¶å®å±€éƒ¨å˜é‡è¡¨ä¹Ÿæ˜¯ä»0å¼€å§‹çš„ï¼Œä½†æ˜¯å› ä¸º0å·ä½ç½®å­˜å‚¨çš„æ˜¯thisæŒ‡é’ˆï¼Œæ‰€ä»¥è¯´å°±ç›´æ¥çœç•¥äº†~</p></blockquote><p>ç„¶åPC+1ï¼ŒæŒ‡å‘çš„æ˜¯ä¸‹ä¸€è¡Œã€‚è®©æ“ä½œæ•°8ä¹Ÿå…¥æ ˆï¼ŒåŒæ—¶æ‰§è¡Œstoreæ“ä½œï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706093646406.png" alt="image-20200706093646406"></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706093751711.png" alt="image-20200706093751711"></p><p>ç„¶åä»å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œä¾æ¬¡å°†æ•°æ®æ”¾åœ¨æ“ä½œæ•°æ ˆä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706093859191.png" alt="image-20200706093859191"></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706093921573.png" alt="image-20200706093921573"></p><p>ç„¶åå°†æ“ä½œæ•°æ ˆä¸­çš„ä¸¤ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŠ æ“ä½œï¼Œå¹¶å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨3çš„ä½ç½®</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706094046782.png" alt="image-20200706094046782"></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706094109629.png" alt="image-20200706094109629"></p><p>æœ€åPCå¯„å­˜å™¨çš„ä½ç½®æŒ‡å‘10ï¼Œä¹Ÿå°±æ˜¯returnæ–¹æ³•ï¼Œåˆ™ç›´æ¥é€€å‡ºæ–¹æ³•</p><p>i++å’Œ++içš„åŒºåˆ«</p><h2 id="5-æ ˆé¡¶ç¼“å­˜æŠ€æœ¯"><a href="#5-æ ˆé¡¶ç¼“å­˜æŠ€æœ¯" class="headerlink" title="5 æ ˆé¡¶ç¼“å­˜æŠ€æœ¯"></a>5 æ ˆé¡¶ç¼“å­˜æŠ€æœ¯</h2><p>æ ˆé¡¶ç¼“å­˜æŠ€æœ¯ï¼šTop Of Stack Cashing</p><p>å‰é¢æè¿‡ï¼ŒåŸºäºæ ˆå¼æ¶æ„çš„è™šæ‹Ÿæœºæ‰€ä½¿ç”¨çš„é›¶åœ°å€æŒ‡ä»¤æ›´åŠ ç´§å‡‘ï¼Œä½†å®Œæˆä¸€é¡¹æ“ä½œçš„æ—¶å€™å¿…ç„¶éœ€è¦ä½¿ç”¨æ›´å¤šçš„å…¥æ ˆå’Œå‡ºæ ˆæŒ‡ä»¤ï¼Œè¿™åŒæ—¶ä¹Ÿå°±æ„å‘³ç€å°†éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾ï¼ˆinstruction dispatchï¼‰æ¬¡æ•°å’Œå†…å­˜è¯»/å†™æ¬¡æ•°ã€‚</p><p>ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»/å†™æ“ä½œå¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMçš„è®¾è®¡è€…ä»¬æå‡ºäº†æ ˆé¡¶ç¼“å­˜ï¼ˆTosï¼ŒTop-of-Stack Cashingï¼‰æŠ€æœ¯ï¼Œå°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»/å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡ã€‚</p><blockquote><p>å¯„å­˜å™¨ï¼šæŒ‡ä»¤æ›´å°‘ï¼Œæ‰§è¡Œé€Ÿåº¦å¿«</p></blockquote><h2 id="6-åŠ¨æ€é“¾æ¥"><a href="#6-åŠ¨æ€é“¾æ¥" class="headerlink" title="6 åŠ¨æ€é“¾æ¥"></a>6 åŠ¨æ€é“¾æ¥</h2><p>åŠ¨æ€é“¾æ¥ï¼šDynamic Linking</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706100311886.png" alt="image-20200706100311886"></p><blockquote><p>åŠ¨æ€é“¾æ¥ã€æ–¹æ³•è¿”å›åœ°å€ã€é™„åŠ ä¿¡æ¯ ï¼š æœ‰äº›åœ°æ–¹è¢«ç§°ä¸ºå¸§æ•°æ®åŒº</p></blockquote><p>æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘<strong>è¿è¡Œæ—¶å¸¸é‡æ± </strong>ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ã€‚æ¯”å¦‚ï¼šinvokedynamicæŒ‡ä»¤</p><p>åœ¨Javaæºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ï¼ˆsymbolic Referenceï¼‰ä¿å­˜åœ¨classæ–‡ä»¶çš„å¸¸é‡æ± é‡Œã€‚</p><p>æ¯”å¦‚ï¼šæè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706101251847.png" alt="image-20200706101251847"></p><blockquote><p>ä¸ºä»€ä¹ˆéœ€è¦è¿è¡Œæ—¶å¸¸é‡æ± ï¼Ÿ</p><p>å› ä¸ºåœ¨ä¸åŒçš„æ–¹æ³•ï¼Œéƒ½å¯èƒ½è°ƒç”¨å¸¸é‡æˆ–è€…æ–¹æ³•ï¼Œæ‰€ä»¥åªéœ€è¦å­˜å‚¨ä¸€ä»½å³å¯ï¼ŒèŠ‚çœäº†ç©ºé—´</p><p>å¸¸é‡æ± çš„ä½œç”¨ï¼šå°±æ˜¯ä¸ºäº†æä¾›ä¸€äº›ç¬¦å·å’Œå¸¸é‡ï¼Œä¾¿äºæŒ‡ä»¤çš„è¯†åˆ«</p></blockquote><h2 id="7-æ–¹æ³•è°ƒç”¨ï¼šè§£æä¸åˆ†é…"><a href="#7-æ–¹æ³•è°ƒç”¨ï¼šè§£æä¸åˆ†é…" class="headerlink" title="7 æ–¹æ³•è°ƒç”¨ï¼šè§£æä¸åˆ†é…"></a>7 æ–¹æ³•è°ƒç”¨ï¼šè§£æä¸åˆ†é…</h2><p>åœ¨JVMä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ç›¸å…³</p><h3 id="7-1-é“¾æ¥"><a href="#7-1-é“¾æ¥" class="headerlink" title="7.1 é“¾æ¥"></a>7.1 é“¾æ¥</h3><h4 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h4><p>å½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸè¢«ç¡®å®šï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œè¿™ç§æƒ…å†µä¸‹é™è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥</p><h4 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h4><p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨çš„æ–¹æ³•çš„ç¬¦å·è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚</p><h3 id="7-2-ç»‘å®šæœºåˆ¶"><a href="#7-2-ç»‘å®šæœºåˆ¶" class="headerlink" title="7.2 ç»‘å®šæœºåˆ¶"></a>7.2 ç»‘å®šæœºåˆ¶</h3><p>å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼šæ—©æœŸç»‘å®šï¼ˆEarly Bindingï¼‰å’Œæ™šæœŸç»‘å®šï¼ˆLate Bindingï¼‰ã€‚ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡ã€‚</p><h4 id="æ—©æœŸç»‘å®š"><a href="#æ—©æœŸç»‘å®š" class="headerlink" title="æ—©æœŸç»‘å®š"></a>æ—©æœŸç»‘å®š</h4><p>æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p><h4 id="æ™šæœŸç»‘å®š"><a href="#æ™šæœŸç»‘å®š" class="headerlink" title="æ™šæœŸç»‘å®š"></a>æ™šæœŸç»‘å®š</h4><p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºæ™šæœŸç»‘å®šã€‚</p><h3 id="æ—©æ™šæœŸç»‘å®šçš„å‘å±•å†å²"><a href="#æ—©æ™šæœŸç»‘å®šçš„å‘å±•å†å²" class="headerlink" title="æ—©æ™šæœŸç»‘å®šçš„å‘å±•å†å²"></a>æ—©æ™šæœŸç»‘å®šçš„å‘å±•å†å²</h3><p>éšç€é«˜çº§è¯­è¨€çš„æ¨ªç©ºå‡ºä¸–ï¼Œç±»ä¼¼äºJavaä¸€æ ·çš„åŸºäºé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€å¦‚ä»Šè¶Šæ¥è¶Šå¤šï¼Œå°½ç®¡è¿™ç±»ç¼–ç¨‹è¯­è¨€åœ¨è¯­æ³•é£æ ¼ä¸Šå­˜åœ¨ä¸€å®šçš„å·®åˆ«ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´å§‹ç»ˆä¿æŒç€ä¸€ä¸ªå…±æ€§ï¼Œé‚£å°±æ˜¯éƒ½æ”¯æŒå°è£…ã€ç»§æ‰¿å’Œå¤šæ€ç­‰é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œæ—¢ç„¶è¿™ä¸€ç±»çš„ç¼–ç¨‹è¯­è¨€å…·å¤‡å¤šæ€ç‰¹æ€§ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå°±å…·å¤‡æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šä¸¤ç§ç»‘å®šæ–¹å¼ã€‚</p><p>Javaä¸­ä»»ä½•ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•å…¶å®éƒ½å…·å¤‡è™šå‡½æ•°çš„ç‰¹å¾ï¼Œå®ƒä»¬ç›¸å½“äºC++è¯­è¨€ä¸­çš„è™šå‡½æ•°ï¼ˆC++ä¸­åˆ™éœ€è¦ä½¿ç”¨å…³é”®å­—virtualæ¥æ˜¾å¼å®šä¹‰ï¼‰ã€‚å¦‚æœåœ¨Javaç¨‹åºä¸­ä¸å¸Œæœ›æŸä¸ªæ–¹æ³•æ‹¥æœ‰è™šå‡½æ•°çš„ç‰¹å¾æ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å…³é”®å­—finalæ¥æ ‡è®°è¿™ä¸ªæ–¹æ³•ã€‚</p><h3 id="7-3-è™šæ–¹æ³•å’Œéè™šæ–¹æ³•"><a href="#7-3-è™šæ–¹æ³•å’Œéè™šæ–¹æ³•" class="headerlink" title="7.3 è™šæ–¹æ³•å’Œéè™šæ–¹æ³•"></a>7.3 è™šæ–¹æ³•å’Œéè™šæ–¹æ³•</h3><ul><li>å¦‚æœæ–¹æ³•åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ã€‚è¿™æ ·çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ã€‚</li><li>é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€finalæ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•ã€‚</li><li>å…¶ä»–æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•ã€‚</li></ul><blockquote><p>å­ç±»å¯¹è±¡çš„å¤šæ€çš„ä½¿ç”¨å‰æ</p><ul><li>ç±»çš„ç»§æ‰¿å…³ç³»</li><li>æ–¹æ³•çš„é‡å†™</li></ul></blockquote><p>è™šæ‹Ÿæœºä¸­æä¾›äº†ä»¥ä¸‹å‡ æ¡æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ï¼š</p><h4 id="æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š"><a href="#æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š" class="headerlink" title="æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š"></a>æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š</h4><ul><li>invokestaticï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬</li><li>invokespecialï¼šè°ƒç”¨<init>æ–¹æ³•ã€ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬</init></li><li>invokevirtualï¼šè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•</li><li>invokeinterfaceï¼šè°ƒç”¨æ¥å£æ–¹æ³•</li></ul><h4 id="åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š"><a href="#åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š" class="headerlink" title="åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š"></a>åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š</h4><ul><li>invokedynamicï¼šåŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ</li></ul><p>å‰å››æ¡æŒ‡ä»¤å›ºåŒ–åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯äººä¸ºå¹²é¢„ï¼Œè€ŒinvokedynamicæŒ‡ä»¤åˆ™æ”¯æŒç”±ç”¨æˆ·ç¡®å®šæ–¹æ³•ç‰ˆæœ¬ã€‚å…¶ä¸­invokestaticæŒ‡ä»¤å’ŒinvokespecialæŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ï¼Œå…¶ä½™çš„ï¼ˆfina1ä¿®é¥°çš„é™¤å¤–ï¼‰ç§°ä¸ºè™šæ–¹æ³•ã€‚</p><h3 id="7-4-invokedynamicæŒ‡ä»¤"><a href="#7-4-invokedynamicæŒ‡ä»¤" class="headerlink" title="7.4 invokedynamicæŒ‡ä»¤"></a>7.4 invokedynamicæŒ‡ä»¤</h3><p>JVMå­—èŠ‚ç æŒ‡ä»¤é›†ä¸€ç›´æ¯”è¾ƒç¨³å®šï¼Œä¸€ç›´åˆ°Java7ä¸­æ‰å¢åŠ äº†ä¸€ä¸ªinvokedynamicæŒ‡ä»¤ï¼Œè¿™æ˜¯Javaä¸ºäº†å®ç°åŠ¨æ€ç±»å‹è¯­è¨€ã€‘æ”¯æŒè€Œåšçš„ä¸€ç§æ”¹è¿›ã€‚</p><p>ä½†æ˜¯åœ¨Java7ä¸­å¹¶æ²¡æœ‰æä¾›ç›´æ¥ç”ŸæˆinvokedynamicæŒ‡ä»¤çš„æ–¹æ³•ï¼Œéœ€è¦å€ŸåŠ©ASMè¿™ç§åº•å±‚å­—èŠ‚ç å·¥å…·æ¥äº§ç”ŸinvokedynamicæŒ‡ä»¤ã€‚ç›´åˆ°Java8çš„Lambdaè¡¨è¾¾å¼çš„å‡ºç°ï¼ŒinvokedynamicæŒ‡ä»¤çš„ç”Ÿæˆï¼Œåœ¨Javaä¸­æ‰æœ‰äº†ç›´æ¥çš„ç”Ÿæˆæ–¹å¼ã€‚</p><p>Java7ä¸­å¢åŠ çš„åŠ¨æ€è¯­è¨€ç±»å‹æ”¯æŒçš„æœ¬è´¨æ˜¯å¯¹Javaè™šæ‹Ÿæœºè§„èŒƒçš„ä¿®æ”¹ï¼Œè€Œä¸æ˜¯å¯¹Javaè¯­è¨€è§„åˆ™çš„ä¿®æ”¹ï¼Œè¿™ä¸€å—ç›¸å¯¹æ¥è®²æ¯”è¾ƒå¤æ‚ï¼Œå¢åŠ äº†è™šæ‹Ÿæœºä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€ç›´æ¥çš„å—ç›Šè€…å°±æ˜¯è¿è¡Œåœ¨Javaå¹³å°çš„åŠ¨æ€è¯­è¨€çš„ç¼–è¯‘å™¨ã€‚</p><h3 id="7-5-åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€"><a href="#7-5-åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€" class="headerlink" title="7.5 åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€"></a>7.5 åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€</h3><p>åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€ä¸¤è€…çš„åŒºåˆ«å°±åœ¨äºå¯¹ç±»å‹çš„æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸè¿˜æ˜¯åœ¨è¿è¡ŒæœŸï¼Œæ»¡è¶³å‰è€…å°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œåä¹‹æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚</p><p>è¯´çš„å†ç›´ç™½ä¸€ç‚¹å°±æ˜¯ï¼Œé™æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯ï¼›åŠ¨æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯ï¼Œå˜é‡æ²¡æœ‰ç±»å‹ä¿¡æ¯ï¼Œå˜é‡å€¼æ‰æœ‰ç±»å‹ä¿¡æ¯ï¼Œè¿™æ˜¯åŠ¨æ€è¯­è¨€çš„ä¸€ä¸ªé‡è¦ç‰¹å¾ã€‚</p><blockquote><p>Javaï¼šString info = â€œmogu blogâ€;     (Javaæ˜¯é™æ€ç±»å‹è¯­è¨€çš„ï¼Œä¼šå…ˆç¼–è¯‘å°±è¿›è¡Œç±»å‹æ£€æŸ¥)</p><p>JSï¼švar name = â€œshkstartâ€;    var name = 10;    ï¼ˆè¿è¡Œæ—¶æ‰è¿›è¡Œæ£€æŸ¥ï¼‰</p></blockquote><h3 id="7-6-æ–¹æ³•é‡å†™çš„æœ¬è´¨"><a href="#7-6-æ–¹æ³•é‡å†™çš„æœ¬è´¨" class="headerlink" title="7.6 æ–¹æ³•é‡å†™çš„æœ¬è´¨"></a>7.6 æ–¹æ³•é‡å†™çš„æœ¬è´¨</h3><h4 id="Java-è¯­è¨€ä¸­æ–¹æ³•é‡å†™çš„æœ¬è´¨ï¼š"><a href="#Java-è¯­è¨€ä¸­æ–¹æ³•é‡å†™çš„æœ¬è´¨ï¼š" class="headerlink" title="Java è¯­è¨€ä¸­æ–¹æ³•é‡å†™çš„æœ¬è´¨ï¼š"></a>Java è¯­è¨€ä¸­æ–¹æ³•é‡å†™çš„æœ¬è´¨ï¼š</h4><ul><li>æ‰¾åˆ°æ“ä½œæ•°æ ˆé¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°ä½œCã€‚</li><li>å¦‚æœåœ¨ç±»å‹Cä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦åˆç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸï¼›å¦‚æœä¸é€šè¿‡ï¼Œåˆ™è¿”å›java.1ang.I1legalAccessError å¼‚å¸¸ã€‚</li><li>å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹Cçš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬2æ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹ã€‚</li><li>å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡ºjava.1ang.AbstractMethodsrrorå¼‚å¸¸ã€‚</li></ul><h4 id="IllegalAccessErrorä»‹ç»"><a href="#IllegalAccessErrorä»‹ç»" class="headerlink" title="IllegalAccessErrorä»‹ç»"></a>IllegalAccessErrorä»‹ç»</h4><p>ç¨‹åºè¯•å›¾è®¿é—®æˆ–ä¿®æ”¹ä¸€ä¸ªå±æ€§æˆ–è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªå±æ€§æˆ–æ–¹æ³•ï¼Œä½ æ²¡æœ‰æƒé™è®¿é—®ã€‚ä¸€èˆ¬çš„ï¼Œè¿™ä¸ªä¼šå¼•èµ·ç¼–è¯‘å™¨å¼‚å¸¸ã€‚è¿™ä¸ªé”™è¯¯å¦‚æœå‘ç”Ÿåœ¨è¿è¡Œæ—¶ï¼Œå°±è¯´æ˜ä¸€ä¸ªç±»å‘ç”Ÿäº†ä¸å…¼å®¹çš„æ”¹å˜ã€‚</p><h3 id="7-7-æ–¹æ³•çš„è°ƒç”¨ï¼šè™šæ–¹æ³•è¡¨"><a href="#7-7-æ–¹æ³•çš„è°ƒç”¨ï¼šè™šæ–¹æ³•è¡¨" class="headerlink" title="7.7 æ–¹æ³•çš„è°ƒç”¨ï¼šè™šæ–¹æ³•è¡¨"></a>7.7 æ–¹æ³•çš„è°ƒç”¨ï¼šè™šæ–¹æ³•è¡¨</h3><p>åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ä¸­ï¼Œä¼šå¾ˆé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼Œå¦‚æœåœ¨æ¯æ¬¡åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ä¸­éƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡çš„è¯å°±å¯èƒ½å½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒJVMé‡‡ç”¨åœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨<br>ï¼ˆvirtual method tableï¼‰ï¼ˆéè™šæ–¹æ³•ä¸ä¼šå‡ºç°åœ¨è¡¨ä¸­ï¼‰æ¥å®ç°ã€‚ä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾ã€‚</p><p>æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚</p><p>è™šæ–¹æ³•è¡¨æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„å‘¢ï¼Ÿ</p><p>è™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼ŒJVMä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706144954070.png" alt="image-20200706144954070"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šå¦‚æœç±»ä¸­é‡å†™äº†æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ—¶å€™ï¼Œå°±ä¼šç›´æ¥åœ¨è™šæ–¹æ³•è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦åˆ™å°†ä¼šç›´æ¥è¿æ¥åˆ°Objectçš„æ–¹æ³•ä¸­ã€‚</p><h2 id="8-æ–¹æ³•è¿”å›åœ°å€"><a href="#8-æ–¹æ³•è¿”å›åœ°å€" class="headerlink" title="8 æ–¹æ³•è¿”å›åœ°å€"></a>8 æ–¹æ³•è¿”å›åœ°å€</h2><p>å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„pcå¯„å­˜å™¨çš„å€¼ã€‚ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><p>æ­£å¸¸æ‰§è¡Œå®Œæˆ</p></li><li><p>å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º</p></li></ul><p>æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„pcè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚</p><p>å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³•ï¼š</p><p>æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼ˆreturnï¼‰ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œç®€ç§°æ­£å¸¸å®Œæˆå‡ºå£ï¼›</p><ul><li>ä¸€ä¸ªæ–¹æ³•åœ¨æ­£å¸¸è°ƒç”¨å®Œæˆä¹‹åï¼Œç©¶ç«Ÿéœ€è¦ä½¿ç”¨å“ªä¸€ä¸ªè¿”å›æŒ‡ä»¤ï¼Œè¿˜éœ€è¦æ ¹æ®æ–¹æ³•è¿”å›å€¼çš„å®é™…æ•°æ®ç±»å‹è€Œå®šã€‚</li><li>åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œè¿”å›æŒ‡ä»¤åŒ…å«ireturnï¼ˆå½“è¿”å›å€¼æ˜¯booleanï¼Œbyteï¼Œcharï¼Œshortå’Œintç±»å‹æ—¶ä½¿ç”¨ï¼‰ï¼Œlreturnï¼ˆLongç±»å‹ï¼‰ï¼Œfreturnï¼ˆFloatç±»å‹ï¼‰ï¼Œdreturnï¼ˆDoubleç±»å‹ï¼‰ï¼Œareturnã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªreturnæŒ‡ä»¤å£°æ˜ä¸ºvoidçš„æ–¹æ³•ï¼Œå®ä¾‹åˆå§‹åŒ–æ–¹æ³•ï¼Œç±»å’Œæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ä½¿ç”¨ã€‚</li></ul><p>åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ï¼ˆExceptionï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œç®€ç§°å¼‚å¸¸å®Œæˆå‡ºå£ã€‚</p><p>æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç </p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706154554604.png" alt="image-20200706154554604"></p><p>æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰æ ˆå¸§å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p><p>æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äºï¼šé€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼ã€‚</p><h2 id="9-ä¸€äº›é™„åŠ ä¿¡æ¯"><a href="#9-ä¸€äº›é™„åŠ ä¿¡æ¯" class="headerlink" title="9 ä¸€äº›é™„åŠ ä¿¡æ¯"></a>9 ä¸€äº›é™„åŠ ä¿¡æ¯</h2><p>æ ˆå¸§ä¸­è¿˜å…è®¸æºå¸¦ä¸Javaè™šæ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼šå¯¹ç¨‹åºè°ƒè¯•æä¾›æ”¯æŒçš„ä¿¡æ¯ã€‚</p><h2 id="10-æ ˆçš„ç›¸å…³é¢è¯•é¢˜"><a href="#10-æ ˆçš„ç›¸å…³é¢è¯•é¢˜" class="headerlink" title="10 æ ˆçš„ç›¸å…³é¢è¯•é¢˜"></a>10 æ ˆçš„ç›¸å…³é¢è¯•é¢˜</h2><ul><li>ä¸¾ä¾‹æ ˆæº¢å‡ºçš„æƒ…å†µï¼Ÿï¼ˆStackOverflowErrorï¼‰<ul><li>é€šè¿‡ -Xssè®¾ç½®æ ˆçš„å¤§å°</li></ul></li><li>è°ƒæ•´æ ˆå¤§å°ï¼Œå°±èƒ½ä¿è¯ä¸å‡ºç°æº¢å‡ºä¹ˆï¼Ÿ<ul><li>ä¸èƒ½ä¿è¯ä¸æº¢å‡º</li></ul></li><li>åˆ†é…çš„æ ˆå†…å­˜è¶Šå¤§è¶Šå¥½ä¹ˆï¼Ÿ<ul><li>ä¸æ˜¯ï¼Œä¸€å®šæ—¶é—´å†…é™ä½äº†OOMæ¦‚ç‡ï¼Œä½†æ˜¯ä¼šæŒ¤å å…¶å®ƒçš„çº¿ç¨‹ç©ºé—´ï¼Œå› ä¸ºæ•´ä¸ªç©ºé—´æ˜¯æœ‰é™çš„ã€‚</li></ul></li><li>åƒåœ¾å›æ”¶æ˜¯å¦æ¶‰åŠåˆ°è™šæ‹Ÿæœºæ ˆï¼Ÿ<ul><li>ä¸ä¼š</li></ul></li><li>æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ<ul><li>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</li></ul></li></ul><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * é¢è¯•é¢˜</span><span class="hljs-comment"> * æ–¹æ³•ä¸­å®šä¹‰å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿå…·ä½“æƒ…å†µå…·ä½“åˆ†æ</span><span class="hljs-comment"> * ä½•ä¸ºçº¿ç¨‹å®‰å…¨ï¼Ÿ</span><span class="hljs-comment"> *    å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰å¯ä»¥æ“ä½œæ­¤æ•°æ®ï¼Œåˆ™å¿…æ˜¯çº¿ç¨‹å®‰å…¨çš„</span><span class="hljs-comment"> *    å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ“ä½œï¼Œåˆ™æ­¤æ•°æ®æ˜¯å…±äº«æ•°æ®ï¼Œå¦‚æœä¸è€ƒè™‘å…±äº«æœºåˆ¶ï¼Œåˆ™ä¸ºçº¿ç¨‹ä¸å®‰å…¨</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringBuilderTest</span> </span>&#123;    <span class="hljs-comment">// s1çš„å£°æ˜æ–¹å¼æ˜¯çº¿ç¨‹å®‰å…¨çš„</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method01</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// çº¿ç¨‹å†…éƒ¨åˆ›å»ºçš„ï¼Œå±äºå±€éƒ¨å˜é‡</span>        StringBuilder s1 = <span class="hljs-keyword">new</span> StringBuilder();        s1.append(<span class="hljs-string">&quot;a&quot;</span>);        s1.append(<span class="hljs-string">&quot;b&quot;</span>);    &#125;    <span class="hljs-comment">// è¿™ä¸ªä¹Ÿæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæœ‰è¿”å›å€¼ï¼Œæœ‰å¯èƒ½è¢«å…¶å®ƒçš„ç¨‹åºæ‰€è°ƒç”¨</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StringBuilder <span class="hljs-title">method04</span><span class="hljs-params">()</span> </span>&#123;        StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();        stringBuilder.append(<span class="hljs-string">&quot;a&quot;</span>);        stringBuilder.append(<span class="hljs-string">&quot;b&quot;</span>);        <span class="hljs-keyword">return</span> stringBuilder;    &#125;    <span class="hljs-comment">// stringBuilder æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ“ä½œçš„æ˜¯å…±äº«æ•°æ®</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method02</span><span class="hljs-params">(StringBuilder stringBuilder)</span> </span>&#123;        stringBuilder.append(<span class="hljs-string">&quot;a&quot;</span>);        stringBuilder.append(<span class="hljs-string">&quot;b&quot;</span>);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åŒæ—¶å¹¶å‘çš„æ‰§è¡Œï¼Œä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method03</span><span class="hljs-params">()</span> </span>&#123;        StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            stringBuilder.append(<span class="hljs-string">&quot;a&quot;</span>);            stringBuilder.append(<span class="hljs-string">&quot;b&quot;</span>);        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();        method02(stringBuilder);    &#125;    <span class="hljs-comment">// StringBuilderæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯Stringä¹Ÿå¯èƒ½çº¿ç¨‹ä¸å®‰å…¨çš„</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">method05</span><span class="hljs-params">()</span> </span>&#123;        StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();        stringBuilder.append(<span class="hljs-string">&quot;a&quot;</span>);        stringBuilder.append(<span class="hljs-string">&quot;b&quot;</span>);        <span class="hljs-keyword">return</span> stringBuilder.toString();    &#125;&#125;</code></pre></div><p>æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šå¦‚æœå¯¹è±¡æ˜¯åœ¨å†…éƒ¨äº§ç”Ÿï¼Œå¹¶åœ¨å†…éƒ¨æ¶ˆäº¡ï¼Œæ²¡æœ‰è¿”å›åˆ°å¤–éƒ¨ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåä¹‹åˆ™æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p><p>è¿è¡Œæ—¶æ•°æ®åŒºï¼Œæ˜¯å¦å­˜åœ¨Errorå’ŒGCï¼Ÿ</p><table><thead><tr><th>è¿è¡Œæ—¶æ•°æ®åŒº</th><th>æ˜¯å¦å­˜åœ¨Error</th><th>æ˜¯å¦å­˜åœ¨GC</th></tr></thead><tbody><tr><td>ç¨‹åºè®¡æ•°å™¨</td><td>å¦</td><td>å¦</td></tr><tr><td>è™šæ‹Ÿæœºæ ˆ</td><td>æ˜¯</td><td>å¦</td></tr><tr><td>æœ¬åœ°æ–¹æ³•æ ˆ</td><td>æ˜¯</td><td>å¦</td></tr><tr><td>æ–¹æ³•åŒº</td><td>æ˜¯ï¼ˆOOMï¼‰</td><td>æ˜¯</td></tr><tr><td>å †</td><td>æ˜¯</td><td>æ˜¯</td></tr></tbody></table><h1 id="ç¬¬6ç« -æœ¬åœ°æ–¹æ³•æ¥å£"><a href="#ç¬¬6ç« -æœ¬åœ°æ–¹æ³•æ¥å£" class="headerlink" title="ç¬¬6ç«  æœ¬åœ°æ–¹æ³•æ¥å£"></a>ç¬¬6ç«  æœ¬åœ°æ–¹æ³•æ¥å£</h1><h2 id="1-ä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•"><a href="#1-ä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•" class="headerlink" title="1 ä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•"></a>1 ä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•</h2><p>ç®€å•åœ°è®²ï¼Œä¸€ä¸ªNative Methodtæ˜¯ä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å›—ã€‚ä¸€ä¸ªNative Methodæ˜¯è¿™æ ·ä¸€ä¸ªJavaæ–¹æ³•ï¼šè¯¥æ–¹æ³•çš„å®ç°ç”±éJavaè¯­è¨€å®ç°ï¼Œæ¯”å¦‚Cã€‚è¿™ä¸ªç‰¹å¾å¹¶éJavaæ‰€ç‰¹æœ‰ï¼Œå¾ˆå¤šå…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¿™ä¸€æœºåˆ¶ï¼Œæ¯”å¦‚åœ¨C++ä¸­ï¼Œä½ å¯ä»¥ç”¨extern â€œcâ€ å‘ŠçŸ¥c++ç¼–è¯‘å™¨å»è°ƒç”¨ä¸€ä¸ªcçš„å‡½æ•°ã€‚</p><p>â€œA native method is a Java method whose implementation is provided by non-java code.â€ï¼ˆæœ¬åœ°æ–¹æ³•æ˜¯ä¸€ä¸ªéJavaçš„æ–¹æ³•ï¼Œå®ƒçš„å…·ä½“å®ç°æ˜¯éJavaä»£ç çš„å®ç°ï¼‰</p><p>åœ¨å®šä¹‰ä¸€ä¸ªnative methodæ—¶ï¼Œå¹¶ä¸æä¾›å®ç°ä½“ï¼ˆæœ‰äº›åƒå®šä¹‰ä¸€ä¸ªJava interfaceï¼‰ï¼Œå› ä¸ºå…¶å®ç°ä½“æ˜¯ç”±éjavaè¯­è¨€åœ¨å¤–é¢å®ç°çš„ã€‚</p><p>æœ¬åœ°æ¥å£çš„ä½œç”¨æ˜¯èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸ºJavaæ‰€ç”¨ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆC/C++ç¨‹åºã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706164139252.png" alt="image-20200706164139252"></p><p>ä»£ç ä¸¾ä¾‹è¯´æ˜Nativeæ–¹æ³•æ˜¯å¦‚ä½•ç¼–å†™çš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IhaveNatives</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Native1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span></span>;    <span class="hljs-function"><span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">Native2</span><span class="hljs-params">()</span></span>;    <span class="hljs-function"><span class="hljs-keyword">native</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> <span class="hljs-title">Native3</span><span class="hljs-params">(Object o)</span></span>;    <span class="hljs-function"><span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Natives</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] ary)</span> <span class="hljs-keyword">throws</span> Exception</span>;&#125;</code></pre></div><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ ‡è¯†ç¬¦nativeå¯ä»¥ä¸å…¶å®ƒjavaæ ‡è¯†ç¬¦è¿ç”¨ï¼Œä½†æ˜¯abstracté™¤å¤–</p></blockquote><h2 id="2-ä¸ºä»€ä¹ˆä½¿ç”¨Native-Methodï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆä½¿ç”¨Native-Methodï¼Ÿ" class="headerlink" title="2 ä¸ºä»€ä¹ˆä½¿ç”¨Native Methodï¼Ÿ"></a>2 ä¸ºä»€ä¹ˆä½¿ç”¨Native Methodï¼Ÿ</h2><p>Javaä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œç„¶è€Œæœ‰äº›å±‚æ¬¡çš„ä»»åŠ¡ç”¨Javaå®ç°èµ·æ¥ä¸å®¹æ˜“ï¼Œæˆ–è€…æˆ‘ä»¬å¯¹ç¨‹åºçš„æ•ˆç‡å¾ˆåœ¨æ„æ—¶ï¼Œé—®é¢˜å°±æ¥äº†ã€‚</p><h3 id="2-1-ä¸Javaç¯å¢ƒçš„äº¤äº’"><a href="#2-1-ä¸Javaç¯å¢ƒçš„äº¤äº’" class="headerlink" title="2.1 ä¸Javaç¯å¢ƒçš„äº¤äº’"></a>2.1 ä¸Javaç¯å¢ƒçš„äº¤äº’</h3><p>æœ‰æ—¶Javaåº”ç”¨éœ€è¦ä¸Javaå¤–é¢çš„ç¯å¢ƒäº¤äº’ï¼Œè¿™æ˜¯æœ¬åœ°æ–¹æ³•å­˜åœ¨çš„ä¸»è¦åŸå› ã€‚ä½ å¯ä»¥æƒ³æƒ³Javaéœ€è¦ä¸ä¸€äº›åº•å±‚ç³»ç»Ÿï¼Œå¦‚æ“ä½œç³»ç»Ÿæˆ–æŸäº›ç¡¬ä»¶äº¤æ¢ä¿¡æ¯æ—¶çš„æƒ…å†µã€‚æœ¬åœ°æ–¹æ³•æ­£æ˜¯è¿™æ ·ä¸€ç§äº¤æµæœºåˆ¶ï¼šå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªéå¸¸ç®€æ´çš„æ¥å£ï¼Œè€Œä¸”æˆ‘ä»¬æ— éœ€å»äº†è§£Javaåº”ç”¨ä¹‹å¤–çš„ç¹ççš„ç»†èŠ‚ã€‚</p><h3 id="2-2-ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’"><a href="#2-2-ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’" class="headerlink" title="2.2 ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’"></a>2.2 ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’</h3><p>JVMæ”¯æŒç€Javaè¯­è¨€æœ¬èº«å’Œè¿è¡Œæ—¶åº“ï¼Œå®ƒæ˜¯Javaç¨‹åºèµ–ä»¥ç”Ÿå­˜çš„å¹³å°ï¼Œå®ƒç”±ä¸€ä¸ªè§£é‡Šå™¨ï¼ˆè§£é‡Šå­—èŠ‚ç ï¼‰å’Œä¸€äº›è¿æ¥åˆ°æœ¬åœ°ä»£ç çš„åº“ç»„æˆã€‚ç„¶è€Œä¸ç®¡æ€æ ·ï¼Œå®ƒæ¯•ç«Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œå®ƒç»å¸¸ä¾èµ–äºä¸€åº•å±‚ç³»ç»Ÿçš„æ”¯æŒã€‚è¿™äº›åº•å±‚ç³»ç»Ÿå¸¸å¸¸æ˜¯å¼ºå¤§çš„æ“ä½œç³»ç»Ÿã€‚é€šè¿‡ä½¿ç”¨æœ¬åœ°æ–¹æ³•ï¼Œæˆ‘ä»¬å¾—ä»¥ç”¨Javaå®ç°äº†jreçš„ä¸åº•å±‚ç³»ç»Ÿçš„äº¤äº’ï¼Œç”šè‡³JVMçš„ä¸€äº›éƒ¨åˆ†å°±æ˜¯ç”¨cå†™çš„ã€‚è¿˜æœ‰ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ä¸€äº›Javaè¯­è¨€æœ¬èº«æ²¡æœ‰æä¾›å°è£…çš„æ“ä½œç³»ç»Ÿçš„ç‰¹æ€§æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä½¿ç”¨æœ¬åœ°æ–¹æ³•ã€‚</p><h3 id="2-3-Sunâ€™s-Java"><a href="#2-3-Sunâ€™s-Java" class="headerlink" title="2.3 Sunâ€™s Java"></a>2.3 Sunâ€™s Java</h3><p>Sunçš„è§£é‡Šå™¨æ˜¯ç”¨Cå®ç°çš„ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åƒä¸€äº›æ™®é€šçš„Cä¸€æ ·ä¸å¤–éƒ¨äº¤äº’ã€‚jreå¤§éƒ¨åˆ†æ˜¯ç”¨Javaå®ç°çš„ï¼Œå®ƒä¹Ÿé€šè¿‡ä¸€äº›æœ¬åœ°æ–¹æ³•ä¸å¤–ç•Œäº¤äº’ã€‚ä¾‹å¦‚ï¼šç±»java.lang.Threadçš„setpriorityï¼ˆï¼‰æ–¹æ³•æ˜¯ç”¨Javaå®ç°çš„ï¼Œä½†æ˜¯å®ƒå®ç°è°ƒç”¨çš„æ˜¯è¯¥ç±»é‡Œçš„æœ¬åœ°æ–¹æ³•setpriorityoï¼ˆï¼‰ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•æ˜¯ç”¨Cå®ç°çš„ï¼Œå¹¶è¢«æ¤å…¥JVMå†…éƒ¨ï¼Œåœ¨Windows 95çš„å¹³å°ä¸Šï¼Œè¿™ä¸ªæœ¬åœ°æ–¹æ³•æœ€ç»ˆå°†è°ƒç”¨Win32 setpriorityï¼ˆï¼‰ApIã€‚è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•çš„å…·ä½“å®ç°ç”±JVMç›´æ¥æä¾›ï¼Œæ›´å¤šçš„æƒ…å†µæ˜¯æœ¬åœ°æ–¹æ³•ç”±å¤–éƒ¨çš„åŠ¨æ€é“¾æ¥åº“ï¼ˆexternal dynamic link libraryï¼‰æä¾›ï¼Œç„¶åè¢«JVwè°ƒç”¨ã€‚</p><h2 id="3-ç°çŠ¶"><a href="#3-ç°çŠ¶" class="headerlink" title="3 ç°çŠ¶"></a>3 ç°çŠ¶</h2><p>ç›®å‰è¯¥æ–¹æ³•ä½¿ç”¨çš„è¶Šæ¥è¶Šå°‘äº†ï¼Œé™¤éæ˜¯ä¸ç¡¬ä»¶æœ‰å…³çš„åº”ç”¨ï¼Œæ¯”å¦‚é€šè¿‡Javaç¨‹åºé©±åŠ¨æ‰“å°æœºæˆ–è€…Javaç³»ç»Ÿç®¡ç†ç”Ÿäº§è®¾å¤‡ï¼Œåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­å·²ç»æ¯”è¾ƒå°‘è§ã€‚å› ä¸ºç°åœ¨çš„å¼‚æ„é¢†åŸŸé—´çš„é€šä¿¡å¾ˆå‘è¾¾ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨Socketé€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Web Serviceç­‰ç­‰ï¼Œä¸å¤šåšä»‹ç»ã€‚</p><h1 id="ç¬¬7ç« -æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#ç¬¬7ç« -æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="ç¬¬7ç«  æœ¬åœ°æ–¹æ³•æ ˆ"></a>ç¬¬7ç«  æœ¬åœ°æ–¹æ³•æ ˆ</h1><p>Javaè™šæ‹Ÿæœºæ ˆäºç®¡ç†Javaæ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œ<strong>æœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨</strong>ã€‚</p><p>æœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p><p>å…è®¸è¢«å®ç°æˆå›ºå®šæˆ–è€…æ˜¯å¯åŠ¨æ€æ‰©å±•çš„å†…å­˜å¤§å°ã€‚ï¼ˆåœ¨å†…å­˜æº¢å‡ºæ–¹é¢æ˜¯ç›¸åŒçš„ï¼‰</p><ul><li>å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡æœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªstackoverflowError å¼‚å¸¸ã€‚</li><li>å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªoutofMemoryErrorå¼‚å¸¸ã€‚</li></ul><p>æœ¬åœ°æ–¹æ³•æ˜¯ä½¿ç”¨Cè¯­è¨€å®ç°çš„ã€‚</p><p>å®ƒçš„å…·ä½“åšæ³•æ˜¯Native Method Stackä¸­ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨Execution Engine æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706174708418.png" alt="image-20200706174708418"></p><p>å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™ã€‚</p><ul><li>æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒºã€‚</li><li>å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨</li><li>ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜ã€‚</li></ul><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„JVMéƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚å› ä¸ºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚æœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰ã€‚å¦‚æœJVMäº§å“ä¸æ‰“ç®—æ”¯æŒnativeæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ— éœ€å®ç°æœ¬åœ°æ–¹æ³•æ ˆã€‚</p><p>åœ¨Hotspot JVMä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚</p><h1 id="ç¬¬8ç« -å †"><a href="#ç¬¬8ç« -å †" class="headerlink" title="ç¬¬8ç«  å †"></a>ç¬¬8ç«  å †</h1><h2 id="1-å †çš„æ ¸å¿ƒæ¦‚å¿µ"><a href="#1-å †çš„æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1 å †çš„æ ¸å¿ƒæ¦‚å¿µ"></a>1 å †çš„æ ¸å¿ƒæ¦‚å¿µ</h2><p>å †é’ˆå¯¹ä¸€ä¸ªJVMè¿›ç¨‹æ¥è¯´æ˜¯å”¯ä¸€çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªJVMï¼Œä½†æ˜¯è¿›ç¨‹åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œä»–ä»¬æ˜¯å…±äº«åŒä¸€å †ç©ºé—´çš„ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706195127740.png" alt="image-20200706195127740"></p><p>ä¸€ä¸ªJVMå®ä¾‹åªå­˜åœ¨ä¸€ä¸ªå †å†…å­˜ï¼Œå †ä¹Ÿæ˜¯Javaå†…å­˜ç®¡ç†çš„æ ¸å¿ƒåŒºåŸŸã€‚</p><p>Javaå †åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™å³è¢«åˆ›å»ºï¼Œå…¶ç©ºé—´å¤§å°ä¹Ÿå°±ç¡®å®šäº†ã€‚æ˜¯JVMç®¡ç†çš„æœ€å¤§ä¸€å—å†…å­˜ç©ºé—´ã€‚</p><ul><li>å †å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ã€‚</li></ul><p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹è§„å®šï¼Œå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ã€‚</p><p>æ‰€æœ‰çš„çº¿ç¨‹å…±äº«Javaå †ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥åˆ’åˆ†çº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚</p><blockquote><p>-Xms10mï¼šæœ€å°å †å†…å­˜</p><p>-Xmx10mï¼šæœ€å¤§å †å†…å­˜</p></blockquote><p>ä¸‹å›¾å°±æ˜¯ä½¿ç”¨ï¼šJava VisualVMæŸ¥çœ‹å †ç©ºé—´çš„å†…å®¹ï¼Œé€šè¿‡ jdk binæä¾›çš„æ’ä»¶</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706200739392.png" alt="image-20200706200739392"></p><p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å¯¹Javaå †çš„æè¿°æ˜¯ï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Šã€‚ï¼ˆThe heap is the run-time data area from which memory for all class instances and arrays is allocatedï¼‰</p><p>æˆ‘è¦è¯´çš„æ˜¯ï¼šâ€œå‡ ä¹â€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚â€”ä»å®é™…ä½¿ç”¨è§’åº¦çœ‹çš„ã€‚</p><ul><li>å› ä¸ºè¿˜æœ‰ä¸€äº›å¯¹è±¡æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„</li></ul><p>æ•°ç»„å’Œå¯¹è±¡å¯èƒ½æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–è€…æ•°ç»„åœ¨å †ä¸­çš„ä½ç½®ã€‚</p><p>åœ¨æ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«ç§»é™¤ï¼Œä»…ä»…åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«ç§»é™¤ã€‚</p><ul><li>ä¹Ÿå°±æ˜¯è§¦å‘äº†GCçš„æ—¶å€™ï¼Œæ‰ä¼šè¿›è¡Œå›æ”¶</li><li>å¦‚æœå †ä¸­å¯¹è±¡é©¬ä¸Šè¢«å›æ”¶ï¼Œé‚£ä¹ˆç”¨æˆ·çº¿ç¨‹å°±ä¼šæ”¶åˆ°å½±å“ï¼Œå› ä¸ºæœ‰stop the word</li></ul><p>å †ï¼Œæ˜¯GCï¼ˆGarbage Collectionï¼Œåƒåœ¾æ”¶é›†å™¨ï¼‰æ‰§è¡Œåƒåœ¾å›æ”¶çš„é‡ç‚¹åŒºåŸŸã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706201904057.png" alt="image-20200706201904057"></p><h3 id="å †å†…å­˜ç»†åˆ†"><a href="#å †å†…å­˜ç»†åˆ†" class="headerlink" title="å †å†…å­˜ç»†åˆ†"></a>å †å†…å­˜ç»†åˆ†</h3><p>Java 7åŠä¹‹å‰å †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”ŸåŒº+å…»è€åŒº+æ°¸ä¹…åŒº</p><ul><li>Young Generation Space æ–°ç”ŸåŒº  Young/New   åˆè¢«åˆ’åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒº</li><li>Tenure generation space å…»è€åŒº Old/Tenure</li><li>Permanent Spaceæ°¸ä¹…åŒº   Perm</li></ul><p>Java 8åŠä¹‹åå †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”ŸåŒºå…»è€åŒº+å…ƒç©ºé—´</p><ul><li>Young Generation Spaceæ–°ç”ŸåŒº  Young/New  åˆè¢«åˆ’åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒº</li><li>Tenure generation space å…»è€åŒº  Old/Tenure</li><li>Meta Space  å…ƒç©ºé—´   Meta</li></ul><p>çº¦å®šï¼šæ–°ç”ŸåŒº -&gt; æ–°ç”Ÿä»£ -&gt; å¹´è½»ä»£   ã€  å…»è€åŒº -&gt; è€å¹´åŒº -&gt; è€å¹´ä»£ã€ æ°¸ä¹…åŒº -&gt; æ°¸ä¹…ä»£</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706203419496.png" alt="image-20200706203419496"></p><p>å †ç©ºé—´å†…éƒ¨ç»“æ„ï¼ŒJDK1.8ä¹‹å‰ä»æ°¸ä¹…ä»£  æ›¿æ¢æˆ å…ƒç©ºé—´</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706203835403.png" alt="image-20200706203835403"></p><h2 id="2-è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM"><a href="#2-è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM" class="headerlink" title="2 è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM"></a>2 è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM</h2><p>Javaå †åŒºç”¨äºå­˜å‚¨Javaå¯¹è±¡å®ä¾‹ï¼Œé‚£ä¹ˆå †çš„å¤§å°åœ¨JVMå¯åŠ¨æ—¶å°±å·²ç»è®¾å®šå¥½äº†ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é€‰é¡¹â€-Xmxâ€å’Œâ€-Xmsâ€æ¥è¿›è¡Œè®¾ç½®ã€‚</p><ul><li>â€œ-Xmsâ€ç”¨äºè¡¨ç¤ºå †åŒºçš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº-xx:InitialHeapSize</li><li>â€œ-Xmxâ€åˆ™ç”¨äºè¡¨ç¤ºå †åŒºçš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº-XX:MaxHeapSize</li></ul><p>ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡â€œ-xmxâ€æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†ä¼šæŠ›å‡ºoutofMemoryErrorå¼‚å¸¸ã€‚</p><p>é€šå¸¸ä¼šå°†-Xmså’Œ-Xmxä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼ï¼Œå…¶ç›®çš„æ˜¯<strong>ä¸ºäº†èƒ½å¤Ÿåœ¨avaåƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåä¸éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †åŒºçš„å¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½</strong>ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹</p><ul><li><p>åˆå§‹å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°/64</p></li><li><p>æœ€å¤§å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°/4</p></li></ul><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * -Xms ç”¨æ¥è®¾ç½®å †ç©ºé—´ï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„åˆå§‹å†…å­˜å¤§å°</span><span class="hljs-comment"> *  -Xï¼šæ˜¯jvmè¿è¡Œå‚æ•°</span><span class="hljs-comment"> *  msï¼šmemory start</span><span class="hljs-comment"> * -Xmxï¼šç”¨æ¥è®¾ç½®å †ç©ºé—´ï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„æœ€å¤§å†…å­˜å¤§å°</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeapSpaceInitial</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">// è¿”å›Javaè™šæ‹Ÿæœºä¸­çš„å †å†…å­˜æ€»é‡</span>        <span class="hljs-keyword">long</span> initialMemory = Runtime.getRuntime().totalMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>;        <span class="hljs-comment">// è¿”å›Javaè™šæ‹Ÿæœºè¯•å›¾ä½¿ç”¨çš„æœ€å¤§å †å†…å­˜</span>        <span class="hljs-keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>;        System.out.println(<span class="hljs-string">&quot;-Xms:&quot;</span> + initialMemory + <span class="hljs-string">&quot;M&quot;</span>);        System.out.println(<span class="hljs-string">&quot;-Xmx:&quot;</span> + maxMemory + <span class="hljs-string">&quot;M&quot;</span>);    &#125;&#125;</code></pre></div><p>è¾“å‡ºç»“æœ</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms:245M</span><span class="hljs-deletion">-Xmx:3614M</span></code></pre></div><p>å¦‚ä½•æŸ¥çœ‹å †å†…å­˜çš„å†…å­˜åˆ†é…æƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-keyword">jps </span> -&gt;  <span class="hljs-keyword">jstat </span>-gc è¿›ç¨‹id</code></pre></div><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706205756045.png" alt="image-20200706205756045"></p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+PrintGCDetails</span></code></pre></div><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706205821919.png" alt="image-20200706205821919"></p><h3 id="OutOfMemoryä¸¾ä¾‹"><a href="#OutOfMemoryä¸¾ä¾‹" class="headerlink" title="OutOfMemoryä¸¾ä¾‹"></a>OutOfMemoryä¸¾ä¾‹</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706205947535.png" alt="image-20200706205947535"></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706210000461.png" alt="image-20200706210000461"></p><p>æˆ‘ä»¬ç®€å•çš„å†™ä¸€ä¸ªOOMä¾‹å­</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OOMTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;            list.add(<span class="hljs-number">999999999</span>);        &#125;    &#125;&#125;</code></pre></div><p>ç„¶åè®¾ç½®å¯åŠ¨å‚æ•°</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms10m -Xmx:10m</span></code></pre></div><p>è¿è¡Œåï¼Œå°±å‡ºç°OOMäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ VisualVMè¿™ä¸ªå·¥å…·æŸ¥çœ‹å…·ä½“æ˜¯ä»€ä¹ˆå‚æ•°é€ æˆçš„OOM</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200706211652779.png" alt="image-20200706211652779"></p><h2 id="3-å¹´è½»ä»£ä¸è€å¹´ä»£"><a href="#3-å¹´è½»ä»£ä¸è€å¹´ä»£" class="headerlink" title="3 å¹´è½»ä»£ä¸è€å¹´ä»£"></a>3 å¹´è½»ä»£ä¸è€å¹´ä»£</h2><p>å­˜å‚¨åœ¨JVMä¸­çš„Javaå¯¹è±¡å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½éå¸¸è¿…é€Ÿ<ul><li>ç”Ÿå‘½å‘¨æœŸçŸ­çš„ï¼ŒåŠæ—¶å›æ”¶å³å¯</li></ul></li><li>å¦å¤–ä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå´éå¸¸é•¿ï¼Œåœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹è¿˜èƒ½å¤Ÿä¸JVMçš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´</li></ul><p>Javaå †åŒºè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆYoungGenï¼‰å’Œè€å¹´ä»£ï¼ˆoldGenï¼‰</p><p>å…¶ä¸­å¹´è½»ä»£åˆå¯ä»¥åˆ’åˆ†ä¸ºEdenç©ºé—´ã€Survivor0ç©ºé—´å’ŒSurvivor1ç©ºé—´ï¼ˆæœ‰æ—¶ä¹Ÿå«åšfromåŒºã€toåŒºï¼‰</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707075847954.png" alt="image-20200707075847954"></p><p>ä¸‹é¢è¿™å‚æ•°å¼€å‘ä¸­ä¸€èˆ¬ä¸ä¼šè°ƒï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707080154039.png" alt="image-20200707080154039"></p><ul><li>Edenï¼šFromï¼što -&gt;  8:1:1</li><li>æ–°ç”Ÿä»£ï¼šè€å¹´ä»£  - &gt;  1 : 2</li></ul><p>é…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”ã€‚</p><ul><li><p>é»˜è®¤-XX:NewRatio=2ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 2ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1/3</p></li><li><p>å¯ä»¥ä¿®æ”¹-XX:NewRatio=4ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 4ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1/5</p></li></ul><blockquote><p>å½“å‘ç°åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡åå¤šï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è°ƒæ•´ è€å¹´ä»£çš„å¤§å°ï¼Œæ¥è¿›è¡Œè°ƒä¼˜</p></blockquote><p>åœ¨HotSpotä¸­ï¼ŒEdenç©ºé—´å’Œå¦å¤–ä¸¤ä¸ªsurvivorç©ºé—´ç¼ºçœæ‰€å çš„æ¯”ä¾‹æ˜¯8ï¼š1ï¼š1å½“ç„¶å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-xx:SurvivorRatioâ€è°ƒæ•´è¿™ä¸ªç©ºé—´æ¯”ä¾‹ã€‚æ¯”å¦‚-xx:SurvivorRatio=8</p><p>å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡éƒ½æ˜¯åœ¨EdenåŒºè¢«newå‡ºæ¥çš„ã€‚ç»å¤§éƒ¨åˆ†çš„Javaå¯¹è±¡çš„é”€æ¯éƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œäº†ã€‚ï¼ˆæœ‰äº›å¤§çš„å¯¹è±¡åœ¨EdenåŒºæ— æ³•å­˜å‚¨æ—¶å€™ï¼Œå°†ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼‰</p><blockquote><p>IBMå…¬å¸çš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­80%çš„å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿå¤•æ­»â€çš„ã€‚</p><p>å¯ä»¥ä½¿ç”¨é€‰é¡¹â€-Xmnâ€è®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°</p><p>è¿™ä¸ªå‚æ•°ä¸€èˆ¬ä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥äº†ã€‚</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707084208115.png" alt="image-20200707084208115"></p><h2 id="4-å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹"><a href="#4-å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹" class="headerlink" title="4 å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹"></a>4 å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹</h2><h3 id="4-1-æ¦‚å¿µ-1"><a href="#4-1-æ¦‚å¿µ-1" class="headerlink" title="4.1 æ¦‚å¿µ"></a>4.1 æ¦‚å¿µ</h3><p>ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ï¼ŒJMçš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•ä¸å†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘GCæ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p><ul><li>newçš„å¯¹è±¡å…ˆæ”¾ä¼Šç”¸å›­åŒºã€‚æ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚</li><li>å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆMinorGCï¼‰ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒº</li><li>ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€…0åŒºã€‚</li><li>å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€…0åŒºçš„ï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€…1åŒºã€‚</li><li>å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€…0åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€…1åŒºã€‚</li><li>å•¥æ—¶å€™èƒ½å»å…»è€åŒºå‘¢ï¼Ÿå¯ä»¥è®¾ç½®æ¬¡æ•°ã€‚é»˜è®¤æ˜¯15æ¬¡ã€‚</li><li>åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘GCï¼šMajor GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†</li><li>è‹¥å…»è€åŒºæ‰§è¡Œäº†Major GCä¹‹åï¼Œå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”ŸOOMå¼‚å¸¸ã€‚</li></ul><p>å¯ä»¥è®¾ç½®å‚æ•°ï¼š-Xx:MaxTenuringThreshold= Nè¿›è¡Œè®¾ç½®</p><h3 id="4-2-å›¾è§£è¿‡ç¨‹"><a href="#4-2-å›¾è§£è¿‡ç¨‹" class="headerlink" title="4.2 å›¾è§£è¿‡ç¨‹"></a>4.2 å›¾è§£è¿‡ç¨‹</h3><p>æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯å­˜æ”¾åœ¨EdenåŒºçš„ï¼Œå½“æˆ‘ä»¬EdenåŒºæ»¡äº†åï¼Œå°±ä¼šè§¦å‘GCæ“ä½œï¼Œä¸€èˆ¬è¢«ç§°ä¸º YGC / Minor GCæ“ä½œ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707084714886.png" alt="image-20200707084714886"></p><p>å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†åï¼Œçº¢è‰²çš„å°†ä¼šè¢«å›æ”¶ï¼Œè€Œç»¿è‰²çš„è¿˜ä¼šè¢«å ç”¨ç€ï¼Œå­˜æ”¾åœ¨S0(Survivor From)åŒºã€‚åŒæ—¶æˆ‘ä»¬ç»™æ¯ä¸ªå¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œä¸€æ¬¡å›æ”¶åå°±æ˜¯1ã€‚</p><p>åŒæ—¶EdenåŒºç»§ç»­å­˜æ”¾å¯¹è±¡ï¼Œå½“EdenåŒºå†æ¬¡å­˜æ»¡çš„æ—¶å€™ï¼Œåˆä¼šè§¦å‘ä¸€ä¸ªMinorGCæ“ä½œï¼Œæ­¤æ—¶GCå°†ä¼šæŠŠ Edenå’ŒSurvivor Fromä¸­çš„å¯¹è±¡ è¿›è¡Œä¸€æ¬¡æ”¶é›†ï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡æ”¾åˆ° Survivor ToåŒºï¼ŒåŒæ—¶è®©å¹´é¾„ + 1</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/8_%E5%A0%86/images/image-20200707085232646.png" alt="image-20200707085232646"></p><p>æˆ‘ä»¬ç»§ç»­ä¸æ–­çš„è¿›è¡Œå¯¹è±¡ç”Ÿæˆ å’Œ åƒåœ¾å›æ”¶ï¼Œå½“Survivorä¸­çš„å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°15çš„æ—¶å€™ï¼Œå°†ä¼šè§¦å‘ä¸€æ¬¡ Promotionæ™‹å‡çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å°†å¹´è½»ä»£ä¸­çš„å¯¹è±¡  æ™‹å‡åˆ° è€å¹´ä»£ä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707085737207.png" alt="image-20200707085737207"></p><h3 id="4-3-æ€è€ƒï¼šå¹¸å­˜åŒºåŒºæ»¡äº†åï¼Ÿ"><a href="#4-3-æ€è€ƒï¼šå¹¸å­˜åŒºåŒºæ»¡äº†åï¼Ÿ" class="headerlink" title="4.3 æ€è€ƒï¼šå¹¸å­˜åŒºåŒºæ»¡äº†åï¼Ÿ"></a>4.3 æ€è€ƒï¼šå¹¸å­˜åŒºåŒºæ»¡äº†åï¼Ÿ</h3><p>ç‰¹åˆ«æ³¨æ„ï¼Œåœ¨EdenåŒºæ»¡äº†çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘MinorGCï¼Œè€Œå¹¸å­˜è€…åŒºæ»¡äº†åï¼Œä¸ä¼šè§¦å‘MinorGCæ“ä½œ</p><p>å¦‚æœSurvivoråŒºæ»¡äº†åï¼Œå°†ä¼šè§¦å‘ä¸€äº›ç‰¹æ®Šçš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½ç›´æ¥æ™‹å‡è€å¹´ä»£</p><blockquote><p>ä¸¾ä¾‹ï¼šä»¥å½“å…µä¸ºä¾‹ï¼Œæ­£å¸¸äººçš„æ™‹å‡å¯èƒ½æ˜¯ ï¼š  æ–°å…µ -&gt; ç­é•¿ -&gt; æ’é•¿ -&gt; è¿é•¿</p><p>ä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½æœ‰äº›äººå› ä¸ºåšäº†éå¸¸å¤§çš„è´¡çŒ®ï¼Œç›´æ¥ä»  æ–°å…µ -&gt; æ’é•¿</p></blockquote><h3 id="4-4-å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ"><a href="#4-4-å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ" class="headerlink" title="4.4 å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ"></a>4.4 å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707091058346.png" alt="image-20200707091058346"></p><h3 id="4-5-ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ†é…è¿‡ç¨‹"><a href="#4-5-ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ†é…è¿‡ç¨‹" class="headerlink" title="4.5 ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ†é…è¿‡ç¨‹"></a>4.5 ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ†é…è¿‡ç¨‹</h3><p>æˆ‘ä»¬ä¸æ–­çš„åˆ›å»ºå¤§å¯¹è±¡</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeapInstanceTest</span> </span>&#123;    <span class="hljs-keyword">byte</span> [] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">1024</span> * <span class="hljs-number">200</span>)];    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        ArrayList&lt;HeapInstanceTest&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;            list.add(<span class="hljs-keyword">new</span> HeapInstanceTest());            Thread.sleep(<span class="hljs-number">10</span>);        &#125;    &#125;&#125;</code></pre></div><p>ç„¶åè®¾ç½®JVMå‚æ•°</p><div class="code-wrapper"><pre><code class="hljs bash">-Xms600m -Xmx600m</code></pre></div><p>ç„¶åcmdè¾“å…¥ä¸‹é¢å‘½ä»¤ï¼Œæ‰“å¼€VisualVMå›¾å½¢åŒ–ç•Œé¢</p><div class="code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">jvisualvm</span></code></pre></div><p>ç„¶åé€šè¿‡æ‰§è¡Œä¸Šé¢ä»£ç ï¼Œé€šè¿‡VisualGCè¿›è¡ŒåŠ¨æ€åŒ–æŸ¥çœ‹</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6.gif" alt="åƒåœ¾å›æ”¶"></p><p>æœ€ç»ˆï¼Œåœ¨è€å¹´ä»£å’Œæ–°ç”Ÿä»£éƒ½æ»¡äº†ï¼Œå°±å‡ºç°OOM</p><div class="code-wrapper"><pre><code class="hljs java">Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap spaceat com.atguigu.java.chapter08.HeapInstanceTest.&lt;init&gt;(HeapInstanceTest.java:<span class="hljs-number">13</span>)at com.atguigu.java.chapter08.HeapInstanceTest.main(HeapInstanceTest.java:<span class="hljs-number">17</span>)</code></pre></div><h3 id="4-6-å¸¸ç”¨çš„è°ƒä¼˜å·¥å…·"><a href="#4-6-å¸¸ç”¨çš„è°ƒä¼˜å·¥å…·" class="headerlink" title="4.6 å¸¸ç”¨çš„è°ƒä¼˜å·¥å…·"></a>4.6 å¸¸ç”¨çš„è°ƒä¼˜å·¥å…·</h3><ul><li>JDKå‘½ä»¤è¡Œ</li><li>Eclipseï¼šMemory Analyzer Tool</li><li>Jconsole</li><li>Visual VMï¼ˆå®æ—¶ç›‘æ§  æ¨è~ï¼‰</li><li>Jprofilerï¼ˆæ¨è~ï¼‰</li><li>Java Flight Recorderï¼ˆå®æ—¶ç›‘æ§ï¼‰</li><li>GCViewer</li><li>GCEasy</li></ul><h3 id="4-7-æ€»ç»“"><a href="#4-7-æ€»ç»“" class="headerlink" title="4.7 æ€»ç»“"></a>4.7 æ€»ç»“</h3><ul><li>é’ˆå¯¹å¹¸å­˜è€…s0ï¼Œs1åŒºçš„æ€»ç»“ï¼šå¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯to</li><li>å…³äºåƒåœ¾å›æ”¶ï¼šé¢‘ç¹åœ¨æ–°ç”ŸåŒºæ”¶é›†ï¼Œå¾ˆå°‘åœ¨è€å¹´ä»£æ”¶é›†ï¼Œå‡ ä¹ä¸å†æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´è¿›è¡Œæ”¶é›†</li><li>æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•çš„ç›®çš„ï¼šæ˜¯ä¸ºäº†å‡å°‘å†…ç¢ç‰‡</li></ul><h2 id="5-Minor-GCï¼ŒMajorGCã€Full-GC"><a href="#5-Minor-GCï¼ŒMajorGCã€Full-GC" class="headerlink" title="5 Minor GCï¼ŒMajorGCã€Full GC"></a>5 Minor GCï¼ŒMajorGCã€Full GC</h2><ul><li>Minor GCï¼šæ–°ç”Ÿä»£çš„GC</li><li>Major GCï¼šè€å¹´ä»£çš„GC</li><li>Full GCï¼šæ•´å †æ”¶é›†ï¼Œæ”¶é›†æ•´ä¸ªJavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†</li></ul><blockquote><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJVMçš„è°ƒä¼˜çš„ä¸€ä¸ªç¯èŠ‚ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾æ”¶é›†ï¼Œæˆ‘ä»¬éœ€è¦å°½é‡çš„é¿å…åƒåœ¾å›æ”¶ï¼Œå› ä¸ºåœ¨åƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå®¹æ˜“å‡ºç°STWçš„é—®é¢˜</p><p>è€Œ Major GC å’Œ Full GCå‡ºç°STWçš„æ—¶é—´ï¼Œæ˜¯Minor GCçš„10å€ä»¥ä¸Š</p></blockquote><p>JVMåœ¨è¿›è¡ŒGCæ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸Šé¢ä¸‰ä¸ªå†…å­˜åŒºåŸŸä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å›æ”¶çš„éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚é’ˆå¯¹Hotspot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCæŒ‰ç…§å›æ”¶åŒºåŸŸåˆåˆ†ä¸ºä¸¤å¤§ç§ç±»å‹ï¼šä¸€ç§æ˜¯éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼Œä¸€ç§æ˜¯æ•´å †æ”¶é›†ï¼ˆFullGCï¼‰</p><p>éƒ¨åˆ†æ”¶é›†ï¼šä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ªJavaå †çš„åƒåœ¾æ”¶é›†ã€‚å…¶ä¸­åˆåˆ†ä¸ºï¼š</p><ul><li>æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinorGC/YoungGCï¼‰ï¼šåªæ˜¯æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†</li><li>è€å¹´ä»£æ”¶é›†ï¼ˆMajorGC/OldGCï¼‰ï¼šåªæ˜¯è€å¹´ä»£çš„åœ¾æ”¶é›†ã€‚<ul><li>ç›®å‰ï¼Œåªæœ‰CMSGCä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºã€‚</li><li>æ³¨æ„ï¼Œå¾ˆå¤šæ—¶å€™Major GCä¼šå’ŒFullGCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶ã€‚</li></ul></li><li>æ··åˆæ”¶é›†ï¼ˆMixedGCï¼‰ï¼šæ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ã€‚<ul><li>ç›®å‰ï¼Œåªæœ‰G1 GCä¼šæœ‰è¿™ç§è¡Œä¸º</li></ul></li></ul><p>æ•´å †æ”¶é›†ï¼ˆFullGCï¼‰ï¼šæ”¶é›†æ•´ä¸ªjavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ã€‚</p><h3 id="5-1-Minor-GC"><a href="#5-1-Minor-GC" class="headerlink" title="5.1 Minor GC"></a>5.1 Minor GC</h3><p>å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘MinorGCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯Edenä»£æ»¡ï¼ŒSurvivoræ»¡ä¸ä¼šå¼•å‘GCã€‚ï¼ˆæ¯æ¬¡Minor GCä¼šæ¸…ç†å¹´è½»ä»£çš„å†…å­˜ã€‚ï¼‰</p><p>å› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡ <strong>æœç”Ÿå¤•ç­</strong> çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚è¿™ä¸€å®šä¹‰æ—¢æ¸…æ™°åˆæ˜“äºç†è§£ã€‚</p><p>Minor GCä¼šå¼•å‘STWï¼Œæš‚åœå…¶å®ƒç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œ</p><blockquote><p>STWï¼šstop the word</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707095606813.png" alt="image-20200707095606813"></p><h3 id="5-2-Major-GC"><a href="#5-2-Major-GC" class="headerlink" title="5.2 Major GC"></a>5.2 Major GC</h3><p>æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±æ—¶ï¼Œæˆ‘ä»¬è¯´ â€œMajor Gcâ€ æˆ– â€œFull GCâ€ å‘ç”Ÿäº†</p><p>å‡ºç°äº†MajorGcï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCï¼ˆä½†éç»å¯¹çš„ï¼Œåœ¨Paralle1 Scavengeæ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡ŒMajorGCçš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰</p><ul><li>ä¹Ÿå°±æ˜¯åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå…ˆå°è¯•è§¦å‘MinorGcã€‚å¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘Major GC</li></ul><p>Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”MinorGcæ…¢10å€ä»¥ä¸Šï¼ŒSTWçš„æ—¶é—´æ›´é•¿ï¼Œå¦‚æœMajor GCåï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±æŠ¥OOMäº†</p><h3 id="5-3-Full-GC"><a href="#5-3-Full-GC" class="headerlink" title="5.3 Full GC"></a>5.3 Full GC</h3><p>è§¦å‘FullGCæ‰§è¡Œçš„æƒ…å†µæœ‰å¦‚ä¸‹äº”ç§ï¼š</p><ul><li>è°ƒç”¨System.gcï¼ˆï¼‰æ—¶ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFullGCï¼Œä½†æ˜¯ä¸å¿…ç„¶æ‰§è¡Œ</li><li>è€å¹´ä»£ç©ºé—´ä¸è¶³</li><li>æ–¹æ³•åŒºç©ºé—´ä¸è¶³</li><li>é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜</li><li>ç”±EdenåŒºã€survivor spaceeï¼ˆFrom Spaceï¼‰åŒºå‘survivor spacelï¼ˆTo Spaceï¼‰åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œä¸”è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡å¤§å°</li></ul><p>è¯´æ˜ï¼šFull GC æ˜¯å¼€å‘æˆ–è°ƒä¼˜ä¸­å°½é‡è¦é¿å…çš„ã€‚è¿™æ ·æš‚æ—¶æ—¶é—´ä¼šçŸ­ä¸€äº›</p><h3 id="5-4-GC-ä¸¾ä¾‹"><a href="#5-4-GC-ä¸¾ä¾‹" class="headerlink" title="5.4 GC ä¸¾ä¾‹"></a>5.4 GC ä¸¾ä¾‹</h3><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªOOMçš„å¼‚å¸¸ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸æ–­çš„åˆ›å»ºå­—ç¬¦ä¸²ï¼Œæ˜¯å­˜æ”¾åœ¨å…ƒç©ºé—´çš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GCTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;        <span class="hljs-keyword">try</span> &#123;            List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();            String a = <span class="hljs-string">&quot;mogu blog&quot;</span>;            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;                list.add(a);                a = a + a;                i++;            &#125;        &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;            e.getStackTrace();        &#125;    &#125;&#125;</code></pre></div><p>è®¾ç½®JVMå¯åŠ¨å‚æ•°</p><div class="code-wrapper"><pre><code class="hljs bash">-Xms10m -Xmx10m -XX:+PrintGCDetails</code></pre></div><p>æ‰“å°å‡ºçš„æ—¥å¿—</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2038</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">500</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">2038</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">797</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.3532002</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.36</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2108</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">480</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">2405</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">1565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0014069</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2288</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">6845</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">5281</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">9133</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">5281</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3482</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3482</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0058675</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">5281</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">5281</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0002857</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">5281</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">5263</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">5281</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">5263</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3482</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3482</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0058564</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-variable">Heap</span> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">60</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">2</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd0f138</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">5263</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">73</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffb23cf0</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3514</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4498</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">390</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span>    <span class="hljs-variable">Exception</span> <span class="hljs-variable">in</span> <span class="hljs-variable">thread</span> <span class="hljs-string">&quot;main&quot;</span> <span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">OutOfMemoryError</span><span class="hljs-operator">:</span> <span class="hljs-variable">Java</span> <span class="hljs-variable">heap</span> <span class="hljs-variable">space</span><span class="hljs-variable">at</span> <span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">util</span><span class="hljs-operator">.</span><span class="hljs-built_in">Arrays</span><span class="hljs-operator">.</span><span class="hljs-variable">copyOfRange</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">Arrays</span><span class="hljs-operator">.</span><span class="hljs-variable">java</span><span class="hljs-operator">:</span><span class="hljs-number">3664</span><span class="hljs-punctuation">)</span><span class="hljs-variable">at</span> <span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-built_in">String</span><span class="hljs-operator">.&lt;</span><span class="hljs-variable">init</span><span class="hljs-operator">&gt;</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">String</span><span class="hljs-operator">.</span><span class="hljs-variable">java</span><span class="hljs-operator">:</span><span class="hljs-number">207</span><span class="hljs-punctuation">)</span><span class="hljs-variable">at</span> <span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">StringBuilder</span><span class="hljs-operator">.</span><span class="hljs-variable">toString</span><span class="hljs-punctuation">(</span><span class="hljs-variable">StringBuilder</span><span class="hljs-operator">.</span><span class="hljs-variable">java</span><span class="hljs-operator">:</span><span class="hljs-number">407</span><span class="hljs-punctuation">)</span><span class="hljs-variable">at</span> <span class="hljs-variable">com</span><span class="hljs-operator">.</span><span class="hljs-variable">atguigu</span><span class="hljs-operator">.</span><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">chapter08</span><span class="hljs-operator">.</span><span class="hljs-variable">GCTest</span><span class="hljs-operator">.</span><span class="hljs-variable">main</span><span class="hljs-punctuation">(</span><span class="hljs-variable">GCTest</span><span class="hljs-operator">.</span><span class="hljs-variable">java</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span></code></pre></div><p>è§¦å‘OOMçš„æ—¶å€™ï¼Œä¸€å®šæ˜¯è¿›è¡Œäº†ä¸€æ¬¡Full GCï¼Œå› ä¸ºåªæœ‰åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶å€™ï¼Œæ‰ä¼šçˆ†å‡ºOOMå¼‚å¸¸</p><h2 id="6-å †ç©ºé—´åˆ†ä»£æ€æƒ³"><a href="#6-å †ç©ºé—´åˆ†ä»£æ€æƒ³" class="headerlink" title="6 å †ç©ºé—´åˆ†ä»£æ€æƒ³"></a>6 å †ç©ºé—´åˆ†ä»£æ€æƒ³</h2><p> ä¸ºä»€ä¹ˆè¦æŠŠJavaå †åˆ†ä»£ï¼Ÿä¸åˆ†ä»£å°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†å—ï¼Ÿç»ç ”ç©¶ï¼Œä¸åŒå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åŒã€‚70%-99%çš„å¯¹è±¡æ˜¯ä¸´æ—¶å¯¹è±¡ã€‚</p><blockquote><p>æ–°ç”Ÿä»£ï¼šæœ‰Edenã€ä¸¤å—å¤§å°ç›¸åŒçš„survivorï¼ˆåˆç§°ä¸ºfrom/toï¼Œs0/s1ï¼‰æ„æˆï¼Œtoæ€»ä¸ºç©ºã€‚<br>è€å¹´ä»£ï¼šå­˜æ”¾æ–°ç”Ÿä»£ä¸­ç»å†å¤šæ¬¡GCä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707101511025.png" alt="image-20200707101511025"></p><p>å…¶å®ä¸åˆ†ä»£å®Œå…¨å¯ä»¥ï¼Œåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ–GCæ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰åˆ†ä»£ï¼Œé‚£æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨ä¸€å—ï¼Œå°±å¦‚åŒæŠŠä¸€ä¸ªå­¦æ ¡çš„äººéƒ½å…³åœ¨ä¸€ä¸ªæ•™å®¤ã€‚GCçš„æ—¶å€™è¦æ‰¾åˆ°å“ªäº›å¯¹è±¡æ²¡ç”¨ï¼Œè¿™æ ·å°±ä¼šå¯¹å †çš„æ‰€æœ‰åŒºåŸŸè¿›è¡Œæ‰«æã€‚è€Œå¾ˆå¤šå¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå¦‚æœåˆ†ä»£çš„è¯ï¼ŒæŠŠæ–°åˆ›å»ºçš„å¯¹è±¡æ”¾åˆ°æŸä¸€åœ°æ–¹ï¼Œå½“GCçš„æ—¶å€™å…ˆæŠŠè¿™å—å­˜å‚¨â€œæœç”Ÿå¤•æ­»â€å¯¹è±¡çš„åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å°±ä¼šè…¾å‡ºå¾ˆå¤§çš„ç©ºé—´å‡ºæ¥ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707101543871.png" alt="image-20200707101543871"></p><h2 id="7-å†…å­˜åˆ†é…ç­–ç•¥"><a href="#7-å†…å­˜åˆ†é…ç­–ç•¥" class="headerlink" title="7 å†…å­˜åˆ†é…ç­–ç•¥"></a>7 å†…å­˜åˆ†é…ç­–ç•¥</h2><p>å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ°survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨survivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡MinorGCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º15å²ï¼Œå…¶å®æ¯ä¸ªJVMã€æ¯ä¸ªGCéƒ½æœ‰æ‰€ä¸åŒï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£</p><p>å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜€å€¼ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹-xx:MaxTenuringThresholdæ¥è®¾ç½®</p><p>é’ˆå¯¹ä¸åŒå¹´é¾„æ®µçš„å¯¹è±¡åˆ†é…åŸåˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>ä¼˜å…ˆåˆ†é…åˆ°Eden<ul><li>å¼€å‘ä¸­æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ï¼Œä¼šç›´æ¥å­˜åœ¨è€å¹´ä»£ï¼Œä½†æ˜¯å› ä¸ºæ–°åˆ›å»ºçš„å¯¹è±¡ éƒ½æ˜¯ æœç”Ÿå¤•æ­»çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå¤§å¯¹è±¡å¯èƒ½ä¹Ÿå¾ˆå¿«è¢«å›æ”¶ï¼Œä½†æ˜¯å› ä¸ºè€å¹´ä»£è§¦å‘Major GCçš„æ¬¡æ•°æ¯” Minor GCè¦æ›´å°‘ï¼Œå› æ­¤å¯èƒ½å›æ”¶èµ·æ¥å°±ä¼šæ¯”è¾ƒæ…¢</li></ul></li><li>å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£<ul><li>å°½é‡é¿å…ç¨‹åºä¸­å‡ºç°è¿‡å¤šçš„å¤§å¯¹è±¡</li></ul></li><li>é•¿æœŸå­˜æ´»çš„å¯¹è±¡åˆ†é…åˆ°è€å¹´ä»£</li><li>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­<ul><li>å¦‚æœsurvivoråŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— é¡»ç­‰åˆ°MaxTenuringThreshold ä¸­è¦æ±‚çš„å¹´é¾„ã€‚</li></ul></li></ul><p>ç©ºé—´åˆ†é…æ‹…ä¿ï¼š -Xx:HandlePromotionFailure</p><ul><li>ä¹Ÿå°±æ˜¯ç»è¿‡Minor GCåï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜æ´»ï¼Œå› ä¸ºSurvivoræ¯”è¾ƒå°ï¼Œæ‰€ä»¥å°±éœ€è¦å°†Survivoræ— æ³•å®¹çº³çš„å¯¹è±¡ï¼Œå­˜æ”¾åˆ°è€å¹´ä»£ä¸­ã€‚</li></ul><h2 id="8-ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB"><a href="#8-ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB" class="headerlink" title="8 ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB"></a>8 ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB</h2><h3 id="8-1-é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ"><a href="#8-1-é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ" class="headerlink" title="8.1 é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ"></a>8.1 é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ</h3><p>ä¸ä¸€å®šï¼Œå› ä¸ºè¿˜æœ‰TLABè¿™ä¸ªæ¦‚å¿µï¼Œåœ¨å †ä¸­åˆ’åˆ†å‡ºä¸€å—åŒºåŸŸï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹æ‰€ç‹¬å </p><h3 id="8-2-ä¸ºä»€ä¹ˆæœ‰TLABï¼Ÿ"><a href="#8-2-ä¸ºä»€ä¹ˆæœ‰TLABï¼Ÿ" class="headerlink" title="8.2 ä¸ºä»€ä¹ˆæœ‰TLABï¼Ÿ"></a>8.2 ä¸ºä»€ä¹ˆæœ‰TLABï¼Ÿ</h3><p>TLABï¼šThread Local Allocation Bufferï¼Œä¹Ÿå°±æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹å•ç‹¬åˆ†é…äº†ä¸€ä¸ªç¼“å†²åŒº</p><p>å †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®</p><p>ç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨JVMä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºä¸­åˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</p><p>ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦ã€‚</p><h3 id="8-3-ä»€ä¹ˆæ˜¯TLAB"><a href="#8-3-ä»€ä¹ˆæ˜¯TLAB" class="headerlink" title="8.3 ä»€ä¹ˆæ˜¯TLAB"></a>8.3 ä»€ä¹ˆæ˜¯TLAB</h3><p>ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾æ”¶é›†çš„è§’åº¦ï¼Œå¯¹EdenåŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVMä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨Edenç©ºé—´å†…ã€‚</p><p>å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨TLABå¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¹‹ä¸ºå¿«é€Ÿåˆ†é…ç­–ç•¥ã€‚</p><p>æ®æˆ‘æ‰€çŸ¥æ‰€æœ‰OpenJDKè¡ç”Ÿå‡ºæ¥çš„JVMéƒ½æä¾›äº†TLABçš„è®¾è®¡ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707103547712.png" alt="image-20200707103547712"></p><p>å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨TLABä¸­æˆåŠŸåˆ†é…å†…å­˜ï¼Œä½†JVMç¡®å®æ˜¯å°†TLABä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ã€‚</p><p>åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-Xx:UseTLABâ€è®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-Xx:TLABWasteTargetPercentâ€è®¾ç½®TLABç©ºé—´æ‰€å ç”¨Edenç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ã€‚</p><p>ä¸€æ—¦å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVMå°±ä¼šå°è¯•ç€é€šè¿‡ä½¿ç”¨åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨Edenç©ºé—´ä¸­åˆ†é…å†…å­˜ã€‚</p><h3 id="8-4-TLABåˆ†é…è¿‡ç¨‹"><a href="#8-4-TLABåˆ†é…è¿‡ç¨‹" class="headerlink" title="8.4 TLABåˆ†é…è¿‡ç¨‹"></a>8.4 TLABåˆ†é…è¿‡ç¨‹</h3><p>å¯¹è±¡é¦–å…ˆæ˜¯é€šè¿‡TLABå¼€è¾Ÿç©ºé—´ï¼Œå¦‚æœä¸èƒ½æ”¾å…¥ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡Edenæ¥è¿›è¡Œåˆ†é…</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707104253530.png" alt="image-20200707104253530"></p><h2 id="9-å°ç»“ï¼šå †ç©ºé—´çš„å‚æ•°è®¾ç½®"><a href="#9-å°ç»“ï¼šå †ç©ºé—´çš„å‚æ•°è®¾ç½®" class="headerlink" title="9 å°ç»“ï¼šå †ç©ºé—´çš„å‚æ•°è®¾ç½®"></a>9 å°ç»“ï¼šå †ç©ºé—´çš„å‚æ•°è®¾ç½®</h2><ul><li><p>-XXï¼š+PrintFlagsInitialï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„é»˜è®¤åˆå§‹å€¼</p></li><li><p>-XXï¼š+PrintFlagsFinalï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå¯èƒ½ä¼šå­˜åœ¨ä¿®æ”¹ï¼Œä¸å†æ˜¯åˆå§‹å€¼ï¼‰</p></li><li><p>-Xmsï¼šåˆå§‹å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼‰</p></li><li><p>-Xmxï¼šæœ€å¤§å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼‰</p></li><li><p>-Xmnï¼šè®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°ã€‚ï¼ˆåˆå§‹å€¼åŠæœ€å¤§å€¼ï¼‰</p></li><li><p>-XX:NewRatioï¼šé…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”</p></li><li><p>-XX:SurvivorRatioï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­Edenå’ŒS0/S1ç©ºé—´çš„æ¯”ä¾‹</p></li><li><p>-XX:MaxTenuringThresholdï¼šè®¾ç½®æ–°ç”Ÿä»£åƒåœ¾çš„æœ€å¤§å¹´é¾„</p></li><li><p>-XXï¼š+PrintGCDetailsï¼šè¾“å‡ºè¯¦ç»†çš„GCå¤„ç†æ—¥å¿—</p><ul><li>æ‰“å°gcç®€è¦ä¿¡æ¯ï¼šâ‘ -Xxï¼š+PrintGC  â‘¡ - verbose:gc</li></ul></li><li><p>-XX:HandlePromotionFalilureï¼šæ˜¯å¦è®¾ç½®ç©ºé—´åˆ†é…æ‹…ä¿</p></li></ul><p>åœ¨å‘ç”ŸMinor GCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„æ€»ç©ºé—´ã€‚I</p><ul><li>å¦‚æœå¤§äºï¼Œåˆ™æ­¤æ¬¡Minor GCæ˜¯å®‰å…¨çš„</li><li>å¦‚æœå°äºï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹-xx:HandlePromotionFailureè®¾ç½®å€¼æ˜¯å¦å…æ‹…ä¿å¤±è´¥ã€‚<ul><li>å¦‚æœHandlePromotionFailure=trueï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚</li><li>å¦‚æœå¤§äºï¼Œåˆ™å°è¯•è¿›è¡Œä¸€æ¬¡Minor GCï¼Œä½†è¿™æ¬¡Minor GCä¾ç„¶æ˜¯æœ‰é£é™©çš„ï¼›</li><li>å¦‚æœå°äºï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡FullGCã€‚</li><li>å¦‚æœHandlePromotionFailure=falseï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Ful1 Gcã€‚</li></ul></li></ul><p>åœ¨JDK6 Update24ä¹‹åï¼ŒHandlePromotionFailureå‚æ•°ä¸ä¼šå†å½±å“åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´åˆ†é…æ‹…ä¿ç­–ç•¥ï¼Œè§‚å¯ŸopenJDKä¸­çš„æºç å˜åŒ–ï¼Œè™½ç„¶æºç ä¸­è¿˜å®šä¹‰äº†HandlePromotionFailureå‚æ•°ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­å·²ç»ä¸ä¼šå†ä½¿ç”¨å®ƒã€‚JDK6 Update 24ä¹‹åçš„è§„åˆ™å˜ä¸ºåªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°å°±ä¼šè¿›è¡ŒMinor GCï¼Œå¦åˆ™å°†è¿›è¡ŒFullGCã€‚</p><h2 id="10-å †æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©ä¹ˆï¼Ÿ"><a href="#10-å †æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©ä¹ˆï¼Ÿ" class="headerlink" title="10 å †æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©ä¹ˆï¼Ÿ"></a>10 å †æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©ä¹ˆï¼Ÿ</h2><h3 id="10-1-é€ƒé€¸åˆ†æ"><a href="#10-1-é€ƒé€¸åˆ†æ" class="headerlink" title="10.1 é€ƒé€¸åˆ†æ"></a>10.1 é€ƒé€¸åˆ†æ</h3><p>åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­å…³äºJavaå †å†…å­˜æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š</p><p>éšç€JITç¼–è¯‘æœŸçš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆâ€œç»å¯¹â€äº†ã€‚</p><p>åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡æ˜¯åœ¨Javaå †ä¸­åˆ†é…å†…å­˜çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å¸¸è¯†ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œé‚£å°±æ˜¯å¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰åå‘ç°ï¼Œä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚è¿™æ ·å°±æ— éœ€åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œä¹Ÿæ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸è§çš„å †å¤–å­˜å‚¨æŠ€æœ¯ã€‚</p><p>æ­¤å¤–ï¼Œå‰é¢æåˆ°çš„åŸºäºopenJDkæ·±åº¦å®šåˆ¶çš„TaoBaovmï¼Œå…¶ä¸­åˆ›æ–°çš„GCIHï¼ˆGC invisible heapï¼‰æŠ€æœ¯å®ç°off-heapï¼Œå°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»è‡³heapå¤–ï¼Œå¹¶ä¸”GCä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡GCçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚</p><p>å¦‚ä½•å°†å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆï¼Œéœ€è¦ä½¿ç”¨é€ƒé€¸åˆ†ææ‰‹æ®µã€‚</p><p>è¿™æ˜¯ä¸€ç§å¯ä»¥æœ‰æ•ˆå‡å°‘Javaç¨‹åºä¸­åŒæ­¥è´Ÿè½½å’Œå†…å­˜å †åˆ†é…å‹åŠ›çš„è·¨å‡½æ•°å…¨å±€æ•°æ®æµåˆ†æç®—æ³•ã€‚é€šè¿‡é€ƒé€¸åˆ†æï¼ŒJava Hotspotç¼–è¯‘å™¨èƒ½å¤Ÿåˆ†æå‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡çš„å¼•ç”¨çš„ä½¿ç”¨èŒƒå›´ä»è€Œå†³å®šæ˜¯å¦è¦å°†è¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°å †ä¸Šã€‚é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼š</p><ul><li>å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå¯¹è±¡åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚</li><li>å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå®ƒè¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿé€ƒé€¸ã€‚ä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹ä¸­ã€‚</li></ul><h4 id="1-é€ƒé€¸åˆ†æä¸¾ä¾‹"><a href="#1-é€ƒé€¸åˆ†æä¸¾ä¾‹" class="headerlink" title="1 é€ƒé€¸åˆ†æä¸¾ä¾‹"></a>1 é€ƒé€¸åˆ†æä¸¾ä¾‹</h4><p>æ²¡æœ‰å‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡ï¼Œåˆ™å¯ä»¥åˆ†é…åˆ°æ ˆä¸Šï¼Œéšç€æ–¹æ³•æ‰§è¡Œçš„ç»“æŸï¼Œæ ˆç©ºé—´å°±è¢«ç§»é™¤ï¼Œæ¯ä¸ªæ ˆé‡Œé¢åŒ…å«äº†å¾ˆå¤šæ ˆå¸§ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿé€ƒé€¸åˆ†æ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">my_method</span><span class="hljs-params">()</span> </span>&#123;    V v = <span class="hljs-keyword">new</span> V();    <span class="hljs-comment">// use v</span>    <span class="hljs-comment">// ....</span>    v = <span class="hljs-keyword">null</span>;&#125;</code></pre></div><p>é’ˆå¯¹ä¸‹é¢çš„ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StringBuffer <span class="hljs-title">createStringBuffer</span><span class="hljs-params">(String s1, String s2)</span> </span>&#123;    StringBuffer sb = <span class="hljs-keyword">new</span> StringBuffer();    sb.append(s1);    sb.append(s2);    <span class="hljs-keyword">return</span> sb;&#125;</code></pre></div><p>å¦‚æœæƒ³è¦StringBuffer sbä¸å‘ç”Ÿé€ƒé€¸ï¼Œå¯ä»¥è¿™æ ·å†™</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">createStringBuffer</span><span class="hljs-params">(String s1, String s2)</span> </span>&#123;    StringBuffer sb = <span class="hljs-keyword">new</span> StringBuffer();    sb.append(s1);    sb.append(s2);    <span class="hljs-keyword">return</span> sb.toString();&#125;</code></pre></div><p>å®Œæ•´çš„é€ƒé€¸åˆ†æä»£ç ä¸¾ä¾‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * é€ƒé€¸åˆ†æ</span><span class="hljs-comment"> * å¦‚ä½•å¿«é€Ÿçš„åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸åˆ†æï¼Œå¤§å®¶å°±çœ‹newçš„å¯¹è±¡æ˜¯å¦åœ¨æ–¹æ³•å¤–è¢«è°ƒç”¨ã€‚</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EscapeAnalysis</span> </span>&#123;    <span class="hljs-keyword">public</span> EscapeAnalysis obj;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ–¹æ³•è¿”å›EscapeAnalysiså¯¹è±¡ï¼Œå‘ç”Ÿé€ƒé€¸</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> EscapeAnalysis <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> obj == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">new</span> EscapeAnalysis():obj;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¸ºæˆå‘˜å±æ€§èµ‹å€¼ï¼Œå‘ç”Ÿé€ƒé€¸</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setObj</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">this</span>.obj = <span class="hljs-keyword">new</span> EscapeAnalysis();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å¯¹è±¡çš„ä½œç”¨äºä»…åœ¨å½“å‰æ–¹æ³•ä¸­æœ‰æ•ˆï¼Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">useEscapeAnalysis</span><span class="hljs-params">()</span> </span>&#123;        EscapeAnalysis e = <span class="hljs-keyword">new</span> EscapeAnalysis();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å¼•ç”¨æˆå‘˜å˜é‡çš„å€¼ï¼Œå‘ç”Ÿé€ƒé€¸</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">useEscapeAnalysis2</span><span class="hljs-params">()</span> </span>&#123;        EscapeAnalysis e = getInstance();        <span class="hljs-comment">// getInstance().XXX  å‘ç”Ÿé€ƒé€¸</span>    &#125;&#125;</code></pre></div><h4 id="2-å‚æ•°è®¾ç½®"><a href="#2-å‚æ•°è®¾ç½®" class="headerlink" title="2 å‚æ•°è®¾ç½®"></a>2 å‚æ•°è®¾ç½®</h4><p>åœ¨JDK 1.7 ç‰ˆæœ¬ä¹‹åï¼ŒHotSpotä¸­é»˜è®¤å°±å·²ç»å¼€å¯äº†é€ƒé€¸åˆ†æ</p><p>å¦‚æœä½¿ç”¨çš„æ˜¯è¾ƒæ—©çš„ç‰ˆæœ¬ï¼Œå¼€å‘äººå‘˜åˆ™å¯ä»¥é€šè¿‡ï¼š</p><ul><li>é€‰é¡¹â€œ-xxï¼š+DoEscapeAnalysisâ€æ˜¾å¼å¼€å¯é€ƒé€¸åˆ†æ</li><li>é€šè¿‡é€‰é¡¹â€œ-xxï¼š+PrintEscapeAnalysisâ€æŸ¥çœ‹é€ƒé€¸åˆ†æçš„ç­›é€‰ç»“æœ</li></ul><h4 id="3-ç»“è®º"><a href="#3-ç»“è®º" class="headerlink" title="3 ç»“è®º"></a>3 ç»“è®º</h4><p>å¼€å‘ä¸­èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡çš„ï¼Œå°±ä¸è¦ä½¿ç”¨åœ¨æ–¹æ³•å¤–å®šä¹‰ã€‚</p><p>ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–ï¼š</p><ul><li>æ ˆä¸Šåˆ†é…ï¼šå°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆä¸Šåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †ä¸Šåˆ†é…</li><li>åŒæ­¥çœç•¥ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚</li><li>åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢ï¼šæœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ã€‚</li></ul><h3 id="10-2-æ ˆä¸Šåˆ†é…"><a href="#10-2-æ ˆä¸Šåˆ†é…" class="headerlink" title="10.2 æ ˆä¸Šåˆ†é…"></a>10.2 æ ˆä¸Šåˆ†é…</h3><p>JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚</p><p>å¸¸è§çš„æ ˆä¸Šåˆ†é…çš„åœºæ™¯</p><blockquote><p>åœ¨é€ƒé€¸åˆ†æä¸­ï¼Œå·²ç»è¯´æ˜äº†ã€‚åˆ†åˆ«æ˜¯ç»™æˆå‘˜å˜é‡èµ‹å€¼ã€æ–¹æ³•è¿”å›å€¼ã€å®ä¾‹å¼•ç”¨ä¼ é€’ã€‚</p></blockquote><h4 id="ä¸¾ä¾‹-1"><a href="#ä¸¾ä¾‹-1" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h4><p>æˆ‘ä»¬é€šè¿‡ä¸¾ä¾‹æ¥è¯´æ˜ å¼€å¯é€ƒé€¸åˆ†æ å’Œ æœªå¼€å¯é€ƒé€¸åˆ†ææ—¶å€™çš„æƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * æ ˆä¸Šåˆ†é…</span><span class="hljs-comment"> * -Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails</span><span class="hljs-comment"> */</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;    <span class="hljs-keyword">private</span> String name;    <span class="hljs-keyword">private</span> String age;    <span class="hljs-keyword">private</span> String gender;    <span class="hljs-keyword">private</span> String phone;&#125;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackAllocation</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000000</span>; i++) &#123;            alloc();        &#125;        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();        System.out.println(<span class="hljs-string">&quot;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š&quot;</span> + (end - start) + <span class="hljs-string">&quot; ms&quot;</span>);        <span class="hljs-comment">// ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹å †å†…å­˜ä¸­å¯¹è±¡ä¸ªæ•°ï¼Œçº¿ç¨‹sleep</span>        Thread.sleep(<span class="hljs-number">10000000</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">alloc</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// æœªå‘ç”Ÿé€ƒé€¸</span>        User user = <span class="hljs-keyword">new</span> User();     &#125;&#125;</code></pre></div><p>è®¾ç½®JVMå‚æ•°ï¼Œè¡¨ç¤ºæœªå¼€å¯é€ƒé€¸åˆ†æ</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails</span></code></pre></div><p>è¿è¡Œç»“æœï¼ŒåŒæ—¶è¿˜è§¦å‘äº†GCæ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs plain">èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š664 ms</code></pre></div><p>ç„¶åæŸ¥çœ‹å†…å­˜çš„æƒ…å†µï¼Œå‘ç°æœ‰å¤§é‡çš„Userå­˜å‚¨åœ¨å †ä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707203038615.png" alt="image-20200707203038615"></p><p>æˆ‘ä»¬åœ¨å¼€å¯é€ƒé€¸åˆ†æ</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xmx1G -Xms1G -XX:+DoEscapeAnalysis -XX:+PrintGCDetails</span></code></pre></div><p>ç„¶åæŸ¥çœ‹è¿è¡Œæ—¶é—´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå‘ç°èŠ±è´¹çš„æ—¶é—´å¿«é€Ÿå‡å°‘ï¼ŒåŒæ—¶ä¸ä¼šå‘ç”ŸGCæ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs plain">èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š5 ms</code></pre></div><p>åœ¨çœ‹å†…å­˜æƒ…å†µï¼Œæˆ‘ä»¬å‘ç°åªæœ‰å¾ˆå°‘çš„Userå¯¹è±¡ï¼Œè¯´æ˜Useræœªå‘ç”Ÿé€ƒé€¸ï¼Œå› ä¸ºå®ƒå­˜å‚¨åœ¨æ ˆä¸­ï¼Œéšç€æ ˆçš„é”€æ¯è€Œæ¶ˆå¤±</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707203441718.png" alt="image-20200707203441718"></p><h3 id="10-3-åŒæ­¥çœç•¥"><a href="#10-3-åŒæ­¥çœç•¥" class="headerlink" title="10.3 åŒæ­¥çœç•¥"></a>10.3 åŒæ­¥çœç•¥</h3><p>çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚</p><p>åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†ææ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥ã€‚è¿™æ ·å°±èƒ½å¤§å¤§æé«˜å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚è¿™ä¸ªå–æ¶ˆåŒæ­¥çš„è¿‡ç¨‹å°±å«åŒæ­¥çœç•¥ï¼Œä¹Ÿå«é”æ¶ˆé™¤ã€‚</p><p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123;    Object hellis = <span class="hljs-keyword">new</span> Object();    <span class="hljs-keyword">synchronized</span>(hellis) &#123;        System.out.println(hellis);    &#125;&#125;</code></pre></div><p>ä»£ç ä¸­å¯¹hellisè¿™ä¸ªå¯¹è±¡åŠ é”ï¼Œä½†æ˜¯helliså¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåªåœ¨f()æ–¹æ³•ä¸­ï¼Œå¹¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰€è®¿é—®åˆ°ï¼Œæ‰€ä»¥åœ¨JITç¼–è¯‘é˜¶æ®µå°±ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œä¼˜åŒ–æˆï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123;    Object hellis = <span class="hljs-keyword">new</span> Object();System.out.println(hellis);&#125;</code></pre></div><p>æˆ‘ä»¬å°†å…¶è½¬æ¢æˆå­—èŠ‚ç </p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200707205634266.png" alt="image-20200707205634266"></p><h3 id="10-4-åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢"><a href="#10-4-åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢" class="headerlink" title="10.4 åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢"></a>10.4 åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢</h3><p>æ ‡é‡ï¼ˆscalarï¼‰æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°çš„æ•°æ®çš„æ•°æ®ã€‚Javaä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚</p><p>ç›¸å¯¹çš„ï¼Œé‚£äº›è¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«åšèšåˆé‡ï¼ˆAggregateï¼‰ï¼ŒJavaä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºä»–å¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚</p><p>åœ¨JITé˜¶æ®µï¼Œå¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡JITä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªå…¶ä¸­åŒ…å«çš„è‹¥å¹²ä¸ªæˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢ã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span> </span>&#123;    alloc();&#125;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> x;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> y;&#125;<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">alloc</span><span class="hljs-params">()</span> </span>&#123;    Point point = <span class="hljs-keyword">new</span> Point(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);    System.out.println(<span class="hljs-string">&quot;point.x&quot;</span> + point.x + <span class="hljs-string">&quot;;point.y&quot;</span> + point.y);&#125;</code></pre></div><p>ä»¥ä¸Šä»£ç ï¼Œç»è¿‡æ ‡é‡æ›¿æ¢åï¼Œå°±ä¼šå˜æˆ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">alloc</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">int</span> x = <span class="hljs-number">1</span>;    <span class="hljs-keyword">int</span> y = <span class="hljs-number">2</span>;    System.out.println(<span class="hljs-string">&quot;point.x = &quot;</span> + x + <span class="hljs-string">&quot;; point.y=&quot;</span> + y);&#125;</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒPointè¿™ä¸ªèšåˆé‡ç»è¿‡é€ƒé€¸åˆ†æåï¼Œå‘ç°ä»–å¹¶æ²¡æœ‰é€ƒé€¸ï¼Œå°±è¢«æ›¿æ¢æˆä¸¤ä¸ªæ ‡é‡äº†ã€‚é‚£ä¹ˆæ ‡é‡æ›¿æ¢æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå°±æ˜¯å¯ä»¥å¤§å¤§å‡å°‘å †å†…å­˜çš„å ç”¨ã€‚å› ä¸ºä¸€æ—¦ä¸éœ€è¦åˆ›å»ºå¯¹è±¡äº†ï¼Œé‚£ä¹ˆå°±ä¸å†éœ€è¦åˆ†é…å †å†…å­˜äº†ã€‚<br>æ ‡é‡æ›¿æ¢ä¸ºæ ˆä¸Šåˆ†é…æä¾›äº†å¾ˆå¥½çš„åŸºç¡€ã€‚</p><h3 id="10-5-ä»£ç ä¼˜åŒ–ä¹‹æ ‡é‡æ›¿æ¢"><a href="#10-5-ä»£ç ä¼˜åŒ–ä¹‹æ ‡é‡æ›¿æ¢" class="headerlink" title="10.5 ä»£ç ä¼˜åŒ–ä¹‹æ ‡é‡æ›¿æ¢"></a>10.5 ä»£ç ä¼˜åŒ–ä¹‹æ ‡é‡æ›¿æ¢</h3><p>ä¸Šè¿°ä»£ç åœ¨ä¸»å‡½æ•°ä¸­è¿›è¡Œäº†1äº¿æ¬¡allocã€‚è°ƒç”¨è¿›è¡Œå¯¹è±¡åˆ›å»ºï¼Œç”±äºUserå¯¹è±¡å®ä¾‹éœ€è¦å æ®çº¦16å­—èŠ‚çš„ç©ºé—´ï¼Œå› æ­¤ç´¯è®¡åˆ†é…ç©ºé—´è¾¾åˆ°å°†è¿‘1.5GBã€‚å¦‚æœå †ç©ºé—´å°äºè¿™ä¸ªå€¼ï¼Œå°±å¿…ç„¶ä¼šå‘ç”ŸGCã€‚ä½¿ç”¨å¦‚ä¸‹å‚æ•°è¿è¡Œä¸Šè¿°ä»£ç ï¼š</p><div class="code-wrapper"><pre><code class="hljs bash">-server -Xmx100m -Xms100m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:+EliminateAllocations</code></pre></div><p>è¿™é‡Œè®¾ç½®å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>å‚æ•°-serverï¼šå¯åŠ¨Serveræ¨¡å¼ï¼Œå› ä¸ºåœ¨serveræ¨¡å¼ä¸‹ï¼Œæ‰å¯ä»¥å¯ç”¨é€ƒé€¸åˆ†æã€‚</li><li>å‚æ•°-XX:+DoEscapeAnalysisï¼šå¯ç”¨é€ƒé€¸åˆ†æ</li><li>å‚æ•°-Xmx10mï¼šæŒ‡å®šäº†å †ç©ºé—´æœ€å¤§ä¸º10MB</li><li>å‚æ•°-XX:+PrintGCï¼šå°†æ‰“å°Gcæ—¥å¿—</li><li>å‚æ•°ä¸€xxï¼š+EliminateAllocationsï¼šå¼€å¯äº†æ ‡é‡æ›¿æ¢ï¼ˆé»˜è®¤æ‰“å¼€ï¼‰ï¼Œå…è®¸å°†å¯¹è±¡æ‰“æ•£åˆ†é…åœ¨æ ˆä¸Šï¼Œæ¯”å¦‚å¯¹è±¡æ‹¥æœ‰idå’Œnameä¸¤ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå­—æ®µå°†ä¼šè¢«è§†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å±€éƒ¨å˜é‡è¿›è¡Œåˆ†é…</li></ul><h3 id="10-6-é€ƒé€¸åˆ†æçš„ä¸è¶³"><a href="#10-6-é€ƒé€¸åˆ†æçš„ä¸è¶³" class="headerlink" title="10.6 é€ƒé€¸åˆ†æçš„ä¸è¶³"></a>10.6 é€ƒé€¸åˆ†æçš„ä¸è¶³</h3><p>å…³äºé€ƒé€¸åˆ†æçš„è®ºæ–‡åœ¨1999å¹´å°±å·²ç»å‘è¡¨äº†ï¼Œä½†ç›´åˆ°JDK1.6æ‰æœ‰å®ç°ï¼Œè€Œä¸”è¿™é¡¹æŠ€æœ¯åˆ°å¦‚ä»Šä¹Ÿå¹¶ä¸æ˜¯ååˆ†æˆç†Ÿã€‚</p><p>å…¶æ ¹æœ¬åŸå› å°±æ˜¯æ— æ³•ä¿è¯é€ƒé€¸åˆ†æçš„æ€§èƒ½æ¶ˆè€—ä¸€å®šèƒ½é«˜äºä»–çš„æ¶ˆè€—ã€‚è™½ç„¶ç»è¿‡é€ƒé€¸åˆ†æå¯ä»¥åšæ ‡é‡æ›¿æ¢ã€æ ˆä¸Šåˆ†é…ã€å’Œé”æ¶ˆé™¤ã€‚ä½†æ˜¯é€ƒé€¸åˆ†æè‡ªèº«ä¹Ÿæ˜¯éœ€è¦è¿›è¡Œä¸€ç³»åˆ—å¤æ‚çš„åˆ†æçš„ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ã€‚<br>ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œå°±æ˜¯ç»è¿‡é€ƒé€¸åˆ†æä¹‹åï¼Œå‘ç°æ²¡æœ‰ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ã€‚é‚£è¿™ä¸ªé€ƒé€¸åˆ†æçš„è¿‡ç¨‹å°±ç™½ç™½æµªè´¹æ‰äº†ã€‚</p><p>è™½ç„¶è¿™é¡¹æŠ€æœ¯å¹¶ä¸ååˆ†æˆç†Ÿï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ä¸­ä¸€ä¸ªååˆ†é‡è¦çš„æ‰‹æ®µã€‚æ³¨æ„åˆ°æœ‰ä¸€äº›è§‚ç‚¹ï¼Œè®¤ä¸ºé€šè¿‡é€ƒé€¸åˆ†æï¼ŒJVMä¼šåœ¨æ ˆä¸Šåˆ†é…é‚£äº›ä¸ä¼šé€ƒé€¸çš„å¯¹è±¡ï¼Œè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å–å†³äºJvMè®¾è®¡è€…çš„é€‰æ‹©ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œoracle Hotspot JVMä¸­å¹¶æœªè¿™ä¹ˆåšï¼Œè¿™ä¸€ç‚¹åœ¨é€ƒé€¸åˆ†æç›¸å…³çš„æ–‡æ¡£é‡Œå·²ç»è¯´æ˜ï¼Œæ‰€ä»¥å¯ä»¥æ˜ç¡®æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ›å»ºåœ¨å †ä¸Šã€‚</p><p>ç›®å‰å¾ˆå¤šä¹¦ç±è¿˜æ˜¯åŸºäºJDK7ä»¥å‰çš„ç‰ˆæœ¬ï¼ŒJDKå·²ç»å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼Œinternå­—ç¬¦ä¸²çš„ç¼“å­˜å’Œé™æ€å˜é‡æ›¾ç»éƒ½è¢«åˆ†é…åœ¨æ°¸ä¹…ä»£ä¸Šï¼Œè€Œæ°¸ä¹…ä»£å·²ç»è¢«å…ƒæ•°æ®åŒºå–ä»£ã€‚ä½†æ˜¯ï¼Œinternå­—ç¬¦ä¸²ç¼“å­˜å’Œé™æ€å˜é‡å¹¶ä¸æ˜¯è¢«è½¬ç§»åˆ°å…ƒæ•°æ®åŒºï¼Œè€Œæ˜¯ç›´æ¥åœ¨å †ä¸Šåˆ†é…ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹åŒæ ·ç¬¦åˆå‰é¢ä¸€ç‚¹çš„ç»“è®ºï¼šå¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚</p><h2 id="11-å°ç»“"><a href="#11-å°ç»“" class="headerlink" title="11 å°ç»“"></a>11 å°ç»“</h2><p>å¹´è½»ä»£æ˜¯å¯¹è±¡çš„è¯ç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™é‡Œäº§ç”Ÿã€åº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ã€ç»“æŸç”Ÿå‘½ã€‚</p><p>è€å¹´ä»£æ”¾ç½®é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œé€šå¸¸éƒ½æ˜¯ä»survivoråŒºåŸŸç­›é€‰æ‹·è´è¿‡æ¥çš„Javaå¯¹è±¡ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“æ™®é€šçš„å¯¹è±¡ä¼šè¢«åˆ†é…åœ¨TLABä¸Šï¼›å¦‚æœå¯¹è±¡è¾ƒå¤§ï¼ŒJVMä¼šè¯•å›¾ç›´æ¥åˆ†é…åœ¨Edenå…¶ä»–ä½ç½®ä¸Šï¼›å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œå®Œå…¨æ— æ³•åœ¨æ–°ç”Ÿä»£æ‰¾åˆ°è¶³å¤Ÿé•¿çš„è¿ç»­ç©ºé—²ç©ºé—´ï¼ŒJVMå°±ä¼šç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚å½“GCåªå‘ç”Ÿåœ¨å¹´è½»ä»£ä¸­ï¼Œå›æ”¶å¹´è½»ä»£å¯¹è±¡çš„è¡Œä¸ºè¢«ç§°ä¸ºMinorGcã€‚</p><p>å½“GCå‘ç”Ÿåœ¨è€å¹´ä»£æ—¶åˆ™è¢«ç§°ä¸ºMajorGcæˆ–è€…FullGCã€‚ä¸€èˆ¬çš„ï¼ŒMinorGcçš„å‘ç”Ÿé¢‘ç‡è¦æ¯”MajorGCé«˜å¾ˆå¤šï¼Œå³è€å¹´ä»£ä¸­åƒåœ¾å›æ”¶å‘ç”Ÿçš„é¢‘ç‡å°†å¤§å¤§ä½äºå¹´è½»ä»£ã€‚</p><h1 id="ç¬¬9ç« -æ–¹æ³•åŒº"><a href="#ç¬¬9ç« -æ–¹æ³•åŒº" class="headerlink" title="ç¬¬9ç«  æ–¹æ³•åŒº"></a>ç¬¬9ç«  æ–¹æ³•åŒº</h1><h2 id="9-1-å‰è¨€"><a href="#9-1-å‰è¨€" class="headerlink" title="9.1 å‰è¨€"></a>9.1 å‰è¨€</h2><p>è¿™æ¬¡æ‰€è®²è¿°çš„æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºçš„æœ€åä¸€ä¸ªéƒ¨åˆ†</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708093918121.png" alt="image-20200708093918121"></p><p>ä»çº¿ç¨‹å…±äº«ä¸å¦çš„è§’åº¦æ¥çœ‹</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708093918121-1628001815741190.png" alt="image-20200708093918121"></p><p>ThreadLocalï¼šå¦‚ä½•ä¿è¯å¤šä¸ªçº¿ç¨‹åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§ï¼Ÿå…¸å‹åº”ç”¨å°±æ˜¯æ•°æ®åº“è¿æ¥ç®¡ç†ï¼Œä»¥åŠä¼šè¯ç®¡ç†</p><h2 id="9-2-æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»"><a href="#9-2-æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»" class="headerlink" title="9.2 æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»"></a>9.2 æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»</h2><p>ä¸‹é¢å°±æ¶‰åŠäº†å¯¹è±¡çš„è®¿é—®å®šä½</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708094747667.png" alt="image-20200708094747667"></p><ul><li>Personï¼šå­˜æ”¾åœ¨å…ƒç©ºé—´ï¼Œä¹Ÿå¯ä»¥è¯´æ–¹æ³•åŒº</li><li>personï¼šå­˜æ”¾åœ¨Javaæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­</li><li>new Person()ï¼šå­˜æ”¾åœ¨Javaå †ä¸­</li></ul><h2 id="9-3-æ–¹æ³•åŒºçš„ç†è§£"><a href="#9-3-æ–¹æ³•åŒºçš„ç†è§£" class="headerlink" title="9.3 æ–¹æ³•åŒºçš„ç†è§£"></a>9.3 æ–¹æ³•åŒºçš„ç†è§£</h2><p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ˜ç¡®è¯´æ˜ï¼šâ€œå°½ç®¡æ‰€æœ‰çš„æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸€äº›ç®€å•çš„å®ç°å¯èƒ½ä¸ä¼šé€‰æ‹©å»è¿›è¡Œåƒåœ¾æ”¶é›†æˆ–è€…è¿›è¡Œå‹ç¼©ã€‚â€ä½†å¯¹äºHotSpotJVMè€Œè¨€ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åå«åšNon-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„å°±æ˜¯è¦å’Œå †åˆ†å¼€ã€‚</p><p>æ‰€ä»¥ï¼Œæ–¹æ³•åŒºçœ‹ä½œæ˜¯ä¸€å—ç‹¬ç«‹äºJavaå †çš„å†…å­˜ç©ºé—´ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708095853544.png" alt="image-20200708095853544"></p><p>æ–¹æ³•åŒºä¸»è¦å­˜æ”¾çš„æ˜¯ Classï¼Œè€Œå †ä¸­ä¸»è¦å­˜æ”¾çš„æ˜¯ å®ä¾‹åŒ–çš„å¯¹è±¡</p><ul><li>æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸Javaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚</li><li>æ–¹æ³•åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¹¶ä¸”å®ƒçš„å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´ä¸­å’ŒJavaå †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</li><li>æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•ã€‚</li><li>æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯ï¼šava.lang.OutofMemoryErrorï¼šPermGen space æˆ–è€…java.lang.OutOfMemoryError:Metaspace<ul><li>åŠ è½½å¤§é‡çš„ç¬¬ä¸‰æ–¹çš„jaråŒ…</li><li>Tomcatéƒ¨ç½²çš„å·¥ç¨‹è¿‡å¤šï¼ˆ30~50ä¸ªï¼‰</li><li>å¤§é‡åŠ¨æ€çš„ç”Ÿæˆåå°„ç±»</li></ul></li><li>å…³é—­JVMå°±ä¼šé‡Šæ”¾è¿™ä¸ªåŒºåŸŸçš„å†…å­˜ã€‚</li></ul><h3 id="HotSpotä¸­æ–¹æ³•åŒºçš„æ¼”è¿›"><a href="#HotSpotä¸­æ–¹æ³•åŒºçš„æ¼”è¿›" class="headerlink" title="HotSpotä¸­æ–¹æ³•åŒºçš„æ¼”è¿›"></a>HotSpotä¸­æ–¹æ³•åŒºçš„æ¼”è¿›</h3><p>åœ¨jdk7åŠä»¥å‰ï¼Œä¹ æƒ¯ä¸ŠæŠŠæ–¹æ³•åŒºï¼Œç§°ä¸ºæ°¸ä¹…ä»£ã€‚jdk8å¼€å§‹ï¼Œä½¿ç”¨å…ƒç©ºé—´å–ä»£äº†æ°¸ä¹…ä»£ã€‚</p><ul><li>JDK 1.8åï¼Œå…ƒç©ºé—´å­˜æ”¾åœ¨å †å¤–å†…å­˜ä¸­</li></ul><p>æœ¬è´¨ä¸Šï¼Œæ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£å¹¶ä¸ç­‰ä»·ã€‚ä»…æ˜¯å¯¹hotspotè€Œè¨€çš„ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹å¦‚ä½•å®ç°æ–¹æ³•åŒºï¼Œä¸åšç»Ÿä¸€è¦æ±‚ã€‚ä¾‹å¦‚ï¼šBEAJRockit / IBM J9 ä¸­ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µã€‚            </p><blockquote><p>ç°åœ¨æ¥çœ‹ï¼Œå½“å¹´ä½¿ç”¨æ°¸ä¹…ä»£ï¼Œä¸æ˜¯å¥½çš„ideaã€‚å¯¼è‡´Javaç¨‹åºæ›´å®¹æ˜“oomï¼ˆè¶…è¿‡-XX:MaxPermsizeä¸Šé™ï¼‰</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708102919149.png" alt="image-20200708102919149"></p><p>è€Œåˆ°äº†JDK8ï¼Œç»ˆäºå®Œå…¨åºŸå¼ƒäº†æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼Œæ”¹ç”¨ä¸JRockitã€J9ä¸€æ ·åœ¨æœ¬åœ°å†…å­˜ä¸­å®ç°çš„å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰æ¥ä»£æ›¿</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708103055914.png" alt="image-20200708103055914"></p><p>å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´ä¸åœ¨è™šæ‹Ÿæœºè®¾ç½®çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜</p><p>æ°¸ä¹…ä»£ã€å…ƒç©ºé—´äºŒè€…å¹¶ä¸åªæ˜¯åå­—å˜äº†ï¼Œå†…éƒ¨ç»“æ„ä¹Ÿè°ƒæ•´äº†</p><p>æ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼Œå¦‚æœæ–¹æ³•åŒºæ— æ³•æ»¡è¶³æ–°çš„å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡ºOOMå¼‚å¸¸</p><h2 id="9-4-è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM"><a href="#9-4-è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM" class="headerlink" title="9.4 è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM"></a>9.4 è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM</h2><p>æ–¹æ³•åŒºçš„å¤§å°ä¸å¿…æ˜¯å›ºå®šçš„ï¼ŒJVMå¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€è¦åŠ¨æ€è°ƒæ•´ã€‚ </p><h3 id="1-jdk7åŠä»¥å‰"><a href="#1-jdk7åŠä»¥å‰" class="headerlink" title="1 jdk7åŠä»¥å‰"></a>1 jdk7åŠä»¥å‰</h3><ul><li>é€šè¿‡-xx:Permsizeæ¥è®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´ã€‚é»˜è®¤å€¼æ˜¯20.75M</li><li>-XX:MaxPermsizeæ¥è®¾å®šæ°¸ä¹…ä»£æœ€å¤§å¯åˆ†é…ç©ºé—´ã€‚32ä½æœºå™¨é»˜è®¤æ˜¯64Mï¼Œ64ä½æœºå™¨æ¨¡å¼æ˜¯82M</li><li>å½“JVMåŠ è½½çš„ç±»ä¿¡æ¯å®¹é‡è¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œä¼šæŠ¥å¼‚å¸¸OutofMemoryError:PermGen spaceã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708111756800.png" alt="image-20200708111756800"></p><h3 id="2-JDK8ä»¥å"><a href="#2-JDK8ä»¥å" class="headerlink" title="2 JDK8ä»¥å"></a>2 JDK8ä»¥å</h3><p>å…ƒæ•°æ®åŒºå¤§å°å¯ä»¥ä½¿ç”¨å‚æ•° -XX:MetaspaceSize å’Œ -XX:MaxMetaspaceSizeæŒ‡å®š</p><p>é»˜è®¤å€¼ä¾èµ–äºå¹³å°ã€‚windowsä¸‹ï¼Œ-XX:MetaspaceSizeæ˜¯21Mï¼Œ-XX:MaxMetaspaceSizeçš„å€¼æ˜¯-1ï¼Œå³æ²¡æœ‰é™åˆ¶ã€‚</p><p>ä¸æ°¸ä¹…ä»£ä¸åŒï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœå…ƒæ•°æ®åŒºå‘ç”Ÿæº¢å‡ºï¼Œè™šæ‹Ÿæœºä¸€æ ·ä¼šæŠ›å‡ºå¼‚å¸¸OutOfMemoryError:Metaspace</p><p>-XX:MetaspaceSizeï¼šè®¾ç½®åˆå§‹çš„å…ƒç©ºé—´å¤§å°ã€‚å¯¹äºä¸€ä¸ª64ä½çš„æœåŠ¡å™¨ç«¯JVMæ¥è¯´ï¼Œå…¶é»˜è®¤çš„-xx:MetaspaceSizeå€¼ä¸º21MBã€‚è¿™å°±æ˜¯åˆå§‹çš„é«˜æ°´ä½çº¿ï¼Œä¸€æ—¦è§¦åŠè¿™ä¸ªæ°´ä½çº¿ï¼ŒFullGCå°†ä¼šè¢«è§¦å‘å¹¶å¸è½½æ²¡ç”¨çš„ç±»ï¼ˆå³è¿™äº›ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ç„¶åè¿™ä¸ªé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿çš„å€¼å–å†³äºGCåé‡Šæ”¾äº†å¤šå°‘å…ƒç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é€‚å½“é™ä½è¯¥å€¼ã€‚</p><p>å¦‚æœåˆå§‹åŒ–çš„é«˜æ°´ä½çº¿è®¾ç½®è¿‡ä½ï¼Œä¸Šè¿°é«˜æ°´ä½çº¿è°ƒæ•´æƒ…å†µä¼šå‘ç”Ÿå¾ˆå¤šæ¬¡ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨çš„æ—¥å¿—å¯ä»¥è§‚å¯Ÿåˆ°FullGCå¤šæ¬¡è°ƒç”¨ã€‚ä¸ºäº†é¿å…é¢‘ç¹åœ°GCï¼Œå»ºè®®å°†-XX:MetaspaceSizeè®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„å€¼ã€‚</p><h3 id="3-å¦‚ä½•è§£å†³è¿™äº›OOM"><a href="#3-å¦‚ä½•è§£å†³è¿™äº›OOM" class="headerlink" title="3 å¦‚ä½•è§£å†³è¿™äº›OOM"></a>3 å¦‚ä½•è§£å†³è¿™äº›OOM</h3><ul><li><p>è¦è§£å†³ooMå¼‚å¸¸æˆ–heap spaceçš„å¼‚å¸¸ï¼Œä¸€èˆ¬çš„æ‰‹æ®µæ˜¯é¦–å…ˆé€šè¿‡å†…å­˜æ˜ åƒåˆ†æå·¥å…·ï¼ˆå¦‚Ec1ipse Memory Analyzerï¼‰å¯¹dumpå‡ºæ¥çš„å †è½¬å‚¨å¿«ç…§è¿›è¡Œåˆ†æï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆåˆ†æ¸…æ¥šåˆ°åº•æ˜¯å‡ºç°äº†å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰è¿˜æ˜¯å†…å­˜æº¢å‡ºï¼ˆMemory Overflowï¼‰</p><ul><li>å†…å­˜æ³„æ¼å°±æ˜¯ æœ‰å¤§é‡çš„å¼•ç”¨æŒ‡å‘æŸäº›å¯¹è±¡ï¼Œä½†æ˜¯è¿™äº›å¯¹è±¡ä»¥åä¸ä¼šä½¿ç”¨äº†ï¼Œä½†æ˜¯å› ä¸ºå®ƒä»¬è¿˜å’ŒGC ROOTæœ‰å…³è”ï¼Œæ‰€ä»¥å¯¼è‡´ä»¥åè¿™äº›å¯¹è±¡ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜</li></ul></li><li><p>å¦‚æœæ˜¯å†…å­˜æ³„æ¼ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„æ¼å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ã€‚äºæ˜¯å°±èƒ½æ‰¾åˆ°æ³„æ¼å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„è·¯å¾„ä¸GCRootsç›¸å…³è”å¹¶å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•è‡ªåŠ¨å›æ”¶å®ƒä»¬çš„ã€‚æŒæ¡äº†æ³„æ¼å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠGCRootså¼•ç”¨é“¾çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥æ¯”è¾ƒå‡†ç¡®åœ°å®šä½å‡ºæ³„æ¼ä»£ç çš„ä½ç½®ã€‚</p></li><li><p>å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ç¡®å®éƒ½è¿˜å¿…é¡»å­˜æ´»ç€ï¼Œé‚£å°±åº”å½“æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ-Xmxä¸-Xmsï¼‰ï¼Œä¸æœºå™¨ç‰©ç†å†…å­˜å¯¹æ¯”çœ‹æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œå°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚</p></li></ul><h2 id="9-5-æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„"><a href="#9-5-æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„" class="headerlink" title="9.5  æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„"></a>9.5  æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„</h2><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708161728320.png" alt="image-20200708161728320"></p><p>ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¹¦ä¸­å¯¹æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰å­˜å‚¨å†…å®¹æè¿°å¦‚ä¸‹ï¼šå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708161856504.png" alt="image-20200708161856504"></p><h3 id="1-ç±»å‹ä¿¡æ¯"><a href="#1-ç±»å‹ä¿¡æ¯" class="headerlink" title="1 ç±»å‹ä¿¡æ¯"></a>1 ç±»å‹ä¿¡æ¯</h3><p>å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±»classã€æ¥å£interfaceã€æšä¸¾enumã€æ³¨è§£annotationï¼‰ï¼ŒJVmå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š</p><ul><li>è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆå…¨å=åŒ…å.ç±»åï¼‰</li><li>è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆåï¼ˆå¯¹äºinterfaceæˆ–æ˜¯java.lang.objectï¼Œéƒ½æ²¡æœ‰çˆ¶ç±»ï¼‰</li><li>è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œabstractï¼Œfinalçš„æŸä¸ªå­é›†ï¼‰</li><li>è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨</li></ul><h3 id="2-åŸŸä¿¡æ¯"><a href="#2-åŸŸä¿¡æ¯" class="headerlink" title="2 åŸŸä¿¡æ¯"></a>2 åŸŸä¿¡æ¯</h3><p>JVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­ä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸçš„ç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåºã€‚</p><p>åŸŸçš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ã€åŸŸç±»å‹ã€åŸŸä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œvolatileï¼Œtransientçš„æŸä¸ªå­é›†ï¼‰</p><h3 id="3-æ–¹æ³•ï¼ˆMethodï¼‰ä¿¡æ¯"><a href="#3-æ–¹æ³•ï¼ˆMethodï¼‰ä¿¡æ¯" class="headerlink" title="3 æ–¹æ³•ï¼ˆMethodï¼‰ä¿¡æ¯"></a>3 æ–¹æ³•ï¼ˆMethodï¼‰ä¿¡æ¯</h3><p>JVMå¿…é¡»ä¿å­˜æ‰€æœ‰æ–¹æ³•çš„ä»¥ä¸‹ä¿¡æ¯ï¼ŒåŒåŸŸä¿¡æ¯ä¸€æ ·åŒ…æ‹¬å£°æ˜é¡ºåºï¼š</p><ul><li>æ–¹æ³•åç§°</li><li>æ–¹æ³•çš„è¿”å›ç±»å‹ï¼ˆæˆ–voidï¼‰</li><li>æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼ˆæŒ‰é¡ºåºï¼‰</li><li>æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œsynchronizedï¼Œnativeï¼Œabstractçš„ä¸€ä¸ªå­é›†ï¼‰</li><li>æ–¹æ³•çš„å­—èŠ‚ç ï¼ˆbytecodesï¼‰ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå¤§å°ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰</li><li>å¼‚å¸¸è¡¨ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰</li></ul><blockquote><p>æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€ä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ã€è¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•</p></blockquote><h3 id="4-non-finalçš„ç±»å˜é‡"><a href="#4-non-finalçš„ç±»å˜é‡" class="headerlink" title="4 non-finalçš„ç±»å˜é‡"></a>4 non-finalçš„ç±»å˜é‡</h3><p>é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œä»–ä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†</p><p>ç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¿é—®å®ƒ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * non-finalçš„ç±»å˜é‡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAreaTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Order order = <span class="hljs-keyword">new</span> Order();        order.hello();        System.out.println(order.count);    &#125;&#125;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span> </span>&#123;    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">1</span>;    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">2</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;hello!&quot;</span>);    &#125;&#125;</code></pre></div><p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œå³ä½¿æˆ‘ä»¬æŠŠorderè®¾ç½®ä¸ºnullï¼Œä¹Ÿä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸</p><h3 id="5-å…¨å±€å¸¸é‡"><a href="#5-å…¨å±€å¸¸é‡" class="headerlink" title="5 å…¨å±€å¸¸é‡"></a>5 å…¨å±€å¸¸é‡</h3><p>å…¨å±€å¸¸é‡å°±æ˜¯ä½¿ç”¨ static final è¿›è¡Œä¿®é¥°</p><p>è¢«å£°æ˜ä¸ºfinalçš„ç±»å˜é‡çš„å¤„ç†æ–¹æ³•åˆ™ä¸åŒï¼Œæ¯ä¸ªå…¨å±€å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…äº†ã€‚ </p><h3 id="6-è¿è¡Œæ—¶å¸¸é‡æ± -VS-å¸¸é‡æ± "><a href="#6-è¿è¡Œæ—¶å¸¸é‡æ± -VS-å¸¸é‡æ± " class="headerlink" title="6 è¿è¡Œæ—¶å¸¸é‡æ±  VS å¸¸é‡æ± "></a>6 è¿è¡Œæ—¶å¸¸é‡æ±  VS å¸¸é‡æ± </h3><p>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå°±æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± </p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708171151384.png" alt="image-20200708171151384"></p><ul><li>æ–¹æ³•åŒºï¼Œå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± </li><li>å­—èŠ‚ç æ–‡ä»¶ï¼Œå†…éƒ¨åŒ…å«äº†å¸¸é‡æ± </li><li>è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºï¼Œéœ€è¦ç†è§£æ¸…æ¥šClassFileï¼Œå› ä¸ºåŠ è½½ç±»çš„ä¿¡æ¯éƒ½åœ¨æ–¹æ³•åŒºã€‚</li><li>è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œéœ€è¦ç†è§£æ¸…æ¥šclassFileä¸­çš„å¸¸é‡æ± ã€‚</li></ul><h3 id="7-å¸¸é‡æ± "><a href="#7-å¸¸é‡æ± " class="headerlink" title="7 å¸¸é‡æ± "></a>7 å¸¸é‡æ± </h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708172357052.png" alt="image-20200708172357052"></p><p>ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ä»¥åŠæ¥å£ç­‰æè¿°ç¬¦ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…å«ä¸€é¡¹ä¿¡æ¯å°±æ˜¯å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰ï¼ŒåŒ…æ‹¬å„ç§å­—é¢é‡å’Œå¯¹ç±»å‹ã€åŸŸå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨</p><h4 id="ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± "><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± " class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± "></a>ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± </h4><p>ä¸€ä¸ªjavaæºæ–‡ä»¶ä¸­çš„ç±»ã€æ¥å£ï¼Œç¼–è¯‘åäº§ç”Ÿä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ã€‚è€ŒJavaä¸­çš„å­—èŠ‚ç éœ€è¦æ•°æ®æ”¯æŒï¼Œé€šå¸¸è¿™ç§æ•°æ®ä¼šå¾ˆå¤§ä»¥è‡³äºä¸èƒ½ç›´æ¥å­˜åˆ°å­—èŠ‚ç é‡Œï¼Œæ¢å¦ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å­˜åˆ°å¸¸é‡æ± ï¼Œè¿™ä¸ªå­—èŠ‚ç åŒ…å«äº†æŒ‡å‘å¸¸é‡æ± çš„å¼•ç”¨ã€‚råœ¨åŠ¨æ€é“¾æ¥çš„æ—¶å€™ä¼šç”¨åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œä¹‹å‰æœ‰ä»‹ç»ã€‚</p><p>æ¯”å¦‚ï¼šå¦‚ä¸‹çš„ä»£ç ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleClass</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sayHello</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);    &#125;&#125;</code></pre></div><p>è™½ç„¶ä¸Šè¿°ä»£ç åªæœ‰194å­—èŠ‚ï¼Œä½†æ˜¯é‡Œé¢å´ä½¿ç”¨äº†Stringã€Systemã€PrintStreamåŠObjectç­‰ç»“æ„ã€‚è¿™é‡Œçš„ä»£ç é‡å…¶å®å¾ˆå°‘äº†ï¼Œå¦‚æœä»£ç å¤šçš„è¯ï¼Œå¼•ç”¨çš„ç»“æ„å°†ä¼šæ›´å¤šï¼Œè¿™é‡Œå°±éœ€è¦ç”¨åˆ°å¸¸é‡æ± äº†ã€‚</p><h4 id="å¸¸é‡æ± ä¸­æœ‰ä»€ä¹ˆ"><a href="#å¸¸é‡æ± ä¸­æœ‰ä»€ä¹ˆ" class="headerlink" title="å¸¸é‡æ± ä¸­æœ‰ä»€ä¹ˆ"></a>å¸¸é‡æ± ä¸­æœ‰ä»€ä¹ˆ</h4><ul><li>æ•°é‡å€¼</li><li>å­—ç¬¦ä¸²å€¼</li><li>ç±»å¼•ç”¨</li><li>å­—æ®µå¼•ç”¨</li><li>æ–¹æ³•å¼•ç”¨</li></ul><p>ä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAreaTest2</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span> </span>&#123;        Object obj = <span class="hljs-keyword">new</span> Object();    &#125;&#125;</code></pre></div><p>å°†ä¼šè¢«ç¿»è¯‘æˆå¦‚ä¸‹å­—èŠ‚ç </p><div class="code-wrapper"><pre><code class="hljs bash">new <span class="hljs-comment">#2  </span>dupinvokespecial</code></pre></div><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å¸¸é‡æ± ã€å¯ä»¥çœ‹åšæ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ç­‰ç±»å‹</p><h3 id="8-è¿è¡Œæ—¶å¸¸é‡æ± "><a href="#8-è¿è¡Œæ—¶å¸¸é‡æ± " class="headerlink" title="8 è¿è¡Œæ—¶å¸¸é‡æ± "></a>8 è¿è¡Œæ—¶å¸¸é‡æ± </h3><p>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</p><p>å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰æ˜¯Classæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</p><p>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œåœ¨åŠ è½½ç±»å’Œæ¥å£åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚</p><p>JVMä¸ºæ¯ä¸ªå·²åŠ è½½çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰éƒ½ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± ä¸­çš„æ•°æ®é¡¹åƒæ•°ç»„é¡¹ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ã€‚</p><p>è¿è¡Œæ—¶å¸¸é‡æ± ä¸­åŒ…å«å¤šç§ä¸åŒçš„å¸¸é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘æœŸå°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½å¤Ÿè·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€äº†ï¼Œè¿™é‡Œæ¢ä¸ºçœŸå®åœ°å€ã€‚</p><p>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦ä¸€é‡è¦ç‰¹å¾æ˜¯ï¼šå…·å¤‡åŠ¨æ€æ€§ã€‚</p><p>è¿è¡Œæ—¶å¸¸é‡æ± ç±»ä¼¼äºä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„ç¬¦å·è¡¨ï¼ˆsymboltableï¼‰ï¼Œä½†æ˜¯å®ƒæ‰€åŒ…å«çš„æ•°æ®å´æ¯”ç¬¦å·è¡¨è¦æ›´åŠ ä¸°å¯Œä¸€äº›ã€‚</p><p>å½“åˆ›å»ºç±»æˆ–æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€èƒ½æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™JVMä¼šæŠ›outofMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="9-6-æ–¹æ³•åŒºä½¿ç”¨ä¸¾ä¾‹"><a href="#9-6-æ–¹æ³•åŒºä½¿ç”¨ä¸¾ä¾‹" class="headerlink" title="9.6 æ–¹æ³•åŒºä½¿ç”¨ä¸¾ä¾‹"></a>9.6 æ–¹æ³•åŒºä½¿ç”¨ä¸¾ä¾‹</h2><p>å¦‚ä¸‹ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAreaDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span> </span>&#123;        <span class="hljs-keyword">int</span> x = <span class="hljs-number">500</span>;        <span class="hljs-keyword">int</span> y = <span class="hljs-number">100</span>;        <span class="hljs-keyword">int</span> a = x / y;        <span class="hljs-keyword">int</span> b = <span class="hljs-number">50</span>;        System.out.println(a+b);    &#125;&#125;</code></pre></div><p>å­—èŠ‚ç æ‰§è¡Œè¿‡ç¨‹å±•ç¤º</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708204750374.png" alt="image-20200708204750374"></p><p>é¦–å…ˆç°å°†æ“ä½œæ•°500æ”¾å…¥åˆ°æ“ä½œæ•°æ ˆä¸­</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/9_%E6%96%B9%E6%B3%95%E5%8C%BA/images/image-20200708204953552.png" alt="image-20200708204953552"></p><p>ç„¶åå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708205029376.png" alt="image-20200708205029376"></p><p>ç„¶åé‡å¤ä¸€æ¬¡ï¼ŒæŠŠ100æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œæœ€åå†å°†å˜é‡è¡¨ä¸­çš„500 å’Œ 100 å–å‡ºï¼Œè¿›è¡Œæ“ä½œ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/9_%E6%96%B9%E6%B3%95%E5%8C%BA/images/image-20200708205221737.png" alt="image-20200708205221737"></p><p>å°†500 å’Œ 100 è¿›è¡Œä¸€ä¸ªé™¤æ³•è¿ç®—ï¼Œåœ¨æŠŠç»“æœå…¥æ ˆ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708205413721.png" alt="image-20200708205413721"></p><p>åœ¨æœ€åå°±æ˜¯è¾“å‡ºæµï¼Œéœ€è¦è°ƒç”¨è¿è¡Œæ—¶å¸¸é‡æ± çš„å¸¸é‡</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708205708057.png" alt="image-20200708205708057"></p><p>æœ€åè°ƒç”¨invokevirtualï¼ˆè™šæ–¹æ³•è°ƒç”¨ï¼‰ï¼Œç„¶åè¿”å›</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708205909176.png" alt="image-20200708205909176"></p><p>è¿”å›æ—¶</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708210540696.png" alt="image-20200708210540696"></p><p>ç¨‹åºè®¡æ•°å™¨å§‹ç»ˆè®¡ç®—çš„éƒ½æ˜¯å½“å‰ä»£ç è¿è¡Œçš„ä½ç½®ï¼Œç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿è®°å½• æ–¹æ³•è°ƒç”¨åèƒ½å¤Ÿæ­£å¸¸è¿”å›ï¼Œæˆ–è€…æ˜¯è¿›è¡Œäº†CPUåˆ‡æ¢åï¼Œä¹Ÿèƒ½å›æ¥åˆ°åŸæ¥çš„ä»£ç è¿›è¡Œæ‰§è¡Œã€‚</p><h2 id="9-7-æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚"><a href="#9-7-æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚" class="headerlink" title="9.7 æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚"></a>9.7 æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚</h2><p>é¦–å…ˆæ˜ç¡®ï¼šåªæœ‰Hotspotæ‰æœ‰æ°¸ä¹…ä»£ã€‚BEA JRockitã€IBMJ9ç­‰æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µçš„ã€‚åŸåˆ™ä¸Šå¦‚ä½•å®ç°æ–¹æ³•åŒºå±äºè™šæ‹Ÿæœºå®ç°ç»†èŠ‚ï¼Œä¸å—ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ç®¡æŸï¼Œå¹¶ä¸è¦æ±‚ç»Ÿä¸€</p><p>Hotspotä¸­æ–¹æ³•åŒºçš„å˜åŒ–ï¼š</p><table><thead><tr><th>JDK1.6åŠä»¥å‰</th><th>æœ‰æ°¸ä¹…ä»£ï¼Œé™æ€å˜é‡å­˜å‚¨åœ¨æ°¸ä¹…ä»£ä¸Š</th></tr></thead><tbody><tr><td>JDK1.7</td><td>æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥ â€œå»æ°¸ä¹…ä»£â€ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œé™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­</td></tr><tr><td>JDK1.8</td><td>æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ï¼Œå­—æ®µï¼Œæ–¹æ³•ï¼Œå¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶åœ¨å †ä¸­ã€‚</td></tr></tbody></table><p>JDK6çš„æ—¶å€™</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708211541300.png" alt="image-20200708211541300"></p><p>JDK7çš„æ—¶å€™</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708211609911.png" alt="image-20200708211609911"></p><p>JDK8çš„æ—¶å€™ï¼Œå…ƒç©ºé—´å¤§å°åªå—ç‰©ç†å†…å­˜å½±å“</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708211637952.png" alt="image-20200708211637952"></p><h3 id="1-ä¸ºä»€ä¹ˆæ°¸ä¹…ä»£è¦è¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿ"><a href="#1-ä¸ºä»€ä¹ˆæ°¸ä¹…ä»£è¦è¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿ" class="headerlink" title="1 ä¸ºä»€ä¹ˆæ°¸ä¹…ä»£è¦è¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿ"></a>1 ä¸ºä»€ä¹ˆæ°¸ä¹…ä»£è¦è¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿ</h3><p>JRockitæ˜¯å’ŒHotSpotèåˆåçš„ç»“æœï¼Œå› ä¸ºJRockitæ²¡æœ‰æ°¸ä¹…ä»£ï¼Œæ‰€ä»¥ä»–ä»¬ä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£</p><p>éšç€Java8çš„åˆ°æ¥ï¼ŒHotSpot VMä¸­å†ä¹Ÿè§ä¸åˆ°æ°¸ä¹…ä»£äº†ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ä¹Ÿæ¶ˆå¤±äº†ã€‚è¿™äº›æ•°æ®è¢«ç§»åˆ°äº†ä¸€ä¸ªä¸å †ä¸ç›¸è¿çš„æœ¬åœ°å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸå«åšå…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ã€‚</p><p>ç”±äºç±»çš„å…ƒæ•°æ®åˆ†é…åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œå…ƒç©ºé—´çš„æœ€å¤§å¯åˆ†é…ç©ºé—´å°±æ˜¯ç³»ç»Ÿå¯ç”¨å†…å­˜ç©ºé—´ï¼Œè¿™é¡¹æ”¹åŠ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼ŒåŸå› æœ‰ï¼š</p><ul><li>ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„ã€‚</li></ul><p>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœåŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼Œå®¹æ˜“äº§ç”ŸPermåŒºçš„oomã€‚æ¯”å¦‚æŸä¸ªå®é™…Webå·¥<br>ç¨‹ä¸­ï¼Œå› ä¸ºåŠŸèƒ½ç‚¹æ¯”è¾ƒå¤šï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¦ä¸æ–­åŠ¨æ€åŠ è½½å¾ˆå¤šç±»ï¼Œç»å¸¸å‡ºç°è‡´å‘½é”™è¯¯ã€‚</p><p>â€œException in threadâ€˜dubbo client x.x connectorâ€™java.lang.OutOfMemoryError:PermGen spaceâ€</p><p>è€Œå…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚<br>å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚</p><ul><li>å¯¹æ°¸ä¹…ä»£è¿›è¡Œè°ƒä¼˜æ˜¯å¾ˆå›°éš¾çš„ã€‚<ul><li>ä¸»è¦æ˜¯ä¸ºäº†é™ä½Full GC</li></ul></li></ul><p>æœ‰äº›äººè®¤ä¸ºæ–¹æ³•åŒºï¼ˆå¦‚HotSpotè™šæ‹Ÿæœºä¸­çš„å…ƒç©ºé—´æˆ–è€…æ°¸ä¹…ä»£ï¼‰æ˜¯æ²¡æœ‰åƒåœ¾æ”¶é›†è¡Œä¸ºçš„ï¼Œå…¶å®ä¸ç„¶ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚JDK11æ—¶æœŸçš„ZGCæ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚<br>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒéš¾ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰sunå…¬å¸çš„Bugåˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„Bugå°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼</p><p>æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸åœ¨ä½¿ç”¨çš„ç±»å‹</p><h3 id="2-StringTableä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®"><a href="#2-StringTableä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®" class="headerlink" title="2 StringTableä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®"></a>2 StringTableä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®</h3><p>jdk7ä¸­å°†StringTableæ”¾åˆ°äº†å †ç©ºé—´ä¸­ã€‚å› ä¸ºæ°¸ä¹…ä»£çš„å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨full gcçš„æ—¶å€™æ‰ä¼šè§¦å‘ã€‚è€Œful1gcæ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ã€‚</p><p>è¿™å°±å¯¼è‡´stringTableå›æ”¶æ•ˆç‡ä¸é«˜ã€‚è€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚</p><h3 id="3-é™æ€å˜é‡å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ"><a href="#3-é™æ€å˜é‡å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ" class="headerlink" title="3 é™æ€å˜é‡å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ"></a>3 é™æ€å˜é‡å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ</h3><p>é™æ€å¼•ç”¨å¯¹åº”çš„å¯¹è±¡å®ä½“å§‹ç»ˆéƒ½å­˜åœ¨å †ç©ºé—´</p><p>å¯ä»¥ä½¿ç”¨ jhsdb.extï¼Œéœ€è¦åœ¨jdk9çš„æ—¶å€™æ‰å¼•å…¥çš„</p><p>staticobjéšç€Testçš„ç±»å‹ä¿¡æ¯å­˜æ”¾åœ¨æ–¹æ³•åŒºï¼Œinstanceobjéšç€Testçš„å¯¹è±¡å®ä¾‹å­˜æ”¾åœ¨Javaå †ï¼Œlocalobjectåˆ™æ˜¯å­˜æ”¾åœ¨fooï¼ˆï¼‰æ–¹æ³•æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä¸­ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708215025527.png" alt="image-20200708215025527"></p><p>æµ‹è¯•å‘ç°ï¼šä¸‰ä¸ªå¯¹è±¡çš„æ•°æ®åœ¨å†…å­˜ä¸­çš„åœ°å€éƒ½è½åœ¨EdenåŒºèŒƒå›´å†…ï¼Œæ‰€ä»¥ç»“è®ºï¼šåªè¦æ˜¯å¯¹è±¡å®ä¾‹å¿…ç„¶ä¼šåœ¨Javaå †ä¸­åˆ†é…ã€‚</p><p>æ¥ç€ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå¼•ç”¨è¯¥staticobjå¯¹è±¡çš„åœ°æ–¹ï¼Œæ˜¯åœ¨ä¸€ä¸ªjava.lang.Classçš„å®ä¾‹é‡Œï¼Œå¹¶ä¸”ç»™å‡ºäº†è¿™ä¸ªå®ä¾‹çš„åœ°å€ï¼Œé€šè¿‡InspectoræŸ¥çœ‹è¯¥å¯¹è±¡å®ä¾‹ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°è¿™ç¡®å®æ˜¯ä¸€ä¸ªjava.lang.Classç±»å‹çš„å¯¹è±¡å®ä¾‹ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªåä¸ºstaticobjçš„å®ä¾‹å­—æ®µï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708215218078.png" alt="image-20200708215218078"></p><p>ä»ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹æ‰€å®šä¹‰çš„æ¦‚å¿µæ¨¡å‹æ¥çœ‹ï¼Œæ‰€æœ‰Classç›¸å…³çš„ä¿¡æ¯éƒ½åº”è¯¥å­˜æ”¾åœ¨æ–¹æ³•åŒºä¹‹ä¸­ï¼Œä½†æ–¹æ³•åŒºè¯¥å¦‚ä½•å®ç°ï¼Œã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¹¶æœªåšå‡ºè§„å®šï¼Œè¿™å°±æˆäº†ä¸€ä»¶å…è®¸ä¸åŒè™šæ‹Ÿæœºè‡ªå·±çµæ´»æŠŠæ¡çš„äº‹æƒ…ã€‚JDK7åŠå…¶ä»¥åç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºé€‰æ‹©æŠŠé™æ€å˜é‡ä¸ç±»å‹åœ¨Javaè¯­è¨€ä¸€ç«¯çš„æ˜ å°„classå¯¹è±¡å­˜æ”¾åœ¨ä¸€èµ·ï¼Œå­˜å‚¨äºJavaå †ä¹‹ä¸­ï¼Œä»æˆ‘ä»¬çš„å®éªŒä¸­ä¹Ÿæ˜ç¡®éªŒè¯äº†è¿™ä¸€ç‚¹</p><h2 id="9-8-æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"><a href="#9-8-æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶" class="headerlink" title="9.8 æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"></a>9.8 æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶</h2><p>æœ‰äº›äººè®¤ä¸ºæ–¹æ³•åŒºï¼ˆå¦‚Hotspotè™šæ‹Ÿæœºä¸­çš„å…ƒç©ºé—´æˆ–è€…æ°¸ä¹…ä»£ï¼‰æ˜¯æ²¡æœ‰åƒåœ¾æ”¶é›†è¡Œä¸ºçš„ï¼Œå…¶å®ä¸ç„¶ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚JDK11æ—¶æœŸçš„zGCæ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚</p><p>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒéš¾ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰sunå…¬å¸çš„Bugåˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„Bugå°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚</p><p>å…ˆæ¥è¯´è¯´æ–¹æ³•åŒºå†…å¸¸é‡æ± ä¹‹ä¸­ä¸»è¦å­˜æ”¾çš„ä¸¤å¤§ç±»å¸¸é‡ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘Javaè¯­è¨€å±‚æ¬¡çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚è€Œç¬¦å·å¼•ç”¨åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š</p><ul><li>ç±»å’Œæ¥å£çš„å…¨é™å®šå</li><li>å­—æ®µçš„åç§°å’Œæè¿°ç¬¦</li><li>æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦</li></ul><p>HotSpotè™šæ‹Ÿæœºå¯¹å¸¸é‡æ± çš„å›æ”¶ç­–ç•¥æ˜¯å¾ˆæ˜ç¡®çš„ï¼Œåªè¦å¸¸é‡æ± ä¸­çš„å¸¸é‡æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œå°±å¯ä»¥è¢«å›æ”¶ã€‚</p><p>å›æ”¶åºŸå¼ƒå¸¸é‡ä¸å›æ”¶Javaå †ä¸­çš„å¯¹è±¡éå¸¸ç±»ä¼¼ã€‚ï¼ˆå…³äºå¸¸é‡çš„å›æ”¶æ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹æ˜¯ç±»çš„å›æ”¶ï¼‰</p><p>åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦â€œåºŸå¼ƒâ€è¿˜æ˜¯ç›¸å¯¹ç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºâ€œä¸å†è¢«ä½¿ç”¨çš„ç±»â€çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š</p><ul><li>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚<br>åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ï¼Œè¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚osGiã€JSPçš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚</li><li>è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ Javaè™šæ‹Ÿæœºè¢«å…è®¸å¯¹æ»¡è¶³ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œè¢«å…è®¸â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚å…³äºæ˜¯å¦è¦å¯¹ç±»å‹è¿›è¡Œå›æ”¶ï¼ŒHotSpotè™šæ‹Ÿæœºæä¾›äº†-Xnoclassgcå‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨-verbose:class ä»¥åŠ -XXï¼š+TraceClass-Loadingã€-XXï¼š+TraceClassUnLoadingæŸ¥çœ‹ç±»åŠ è½½å’Œå¸è½½ä¿¡æ¯</li><li>åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLibç­‰å­—èŠ‚ç æ¡†æ¶ï¼ŒåŠ¨æ€ç”ŸæˆJSPä»¥åŠoSGiè¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ï¼Œé€šå¸¸éƒ½éœ€è¦Javaè™šæ‹Ÿæœºå…·å¤‡ç±»å‹å¸è½½çš„èƒ½åŠ›ï¼Œä»¥ä¿è¯ä¸ä¼šå¯¹æ–¹æ³•åŒºé€ æˆè¿‡å¤§çš„å†…å­˜å‹åŠ›ã€‚</li></ul><h2 id="9-9-æ€»ç»“"><a href="#9-9-æ€»ç»“" class="headerlink" title="9.9 æ€»ç»“"></a>9.9 æ€»ç»“</h2><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200708220303243.png" alt="image-20200708220303243"></p><h3 id="å¸¸è§é¢è¯•é¢˜"><a href="#å¸¸è§é¢è¯•é¢˜" class="headerlink" title="å¸¸è§é¢è¯•é¢˜"></a>å¸¸è§é¢è¯•é¢˜</h3><p>ç™¾åº¦<br>ä¸‰é¢ï¼šè¯´ä¸€ä¸‹JVMå†…å­˜æ¨¡å‹å§ï¼Œæœ‰å“ªäº›åŒºï¼Ÿåˆ†åˆ«å¹²ä»€ä¹ˆçš„ï¼Ÿ</p><p>èš‚èšé‡‘æœï¼š<br>Java8çš„å†…å­˜åˆ†ä»£æ”¹è¿›<br>JVMå†…å­˜åˆ†å“ªå‡ ä¸ªåŒºï¼Œæ¯ä¸ªåŒºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ<br>ä¸€é¢ï¼šJVMå†…å­˜åˆ†å¸ƒ/å†…å­˜ç»“æ„ï¼Ÿæ ˆå’Œå †çš„åŒºåˆ«ï¼Ÿå †çš„ç»“æ„ï¼Ÿä¸ºä»€ä¹ˆä¸¤ä¸ªsurvivoråŒºï¼Ÿ<br>äºŒé¢ï¼šEdenå’Œsurviorçš„æ¯”ä¾‹åˆ†é…</p><p>å°ç±³ï¼š<br>jvmå†…å­˜åˆ†åŒºï¼Œä¸ºä»€ä¹ˆè¦æœ‰æ–°ç”Ÿä»£å’Œè€å¹´ä»£</p><p>å­—èŠ‚è·³åŠ¨ï¼š<br>äºŒé¢ï¼šJavaçš„å†…å­˜åˆ†åŒº<br>äºŒé¢ï¼šè®²è®²vmè¿è¡Œæ—¶æ•°æ®åº“åŒº<br>ä»€ä¹ˆæ—¶å€™å¯¹è±¡ä¼šè¿›å…¥è€å¹´ä»£ï¼Ÿ</p><p>äº¬ä¸œï¼š<br>JVMçš„å†…å­˜ç»“æ„ï¼ŒEdenå’ŒSurvivoræ¯”ä¾‹ã€‚<br>JVMå†…å­˜ä¸ºä»€ä¹ˆè¦åˆ†æˆæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£ï¼ŒæŒä¹…ä»£ã€‚æ–°ç”Ÿä»£ä¸­ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºEdenå’Œsurvivorã€‚</p><p>å¤©çŒ«ï¼š<br>ä¸€é¢ï¼šJvmå†…å­˜æ¨¡å‹ä»¥åŠåˆ†åŒºï¼Œéœ€è¦è¯¦ç»†åˆ°æ¯ä¸ªåŒºæ”¾ä»€ä¹ˆã€‚<br>ä¸€é¢ï¼šJVMçš„å†…å­˜æ¨¡å‹ï¼ŒJava8åšäº†ä»€ä¹ˆæ”¹</p><p>æ‹¼å¤šå¤šï¼š<br>JVMå†…å­˜åˆ†å“ªå‡ ä¸ªåŒºï¼Œæ¯ä¸ªåŒºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ç¾å›¢ï¼š<br>javaå†…å­˜åˆ†é…<br>jvmçš„æ°¸ä¹…ä»£ä¸­ä¼šå‘ç”Ÿåƒåœ¾å›æ”¶å—ï¼Ÿ<br>ä¸€é¢ï¼šjvmå†…å­˜åˆ†åŒºï¼Œä¸ºä»€ä¹ˆè¦æœ‰æ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Ÿ</p><h1 id="ç¬¬10ç« -å¯¹è±¡å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½"><a href="#ç¬¬10ç« -å¯¹è±¡å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½" class="headerlink" title="ç¬¬10ç«  å¯¹è±¡å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½"></a>ç¬¬10ç«  å¯¹è±¡å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½</h1><h2 id="1-å¯¹è±¡å®ä¾‹åŒ–"><a href="#1-å¯¹è±¡å®ä¾‹åŒ–" class="headerlink" title="1 å¯¹è±¡å®ä¾‹åŒ–"></a>1 å¯¹è±¡å®ä¾‹åŒ–</h2><h3 id="1-1-é¢è¯•é¢˜"><a href="#1-1-é¢è¯•é¢˜" class="headerlink" title="1.1 é¢è¯•é¢˜"></a>1.1 é¢è¯•é¢˜</h3><ul><li>å¯¹è±¡åœ¨JVMä¸­æ˜¯æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ</li><li>å¯¹è±¡å¤´ä¿¡æ¯é‡Œé¢æœ‰å“ªäº›ä¸œè¥¿ï¼Ÿ</li><li>Javaå¯¹è±¡å¤´æœ‰ä»€ä¹ˆï¼Ÿ</li></ul><p>ä»å¯¹è±¡åˆ›å»ºçš„æ–¹å¼ å’Œ æ­¥éª¤å¼€å§‹è¯´</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709095356247.png" alt="image-20200709095356247"></p><h3 id="1-2-å¯¹è±¡åˆ›å»ºæ–¹å¼"><a href="#1-2-å¯¹è±¡åˆ›å»ºæ–¹å¼" class="headerlink" title="1.2 å¯¹è±¡åˆ›å»ºæ–¹å¼"></a>1.2 å¯¹è±¡åˆ›å»ºæ–¹å¼</h3><ul><li>newï¼šæœ€å¸¸è§çš„æ–¹å¼ã€å•ä¾‹ç±»ä¸­è°ƒç”¨getInstanceçš„é™æ€ç±»æ–¹æ³•ï¼ŒXXXFactoryçš„é™æ€æ–¹æ³•</li><li>Classçš„newInstanceæ–¹æ³•ï¼šåœ¨JDK9é‡Œé¢è¢«æ ‡è®°ä¸ºè¿‡æ—¶çš„æ–¹æ³•ï¼Œå› ä¸ºåªèƒ½è°ƒç”¨ç©ºå‚æ„é€ å™¨</li><li>Constructorçš„newInstance(XXX)ï¼šåå°„çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨ç©ºå‚çš„ï¼Œæˆ–è€…å¸¦å‚çš„æ„é€ å™¨</li><li>ä½¿ç”¨clone()ï¼šä¸è°ƒç”¨ä»»ä½•çš„æ„é€ å™¨ï¼Œè¦æ±‚å½“å‰çš„ç±»éœ€è¦å®ç°Cloneableæ¥å£ä¸­çš„cloneæ¥å£</li><li>ä½¿ç”¨åºåˆ—åŒ–ï¼šåºåˆ—åŒ–ä¸€èˆ¬ç”¨äºSocketçš„ç½‘ç»œä¼ è¾“</li><li>ç¬¬ä¸‰æ–¹åº“ Objenesis</li></ul><h3 id="1-3-åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤"><a href="#1-3-åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤" class="headerlink" title="1.3 åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤"></a>1.3 åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤</h3><h4 id="åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–"><a href="#åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–" class="headerlink" title="åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–"></a>åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–</h4><p>è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤ï¼Œé¦–å…ˆå»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°èƒ½å¦åœ¨Metaspaceçš„å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œè§£æå’Œåˆå§‹åŒ–ã€‚ï¼ˆå³åˆ¤æ–­ç±»å…ƒä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆåœ¨åŒäº²å§”æ´¾æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨å½“å‰ç±»åŠ è½½å™¨ä»¥ClassLoader + åŒ…å + ç±»åä¸ºkeyè¿›è¡ŒæŸ¥æ‰¾å¯¹åº”çš„ .classæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿›è¡Œç±»åŠ è½½ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„Classå¯¹è±¡ã€‚</p><h4 id="ä¸ºå¯¹è±¡åˆ†é…å†…å­˜"><a href="#ä¸ºå¯¹è±¡åˆ†é…å†…å­˜" class="headerlink" title="ä¸ºå¯¹è±¡åˆ†é…å†…å­˜"></a>ä¸ºå¯¹è±¡åˆ†é…å†…å­˜</h4><p>é¦–å…ˆè®¡ç®—å¯¹è±¡å ç”¨ç©ºé—´çš„å¤§å°ï¼Œæ¥ç€åœ¨å †ä¸­åˆ’åˆ†ä¸€å—å†…å­˜ç»™æ–°å¯¹è±¡ã€‚å¦‚æœå®ä¾‹æˆå‘˜å˜é‡æ˜¯å¼•ç”¨å˜é‡ï¼Œä»…åˆ†é…å¼•ç”¨å˜é‡ç©ºé—´å³å¯ï¼Œå³4ä¸ªå­—èŠ‚å¤§å°</p><ul><li><p>å¦‚æœå†…å­˜è§„æ•´ï¼šæŒ‡é’ˆç¢°æ’</p></li><li><p>å¦‚æœå†…å­˜ä¸è§„æ•´</p><ul><li>è™šæ‹Ÿè¡¨éœ€è¦ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨</li><li>ç©ºé—²åˆ—è¡¨åˆ†é…</li></ul></li></ul><p>å¦‚æœå†…å­˜æ˜¯è§„æ•´çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨çš„æ˜¯æŒ‡é’ˆç¢°æ’æ³•ï¼ˆBump The Pointï¼‰æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚</p><p>æ„æ€æ˜¯æ‰€æœ‰ç”¨è¿‡çš„å†…å­˜åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜æ”¾å¦å¤–ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œåˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠæŒ‡é’ˆæŒ‡å‘ç©ºé—²é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ç½¢äº†ã€‚å¦‚æœåƒåœ¾æ”¶é›†å™¨é€‰æ‹©çš„æ˜¯Serial ï¼ŒParNewè¿™ç§åŸºäºå‹ç¼©ç®—æ³•çš„ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨è¿™ç§åˆ†é…æ–¹å¼ã€‚ä¸€èˆ¬ä½¿ç”¨å¸¦Compactï¼ˆæ•´ç†ï¼‰è¿‡ç¨‹çš„æ”¶é›†å™¨æ—¶ï¼Œä½¿ç”¨æŒ‡é’ˆç¢°æ’ã€‚</p><p>å¦‚æœå†…å­˜ä¸æ˜¯è§„æ•´çš„ï¼Œå·²ä½¿ç”¨çš„å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜ç›¸äº’äº¤é”™ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨çš„æ˜¯ç©ºé—²åˆ—è¡¨æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚æ„æ€æ˜¯è™šæ‹Ÿæœºç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•ä¸Šé‚£äº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œå†åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„å†…å®¹ã€‚è¿™ç§åˆ†é…æ–¹å¼æˆä¸ºäº† â€œç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰â€</p><p>é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”±Javaå †æ˜¯å¦è§„æ•´æ‰€å†³å®šï¼Œè€ŒJavaå †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®šã€‚</p><h4 id="å¤„ç†å¹¶å‘é—®é¢˜"><a href="#å¤„ç†å¹¶å‘é—®é¢˜" class="headerlink" title="å¤„ç†å¹¶å‘é—®é¢˜"></a>å¤„ç†å¹¶å‘é—®é¢˜</h4><ul><li>é‡‡ç”¨CASé…ä¸Šå¤±è´¥é‡è¯•ä¿è¯æ›´æ–°çš„åŸå­æ€§</li><li>æ¯ä¸ªçº¿ç¨‹é¢„å…ˆåˆ†é…TLAB - é€šè¿‡è®¾ç½® -XX:+UseTLABå‚æ•°æ¥è®¾ç½®ï¼ˆåŒºåŸŸåŠ é”æœºåˆ¶ï¼‰<ul><li>åœ¨EdenåŒºç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å—åŒºåŸŸ</li></ul></li></ul><h3 id="1-4-åˆå§‹åŒ–åˆ†é…åˆ°çš„å†…å­˜"><a href="#1-4-åˆå§‹åŒ–åˆ†é…åˆ°çš„å†…å­˜" class="headerlink" title="1.4 åˆå§‹åŒ–åˆ†é…åˆ°çš„å†…å­˜"></a>1.4 åˆå§‹åŒ–åˆ†é…åˆ°çš„å†…å­˜</h3><p>ç»™å¯¹è±¡å±æ€§èµ‹å€¼çš„æ“ä½œ</p><ul><li><p>å±æ€§çš„é»˜è®¤åˆå§‹åŒ–</p></li><li><p>æ˜¾ç¤ºåˆå§‹åŒ–</p></li><li><p>ä»£ç å—ä¸­çš„åˆå§‹åŒ–</p></li><li><p>æ„é€ å™¨åˆå§‹åŒ–</p></li><li><p>æ‰€æœ‰å±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œä¿è¯å¯¹è±¡å®ä¾‹å­—æ®µåœ¨ä¸èµ‹å€¼å¯ä»¥ç›´æ¥ä½¿ç”¨</p></li></ul><h3 id="1-5-è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´"><a href="#1-5-è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´" class="headerlink" title="1.5 è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´"></a>1.5 è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´</h3><p>å°†å¯¹è±¡çš„æ‰€å±ç±»ï¼ˆå³ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼‰ã€å¯¹è±¡çš„HashCodeå’Œå¯¹è±¡çš„GCä¿¡æ¯ã€é”ä¿¡æ¯ç­‰æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å…·ä½“è®¾ç½®æ–¹å¼å–å†³äºJVMå®ç°ã€‚</p><h3 id="1-6-æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–"><a href="#1-6-æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–" class="headerlink" title="1.6 æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–"></a>1.6 æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</h3><p>åœ¨Javaç¨‹åºçš„è§†è§’çœ‹æ¥ï¼Œåˆå§‹åŒ–æ‰æ­£å¼å¼€å§‹ã€‚åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œæ‰§è¡Œå®ä¾‹åŒ–ä»£ç å—ï¼Œè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠå †å†…å¯¹è±¡çš„é¦–åœ°å€èµ‹å€¼ç»™å¼•ç”¨å˜é‡ã€‚</p><p>å› æ­¤ä¸€èˆ¬æ¥è¯´ï¼ˆç”±å­—èŠ‚ç ä¸­è·ŸéšinvokespecialæŒ‡ä»¤æ‰€å†³å®šï¼‰ï¼ŒnewæŒ‡ä»¤ä¹‹åä¼šæ¥ç€å°±æ˜¯æ‰§è¡Œæ–¹æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œæˆåˆ›å»ºå‡ºæ¥ã€‚</p><h3 id="1-7-å¯¹è±¡å®ä¾‹åŒ–çš„è¿‡ç¨‹"><a href="#1-7-å¯¹è±¡å®ä¾‹åŒ–çš„è¿‡ç¨‹" class="headerlink" title="1.7 å¯¹è±¡å®ä¾‹åŒ–çš„è¿‡ç¨‹"></a>1.7 å¯¹è±¡å®ä¾‹åŒ–çš„è¿‡ç¨‹</h3><ul><li>åŠ è½½ç±»å…ƒä¿¡æ¯</li><li>ä¸ºå¯¹è±¡åˆ†é…å†…å­˜</li><li>å¤„ç†å¹¶å‘é—®é¢˜</li><li>å±æ€§çš„é»˜è®¤åˆå§‹åŒ–ï¼ˆé›¶å€¼åˆå§‹åŒ–ï¼‰</li><li>è®¾ç½®å¯¹è±¡å¤´ä¿¡æ¯</li><li>å±æ€§çš„æ˜¾ç¤ºåˆå§‹åŒ–ã€ä»£ç å—ä¸­åˆå§‹åŒ–ã€æ„é€ å™¨ä¸­åˆå§‹åŒ–</li></ul><h2 id="1-8-å¯¹è±¡å†…å­˜å¸ƒå±€"><a href="#1-8-å¯¹è±¡å†…å­˜å¸ƒå±€" class="headerlink" title="1.8 å¯¹è±¡å†…å­˜å¸ƒå±€"></a>1.8 å¯¹è±¡å†…å­˜å¸ƒå±€</h2><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709151033237.png" alt="image-20200709151033237"></p><h3 id="1-9-å¯¹è±¡å¤´"><a href="#1-9-å¯¹è±¡å¤´" class="headerlink" title="1.9 å¯¹è±¡å¤´"></a>1.9 å¯¹è±¡å¤´</h3><p>å¯¹è±¡å¤´åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ è¿è¡Œæ—¶å…ƒæ•°æ®ï¼ˆMark Wordï¼‰å’Œ ç±»å‹æŒ‡é’ˆ</p><blockquote><p>å¦‚æœæ˜¯æ•°ç»„ï¼Œè¿˜éœ€è¦è®°å½•æ•°ç»„çš„é•¿åº¦</p></blockquote><h4 id="è¿è¡Œæ—¶å…ƒæ•°æ®"><a href="#è¿è¡Œæ—¶å…ƒæ•°æ®" class="headerlink" title="è¿è¡Œæ—¶å…ƒæ•°æ®"></a>è¿è¡Œæ—¶å…ƒæ•°æ®</h4><ul><li>å“ˆå¸Œå€¼ï¼ˆHashCodeï¼‰</li><li>GCåˆ†ä»£å¹´é¾„</li><li>é”çŠ¶æ€æ ‡å¿—</li><li>çº¿ç¨‹æŒæœ‰çš„é”</li><li>åå‘çº¿ç¨‹ID</li><li>ç¿©å‘æ—¶é—´æˆ³</li></ul><h4 id="ç±»å‹æŒ‡é’ˆ"><a href="#ç±»å‹æŒ‡é’ˆ" class="headerlink" title="ç±»å‹æŒ‡é’ˆ"></a>ç±»å‹æŒ‡é’ˆ</h4><p>æŒ‡å‘ç±»å…ƒæ•°æ®InstanceKlassï¼Œç¡®å®šè¯¥å¯¹è±¡æ‰€å±çš„ç±»å‹ã€‚æŒ‡å‘çš„å…¶å®æ˜¯æ–¹æ³•åŒºä¸­å­˜æ”¾çš„ç±»å…ƒä¿¡æ¯</p><h3 id="1-10-å®ä¾‹æ•°æ®ï¼ˆInstance-Dataï¼‰"><a href="#1-10-å®ä¾‹æ•°æ®ï¼ˆInstance-Dataï¼‰" class="headerlink" title="1.10 å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰"></a>1.10 å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰</h3><h4 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h4><p>ä¸æ˜¯å¿…é¡»çš„ï¼Œä¹Ÿæ²¡æœ‰ç‰¹åˆ«çš„å«ä¹‰ï¼Œä»…ä»…èµ·åˆ°å ä½ç¬¦çš„ä½œç”¨</p><h3 id="1-11-å°ç»“"><a href="#1-11-å°ç»“" class="headerlink" title="1.11 å°ç»“"></a>1.11 å°ç»“</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709152801713.png" alt="image-20200709152801713"></p><h2 id="2-å¯¹è±¡çš„è®¿é—®å®šä½"><a href="#2-å¯¹è±¡çš„è®¿é—®å®šä½" class="headerlink" title="2 å¯¹è±¡çš„è®¿é—®å®šä½"></a>2 å¯¹è±¡çš„è®¿é—®å®šä½</h2><h3 id="2-1-å›¾ç¤º"><a href="#2-1-å›¾ç¤º" class="headerlink" title="2.1 å›¾ç¤º"></a>2.1 å›¾ç¤º</h3><p>JVMæ˜¯å¦‚ä½•é€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨è®¿é—®åˆ°å…¶å†…éƒ¨çš„å¯¹è±¡å®ä¾‹å‘¢ï¼Ÿ</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/10_%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B8%8E%E8%AE%BF%E9%97%AE%E5%AE%9A%E4%BD%8D/images/image-20200709164149920.png" alt="image-20200709164149920"></p><h3 id="2-2-å¯¹è±¡è®¿é—®çš„ä¸¤ç§æ–¹å¼"><a href="#2-2-å¯¹è±¡è®¿é—®çš„ä¸¤ç§æ–¹å¼" class="headerlink" title="2.2 å¯¹è±¡è®¿é—®çš„ä¸¤ç§æ–¹å¼"></a>2.2 å¯¹è±¡è®¿é—®çš„ä¸¤ç§æ–¹å¼</h3><h4 id="å¥æŸ„è®¿é—®"><a href="#å¥æŸ„è®¿é—®" class="headerlink" title="å¥æŸ„è®¿é—®"></a>å¥æŸ„è®¿é—®</h4><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709164342002.png" alt="image-20200709164342002"></p><p>å¥æŸ„è®¿é—®å°±æ˜¯è¯´æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œè®°å½•çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œç„¶ååœ¨å †ç©ºé—´ä¸­å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯å¥æŸ„æ± </p><h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><p>referenceä¸­å­˜å‚¨ç¨³å®šå¥æŸ„åœ°å€ï¼Œå¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡å¾ˆæ™®éï¼‰æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­å®ä¾‹æ•°æ®æŒ‡é’ˆå³å¯ï¼Œreferenceæœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹</p><h4 id="ç›´æ¥æŒ‡é’ˆï¼ˆHotSpoté‡‡ç”¨ï¼‰"><a href="#ç›´æ¥æŒ‡é’ˆï¼ˆHotSpoté‡‡ç”¨ï¼‰" class="headerlink" title="ç›´æ¥æŒ‡é’ˆï¼ˆHotSpoté‡‡ç”¨ï¼‰"></a>ç›´æ¥æŒ‡é’ˆï¼ˆHotSpoté‡‡ç”¨ï¼‰</h4><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709164350466.png" alt="image-20200709164350466"></p><p>ç›´æ¥æŒ‡é’ˆæ˜¯å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¼•ç”¨ï¼Œç›´æ¥æŒ‡å‘å †ä¸­çš„å®ä¾‹ï¼Œåœ¨å¯¹è±¡å®ä¾‹ä¸­æœ‰ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯æ–¹æ³•åŒºä¸­çš„å¯¹è±¡ç±»å‹æ•°æ®</p><h1 id="ç¬¬11ç« -ç›´æ¥å†…å­˜-Direct-Memory"><a href="#ç¬¬11ç« -ç›´æ¥å†…å­˜-Direct-Memory" class="headerlink" title="ç¬¬11ç«  ç›´æ¥å†…å­˜ Direct Memory"></a>ç¬¬11ç«  ç›´æ¥å†…å­˜ Direct Memory</h1><p>ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚</p><p>ç›´æ¥å†…å­˜æ˜¯åœ¨Javaå †å¤–çš„ã€ç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜åŒºé—´ã€‚</p><p>æ¥æºäºNIOï¼Œé€šè¿‡å­˜åœ¨å †ä¸­çš„DirectByteBufferæ“ä½œNativeå†…å­˜</p><p>é€šå¸¸ï¼Œè®¿é—®ç›´æ¥å†…å­˜çš„é€Ÿåº¦ä¼šä¼˜äºJavaå †ã€‚å³è¯»å†™æ€§èƒ½é«˜ã€‚</p><ul><li>å› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜ã€‚</li><li>Javaçš„NIOåº“å…è®¸Javaç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒº</li></ul><p>ä½¿ç”¨ä¸‹åˆ—ä»£ç ï¼Œç›´æ¥åˆ†é…æœ¬åœ°å†…å­˜ç©ºé—´</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">int</span> BUFFER = <span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>; <span class="hljs-comment">// 1GB</span>ByteBuffer byteBuffer = ByteBuffer.allocateDirect(BUFFER);</code></pre></div><h2 id="éç›´æ¥ç¼“å­˜åŒºå’Œç¼“å­˜åŒº"><a href="#éç›´æ¥ç¼“å­˜åŒºå’Œç¼“å­˜åŒº" class="headerlink" title="éç›´æ¥ç¼“å­˜åŒºå’Œç¼“å­˜åŒº"></a>éç›´æ¥ç¼“å­˜åŒºå’Œç¼“å­˜åŒº</h2><p>åŸæ¥é‡‡ç”¨BIOçš„æ¶æ„ï¼Œæˆ‘ä»¬éœ€è¦ä»ç”¨æˆ·æ€åˆ‡æ¢æˆå†…æ ¸æ€</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709170907611.png" alt="image-20200709170907611"></p><p>NIOçš„æ–¹å¼ä½¿ç”¨äº†ç¼“å­˜åŒºçš„æ¦‚å¿µ</p><h2 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h2><p>ä¹Ÿå¯èƒ½å¯¼è‡´outofMemoryErrorå¼‚å¸¸</p><p>ç”±äºç›´æ¥å†…å­˜åœ¨Javaå †å¤–ï¼Œå› æ­¤å®ƒçš„å¤§å°ä¸ä¼šç›´æ¥å—é™äº-xmxæŒ‡å®šçš„æœ€å¤§å †å¤§å°ï¼Œä½†æ˜¯ç³»ç»Ÿå†…å­˜æ˜¯æœ‰é™çš„ï¼ŒJavaå †å’Œç›´æ¥å†…å­˜çš„æ€»å’Œä¾ç„¶å—é™äºæ“ä½œç³»ç»Ÿèƒ½ç»™å‡ºçš„æœ€å¤§å†…å­˜ã€‚<br>ç¼ºç‚¹</p><ul><li>åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜</li><li>ä¸å—JVMå†…å­˜å›æ”¶ç®¡ç†</li></ul><p>ç›´æ¥å†…å­˜å¤§å°å¯ä»¥é€šè¿‡MaxDirectMemorySizeè®¾ç½®</p><p>å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸å †çš„æœ€å¤§å€¼-xmxå‚æ•°å€¼ä¸€è‡´</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200709230647277.png" alt="image-20200709230647277"></p><h1 id="ç¬¬12ç« æ‰§è¡Œå¼•æ“"><a href="#ç¬¬12ç« æ‰§è¡Œå¼•æ“" class="headerlink" title="ç¬¬12ç« æ‰§è¡Œå¼•æ“"></a>ç¬¬12ç« æ‰§è¡Œå¼•æ“</h1><h2 id="1-æ‰§è¡Œå¼•æ“æ¦‚è¿°"><a href="#1-æ‰§è¡Œå¼•æ“æ¦‚è¿°" class="headerlink" title="1 æ‰§è¡Œå¼•æ“æ¦‚è¿°"></a>1 æ‰§è¡Œå¼•æ“æ¦‚è¿°</h2><p>æ‰§è¡Œå¼•æ“å±äºJVMçš„ä¸‹å±‚ï¼Œé‡Œé¢åŒ…æ‹¬ è§£é‡Šå™¨ã€åŠæ—¶ç¼–è¯‘å™¨ã€åƒåœ¾å›æ”¶å™¨</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710080707873.png" alt="image-20200710080707873"></p><p>æ‰§è¡Œå¼•æ“æ˜¯Javaè™šæ‹Ÿæœºæ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚â€œè™šæ‹Ÿæœºâ€æ˜¯ä¸€ä¸ªç›¸å¯¹äºâ€œç‰©ç†æœºâ€çš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¼“å­˜ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“åˆ™æ˜¯ç”±è½¯ä»¶è‡ªè¡Œå®ç°çš„ï¼Œå› æ­¤å¯ä»¥ä¸å—ç‰©ç†æ¡ä»¶åˆ¶çº¦åœ°å®šåˆ¶æŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œèƒ½å¤Ÿæ‰§è¡Œé‚£äº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†æ ¼å¼ã€‚</p><p>JVMçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œä½†å­—èŠ‚ç å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œå› ä¸ºå­—èŠ‚ç æŒ‡ä»¤å¹¶éç­‰ä»·äºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œå®ƒå†…éƒ¨åŒ…å«çš„ä»…ä»…åªæ˜¯ä¸€äº›èƒ½å¤Ÿè¢«JVMæ‰€è¯†åˆ«çš„å­—èŠ‚ç æŒ‡ä»¤ã€ç¬¦å·è¡¨ï¼Œä»¥åŠå…¶ä»–è¾…åŠ©ä¿¡æ¯ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710081118053.png" alt="image-20200710081118053"></p><p>é‚£ä¹ˆï¼Œå¦‚æœæƒ³è¦è®©ä¸€ä¸ªJavaç¨‹åºè¿è¡Œèµ·æ¥ï¼Œæ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰çš„ä»»åŠ¡å°±æ˜¯å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Š/ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰å¯ä»¥ã€‚ç®€å•æ¥è¯´ï¼ŒJVMä¸­çš„æ‰§è¡Œå¼•æ“å……å½“äº†å°†é«˜çº§è¯­è¨€ç¿»è¯‘ä¸ºæœºå™¨è¯­è¨€çš„è¯‘è€…ã€‚</p><h3 id="æ‰§è¡Œå¼•æ“çš„å·¥ä½œæµç¨‹"><a href="#æ‰§è¡Œå¼•æ“çš„å·¥ä½œæµç¨‹" class="headerlink" title="æ‰§è¡Œå¼•æ“çš„å·¥ä½œæµç¨‹"></a>æ‰§è¡Œå¼•æ“çš„å·¥ä½œæµç¨‹</h3><ul><li>æ‰§è¡Œå¼•æ“åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ç©¶ç«Ÿéœ€è¦æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤å®Œå…¨ä¾èµ–äºPCå¯„å­˜å™¨ã€‚</li><li>æ¯å½“æ‰§è¡Œå®Œä¸€é¡¹æŒ‡ä»¤æ“ä½œåï¼ŒPCå¯„å­˜å™¨å°±ä¼šæ›´æ–°ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚</li><li>å½“ç„¶æ–¹æ³•åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œå¼•æ“æœ‰å¯èƒ½ä¼šé€šè¿‡å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¯¹è±¡å¼•ç”¨å‡†ç¡®å®šä½åˆ°å­˜å‚¨åœ¨Javaå †åŒºä¸­çš„å¯¹è±¡å®ä¾‹ä¿¡æ¯ï¼Œä»¥åŠé€šè¿‡å¯¹è±¡å¤´ä¸­çš„å…ƒæ•°æ®æŒ‡é’ˆå®šä½åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710081627217.png" alt="image-20200710081627217"></p><p>ä»å¤–è§‚ä¸Šæ¥çœ‹ï¼Œæ‰€æœ‰çš„Javaè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“è¾“å…¥ï¼Œè¾“å‡ºéƒ½æ˜¯ä¸€è‡´çš„ï¼šè¾“å…¥çš„æ˜¯å­—èŠ‚ç äºŒè¿›åˆ¶æµï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£ææ‰§è¡Œçš„ç­‰æ•ˆè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œè¿‡ç¨‹ã€‚</p><h2 id="2-Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹"><a href="#2-Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="2 Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹"></a>2 Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹</h2><p>å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç è½¬æ¢æˆç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ä¸Šå›¾ä¸­çš„å„ä¸ªæ­¥éª¤</p><ul><li>å‰é¢æ©™è‰²éƒ¨åˆ†æ˜¯ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œå’ŒJVMæ— å…³</li><li>åé¢è“è‰²å’Œç»¿è‰²æ‰æ˜¯JVMéœ€è¦è€ƒè™‘çš„è¿‡ç¨‹</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710082141643.png" alt="image-20200710082141643"></p><p>Javaä»£ç ç¼–è¯‘æ˜¯ç”±Javaæºç ç¼–è¯‘å™¨æ¥å®Œæˆï¼Œæµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710082433146.png" alt="image-20200710082433146"></p><p>Javaå­—èŠ‚ç çš„æ‰§è¡Œæ˜¯ç”±JVMæ‰§è¡Œå¼•æ“æ¥å®Œæˆï¼Œæµç¨‹å›¾ å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710083036258.png" alt="image-20200710083036258"></p><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªæ€»çš„å›¾ï¼Œæ¥è¯´è¯´ è§£é‡Šå™¨å’Œç¼–è¯‘å™¨</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710083656277.png" alt="image-20200710083656277"></p><h3 id="2-1-ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼ˆInterpreterï¼‰"><a href="#2-1-ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼ˆInterpreterï¼‰" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼ˆInterpreterï¼‰"></a>2.1 ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼ˆInterpreterï¼‰</h3><p>å½“Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶ä¼šæ ¹æ®é¢„å®šä¹‰çš„è§„èŒƒå¯¹å­—èŠ‚ç é‡‡ç”¨é€è¡Œè§£é‡Šçš„æ–¹å¼æ‰§è¡Œï¼Œå°†æ¯æ¡å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p><h3 id="2-2-ä»€ä¹ˆæ˜¯ITç¼–è¯‘å™¨"><a href="#2-2-ä»€ä¹ˆæ˜¯ITç¼–è¯‘å™¨" class="headerlink" title="2.2 ä»€ä¹ˆæ˜¯ITç¼–è¯‘å™¨"></a>2.2 ä»€ä¹ˆæ˜¯ITç¼–è¯‘å™¨</h3><p>JITï¼ˆJust In Time Compilerï¼‰ç¼–è¯‘å™¨ï¼šå°±æ˜¯è™šæ‹Ÿæœºå°†æºä»£ç ç›´æ¥ç¼–è¯‘æˆå’Œæœ¬åœ°æœºå™¨å¹³å°ç›¸å…³çš„æœºå™¨è¯­è¨€ã€‚</p><h3 id="2-3-ä¸ºä»€ä¹ˆJavaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€"><a href="#2-3-ä¸ºä»€ä¹ˆJavaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€" class="headerlink" title="2.3 ä¸ºä»€ä¹ˆJavaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€"></a>2.3 ä¸ºä»€ä¹ˆJavaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€</h3><p>JDK1.xæ—¶ä»£ï¼Œå°†Javaè¯­è¨€å®šä½ä¸ºâ€œè§£é‡Šæ‰§è¡Œâ€è¿˜æ˜¯æ¯”è¾ƒå‡†ç¡®çš„ã€‚å†åæ¥ï¼ŒJavaä¹Ÿå‘å±•å‡ºå¯ä»¥ç›´æ¥ç”Ÿæˆæœ¬åœ°ä»£ç çš„ç¼–è¯‘å™¨ã€‚ç°åœ¨JVMåœ¨æ‰§è¡ŒJavaä»£ç çš„æ—¶å€™ï¼Œé€šå¸¸éƒ½ä¼šå°†è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡ŒäºŒè€…ç»“åˆèµ·æ¥è¿›è¡Œã€‚</p><p>ç¿»è¯‘æˆæœ¬åœ°ä»£ç åï¼Œå°±å¯ä»¥åšä¸€ä¸ªç¼“å­˜æ“ä½œï¼Œå­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­</p><h2 id="3-æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€"><a href="#3-æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€" class="headerlink" title="3 æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€"></a>3 æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€</h2><h3 id="3-1-æœºå™¨ç "><a href="#3-1-æœºå™¨ç " class="headerlink" title="3.1 æœºå™¨ç "></a>3.1 æœºå™¨ç </h3><p>å„ç§ç”¨äºŒè¿›åˆ¶ç¼–ç æ–¹å¼è¡¨ç¤ºçš„æŒ‡ä»¤ï¼Œå«åšæœºå™¨æŒ‡ä»¤ç ã€‚å¼€å§‹ï¼Œäººä»¬å°±ç”¨å®ƒé‡‡ç¼–å†™ç¨‹åºï¼Œè¿™å°±æ˜¯æœºå™¨è¯­è¨€ã€‚</p><p>æœºå™¨è¯­è¨€è™½ç„¶èƒ½å¤Ÿè¢«è®¡ç®—æœºç†è§£å’Œæ¥å—ï¼Œä½†å’Œäººä»¬çš„è¯­è¨€å·®åˆ«å¤ªå¤§ï¼Œä¸æ˜“è¢«äººä»¬ç†è§£å’Œè®°å¿†ï¼Œå¹¶ä¸”ç”¨å®ƒç¼–ç¨‹å®¹æ˜“å‡ºå·®é”™ã€‚</p><p>ç”¨å®ƒç¼–å†™çš„ç¨‹åºä¸€ç»è¾“å…¥è®¡ç®—æœºï¼ŒCPUç›´æ¥è¯»å–è¿è¡Œï¼Œå› æ­¤å’Œå…¶ä»–è¯­è¨€ç¼–çš„ç¨‹åºç›¸æ¯”ï¼Œæ‰§è¡Œé€Ÿåº¦æœ€å¿«ã€‚</p><p>æœºå™¨æŒ‡ä»¤ä¸CPUç´§å¯†ç›¸å…³ï¼Œæ‰€ä»¥ä¸åŒç§ç±»çš„CPUæ‰€å¯¹åº”çš„æœºå™¨æŒ‡ä»¤ä¹Ÿå°±ä¸åŒã€‚</p><h3 id="3-2-æŒ‡ä»¤"><a href="#3-2-æŒ‡ä»¤" class="headerlink" title="3.2 æŒ‡ä»¤"></a>3.2 æŒ‡ä»¤</h3><p>ç”±äºæœºå™¨ç æ˜¯æœ‰0å’Œ1ç»„æˆçš„äºŒè¿›åˆ¶åºåˆ—ï¼Œå¯è¯»æ€§å®åœ¨å¤ªå·®ï¼Œäºæ˜¯äººä»¬å‘æ˜äº†æŒ‡ä»¤ã€‚</p><p>æŒ‡ä»¤å°±æ˜¯æŠŠæœºå™¨ç ä¸­ç‰¹å®šçš„0å’Œ1åºåˆ—ï¼Œç®€åŒ–æˆå¯¹åº”çš„æŒ‡ä»¤ï¼ˆä¸€èˆ¬ä¸ºè‹±æ–‡ç®€å†™ï¼Œå¦‚movï¼Œincç­‰ï¼‰ï¼Œå¯è¯»æ€§ç¨å¥½</p><p>ç”±äºä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ‰§è¡ŒåŒä¸€ä¸ªæ“ä½œï¼Œå¯¹åº”çš„æœºå™¨ç å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„ç¡¬ä»¶å¹³å°çš„åŒä¸€ç§æŒ‡ä»¤ï¼ˆæ¯”å¦‚movï¼‰ï¼Œå¯¹åº”çš„æœºå™¨ç ä¹Ÿå¯èƒ½ä¸åŒã€‚</p><h3 id="3-3-æŒ‡ä»¤é›†"><a href="#3-3-æŒ‡ä»¤é›†" class="headerlink" title="3.3 æŒ‡ä»¤é›†"></a>3.3 æŒ‡ä»¤é›†</h3><p>ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œå„è‡ªæ”¯æŒçš„æŒ‡ä»¤ï¼Œæ˜¯æœ‰å·®åˆ«çš„ã€‚å› æ­¤æ¯ä¸ªå¹³å°æ‰€æ”¯æŒçš„æŒ‡ä»¤ï¼Œç§°ä¹‹ä¸ºå¯¹åº”å¹³å°çš„æŒ‡ä»¤é›†ã€‚<br>å¦‚å¸¸è§çš„</p><ul><li>x86æŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯x86æ¶æ„çš„å¹³å°</li><li>ARMæŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯ARMæ¶æ„çš„å¹³å°</li></ul><h3 id="3-4-æ±‡ç¼–è¯­è¨€"><a href="#3-4-æ±‡ç¼–è¯­è¨€" class="headerlink" title="3.4 æ±‡ç¼–è¯­è¨€"></a>3.4 æ±‡ç¼–è¯­è¨€</h3><p>ç”±äºæŒ‡ä»¤çš„å¯è¯»æ€§è¿˜æ˜¯å¤ªå·®ï¼Œäºæ˜¯äººä»¬åˆå‘æ˜äº†æ±‡ç¼–è¯­è¨€ã€‚</p><p>åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œç”¨åŠ©è®°ç¬¦ï¼ˆMnemonicsï¼‰ä»£æ›¿æœºå™¨æŒ‡ä»¤çš„æ“ä½œç ï¼Œç”¨åœ°å€ç¬¦å·ï¼ˆSymbo1ï¼‰æˆ–æ ‡å·ï¼ˆLabe1ï¼‰ä»£æ›¿æŒ‡ä»¤æˆ–æ“ä½œæ•°çš„åœ°å€ã€‚åœ¨ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ±‡ç¼–è¯­è¨€å¯¹åº”ç€ä¸åŒçš„æœºå™¨è¯­è¨€æŒ‡ä»¤é›†ï¼Œé€šè¿‡æ±‡ç¼–è¿‡ç¨‹è½¬æ¢æˆæœºå™¨æŒ‡ä»¤ã€‚</p><blockquote><p>ç”±äºè®¡ç®—æœºåªè®¤è¯†æŒ‡ä»¤ç ï¼Œæ‰€ä»¥ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ç¨‹åºè¿˜å¿…é¡»ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ç ï¼Œè®¡ç®—æœºæ‰èƒ½è¯†åˆ«å’Œæ‰§è¡Œã€‚</p></blockquote><h3 id="3-5-é«˜çº§è¯­è¨€"><a href="#3-5-é«˜çº§è¯­è¨€" class="headerlink" title="3.5 é«˜çº§è¯­è¨€"></a>3.5 é«˜çº§è¯­è¨€</h3><p>ä¸ºäº†ä½¿è®¡ç®—æœºç”¨æˆ·ç¼–ç¨‹åºæ›´å®¹æ˜“äº›ï¼Œåæ¥å°±å‡ºç°äº†å„ç§é«˜çº§è®¡ç®—æœºè¯­è¨€ã€‚</p><p>é«˜çº§è¯­è¨€æ¯”æœºå™¨è¯­è¨€ã€æ±‡ç¼–è¯­è¨€æ›´æ¥è¿‘äººçš„è¯­è¨€å½“è®¡ç®—æœºæ‰§è¡Œé«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºæ—¶ï¼Œä»ç„¶éœ€è¦æŠŠç¨‹åºè§£é‡Šå’Œç¼–è¯‘æˆæœºå™¨çš„æŒ‡ä»¤ç ã€‚å®Œæˆè¿™ä¸ªè¿‡ç¨‹çš„ç¨‹åºå°±å«åšè§£é‡Šç¨‹åºæˆ–ç¼–è¯‘ç¨‹åºã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710085323733.png" alt="image-20200710085323733"></p><p>é«˜çº§è¯­è¨€ä¹Ÿä¸æ˜¯ç›´æ¥ç¿»è¯‘æˆ æœºå™¨æŒ‡ä»¤ï¼Œè€Œæ˜¯ç¿»è¯‘æˆæ±‡ç¼–è¯­è¨€å—ï¼Œå¦‚ä¸‹é¢è¯´çš„Cå’ŒC++</p><h3 id="3-6-Cã€C-æºç¨‹åºæ‰§è¡Œè¿‡ç¨‹"><a href="#3-6-Cã€C-æºç¨‹åºæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="3.6 Cã€C++æºç¨‹åºæ‰§è¡Œè¿‡ç¨‹"></a>3.6 Cã€C++æºç¨‹åºæ‰§è¡Œè¿‡ç¨‹</h3><p>ç¼–è¯‘è¿‡ç¨‹åˆå¯ä»¥åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼šç¼–è¯‘å’Œæ±‡ç¼–ã€‚</p><p>ç¼–è¯‘è¿‡ç¨‹ï¼šæ˜¯è¯»å–æºç¨‹åºï¼ˆå­—ç¬¦æµï¼‰ï¼Œå¯¹ä¹‹è¿›è¡Œè¯æ³•å’Œè¯­æ³•çš„åˆ†æï¼Œå°†é«˜çº§è¯­è¨€æŒ‡ä»¤è½¬æ¢ä¸ºåŠŸèƒ½ç­‰æ•ˆçš„æ±‡ç¼–ä»£ç </p><p>æ±‡ç¼–è¿‡ç¨‹ï¼šå®é™…ä¸ŠæŒ‡æŠŠæ±‡ç¼–è¯­è¨€ä»£ç ç¿»è¯‘æˆç›®æ ‡æœºå™¨æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710085553258.png" alt="image-20200710085553258"></p><h3 id="3-7-å­—èŠ‚ç "><a href="#3-7-å­—èŠ‚ç " class="headerlink" title="3.7 å­—èŠ‚ç "></a>3.7 å­—èŠ‚ç </h3><p>å­—èŠ‚ç æ˜¯ä¸€ç§ä¸­é—´çŠ¶æ€ï¼ˆä¸­é—´ç ï¼‰çš„äºŒè¿›åˆ¶ä»£ç ï¼ˆæ–‡ä»¶ï¼‰ï¼Œå®ƒæ¯”æœºå™¨ç æ›´æŠ½è±¡ï¼Œéœ€è¦ç›´è¯‘å™¨è½¬è¯‘åæ‰èƒ½æˆä¸ºæœºå™¨ç </p><p>å­—èŠ‚ç ä¸»è¦ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒã€ä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³ã€‚</p><p>å­—èŠ‚ç çš„å®ç°æ–¹å¼æ˜¯é€šè¿‡ç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå™¨ã€‚ç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œç‰¹å®šå¹³å°ä¸Šçš„è™šæ‹Ÿæœºå™¨å°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p><ul><li>å­—èŠ‚ç å…¸å‹çš„åº”ç”¨ä¸ºï¼šJava bytecode</li></ul><h2 id="4-è§£é‡Šå™¨"><a href="#4-è§£é‡Šå™¨" class="headerlink" title="4 è§£é‡Šå™¨"></a>4 è§£é‡Šå™¨</h2><p>JVMè®¾è®¡è€…ä»¬çš„åˆè¡·ä»…ä»…åªæ˜¯å•çº¯åœ°ä¸ºäº†æ»¡è¶³Javaç¨‹åºå®ç°è·¨å¹³å°ç‰¹æ€§ï¼Œå› æ­¤é¿å…é‡‡ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼ç›´æ¥ç”Ÿæˆæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»è€Œè¯ç”Ÿäº†å®ç°è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶é‡‡ç”¨é€è¡Œè§£é‡Šå­—èŠ‚ç æ‰§è¡Œç¨‹åºçš„æƒ³æ³•ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710090203674.png" alt="image-20200710090203674"></p><p>ä¸ºä»€ä¹ˆJavaæºæ–‡ä»¶ä¸ç›´æ¥ç¿»è¯‘æˆJMVï¼Œè€Œæ˜¯ç¿»è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Ÿå¯èƒ½æ˜¯å› ä¸ºç›´æ¥ç¿»è¯‘çš„ä»£ç æ˜¯æ¯”è¾ƒå¤§çš„</p><p>è§£é‡Šå™¨çœŸæ­£æ„ä¹‰ä¸Šæ‰€æ‰¿æ‹…çš„è§’è‰²å°±æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶â€œç¿»è¯‘è€…â€ï¼Œå°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p><p>å½“ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤è¢«è§£é‡Šæ‰§è¡Œå®Œæˆåï¼Œæ¥ç€å†æ ¹æ®PCå¯„å­˜å™¨ä¸­è®°å½•çš„ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œè§£é‡Šæ“ä½œã€‚</p><h3 id="è§£é‡Šå™¨åˆ†ç±»"><a href="#è§£é‡Šå™¨åˆ†ç±»" class="headerlink" title="è§£é‡Šå™¨åˆ†ç±»"></a>è§£é‡Šå™¨åˆ†ç±»</h3><p>åœ¨Javaçš„å‘å±•å†å²é‡Œï¼Œä¸€å…±æœ‰ä¸¤å¥—è§£é‡Šæ‰§è¡Œå™¨ï¼Œå³å¤è€çš„å­—èŠ‚ç è§£é‡Šå™¨ã€ç°åœ¨æ™®éä½¿ç”¨çš„æ¨¡æ¿è§£é‡Šå™¨ã€‚</p><p>å­—èŠ‚ç è§£é‡Šå™¨åœ¨æ‰§è¡Œæ—¶é€šè¿‡çº¯è½¯ä»¶ä»£ç æ¨¡æ‹Ÿå­—èŠ‚ç çš„æ‰§è¡Œï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚</p><p>è€Œæ¨¡æ¿è§£é‡Šå™¨å°†æ¯ä¸€æ¡å­—èŠ‚ç å’Œä¸€ä¸ªæ¨¡æ¿å‡½æ•°ç›¸å…³è”ï¼Œæ¨¡æ¿å‡½æ•°ä¸­ç›´æ¥äº§ç”Ÿè¿™æ¡å­—èŠ‚ç æ‰§è¡Œæ—¶çš„æœºå™¨ç ï¼Œä»è€Œå¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†è§£é‡Šå™¨çš„æ€§èƒ½ã€‚</p><p>åœ¨HotSpot VMä¸­ï¼Œè§£é‡Šå™¨ä¸»è¦ç”±Interpreteræ¨¡å—å’ŒCodeæ¨¡å—æ„æˆã€‚</p><ul><li>Interpreteræ¨¡å—ï¼šå®ç°äº†è§£é‡Šå™¨çš„æ ¸å¿ƒåŠŸèƒ½</li><li>Codeæ¨¡å—ï¼šç”¨äºç®¡ç†HotSpot VMåœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤</li></ul><h3 id="ç°çŠ¶"><a href="#ç°çŠ¶" class="headerlink" title="ç°çŠ¶"></a>ç°çŠ¶</h3><p>ç”±äºè§£é‡Šå™¨åœ¨è®¾è®¡å’Œå®ç°ä¸Šéå¸¸ç®€å•ï¼Œå› æ­¤é™¤äº†Javaè¯­è¨€ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šé«˜çº§è¯­è¨€åŒæ ·ä¹Ÿæ˜¯åŸºäºè§£é‡Šå™¨æ‰§è¡Œçš„ï¼Œæ¯”å¦‚Pythonã€Per1ã€Rubyç­‰ã€‚ä½†æ˜¯åœ¨ä»Šå¤©ï¼ŒåŸºäºè§£é‡Šå™¨æ‰§è¡Œå·²ç»æ²¦è½ä¸ºä½æ•ˆçš„ä»£åè¯ï¼Œå¹¶ä¸”æ—¶å¸¸è¢«ä¸€äº›C/C++ç¨‹åºå‘˜æ‰€è°ƒä¾ƒã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJVMå¹³å°æ”¯æŒä¸€ç§å«ä½œå³æ—¶ç¼–è¯‘çš„æŠ€æœ¯ã€‚å³æ—¶ç¼–è¯‘çš„ç›®çš„æ˜¯é¿å…å‡½æ•°è¢«è§£é‡Šæ‰§è¡Œï¼Œè€Œæ˜¯å°†æ•´ä¸ªå‡½æ•°ä½“ç¼–è¯‘æˆä¸ºæœºå™¨ç ï¼Œæ¯æ¬¡å‡½æ•°æ‰§è¡Œæ—¶ï¼Œåªæ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç å³å¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½¿æ‰§è¡Œæ•ˆç‡å¤§å¹…åº¦æå‡ã€‚</p><p>ä¸è¿‡æ— è®ºå¦‚ä½•ï¼ŒåŸºäºè§£é‡Šå™¨çš„æ‰§è¡Œæ¨¡å¼ä»ç„¶ä¸ºä¸­é—´è¯­è¨€çš„å‘å±•åšå‡ºäº†ä¸å¯ç£¨ç­çš„è´¡çŒ®ã€‚</p><h2 id="5-JITç¼–è¯‘å™¨"><a href="#5-JITç¼–è¯‘å™¨" class="headerlink" title="5 JITç¼–è¯‘å™¨"></a>5 JITç¼–è¯‘å™¨</h2><h3 id="5-1-Javaä»£ç çš„æ‰§è¡Œåˆ†ç±»"><a href="#5-1-Javaä»£ç çš„æ‰§è¡Œåˆ†ç±»" class="headerlink" title="5.1 Javaä»£ç çš„æ‰§è¡Œåˆ†ç±»"></a>5.1 Javaä»£ç çš„æ‰§è¡Œåˆ†ç±»</h3><p>ç¬¬ä¸€ç§æ˜¯å°†æºä»£ç ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶ååœ¨è¿è¡Œæ—¶é€šè¿‡è§£é‡Šå™¨å°†å­—èŠ‚ç æ–‡ä»¶è½¬ä¸ºæœºå™¨ç æ‰§è¡Œ</p><p>ç¬¬äºŒç§æ˜¯ç¼–è¯‘æ‰§è¡Œï¼ˆç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼‰ã€‚ç°ä»£è™šæ‹Ÿæœºä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œä¼šä½¿ç”¨å³æ—¶ç¼–è¯‘æŠ€æœ¯ï¼ˆJITï¼ŒJust In Timeï¼‰å°†æ–¹æ³•ç¼–è¯‘æˆæœºå™¨ç åå†æ‰§è¡Œ</p><p>HotSpot VMæ˜¯ç›®å‰å¸‚é¢ä¸Šé«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ä»£è¡¨ä½œä¹‹ä¸€ã€‚å®ƒé‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ã€‚åœ¨Javaè™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œè§£é‡Šå™¨å’Œå³æ—¶ç¼–è¯‘å™¨èƒ½å¤Ÿç›¸äº’åä½œï¼Œå„è‡ªå–é•¿è¡¥çŸ­ï¼Œå°½åŠ›å»é€‰æ‹©æœ€åˆé€‚çš„æ–¹å¼æ¥æƒè¡¡ç¼–è¯‘æœ¬åœ°ä»£ç çš„æ—¶é—´å’Œç›´æ¥è§£é‡Šæ‰§è¡Œä»£ç çš„æ—¶é—´ã€‚</p><p>åœ¨ä»Šå¤©ï¼ŒJavaç¨‹åºçš„è¿è¡Œæ€§èƒ½æ—©å·²è„±èƒæ¢éª¨ï¼Œå·²ç»è¾¾åˆ°äº†å¯ä»¥å’ŒC/C++ ç¨‹åºä¸€è¾ƒé«˜ä¸‹çš„åœ°æ­¥ã€‚</p><h3 id="5-2-é—®é¢˜æ¥äº†"><a href="#5-2-é—®é¢˜æ¥äº†" class="headerlink" title="5.2 é—®é¢˜æ¥äº†"></a>5.2 é—®é¢˜æ¥äº†</h3><p>æœ‰äº›å¼€å‘äººå‘˜ä¼šæ„Ÿè§‰åˆ°è¯§å¼‚ï¼Œæ—¢ç„¶HotSpot VMä¸­å·²ç»å†…ç½®JITç¼–è¯‘å™¨äº†ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦å†ä½¿ç”¨è§£é‡Šå™¨æ¥â€œæ‹–ç´¯â€ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½å‘¢ï¼Ÿæ¯”å¦‚JRockit VMå†…éƒ¨å°±ä¸åŒ…å«è§£é‡Šå™¨ï¼Œå­—èŠ‚ç å…¨éƒ¨éƒ½ä¾é å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åæ‰§è¡Œã€‚</p><ul><li>JRockitè™šæ‹Ÿæœºæ˜¯ç æ‰äº†è§£é‡Šå™¨ï¼Œä¹Ÿå°±æ˜¯åªé‡‡åŠæ—¶ç¼–è¯‘å™¨ã€‚é‚£æ˜¯å› ä¸ºå‘¢JRockitåªéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼Œä¸€èˆ¬å·²ç»æœ‰æ—¶é—´è®©ä»–è¿›è¡ŒæŒ‡ä»¤ç¼–è¯‘çš„è¿‡ç¨‹äº†ï¼Œå¯¹äºå“åº”æ¥è¯´è¦æ±‚ä¸é«˜ï¼Œç­‰åŠæ—¶ç¼–è¯‘å™¨çš„ç¼–è¯‘å®Œæˆåï¼Œå°±ä¼šæä¾›æ›´å¥½çš„æ€§èƒ½</li></ul><p>é¦–å…ˆæ˜ç¡®ï¼š<br>å½“ç¨‹åºå¯åŠ¨åï¼Œè§£é‡Šå™¨å¯ä»¥é©¬ä¸Šå‘æŒ¥ä½œç”¨ï¼Œçœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œç«‹å³æ‰§è¡Œã€‚<br>ç¼–è¯‘å™¨è¦æƒ³å‘æŒ¥ä½œç”¨ï¼ŒæŠŠä»£ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼Œéœ€è¦ä¸€å®šçš„æ‰§è¡Œæ—¶é—´ã€‚ä½†ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç åï¼Œæ‰§è¡Œæ•ˆç‡é«˜ã€‚</p><p>æ‰€ä»¥ï¼š<br>å°½ç®¡JRockit VMä¸­ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ä¼šéå¸¸é«˜æ•ˆï¼Œä½†ç¨‹åºåœ¨å¯åŠ¨æ—¶å¿…ç„¶éœ€è¦èŠ±è´¹æ›´é•¿çš„æ—¶é—´æ¥è¿›è¡Œç¼–è¯‘ã€‚å¯¹äºæœåŠ¡ç«¯åº”ç”¨æ¥è¯´ï¼Œå¯åŠ¨æ—¶é—´å¹¶éæ˜¯å…³æ³¨é‡ç‚¹ï¼Œä½†å¯¹äºé‚£äº›çœ‹ä¸­å¯åŠ¨æ—¶é—´çš„åº”ç”¨åœºæ™¯è€Œè¨€ï¼Œæˆ–è®¸å°±éœ€è¦é‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„æ¥æ¢å–ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚</p><p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå½“Javaè™šæ‹Ÿå™¨å¯åŠ¨æ—¶ï¼Œè§£é‡Šå™¨å¯ä»¥é¦–å…ˆå‘æŒ¥ä½œç”¨ï¼Œè€Œä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨å…¨éƒ¨ç¼–è¯‘å®Œæˆåå†æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥çœå»è®¸å¤šä¸å¿…è¦çš„ç¼–è¯‘æ—¶é—´ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œç¼–è¯‘å™¨å‘æŒ¥ä½œç”¨ï¼ŒæŠŠè¶Šæ¥è¶Šå¤šçš„ä»£ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼Œè·å¾—æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚</p><p>åŒæ—¶ï¼Œè§£é‡Šæ‰§è¡Œåœ¨ç¼–è¯‘å™¨è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ä¸æˆç«‹çš„æ—¶å€™ï¼Œä½œä¸ºç¼–è¯‘å™¨çš„â€œé€ƒç”Ÿé—¨â€ã€‚</p><h3 id="5-3-HotSpot-JVMæ‰§è¡Œæ–¹å¼"><a href="#5-3-HotSpot-JVMæ‰§è¡Œæ–¹å¼" class="headerlink" title="5.3 HotSpot JVMæ‰§è¡Œæ–¹å¼"></a>5.3 HotSpot JVMæ‰§è¡Œæ–¹å¼</h3><p>å½“è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™ï¼Œè§£é‡Šå™¨å¯ä»¥é¦–å…ˆå‘æŒ¥ä½œç”¨ï¼Œè€Œä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨å…¨éƒ¨ç¼–è¯‘å®Œæˆå†æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥çœå»è®¸å¤šä¸å¿…è¦çš„ç¼–è¯‘æ—¶é—´ã€‚å¹¶ä¸”éšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„æ¨ç§»ï¼Œå³æ—¶ç¼–è¯‘å™¨é€æ¸å‘æŒ¥ä½œç”¨ï¼Œæ ¹æ®çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ï¼Œå°†æœ‰ä»·å€¼çš„å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ¢å–æ›´é«˜çš„ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p><h3 id="5-4-æ¡ˆä¾‹"><a href="#5-4-æ¡ˆä¾‹" class="headerlink" title="5.4 æ¡ˆä¾‹"></a>5.4 æ¡ˆä¾‹</h3><p>æ³¨æ„è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡Œåœ¨çº¿ä¸Šç¯å¢ƒå¾®å¦™çš„è¾©è¯å…³ç³»ã€‚æœºå™¨åœ¨çƒ­æœºçŠ¶æ€å¯ä»¥æ‰¿å—çš„è´Ÿè½½è¦å¤§äºå†·æœºçŠ¶æ€ã€‚å¦‚æœä»¥çƒ­æœºçŠ¶æ€æ—¶çš„æµé‡è¿›è¡Œåˆ‡æµï¼Œå¯èƒ½ä½¿å¤„äºå†·æœºçŠ¶æ€çš„æœåŠ¡å™¨å› æ— æ³•æ‰¿è½½æµé‡è€Œå‡æ­»ã€‚</p><p>åœ¨ç”Ÿäº§ç¯å¢ƒå‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œä»¥åˆ†æ‰¹çš„æ–¹å¼è¿›è¡Œå‘å¸ƒï¼Œæ ¹æ®æœºå™¨æ•°é‡åˆ’åˆ†æˆå¤šä¸ªæ‰¹æ¬¡ï¼Œæ¯ä¸ªæ‰¹æ¬¡çš„æœºå™¨æ•°è‡³å¤šå åˆ°æ•´ä¸ªé›†ç¾¤çš„1/8ã€‚æ›¾ç»æœ‰è¿™æ ·çš„æ•…éšœæ¡ˆä¾‹ï¼šæŸç¨‹åºå‘˜åœ¨å‘å¸ƒå¹³å°è¿›è¡Œåˆ†æ‰¹å‘å¸ƒï¼Œåœ¨è¾“å…¥å‘å¸ƒæ€»æ‰¹æ•°æ—¶ï¼Œè¯¯å¡«å†™æˆåˆ†ä¸ºä¸¤æ‰¹å‘å¸ƒã€‚å¦‚æœæ˜¯çƒ­æœºçŠ¶æ€ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸€åŠçš„æœºå™¨å¯ä»¥å‹‰å¼ºæ‰¿è½½æµé‡ï¼Œä½†ç”±äºåˆšå¯åŠ¨çš„JVMå‡æ˜¯è§£é‡Šæ‰§è¡Œï¼Œè¿˜æ²¡æœ‰è¿›è¡Œçƒ­ç‚¹ä»£ç ç»Ÿè®¡å’ŒJITåŠ¨æ€ç¼–è¯‘ï¼Œå¯¼è‡´æœºå™¨å¯åŠ¨ä¹‹åï¼Œå½“å‰1/2å‘å¸ƒæˆåŠŸçš„æœåŠ¡å™¨é©¬ä¸Šå…¨éƒ¨å®•æœºï¼Œæ­¤æ•…éšœè¯´æ˜äº†JITçš„å­˜åœ¨ã€‚â€”é˜¿é‡Œå›¢é˜Ÿ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710095417462.png" alt="image-20200710095417462"></p><h3 id="5-5-æ¦‚å¿µè§£é‡Š"><a href="#5-5-æ¦‚å¿µè§£é‡Š" class="headerlink" title="5.5 æ¦‚å¿µè§£é‡Š"></a>5.5 æ¦‚å¿µè§£é‡Š</h3><ul><li>Java è¯­è¨€çš„â€œç¼–è¯‘æœŸâ€å…¶å®æ˜¯ä¸€æ®µâ€œä¸ç¡®å®šâ€çš„æ“ä½œè¿‡ç¨‹ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯æŒ‡ä¸€ä¸ªå‰ç«¯ç¼–è¯‘å™¨ï¼ˆå…¶å®å«â€œç¼–è¯‘å™¨çš„å‰ç«¯â€æ›´å‡†ç¡®ä¸€äº›ï¼‰æŠŠ.javaæ–‡ä»¶è½¬å˜æˆ.classæ–‡ä»¶çš„è¿‡ç¨‹ï¼›ä¹Ÿå¯èƒ½æ˜¯æŒ‡è™šæ‹Ÿæœºçš„åç«¯è¿è¡ŒæœŸç¼–è¯‘å™¨ï¼ˆJITç¼–è¯‘å™¨ï¼ŒJust In Time Compilerï¼‰</li><li>æŠŠå­—èŠ‚ç è½¬å˜æˆæœºå™¨ç çš„è¿‡ç¨‹ã€‚</li><li>è¿˜å¯èƒ½æ˜¯æŒ‡ä½¿ç”¨é™æ€æå‰ç¼–è¯‘å™¨ï¼ˆAOTç¼–è¯‘å™¨ï¼ŒAhead of Time Compilerï¼‰ç›´æ¥æŠŠ.javaæ–‡ä»¶ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ä»£ç çš„è¿‡ç¨‹ã€‚</li></ul><p>å‰ç«¯ç¼–è¯‘å™¨ï¼šSunçš„Javacã€Eclipse JDTä¸­çš„å¢é‡å¼ç¼–è¯‘å™¨ï¼ˆECJï¼‰ã€‚</p><p>JITç¼–è¯‘å™¨ï¼šHotSpot VMçš„C1ã€C2ç¼–è¯‘å™¨ã€‚</p><p>AOT ç¼–è¯‘å™¨ï¼šGNU Compiler for the Javaï¼ˆGCJï¼‰ã€Excelsior JETã€‚</p><h3 id="5-6-çƒ­ç‚¹æ¢æµ‹æŠ€æœ¯"><a href="#5-6-çƒ­ç‚¹æ¢æµ‹æŠ€æœ¯" class="headerlink" title="5.6 çƒ­ç‚¹æ¢æµ‹æŠ€æœ¯"></a>5.6 çƒ­ç‚¹æ¢æµ‹æŠ€æœ¯</h3><p>ä¸€ä¸ªè¢«å¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ–¹æ³•ä½“å†…éƒ¨å¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“éƒ½å¯ä»¥è¢«ç§°ä¹‹ä¸ºâ€œçƒ­ç‚¹ä»£ç â€ï¼Œå› æ­¤éƒ½å¯ä»¥é€šè¿‡JITç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚ç”±äºè¿™ç§ç¼–è¯‘æ–¹å¼å‘ç”Ÿåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› æ­¤è¢«ç§°ä¹‹ä¸ºæ ˆä¸Šæ›¿æ¢ï¼Œæˆ–ç®€ç§°ä¸ºOSRï¼ˆOn Stack Replacementï¼‰ç¼–è¯‘ã€‚</p><p>ä¸€ä¸ªæ–¹æ³•ç©¶ç«Ÿè¦è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œæˆ–è€…ä¸€ä¸ªå¾ªç¯ä½“ç©¶ç«Ÿéœ€è¦æ‰§è¡Œå¤šå°‘æ¬¡å¾ªç¯æ‰å¯ä»¥è¾¾åˆ°è¿™ä¸ªæ ‡å‡†ï¼Ÿå¿…ç„¶éœ€è¦ä¸€ä¸ªæ˜ç¡®çš„é˜ˆå€¼ï¼ŒJITç¼–è¯‘å™¨æ‰ä¼šå°†è¿™äº›â€œçƒ­ç‚¹ä»£ç â€ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚è¿™é‡Œä¸»è¦ä¾é çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ã€‚</p><p>ç›®å‰HotSpot VMæ‰€é‡‡ç”¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹å¼æ˜¯åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ã€‚</p><p>é‡‡ç”¨åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ï¼ŒHotSpot Vå°†ä¼šä¸ºæ¯ä¸€ä¸ªæ–¹æ³•éƒ½å»ºç«‹2ä¸ªä¸åŒç±»å‹çš„è®¡æ•°å™¨ï¼Œåˆ†åˆ«ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼ˆInvocation Counterï¼‰å’Œå›è¾¹è®¡æ•°å™¨ï¼ˆBack Edge Counterï¼‰ã€‚</p><ul><li>æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç”¨äºç»Ÿè®¡æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°</li><li>å›è¾¹è®¡æ•°å™¨åˆ™ç”¨äºç»Ÿè®¡å¾ªç¯ä½“æ‰§è¡Œçš„å¾ªç¯æ¬¡æ•°</li></ul><h3 id="5-7-æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨"><a href="#5-7-æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨" class="headerlink" title="5.7 æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨"></a>5.7 æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨</h3><p>è¿™ä¸ªè®¡æ•°å™¨å°±ç”¨äºç»Ÿè®¡æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ï¼Œå®ƒçš„é»˜è®¤é˜€å€¼åœ¨Clientæ¨¡å¼ä¸‹æ˜¯1500æ¬¡ï¼Œåœ¨Serveræ¨¡å¼ä¸‹æ˜¯10000æ¬¡ã€‚è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘JITç¼–è¯‘ã€‚</p><p>è¿™ä¸ªé˜€å€¼å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•° -XX:CompileThreshold æ¥äººä¸ºè®¾å®šã€‚</p><p>å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨è¢«JITç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç æ¥æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨å·²è¢«ç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œåˆ™å°†æ­¤æ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å€¼åŠ 1ï¼Œç„¶ååˆ¤æ–­æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ä¸å›è¾¹è®¡æ•°å™¨å€¼ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜€å€¼ã€‚å¦‚æœå·²è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå°†ä¼šå‘å³æ—¶ç¼–è¯‘å™¨æäº¤ä¸€ä¸ªè¯¥æ–¹æ³•çš„ä»£ç ç¼–è¯‘è¯·æ±‚ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710101829934.png" alt="image-20200710101829934"></p><h3 id="5-8-çƒ­ç‚¹è¡°å‡"><a href="#5-8-çƒ­ç‚¹è¡°å‡" class="headerlink" title="5.8 çƒ­ç‚¹è¡°å‡"></a>5.8 çƒ­ç‚¹è¡°å‡</h3><p> å¦‚æœä¸åšä»»ä½•è®¾ç½®ï¼Œæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç»Ÿè®¡çš„å¹¶ä¸æ˜¯æ–¹æ³•è¢«è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ‰§è¡Œé¢‘ç‡ï¼Œå³ä¸€æ®µæ—¶é—´ä¹‹å†…æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚å½“è¶…è¿‡ä¸€å®šçš„æ—¶é—´é™åº¦ï¼Œå¦‚æœæ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä»ç„¶ä¸è¶³ä»¥è®©å®ƒæäº¤ç»™å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œé‚£è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å°±ä¼šè¢«å‡å°‘ä¸€åŠï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çƒ­åº¦çš„è¡°å‡ï¼ˆCounter Decayï¼‰ï¼Œè€Œè¿™æ®µæ—¶é—´å°±ç§°ä¸ºæ­¤æ–¹æ³•ç»Ÿè®¡çš„åŠè¡°å‘¨æœŸï¼ˆCounter Half Life Timeï¼‰</p><ul><li>åŠè¡°å‘¨æœŸæ˜¯åŒ–å­¦ä¸­çš„æ¦‚å¿µï¼Œæ¯”å¦‚å‡ºåœŸçš„æ–‡ç‰©é€šè¿‡æŸ¥çœ‹C60æ¥è·å¾—æ–‡ç‰©çš„å¹´é¾„</li></ul><p>è¿›è¡Œçƒ­åº¦è¡°å‡çš„åŠ¨ä½œæ˜¯åœ¨è™šæ‹Ÿæœºè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶é¡ºä¾¿è¿›è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•°<br>-XX:-UseCounterDecay æ¥å…³é—­çƒ­åº¦è¡°å‡ï¼Œè®©æ–¹æ³•è®¡æ•°å™¨ç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè¿™æ ·ï¼Œåªè¦ç³»ç»Ÿè¿è¡Œæ—¶é—´è¶³å¤Ÿé•¿ï¼Œç»å¤§éƒ¨åˆ†æ–¹æ³•éƒ½ä¼šè¢«ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚</p><p>å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨-XX:CounterHalfLifeTimeå‚æ•°è®¾ç½®åŠè¡°å‘¨æœŸçš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚</p><h3 id="5-9-å›è¾¹è®¡æ•°å™¨"><a href="#5-9-å›è¾¹è®¡æ•°å™¨" class="headerlink" title="5.9 å›è¾¹è®¡æ•°å™¨"></a>5.9 å›è¾¹è®¡æ•°å™¨</h3><p>å®ƒçš„ä½œç”¨æ˜¯ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­é‡åˆ°æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸ºâ€œå›è¾¹â€ï¼ˆBack Edgeï¼‰ã€‚æ˜¾ç„¶ï¼Œå»ºç«‹å›è¾¹è®¡æ•°å™¨ç»Ÿè®¡çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§¦å‘OSRç¼–è¯‘ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710103103869.png" alt="image-20200710103103869"></p><h3 id="5-10-HotSpotVM-å¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹æ³•"><a href="#5-10-HotSpotVM-å¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹æ³•" class="headerlink" title="5.10 HotSpotVM å¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹æ³•"></a>5.10 HotSpotVM å¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹æ³•</h3><p>ç¼ºçœæƒ…å†µä¸‹HotSpot VMæ˜¯é‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ï¼Œå½“ç„¶å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œé€šè¿‡å‘½ä»¤æ˜¾å¼åœ°ä¸ºJavaè™šæ‹ŸæœºæŒ‡å®šåœ¨è¿è¡Œæ—¶åˆ°åº•æ˜¯å®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Œè¿˜æ˜¯å®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ‰§è¡Œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>-Xintï¼šå®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ¨¡å¼æ‰§è¡Œç¨‹åºï¼›</li><li>-Xcompï¼šå®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚å¦‚æœå³æ—¶ç¼–è¯‘å‡ºç°é—®é¢˜ï¼Œè§£é‡Šå™¨ä¼šä»‹å…¥æ‰§è¡Œ</li><li>-Xmixedï¼šé‡‡ç”¨è§£é‡Šå™¨+å³æ—¶ç¼–è¯‘å™¨çš„æ··åˆæ¨¡å¼å…±åŒæ‰§è¡Œç¨‹åºã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200710103340273.png" alt="image-20200710103340273"></p><h3 id="5-11-HotSpotVMä¸­-JIT-åˆ†ç±»"><a href="#5-11-HotSpotVMä¸­-JIT-åˆ†ç±»" class="headerlink" title="5.11 HotSpotVMä¸­ JIT åˆ†ç±»"></a>5.11 HotSpotVMä¸­ JIT åˆ†ç±»</h3><p>JITçš„ç¼–è¯‘å™¨è¿˜åˆ†ä¸ºäº†ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯C1å’ŒC2ï¼Œåœ¨HotSpot VMä¸­å†…åµŒæœ‰ä¸¤ä¸ªJITç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸ºClient Compilerå’ŒServer Compilerï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ç®€ç§°ä¸ºC1ç¼–è¯‘å™¨ å’Œ C2ç¼–è¯‘å™¨ã€‚å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ˜¾å¼æŒ‡å®šJavaè™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶åˆ°åº•ä½¿ç”¨å“ªä¸€ç§å³æ—¶ç¼–è¯‘å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li><p>-clientï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C1ç¼–è¯‘å™¨ï¼›</p><ul><li>C1ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ã€‚ä»¥è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚</li></ul></li><li><p>-serverï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨serveræ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C2ç¼–è¯‘å™¨ã€‚</p><ul><li>C2è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ã€‚ä½†ä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚ï¼ˆä½¿ç”¨C++ï¼‰</li></ul></li></ul><h3 id="5-12-C1-å’Œ-C2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥"><a href="#5-12-C1-å’Œ-C2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="5.12 C1 å’Œ C2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥"></a>5.12 C1 å’Œ C2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥</h3><p>åœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¸Šæœ‰ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥ï¼ŒC1ç¼–è¯‘å™¨ä¸Šä¸»è¦æœ‰æ–¹æ³•å†…è”ï¼Œå»è™šæ‹ŸåŒ–ã€å…ƒä½™æ¶ˆé™¤ã€‚</p><ul><li>æ–¹æ³•å†…è”ï¼šå°†å¼•ç”¨çš„å‡½æ•°ä»£ç ç¼–è¯‘åˆ°å¼•ç”¨ç‚¹å¤„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ ˆå¸§çš„ç”Ÿæˆï¼Œå‡å°‘å‚æ•°ä¼ é€’ä»¥åŠè·³è½¬è¿‡ç¨‹</li><li>å»è™šæ‹ŸåŒ–ï¼šå¯¹å”¯ä¸€çš„å®ç°æ¨Šè¿›è¡Œå†…è”</li><li>å†—ä½™æ¶ˆé™¤ï¼šåœ¨è¿è¡ŒæœŸé—´æŠŠä¸€äº›ä¸ä¼šæ‰§è¡Œçš„ä»£ç æŠ˜å æ‰</li></ul><p>C2çš„ä¼˜åŒ–ä¸»è¦æ˜¯åœ¨å…¨å±€å±‚é¢ï¼Œé€ƒé€¸åˆ†ææ˜¯ä¼˜åŒ–çš„åŸºç¡€ã€‚åŸºäºé€ƒé€¸åˆ†æåœ¨C2ä¸Šæœ‰å¦‚ä¸‹å‡ ç§ä¼˜åŒ–ï¼š</p><ul><li>æ ‡é‡æ›¿æ¢ï¼šç”¨æ ‡é‡å€¼ä»£æ›¿èšåˆå¯¹è±¡çš„å±æ€§å€¼</li><li>æ ˆä¸Šåˆ†é…ï¼šå¯¹äºæœªé€ƒé€¸çš„å¯¹è±¡åˆ†é…å¯¹è±¡åœ¨æ ˆè€Œä¸æ˜¯å †</li><li>åŒæ­¥æ¶ˆé™¤ï¼šæ¸…é™¤åŒæ­¥æ“ä½œï¼Œé€šå¸¸æŒ‡synchronized</li></ul><h3 id="5-13-åˆ†å±‚ç¼–è¯‘ç­–ç•¥"><a href="#5-13-åˆ†å±‚ç¼–è¯‘ç­–ç•¥" class="headerlink" title="5.13 åˆ†å±‚ç¼–è¯‘ç­–ç•¥"></a>5.13 åˆ†å±‚ç¼–è¯‘ç­–ç•¥</h3><p>åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ç­–ç•¥ï¼šç¨‹åºè§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯æ€§èƒ½ç›‘æ§ï¼‰å¯ä»¥è§¦å‘C1ç¼–è¯‘ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œå¯ä»¥è¿›è¡Œç®€å•ä¼˜åŒ–ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Šæ€§èƒ½ç›‘æ§ï¼ŒC2ç¼–è¯‘ä¼šæ ¹æ®æ€§èƒ½ç›‘æ§ä¿¡æ¯è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ã€‚</p><p>ä¸è¿‡åœ¨Java7ç‰ˆæœ¬ä¹‹åï¼Œä¸€æ—¦å¼€å‘äººå‘˜åœ¨ç¨‹åºä¸­æ˜¾å¼æŒ‡å®šå‘½ä»¤â€œ-serverâ€æ—¶ï¼Œé»˜è®¤å°†ä¼šå¼€å¯åˆ†å±‚ç¼–è¯‘ç­–ç•¥ï¼Œç”±C1ç¼–è¯‘å™¨å’ŒC2ç¼–è¯‘å™¨ç›¸äº’åä½œå…±åŒæ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡ã€‚</p><h3 id="5-14-æ€»ç»“"><a href="#5-14-æ€»ç»“" class="headerlink" title="5.14 æ€»ç»“"></a>5.14 æ€»ç»“</h3><ul><li>ä¸€èˆ¬æ¥è®²ï¼ŒJITç¼–è¯‘å‡ºæ¥çš„æœºå™¨ç æ€§èƒ½æ¯”è§£é‡Šå™¨æ</li><li>C2ç¼–è¯‘å™¨å¯åŠ¨æ—¶é•¿æ¯”C1æ…¢ï¼Œç³»ç»Ÿç¨³å®šæ‰§è¡Œä»¥åï¼ŒC2ç¼–è¯‘å™¨æ‰§è¡Œé€Ÿåº¦è¿œå¿«äºC1ç¼–è¯‘å™¨</li></ul><h3 id="5-15-AOTç¼–è¯‘å™¨"><a href="#5-15-AOTç¼–è¯‘å™¨" class="headerlink" title="5.15 AOTç¼–è¯‘å™¨"></a>5.15 AOTç¼–è¯‘å™¨</h3><p>jdk9å¼•å…¥äº†AoTç¼–è¯‘å™¨ï¼ˆé™æ€æå‰ç¼–è¯‘å™¨ï¼ŒAhead of Time Compilerï¼‰</p><p>Java 9å¼•å…¥äº†å®éªŒæ€§AOTç¼–è¯‘å·¥å…·aotcã€‚å®ƒå€ŸåŠ©äº†Graalç¼–è¯‘å™¨ï¼Œå°†æ‰€è¾“å…¥çš„Javaç±»æ–‡ä»¶è½¬æ¢ä¸ºæœºå™¨ç ï¼Œå¹¶å­˜æ”¾è‡³ç”Ÿæˆçš„åŠ¨æ€å…±äº«åº“ä¹‹ä¸­ã€‚</p><p>æ‰€è°“AOTç¼–è¯‘ï¼Œæ˜¯ä¸å³æ—¶ç¼–è¯‘ç›¸å¯¹ç«‹çš„ä¸€ä¸ªæ¦‚å¿µã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå³æ—¶ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå°†å­—èŠ‚ç è½¬æ¢ä¸ºå¯åœ¨ç¡¬ä»¶ä¸Šç›´æ¥è¿è¡Œçš„æœºå™¨ç ï¼Œå¹¶éƒ¨ç½²è‡³æ‰˜ç®¡ç¯å¢ƒä¸­çš„è¿‡ç¨‹ã€‚è€ŒAOTç¼–è¯‘æŒ‡çš„åˆ™æ˜¯ï¼Œåœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œä¾¿å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç çš„è¿‡ç¨‹ã€‚</p><div class="code-wrapper"><pre><code class="hljs livescript">.java -&gt; .<span class="hljs-keyword">class</span> -&gt; <span class="hljs-function"><span class="hljs-params">(ä½¿ç”¨jaotc)</span> -&gt;</span> .so</code></pre></div><p>æœ€å¤§çš„å¥½å¤„ï¼šJavaè™šæ‹ŸæœºåŠ è½½å·²ç»é¢„ç¼–è¯‘æˆäºŒè¿›åˆ¶åº“ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚ä¸å¿…ç­‰å¾…åŠæ—¶ç¼–è¯‘å™¨çš„é¢„çƒ­ï¼Œå‡å°‘Javaåº”ç”¨ç»™äººå¸¦æ¥â€œç¬¬ä¸€æ¬¡è¿è¡Œæ…¢â€ çš„ä¸è‰¯ä½“éªŒ</p><p>ç¼ºç‚¹ï¼š</p><ul><li>ç ´åäº† java  â€œ ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªä¸åŒçš„ç¡¬ä»¶ï¼ŒOSç¼–è¯‘å¯¹åº”çš„å‘è¡ŒåŒ…</li><li>é™ä½äº†Javaé“¾æ¥è¿‡ç¨‹çš„åŠ¨æ€æ€§ï¼ŒåŠ è½½çš„ä»£ç åœ¨ç¼–è¯‘å™¨å°±å¿…é¡»å…¨éƒ¨å·²çŸ¥ã€‚</li><li>è¿˜éœ€è¦ç»§ç»­ä¼˜åŒ–ä¸­ï¼Œæœ€åˆåªæ”¯æŒLinux X64 java base</li></ul><h3 id="5-16-å†™åˆ°æœ€å"><a href="#5-16-å†™åˆ°æœ€å" class="headerlink" title="5.16 å†™åˆ°æœ€å"></a>5.16 å†™åˆ°æœ€å</h3><ul><li>è‡ªJDK10èµ·ï¼ŒHotSpotåˆåŠ å…¥äº†ä¸€ä¸ªå…¨æ–°çš„åŠæ—¶ç¼–è¯‘å™¨ï¼šGraalç¼–è¯‘å™¨</li><li>ç¼–è¯‘æ•ˆæœçŸ­çŸ­å‡ å¹´æ—¶é—´å°±è¿½è¯„äº†G2ç¼–è¯‘å™¨ï¼Œæœªæ¥å¯æœŸ</li><li>ç›®å‰ï¼Œå¸¦ç€å®éªŒçŠ¶æ€æ ‡ç­¾ï¼Œéœ€è¦ä½¿ç”¨å¼€å…³å‚æ•°å»æ¿€æ´»æ‰èƒ½ä½¿ç”¨</li></ul><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UnlockExperimentalvMOptions -XX:+UseJVMCICompiler</span></code></pre></div><h1 id="ç¬¬13ç« -StringTable"><a href="#ç¬¬13ç« -StringTable" class="headerlink" title="ç¬¬13ç«  StringTable"></a>ç¬¬13ç«  StringTable</h1><h2 id="1-Stringçš„åŸºæœ¬ç‰¹æ€§"><a href="#1-Stringçš„åŸºæœ¬ç‰¹æ€§" class="headerlink" title="1 Stringçš„åŸºæœ¬ç‰¹æ€§"></a>1 Stringçš„åŸºæœ¬ç‰¹æ€§</h2><ul><li>Stringï¼šå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ä¸€å¯¹ â€â€ å¼•èµ·æ¥è¡¨ç¤º<ul><li>String s1 = â€œmogublogâ€ ;   // å­—é¢é‡çš„å®šä¹‰æ–¹å¼</li><li>String s2 =  new String(â€œmoxiâ€); </li></ul></li><li>stringå£°æ˜ä¸ºfinalçš„ï¼Œä¸å¯è¢«ç»§æ‰¿</li><li>Stringå®ç°äº†Serializableæ¥å£ï¼šè¡¨ç¤ºå­—ç¬¦ä¸²æ˜¯æ”¯æŒåºåˆ—åŒ–çš„ã€‚å®ç°äº†Comparableæ¥å£ï¼šè¡¨ç¤ºstringå¯ä»¥æ¯”è¾ƒå¤§å°</li><li>stringåœ¨jdk8åŠä»¥å‰å†…éƒ¨å®šä¹‰äº†final char[] valueç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ã€‚JDK9æ—¶æ”¹ä¸ºbyte[]</li></ul><h3 id="1-1-ä¸ºä»€ä¹ˆJDK9æ”¹å˜äº†ç»“æ„"><a href="#1-1-ä¸ºä»€ä¹ˆJDK9æ”¹å˜äº†ç»“æ„" class="headerlink" title="1.1 ä¸ºä»€ä¹ˆJDK9æ”¹å˜äº†ç»“æ„"></a>1.1 ä¸ºä»€ä¹ˆJDK9æ”¹å˜äº†ç»“æ„</h3><p>Stringç±»çš„å½“å‰å®ç°å°†å­—ç¬¦å­˜å‚¨åœ¨charæ•°ç»„ä¸­ï¼Œæ¯ä¸ªå­—ç¬¦ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚(16ä½)ã€‚ä»è®¸å¤šä¸åŒçš„åº”ç”¨ç¨‹åºæ”¶é›†çš„æ•°æ®è¡¨æ˜ï¼Œå­—ç¬¦ä¸²æ˜¯å †ä½¿ç”¨çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼Œè€Œä¸”ï¼Œå¤§å¤šæ•°å­—ç¬¦ä¸²å¯¹è±¡åªåŒ…å«æ‹‰ä¸å­—ç¬¦ã€‚è¿™äº›å­—ç¬¦åªéœ€è¦ä¸€ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œå› æ­¤è¿™äº›å­—ç¬¦ä¸²å¯¹è±¡çš„å†…éƒ¨charæ•°ç»„ä¸­æœ‰ä¸€åŠçš„ç©ºé—´å°†ä¸ä¼šä½¿ç”¨ã€‚</p><p>æˆ‘ä»¬å»ºè®®æ”¹å˜å­—ç¬¦ä¸²çš„å†…éƒ¨è¡¨ç¤ºclassä»utf - 16å­—ç¬¦æ•°ç»„åˆ°å­—èŠ‚æ•°ç»„+ä¸€ä¸ªencoding-flagå­—æ®µã€‚æ–°çš„Stringç±»å°†æ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹å­˜å‚¨ç¼–ç ä¸ºISO-8859-1/Latin-1(æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªå­—èŠ‚)æˆ–UTF-16(æ¯ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚)çš„å­—ç¬¦ã€‚ç¼–ç æ ‡å¿—å°†æŒ‡ç¤ºä½¿ç”¨å“ªç§ç¼–ç ã€‚</p><p>ç»“è®ºï¼šStringå†ä¹Ÿä¸ç”¨char[] æ¥å­˜å‚¨äº†ï¼Œæ”¹æˆäº†byte [] åŠ ä¸Šç¼–ç æ ‡è®°ï¼ŒèŠ‚çº¦äº†ä¸€äº›ç©ºé—´</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// ä¹‹å‰</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">char</span> value[];<span class="hljs-comment">// ä¹‹å</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] value</code></pre></div><p>åŒæ—¶åŸºäºStringçš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚StringBufferå’ŒStringBuilderä¹ŸåŒæ ·åšäº†ä¿®æ”¹</p><h3 id="1-2-Stringçš„ä¸å¯å˜æ€§"><a href="#1-2-Stringçš„ä¸å¯å˜æ€§" class="headerlink" title="1.2 Stringçš„ä¸å¯å˜æ€§"></a>1.2 Stringçš„ä¸å¯å˜æ€§</h3><p>Stringï¼šä»£è¡¨ä¸å¯å˜çš„å­—ç¬¦åºåˆ—ã€‚ç®€ç§°ï¼šä¸å¯å˜æ€§ã€‚</p><blockquote><p>å½“å¯¹å­—ç¬¦ä¸²é‡æ–°èµ‹å€¼æ—¶ï¼Œéœ€è¦é‡å†™æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚<br>å½“å¯¹ç°æœ‰çš„å­—ç¬¦ä¸²è¿›è¡Œè¿æ¥æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚<br>å½“è°ƒç”¨stringçš„replaceï¼ˆï¼‰æ–¹æ³•ä¿®æ”¹æŒ‡å®šå­—ç¬¦æˆ–å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚<br>é€šè¿‡å­—é¢é‡çš„æ–¹å¼ï¼ˆåŒºåˆ«äºnewï¼‰ç»™ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ï¼Œæ­¤æ—¶çš„å­—ç¬¦ä¸²å€¼å£°æ˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚</p></blockquote><p>ä»£ç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Stringçš„ä¸å¯å˜æ€§</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringTest1</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">// å­—é¢é‡å®šä¹‰çš„æ–¹å¼ï¼Œâ€œabcâ€å­˜å‚¨åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­</span>        String s1 = <span class="hljs-string">&quot;abc&quot;</span>;        String s2 = <span class="hljs-string">&quot;abc&quot;</span>;        System.out.println(s1 == s2);        s1 = <span class="hljs-string">&quot;hello&quot;</span>;        System.out.println(s1 == s2);        System.out.println(s1);        System.out.println(s2);        System.out.println(<span class="hljs-string">&quot;----------------&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span> </span>&#123;        String s1 = <span class="hljs-string">&quot;abc&quot;</span>;        String s2 = <span class="hljs-string">&quot;abc&quot;</span>;        <span class="hljs-comment">// åªè¦è¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸å¯å˜æ€§</span>        s2 += <span class="hljs-string">&quot;def&quot;</span>;        System.out.println(s1);        System.out.println(s2);        System.out.println(<span class="hljs-string">&quot;----------------&quot;</span>);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span> </span>&#123;        String s1 = <span class="hljs-string">&quot;abc&quot;</span>;        String s2 = s1.replace(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;m&#x27;</span>);        System.out.println(s1);        System.out.println(s2);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        test1();        test2();        test3();    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs asciidoc">truefalsehelloabc----------------abcabcdef----------------abcmbc</code></pre></div><h3 id="1-3-é¢è¯•é¢˜"><a href="#1-3-é¢è¯•é¢˜" class="headerlink" title="1.3 é¢è¯•é¢˜"></a>1.3 é¢è¯•é¢˜</h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * é¢è¯•é¢˜</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringExer</span> </span>&#123;    String str = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;good&quot;</span>);    <span class="hljs-keyword">char</span> [] ch = &#123;<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>&#125;;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">change</span><span class="hljs-params">(String str, <span class="hljs-keyword">char</span> ch [])</span> </span>&#123;        str = <span class="hljs-string">&quot;test ok&quot;</span>;        ch[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;b&#x27;</span>;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        StringExer ex = <span class="hljs-keyword">new</span> StringExer();        ex.change(ex.str, ex.ch);        System.out.println(ex.str);        System.out.println(ex.ch);    &#125;&#125;</code></pre></div><p>è¾“å‡ºç»“æœ</p><div class="code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">good</span><span class="hljs-attribute">best</span></code></pre></div><h3 id="1-4-æ³¨æ„"><a href="#1-4-æ³¨æ„" class="headerlink" title="1.4 æ³¨æ„"></a>1.4 æ³¨æ„</h3><p><strong>å­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯ä¸ä¼šå­˜å‚¨ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²çš„</strong></p><p>Stringçš„string Poolæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„Hashtableï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯1009ã€‚å¦‚æœæ”¾è¿›string Poolçš„stringéå¸¸å¤šï¼Œå°±ä¼šé€ æˆHashå†²çªä¸¥é‡ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨ä¼šå¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†åç›´æ¥ä¼šé€ æˆçš„å½±å“å°±æ˜¯å½“è°ƒç”¨string.internæ—¶æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ã€‚</p><p>ä½¿ç”¨-XX:StringTablesizeå¯è®¾ç½®stringTab1eçš„é•¿åº¦</p><p>åœ¨jdk6ä¸­stringTableæ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯1009çš„é•¿åº¦ï¼Œæ‰€ä»¥å¦‚æœå¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿«ã€‚stringTablesizeè®¾ç½®æ²¡æœ‰è¦æ±‚</p><p>åœ¨jdk7ä¸­ï¼ŒstringTableçš„é•¿åº¦é»˜è®¤å€¼æ˜¯60013ï¼Œ</p><p>åœ¨JDK8ä¸­ï¼ŒStringTableå¯ä»¥è®¾ç½®çš„æœ€å°å€¼ä¸º1009</p><h2 id="2-Stringçš„å†…å­˜åˆ†é…"><a href="#2-Stringçš„å†…å­˜åˆ†é…" class="headerlink" title="2 Stringçš„å†…å­˜åˆ†é…"></a>2 Stringçš„å†…å­˜åˆ†é…</h2><p>åœ¨Javaè¯­è¨€ä¸­æœ‰8ç§åŸºæœ¬æ•°æ®ç±»å‹å’Œä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹Stringã€‚è¿™äº›ç±»å‹ä¸ºäº†ä½¿å®ƒä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€Ÿåº¦æ›´å¿«ã€æ›´èŠ‚çœå†…å­˜ï¼Œéƒ½æä¾›äº†ä¸€ç§å¸¸é‡æ± çš„æ¦‚å¿µã€‚</p><p>å¸¸é‡æ± å°±ç±»ä¼¼ä¸€ä¸ªJavaç³»ç»Ÿçº§åˆ«æä¾›çš„ç¼“å­˜ã€‚8ç§åŸºæœ¬æ•°æ®ç±»å‹çš„å¸¸é‡æ± éƒ½æ˜¯ç³»ç»Ÿåè°ƒçš„ï¼ŒStringç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ã€‚</p><p>ç›´æ¥ä½¿ç”¨åŒå¼•å·å£°æ˜å‡ºæ¥çš„Stringå¯¹è±¡ä¼šç›´æ¥å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­ã€‚</p><ul><li>æ¯”å¦‚ï¼šString info=â€atguigu.comâ€ï¼›</li></ul><p>å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„Stringå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Stringæä¾›çš„internï¼ˆï¼‰æ–¹æ³•ã€‚</p><p>Java 6åŠä»¥å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ°¸ä¹…ä»£</p><p>Java 7ä¸­ oracleçš„å·¥ç¨‹å¸ˆå¯¹å­—ç¬¦ä¸²æ± çš„é€»è¾‘åšäº†å¾ˆå¤§çš„æ”¹å˜ï¼Œå³å°†å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½ç½®è°ƒæ•´åˆ°Javaå †å†…</p><blockquote><p>æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½ä¿å­˜åœ¨å †ï¼ˆHeapï¼‰ä¸­ï¼Œå’Œå…¶ä»–æ™®é€šå¯¹è±¡ä¸€æ ·ï¼Œè¿™æ ·å¯ä»¥è®©ä½ åœ¨è¿›è¡Œè°ƒä¼˜åº”ç”¨æ—¶ä»…éœ€è¦è°ƒæ•´å †å¤§å°å°±å¯ä»¥äº†ã€‚</p><p>å­—ç¬¦ä¸²å¸¸é‡æ± æ¦‚å¿µåŸæœ¬ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ä¸ªæ”¹åŠ¨ä½¿å¾—æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ç†ç”±è®©æˆ‘ä»¬é‡æ–°è€ƒè™‘åœ¨Java 7ä¸­ä½¿ç”¨string.internï¼ˆï¼‰ã€‚</p></blockquote><p>Java8å…ƒç©ºé—´ï¼Œå­—ç¬¦ä¸²å¸¸é‡åœ¨å †</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711093546398.png" alt="image-20200711093546398"></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711093558709.png" alt="image-20200711093558709"></p><h3 id="2-1-ä¸ºä»€ä¹ˆStringTableä»æ°¸ä¹…ä»£è°ƒæ•´åˆ°å †ä¸­"><a href="#2-1-ä¸ºä»€ä¹ˆStringTableä»æ°¸ä¹…ä»£è°ƒæ•´åˆ°å †ä¸­" class="headerlink" title="2.1 ä¸ºä»€ä¹ˆStringTableä»æ°¸ä¹…ä»£è°ƒæ•´åˆ°å †ä¸­"></a>2.1 ä¸ºä»€ä¹ˆStringTableä»æ°¸ä¹…ä»£è°ƒæ•´åˆ°å †ä¸­</h3><p>åœ¨JDK 7ä¸­ï¼Œinternedå­—ç¬¦ä¸²ä¸å†åœ¨Javaå †çš„æ°¸ä¹…ç”Ÿæˆä¸­åˆ†é…ï¼Œè€Œæ˜¯åœ¨Javaå †çš„ä¸»è¦éƒ¨åˆ†(ç§°ä¸ºå¹´è½»ä»£å’Œå¹´è€ä»£)ä¸­åˆ†é…ï¼Œä¸åº”ç”¨ç¨‹åºåˆ›å»ºçš„å…¶ä»–å¯¹è±¡ä¸€èµ·åˆ†é…ã€‚æ­¤æ›´æ”¹å°†å¯¼è‡´é©»ç•™åœ¨ä¸»Javaå †ä¸­çš„æ•°æ®æ›´å¤šï¼Œé©»ç•™åœ¨æ°¸ä¹…ç”Ÿæˆä¸­çš„æ•°æ®æ›´å°‘ï¼Œå› æ­¤å¯èƒ½éœ€è¦è°ƒæ•´å †å¤§å°ã€‚ç”±äºè¿™ä¸€å˜åŒ–ï¼Œå¤§å¤šæ•°åº”ç”¨ç¨‹åºåœ¨å †ä½¿ç”¨æ–¹é¢åªä¼šçœ‹åˆ°ç›¸å¯¹è¾ƒå°çš„å·®å¼‚ï¼Œä½†åŠ è½½è®¸å¤šç±»æˆ–å¤§é‡ä½¿ç”¨å­—ç¬¦ä¸²çš„è¾ƒå¤§åº”ç”¨ç¨‹åºä¼šå‡ºç°è¿™ç§å·®å¼‚ã€‚intern()æ–¹æ³•ä¼šçœ‹åˆ°æ›´æ˜¾è‘—çš„å·®å¼‚ã€‚</p><ul><li>æ°¸ä¹…ä»£çš„é»˜è®¤æ¯”è¾ƒå°</li><li>æ°¸ä¹…ä»£åƒåœ¾å›æ”¶é¢‘ç‡ä½</li></ul><h2 id="3-Stringçš„åŸºæœ¬æ“ä½œ"><a href="#3-Stringçš„åŸºæœ¬æ“ä½œ" class="headerlink" title="3 Stringçš„åŸºæœ¬æ“ä½œ"></a>3 Stringçš„åŸºæœ¬æ“ä½œ</h2><p>Javaè¯­è¨€è§„èŒƒé‡Œè¦æ±‚å®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²å­—é¢é‡ï¼Œåº”è¯¥åŒ…å«åŒæ ·çš„Unicodeå­—ç¬¦åºåˆ—ï¼ˆåŒ…å«åŒä¸€ä»½ç ç‚¹åºåˆ—çš„å¸¸é‡ï¼‰ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æŒ‡å‘åŒä¸€ä¸ªStringç±»å®ä¾‹ã€‚</p><h2 id="4-å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ"><a href="#4-å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ" class="headerlink" title="4 å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ"></a>4 å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ</h2><ul><li>å¸¸é‡ä¸å¸¸é‡çš„æ‹¼æ¥ç»“æœåœ¨å¸¸é‡æ± ï¼ŒåŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–</li><li>å¸¸é‡æ± ä¸­ä¸ä¼šå­˜åœ¨ç›¸åŒå†…å®¹çš„å˜é‡</li><li>åªè¦å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å˜é‡ï¼Œç»“æœå°±åœ¨å †ä¸­ã€‚å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯StringBuilder</li><li>å¦‚æœæ‹¼æ¥çš„ç»“æœè°ƒç”¨intern()æ–¹æ³•ï¼Œåˆ™ä¸»åŠ¨å°†å¸¸é‡æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥æ± ä¸­ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡åœ°å€</li></ul><div class="code-wrapper"><pre><code class="hljs java">   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> </span>&#123;       String s1 = <span class="hljs-string">&quot;a&quot;</span> + <span class="hljs-string">&quot;b&quot;</span> + <span class="hljs-string">&quot;c&quot;</span>;  <span class="hljs-comment">// å¾—åˆ° abcçš„å¸¸é‡æ± </span>       String s2 = <span class="hljs-string">&quot;abc&quot;</span>; <span class="hljs-comment">// abcå­˜æ”¾åœ¨å¸¸é‡æ± ï¼Œç›´æ¥å°†å¸¸é‡æ± çš„åœ°å€è¿”å›</span>       <span class="hljs-comment">/**</span><span class="hljs-comment">        * æœ€ç»ˆjavaç¼–è¯‘æˆ.classï¼Œå†æ‰§è¡Œ.class</span><span class="hljs-comment">        */</span>       System.out.println(s1 == s2); <span class="hljs-comment">// trueï¼Œå› ä¸ºå­˜æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± </span>       System.out.println(s1.equals(s2)); <span class="hljs-comment">// true</span>   &#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span> </span>&#123;       String s1 = <span class="hljs-string">&quot;javaEE&quot;</span>;       String s2 = <span class="hljs-string">&quot;hadoop&quot;</span>;       String s3 = <span class="hljs-string">&quot;javaEEhadoop&quot;</span>;       String s4 = <span class="hljs-string">&quot;javaEE&quot;</span> + <span class="hljs-string">&quot;hadoop&quot;</span>;           String s5 = s1 + <span class="hljs-string">&quot;hadoop&quot;</span>;       String s6 = <span class="hljs-string">&quot;javaEE&quot;</span> + s2;       String s7 = s1 + s2;       System.out.println(s3 == s4); <span class="hljs-comment">// true</span>       System.out.println(s3 == s5); <span class="hljs-comment">// false</span>       System.out.println(s3 == s6); <span class="hljs-comment">// false</span>       System.out.println(s3 == s7); <span class="hljs-comment">// false</span>       System.out.println(s5 == s6); <span class="hljs-comment">// false</span>       System.out.println(s5 == s7); <span class="hljs-comment">// false</span>       System.out.println(s6 == s7); <span class="hljs-comment">// false</span>       String s8 = s6.intern();       System.out.println(s3 == s8); <span class="hljs-comment">// true</span>   &#125;</code></pre></div><p>ä»ä¸Šè¿°çš„ç»“æœæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><p>å¦‚æœæ‹¼æ¥ç¬¦å·çš„å‰åå‡ºç°äº†å˜é‡ï¼Œåˆ™ç›¸å½“äºåœ¨å †ç©ºé—´ä¸­new String()ï¼Œå…·ä½“çš„å†…å®¹ä¸ºæ‹¼æ¥çš„ç»“æœ</p><p>è€Œè°ƒç”¨internæ–¹æ³•ï¼Œåˆ™ä¼šåˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨JavaEEhadoopå€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å¸¸é‡æ± ä¸­çš„å€¼ï¼Œå¦è€…å°±åœ¨å¸¸é‡æ± ä¸­åˆ›å»º</p><h3 id="åº•å±‚åŸç†"><a href="#åº•å±‚åŸç†" class="headerlink" title="åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h3><p>æ‹¼æ¥æ“ä½œçš„åº•å±‚å…¶å®ä½¿ç”¨äº†StringBuilder</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711102231129.png" alt="image-20200711102231129"></p><p>s1 + s2çš„æ‰§è¡Œç»†èŠ‚</p><ul><li>StringBuilder s = new StringBuilder();</li><li>s.append(s1);</li><li>s.append(s2);</li><li>s.toString();  -&gt; ç±»ä¼¼äºnew String(â€œabâ€);</li></ul><p>åœ¨JDK5ä¹‹åï¼Œä½¿ç”¨çš„æ˜¯StringBuilderï¼Œåœ¨JDK5ä¹‹å‰ä½¿ç”¨çš„æ˜¯StringBuffer</p><table><thead><tr><th>String</th><th>StringBuffer</th><th>StringBuilder</th></tr></thead><tbody><tr><td>Stringçš„å€¼æ˜¯ä¸å¯å˜çš„ï¼Œè¿™å°±å¯¼è‡´æ¯æ¬¡å¯¹Stringçš„æ“ä½œéƒ½ä¼šç”Ÿæˆæ–°çš„Stringå¯¹è±¡ï¼Œä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”æµªè´¹å¤§é‡ä¼˜å…ˆçš„å†…å­˜ç©ºé—´</td><td>StringBufferæ˜¯å¯å˜ç±»ï¼Œå’Œçº¿ç¨‹å®‰å…¨çš„å­—ç¬¦ä¸²æ“ä½œç±»ï¼Œä»»ä½•å¯¹å®ƒæŒ‡å‘çš„å­—ç¬¦ä¸²çš„æ“ä½œéƒ½ä¸ä¼šäº§ç”Ÿæ–°çš„å¯¹è±¡ã€‚æ¯ä¸ªStringBufferå¯¹è±¡éƒ½æœ‰ä¸€å®šçš„ç¼“å†²åŒºå®¹é‡ï¼Œå½“å­—ç¬¦ä¸²å¤§å°æ²¡æœ‰è¶…è¿‡å®¹é‡æ—¶ï¼Œä¸ä¼šåˆ†é…æ–°çš„å®¹é‡ï¼Œå½“å­—ç¬¦ä¸²å¤§å°è¶…è¿‡å®¹é‡æ—¶ï¼Œä¼šè‡ªåŠ¨å¢åŠ å®¹é‡</td><td>å¯å˜ç±»ï¼Œé€Ÿåº¦æ›´å¿«</td></tr><tr><td>ä¸å¯å˜</td><td>å¯å˜</td><td>å¯å˜</td></tr><tr><td></td><td>çº¿ç¨‹å®‰å…¨</td><td>çº¿ç¨‹ä¸å®‰å…¨</td></tr><tr><td></td><td>å¤šçº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²</td><td>å•çº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²</td></tr></tbody></table><p>æ³¨æ„ï¼Œæˆ‘ä»¬å·¦å³ä¸¤è¾¹å¦‚æœæ˜¯å˜é‡çš„è¯ï¼Œå°±æ˜¯éœ€è¦new StringBuilderè¿›è¡Œæ‹¼æ¥ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨çš„æ˜¯finalä¿®é¥°ï¼Œåˆ™æ˜¯ä»å¸¸é‡æ± ä¸­è·å–ã€‚æ‰€ä»¥è¯´æ‹¼æ¥ç¬¦å·å·¦å³ä¸¤è¾¹éƒ½æ˜¯å­—ç¬¦ä¸²å¸¸é‡æˆ–å¸¸é‡å¼•ç”¨ åˆ™ä»ç„¶ä½¿ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´è¢«finalä¿®é¥°çš„å˜é‡ï¼Œå°†ä¼šå˜æˆå¸¸é‡ï¼Œç±»å’Œæ–¹æ³•å°†ä¸èƒ½è¢«ç»§æ‰¿ã€</p><ul><li>åœ¨å¼€å‘ä¸­ï¼Œèƒ½å¤Ÿä½¿ç”¨finalçš„æ—¶å€™ï¼Œå»ºè®®ä½¿ç”¨ä¸Š</li></ul><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">final</span> String s1 = <span class="hljs-string">&quot;a&quot;</span>;    <span class="hljs-keyword">final</span> String s2 = <span class="hljs-string">&quot;b&quot;</span>;    String s3 = <span class="hljs-string">&quot;ab&quot;</span>;    String s4 = s1 + s2;    System.out.println(s3 == s4);&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs actionscript"><span class="hljs-literal">true</span></code></pre></div><h3 id="æ‹¼æ¥æ“ä½œå’Œappendæ€§èƒ½å¯¹æ¯”"><a href="#æ‹¼æ¥æ“ä½œå’Œappendæ€§èƒ½å¯¹æ¯”" class="headerlink" title="æ‹¼æ¥æ“ä½œå’Œappendæ€§èƒ½å¯¹æ¯”"></a>æ‹¼æ¥æ“ä½œå’Œappendæ€§èƒ½å¯¹æ¯”</h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> highLevel)</span> </span>&#123;    String src = <span class="hljs-string">&quot;&quot;</span>;    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; highLevel; i++) &#123;        src += <span class="hljs-string">&quot;a&quot;</span>; <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ªStringBuilderå¯¹è±¡</span>    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> highLevel)</span> </span>&#123;    StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; highLevel; i++) &#123;        sb.append(<span class="hljs-string">&quot;a&quot;</span>);    &#125;&#125;</code></pre></div><p>æ–¹æ³•1è€—è´¹çš„æ—¶é—´ï¼š4005msï¼Œæ–¹æ³•2æ¶ˆè€—æ—¶é—´ï¼š7ms</p><p>ç»“è®ºï¼š</p><ul><li>é€šè¿‡StringBuilderçš„append()æ–¹å¼æ·»åŠ å­—ç¬¦ä¸²çš„æ•ˆç‡ï¼Œè¦è¿œè¿œé«˜äºStringçš„å­—ç¬¦ä¸²æ‹¼æ¥æ–¹æ³•</li></ul><p>å¥½å¤„</p><ul><li>StringBuilderçš„appendçš„æ–¹å¼ï¼Œè‡ªå§‹è‡³ç»ˆåªåˆ›å»ºä¸€ä¸ªStringBuilderçš„å¯¹è±¡</li><li>å¯¹äºå­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œè¿˜éœ€è¦åˆ›å»ºå¾ˆå¤šStringBuilderå¯¹è±¡å’Œ è°ƒç”¨toStringæ—¶å€™åˆ›å»ºçš„Stringå¯¹è±¡</li><li>å†…å­˜ä¸­ç”±äºåˆ›å»ºäº†è¾ƒå¤šçš„StringBuilderå’ŒStringå¯¹è±¡ï¼Œå†…å­˜å ç”¨è¿‡å¤§ï¼Œå¦‚æœè¿›è¡ŒGCé‚£ä¹ˆå°†ä¼šè€—è´¹æ›´å¤šçš„æ—¶é—´</li></ul><p>æ”¹è¿›çš„ç©ºé—´</p><ul><li>æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯StringBuilderçš„ç©ºå‚æ„é€ å™¨ï¼Œé»˜è®¤çš„å­—ç¬¦ä¸²å®¹é‡æ˜¯16ï¼Œç„¶åå°†åŸæ¥çš„å­—ç¬¦ä¸²æ‹·è´åˆ°æ–°çš„å­—ç¬¦ä¸²ä¸­ï¼Œ æˆ‘ä»¬ä¹Ÿå¯ä»¥é»˜è®¤åˆå§‹åŒ–æ›´å¤§çš„é•¿åº¦ï¼Œå‡å°‘æ‰©å®¹çš„æ¬¡æ•°</li><li>å› æ­¤åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®å®šï¼Œå‰å‰ååéœ€è¦æ·»åŠ çš„å­—ç¬¦ä¸²ä¸é«˜äºæŸä¸ªé™å®šå€¼ï¼Œé‚£ä¹ˆå»ºè®®ä½¿ç”¨æ„é€ å™¨åˆ›å»ºä¸€ä¸ªé˜ˆå€¼çš„é•¿åº¦</li></ul><h2 id="5-intern-çš„ä½¿ç”¨"><a href="#5-intern-çš„ä½¿ç”¨" class="headerlink" title="5 intern()çš„ä½¿ç”¨"></a>5 intern()çš„ä½¿ç”¨</h2><p>internæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯åº•å±‚Cçš„æ–¹æ³•</p><p>å­—ç¬¦ä¸²æ± æœ€åˆæ˜¯ç©ºçš„ï¼Œç”±Stringç±»ç§æœ‰åœ°ç»´æŠ¤ã€‚åœ¨è°ƒç”¨internæ–¹æ³•æ—¶ï¼Œå¦‚æœæ± ä¸­å·²ç»åŒ…å«äº†ç”±equals(object)æ–¹æ³•ç¡®å®šçš„ä¸è¯¥å­—ç¬¦ä¸²å¯¹è±¡ç›¸ç­‰çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œè¯¥å­—ç¬¦ä¸²å¯¹è±¡å°†è¢«æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶è¿”å›å¯¹è¯¥å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p>å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„Stringå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Stringæä¾›çš„internæ–¹æ³•ï¼šinternæ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥è¯¢å½“å‰å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­ã€‚</p><p>æ¯”å¦‚ï¼š</p><div class="code-wrapper"><pre><code class="hljs arduino"><span class="hljs-keyword">String</span> myInfo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;I love atguigu&quot;</span>).<span class="hljs-built_in">intern</span>();</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåœ¨ä»»æ„å­—ç¬¦ä¸²ä¸Šè°ƒç”¨String.internæ–¹æ³•ï¼Œé‚£ä¹ˆå…¶è¿”å›ç»“æœæ‰€æŒ‡å‘çš„é‚£ä¸ªç±»å®ä¾‹ï¼Œå¿…é¡»å’Œç›´æ¥ä»¥å¸¸é‡å½¢å¼å‡ºç°çš„å­—ç¬¦ä¸²å®ä¾‹å®Œå…¨ç›¸åŒã€‚å› æ­¤ï¼Œä¸‹åˆ—è¡¨è¾¾å¼çš„å€¼å¿…å®šæ˜¯true</p><div class="code-wrapper"><pre><code class="hljs java">ï¼ˆ<span class="hljs-string">&quot;a&quot;</span>+<span class="hljs-string">&quot;b&quot;</span>+<span class="hljs-string">&quot;c&quot;</span>ï¼‰.internï¼ˆï¼‰==<span class="hljs-string">&quot;abc&quot;</span></code></pre></div><p>é€šä¿—ç‚¹è®²ï¼ŒInterned stringå°±æ˜¯ç¡®ä¿å­—ç¬¦ä¸²åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä»½æ‹·è´ï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦å†…å­˜ç©ºé—´ï¼ŒåŠ å¿«å­—ç¬¦ä¸²æ“ä½œä»»åŠ¡çš„æ‰§è¡Œé€Ÿåº¦ã€‚æ³¨æ„ï¼Œè¿™ä¸ªå€¼ä¼šè¢«å­˜æ”¾åœ¨å­—ç¬¦ä¸²å†…éƒ¨æ± ï¼ˆString Intern Poolï¼‰</p><h3 id="internçš„ç©ºé—´æ•ˆç‡æµ‹è¯•"><a href="#internçš„ç©ºé—´æ•ˆç‡æµ‹è¯•" class="headerlink" title="internçš„ç©ºé—´æ•ˆç‡æµ‹è¯•"></a>internçš„ç©ºé—´æ•ˆç‡æµ‹è¯•</h3><p>æˆ‘ä»¬é€šè¿‡æµ‹è¯•ä¸€ä¸‹ï¼Œä½¿ç”¨äº†internå’Œä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œå…¶å®ç›¸å·®è¿˜æŒºå¤šçš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ä½¿ç”¨Intern() æµ‹è¯•æ‰§è¡Œæ•ˆç‡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringIntern2</span> </span>&#123;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAX_COUNT = <span class="hljs-number">1000</span> * <span class="hljs-number">10000</span>;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] arr = <span class="hljs-keyword">new</span> String[MAX_COUNT];    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Integer [] data = <span class="hljs-keyword">new</span> Integer[]&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>&#125;;        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_COUNT; i++) &#123;            arr[i] = <span class="hljs-keyword">new</span> String(String.valueOf(data[i%data.length])).intern();        &#125;        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();        System.out.println(<span class="hljs-string">&quot;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š&quot;</span> + (end - start));        <span class="hljs-keyword">try</span> &#123;            Thread.sleep(<span class="hljs-number">1000000</span>);        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.getStackTrace();        &#125;    &#125;&#125;</code></pre></div><p><strong>ç»“è®º</strong>ï¼šå¯¹äºç¨‹åºä¸­å¤§é‡ä½¿ç”¨å­˜åœ¨çš„å­—ç¬¦ä¸²æ—¶ï¼Œå°¤å…¶å­˜åœ¨å¾ˆå¤šå·²ç»é‡å¤çš„å­—ç¬¦ä¸²æ—¶ï¼Œä½¿ç”¨intern()æ–¹æ³•èƒ½å¤ŸèŠ‚çœå†…å­˜ç©ºé—´ã€‚</p><p>å¤§çš„ç½‘ç«™å¹³å°ï¼Œéœ€è¦å†…å­˜ä¸­å­˜å‚¨å¤§é‡çš„å­—ç¬¦ä¸²ã€‚æ¯”å¦‚ç¤¾äº¤ç½‘ç«™ï¼Œå¾ˆå¤šäººéƒ½å­˜å‚¨ï¼šåŒ—äº¬å¸‚ã€æµ·æ·€åŒºç­‰ä¿¡æ¯ã€‚è¿™æ—¶å€™å¦‚æœå­—ç¬¦ä¸²éƒ½è°ƒç”¨intern() æ–¹æ³•ï¼Œå°±ä¼šå¾ˆæ˜æ˜¾é™ä½å†…å­˜çš„å¤§å°ã€‚</p><h2 id="6-é¢è¯•é¢˜"><a href="#6-é¢è¯•é¢˜" class="headerlink" title="6 é¢è¯•é¢˜"></a>6 é¢è¯•é¢˜</h2><h3 id="6-1-new-String-â€œabâ€-ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡"><a href="#6-1-new-String-â€œabâ€-ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡" class="headerlink" title="6.1 new String(â€œabâ€)ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡"></a>6.1 new String(â€œabâ€)ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡</h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * new String(&quot;ab&quot;) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ çœ‹å­—èŠ‚ç å°±çŸ¥é“æ˜¯2ä¸ªå¯¹è±¡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringNewTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        String str = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;ab&quot;</span>);    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬è½¬æ¢æˆå­—èŠ‚ç æ¥æŸ¥çœ‹</p><div class="code-wrapper"><pre><code class="hljs tap"><span class="hljs-number"> 0 </span>new <span class="hljs-comment">#2 &lt;java/lang/String&gt;</span><span class="hljs-number"> 3 </span>dup<span class="hljs-number"> 4 </span>ldc <span class="hljs-comment">#3 &lt;ab&gt;</span><span class="hljs-number"> 6 </span>invokespecial <span class="hljs-comment">#4 &lt;java/lang/String.&lt;init&gt;&gt;</span><span class="hljs-number"> 9 </span>astore_110 return</code></pre></div><p>è¿™é‡Œé¢å°±æ˜¯ä¸¤ä¸ªå¯¹è±¡</p><ul><li>ä¸€ä¸ªå¯¹è±¡æ˜¯ï¼šnewå…³é”®å­—åœ¨å †ç©ºé—´ä¸­åˆ›å»º</li><li>å¦ä¸€ä¸ªå¯¹è±¡ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡</li></ul><h3 id="6-2-new-String-â€œaâ€-new-String-â€œbâ€-ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡"><a href="#6-2-new-String-â€œaâ€-new-String-â€œbâ€-ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡" class="headerlink" title="6.2 new String(â€œaâ€) + new String(â€œbâ€) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡"></a>6.2 new String(â€œaâ€) + new String(â€œbâ€) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡</h3><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * new String(&quot;ab&quot;) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ çœ‹å­—èŠ‚ç å°±çŸ¥é“æ˜¯2ä¸ªå¯¹è±¡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringNewTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        String str = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;a&quot;</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;b&quot;</span>);    &#125;&#125;</code></pre></div><p>å­—èŠ‚ç æ–‡ä»¶ä¸º</p><div class="code-wrapper"><pre><code class="hljs gradle"> <span class="hljs-number">0</span> <span class="hljs-keyword">new</span> #<span class="hljs-number">2</span> &lt;java<span class="hljs-regexp">/lang/</span>StringBuilder&gt; <span class="hljs-number">3</span> dup <span class="hljs-number">4</span> invokespecial #<span class="hljs-number">3</span> &lt;java<span class="hljs-regexp">/lang/</span>StringBuilder.&lt;init&gt;&gt; <span class="hljs-number">7</span> <span class="hljs-keyword">new</span> #<span class="hljs-number">4</span> &lt;java<span class="hljs-regexp">/lang/</span>String&gt;<span class="hljs-number">10</span> dup<span class="hljs-number">11</span> ldc #<span class="hljs-number">5</span> &lt;a&gt;<span class="hljs-number">13</span> invokespecial #<span class="hljs-number">6</span> &lt;java<span class="hljs-regexp">/lang/</span>String.&lt;init&gt;&gt;<span class="hljs-number">16</span> invokevirtual #<span class="hljs-number">7</span> &lt;java<span class="hljs-regexp">/lang/</span>StringBuilder.<span class="hljs-keyword">append</span>&gt;<span class="hljs-number">19</span> <span class="hljs-keyword">new</span> #<span class="hljs-number">4</span> &lt;java<span class="hljs-regexp">/lang/</span>String&gt;<span class="hljs-number">22</span> dup<span class="hljs-number">23</span> ldc #<span class="hljs-number">8</span> &lt;b&gt;<span class="hljs-number">25</span> invokespecial #<span class="hljs-number">6</span> &lt;java<span class="hljs-regexp">/lang/</span>String.&lt;init&gt;&gt;<span class="hljs-number">28</span> invokevirtual #<span class="hljs-number">7</span> &lt;java<span class="hljs-regexp">/lang/</span>StringBuilder.<span class="hljs-keyword">append</span>&gt;<span class="hljs-number">31</span> invokevirtual #<span class="hljs-number">9</span> &lt;java<span class="hljs-regexp">/lang/</span>StringBuilder.toString&gt;<span class="hljs-number">34</span> astore_1<span class="hljs-number">35</span> <span class="hljs-keyword">return</span></code></pre></div><p>æˆ‘ä»¬åˆ›å»ºäº†6ä¸ªå¯¹è±¡</p><ul><li>å¯¹è±¡1ï¼šnew StringBuilder()</li><li>å¯¹è±¡2ï¼šnew String(â€œaâ€)</li><li>å¯¹è±¡3ï¼šå¸¸é‡æ± çš„ a</li><li>å¯¹è±¡4ï¼šnew String(â€œbâ€)</li><li>å¯¹è±¡5ï¼šå¸¸é‡æ± çš„ b</li><li>å¯¹è±¡6ï¼štoStringä¸­ä¼šåˆ›å»ºä¸€ä¸ª new String(â€œabâ€)<ul><li>è°ƒç”¨toStringæ–¹æ³•ï¼Œä¸ä¼šåœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆab</li></ul></li></ul><h3 id="6-3-internçš„ä½¿ç”¨ï¼šJDK6å’ŒJDK7"><a href="#6-3-internçš„ä½¿ç”¨ï¼šJDK6å’ŒJDK7" class="headerlink" title="6.3 internçš„ä½¿ç”¨ï¼šJDK6å’ŒJDK7"></a>6.3 internçš„ä½¿ç”¨ï¼šJDK6å’ŒJDK7</h3><h4 id="JDK6ä¸­"><a href="#JDK6ä¸­" class="headerlink" title="JDK6ä¸­"></a>JDK6ä¸­</h4><div class="code-wrapper"><pre><code class="hljs java">String s = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>);  <span class="hljs-comment">// åœ¨å¸¸é‡æ± ä¸­å·²ç»æœ‰äº†</span>s.intern(); <span class="hljs-comment">// å°†è¯¥å¯¹è±¡æ”¾å…¥åˆ°å¸¸é‡æ± ã€‚ä½†æ˜¯è°ƒç”¨æ­¤æ–¹æ³•æ²¡æœ‰å¤ªå¤šçš„åŒºåˆ«ï¼Œå› ä¸ºå·²ç»å­˜åœ¨äº†1</span>String s2 = <span class="hljs-string">&quot;1&quot;</span>;System.out.println(s == s2); <span class="hljs-comment">// false</span>String s3 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>);s3.intern();String s4 = <span class="hljs-string">&quot;11&quot;</span>;System.out.println(s3 == s4); <span class="hljs-comment">// true</span></code></pre></div><p>è¾“å‡ºç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">false</span><span class="hljs-keyword">true</span></code></pre></div><p>ä¸ºä»€ä¹ˆå¯¹è±¡ä¼šä¸ä¸€æ ·å‘¢ï¼Ÿ</p><ul><li>ä¸€ä¸ªæ˜¯newåˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å¸¸é‡æ± ä¸­çš„å¯¹è±¡ï¼Œæ˜¾ç„¶ä¸æ˜¯åŒä¸€ä¸ª</li></ul><p>å¦‚æœæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼Œé‚£ä¹ˆå°±æ˜¯true</p><div class="code-wrapper"><pre><code class="hljs java">String s = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>);s = s.intern();String s2 = <span class="hljs-string">&quot;1&quot;</span>;System.out.println(s == s2); <span class="hljs-comment">// true</span></code></pre></div><p>è€Œå¯¹äºä¸‹é¢çš„æ¥è¯´ï¼Œå› ä¸º s3å˜é‡è®°å½•çš„åœ°å€æ˜¯  new String(â€œ11â€)ï¼Œç„¶åè¿™æ®µä»£ç æ‰§è¡Œå®Œä»¥åï¼Œå¸¸é‡æ± ä¸­ä¸å­˜åœ¨ â€œ11â€ï¼Œè¿™æ˜¯JDK6çš„å…³ç³»ï¼Œç„¶åæ‰§è¡Œ s3.intern()åï¼Œå°±ä¼šåœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆ â€œ11â€ï¼Œæœ€å s4ç”¨çš„å°±æ˜¯s3çš„åœ°å€</p><blockquote><p>ä¸ºä»€ä¹ˆæœ€åè¾“å‡ºçš„ s3 == s4  ä¼šä¸ºfalseå‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºåœ¨JDK6ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ â€œ11â€ï¼Œä¹Ÿå°±æ˜¯æœ‰äº†æ–°çš„åœ°å€ï¼Œ s2 = æ–°åœ°å€</p><p>è€Œåœ¨JDK7ä¸­ï¼Œåœ¨JDK7ä¸­ï¼Œå¹¶æ²¡æœ‰åˆ›æ–°ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œæ˜¯æŒ‡å‘å¸¸é‡æ± ä¸­çš„æ–°å¯¹è±¡</p></blockquote><h4 id="JDK7ä¸­"><a href="#JDK7ä¸­" class="headerlink" title="JDK7ä¸­"></a>JDK7ä¸­</h4><div class="code-wrapper"><pre><code class="hljs java">String s = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>);s.intern();String s2 = <span class="hljs-string">&quot;1&quot;</span>;System.out.println(s == s2); <span class="hljs-comment">// true</span>String s3 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>);s3.intern();String s4 = <span class="hljs-string">&quot;11&quot;</span>;System.out.println(s3 == s4); <span class="hljs-comment">// true</span></code></pre></div><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711145925091.png" alt="image-20200711145925091"></p><h3 id="6-4-æ‰©å±•"><a href="#6-4-æ‰©å±•" class="headerlink" title="6.4 æ‰©å±•"></a>6.4 æ‰©å±•</h3><div class="code-wrapper"><pre><code class="hljs java">String s3 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;1&quot;</span>);String s4 = <span class="hljs-string">&quot;11&quot;</span>;  <span class="hljs-comment">// åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆçš„å­—ç¬¦ä¸²</span>s3.intern();  <span class="hljs-comment">// ç„¶ås3å°±ä¼šä»å¸¸é‡æ± ä¸­æ‰¾ï¼Œå‘ç°æœ‰äº†ï¼Œå°±ä»€ä¹ˆäº‹æƒ…éƒ½ä¸åš</span>System.out.println(s3 == s4);</code></pre></div><p>æˆ‘ä»¬å°† s4çš„ä½ç½®å‘ä¸Šç§»åŠ¨ä¸€è¡Œï¼Œå‘ç°å˜åŒ–å°±ä¼šå¾ˆå¤§ï¼Œæœ€åå¾—åˆ°çš„æ˜¯ false</p><h3 id="6-5-æ€»ç»“"><a href="#6-5-æ€»ç»“" class="headerlink" title="6.5 æ€»ç»“"></a>6.5 æ€»ç»“</h3><p>æ€»ç»“stringçš„internï¼ˆï¼‰çš„ä½¿ç”¨ï¼š</p><p>JDK1.6ä¸­ï¼Œå°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ã€‚</p><ul><li>å¦‚æœä¸²æ± ä¸­æœ‰ï¼Œåˆ™å¹¶ä¸ä¼šæ”¾å…¥ã€‚è¿”å›å·²æœ‰çš„ä¸²æ± ä¸­çš„å¯¹è±¡çš„åœ°å€</li><li>å¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ­¤<strong>å¯¹è±¡å¤åˆ¶ä¸€ä»½</strong>ï¼Œæ”¾å…¥ä¸²æ± ï¼Œå¹¶è¿”å›ä¸²æ± ä¸­çš„å¯¹è±¡åœ°å€</li></ul><p>JDK1.7èµ·ï¼Œå°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ã€‚</p><ul><li>å¦‚æœä¸²æ± ä¸­æœ‰ï¼Œåˆ™å¹¶ä¸ä¼šæ”¾å…¥ã€‚è¿”å›å·²æœ‰çš„ä¸²æ± ä¸­çš„å¯¹è±¡çš„åœ°å€</li><li>å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šæŠŠ<strong>å¯¹è±¡çš„å¼•ç”¨åœ°å€</strong>å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥ä¸²æ± ï¼Œå¹¶è¿”å›ä¸²æ± ä¸­çš„å¼•ç”¨åœ°å€</li></ul><p>ç»ƒä¹ ï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711150859709.png" alt="image-20200711150859709"></p><ul><li>åœ¨JDK6ä¸­ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² â€œabâ€</li><li>åœ¨JDK8ä¸­ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰åˆ›å»º â€œabâ€ï¼Œè€Œæ˜¯å°†å †ä¸­çš„åœ°å€å¤åˆ¶åˆ° ä¸²æ± ä¸­ã€‚</li></ul><p>æ‰€ä»¥ä¸Šè¿°ç»“æœï¼Œåœ¨JDK6ä¸­æ˜¯ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">true</span><span class="hljs-keyword">false</span></code></pre></div><p>åœ¨JDK8ä¸­æ˜¯</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">false</span><span class="hljs-keyword">true</span></code></pre></div><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711151326909.png" alt="image-20200711151326909"></p><p>é’ˆå¯¹ä¸‹é¢è¿™é¢˜ï¼Œåœ¨JDK6å’Œ8ä¸­è¡¨ç°çš„æ˜¯ä¸€æ ·çš„</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200711151433277.png" alt="image-20200711151433277"></p><h2 id="7-StringTableçš„åƒåœ¾å›æ”¶"><a href="#7-StringTableçš„åƒåœ¾å›æ”¶" class="headerlink" title="7 StringTableçš„åƒåœ¾å›æ”¶"></a>7 StringTableçš„åƒåœ¾å›æ”¶</h2><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Stringçš„åƒåœ¾å›æ”¶</span><span class="hljs-comment"> * -Xms15m -Xmx15m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringGCTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) &#123;            String.valueOf(i).intern();        &#125;    &#125;&#125;</code></pre></div><h2 id="8-G1ä¸­çš„Stringå»é‡æ“ä½œ"><a href="#8-G1ä¸­çš„Stringå»é‡æ“ä½œ" class="headerlink" title="8 G1ä¸­çš„Stringå»é‡æ“ä½œ"></a>8 G1ä¸­çš„Stringå»é‡æ“ä½œ</h2><p>æ³¨æ„è¿™é‡Œè¯´çš„é‡å¤ï¼ŒæŒ‡çš„æ˜¯åœ¨å †ä¸­çš„æ•°æ®ï¼Œè€Œä¸æ˜¯å¸¸é‡æ± ä¸­çš„ï¼Œå› ä¸ºå¸¸é‡æ± ä¸­çš„æœ¬èº«å°±ä¸ä¼šé‡å¤</p><h3 id="8-1-æè¿°"><a href="#8-1-æè¿°" class="headerlink" title="8.1 æè¿°"></a>8.1 æè¿°</h3><p>èƒŒæ™¯ï¼šå¯¹è®¸å¤šJavaåº”ç”¨ï¼ˆæœ‰å¤§çš„ä¹Ÿæœ‰å°çš„ï¼‰åšçš„æµ‹è¯•å¾—å‡ºä»¥ä¸‹ç»“æœï¼š</p><ul><li><p>å †å­˜æ´»æ•°æ®é›†åˆé‡Œé¢stringå¯¹è±¡å äº†25%</p></li><li><p>å †å­˜æ´»æ•°æ®é›†åˆé‡Œé¢é‡å¤çš„stringå¯¹è±¡æœ‰13.5%</p></li><li><p>stringå¯¹è±¡çš„å¹³å‡é•¿åº¦æ˜¯45</p></li></ul><p>è®¸å¤šå¤§è§„æ¨¡çš„Javaåº”ç”¨çš„ç“¶é¢ˆåœ¨äºå†…å­˜ï¼Œæµ‹è¯•è¡¨æ˜ï¼Œåœ¨è¿™äº›ç±»å‹çš„åº”ç”¨é‡Œé¢ï¼ŒJavaå †ä¸­å­˜æ´»çš„æ•°æ®é›†åˆå·®ä¸å¤š25%æ˜¯stringå¯¹è±¡ã€‚æ›´è¿›ä¸€æ­¥ï¼Œè¿™é‡Œé¢å·®ä¸å¤šä¸€åŠstringå¯¹è±¡æ˜¯é‡å¤çš„ï¼Œé‡å¤çš„æ„æ€æ˜¯è¯´ï¼š<br>stringl.equalsï¼ˆstring2ï¼‰= trueã€‚å †ä¸Šå­˜åœ¨é‡å¤çš„stringå¯¹è±¡å¿…ç„¶æ˜¯ä¸€ç§å†…å­˜çš„æµªè´¹ã€‚è¿™ä¸ªé¡¹ç›®å°†åœ¨G1åƒåœ¾æ”¶é›†å™¨ä¸­å®ç°è‡ªåŠ¨æŒç»­å¯¹é‡å¤çš„stringå¯¹è±¡è¿›è¡Œå»é‡ï¼Œè¿™æ ·å°±èƒ½é¿å…æµªè´¹å†…å­˜ã€‚</p><h3 id="8-2-å®ç°"><a href="#8-2-å®ç°" class="headerlink" title="8.2 å®ç°"></a>8.2 å®ç°</h3><ul><li>å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„æ—¶å€™ï¼Œä¼šè®¿é—®å †ä¸Šå­˜æ´»çš„å¯¹è±¡ã€‚å¯¹æ¯ä¸€ä¸ªè®¿é—®çš„å¯¹è±¡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦æ˜¯å€™é€‰çš„è¦å»é‡çš„stringå¯¹è±¡ã€‚</li><li>å¦‚æœæ˜¯ï¼ŒæŠŠè¿™ä¸ªå¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…åç»­çš„å¤„ç†ã€‚ä¸€ä¸ªå»é‡çš„çº¿ç¨‹åœ¨åå°è¿è¡Œï¼Œå¤„ç†è¿™ä¸ªé˜Ÿåˆ—ã€‚å¤„ç†é˜Ÿåˆ—çš„ä¸€ä¸ªå…ƒç´ æ„å‘³ç€ä»é˜Ÿåˆ—åˆ é™¤è¿™ä¸ªå…ƒç´ ï¼Œç„¶åå°è¯•å»é‡å®ƒå¼•ç”¨çš„stringå¯¹è±¡ã€‚</li><li>ä½¿ç”¨ä¸€ä¸ªhashtab1eæ¥è®°å½•æ‰€æœ‰çš„è¢«stringå¯¹è±¡ä½¿ç”¨çš„ä¸é‡å¤çš„charæ•°ç»„ã€‚å½“å»é‡çš„æ—¶å€™ï¼Œä¼šæŸ¥è¿™ä¸ªhashtableï¼Œæ¥çœ‹å †ä¸Šæ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„charæ•°ç»„ã€‚</li><li>å¦‚æœå­˜åœ¨ï¼Œstringå¯¹è±¡ä¼šè¢«è°ƒæ•´å¼•ç”¨é‚£ä¸ªæ•°ç»„ï¼Œé‡Šæ”¾å¯¹åŸæ¥çš„æ•°ç»„çš„å¼•ç”¨ï¼Œæœ€ç»ˆä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ‰ã€‚</li><li>å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œcharæ•°ç»„ä¼šè¢«æ’å…¥åˆ°hashtableï¼Œè¿™æ ·ä»¥åçš„æ—¶å€™å°±å¯ä»¥å…±äº«è¿™ä¸ªæ•°ç»„äº†ã€‚</li></ul><h3 id="8-3-å¼€å¯"><a href="#8-3-å¼€å¯" class="headerlink" title="8.3 å¼€å¯"></a>8.3 å¼€å¯</h3><p>å‘½ä»¤è¡Œé€‰é¡¹</p><blockquote><p>UsestringDeduplicationï¼ˆboolï¼‰ï¼šå¼€å¯stringå»é‡ï¼Œé»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ã€‚<br>Printstringbeduplicationstatisticsï¼ˆboolï¼‰ï¼šæ‰“å°è¯¦ç»†çš„å»é‡ç»Ÿè®¡ä¿¡æ¯<br>stringpeduplicationAgeThresholdï¼ˆuintxï¼‰ï¼šè¾¾åˆ°è¿™ä¸ªå¹´é¾„çš„stringå¯¹è±¡è¢«è®¤ä¸ºæ˜¯å»é‡çš„å€™é€‰å¯¹è±¡</p></blockquote><h1 id="ç¬¬14ç« -åƒåœ¾å›æ”¶æ¦‚è¿°"><a href="#ç¬¬14ç« -åƒåœ¾å›æ”¶æ¦‚è¿°" class="headerlink" title="ç¬¬14ç«  åƒåœ¾å›æ”¶æ¦‚è¿°"></a>ç¬¬14ç«  åƒåœ¾å›æ”¶æ¦‚è¿°</h1><h2 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1 æ¦‚å¿µ"></a>1 æ¦‚å¿µ</h2><p>è¿™æ¬¡æˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯é»„è‰²éƒ¨åˆ†ï¼Œå†…å­˜çš„åˆ†é…ä¸å›æ”¶</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712084539884.png" alt="image-20200712084539884"></p><h2 id="2-ä»€ä¹ˆæ˜¯åƒåœ¾"><a href="#2-ä»€ä¹ˆæ˜¯åƒåœ¾" class="headerlink" title="2 ä»€ä¹ˆæ˜¯åƒåœ¾"></a>2 ä»€ä¹ˆæ˜¯åƒåœ¾</h2><p>åœ¨æåˆ°ä»€ä¹ˆæ˜¯åƒåœ¾ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹é¢ä¸€å¼ å›¾</p><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/14_%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%A6%82%E8%BF%B0/images/image-20200712085456113.png" alt="image-20200712085456113"></p><p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å¾ˆæ˜ç¡®çš„çŸ¥é“ï¼ŒJava å’Œ C++è¯­è¨€çš„åŒºåˆ«ï¼Œå°±åœ¨äºåƒåœ¾æ”¶é›†æŠ€æœ¯å’Œå†…å­˜åŠ¨æ€åˆ†é…ä¸Šï¼ŒCè¯­è¨€æ²¡æœ‰åƒåœ¾æ”¶é›†æŠ€æœ¯ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨çš„æ”¶é›†ã€‚</p><p>åƒåœ¾æ”¶é›†ï¼Œä¸æ˜¯Javaè¯­è¨€çš„ä¼´ç”Ÿäº§ç‰©ã€‚æ—©åœ¨1960å¹´ï¼Œç¬¬ä¸€é—¨å¼€å§‹ä½¿ç”¨å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†æŠ€æœ¯çš„Lispè¯­è¨€è¯ç”Ÿã€‚<br>å…³äºåƒåœ¾æ”¶é›†æœ‰ä¸‰ä¸ªç»å…¸é—®é¢˜ï¼š</p><ul><li>å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ</li><li>ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ</li><li>å¦‚ä½•å›æ”¶ï¼Ÿ</li></ul><p>åƒåœ¾æ”¶é›†æœºåˆ¶æ˜¯Javaçš„æ‹›ç‰Œèƒ½åŠ›ï¼Œæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ã€‚å¦‚ä»Šï¼Œåƒåœ¾æ”¶é›†å‡ ä¹æˆä¸ºç°ä»£è¯­è¨€çš„æ ‡é…ï¼Œå³ä½¿ç»è¿‡å¦‚æ­¤é•¿æ—¶é—´çš„å‘å±•ï¼ŒJavaçš„åƒåœ¾æ”¶é›†æœºåˆ¶ä»ç„¶åœ¨ä¸æ–­çš„æ¼”è¿›ä¸­ï¼Œä¸åŒå¤§å°çš„è®¾å¤‡ã€ä¸åŒç‰¹å¾çš„åº”ç”¨åœºæ™¯ï¼Œå¯¹åƒåœ¾æ”¶é›†æå‡ºäº†æ–°çš„æŒ‘æˆ˜ï¼Œè¿™å½“ç„¶ä¹Ÿæ˜¯é¢è¯•çš„çƒ­ç‚¹ã€‚</p><h3 id="2-1-ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Ÿ"><a href="#2-1-ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Ÿ" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Ÿ"></a>2.1 ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Ÿ</h3><p>åƒåœ¾æ˜¯æŒ‡åœ¨è¿è¡Œç¨‹åºä¸­æ²¡æœ‰ä»»ä½•æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯éœ€è¦è¢«å›æ”¶çš„åƒåœ¾ã€‚</p><p>å¦‚æœä¸åŠæ—¶å¯¹å†…å­˜ä¸­çš„åƒåœ¾è¿›è¡Œæ¸…ç†ï¼Œé‚£ä¹ˆï¼Œè¿™äº›åƒåœ¾å¯¹è±¡æ‰€å çš„å†…å­˜ç©ºé—´ä¼šä¸€ç›´ä¿ç•™åˆ°åº”ç”¨ç¨‹åºçš„ç»“æŸï¼Œè¢«ä¿ç•™çš„ç©ºé—´æ— æ³•è¢«å…¶å®ƒå¯¹è±¡ä½¿ç”¨ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p><h3 id="2-2-ç£ç›˜ç¢ç‰‡æ•´ç†"><a href="#2-2-ç£ç›˜ç¢ç‰‡æ•´ç†" class="headerlink" title="2.2 ç£ç›˜ç¢ç‰‡æ•´ç†"></a>2.2 ç£ç›˜ç¢ç‰‡æ•´ç†</h3><p>æœºæ¢°ç¡¬ç›˜éœ€è¦è¿›è¡Œç£ç›˜æ•´ç†ï¼ŒåŒæ—¶è¿˜æœ‰åé“</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712090848669.png" alt="image-20200712090848669"></p><h3 id="2-3-å¤§å‚é¢è¯•é¢˜"><a href="#2-3-å¤§å‚é¢è¯•é¢˜" class="headerlink" title="2.3 å¤§å‚é¢è¯•é¢˜"></a>2.3 å¤§å‚é¢è¯•é¢˜</h3><h4 id="èš‚èšé‡‘æœ"><a href="#èš‚èšé‡‘æœ" class="headerlink" title="èš‚èšé‡‘æœ"></a>èš‚èšé‡‘æœ</h4><ul><li>ä½ çŸ¥é“å“ªå‡ ç§åƒåœ¾å›æ”¶å™¨ï¼Œå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œé‡ç‚¹è®²ä¸€ä¸‹cmså’ŒG1ï¼Ÿ</li><li>JVM GCç®—æ³•æœ‰å“ªäº›ï¼Œç›®å‰çš„JDKç‰ˆæœ¬é‡‡ç”¨ä»€ä¹ˆå›æ”¶ç®—æ³•ï¼Ÿ</li><li>G1å›æ”¶å™¨è®²ä¸‹å›æ”¶è¿‡ç¨‹GCæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰GCï¼Ÿ</li><li>GCçš„ä¸¤ç§åˆ¤å®šæ–¹æ³•ï¼ŸCMSæ”¶é›†å™¨ä¸G1æ”¶é›†å™¨çš„ç‰¹ç‚¹</li></ul><h4 id="ç™¾åº¦"><a href="#ç™¾åº¦" class="headerlink" title="ç™¾åº¦"></a>ç™¾åº¦</h4><ul><li>è¯´ä¸€ä¸‹GCç®—æ³•ï¼Œåˆ†ä»£å›æ”¶è¯´ä¸‹</li><li>åƒåœ¾æ”¶é›†ç­–ç•¥å’Œç®—æ³•</li></ul><h4 id="å¤©çŒ«"><a href="#å¤©çŒ«" class="headerlink" title="å¤©çŒ«"></a>å¤©çŒ«</h4><ul><li>JVM GCåŸç†ï¼ŒJVMæ€ä¹ˆå›æ”¶å†…å­˜</li><li>CMSç‰¹ç‚¹ï¼Œåƒåœ¾å›æ”¶ç®—æ³•æœ‰å“ªäº›ï¼Ÿå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œä»–ä»¬å…±åŒçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li></ul><h4 id="æ»´æ»´"><a href="#æ»´æ»´" class="headerlink" title="æ»´æ»´"></a>æ»´æ»´</h4><p>Javaçš„åƒåœ¾å›æ”¶å™¨éƒ½æœ‰å“ªäº›ï¼Œè¯´ä¸‹g1çš„åº”ç”¨åœºæ™¯ï¼Œå¹³æ—¶ä½ æ˜¯å¦‚ä½•æ­é…ä½¿ç”¨åƒåœ¾å›æ”¶å™¨çš„</p><h4 id="äº¬ä¸œ"><a href="#äº¬ä¸œ" class="headerlink" title="äº¬ä¸œ"></a>äº¬ä¸œ</h4><ul><li>ä½ çŸ¥é“å“ªå‡ ç§åƒåœ¾æ”¶é›†å™¨ï¼Œå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œé‡ç‚¹è®²ä¸‹cmså’ŒG1ï¼Œ</li><li>åŒ…æ‹¬åŸç†ï¼Œæµç¨‹ï¼Œä¼˜ç¼ºç‚¹ã€‚åƒåœ¾å›æ”¶ç®—æ³•çš„å®ç°åŸç†</li></ul><h4 id="é˜¿é‡Œ"><a href="#é˜¿é‡Œ" class="headerlink" title="é˜¿é‡Œ"></a>é˜¿é‡Œ</h4><ul><li>è®²ä¸€è®²åƒåœ¾å›æ”¶ç®—æ³•ã€‚</li><li>ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘åƒåœ¾å›æ”¶ï¼Ÿ</li><li>å¦‚ä½•é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Ÿ</li><li>JVMæœ‰å“ªä¸‰ç§åƒåœ¾å›æ”¶å™¨ï¼Ÿ</li></ul><h4 id="å­—èŠ‚è·³åŠ¨"><a href="#å­—èŠ‚è·³åŠ¨" class="headerlink" title="å­—èŠ‚è·³åŠ¨"></a>å­—èŠ‚è·³åŠ¨</h4><ul><li>å¸¸è§çš„åƒåœ¾å›æ”¶å™¨ç®—æ³•æœ‰å“ªäº›ï¼Œå„æœ‰ä»€ä¹ˆä¼˜åŠ£ï¼Ÿ</li><li>System.gcï¼ˆï¼‰å’ŒRuntime.gcï¼ˆï¼‰ä¼šåšä»€ä¹ˆäº‹æƒ…ï¼Ÿ</li><li>Java GCæœºåˆ¶ï¼ŸGC Rootsæœ‰å“ªäº›ï¼Ÿ</li><li>Javaå¯¹è±¡çš„å›æ”¶æ–¹å¼ï¼Œå›æ”¶ç®—æ³•ã€‚</li><li>CMSå’ŒG1äº†è§£ä¹ˆï¼ŒCMSè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¯´ä¸€ä¸‹å›æ”¶çš„è¿‡ç¨‹ã€‚</li><li>CMSå›æ”¶åœé¡¿äº†å‡ æ¬¡ï¼Œä¸ºä»€ä¹ˆè¦åœé¡¿ä¸¤æ¬¡?</li></ul><h2 id="3-ä¸ºä»€ä¹ˆéœ€è¦GC"><a href="#3-ä¸ºä»€ä¹ˆéœ€è¦GC" class="headerlink" title="3 ä¸ºä»€ä¹ˆéœ€è¦GC"></a>3 ä¸ºä»€ä¹ˆéœ€è¦GC</h2><p>å¯¹äºé«˜çº§è¯­è¨€æ¥è¯´ï¼Œä¸€ä¸ªåŸºæœ¬è®¤çŸ¥æ˜¯å¦‚æœä¸è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå†…å­˜è¿Ÿæ—©éƒ½ä¼šè¢«æ¶ˆè€—å®Œï¼Œå› ä¸ºä¸æ–­åœ°åˆ†é…å†…å­˜ç©ºé—´è€Œä¸è¿›è¡Œå›æ”¶ï¼Œå°±å¥½åƒä¸åœåœ°ç”Ÿäº§ç”Ÿæ´»åƒåœ¾è€Œä»æ¥ä¸æ‰“æ‰«ä¸€æ ·ã€‚</p><p>é™¤äº†é‡Šæ”¾æ²¡ç”¨çš„å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ä¹Ÿå¯ä»¥æ¸…é™¤å†…å­˜é‡Œçš„è®°å½•ç¢ç‰‡ã€‚ç¢ç‰‡æ•´ç†å°†æ‰€å ç”¨çš„å †å†…å­˜ç§»åˆ°å †çš„ä¸€ç«¯ï¼Œä»¥ä¾¿JVMå°†æ•´ç†å‡ºçš„å†…å­˜åˆ†é…ç»™æ–°çš„å¯¹è±¡ã€‚</p><p>éšç€åº”ç”¨ç¨‹åºæ‰€åº”ä»˜çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºçš„æ­£å¸¸è¿›è¡Œã€‚è€Œç»å¸¸é€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­åœ°å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚</p><h2 id="4-æ—©æœŸåƒåœ¾å›æ”¶"><a href="#4-æ—©æœŸåƒåœ¾å›æ”¶" class="headerlink" title="4 æ—©æœŸåƒåœ¾å›æ”¶"></a>4 æ—©æœŸåƒåœ¾å›æ”¶</h2><p>åœ¨æ—©æœŸçš„C/C++æ—¶ä»£ï¼Œåƒåœ¾å›æ”¶åŸºæœ¬ä¸Šæ˜¯æ‰‹å·¥è¿›è¡Œçš„ã€‚å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨newå…³é”®å­—è¿›è¡Œå†…å­˜ç”³è¯·ï¼Œå¹¶ä½¿ç”¨deleteå…³é”®å­—è¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><div class="code-wrapper"><pre><code class="hljs c++">MibBridge *pBridge= <span class="hljs-keyword">new</span> cmBaseGroupBridgeï¼ˆï¼‰ï¼›<span class="hljs-comment">//å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œä½¿ç”¨Deleteé‡Šæ”¾è¯¥å¯¹è±¡æ‰€å å†…å­˜åŒºåŸŸ</span><span class="hljs-keyword">if</span>ï¼ˆpBridge-&gt;Registerï¼ˆkDestroyï¼‰ï¼=NO ERRORï¼‰<span class="hljs-keyword">delete</span> pBridgeï¼›</code></pre></div><p>è¿™ç§æ–¹å¼å¯ä»¥çµæ´»æ§åˆ¶å†…å­˜é‡Šæ”¾çš„æ—¶é—´ï¼Œä½†æ˜¯ä¼šç»™å¼€å‘äººå‘˜å¸¦æ¥é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„ç®¡ç†è´Ÿæ‹…ã€‚å€˜è‹¥æœ‰ä¸€å¤„å†…å­˜åŒºé—´ç”±äºç¨‹åºå‘˜ç¼–ç çš„é—®é¢˜å¿˜è®°è¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œåƒåœ¾å¯¹è±¡æ°¸è¿œæ— æ³•è¢«æ¸…é™¤ï¼Œéšç€ç³»ç»Ÿè¿è¡Œæ—¶é—´çš„ä¸æ–­å¢é•¿ï¼Œåƒåœ¾å¯¹è±¡æ‰€è€—å†…å­˜å¯èƒ½æŒç»­ä¸Šå‡ï¼Œç›´åˆ°å‡ºç°å†…å­˜æº¢å‡ºå¹¶é€ æˆåº”ç”¨ç¨‹åºå´©æºƒã€‚ </p><p>æœ‰äº†åƒåœ¾å›æ”¶æœºåˆ¶åï¼Œä¸Šè¿°ä»£ç ææœ‰å¯èƒ½å˜æˆè¿™æ ·</p><div class="code-wrapper"><pre><code class="hljs c++">MibBridge *pBridge=<span class="hljs-keyword">new</span> <span class="hljs-built_in">cmBaseGroupBridge</span>(); pBridge-&gt;<span class="hljs-built_in">Register</span>(kDestroy);</code></pre></div><p>ç°åœ¨ï¼Œé™¤äº†Javaä»¥å¤–ï¼ŒC#ã€Pythonã€Rubyç­‰è¯­è¨€éƒ½ä½¿ç”¨äº†è‡ªåŠ¨åƒåœ¾å›æ”¶çš„æ€æƒ³ï¼Œä¹Ÿæ˜¯æœªæ¥å‘å±•è¶‹åŠ¿ï¼Œå¯ä»¥è¯´è¿™ç§è‡ªåŠ¨åŒ–çš„å†…å­˜åˆ†é…å’Œæ¥åŠå›æ”¶æ–¹å¼å·²ç»æˆä¸ºäº†çº¿ä»£å¼€å‘è¯­è¨€å¿…å¤‡çš„æ ‡å‡†ã€‚</p><h2 id="5-Javaåƒåœ¾å›æ”¶æœºåˆ¶"><a href="#5-Javaåƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="5 Javaåƒåœ¾å›æ”¶æœºåˆ¶"></a>5 Javaåƒåœ¾å›æ”¶æœºåˆ¶</h2><h3 id="5-1-ä¼˜ç‚¹"><a href="#5-1-ä¼˜ç‚¹" class="headerlink" title="5.1 ä¼˜ç‚¹"></a>5.1 ä¼˜ç‚¹</h3><p>è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œæ— éœ€å¼€å‘äººå‘˜æ‰‹åŠ¨å‚ä¸å†…å­˜çš„åˆ†é…ä¸å›æ”¶ï¼Œè¿™æ ·é™ä½å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºçš„é£é™©</p><p>æ²¡æœ‰åƒåœ¾å›æ”¶å™¨ï¼Œjavaä¹Ÿä¼šå’Œcppä¸€æ ·ï¼Œå„ç§æ‚¬å‚æŒ‡é’ˆï¼Œé‡æŒ‡é’ˆï¼Œæ³„éœ²é—®é¢˜è®©ä½ å¤´ç–¼ä¸å·²ã€‚</p><p>è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå°†ç¨‹åºå‘˜ä»ç¹é‡çš„å†…å­˜ç®¡ç†ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œå¯ä»¥æ›´ä¸“å¿ƒåœ°ä¸“æ³¨äºä¸šåŠ¡å¼€å‘</p><p>oracleå®˜ç½‘å…³äºåƒåœ¾å›æ”¶çš„ä»‹ç»<br><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html</a></p><h3 id="5-2-æ‹…å¿§"><a href="#5-2-æ‹…å¿§" class="headerlink" title="5.2 æ‹…å¿§"></a>5.2 æ‹…å¿§</h3><p>å¯¹äºJavaå¼€å‘äººå‘˜è€Œè¨€ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†å°±åƒæ˜¯ä¸€ä¸ªé»‘åŒ£å­ï¼Œå¦‚æœè¿‡åº¦ä¾èµ–äºâ€œè‡ªåŠ¨â€ï¼Œé‚£ä¹ˆè¿™å°†ä¼šæ˜¯ä¸€åœºç¾éš¾ï¼Œæœ€ä¸¥é‡çš„å°±ä¼šå¼±åŒ–Javaå¼€å‘äººå‘˜åœ¨ç¨‹åºå‡ºç°å†…å­˜æº¢å‡ºæ—¶å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚</p><p>æ­¤æ—¶ï¼Œäº†è§£JVMçš„è‡ªåŠ¨å†…å­˜åˆ†é…å’Œå†…å­˜å›æ”¶åŸç†å°±æ˜¾å¾—éå¸¸é‡è¦ï¼Œåªæœ‰åœ¨çœŸæ­£äº†è§£JVMæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜åï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨é‡è§outofMemoryErroræ—¶ï¼Œå¿«é€Ÿåœ°æ ¹æ®é”™è¯¯å¼‚å¸¸æ—¥å¿—å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚</p><p>å½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼é—®é¢˜æ—¶ï¼Œå½“åƒåœ¾æ”¶é›†æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘é‡çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å°±å¿…é¡»å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚</p><h3 id="5-3-GCä¸»è¦å…³æ³¨çš„åŒºåŸŸ"><a href="#5-3-GCä¸»è¦å…³æ³¨çš„åŒºåŸŸ" class="headerlink" title="5.3 GCä¸»è¦å…³æ³¨çš„åŒºåŸŸ"></a>5.3 GCä¸»è¦å…³æ³¨çš„åŒºåŸŸ</h3><p>GCä¸»è¦å…³æ³¨äº æ–¹æ³•åŒº å’Œå †ä¸­çš„åƒåœ¾æ”¶é›†</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712092427246.png" alt="image-20200712092427246"></p><p>åƒåœ¾æ”¶é›†å™¨å¯ä»¥å¯¹å¹´è½»ä»£å›æ”¶ï¼Œä¹Ÿå¯ä»¥å¯¹è€å¹´ä»£å›æ”¶ï¼Œç”šè‡³æ˜¯å…¨æ ˆå’Œæ–¹æ³•åŒºçš„å›æ”¶</p><ul><li>å…¶ä¸­ï¼ŒJavaå †æ˜¯åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œé‡ç‚¹</li></ul><p>ä»æ¬¡æ•°ä¸Šè®²ï¼š</p><ul><li>é¢‘ç¹æ”¶é›†YoungåŒº</li><li>è¾ƒå°‘æ”¶é›†OldåŒº</li><li>åŸºæœ¬ä¸æ”¶é›†PermåŒºï¼ˆå…ƒç©ºé—´ï¼‰</li></ul><h1 id="ç¬¬15ç« -åƒåœ¾å›æ”¶ç›¸å…³ç®—æ³•"><a href="#ç¬¬15ç« -åƒåœ¾å›æ”¶ç›¸å…³ç®—æ³•" class="headerlink" title="ç¬¬15ç«  åƒåœ¾å›æ”¶ç›¸å…³ç®—æ³•"></a>ç¬¬15ç«  åƒåœ¾å›æ”¶ç›¸å…³ç®—æ³•</h1><h2 id="1-æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#1-æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="1 æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•"></a>1 æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•</h2><p>åœ¨å †é‡Œå­˜æ”¾ç€å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡å®ä¾‹ï¼Œåœ¨GCæ‰§è¡Œåƒåœ¾å›æ”¶ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦åŒºåˆ†å‡ºå†…å­˜ä¸­å“ªäº›æ˜¯å­˜æ´»å¯¹è±¡ï¼Œå“ªäº›æ˜¯å·²ç»æ­»äº¡çš„å¯¹è±¡ã€‚åªæœ‰è¢«æ ‡è®°ä¸ºå·±ç»æ­»äº¡çš„å¯¹è±¡ï¼ŒGCæ‰ä¼šåœ¨æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œé‡Šæ”¾æ‰å…¶æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç§°ä¸ºåƒåœ¾æ ‡è®°é˜¶æ®µã€‚</p><p>é‚£ä¹ˆåœ¨JVMä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ ‡è®°ä¸€ä¸ªæ­»äº¡å¯¹è±¡å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå½“ä¸€ä¸ªå¯¹è±¡å·²ç»ä¸å†è¢«ä»»ä½•çš„å­˜æ´»å¯¹è±¡ç»§ç»­å¼•ç”¨æ—¶ï¼Œå°±å¯ä»¥å®£åˆ¤ä¸ºå·²ç»æ­»äº¡ã€‚</p><p>åˆ¤æ–­å¯¹è±¡å­˜æ´»ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š<strong>å¼•ç”¨è®¡æ•°ç®—æ³•</strong>å’Œ<strong>å¯è¾¾æ€§åˆ†æç®—æ³•ã€‚</strong></p><p>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ã€‚ç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚</p><p>å¯¹äºä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„å¼•ç”¨è®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡1ã€‚åªè¦å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œå³è¡¨ç¤ºå¯¹è±¡Aä¸å¯èƒ½å†è¢«ä½¿ç”¨ï¼Œå¯è¿›è¡Œå›æ”¶ã€‚</p><p>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ï¼›åˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ã€‚</p><p>ç¼ºç‚¹ï¼šå®ƒéœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†å­˜å‚¨ç©ºé—´çš„å¼€é”€ã€‚</p><blockquote><p>æ¯æ¬¡èµ‹å€¼éƒ½éœ€è¦æ›´æ–°è®¡æ•°å™¨ï¼Œä¼´éšç€åŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œè¿™å¢åŠ äº†æ—¶é—´å¼€é”€ã€‚<br>å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€æ¡è‡´å‘½ç¼ºé™·ï¼Œå¯¼è‡´åœ¨Javaçš„åƒåœ¾å›æ”¶å™¨ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ç±»ç®—æ³•ã€‚</p></blockquote><h3 id="1-1-å¾ªç¯å¼•ç”¨"><a href="#1-1-å¾ªç¯å¼•ç”¨" class="headerlink" title="1.1 å¾ªç¯å¼•ç”¨"></a>1.1 å¾ªç¯å¼•ç”¨</h3><p>å½“pçš„æŒ‡é’ˆæ–­å¼€çš„æ—¶å€™ï¼Œå†…éƒ¨çš„å¼•ç”¨å½¢æˆä¸€ä¸ªå¾ªç¯ï¼Œè¿™å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712102205795.png" alt="image-20200712102205795"></p><h3 id="1-2-ä¸¾ä¾‹"><a href="#1-2-ä¸¾ä¾‹" class="headerlink" title="1.2 ä¸¾ä¾‹"></a>1.2 ä¸¾ä¾‹</h3><p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ¡ˆä¾‹æ¥æµ‹è¯•Javaä¸­æ˜¯å¦é‡‡ç”¨çš„æ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å¼•ç”¨è®¡æ•°ç®—æ³•æµ‹è¯•</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefCountGC</span> </span>&#123;    <span class="hljs-comment">// è¿™ä¸ªæˆå‘˜å±æ€§çš„å”¯ä¸€ä½œç”¨å°±æ˜¯å ç”¨ä¸€ç‚¹å†…å­˜</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] bigSize = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">5</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];    <span class="hljs-comment">// å¼•ç”¨</span>    Object reference = <span class="hljs-keyword">null</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        RefCountGC obj1 = <span class="hljs-keyword">new</span> RefCountGC();        RefCountGC obj2 = <span class="hljs-keyword">new</span> RefCountGC();        obj1.reference = obj2;        obj2.reference = obj1;        obj1 = <span class="hljs-keyword">null</span>;        obj2 = <span class="hljs-keyword">null</span>;        <span class="hljs-comment">// æ˜¾ç¤ºçš„æ‰§è¡Œåƒåœ¾æ”¶é›†è¡Œä¸ºï¼Œåˆ¤æ–­obj1 å’Œ obj2æ˜¯å¦è¢«å›æ”¶ï¼Ÿ</span>        System.gc();    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">System</span><span class="hljs-operator">.</span><span class="hljs-variable">gc</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">15490</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">76288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">15490</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">251392</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0061980</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.36</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">System</span><span class="hljs-operator">.</span><span class="hljs-variable">gc</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">808</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">76288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">8</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">672</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">175104</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">816</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">672</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">251392</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3479</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3479</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0045983</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-variable">Heap</span> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">76288</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">655</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076b500000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000770a00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">65536</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076b500000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076b5a3ee8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076f500000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076f500000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076f500000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076ff80000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076ff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x000000076ff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000770a00000</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">175104</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">672</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000006c1e00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000006cc900000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x000000076b500000</span><span class="hljs-punctuation">)</span>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">175104</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000006c1e00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000006c1ea8070</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000006cc900000</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3486</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4496</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">385</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span></code></pre></div><p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œä¸Šè¿°è¿›è¡Œäº†GCæ”¶é›†çš„è¡Œä¸ºï¼Œå°†ä¸Šè¿°çš„æ–°ç”Ÿä»£ä¸­çš„ä¸¤ä¸ªå¯¹è±¡éƒ½è¿›è¡Œå›æ”¶äº†</p><div class="code-wrapper"><pre><code class="hljs shell">PSYoungGen: 15490K-&gt;808K(76288K)] 15490K-&gt;816K(251392K)</code></pre></div><p>å¦‚æœä½¿ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡å°†ä¼šæ— æ³•å›æ”¶ã€‚è€Œç°åœ¨ä¸¤ä¸ªå¯¹è±¡è¢«å›æ”¶äº†ï¼Œè¯´æ˜Javaä½¿ç”¨çš„ä¸æ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ¥è¿›è¡Œæ ‡è®°çš„ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712103230349.png" alt="image-20200712103230349"></p><h3 id="1-3-å°ç»“"><a href="#1-3-å°ç»“" class="headerlink" title="1.3 å°ç»“"></a>1.3 å°ç»“</h3><p>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œæ˜¯å¾ˆå¤šè¯­è¨€çš„èµ„æºå›æ”¶é€‰æ‹©ï¼Œä¾‹å¦‚å› äººå·¥æ™ºèƒ½è€Œæ›´åŠ ç«çƒ­çš„Pythonï¼Œå®ƒæ›´æ˜¯åŒæ—¶æ”¯æŒå¼•ç”¨è®¡æ•°å’Œåƒåœ¾æ”¶é›†æœºåˆ¶ã€‚</p><p>å…·ä½“å“ªç§æœ€ä¼˜æ˜¯è¦çœ‹åœºæ™¯çš„ï¼Œä¸šç•Œæœ‰å¤§è§„æ¨¡å®è·µä¸­ä»…ä¿ç•™å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼Œä»¥æé«˜ååé‡çš„å°è¯•ã€‚</p><p>Javaå¹¶æ²¡æœ‰é€‰æ‹©å¼•ç”¨è®¡æ•°ï¼Œæ˜¯å› ä¸ºå…¶å­˜åœ¨ä¸€ä¸ªåŸºæœ¬çš„éš¾é¢˜ï¼Œä¹Ÿå°±æ˜¯å¾ˆéš¾å¤„ç†å¾ªç¯å¼•ç”¨å…³ç³»ã€‚Pythonå¦‚ä½•è§£å†³å¾ªç¯å¼•ç”¨ï¼Ÿ</p><blockquote><p>æ‰‹åŠ¨è§£é™¤ï¼šå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨åˆé€‚çš„æ—¶æœºï¼Œè§£é™¤å¼•ç”¨å…³ç³»ã€‚<br>ä½¿ç”¨å¼±å¼•ç”¨weakrefï¼Œweakrefæ˜¯Pythonæä¾›çš„æ ‡å‡†åº“ï¼Œæ—¨åœ¨è§£å†³å¾ªç¯å¼•ç”¨ã€‚</p></blockquote><h2 id="2-æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#2-æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="2 æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•"></a>2 æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•</h2><h3 id="2-1-æ¦‚å¿µ"><a href="#2-1-æ¦‚å¿µ" class="headerlink" title="2.1 æ¦‚å¿µ"></a>2.1 æ¦‚å¿µ</h3><p>å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šä¹Ÿå¯ä»¥ç§°ä¸º æ ¹æœç´¢ç®—æ³•ã€è¿½è¸ªæ€§åƒåœ¾æ”¶é›†</p><p>ç›¸å¯¹äºå¼•ç”¨è®¡æ•°ç®—æ³•è€Œè¨€ï¼Œå¯è¾¾æ€§åˆ†æç®—æ³•ä¸ä»…åŒæ ·å…·å¤‡å®ç°ç®€å•å’Œæ‰§è¡Œé«˜æ•ˆç­‰ç‰¹ç‚¹ï¼Œæ›´é‡è¦çš„æ˜¯è¯¥ç®—æ³•å¯ä»¥æœ‰æ•ˆåœ°è§£å†³åœ¨å¼•ç”¨è®¡æ•°ç®—æ³•ä¸­å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼çš„å‘ç”Ÿã€‚</p><p>ç›¸è¾ƒäºå¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œè¿™é‡Œçš„å¯è¾¾æ€§åˆ†æå°±æ˜¯Javaã€C#é€‰æ‹©çš„ã€‚è¿™ç§ç±»å‹çš„åƒåœ¾æ”¶é›†é€šå¸¸ä¹Ÿå«ä½œè¿½è¸ªæ€§åƒåœ¾æ”¶é›†ï¼ˆTracing Garbage Collectionï¼‰</p><h3 id="2-2-æ€è·¯"><a href="#2-2-æ€è·¯" class="headerlink" title="2.2 æ€è·¯"></a>2.2 æ€è·¯</h3><p>æ‰€è°“â€GCRootsâ€æ ¹é›†åˆå°±æ˜¯ä¸€ç»„å¿…é¡»æ´»è·ƒçš„å¼•ç”¨ã€‚</p><p>åŸºæœ¬æ€è·¯ï¼š</p><ul><li>å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥æ ¹å¯¹è±¡é›†åˆï¼ˆGCRootsï¼‰ä¸ºèµ·å§‹ç‚¹ï¼ŒæŒ‰ç…§ä»ä¸Šè‡³ä¸‹çš„æ–¹å¼æœç´¢è¢«æ ¹å¯¹è±¡é›†åˆæ‰€è¿æ¥çš„ç›®æ ‡å¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚</li><li>ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•åï¼Œå†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–é—´æ¥è¿æ¥ç€ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰</li><li>å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™æ˜¯ä¸å¯è¾¾çš„ï¼Œå°±æ„å‘³ç€è¯¥å¯¹è±¡å·±ç»æ­»äº¡ï¼Œå¯ä»¥æ ‡è®°ä¸ºåƒåœ¾å¯¹è±¡ã€‚</li><li>åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ï¼Œåªæœ‰èƒ½å¤Ÿè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–è€…é—´æ¥è¿æ¥çš„å¯¹è±¡æ‰æ˜¯å­˜æ´»å¯¹è±¡ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712104149246.png" alt="image-20200712104149246"></p><p>å®˜åœºä¸Šçš„è£™å¸¦å…³ç³»ï¼Œå¯è¾¾æ€§åˆ†æåœ¨äººç±»å…³ç³»ç½‘ä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712104312406.png" alt="image-20200712104312406"></p><h3 id="2-3-GC-Rootså¯ä»¥æ˜¯å“ªäº›ï¼Ÿ"><a href="#2-3-GC-Rootså¯ä»¥æ˜¯å“ªäº›ï¼Ÿ" class="headerlink" title="2.3 GC Rootså¯ä»¥æ˜¯å“ªäº›ï¼Ÿ"></a>2.3 GC Rootså¯ä»¥æ˜¯å“ªäº›ï¼Ÿ</h3><ul><li>è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡<ul><li>æ¯”å¦‚ï¼šå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰ã€‚</li></ul></li><li>æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆé€šå¸¸è¯´çš„æœ¬åœ°æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡<ul><li>æ¯”å¦‚ï¼šJavaç±»çš„å¼•ç”¨ç±»å‹é™æ€å˜é‡</li></ul></li><li>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡<ul><li>æ¯”å¦‚ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆstring Tableï¼‰é‡Œçš„å¼•ç”¨</li></ul></li><li>æ‰€æœ‰è¢«åŒæ­¥é”synchronizedæŒæœ‰çš„å¯¹è±¡</li><li>Javaè™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨ã€‚<ul><li>åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„Classå¯¹è±¡ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ï¼ˆå¦‚ï¼šNu11PointerExceptionã€outofMemoryErrorï¼‰ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ã€‚</li></ul></li><li>åæ˜ javaè™šæ‹Ÿæœºå†…éƒ¨æƒ…å†µçš„JMXBeanã€JVMTIä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ç­‰ã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712104622677.png" alt="image-20200712104622677"></p><h4 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼Œé™¤äº†å †ç©ºé—´å¤–çš„ä¸€äº›ç»“æ„ï¼Œæ¯”å¦‚ è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€æ–¹æ³•åŒºã€å­—ç¬¦ä¸²å¸¸é‡æ±  ç­‰åœ°æ–¹å¯¹å †ç©ºé—´è¿›è¡Œå¼•ç”¨çš„ï¼Œéƒ½å¯ä»¥ä½œä¸ºGC Rootsè¿›è¡Œå¯è¾¾æ€§åˆ†æ</p><p>é™¤äº†è¿™äº›å›ºå®šçš„GC Rootsé›†åˆä»¥å¤–ï¼Œæ ¹æ®ç”¨æˆ·æ‰€é€‰ç”¨çš„åƒåœ¾æ”¶é›†å™¨ä»¥åŠå½“å‰å›æ”¶çš„å†…å­˜åŒºåŸŸä¸åŒï¼Œè¿˜å¯ä»¥æœ‰å…¶ä»–å¯¹è±¡â€œä¸´æ—¶æ€§â€åœ°åŠ å…¥ï¼Œå…±åŒæ„æˆå®Œæ•´GC Rootsé›†åˆã€‚æ¯”å¦‚ï¼šåˆ†ä»£æ”¶é›†å’Œå±€éƒ¨å›æ”¶ï¼ˆPartialGCï¼‰ã€‚</p><p>å¦‚æœåªé’ˆå¯¹Javaå †ä¸­çš„æŸä¸€å—åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆæ¯”å¦‚ï¼šå…¸å‹çš„åªé’ˆå¯¹æ–°ç”Ÿä»£ï¼‰ï¼Œå¿…é¡»è€ƒè™‘åˆ°å†…å­˜åŒºåŸŸæ˜¯è™šæ‹Ÿæœºè‡ªå·±çš„å®ç°ç»†èŠ‚ï¼Œæ›´ä¸æ˜¯å­¤ç«‹å°é—­çš„ï¼Œè¿™ä¸ªåŒºåŸŸçš„å¯¹è±¡å®Œå…¨æœ‰å¯èƒ½è¢«å…¶ä»–åŒºåŸŸçš„å¯¹è±¡æ‰€å¼•ç”¨ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä¸€å¹¶å°†å…³è”çš„åŒºåŸŸå¯¹è±¡ä¹ŸåŠ å…¥GCRootsé›†åˆä¸­å»è€ƒè™‘ï¼Œæ‰èƒ½ä¿è¯å¯è¾¾æ€§åˆ†æçš„å‡†ç¡®æ€§ã€‚</p><h4 id="å°æŠ€å·§"><a href="#å°æŠ€å·§" class="headerlink" title="å°æŠ€å·§"></a>å°æŠ€å·§</h4><p>ç”±äºRooté‡‡ç”¨æ ˆæ–¹å¼å­˜æ”¾å˜é‡å’ŒæŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒä¿å­˜äº†å †å†…å­˜é‡Œé¢çš„å¯¹è±¡ï¼Œä½†æ˜¯è‡ªå·±åˆä¸å­˜æ”¾åœ¨å †å†…å­˜é‡Œé¢ï¼Œé‚£å®ƒå°±æ˜¯ä¸€ä¸ªRootã€‚</p><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>å¦‚æœè¦ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å†…å­˜æ˜¯å¦å¯å›æ”¶ï¼Œé‚£ä¹ˆåˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œã€‚è¿™ç‚¹ä¸æ»¡è¶³çš„è¯åˆ†æç»“æœçš„å‡†ç¡®æ€§å°±æ— æ³•ä¿è¯ã€‚</p><p>è¿™ç‚¹ä¹Ÿæ˜¯å¯¼è‡´GCè¿›è¡Œæ—¶å¿…é¡»â€œstop The Worldâ€çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚</p><p>å³ä½¿æ˜¯å·ç§°ï¼ˆå‡ ä¹ï¼‰ä¸ä¼šå‘ç”Ÿåœé¡¿çš„CMSæ”¶é›†å™¨ä¸­ï¼Œæšä¸¾æ ¹èŠ‚ç‚¹æ—¶ä¹Ÿæ˜¯å¿…é¡»è¦åœé¡¿çš„ã€‚</p><h2 id="3-å¯¹è±¡çš„finalizationæœºåˆ¶"><a href="#3-å¯¹è±¡çš„finalizationæœºåˆ¶" class="headerlink" title="3 å¯¹è±¡çš„finalizationæœºåˆ¶"></a>3 å¯¹è±¡çš„finalizationæœºåˆ¶</h2><p>Javaè¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚</p><p>å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ã€‚</p><p>finalize() æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚</p><h3 id="3-1-æ³¨æ„"><a href="#3-1-æ³¨æ„" class="headerlink" title="3.1 æ³¨æ„"></a>3.1 æ³¨æ„</h3><p>æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„finalizeï¼ˆï¼‰æ–¹æ³•Iåº”è¯¥äº¤ç»™åƒåœ¾å›æ”¶æœºåˆ¶è°ƒç”¨ã€‚ç†ç”±åŒ…æ‹¬ä¸‹é¢ä¸‰ç‚¹ï¼š</p><ul><li>åœ¨finalizeï¼ˆï¼‰æ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»ã€‚</li><li>finalizeï¼ˆï¼‰æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®ƒå®Œå…¨ç”±GCçº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”ŸGCï¼Œåˆ™finalizeï¼ˆï¼‰æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šã€‚<ul><li>å› ä¸ºä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œå³ä½¿ä¸»åŠ¨è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå› æ­¤å°±ç›´æ¥è¿›è¡Œå›æ”¶</li></ul></li><li>ä¸€ä¸ªç³Ÿç³•çš„finalizeï¼ˆï¼‰ä¼šä¸¥é‡å½±å“Gcçš„æ€§èƒ½ã€‚</li></ul><p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œfinalizeï¼ˆï¼‰æ–¹æ³•ä¸C++ä¸­çš„ææ„å‡½æ•°æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯Javaé‡‡ç”¨çš„æ˜¯åŸºäºåƒåœ¾å›æ”¶å™¨çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥finalizeï¼ˆï¼‰æ–¹æ³•åœ¨æœ¬è´¨ä¸Šä¸åŒäºC++ä¸­çš„ææ„å‡½æ•°ã€‚</p><p>ç”±äºfinalizeï¼ˆï¼‰æ–¹æ³•çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸€èˆ¬å¤„äºä¸‰ç§å¯èƒ½çš„çŠ¶æ€ã€‚</p><h3 id="3-2-ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ï¼Ÿ"><a href="#3-2-ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ï¼Ÿ" class="headerlink" title="3.2 ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ï¼Ÿ"></a>3.2 ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ï¼Ÿ</h3><p>å¦‚æœä»æ‰€æœ‰çš„æ ¹èŠ‚ç‚¹éƒ½æ— æ³•è®¿é—®åˆ°æŸä¸ªå¯¹è±¡ï¼Œè¯´æ˜å¯¹è±¡å·±ç»ä¸å†ä½¿ç”¨äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ­¤å¯¹è±¡éœ€è¦è¢«å›æ”¶ã€‚ä½†äº‹å®ä¸Šï¼Œä¹Ÿå¹¶éæ˜¯â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µã€‚<strong>ä¸€ä¸ªæ— æ³•è§¦åŠçš„å¯¹è±¡æœ‰å¯èƒ½åœ¨æŸä¸€ä¸ªæ¡ä»¶ä¸‹â€œå¤æ´»â€è‡ªå·±</strong>ï¼Œå¦‚æœè¿™æ ·ï¼Œé‚£ä¹ˆå¯¹å®ƒçš„å›æ”¶å°±æ˜¯ä¸åˆç†çš„ï¼Œä¸ºæ­¤ï¼Œå®šä¹‰è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡å¯èƒ½çš„ä¸‰ç§çŠ¶æ€ã€‚å¦‚ä¸‹ï¼š</p><ul><li>å¯è§¦åŠçš„ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯ä»¥åˆ°è¾¾è¿™ä¸ªå¯¹è±¡ã€‚</li><li>å¯å¤æ´»çš„ï¼šå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¯¹è±¡æœ‰å¯èƒ½åœ¨finalizeï¼ˆï¼‰ä¸­å¤æ´»ã€‚</li><li>ä¸å¯è§¦åŠçš„ï¼šå¯¹è±¡çš„finalizeï¼ˆï¼‰è¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰å¤æ´»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€ã€‚ä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½è¢«å¤æ´»ï¼Œå› ä¸º<strong>finalize()åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡</strong>ã€‚</li></ul><p>ä»¥ä¸Š3ç§çŠ¶æ€ä¸­ï¼Œæ˜¯ç”±äºfinalizeï¼ˆï¼‰æ–¹æ³•çš„å­˜åœ¨ï¼Œè¿›è¡Œçš„åŒºåˆ†ã€‚åªæœ‰åœ¨å¯¹è±¡ä¸å¯è§¦åŠæ—¶æ‰å¯ä»¥è¢«å›æ”¶ã€‚</p><h3 id="3-3-å…·ä½“è¿‡ç¨‹"><a href="#3-3-å…·ä½“è¿‡ç¨‹" class="headerlink" title="3.3 å…·ä½“è¿‡ç¨‹"></a>3.3 å…·ä½“è¿‡ç¨‹</h3><p>åˆ¤å®šä¸€ä¸ªå¯¹è±¡objAæ˜¯å¦å¯å›æ”¶ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š</p><ul><li><p>å¦‚æœå¯¹è±¡objAåˆ°GC Rootsæ²¡æœ‰å¼•ç”¨é“¾ï¼Œåˆ™è¿›è¡Œç¬¬ä¸€æ¬¡æ ‡è®°ã€‚</p></li><li><p>è¿›è¡Œç­›é€‰ï¼Œåˆ¤æ–­æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalizeï¼ˆï¼‰æ–¹æ³•</p><ul><li>å¦‚æœå¯¹è±¡objAæ²¡æœ‰é‡å†™finalizeï¼ˆï¼‰æ–¹æ³•ï¼Œæˆ–è€…finalizeï¼ˆï¼‰æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œåˆ™è™šæ‹Ÿæœºè§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ï¼ŒobjAè¢«åˆ¤å®šä¸ºä¸å¯è§¦åŠçš„ã€‚</li><li>å¦‚æœå¯¹è±¡objAé‡å†™äº†finalizeï¼ˆï¼‰æ–¹æ³•ï¼Œä¸”è¿˜æœªæ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆobjAä¼šè¢«æ’å…¥åˆ°F-Queueé˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªè™šæ‹Ÿæœºè‡ªåŠ¨åˆ›å»ºçš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹è§¦å‘å…¶finalizeï¼ˆï¼‰æ–¹æ³•æ‰§è¡Œã€‚</li><li>finalizeï¼ˆï¼‰æ–¹æ³•æ˜¯å¯¹è±¡é€ƒè„±æ­»äº¡çš„æœ€åæœºä¼šï¼Œç¨åGCä¼šå¯¹F-Queueé˜Ÿåˆ—ä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ã€‚å¦‚æœobjAåœ¨finalizeï¼ˆï¼‰æ–¹æ³•ä¸­ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹äº†è”ç³»ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶ï¼ŒobjAä¼šè¢«ç§»å‡ºâ€œå³å°†å›æ”¶â€é›†åˆã€‚ä¹‹åï¼Œå¯¹è±¡ä¼šå†æ¬¡å‡ºç°æ²¡æœ‰å¼•ç”¨å­˜åœ¨çš„æƒ…å†µã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œfinalizeæ–¹æ³•ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œå¯¹è±¡ä¼šç›´æ¥å˜æˆä¸å¯è§¦åŠçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå¯¹è±¡çš„finalizeæ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</li></ul></li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712110411885.png" alt="image-20200712110411885"></p><p>ä¸Šå›¾å°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„Finalizerçº¿ç¨‹</p><h3 id="3-4-ä»£ç æ¼”ç¤º"><a href="#3-4-ä»£ç æ¼”ç¤º" class="headerlink" title="3.4 ä»£ç æ¼”ç¤º"></a>3.4 ä»£ç æ¼”ç¤º</h3><p>æˆ‘ä»¬ä½¿ç”¨é‡å†™ finalize()æ–¹æ³•ï¼Œç„¶ååœ¨æ–¹æ³•çš„å†…éƒ¨ï¼Œé‡å†™å°†å…¶å­˜æ”¾åˆ°GC Rootsä¸­</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * æµ‹è¯•Objectç±»ä¸­finalize()æ–¹æ³•</span><span class="hljs-comment"> * å¯¹è±¡å¤æ´»åœºæ™¯</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CanReliveObj</span> </span>&#123;    <span class="hljs-comment">// ç±»å˜é‡ï¼Œå±äºGC Rootsçš„ä¸€éƒ¨åˆ†</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CanReliveObj canReliveObj;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;        <span class="hljs-keyword">super</span>.finalize();        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨å½“å‰ç±»é‡å†™çš„finalize()æ–¹æ³•&quot;</span>);        canReliveObj = <span class="hljs-keyword">this</span>;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        canReliveObj = <span class="hljs-keyword">new</span> CanReliveObj();        canReliveObj = <span class="hljs-keyword">null</span>;        System.gc();        System.out.println(<span class="hljs-string">&quot;-----------------ç¬¬ä¸€æ¬¡gcæ“ä½œ------------&quot;</span>);        <span class="hljs-comment">// å› ä¸ºFinalizerçº¿ç¨‹çš„ä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œæš‚åœ2ç§’ï¼Œä»¥ç­‰å¾…å®ƒ</span>        Thread.sleep(<span class="hljs-number">2000</span>);        <span class="hljs-keyword">if</span> (canReliveObj == <span class="hljs-keyword">null</span>) &#123;            System.out.println(<span class="hljs-string">&quot;obj is dead&quot;</span>);        &#125; <span class="hljs-keyword">else</span> &#123;            System.out.println(<span class="hljs-string">&quot;obj is still alive&quot;</span>);        &#125;        System.out.println(<span class="hljs-string">&quot;-----------------ç¬¬äºŒæ¬¡gcæ“ä½œ------------&quot;</span>);        canReliveObj = <span class="hljs-keyword">null</span>;        System.gc();        <span class="hljs-comment">// ä¸‹é¢ä»£ç å’Œä¸Šé¢ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ canReliveObjå´è‡ªæ•‘å¤±è´¥äº†</span>        Thread.sleep(<span class="hljs-number">2000</span>);        <span class="hljs-keyword">if</span> (canReliveObj == <span class="hljs-keyword">null</span>) &#123;            System.out.println(<span class="hljs-string">&quot;obj is dead&quot;</span>);        &#125; <span class="hljs-keyword">else</span> &#123;            System.out.println(<span class="hljs-string">&quot;obj is still alive&quot;</span>);        &#125;    &#125;&#125;</code></pre></div><p>æœ€åè¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs ada"><span class="hljs-comment">-----------------ç¬¬ä¸€æ¬¡gcæ“ä½œ------------</span>è°ƒç”¨å½“å‰ç±»é‡å†™çš„finalize()æ–¹æ³•obj <span class="hljs-keyword">is</span> still alive<span class="hljs-comment">-----------------ç¬¬äºŒæ¬¡gcæ“ä½œ------------</span>obj <span class="hljs-keyword">is</span> dead</code></pre></div><p>åœ¨è¿›è¡Œç¬¬ä¸€æ¬¡æ¸…é™¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ‰§è¡Œfinalizeæ–¹æ³•ï¼Œç„¶å å¯¹è±¡ è¿›è¡Œäº†ä¸€æ¬¡è‡ªæ•‘æ“ä½œï¼Œä½†æ˜¯å› ä¸ºfinalize()æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤ç¬¬äºŒæ¬¡è¯¥å¯¹è±¡å°†ä¼šè¢«åƒåœ¾æ¸…é™¤ã€‚</p><h2 id="4-MATä¸JProfilerçš„GC-Rootsæº¯æº"><a href="#4-MATä¸JProfilerçš„GC-Rootsæº¯æº" class="headerlink" title="4 MATä¸JProfilerçš„GC Rootsæº¯æº"></a>4 MATä¸JProfilerçš„GC Rootsæº¯æº</h2><h3 id="4-1-MATæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#4-1-MATæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="4.1 MATæ˜¯ä»€ä¹ˆï¼Ÿ"></a>4.1 MATæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>MATæ˜¯Memory Analyzerçš„ç®€ç§°ï¼Œå®ƒæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„Javaå †å†…å­˜åˆ†æå™¨ã€‚ç”¨äºæŸ¥æ‰¾å†…å­˜æ³„æ¼ä»¥åŠæŸ¥çœ‹å†…å­˜æ¶ˆè€—æƒ…å†µã€‚</p><p>MATæ˜¯åŸºäºEclipseå¼€å‘çš„ï¼Œæ˜¯ä¸€æ¬¾å…è´¹çš„æ€§èƒ½åˆ†æå·¥å…·ã€‚</p><p>å¤§å®¶å¯ä»¥åœ¨<a href="http://www.eclipse.org/mat/ä¸‹è½½å¹¶ä½¿ç”¨MAT">http://www.eclipse.org/mat/ä¸‹è½½å¹¶ä½¿ç”¨MAT</a></p><h3 id="4-2-å‘½ä»¤è¡Œä½¿ç”¨-jmap"><a href="#4-2-å‘½ä»¤è¡Œä½¿ç”¨-jmap" class="headerlink" title="4.2 å‘½ä»¤è¡Œä½¿ç”¨ jmap"></a>4.2 å‘½ä»¤è¡Œä½¿ç”¨ jmap</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712112026317.png" alt="image-20200712112026317"></p><h3 id="4-3-ä½¿ç”¨JVIsualVM"><a href="#4-3-ä½¿ç”¨JVIsualVM" class="headerlink" title="4.3 ä½¿ç”¨JVIsualVM"></a>4.3 ä½¿ç”¨JVIsualVM</h3><p>æ•è·çš„heap dumpæ–‡ä»¶æ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå…³é—­JVisualVMåè‡ªåŠ¨åˆ é™¤ï¼Œè‹¥è¦ä¿ç•™ï¼Œéœ€è¦å°†å…¶å¦å­˜ä¸ºæ–‡ä»¶ã€‚å¯é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ•è·heap dumpï¼š</p><p>åœ¨å·¦ä¾§â€œApplicationâ€ï¼ˆåº”ç”¨ç¨‹åºï¼‰å­çª—å£ä¸­å³å‡»ç›¸åº”çš„åº”ç”¨ç¨‹åºï¼Œé€‰æ‹©Heap Dumpï¼ˆå †Dumpï¼‰ã€‚</p><p>åœ¨Monitorï¼ˆç›‘è§†ï¼‰å­æ ‡ç­¾é¡µä¸­ç‚¹å‡»Heap Dumpï¼ˆå †Dumpï¼‰æŒ‰é’®ã€‚æœ¬åœ°åº”ç”¨ç¨‹åºçš„Heap dumpsä½œä¸ºåº”ç”¨ç¨‹åºæ ‡ç­¾é¡µçš„ä¸€ä¸ªå­æ ‡ç­¾é¡µæ‰“å¼€ã€‚åŒæ—¶ï¼Œheap dumpåœ¨å·¦ä¾§çš„Applicationï¼ˆåº”ç”¨ç¨‹åºï¼‰æ ä¸­å¯¹åº”ä¸€ä¸ªå«æœ‰æ—¶é—´æˆ³çš„èŠ‚ç‚¹ã€‚</p><p>å³å‡»è¿™ä¸ªèŠ‚ç‚¹é€‰æ‹©save asï¼ˆå¦å­˜ä¸ºï¼‰å³å¯å°†heap dumpä¿å­˜åˆ°æœ¬åœ°ã€‚</p><h3 id="4-4-ä½¿ç”¨MATæ‰“å¼€Dumpæ–‡ä»¶"><a href="#4-4-ä½¿ç”¨MATæ‰“å¼€Dumpæ–‡ä»¶" class="headerlink" title="4.4 ä½¿ç”¨MATæ‰“å¼€Dumpæ–‡ä»¶"></a>4.4 ä½¿ç”¨MATæ‰“å¼€Dumpæ–‡ä»¶</h3><p>æ‰“å¼€åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›å¯ä»¥ä½œä¸ºGC Rootsçš„å¯¹è±¡</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712112512720.png" alt="image-20200712112512720"></p><p>é‡Œé¢æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°æœ‰ä¸€äº›å¸¸ç”¨çš„Javaç±»ï¼Œç„¶åThreadçº¿ç¨‹ã€‚</p><h3 id="4-5-JProfilerçš„GC-Rootsæº¯æº"><a href="#4-5-JProfilerçš„GC-Rootsæº¯æº" class="headerlink" title="4.5 JProfilerçš„GC Rootsæº¯æº"></a>4.5 JProfilerçš„GC Rootsæº¯æº</h3><p>æˆ‘ä»¬åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œä¸€èˆ¬ä¸ä¼šæŸ¥æ‰¾å…¨éƒ¨çš„GC Rootsï¼Œå¯èƒ½åªæ˜¯æŸ¥æ‰¾æŸä¸ªå¯¹è±¡çš„æ•´ä¸ªé“¾è·¯ï¼Œæˆ–è€…ç§°ä¸ºGC Rootsæº¯æºï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨JProfiler</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712113256075.png" alt="image-20200712113256075"></p><h3 id="4-6-å¦‚ä½•åˆ¤æ–­ä»€ä¹ˆåŸå› é€ æˆOOM"><a href="#4-6-å¦‚ä½•åˆ¤æ–­ä»€ä¹ˆåŸå› é€ æˆOOM" class="headerlink" title="4.6 å¦‚ä½•åˆ¤æ–­ä»€ä¹ˆåŸå› é€ æˆOOM"></a>4.6 å¦‚ä½•åˆ¤æ–­ä»€ä¹ˆåŸå› é€ æˆOOM</h3><p>å½“æˆ‘ä»¬ç¨‹åºå‡ºç°OOMçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œæ’æŸ¥ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ä¸‹é¢çš„ä¾‹å­è¿›è¡Œè¯´æ˜</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å†…å­˜æº¢å‡ºæ’æŸ¥</span><span class="hljs-comment"> * -Xms8m -Xmx8m -XX:HeapDumpOnOutOfMemoryError</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeapOOM</span> </span>&#123;    <span class="hljs-comment">// åˆ›å»º1Mçš„æ–‡ä»¶</span>    <span class="hljs-keyword">byte</span> [] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        ArrayList&lt;HeapOOM&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;                list.add(<span class="hljs-keyword">new</span> HeapOOM());                count++;            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.getStackTrace();            System.out.println(<span class="hljs-string">&quot;count:&quot;</span> + count);        &#125;    &#125;&#125;</code></pre></div><p>ä¸Šè¿°ä»£ç å°±æ˜¯ä¸æ–­çš„åˆ›å»ºä¸€ä¸ª1Må°å­—èŠ‚æ•°ç»„ï¼Œç„¶åè®©å†…å­˜æº¢å‡ºï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶ä¸€ä¸‹å†…å­˜å¤§å°ï¼ŒåŒæ—¶ä½¿ç”¨HeapDumpOnOutOfMemoryErrorå°†å‡ºé”™æ—¶å€™çš„dumpæ–‡ä»¶è¾“å‡º</p><div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-deletion">-Xms8m -Xmx8m -XX:HeapDumpOnOutOfMemoryError</span></code></pre></div><p>æˆ‘ä»¬å°†ç”Ÿæˆçš„dumpæ–‡ä»¶æ‰“å¼€ï¼Œç„¶åç‚¹å‡»Biggest Objectså°±èƒ½å¤Ÿçœ‹åˆ°è¶…å¤§å¯¹è±¡</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712150229048.png" alt="image-20200712150229048"></p><p>ç„¶åæˆ‘ä»¬é€šè¿‡çº¿ç¨‹ï¼Œè¿˜èƒ½å¤Ÿå®šä½åˆ°å“ªé‡Œå‡ºç°OOM</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712150303710.png" alt="image-20200712150303710"></p><h2 id="5-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#5-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="5 æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•"></a>5 æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•</h2><p>å½“æˆåŠŸåŒºåˆ†å‡ºå†…å­˜ä¸­å­˜æ´»å¯¹è±¡å’Œæ­»äº¡å¯¹è±¡åï¼ŒGCæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œé‡Šæ”¾æ‰æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚ç›®å‰åœ¨JVMä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‰ç§åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯</p><ul><li>æ ‡è®°ä¸€æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰</li><li>å¤åˆ¶ç®—æ³•ï¼ˆcopyingï¼‰</li><li>æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆMark-Compactï¼‰</li></ul><p>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰æ˜¯ä¸€ç§éå¸¸åŸºç¡€å’Œå¸¸è§çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œè¯¥ç®—æ³•è¢«J.McCarthyç­‰äººåœ¨1960å¹´æå‡ºå¹¶å¹¶åº”ç”¨äºLispè¯­è¨€ã€‚</p><h3 id="5-1-æ‰§è¡Œè¿‡ç¨‹"><a href="#5-1-æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="5.1 æ‰§è¡Œè¿‡ç¨‹"></a>5.1 æ‰§è¡Œè¿‡ç¨‹</h3><p>å½“å †ä¸­çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼ˆavailable memoryï¼‰è¢«è€—å°½çš„æ—¶å€™ï¼Œå°±ä¼šåœæ­¢æ•´ä¸ªç¨‹åºï¼ˆä¹Ÿè¢«ç§°ä¸ºstop the worldï¼‰ï¼Œç„¶åè¿›è¡Œä¸¤é¡¹å·¥ä½œï¼Œç¬¬ä¸€é¡¹åˆ™æ˜¯æ ‡è®°ï¼Œç¬¬äºŒé¡¹åˆ™æ˜¯æ¸…é™¤</p><ul><li><strong>æ ‡è®°</strong>ï¼šCollectorä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œ<strong>æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡</strong>ã€‚ä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ã€‚<ul><li><strong>æ ‡è®°çš„æ˜¯å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸æ˜¯åƒåœ¾ï¼ï¼</strong></li></ul></li><li><strong>æ¸…é™¤</strong>ï¼šCollectorå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§çš„éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶Headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712150935078.png" alt="image-20200712150935078"></p><h3 id="5-2-ä»€ä¹ˆæ˜¯æ¸…é™¤ï¼Ÿ"><a href="#5-2-ä»€ä¹ˆæ˜¯æ¸…é™¤ï¼Ÿ" class="headerlink" title="5.2 ä»€ä¹ˆæ˜¯æ¸…é™¤ï¼Ÿ"></a>5.2 ä»€ä¹ˆæ˜¯æ¸…é™¤ï¼Ÿ</h3><p>è¿™é‡Œæ‰€è°“çš„æ¸…é™¤å¹¶ä¸æ˜¯çœŸçš„ç½®ç©ºï¼Œè€Œæ˜¯æŠŠéœ€è¦æ¸…é™¤çš„å¯¹è±¡åœ°å€ä¿å­˜åœ¨ç©ºé—²çš„åœ°å€åˆ—è¡¨é‡Œã€‚ä¸‹æ¬¡æœ‰æ–°å¯¹è±¡éœ€è¦åŠ è½½æ—¶ï¼Œåˆ¤æ–­åƒåœ¾çš„ä½ç½®ç©ºé—´æ˜¯å¦å¤Ÿï¼Œå¦‚æœå¤Ÿï¼Œå°±å­˜æ”¾è¦†ç›–åŸæœ‰çš„åœ°å€ã€‚</p><p>å…³äºç©ºé—²åˆ—è¡¨æ˜¯åœ¨ä¸ºå¯¹è±¡åˆ†é…å†…å­˜çš„æ—¶å€™ æè¿‡</p><ul><li>å¦‚æœå†…å­˜è§„æ•´<ul><li>é‡‡ç”¨æŒ‡é’ˆç¢°æ’çš„æ–¹å¼è¿›è¡Œå†…å­˜åˆ†é…</li></ul></li><li>å¦‚æœå†…å­˜ä¸è§„æ•´<ul><li>è™šæ‹Ÿæœºéœ€è¦ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨</li><li>ç©ºé—²åˆ—è¡¨åˆ†é…</li></ul></li></ul><h3 id="5-3-ç¼ºç‚¹"><a href="#5-3-ç¼ºç‚¹" class="headerlink" title="5.3 ç¼ºç‚¹"></a>5.3 ç¼ºç‚¹</h3><ul><li>æ ‡è®°æ¸…é™¤ç®—æ³•çš„æ•ˆç‡ä¸ç®—é«˜</li><li>åœ¨è¿›è¡ŒGCçš„æ—¶å€™ï¼Œéœ€è¦åœæ­¢æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œç”¨æˆ·ä½“éªŒè¾ƒå·®</li><li>è¿™ç§æ–¹å¼æ¸…ç†å‡ºæ¥çš„ç©ºé—²å†…å­˜æ˜¯ä¸è¿ç»­çš„ï¼Œäº§ç”Ÿå†…ç¢ç‰‡ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨</li></ul><h2 id="6-æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•"><a href="#6-æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•" class="headerlink" title="6 æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•"></a>6 æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•</h2><h3 id="6-1-èƒŒæ™¯"><a href="#6-1-èƒŒæ™¯" class="headerlink" title="6.1 èƒŒæ™¯"></a>6.1 èƒŒæ™¯</h3><p>ä¸ºäº†è§£å†³æ ‡è®°-æ¸…é™¤ç®—æ³•åœ¨åƒåœ¾æ”¶é›†æ•ˆç‡æ–¹é¢çš„ç¼ºé™·ï¼ŒM.L.Minskyäº1963å¹´å‘è¡¨äº†è‘—åçš„è®ºæ–‡ï¼Œâ€œä½¿ç”¨åŒå­˜å‚¨åŒºçš„Lispè¯­è¨€åƒåœ¾æ”¶é›†å™¨CA LISP Garbage Collector Algorithm Using Serial Secondary Storageï¼‰â€ã€‚M.L.Minskyåœ¨è¯¥è®ºæ–‡ä¸­æè¿°çš„ç®—æ³•è¢«äººä»¬ç§°ä¸ºå¤åˆ¶ï¼ˆCopyingï¼‰ç®—æ³•ï¼Œå®ƒä¹Ÿè¢«M.L.Minskyæœ¬äººæˆåŠŸåœ°å¼•å…¥åˆ°äº†Lispè¯­è¨€çš„ä¸€ä¸ªå®ç°ç‰ˆæœ¬ä¸­ã€‚</p><h3 id="6-2-æ ¸å¿ƒæ€æƒ³"><a href="#6-2-æ ¸å¿ƒæ€æƒ³" class="headerlink" title="6.2 æ ¸å¿ƒæ€æƒ³"></a>6.2 æ ¸å¿ƒæ€æƒ³</h3><p>å°†æ´»ç€çš„å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œæœ€åå®Œæˆåƒåœ¾å›æ”¶</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712151916991.png" alt="image-20200712151916991"></p><p>æŠŠå¯è¾¾çš„å¯¹è±¡ï¼Œç›´æ¥å¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåŒºåŸŸä¸­å¤åˆ¶å®Œæˆåï¼ŒAåŒºå°±æ²¡æœ‰ç”¨äº†ï¼Œé‡Œé¢çš„å¯¹è±¡å¯ä»¥ç›´æ¥æ¸…é™¤æ‰ï¼Œå…¶å®é‡Œé¢çš„æ–°ç”Ÿä»£é‡Œé¢å°±ç”¨åˆ°äº†å¤åˆ¶ç®—æ³•</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712152029615.png" alt="image-20200712152029615"></p><h3 id="6-3-ä¼˜ç‚¹"><a href="#6-3-ä¼˜ç‚¹" class="headerlink" title="6.3 ä¼˜ç‚¹"></a>6.3 ä¼˜ç‚¹</h3><ul><li>æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆ</li><li>å¤åˆ¶è¿‡å»ä»¥åä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°â€œç¢ç‰‡â€é—®é¢˜ã€‚</li></ul><h3 id="6-4-ç¼ºç‚¹"><a href="#6-4-ç¼ºç‚¹" class="headerlink" title="6.4 ç¼ºç‚¹"></a>6.4 ç¼ºç‚¹</h3><ul><li>æ­¤ç®—æ³•çš„ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå°±æ˜¯éœ€è¦ä¸¤å€çš„å†…å­˜ç©ºé—´ã€‚</li><li>å¯¹äºG1è¿™ç§åˆ†æ‹†æˆä¸ºå¤§é‡regionçš„GCï¼Œå¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œæ„å‘³ç€GCéœ€è¦ç»´æŠ¤regionä¹‹é—´å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œä¸ç®¡æ˜¯å†…å­˜å ç”¨æˆ–è€…æ—¶é—´å¼€é”€ä¹Ÿä¸å°</li></ul><h3 id="6-5-æ³¨æ„"><a href="#6-5-æ³¨æ„" class="headerlink" title="6.5 æ³¨æ„"></a>6.5 æ³¨æ„</h3><p>å¦‚æœç³»ç»Ÿä¸­çš„åƒåœ¾å¯¹è±¡å¾ˆå¤šï¼Œå¤åˆ¶ç®—æ³•éœ€è¦å¤åˆ¶çš„å­˜æ´»å¯¹è±¡æ•°é‡å¹¶ä¸ä¼šå¤ªå¤§ï¼Œæˆ–è€…è¯´éå¸¸ä½æ‰è¡Œï¼ˆè€å¹´ä»£å¤§é‡çš„å¯¹è±¡å­˜æ´»ï¼Œé‚£ä¹ˆå¤åˆ¶çš„å¯¹è±¡å°†ä¼šæœ‰å¾ˆå¤šï¼Œæ•ˆç‡ä¼šå¾ˆä½ï¼‰</p><p>åœ¨æ–°ç”Ÿä»£ï¼Œå¯¹å¸¸è§„åº”ç”¨çš„åƒåœ¾å›æ”¶ï¼Œä¸€æ¬¡é€šå¸¸å¯ä»¥å›æ”¶70% - 99% çš„å†…å­˜ç©ºé—´ã€‚å›æ”¶æ€§ä»·æ¯”å¾ˆé«˜ã€‚æ‰€ä»¥ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½æ˜¯ç”¨è¿™ç§æ”¶é›†ç®—æ³•å›æ”¶æ–°ç”Ÿä»£ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712152847218.png" alt="image-20200712152847218"></p><h2 id="7-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ•´ç†ç®—æ³•"><a href="#7-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ•´ç†ç®—æ³•" class="headerlink" title="7 æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ•´ç†ç®—æ³•"></a>7 æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ•´ç†ç®—æ³•</h2><h3 id="7-1-èƒŒæ™¯"><a href="#7-1-èƒŒæ™¯" class="headerlink" title="7.1 èƒŒæ™¯"></a>7.1 èƒŒæ™¯</h3><p>å¤åˆ¶ç®—æ³•çš„é«˜æ•ˆæ€§æ˜¯å»ºç«‹åœ¨å­˜æ´»å¯¹è±¡å°‘ã€åƒåœ¾å¯¹è±¡å¤šçš„å‰æä¸‹çš„ã€‚è¿™ç§æƒ…å†µåœ¨æ–°ç”Ÿä»£ç»å¸¸å‘ç”Ÿï¼Œä½†æ˜¯åœ¨è€å¹´ä»£ï¼Œæ›´å¸¸è§çš„æƒ…å†µæ˜¯å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯å­˜æ´»å¯¹è±¡ã€‚å¦‚æœä¾ç„¶ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œç”±äºå­˜æ´»å¯¹è±¡è¾ƒå¤šï¼Œå¤åˆ¶çš„æˆæœ¬ä¹Ÿå°†å¾ˆé«˜ã€‚å› æ­¤ï¼ŒåŸºäºè€å¹´ä»£åƒåœ¾å›æ”¶çš„ç‰¹æ€§ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–çš„ç®—æ³•ã€‚</p><p>æ ‡è®°ä¸€æ¸…é™¤ç®—æ³•çš„ç¡®å¯ä»¥åº”ç”¨åœ¨è€å¹´ä»£ä¸­ï¼Œä½†æ˜¯è¯¥ç®—æ³•ä¸ä»…æ‰§è¡Œæ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”åœ¨æ‰§è¡Œå®Œå†…å­˜å›æ”¶åè¿˜ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œæ‰€ä»¥JvMçš„è®¾è®¡è€…éœ€è¦åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œæ”¹è¿›ã€‚æ ‡è®°-å‹ç¼©ï¼ˆMark-Compactï¼‰ç®—æ³•ç”±æ­¤è¯ç”Ÿã€‚</p><p>1970å¹´å‰åï¼ŒG.L.Steeleã€C.J.Cheneå’ŒD.s.Wiseç­‰ç ”ç©¶è€…å‘å¸ƒæ ‡è®°-å‹ç¼©ç®—æ³•ã€‚åœ¨è®¸å¤šç°ä»£çš„åƒåœ¾æ”¶é›†å™¨ä¸­ï¼Œäººä»¬éƒ½ä½¿ç”¨äº†æ ‡è®°-å‹ç¼©ç®—æ³•æˆ–å…¶æ”¹è¿›ç‰ˆæœ¬ã€‚</p><h3 id="7-2-æ‰§è¡Œè¿‡ç¨‹"><a href="#7-2-æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="7.2 æ‰§è¡Œè¿‡ç¨‹"></a>7.2 æ‰§è¡Œè¿‡ç¨‹</h3><p>ç¬¬ä¸€é˜¶æ®µå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨å¯¹è±¡</p><p>ç¬¬äºŒé˜¶æ®µå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾ã€‚ä¹‹åï¼Œæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712153236508.png" alt="image-20200712153236508"></p><h3 id="7-3-æ ‡æ¸…å’Œæ ‡æ•´çš„åŒºåˆ«"><a href="#7-3-æ ‡æ¸…å’Œæ ‡æ•´çš„åŒºåˆ«" class="headerlink" title="7.3 æ ‡æ¸…å’Œæ ‡æ•´çš„åŒºåˆ«"></a>7.3 æ ‡æ¸…å’Œæ ‡æ•´çš„åŒºåˆ«</h3><p>æ ‡è®°-å‹ç¼©ç®—æ³•çš„æœ€ç»ˆæ•ˆæœç­‰åŒäºæ ‡è®°-æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç§°ä¸ºæ ‡è®°-æ¸…é™¤-å‹ç¼©ï¼ˆMark-Sweep-Compactï¼‰ç®—æ³•ã€‚</p><p>äºŒè€…çš„æœ¬è´¨å·®å¼‚åœ¨äºæ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯ä¸€ç§éç§»åŠ¨å¼çš„å›æ”¶ç®—æ³•ï¼Œæ ‡è®°-å‹ç¼©æ˜¯ç§»åŠ¨å¼çš„ã€‚æ˜¯å¦ç§»åŠ¨å›æ”¶åçš„å­˜æ´»å¯¹è±¡æ˜¯ä¸€é¡¹ä¼˜ç¼ºç‚¹å¹¶å­˜çš„é£é™©å†³ç­–ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ ‡è®°çš„å­˜æ´»å¯¹è±¡å°†ä¼šè¢«æ•´ç†ï¼ŒæŒ‰ç…§å†…å­˜åœ°å€ä¾æ¬¡æ’åˆ—ï¼Œè€Œæœªè¢«æ ‡è®°çš„å†…å­˜ä¼šè¢«æ¸…ç†æ‰ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ï¼Œè¿™æ¯”ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ˜¾ç„¶å°‘äº†è®¸å¤šå¼€é”€ã€‚</p><h3 id="7-4-æ ‡æ•´çš„ä¼˜ç¼ºç‚¹"><a href="#7-4-æ ‡æ•´çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="7.4 æ ‡æ•´çš„ä¼˜ç¼ºç‚¹"></a>7.4 æ ‡æ•´çš„ä¼˜ç¼ºç‚¹</h3><h4 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul><li>æ¶ˆé™¤äº†æ ‡è®°-æ¸…é™¤ç®—æ³•å½“ä¸­ï¼Œå†…å­˜åŒºåŸŸåˆ†æ•£çš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ã€‚</li><li>æ¶ˆé™¤äº†å¤åˆ¶ç®—æ³•å½“ä¸­ï¼Œå†…å­˜å‡åŠçš„é«˜é¢ä»£ä»·ã€‚</li></ul><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul><li>ä»æ•ˆç‡ä¸Šæ¥è¯´ï¼Œæ ‡è®°-æ•´ç†ç®—æ³•è¦ä½äºå¤åˆ¶ç®—æ³•ã€‚</li><li>ç§»åŠ¨å¯¹è±¡çš„åŒæ—¶ï¼Œå¦‚æœå¯¹è±¡è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œåˆ™è¿˜éœ€è¦è°ƒæ•´å¼•ç”¨çš„åœ°å€</li><li>ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…¨ç¨‹æš‚åœç”¨æˆ·åº”ç”¨ç¨‹åºã€‚å³ï¼šSTW</li></ul><h2 id="8-å°ç»“"><a href="#8-å°ç»“" class="headerlink" title="8 å°ç»“"></a>8 å°ç»“</h2><p>æ•ˆç‡ä¸Šæ¥è¯´ï¼Œå¤åˆ¶ç®—æ³•æ˜¯å½“ä¹‹æ— æ„§çš„è€å¤§ï¼Œä½†æ˜¯å´æµªè´¹äº†å¤ªå¤šå†…å­˜ã€‚</p><p>è€Œä¸ºäº†å°½é‡å…¼é¡¾ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæŒ‡æ ‡ï¼Œæ ‡è®°-æ•´ç†ç®—æ³•ç›¸å¯¹æ¥è¯´æ›´å¹³æ»‘ä¸€äº›ï¼Œä½†æ˜¯æ•ˆç‡ä¸Šä¸å°½å¦‚äººæ„ï¼Œå®ƒæ¯”å¤åˆ¶ç®—æ³•å¤šäº†ä¸€ä¸ªæ ‡è®°çš„é˜¶æ®µï¼Œæ¯”æ ‡è®°-æ¸…é™¤å¤šäº†ä¸€ä¸ªæ•´ç†å†…å­˜çš„é˜¶æ®µã€‚</p><table><thead><tr><th></th><th>æ ‡è®°æ¸…é™¤</th><th>æ ‡è®°æ•´ç†</th><th>å¤åˆ¶</th></tr></thead><tbody><tr><td><strong>é€Ÿç‡</strong></td><td>ä¸­ç­‰</td><td>æœ€æ…¢</td><td>æœ€å¿«</td></tr><tr><td><strong>ç©ºé—´å¼€é”€</strong></td><td>å°‘ï¼ˆä½†ä¼šå †ç§¯ç¢ç‰‡ï¼‰</td><td>å°‘ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰</td><td>é€šå¸¸éœ€è¦æ´»å¯¹è±¡çš„2å€ç©ºé—´ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰</td></tr><tr><td><strong>ç§»åŠ¨å¯¹è±¡</strong></td><td>å¦</td><td>æ˜¯</td><td>æ˜¯</td></tr></tbody></table><p>ç»¼åˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ï¼Œæ²¡æœ‰æœ€å¥½çš„ç®—æ³•ï¼Œåªæœ‰æœ€åˆé€‚çš„ç®—æ³•</p><h3 id="åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="åˆ†ä»£æ”¶é›†ç®—æ³•"></a>åˆ†ä»£æ”¶é›†ç®—æ³•</h3><p>å‰é¢æ‰€æœ‰è¿™äº›ç®—æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰ä¸€ç§ç®—æ³•å¯ä»¥å®Œå…¨æ›¿ä»£å…¶ä»–ç®—æ³•ï¼Œå®ƒä»¬éƒ½å…·æœ‰è‡ªå·±ç‹¬ç‰¹çš„ä¼˜åŠ¿å’Œç‰¹ç‚¹ã€‚åˆ†ä»£æ”¶é›†ç®—æ³•åº”è¿è€Œç”Ÿã€‚</p><p>åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œæ˜¯åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼šä¸åŒçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡å¯ä»¥é‡‡å–ä¸åŒçš„æ”¶é›†æ–¹å¼ï¼Œä»¥ä¾¿æé«˜å›æ”¶æ•ˆç‡ã€‚ä¸€èˆ¬æ˜¯æŠŠJavaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹ä½¿ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•ï¼Œä»¥æé«˜åƒåœ¾å›æ”¶çš„æ•ˆç‡ã€‚</p><p>åœ¨Javaç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„å¯¹è±¡ï¼Œå…¶ä¸­æœ‰äº›å¯¹è±¡æ˜¯ä¸ä¸šåŠ¡ä¿¡æ¯ç›¸å…³ï¼Œæ¯”å¦‚Httpè¯·æ±‚ä¸­çš„Sessionå¯¹è±¡ã€çº¿ç¨‹ã€Socketè¿æ¥ï¼Œè¿™ç±»å¯¹è±¡è·Ÿä¸šåŠ¡ç›´æ¥æŒ‚é’©ï¼Œå› æ­¤ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€äº›å¯¹è±¡ï¼Œä¸»è¦æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶å˜é‡ï¼Œè¿™äº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¼šæ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚ï¼šstringå¯¹è±¡ï¼Œç”±äºå…¶ä¸å˜ç±»çš„ç‰¹æ€§ï¼Œç³»ç»Ÿä¼šäº§ç”Ÿå¤§é‡çš„è¿™äº›å¯¹è±¡ï¼Œæœ‰äº›å¯¹è±¡ç”šè‡³åªç”¨ä¸€æ¬¡å³å¯å›æ”¶ã€‚</p><p>ç›®å‰å‡ ä¹æ‰€æœ‰çš„GCéƒ½é‡‡ç”¨åˆ†ä»£æ‰‹æœºç®—æ³•æ‰§è¡Œåƒåœ¾å›æ”¶çš„</p><p>åœ¨HotSpotä¸­ï¼ŒåŸºäºåˆ†ä»£çš„æ¦‚å¿µï¼ŒGCæ‰€ä½¿ç”¨çš„å†…å­˜å›æ”¶ç®—æ³•å¿…é¡»ç»“åˆå¹´è½»ä»£å’Œè€å¹´ä»£å„è‡ªçš„ç‰¹ç‚¹ã€‚</p><ul><li>å¹´è½»ä»£ï¼ˆYoung Genï¼‰</li></ul><p>å¹´è½»ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸç›¸å¯¹è€å¹´ä»£è¾ƒå°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ã€å­˜æ´»ç‡ä½ï¼Œå›æ”¶é¢‘ç¹ã€‚</p><p>è¿™ç§æƒ…å†µå¤åˆ¶ç®—æ³•çš„å›æ”¶æ•´ç†ï¼Œé€Ÿåº¦æ˜¯æœ€å¿«çš„ã€‚å¤åˆ¶ç®—æ³•çš„æ•ˆç‡åªå’Œå½“å‰å­˜æ´»å¯¹è±¡å¤§å°æœ‰å…³ï¼Œå› æ­¤å¾ˆé€‚ç”¨äºå¹´è½»ä»£çš„å›æ”¶ã€‚è€Œå¤åˆ¶ç®—æ³•å†…å­˜åˆ©ç”¨ç‡ä¸é«˜çš„é—®é¢˜ï¼Œé€šè¿‡hotspotä¸­çš„ä¸¤ä¸ªsurvivorçš„è®¾è®¡å¾—åˆ°ç¼“è§£ã€‚</p><ul><li>è€å¹´ä»£ï¼ˆTenured Genï¼‰</li></ul><p>è€å¹´ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸè¾ƒå¤§ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé•¿ã€å­˜æ´»ç‡é«˜ï¼Œå›æ”¶ä¸åŠå¹´è½»ä»£é¢‘ç¹ã€‚</p><p>è¿™ç§æƒ…å†µå­˜åœ¨å¤§é‡å­˜æ´»ç‡é«˜çš„å¯¹è±¡ï¼Œå¤åˆ¶ç®—æ³•æ˜æ˜¾å˜å¾—ä¸åˆé€‚ã€‚ä¸€èˆ¬æ˜¯ç”±æ ‡è®°-æ¸…é™¤æˆ–è€…æ˜¯æ ‡è®°-æ¸…é™¤ä¸æ ‡è®°-æ•´ç†çš„æ··åˆå®ç°ã€‚</p><ul><li>Marké˜¶æ®µçš„å¼€é”€ä¸å­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ã€‚</li><li>Sweepé˜¶æ®µçš„å¼€é”€ä¸æ‰€ç®¡ç†åŒºåŸŸçš„å¤§å°æˆæ­£ç›¸å…³ã€‚</li><li>compacté˜¶æ®µçš„å¼€é”€ä¸å­˜æ´»å¯¹è±¡çš„æ•°æ®æˆæ­£æ¯”ã€‚</li></ul><p>ä»¥HotSpotä¸­çš„CMSå›æ”¶å™¨ä¸ºä¾‹ï¼ŒCMSæ˜¯åŸºäºMark-Sweepå®ç°çš„ï¼Œå¯¹äºå¯¹è±¡çš„å›æ”¶æ•ˆç‡å¾ˆé«˜ã€‚è€Œå¯¹äºç¢ç‰‡é—®é¢˜ï¼ŒCMSé‡‡ç”¨åŸºäºMark-Compactç®—æ³•çš„Serial oldå›æ”¶å™¨ä½œä¸ºè¡¥å¿æªæ–½ï¼šå½“å†…å­˜å›æ”¶ä¸ä½³ï¼ˆç¢ç‰‡å¯¼è‡´çš„Concurrent Mode Failureæ—¶ï¼‰ï¼Œå°†é‡‡ç”¨serial oldæ‰§è¡ŒFullGCä»¥è¾¾åˆ°å¯¹è€å¹´ä»£å†…å­˜çš„æ•´ç†ã€‚</p><p>åˆ†ä»£çš„æ€æƒ³è¢«ç°æœ‰çš„è™šæ‹Ÿæœºå¹¿æ³›ä½¿ç”¨ã€‚å‡ ä¹æ‰€æœ‰çš„åƒåœ¾å›æ”¶å™¨éƒ½åŒºåˆ†æ–°ç”Ÿä»£å’Œè€å¹´ä»£</p><h2 id="9-å¢é‡æ”¶é›†ç®—æ³•"><a href="#9-å¢é‡æ”¶é›†ç®—æ³•" class="headerlink" title="9 å¢é‡æ”¶é›†ç®—æ³•"></a>9 å¢é‡æ”¶é›†ç®—æ³•</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§stop the Worldçš„çŠ¶æ€ã€‚åœ¨stop the WorldçŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹å®æ—¶åƒåœ¾æ”¶é›†ç®—æ³•çš„ç ”ç©¶ç›´æ¥å¯¼è‡´äº†å¢é‡æ”¶é›†ï¼ˆIncremental Collectingï¼‰ç®—æ³•çš„è¯ç”Ÿã€‚</p><p>å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œéœ€è¦é€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾æ”¶é›†çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾æ”¶é›†çº¿ç¨‹åªæ”¶é›†ä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ã€‚ä¾æ¬¡åå¤ï¼Œç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå¢é‡æ”¶é›†ç®—æ³•çš„åŸºç¡€ä»æ˜¯ä¼ ç»Ÿçš„æ ‡è®°-æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚<strong>å¢é‡æ”¶é›†ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†</strong>ï¼Œå…è®¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œ</p><h3 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç”±äºåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œé—´æ–­æ€§åœ°è¿˜æ‰§è¡Œäº†åº”ç”¨ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èƒ½å‡å°‘ç³»ç»Ÿçš„åœé¡¿æ—¶é—´ã€‚ä½†æ˜¯ï¼Œå› ä¸ºçº¿ç¨‹åˆ‡æ¢å’Œä¸Šä¸‹æ–‡è½¬æ¢çš„æ¶ˆè€—ï¼Œä¼šä½¿å¾—åƒåœ¾å›æ”¶çš„æ€»ä½“æˆæœ¬ä¸Šå‡ï¼Œé€ æˆç³»ç»Ÿååé‡çš„ä¸‹é™ã€‚</p><h2 id="10-åˆ†åŒºç®—æ³•"><a href="#10-åˆ†åŒºç®—æ³•" class="headerlink" title="10 åˆ†åŒºç®—æ³•"></a>10 åˆ†åŒºç®—æ³•</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œå †ç©ºé—´è¶Šå¤§ï¼Œä¸€æ¬¡Gcæ—¶æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œæœ‰å…³GCäº§ç”Ÿçš„åœé¡¿ä¹Ÿè¶Šé•¿ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶GCäº§ç”Ÿçš„åœé¡¿æ—¶é—´ï¼Œå°†ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸåˆ†å‰²æˆå¤šä¸ªå°å—ï¼Œæ ¹æ®ç›®æ ‡çš„åœé¡¿æ—¶é—´ï¼Œæ¯æ¬¡åˆç†åœ°å›æ”¶è‹¥å¹²ä¸ªå°åŒºé—´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå †ç©ºé—´ï¼Œä»è€Œå‡å°‘ä¸€æ¬¡GCæ‰€äº§ç”Ÿçš„åœé¡¿ã€‚</p><p>åˆ†ä»£ç®—æ³•å°†æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•å°†æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒå°åŒºé—´ã€‚<br>æ¯ä¸€ä¸ªå°åŒºé—´éƒ½ç‹¬ç«‹ä½¿ç”¨ï¼Œç‹¬ç«‹å›æ”¶ã€‚è¿™ç§ç®—æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æ§åˆ¶ä¸€æ¬¡å›æ”¶å¤šå°‘ä¸ªå°åŒºé—´ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712165318590.png" alt="image-20200712165318590"></p><h2 id="11-å†™åˆ°æœ€å"><a href="#11-å†™åˆ°æœ€å" class="headerlink" title="11 å†™åˆ°æœ€å"></a>11 å†™åˆ°æœ€å</h2><p>æ³¨æ„ï¼Œè¿™äº›åªæ˜¯åŸºæœ¬çš„ç®—æ³•æ€è·¯ï¼Œå®é™…GCå®ç°è¿‡ç¨‹è¦å¤æ‚çš„å¤šï¼Œç›®å‰è¿˜åœ¨å‘å±•ä¸­çš„å‰æ²¿GCéƒ½æ˜¯å¤åˆç®—æ³•ï¼Œå¹¶ä¸”å¹¶è¡Œå’Œå¹¶å‘å…¼å¤‡ã€‚</p><h1 id="ç¬¬16ç« -åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µ"><a href="#ç¬¬16ç« -åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç¬¬16ç«  åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µ"></a>ç¬¬16ç«  åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µ</h1><h2 id="1-System-gc-çš„ç†è§£"><a href="#1-System-gc-çš„ç†è§£" class="headerlink" title="1 System.gc()çš„ç†è§£"></a>1 System.gc()çš„ç†è§£</h2><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡system.gcï¼ˆï¼‰è€…Runtime.getRuntime().gc() çš„è°ƒç”¨ï¼Œä¼šæ˜¾å¼è§¦å‘FullGCï¼ŒåŒæ—¶å¯¹è€å¹´ä»£å’Œæ–°ç”Ÿä»£è¿›è¡Œå›æ”¶ï¼Œå°è¯•é‡Šæ”¾è¢«ä¸¢å¼ƒå¯¹è±¡å ç”¨çš„å†…å­˜ã€‚</p><p>ç„¶è€Œsystem.gc() )è°ƒç”¨é™„å¸¦ä¸€ä¸ªå…è´£å£°æ˜ï¼Œæ— æ³•ä¿è¯å¯¹åƒåœ¾æ”¶é›†å™¨çš„è°ƒç”¨ã€‚(ä¸èƒ½ç¡®ä¿ç«‹å³ç”Ÿæ•ˆ)</p><p>JVMå®ç°è€…å¯ä»¥é€šè¿‡system.gc() è°ƒç”¨æ¥å†³å®šJVMçš„GCè¡Œä¸ºã€‚è€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåƒåœ¾å›æ”¶åº”è¯¥æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œæ— é¡»æ‰‹åŠ¨è§¦å‘ï¼Œå¦åˆ™å°±å¤ªè¿‡äºéº»çƒ¦äº†ã€‚åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ€§èƒ½åŸºå‡†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œä¹‹é—´è°ƒç”¨System.gc() </p><p>ä»£ç æ¼”ç¤ºæ˜¯å¦å‡ºå‘GCæ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * System.gc()</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemGCTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">new</span> SystemGCTest();        <span class="hljs-comment">// æé†’JVMè¿›è¡Œåƒåœ¾å›æ”¶</span>        System.gc();        <span class="hljs-comment">//System.runFinalization();</span>    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;        <span class="hljs-keyword">super</span>.finalize();        System.out.println(<span class="hljs-string">&quot;SystemGCTest æ‰§è¡Œäº† finalizeæ–¹æ³•&quot;</span>);    &#125;&#125;</code></pre></div><p>è¿è¡Œç»“æœï¼Œä½†æ˜¯ä¸ä¸€å®šä¼šè§¦å‘é”€æ¯çš„æ–¹æ³•ï¼Œè°ƒç”¨System.runFinalization()ä¼šå¼ºåˆ¶è°ƒç”¨ å¤±å»å¼•ç”¨å¯¹è±¡çš„finalize()</p><div class="code-wrapper"><pre><code class="hljs mercury">SystemGCTest æ‰§è¡Œäº† <span class="hljs-keyword">finalize</span>æ–¹æ³•</code></pre></div><h3 id="æ‰‹åŠ¨GCæ¥ç†è§£ä¸å¯è¾¾å¯¹è±¡çš„å›æ”¶"><a href="#æ‰‹åŠ¨GCæ¥ç†è§£ä¸å¯è¾¾å¯¹è±¡çš„å›æ”¶" class="headerlink" title="æ‰‹åŠ¨GCæ¥ç†è§£ä¸å¯è¾¾å¯¹è±¡çš„å›æ”¶"></a>æ‰‹åŠ¨GCæ¥ç†è§£ä¸å¯è¾¾å¯¹è±¡çš„å›æ”¶</h3><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * å±€éƒ¨å˜é‡å›æ”¶</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalVarGC</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è§¦å‘Minor GCæ²¡æœ‰å›æ”¶å¯¹è±¡ï¼Œç„¶ååœ¨è§¦å‘Full GCå°†è¯¥å¯¹è±¡å­˜å…¥oldåŒº</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC1</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];        System.gc();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è§¦å‘YoungGCçš„æ—¶å€™ï¼Œå·²ç»è¢«å›æ”¶äº†</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC2</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];        buffer = <span class="hljs-keyword">null</span>;        System.gc();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¸ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC3</span><span class="hljs-params">()</span> </span>&#123;        &#123;            <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];        &#125;        System.gc();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­ï¼Œä½†æ˜¯åé¢å®šä¹‰çš„valueæŠŠè¿™ä¸ªæ§½ç»™æ›¿æ¢äº†</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC4</span><span class="hljs-params">()</span> </span>&#123;        &#123;            <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];        &#125;        <span class="hljs-keyword">int</span> value = <span class="hljs-number">10</span>;        System.gc();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * localvarGC5ä¸­çš„æ•°ç»„å·²ç»è¢«å›æ”¶</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC5</span><span class="hljs-params">()</span> </span>&#123;        localvarGC1();        System.gc();    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        LocalVarGC localVarGC = <span class="hljs-keyword">new</span> LocalVarGC();        localVarGC.localvarGC3();    &#125;&#125;</code></pre></div><h2 id="2-å†…å­˜æº¢å‡º"><a href="#2-å†…å­˜æº¢å‡º" class="headerlink" title="2 å†…å­˜æº¢å‡º"></a>2 å†…å­˜æº¢å‡º</h2><p>å†…å­˜æº¢å‡ºç›¸å¯¹äºå†…å­˜æ³„æ¼æ¥è¯´ï¼Œå°½ç®¡æ›´å®¹æ˜“è¢«ç†è§£ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œå†…å­˜æº¢å‡ºä¹Ÿæ˜¯å¼•å‘ç¨‹åºå´©æºƒçš„ç½ªé­ç¥¸é¦–ä¹‹ä¸€ã€‚</p><p>ç”±äºGCä¸€ç›´åœ¨å‘å±•ï¼Œæ‰€æœ‰ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™¤éåº”ç”¨ç¨‹åºå ç”¨çš„å†…å­˜å¢é•¿é€Ÿåº¦éå¸¸å¿«ï¼Œé€ æˆåƒåœ¾å›æ”¶å·²ç»è·Ÿä¸ä¸Šå†…å­˜æ¶ˆè€—çš„é€Ÿåº¦ï¼Œå¦åˆ™ä¸å¤ªå®¹æ˜“å‡ºç°ooMçš„æƒ…å†µã€‚</p><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGCä¼šè¿›è¡Œå„ç§å¹´é¾„æ®µçš„åƒåœ¾å›æ”¶ï¼Œå®åœ¨ä¸è¡Œäº†å°±æ”¾å¤§æ‹›ï¼Œæ¥ä¸€æ¬¡ç‹¬å å¼çš„Fu11GCæ“ä½œï¼Œè¿™æ—¶å€™ä¼šå›æ”¶å¤§é‡çš„å†…å­˜ï¼Œä¾›åº”ç”¨ç¨‹åºç»§ç»­ä½¿ç”¨ã€‚</p><p>javadocä¸­å¯¹outofMemoryErrorçš„è§£é‡Šæ˜¯ï¼Œæ²¡æœ‰ç©ºé—²å†…å­˜ï¼Œå¹¶ä¸”åƒåœ¾æ”¶é›†å™¨ä¹Ÿæ— æ³•æä¾›æ›´å¤šå†…å­˜ã€‚</p><p>é¦–å…ˆè¯´æ²¡æœ‰ç©ºé—²å†…å­˜çš„æƒ…å†µï¼šè¯´æ˜Javaè™šæ‹Ÿæœºçš„å †å†…å­˜ä¸å¤Ÿã€‚åŸå› æœ‰äºŒï¼š</p><ul><li>Javaè™šæ‹Ÿæœºçš„å †å†…å­˜è®¾ç½®ä¸å¤Ÿã€‚</li></ul><p>æ¯”å¦‚ï¼šå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ï¼›ä¹Ÿå¾ˆæœ‰å¯èƒ½å°±æ˜¯å †çš„å¤§å°ä¸åˆç†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦å¤„ç†æ¯”è¾ƒå¯è§‚çš„æ•°æ®é‡ï¼Œä½†æ˜¯æ²¡æœ‰æ˜¾å¼æŒ‡å®šJVMå †å¤§å°æˆ–è€…æŒ‡å®šæ•°å€¼åå°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°-Xms ã€-Xmxæ¥è°ƒæ•´ã€‚</p><ul><li>ä»£ç ä¸­åˆ›å»ºäº†å¤§é‡å¤§å¯¹è±¡ï¼Œå¹¶ä¸”é•¿æ—¶é—´ä¸èƒ½è¢«åƒåœ¾æ”¶é›†å™¨æ”¶é›†ï¼ˆå­˜åœ¨è¢«å¼•ç”¨ï¼‰</li></ul><p>å¯¹äºè€ç‰ˆæœ¬çš„oracle JDKï¼Œå› ä¸ºæ°¸ä¹…ä»£çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå¹¶ä¸”JVMå¯¹æ°¸ä¹…ä»£åƒåœ¾å›æ”¶ï¼ˆå¦‚ï¼Œå¸¸é‡æ± å›æ”¶ã€å¸è½½ä¸å†éœ€è¦çš„ç±»å‹ï¼‰éå¸¸ä¸ç§¯æï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä¸æ–­æ·»åŠ æ–°ç±»å‹çš„æ—¶å€™ï¼Œæ°¸ä¹…ä»£å‡ºç°OutOfMemoryErrorä¹Ÿéå¸¸å¤šè§ï¼Œå°¤å…¶æ˜¯åœ¨è¿è¡Œæ—¶å­˜åœ¨å¤§é‡åŠ¨æ€ç±»å‹ç”Ÿæˆçš„åœºåˆï¼›ç±»ä¼¼internå­—ç¬¦ä¸²ç¼“å­˜å ç”¨å¤ªå¤šç©ºé—´ï¼Œä¹Ÿä¼šå¯¼è‡´OOMé—®é¢˜ã€‚å¯¹åº”çš„å¼‚å¸¸ä¿¡æ¯ï¼Œä¼šæ ‡è®°å‡ºæ¥å’Œæ°¸ä¹…ä»£ç›¸å…³ï¼šâ€œjava.lang.OutOfMemoryError:PermGen spaceâ€ã€‚</p><p>éšç€å…ƒæ•°æ®åŒºçš„å¼•å…¥ï¼Œæ–¹æ³•åŒºå†…å­˜å·²ç»ä¸å†é‚£ä¹ˆçª˜è¿«ï¼Œæ‰€ä»¥ç›¸åº”çš„ooMæœ‰æ‰€æ”¹è§‚ï¼Œå‡ºç°ooMï¼Œå¼‚å¸¸ä¿¡æ¯åˆ™å˜æˆäº†ï¼šâ€œjava.lang.OutofMemoryError:Metaspaceâ€ã€‚ç›´æ¥å†…å­˜ä¸è¶³ï¼Œä¹Ÿä¼šå¯¼è‡´OOMã€‚</p><p>è¿™é‡Œé¢éšå«ç€ä¸€å±‚æ„æ€æ˜¯ï¼Œåœ¨æŠ›å‡ºOutofMemoryErrorä¹‹å‰ï¼Œé€šå¸¸åƒåœ¾æ”¶é›†å™¨ä¼šè¢«è§¦å‘ï¼Œå°½å…¶æ‰€èƒ½å»æ¸…ç†å‡ºç©ºé—´ã€‚</p><blockquote><p>ä¾‹å¦‚ï¼šåœ¨å¼•ç”¨æœºåˆ¶åˆ†æä¸­ï¼Œæ¶‰åŠåˆ°JVMä¼šå»å°è¯•å›æ”¶è½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ç­‰ã€‚<br>åœ¨java.nio.BIts.reserveMemoryï¼ˆï¼‰æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬èƒ½æ¸…æ¥šçš„çœ‹åˆ°ï¼ŒSystem.gcï¼ˆï¼‰ä¼šè¢«è°ƒç”¨ï¼Œä»¥æ¸…ç†ç©ºé—´ã€‚</p></blockquote><p>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹åƒåœ¾æ”¶é›†å™¨éƒ½ä¼šè¢«è§¦å‘çš„</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å»åˆ†é…ä¸€ä¸ªè¶…å¤§å¯¹è±¡ï¼Œç±»ä¼¼ä¸€ä¸ªè¶…å¤§æ•°ç»„è¶…è¿‡å †çš„æœ€å¤§å€¼ï¼ŒJVMå¯ä»¥åˆ¤æ–­å‡ºåƒåœ¾æ”¶é›†å¹¶ä¸èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ç›´æ¥æŠ›å‡ºOutofMemoryErrorã€‚</p><h2 id="3-å†…å­˜æ³„æ¼"><a href="#3-å†…å­˜æ³„æ¼" class="headerlink" title="3 å†…å­˜æ³„æ¼"></a>3 å†…å­˜æ³„æ¼</h2><p>ä¹Ÿç§°ä½œâ€œå­˜å‚¨æ¸—æ¼â€ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œåªæœ‰å¯¹è±¡ä¸ä¼šå†è¢«ç¨‹åºç”¨åˆ°äº†ï¼Œä½†æ˜¯GCåˆä¸èƒ½å›æ”¶ä»–ä»¬çš„æƒ…å†µï¼Œæ‰å«å†…å­˜æ³„æ¼ã€‚</p><p>ä½†å®é™…æƒ…å†µå¾ˆå¤šæ—¶å€™ä¸€äº›ä¸å¤ªå¥½çš„å®è·µï¼ˆæˆ–ç–å¿½ï¼‰ä¼šå¯¼è‡´å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå˜å¾—å¾ˆé•¿ç”šè‡³å¯¼è‡´00Mï¼Œä¹Ÿå¯ä»¥å«åšå®½æ³›æ„ä¹‰ä¸Šçš„â€œå†…å­˜æ³„æ¼â€ã€‚</p><p>å°½ç®¡å†…å­˜æ³„æ¼å¹¶ä¸ä¼šç«‹åˆ»å¼•èµ·ç¨‹åºå´©æºƒï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç¨‹åºä¸­çš„å¯ç”¨å†…å­˜å°±ä¼šè¢«é€æ­¥èš•é£Ÿï¼Œç›´è‡³è€—å°½æ‰€æœ‰å†…å­˜ï¼Œæœ€ç»ˆå‡ºç°outofMemoryå¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>æ³¨æ„ï¼Œè¿™é‡Œçš„å­˜å‚¨ç©ºé—´å¹¶ä¸æ˜¯æŒ‡ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æŒ‡è™šæ‹Ÿå†…å­˜å¤§å°ï¼Œè¿™ä¸ªè™šæ‹Ÿå†…å­˜å¤§å°å–å†³äºç£ç›˜äº¤æ¢åŒºè®¾å®šçš„å¤§å°ã€‚</p><blockquote><p>ä¹°æˆ¿å­ï¼š80å¹³çš„æˆ¿å­ï¼Œä½†æ˜¯æœ‰10å¹³æ˜¯å…¬æ‘Šçš„é¢ç§¯ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•ä½¿ç”¨è¿™10å¹³çš„ç©ºé—´ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å†…å­˜æ³„æ¼</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712195158470.png" alt="image-20200712195158470"></p><p>Javaä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œæœ€ä¸Šé¢çš„æ•°æ®ä¸å¯è¾¾ï¼Œå°±æ˜¯éœ€è¦è¢«å›æ”¶çš„ã€‚åæœŸæœ‰ä¸€äº›å¯¹è±¡ä¸ç”¨äº†ï¼ŒæŒ‰é“ç†åº”è¯¥æ–­å¼€å¼•ç”¨ï¼Œä½†æ˜¯å­˜åœ¨ä¸€äº›é“¾æ²¡æœ‰æ–­å¼€ï¼Œä»è€Œå¯¼è‡´æ²¡æœ‰åŠæ³•è¢«å›æ”¶ã€‚</p><h3 id="ä¸¾ä¾‹-2"><a href="#ä¸¾ä¾‹-2" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><ul><li>å•ä¾‹æ¨¡å¼</li></ul><p>å•ä¾‹çš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨ç¨‹åºæ˜¯ä¸€æ ·é•¿çš„ï¼Œæ‰€ä»¥å•ä¾‹ç¨‹åºä¸­ï¼Œå¦‚æœæŒæœ‰å¯¹å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œåˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„äº§ç”Ÿã€‚</p><ul><li>ä¸€äº›æä¾›closeçš„èµ„æºæœªå…³é—­å¯¼è‡´å†…å­˜æ³„æ¼</li></ul><p>æ•°æ®åº“è¿æ¥ï¼ˆdataSourse.getConnection() ï¼‰ï¼Œç½‘ç»œè¿æ¥ï¼ˆsocketï¼‰å’Œioè¿æ¥å¿…é¡»æ‰‹åŠ¨closeï¼Œå¦åˆ™æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ã€‚</p><h2 id="4-Stop-The-World"><a href="#4-Stop-The-World" class="headerlink" title="4 Stop The World"></a>4 Stop The World</h2><p> stop-the-worldï¼Œç®€ç§°STwï¼ŒæŒ‡çš„æ˜¯GCäº‹ä»¶å‘ç”Ÿè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿåº”ç”¨ç¨‹åºçš„åœé¡¿ã€‚åœé¡¿äº§ç”Ÿæ—¶æ•´ä¸ªåº”ç”¨ç¨‹åºçº¿ç¨‹éƒ½ä¼šè¢«æš‚åœï¼Œæ²¡æœ‰ä»»ä½•å“åº”ï¼Œæœ‰ç‚¹åƒå¡æ­»çš„æ„Ÿè§‰ï¼Œè¿™ä¸ªåœé¡¿ç§°ä¸ºSTWã€‚</p><p>å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­æšä¸¾æ ¹èŠ‚ç‚¹ï¼ˆGC Rootsï¼‰ä¼šå¯¼è‡´æ‰€æœ‰Javaæ‰§è¡Œçº¿ç¨‹åœé¡¿ã€‚</p><ul><li><p>åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ç¡®ä¿ä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œ</p></li><li><p>ä¸€è‡´æ€§æŒ‡æ•´ä¸ªåˆ†ææœŸé—´æ•´ä¸ªæ‰§è¡Œç³»ç»Ÿçœ‹èµ·æ¥åƒè¢«å†»ç»“åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Š</p></li><li><p>å¦‚æœå‡ºç°åˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡å¼•ç”¨å…³ç³»è¿˜åœ¨ä¸æ–­å˜åŒ–ï¼Œåˆ™åˆ†æç»“æœçš„å‡†ç¡®æ€§æ— æ³•ä¿è¯</p></li></ul><p>è¢«STWä¸­æ–­çš„åº”ç”¨ç¨‹åºçº¿ç¨‹ä¼šåœ¨å®ŒæˆGCä¹‹åæ¢å¤ï¼Œé¢‘ç¹ä¸­æ–­ä¼šè®©ç”¨æˆ·æ„Ÿè§‰åƒæ˜¯ç½‘é€Ÿä¸å¿«é€ æˆç”µå½±å¡å¸¦ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‡å°‘STwçš„å‘ç”Ÿã€‚</p><p>STWäº‹ä»¶å’Œé‡‡ç”¨å“ªæ¬¾GCæ— å…³æ‰€æœ‰çš„GCéƒ½æœ‰è¿™ä¸ªäº‹ä»¶ã€‚</p><p>å“ªæ€•æ˜¯G1ä¹Ÿä¸èƒ½å®Œå…¨é¿å…Stop-the-worldæƒ…å†µå‘ç”Ÿï¼Œåªèƒ½è¯´åƒåœ¾å›æ”¶å™¨è¶Šæ¥è¶Šä¼˜ç§€ï¼Œå›æ”¶æ•ˆç‡è¶Šæ¥è¶Šé«˜ï¼Œå°½å¯èƒ½åœ°ç¼©çŸ­äº†æš‚åœæ—¶é—´ã€‚</p><p>STWæ˜¯JVMåœ¨åå°è‡ªåŠ¨å‘èµ·å’Œè‡ªåŠ¨å®Œæˆçš„ã€‚åœ¨ç”¨æˆ·ä¸å¯è§çš„æƒ…å†µä¸‹ï¼ŒæŠŠç”¨æˆ·æ­£å¸¸çš„å·¥ä½œçº¿ç¨‹å…¨éƒ¨åœæ‰ã€‚</p><p>å¼€å‘ä¸­ä¸è¦ç”¨system.gc() ä¼šå¯¼è‡´stop-the-worldçš„å‘ç”Ÿã€‚</p><h2 id="5-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"><a href="#5-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘" class="headerlink" title="5 åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"></a>5 åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘</h2><h3 id="5-1-å¹¶å‘"><a href="#5-1-å¹¶å‘" class="headerlink" title="5.1 å¹¶å‘"></a>5.1 å¹¶å‘</h3><p>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œæ˜¯æŒ‡ä¸€ä¸ªæ—¶é—´æ®µä¸­æœ‰å‡ ä¸ªç¨‹åºéƒ½å¤„äºå·²å¯åŠ¨è¿è¡Œåˆ°è¿è¡Œå®Œæ¯•ä¹‹é—´ï¼Œä¸”è¿™å‡ ä¸ªç¨‹åºéƒ½æ˜¯åœ¨åŒä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œã€‚</p><p>å¹¶å‘ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€œåŒæ—¶è¿›è¡Œâ€ï¼Œåªæ˜¯CPUæŠŠä¸€ä¸ªæ—¶é—´æ®µåˆ’åˆ†æˆå‡ ä¸ªæ—¶é—´ç‰‡æ®µï¼ˆæ—¶é—´åŒºé—´ï¼‰ï¼Œç„¶ååœ¨è¿™å‡ ä¸ªæ—¶é—´åŒºé—´ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œç”±äºCPUå¤„ç†çš„é€Ÿåº¦éå¸¸å¿«ï¼Œåªè¦æ—¶é—´é—´éš”å¤„ç†å¾—å½“ï¼Œå³å¯è®©ç”¨æˆ·æ„Ÿè§‰æ˜¯å¤šä¸ªåº”ç”¨ç¨‹åºåŒæ—¶åœ¨è¿›è¡Œã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712202522051.png" alt="image-20200712202522051"></p><h3 id="5-2-å¹¶è¡Œ"><a href="#5-2-å¹¶è¡Œ" class="headerlink" title="5.2 å¹¶è¡Œ"></a>5.2 å¹¶è¡Œ</h3><p>å½“ç³»ç»Ÿæœ‰ä¸€ä¸ªä»¥ä¸ŠCPUæ—¶ï¼Œå½“ä¸€ä¸ªCPUæ‰§è¡Œä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå¦ä¸€ä¸ªCPUå¯ä»¥æ‰§è¡Œå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸¤ä¸ªè¿›ç¨‹äº’ä¸æŠ¢å CPUèµ„æºï¼Œå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå¹¶è¡Œï¼ˆParalle1ï¼‰ã€‚</p><p>å…¶å®å†³å®šå¹¶è¡Œçš„å› ç´ ä¸æ˜¯CPUçš„æ•°é‡ï¼Œè€Œæ˜¯CPUçš„æ ¸å¿ƒæ•°é‡ï¼Œæ¯”å¦‚ä¸€ä¸ªCPUå¤šä¸ªæ ¸ä¹Ÿå¯ä»¥å¹¶è¡Œã€‚</p><p>é€‚åˆç§‘å­¦è®¡ç®—ï¼Œåå°å¤„ç†ç­‰å¼±äº¤äº’åœºæ™¯</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712202822129.png" alt="image-20200712202822129"></p><h3 id="5-3-å¹¶å‘å’Œå¹¶è¡Œå¯¹æ¯”"><a href="#5-3-å¹¶å‘å’Œå¹¶è¡Œå¯¹æ¯”" class="headerlink" title="5.3 å¹¶å‘å’Œå¹¶è¡Œå¯¹æ¯”"></a>5.3 å¹¶å‘å’Œå¹¶è¡Œå¯¹æ¯”</h3><p><strong>å¹¶å‘</strong>ï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªäº‹æƒ…ï¼Œåœ¨åŒä¸€æ—¶é—´æ®µå†…åŒæ—¶å‘ç”Ÿäº†ã€‚</p><p><strong>å¹¶è¡Œ</strong>ï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªäº‹æƒ…ï¼Œåœ¨åŒä¸€æ—¶é—´ç‚¹ä¸ŠåŒæ—¶å‘ç”Ÿäº†ã€‚</p><p>å¹¶å‘çš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ˜¯äº’ç›¸æŠ¢å èµ„æºçš„ã€‚å¹¶è¡Œçš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ˜¯ä¸äº’ç›¸æŠ¢å èµ„æºçš„ã€‚</p><p>åªæœ‰åœ¨å¤šCPUæˆ–è€…ä¸€ä¸ªCPUå¤šæ ¸çš„æƒ…å†µä¸­ï¼Œæ‰ä¼šå‘ç”Ÿå¹¶è¡Œã€‚</p><p>å¦åˆ™ï¼Œçœ‹ä¼¼åŒæ—¶å‘ç”Ÿçš„äº‹æƒ…ï¼Œå…¶å®éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚</p><h3 id="5-4-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"><a href="#5-4-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘" class="headerlink" title="5.4 åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"></a>5.4 åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘</h3><p>å¹¶å‘å’Œå¹¶è¡Œï¼Œåœ¨è°ˆè®ºåƒåœ¾æ”¶é›†å™¨çš„ä¸Šä¸‹æ–‡è¯­å¢ƒä¸­ï¼Œå®ƒä»¬å¯ä»¥è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li><p>å¹¶è¡Œï¼ˆParalle1ï¼‰ï¼šæŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»å¤„äºç­‰å¾…çŠ¶æ€ã€‚å¦‚ParNewã€Parallel Scavengeã€Parallel oldï¼›</p></li><li><p>ä¸²è¡Œï¼ˆSerialï¼‰</p><ul><li>ç›¸è¾ƒäºå¹¶è¡Œçš„æ¦‚å¿µï¼Œå•çº¿ç¨‹æ‰§è¡Œã€‚</li><li>å¦‚æœå†…å­˜ä¸å¤Ÿï¼Œåˆ™ç¨‹åºæš‚åœï¼Œå¯åŠ¨JMåƒåœ¾å›æ”¶å™¨è¿›è¡Œåƒåœ¾å›æ”¶ã€‚å›æ”¶å®Œï¼Œå†å¯åŠ¨ç¨‹åºçš„çº¿ç¨‹ã€‚</li></ul></li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712203607845.png" alt="image-20200712203607845"></p><p>å¹¶å‘å’Œå¹¶è¡Œï¼Œåœ¨è°ˆè®ºåƒåœ¾æ”¶é›†å™¨çš„ä¸Šä¸‹æ–‡è¯­å¢ƒä¸­ï¼Œå®ƒä»¬å¯ä»¥è§£é‡Šå¦‚ä¸‹ï¼š</p><p>å¹¶å‘ï¼ˆConcurrentï¼‰ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆä½†ä¸ä¸€å®šæ˜¯å¹¶è¡Œçš„ï¼Œå¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œï¼‰ï¼Œåƒåœ¾å›æ”¶çº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ä¸ä¼šåœé¡¿ç”¨æˆ·ç¨‹åºçš„è¿è¡Œã€‚&gt;ç”¨æˆ·ç¨‹åºåœ¨ç»§ç»­è¿è¡Œï¼Œè€Œåƒåœ¾æ”¶é›†ç¨‹åºçº¿ç¨‹è¿è¡Œäºå¦ä¸€ä¸ªCPUä¸Šï¼›</p><blockquote><p>å¦‚ï¼šCMSã€G1</p></blockquote><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712203815517.png" alt="image-20200712203815517"></p><h2 id="6-å®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ"><a href="#6-å®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ" class="headerlink" title="6 å®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ"></a>6 å®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ</h2><h3 id="6-1-å®‰å…¨ç‚¹"><a href="#6-1-å®‰å…¨ç‚¹" class="headerlink" title="6.1 å®‰å…¨ç‚¹"></a>6.1 å®‰å…¨ç‚¹</h3><p>ç¨‹åºæ‰§è¡Œæ—¶å¹¶éåœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œåªæœ‰åœ¨ç‰¹å®šçš„ä½ç½®æ‰èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œè¿™äº›ä½ç½®ç§°ä¸ºâ€œå®‰å…¨ç‚¹ï¼ˆSafepointï¼‰â€ã€‚</p><p>Safe Pointçš„é€‰æ‹©å¾ˆé‡è¦ï¼Œå¦‚æœå¤ªå°‘å¯èƒ½å¯¼è‡´GCç­‰å¾…çš„æ—¶é—´å¤ªé•¿ï¼Œå¦‚æœå¤ªé¢‘ç¹å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜ã€‚å¤§éƒ¨åˆ†æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´éƒ½éå¸¸çŸ­æš‚ï¼Œé€šå¸¸ä¼šæ ¹æ®â€œæ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾â€ä¸ºæ ‡å‡†ã€‚æ¯”å¦‚ï¼šé€‰æ‹©ä¸€äº›æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æŒ‡ä»¤ä½œä¸ºSafe Pointï¼Œå¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬å’Œå¼‚å¸¸è·³è½¬ç­‰ã€‚</p><p>å¦‚ä½•åœ¨ccå‘ç”Ÿæ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰çº¿ç¨‹éƒ½è·‘åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹åœé¡¿ä¸‹æ¥å‘¢ï¼Ÿ</p><ul><li><strong>æŠ¢å…ˆå¼ä¸­æ–­</strong>ï¼šï¼ˆç›®å‰æ²¡æœ‰è™šæ‹Ÿæœºé‡‡ç”¨äº†ï¼‰é¦–å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœè¿˜æœ‰çº¿ç¨‹ä¸åœ¨å®‰å…¨ç‚¹ï¼Œå°±æ¢å¤çº¿ç¨‹ï¼Œè®©çº¿ç¨‹è·‘åˆ°å®‰å…¨ç‚¹ã€‚</li><li><strong>ä¸»åŠ¨å¼ä¸­æ–­</strong>ï¼šè®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªçº¿ç¨‹è¿è¡Œåˆ°Safe Pointçš„æ—¶å€™ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±è¿›è¡Œä¸­æ–­æŒ‚èµ·ã€‚ï¼ˆæœ‰è½®è¯¢çš„æœºåˆ¶ï¼‰</li></ul><h3 id="6-2-å®‰å…¨åŒºåŸŸ"><a href="#6-2-å®‰å…¨åŒºåŸŸ" class="headerlink" title="6.2 å®‰å…¨åŒºåŸŸ"></a>6.2 å®‰å…¨åŒºåŸŸ</h3><p>Safepoint æœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥GCçš„Safepointã€‚ä½†æ˜¯ï¼Œç¨‹åºâ€œä¸æ‰§è¡Œâ€çš„æ—¶å€™å‘¢ï¼Ÿä¾‹å¦‚çº¿ç¨‹å¤„äºsleep-çŠ¶æ€æˆ–Blocked çŠ¶æ€ï¼Œè¿™æ—¶å€™çº¿ç¨‹æ— æ³•å“åº”JVMçš„ä¸­æ–­è¯·æ±‚ï¼Œâ€œèµ°â€åˆ°å®‰å…¨ç‚¹å»ä¸­æ–­æŒ‚èµ·ï¼ŒJVMä¹Ÿä¸å¤ªå¯èƒ½ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå°±éœ€è¦å®‰å…¨åŒºåŸŸï¼ˆSafe Regionï¼‰æ¥è§£å†³ã€‚</p><p>å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹Gcéƒ½æ˜¯å®‰å…¨çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠSafe Regionçœ‹åšæ˜¯è¢«æ‰©å±•äº†çš„Safepointã€‚</p><p><strong>æ‰§è¡Œæµç¨‹ï¼š</strong></p><ul><li>å½“çº¿ç¨‹è¿è¡Œåˆ°Safe Regionçš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº†Safe Relgionï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”ŸGCï¼ŒJVMä¼šå¿½ç•¥æ ‡è¯†ä¸ºSafe RegionçŠ¶æ€çš„çº¿ç¨‹</li><li>å½“çº¿ç¨‹å³å°†ç¦»å¼€Safe Regionæ—¶ï¼Œä¼šæ£€æŸ¥JVMæ˜¯å¦å·²ç»å®ŒæˆGCï¼Œå¦‚æœå®Œæˆäº†ï¼Œåˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€Safe Regionçš„ä¿¡å·ä¸ºæ­¢ï¼›</li></ul><h2 id="7-å†è°ˆå¼•ç”¨"><a href="#7-å†è°ˆå¼•ç”¨" class="headerlink" title="7 å†è°ˆå¼•ç”¨"></a>7 å†è°ˆå¼•ç”¨</h2><p>æˆ‘ä»¬å¸Œæœ›èƒ½æè¿°è¿™æ ·ä¸€ç±»å¯¹è±¡ï¼šå½“å†…å­˜ç©ºé—´è¿˜è¶³å¤Ÿæ—¶ï¼Œåˆ™èƒ½ä¿ç•™åœ¨å†…å­˜ä¸­ï¼›å¦‚æœå†…å­˜ç©ºé—´åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†åè¿˜æ˜¯å¾ˆç´§å¼ ï¼Œåˆ™å¯ä»¥æŠ›å¼ƒè¿™äº›å¯¹è±¡ã€‚</p><p>ã€æ—¢åé—¨åˆéå¸¸é«˜é¢‘çš„é¢è¯•é¢˜ã€‘å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå…·ä½“ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ<br>åœ¨JDK1.2ç‰ˆä¹‹åï¼ŒJavaå¯¹å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸ºï¼š</p><ul><li>å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰</li><li>è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰</li><li>å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰</li><li>è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰</li></ul><p>è¿™4ç§å¼•ç”¨å¼ºåº¦ä¾æ¬¡é€æ¸å‡å¼±ã€‚é™¤å¼ºå¼•ç”¨å¤–ï¼Œå…¶ä»–3ç§å¼•ç”¨å‡å¯ä»¥åœ¨java.1ang.refåŒ…ä¸­æ‰¾åˆ°å®ƒä»¬çš„èº«å½±ã€‚å¦‚ä¸‹å›¾ï¼Œæ˜¾ç¤ºäº†è¿™3ç§å¼•ç”¨ç±»å‹å¯¹åº”çš„ç±»ï¼Œå¼€å‘äººå‘˜å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨å®ƒä»¬ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712205813321.png" alt="image-20200712205813321"></p><p>Referenceå­ç±»ä¸­åªæœ‰ç»ˆç»“å™¨å¼•ç”¨æ˜¯åŒ…å†…å¯è§çš„ï¼Œå…¶ä»–3ç§å¼•ç”¨ç±»å‹å‡ä¸ºpublicï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨</p><ul><li>å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰ï¼šæœ€ä¼ ç»Ÿçš„â€œå¼•ç”¨â€çš„å®šä¹‰ï¼Œæ˜¯æŒ‡åœ¨ç¨‹åºä»£ç ä¹‹ä¸­æ™®éå­˜åœ¨çš„å¼•ç”¨èµ‹å€¼ï¼Œå³ç±»ä¼¼â€œobject obj=new Objectï¼ˆï¼‰â€è¿™ç§å¼•ç”¨å…³ç³»ã€‚æ— è®ºä»»ä½•æƒ…å†µä¸‹ï¼Œ==åªè¦å¼ºå¼•ç”¨å…³ç³»è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡==ã€‚</li><li>è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—å…¥å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶åè¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æµå‡ºå¼‚å¸¸ã€‚</li><li>å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†ä¹‹å‰ã€‚å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œæ— è®ºå†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</li><li>è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å¾—ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ã€‚==ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥==ã€‚</li></ul><h2 id="8-å†è°ˆå¼•ç”¨ï¼šå¼ºå¼•ç”¨"><a href="#8-å†è°ˆå¼•ç”¨ï¼šå¼ºå¼•ç”¨" class="headerlink" title="8 å†è°ˆå¼•ç”¨ï¼šå¼ºå¼•ç”¨"></a>8 å†è°ˆå¼•ç”¨ï¼šå¼ºå¼•ç”¨</h2><p>åœ¨Javaç¨‹åºä¸­ï¼Œæœ€å¸¸è§çš„å¼•ç”¨ç±»å‹æ˜¯å¼ºå¼•ç”¨ï¼ˆæ™®é€šç³»ç»Ÿ99%ä»¥ä¸Šéƒ½æ˜¯å¼ºå¼•ç”¨ï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„å¼•ç”¨ç±»å‹ã€‚</p><p>å½“åœ¨Javaè¯­è¨€ä¸­ä½¿ç”¨newæ“ä½œç¬¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œè¿™ä¸ªå˜é‡å°±æˆä¸ºæŒ‡å‘è¯¥å¯¹è±¡çš„ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚</p><p>å¼ºå¼•ç”¨çš„å¯¹è±¡æ˜¯å¯è§¦åŠçš„ï¼Œåƒåœ¾æ”¶é›†å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</p><p>å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾å¼åœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸ºnu11ï¼Œå°±æ˜¯å¯ä»¥å½“åšåƒåœ¾è¢«æ”¶é›†äº†ï¼Œå½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾æ”¶é›†ç­–ç•¥ã€‚</p><p>ç›¸å¯¹çš„ï¼Œè½¯å¼•ç”¨ã€å¼±å¼•ç”¨å’Œè™šå¼•ç”¨çš„å¯¹è±¡æ˜¯è½¯å¯è§¦åŠã€å¼±å¯è§¦åŠå’Œè™šå¯è§¦åŠçš„ï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹ï¼Œéƒ½æ˜¯å¯ä»¥è¢«å›æ”¶çš„ã€‚æ‰€ä»¥ï¼Œå¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><h3 id="8-1-ä¸¾ä¾‹"><a href="#8-1-ä¸¾ä¾‹" class="headerlink" title="8.1 ä¸¾ä¾‹"></a>8.1 ä¸¾ä¾‹</h3><p>å¼ºå¼•ç”¨çš„æ¡ˆä¾‹è¯´æ˜</p><div class="code-wrapper"><pre><code class="hljs java">StringBuffer str = <span class="hljs-keyword">new</span> StringBuffer(<span class="hljs-string">&quot;hello mogublog&quot;</span>);</code></pre></div><p>å±€éƒ¨å˜é‡stræŒ‡å‘stringBufferå®ä¾‹æ‰€åœ¨å †ç©ºé—´ï¼Œé€šè¿‡strå¯ä»¥æ“ä½œè¯¥å®ä¾‹ï¼Œé‚£ä¹ˆstrå°±æ˜¯stringBufferå®ä¾‹çš„å¼ºå¼•ç”¨å¯¹åº”å†…å­˜ç»“æ„ï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712211501377.png" alt="image-20200712211501377"></p><p>å¦‚æœæ­¤æ—¶ï¼Œåœ¨è¿è¡Œä¸€ä¸ªèµ‹å€¼è¯­å¥</p><div class="code-wrapper"><pre><code class="hljs java">StringBuffer str = <span class="hljs-keyword">new</span> StringBuffer(<span class="hljs-string">&quot;hello mogublog&quot;</span>);StringBuffer str1 = str;</code></pre></div><p>å¯¹åº”çš„å†…å­˜ç»“æ„ä¸º:</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200712211732976.png" alt="image-20200712211732976"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°† str = null; åˆ™ åŸæ¥å †ä¸­çš„å¯¹è±¡ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºè¿˜æœ‰å…¶å®ƒå¯¹è±¡æŒ‡å‘è¯¥åŒºåŸŸ</p><h3 id="8-2-æ€»ç»“"><a href="#8-2-æ€»ç»“" class="headerlink" title="8.2 æ€»ç»“"></a>8.2 æ€»ç»“</h3><p>æœ¬ä¾‹ä¸­çš„ä¸¤ä¸ªå¼•ç”¨ï¼Œéƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œå¼ºå¼•ç”¨å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å¼ºå¼•ç”¨å¯ä»¥ç›´æ¥è®¿é—®ç›®æ ‡å¯¹è±¡ã€‚</li><li>å¼ºå¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸ä¼šè¢«ç³»ç»Ÿå›æ”¶ï¼Œè™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOOMå¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå›æ”¶å¼ºå¼•ç”¨æ‰€æŒ‡å‘å¯¹è±¡ã€‚</li><li>å¼ºå¼•ç”¨å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</li></ul><h2 id="9-å†è°ˆå¼•ç”¨ï¼š-è½¯å¼•ç”¨"><a href="#9-å†è°ˆå¼•ç”¨ï¼š-è½¯å¼•ç”¨" class="headerlink" title="9 å†è°ˆå¼•ç”¨ï¼š è½¯å¼•ç”¨"></a>9 å†è°ˆå¼•ç”¨ï¼š è½¯å¼•ç”¨</h2><p>è½¯å¼•ç”¨æ˜¯ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ç”¨ï¼Œä½†éå¿…éœ€çš„å¯¹è±¡ã€‚åªè¢«è½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸å‰ï¼Œä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ï¼Œå¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</p><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œçš„ç¬¬ä¸€æ¬¡å›æ”¶æ˜¯ä¸å¯è¾¾çš„å¯¹è±¡</p></blockquote><p>è½¯å¼•ç”¨é€šå¸¸ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ã€‚æ¯”å¦‚ï¼šé«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ã€‚å¦‚æœè¿˜æœ‰ç©ºé—²å†…å­˜ï¼Œå°±å¯ä»¥æš‚æ—¶ä¿ç•™ç¼“å­˜ï¼Œå½“å†…å­˜ä¸è¶³æ—¶æ¸…ç†æ‰ï¼Œè¿™æ ·å°±ä¿è¯äº†ä½¿ç”¨ç¼“å­˜çš„åŒæ—¶ï¼Œä¸ä¼šè€—å°½å†…å­˜ã€‚</p><p>åƒåœ¾å›æ”¶å™¨åœ¨æŸä¸ªæ—¶åˆ»å†³å®šå›æ”¶è½¯å¯è¾¾çš„å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæ¸…ç†è½¯å¼•ç”¨ï¼Œå¹¶å¯é€‰åœ°æŠŠå¼•ç”¨å­˜æ”¾åˆ°ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReference Queueï¼‰ã€‚</p><p>ç±»ä¼¼å¼±å¼•ç”¨ï¼Œåªä¸è¿‡Javaè™šæ‹Ÿæœºä¼šå°½é‡è®©è½¯å¼•ç”¨çš„å­˜æ´»æ—¶é—´é•¿ä¸€äº›ï¼Œè¿«ä¸å¾—å·²æ‰æ¸…ç†ã€‚</p><blockquote><p>ä¸€å¥è¯æ¦‚æ‹¬ï¼šå½“å†…å­˜è¶³å¤Ÿæ—¶ï¼Œä¸ä¼šå›æ”¶è½¯å¼•ç”¨å¯è¾¾çš„å¯¹è±¡ã€‚å†…å­˜ä¸å¤Ÿæ—¶ï¼Œä¼šå›æ”¶è½¯å¼•ç”¨çš„å¯è¾¾å¯¹è±¡</p></blockquote><p>åœ¨JDK1.2ç‰ˆä¹‹åæä¾›äº†SoftReferenceç±»æ¥å®ç°è½¯å¼•ç”¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// å£°æ˜å¼ºå¼•ç”¨</span>Object obj = <span class="hljs-keyword">new</span> Object();<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè½¯å¼•ç”¨</span>SoftReference&lt;Object&gt; sf = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(obj);obj = <span class="hljs-keyword">null</span>; <span class="hljs-comment">//é”€æ¯å¼ºå¼•ç”¨ï¼Œè¿™æ˜¯å¿…é¡»çš„ï¼Œä¸ç„¶ä¼šå­˜åœ¨å¼ºå¼•ç”¨å’Œè½¯å¼•ç”¨</span></code></pre></div><h2 id="10-å†è°ˆå¼•ç”¨ï¼šå¼±å¼•ç”¨"><a href="#10-å†è°ˆå¼•ç”¨ï¼šå¼±å¼•ç”¨" class="headerlink" title="10 å†è°ˆå¼•ç”¨ï¼šå¼±å¼•ç”¨"></a>10 å†è°ˆå¼•ç”¨ï¼šå¼±å¼•ç”¨</h2><blockquote><p>å‘ç°å³å›æ”¶</p></blockquote><p>å¼±å¼•ç”¨ä¹Ÿæ˜¯ç”¨æ¥æè¿°é‚£äº›éå¿…éœ€å¯¹è±¡ï¼Œè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¸ºæ­¢ã€‚åœ¨ç³»ç»ŸGCæ—¶ï¼Œåªè¦å‘ç°å¼±å¼•ç”¨ï¼Œä¸ç®¡ç³»ç»Ÿå †ç©ºé—´ä½¿ç”¨æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</p><p>ä½†æ˜¯ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨çš„çº¿ç¨‹é€šå¸¸ä¼˜å…ˆçº§å¾ˆä½ï¼Œå› æ­¤ï¼Œå¹¶ä¸ä¸€å®šèƒ½å¾ˆå¿«åœ°å‘ç°æŒæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼±å¼•ç”¨å¯¹è±¡å¯ä»¥å­˜åœ¨è¾ƒé•¿çš„æ—¶é—´ã€‚</p><p>å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ä¸€æ ·ï¼Œåœ¨æ„é€ å¼±å¼•ç”¨æ—¶ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼Œå½“å¼±å¼•ç”¨å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œå°±ä¼šåŠ å…¥æŒ‡å®šçš„å¼•ç”¨é˜Ÿåˆ—ï¼Œé€šè¿‡è¿™ä¸ªé˜Ÿåˆ—å¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å›æ”¶æƒ…å†µã€‚</p><p>è½¯å¼•ç”¨ã€å¼±å¼•ç”¨éƒ½éå¸¸é€‚åˆæ¥ä¿å­˜é‚£äº›å¯æœ‰å¯æ— çš„ç¼“å­˜æ•°æ®ã€‚å¦‚æœè¿™ä¹ˆåšï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œè¿™äº›ç¼“å­˜æ•°æ®ä¼šè¢«å›æ”¶ï¼Œä¸ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚è€Œå½“å†…å­˜èµ„æºå……è¶³æ—¶ï¼Œè¿™äº›ç¼“å­˜æ•°æ®åˆå¯ä»¥å­˜åœ¨ç›¸å½“é•¿çš„æ—¶é—´ï¼Œä»è€Œèµ·åˆ°åŠ é€Ÿç³»ç»Ÿçš„ä½œç”¨ã€‚</p><p>åœ¨JDK1.2ç‰ˆä¹‹åæä¾›äº†WeakReferenceç±»æ¥å®ç°å¼±å¼•ç”¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// å£°æ˜å¼ºå¼•ç”¨</span>Object obj = <span class="hljs-keyword">new</span> Object();<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨</span>WeakReference&lt;Object&gt; sf = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(obj);obj = <span class="hljs-keyword">null</span>; <span class="hljs-comment">//é”€æ¯å¼ºå¼•ç”¨ï¼Œè¿™æ˜¯å¿…é¡»çš„ï¼Œä¸ç„¶ä¼šå­˜åœ¨å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨</span></code></pre></div><p>å¼±å¼•ç”¨å¯¹è±¡ä¸è½¯å¼•ç”¨å¯¹è±¡çš„æœ€å¤§ä¸åŒå°±åœ¨äºï¼Œå½“GCåœ¨è¿›è¡Œå›æ”¶æ—¶ï¼Œéœ€è¦é€šè¿‡ç®—æ³•æ£€æŸ¥æ˜¯å¦å›æ”¶è½¯å¼•ç”¨å¯¹è±¡ï¼Œè€Œå¯¹äºå¼±å¼•ç”¨å¯¹è±¡ï¼ŒGCæ€»æ˜¯è¿›è¡Œå›æ”¶ã€‚å¼±å¼•ç”¨å¯¹è±¡æ›´å®¹æ˜“ã€æ›´å¿«è¢«GCå›æ”¶ã€‚</p><p>é¢è¯•é¢˜ï¼šä½ å¼€å‘ä¸­ä½¿ç”¨è¿‡WeakHashMapå—ï¼Ÿ</p><p>WeakHashMapç”¨æ¥å­˜å‚¨å›¾ç‰‡ä¿¡æ¯ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼ŒåŠæ—¶å›æ”¶ï¼Œé¿å…äº†OOM</p><h2 id="11-å†è°ˆå¼•ç”¨ï¼šè™šå¼•ç”¨"><a href="#11-å†è°ˆå¼•ç”¨ï¼šè™šå¼•ç”¨" class="headerlink" title="11 å†è°ˆå¼•ç”¨ï¼šè™šå¼•ç”¨"></a>11 å†è°ˆå¼•ç”¨ï¼šè™šå¼•ç”¨</h2><p>ä¹Ÿç§°ä¸ºâ€œå¹½çµå¼•ç”¨â€æˆ–è€…â€œå¹»å½±å¼•ç”¨â€ï¼Œæ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹ä¸­æœ€å¼±çš„ä¸€ä¸ª</p><p>ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå’Œæ²¡æœ‰å¼•ç”¨å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œéšæ—¶éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p><p>å®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å–è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚å½“è¯•å›¾é€šè¿‡è™šå¼•ç”¨çš„getï¼ˆï¼‰æ–¹æ³•å–å¾—å¯¹è±¡æ—¶ï¼Œæ€»æ˜¯null</p><p>ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åœ¨äºè·Ÿè¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚æ¯”å¦‚ï¼šèƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</p><p>è™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ã€‚è™šå¼•ç”¨åœ¨åˆ›å»ºæ—¶å¿…é¡»æä¾›ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ä½œä¸ºå‚æ•°ã€‚å½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šåœ¨å›æ”¶å¯¹è±¡åï¼Œå°†è¿™ä¸ªè™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—ï¼Œä»¥é€šçŸ¥åº”ç”¨ç¨‹åºå¯¹è±¡çš„å›æ”¶æƒ…å†µã€‚</p><p>ç”±äºè™šå¼•ç”¨å¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å›æ”¶æ—¶é—´ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥å°†ä¸€äº›èµ„æºé‡Šæ”¾æ“ä½œæ”¾ç½®åœ¨è™šå¼•ç”¨ä¸­æ‰§è¡Œå’Œè®°å½•ã€‚</p><blockquote><p>è™šå¼•ç”¨æ— æ³•è·å–åˆ°æˆ‘ä»¬çš„æ•°æ®</p></blockquote><p>åœ¨JDK1.2ç‰ˆä¹‹åæä¾›äº†PhantomReferenceç±»æ¥å®ç°è™šå¼•ç”¨ã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// å£°æ˜å¼ºå¼•ç”¨</span>Object obj = <span class="hljs-keyword">new</span> Object();<span class="hljs-comment">// å£°æ˜å¼•ç”¨é˜Ÿåˆ—</span>ReferenceQueue phantomQueue = <span class="hljs-keyword">new</span> ReferenceQueue();<span class="hljs-comment">// å£°æ˜è™šå¼•ç”¨ï¼ˆè¿˜éœ€è¦ä¼ å…¥å¼•ç”¨é˜Ÿåˆ—ï¼‰</span>PhantomReference&lt;Object&gt; sf = <span class="hljs-keyword">new</span> PhantomReference&lt;&gt;(obj, phantomQueue);obj = <span class="hljs-keyword">null</span>;</code></pre></div><h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ¡ˆä¾‹ï¼Œæ¥ç»“åˆè™šå¼•ç”¨ï¼Œå¼•ç”¨é˜Ÿåˆ—ï¼Œfinalizeè¿›è¡Œè®²è§£</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: é™Œæºª</span><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2020-07-12-21:42</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhantomReferenceTest</span> </span>&#123;    <span class="hljs-comment">// å½“å‰ç±»å¯¹è±¡çš„å£°æ˜</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PhantomReferenceTest obj;    <span class="hljs-comment">// å¼•ç”¨é˜Ÿåˆ—</span>    <span class="hljs-keyword">static</span> ReferenceQueue&lt;PhantomReferenceTest&gt; phantomQueue = <span class="hljs-keyword">null</span>;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;        <span class="hljs-keyword">super</span>.finalize();        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨å½“å‰ç±»çš„finalizeæ–¹æ³•&quot;</span>);        obj = <span class="hljs-keyword">this</span>;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Thread thread = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;                <span class="hljs-keyword">if</span> (phantomQueue != <span class="hljs-keyword">null</span>) &#123;                    PhantomReference&lt;PhantomReferenceTest&gt; objt = <span class="hljs-keyword">null</span>;                    <span class="hljs-keyword">try</span> &#123;                        objt = (PhantomReference&lt;PhantomReferenceTest&gt;) phantomQueue.remove();                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                        e.getStackTrace();                    &#125;                    <span class="hljs-keyword">if</span> (objt != <span class="hljs-keyword">null</span>) &#123;                        System.out.println(<span class="hljs-string">&quot;è¿½è¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼šPhantomReferenceTestå®ä¾‹è¢«GCäº†&quot;</span>);                    &#125;                &#125;            &#125;        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);        thread.setDaemon(<span class="hljs-keyword">true</span>);        thread.start();        phantomQueue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;&gt;();        obj = <span class="hljs-keyword">new</span> PhantomReferenceTest();        <span class="hljs-comment">// æ„é€ äº†PhantomReferenceTestå¯¹è±¡çš„è™šå¼•ç”¨ï¼Œå¹¶æŒ‡å®šäº†å¼•ç”¨é˜Ÿåˆ—</span>        PhantomReference&lt;PhantomReferenceTest&gt; phantomReference = <span class="hljs-keyword">new</span> PhantomReference&lt;&gt;(obj, phantomQueue);        <span class="hljs-keyword">try</span> &#123;            System.out.println(phantomReference.get());            <span class="hljs-comment">// å»é™¤å¼ºå¼•ç”¨</span>            obj = <span class="hljs-keyword">null</span>;            <span class="hljs-comment">// ç¬¬ä¸€æ¬¡è¿›è¡ŒGCï¼Œç”±äºå¯¹è±¡å¯å¤æ´»ï¼ŒGCæ— æ³•å›æ”¶è¯¥å¯¹è±¡</span>            System.out.println(<span class="hljs-string">&quot;ç¬¬ä¸€æ¬¡GCæ“ä½œ&quot;</span>);            System.gc();            Thread.sleep(<span class="hljs-number">1000</span>);            <span class="hljs-keyword">if</span> (obj == <span class="hljs-keyword">null</span>) &#123;                System.out.println(<span class="hljs-string">&quot;obj æ˜¯ null&quot;</span>);            &#125; <span class="hljs-keyword">else</span> &#123;                System.out.println(<span class="hljs-string">&quot;obj ä¸æ˜¯ null&quot;</span>);            &#125;            System.out.println(<span class="hljs-string">&quot;ç¬¬äºŒæ¬¡GCæ“ä½œ&quot;</span>);            obj = <span class="hljs-keyword">null</span>;            System.gc();            Thread.sleep(<span class="hljs-number">1000</span>);            <span class="hljs-keyword">if</span> (obj == <span class="hljs-keyword">null</span>) &#123;                System.out.println(<span class="hljs-string">&quot;obj æ˜¯ null&quot;</span>);            &#125; <span class="hljs-keyword">else</span> &#123;                System.out.println(<span class="hljs-string">&quot;obj ä¸æ˜¯ null&quot;</span>);            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;        &#125;    &#125;&#125;</code></pre></div><p>æœ€åè¿è¡Œç»“æœ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">null</span>ç¬¬ä¸€æ¬¡GCæ“ä½œè°ƒç”¨å½“å‰ç±»çš„finalizeæ–¹æ³•obj ä¸æ˜¯ <span class="hljs-keyword">null</span>ç¬¬äºŒæ¬¡GCæ“ä½œè¿½è¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼šPhantomReferenceTestå®ä¾‹è¢«GCäº†obj æ˜¯ <span class="hljs-keyword">null</span></code></pre></div><p>ä»ä¸Šè¿°è¿è¡Œç»“æœæˆ‘ä»¬çŸ¥é“ï¼Œç¬¬ä¸€æ¬¡å°è¯•è·å–è™šå¼•ç”¨çš„å€¼ï¼Œå‘ç°æ— æ³•è·å–çš„ï¼Œè¿™æ˜¯å› ä¸ºè™šå¼•ç”¨æ˜¯æ— æ³•ç›´æ¥è·å–å¯¹è±¡çš„å€¼ï¼Œç„¶åè¿›è¡Œç¬¬ä¸€æ¬¡gcï¼Œå› ä¸ºä¼šè°ƒç”¨finalizeæ–¹æ³•ï¼Œå°†å¯¹è±¡å¤æ´»äº†ï¼Œæ‰€ä»¥å¯¹è±¡æ²¡æœ‰è¢«å›æ”¶ï¼Œä½†æ˜¯è°ƒç”¨ç¬¬äºŒæ¬¡gcæ“ä½œçš„æ—¶å€™ï¼Œå› ä¸ºfinalizeæ–¹æ³•åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥å°±è§¦å‘äº†GCæ“ä½œï¼Œå°†å¯¹è±¡å›æ”¶äº†ï¼ŒåŒæ—¶å°†ä¼šè§¦å‘ç¬¬äºŒä¸ªæ“ä½œå°±æ˜¯ å°†å›æ”¶çš„å€¼å­˜å…¥åˆ°å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚</p><h2 id="12-ç»ˆç»“å™¨å¼•ç”¨"><a href="#12-ç»ˆç»“å™¨å¼•ç”¨" class="headerlink" title="12 ç»ˆç»“å™¨å¼•ç”¨"></a>12 ç»ˆç»“å™¨å¼•ç”¨</h2><p>å®ƒç”¨äºå®ç°å¯¹è±¡çš„finalize() æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºç»ˆç»“å™¨å¼•ç”¨</p><p>æ— éœ€æ‰‹åŠ¨ç¼–ç ï¼Œå…¶å†…éƒ¨é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨</p><p>åœ¨GCæ—¶ï¼Œç»ˆç»“å™¨å¼•ç”¨å…¥é˜Ÿã€‚ç”±Finalizerçº¿ç¨‹é€šè¿‡ç»ˆç»“å™¨å¼•ç”¨æ‰¾åˆ°è¢«å¼•ç”¨å¯¹è±¡è°ƒç”¨å®ƒçš„finalize()æ–¹æ³•ï¼Œç¬¬äºŒæ¬¡GCæ—¶æ‰å›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡</p><h1 id="ç¬¬17ç« -åƒåœ¾å›æ”¶å™¨"><a href="#ç¬¬17ç« -åƒåœ¾å›æ”¶å™¨" class="headerlink" title="ç¬¬17ç«  åƒåœ¾å›æ”¶å™¨"></a>ç¬¬17ç«  åƒåœ¾å›æ”¶å™¨</h1><h2 id="1-GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡"><a href="#1-GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="1 GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡"></a>1 GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡</h2><p>åƒåœ¾æ”¶é›†å™¨æ²¡æœ‰åœ¨è§„èŒƒä¸­è¿›è¡Œè¿‡å¤šçš„è§„å®šï¼Œå¯ä»¥ç”±ä¸åŒçš„å‚å•†ã€ä¸åŒç‰ˆæœ¬çš„JVMæ¥å®ç°ã€‚</p><p>ç”±äºJDKçš„ç‰ˆæœ¬å¤„äºé«˜é€Ÿè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå› æ­¤Javaå‘å±•è‡³ä»Šå·²ç»è¡ç”Ÿäº†ä¼—å¤šçš„GCç‰ˆæœ¬ã€‚</p><p>ä»ä¸åŒè§’åº¦åˆ†æåƒåœ¾æ”¶é›†å™¨ï¼Œå¯ä»¥å°†GCåˆ†ä¸ºä¸åŒçš„ç±»å‹ã€‚</p><blockquote><p>Javaä¸åŒç‰ˆæœ¬æ–°ç‰¹æ€§</p><ul><li>è¯­æ³•å±‚é¢ï¼šLambdaè¡¨è¾¾å¼ã€switchã€è‡ªåŠ¨æ‹†ç®±è£…ç®±ã€enum</li><li>APIå±‚é¢ï¼šStream APIã€æ–°çš„æ—¥æœŸæ—¶é—´ã€Optionalã€Stringã€é›†åˆæ¡†æ¶</li><li>åº•å±‚ä¼˜åŒ–ï¼šJVMä¼˜åŒ–ã€GCçš„å˜åŒ–ã€å…ƒç©ºé—´ã€é™æ€åŸŸã€å­—ç¬¦ä¸²å¸¸é‡æ± ä½ç½®å˜åŒ–</li></ul></blockquote><h3 id="1-1-åƒåœ¾æ”¶é›†å™¨åˆ†ç±»"><a href="#1-1-åƒåœ¾æ”¶é›†å™¨åˆ†ç±»" class="headerlink" title="1.1 åƒåœ¾æ”¶é›†å™¨åˆ†ç±»"></a>1.1 åƒåœ¾æ”¶é›†å™¨åˆ†ç±»</h3><h4 id="æŒ‰çº¿ç¨‹æ•°åˆ†"><a href="#æŒ‰çº¿ç¨‹æ•°åˆ†" class="headerlink" title="æŒ‰çº¿ç¨‹æ•°åˆ†"></a><strong>æŒ‰çº¿ç¨‹æ•°åˆ†</strong></h4><p><strong>æŒ‰çº¿ç¨‹æ•°åˆ†</strong>ï¼ˆåƒåœ¾å›æ”¶çº¿ç¨‹æ•°ï¼‰ï¼Œå¯ä»¥åˆ†ä¸ºä¸²è¡Œåƒåœ¾å›æ”¶å™¨å’Œå¹¶è¡Œåƒåœ¾å›æ”¶å™¨ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713083030867.png" alt="image-20200713083030867"></p><p>ä¸²è¡Œå›æ”¶æŒ‡çš„æ˜¯åœ¨åŒä¸€æ—¶é—´æ®µå†…åªå…è®¸æœ‰ä¸€ä¸ªCPUç”¨äºæ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œï¼Œæ­¤æ—¶å·¥ä½œçº¿ç¨‹è¢«æš‚åœï¼Œç›´è‡³åƒåœ¾æ”¶é›†å·¥ä½œç»“æŸã€‚</p><ul><li>åœ¨è¯¸å¦‚å•CPUå¤„ç†å™¨æˆ–è€…è¾ƒå°çš„åº”ç”¨å†…å­˜ç­‰ç¡¬ä»¶å¹³å°ä¸æ˜¯ç‰¹åˆ«ä¼˜è¶Šçš„åœºåˆï¼Œä¸²è¡Œå›æ”¶å™¨çš„æ€§èƒ½è¡¨ç°å¯ä»¥è¶…è¿‡å¹¶è¡Œå›æ”¶å™¨å’Œå¹¶å‘å›æ”¶å™¨ã€‚æ‰€ä»¥ï¼Œä¸²è¡Œå›æ”¶é»˜è®¤è¢«åº”ç”¨åœ¨å®¢æˆ·ç«¯çš„Clientæ¨¡å¼ä¸‹çš„JVMä¸­</li><li>åœ¨å¹¶å‘èƒ½åŠ›æ¯”è¾ƒå¼ºçš„CPUä¸Šï¼Œå¹¶è¡Œå›æ”¶å™¨äº§ç”Ÿçš„åœé¡¿æ—¶é—´è¦çŸ­äºä¸²è¡Œå›æ”¶å™¨ã€‚</li></ul><p>å’Œä¸²è¡Œå›æ”¶ç›¸åï¼Œå¹¶è¡Œæ”¶é›†å¯ä»¥è¿ç”¨å¤šä¸ªCPUåŒæ—¶æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œå› æ­¤æå‡äº†åº”ç”¨çš„ååé‡ï¼Œä¸è¿‡å¹¶è¡Œå›æ”¶ä»ç„¶ä¸ä¸²è¡Œå›æ”¶ä¸€æ ·ï¼Œé‡‡ç”¨ç‹¬å å¼ï¼Œä½¿ç”¨äº†â€œstop-the-worldâ€æœºåˆ¶ã€‚</p><h4 id="æŒ‰å·¥ä½œæ¨¡å¼åˆ†"><a href="#æŒ‰å·¥ä½œæ¨¡å¼åˆ†" class="headerlink" title="æŒ‰å·¥ä½œæ¨¡å¼åˆ†"></a>æŒ‰å·¥ä½œæ¨¡å¼åˆ†</h4><p>æŒ‰ç…§å·¥ä½œæ¨¡å¼åˆ†ï¼Œå¯ä»¥åˆ†ä¸ºå¹¶å‘å¼åƒåœ¾å›æ”¶å™¨å’Œç‹¬å å¼åƒåœ¾å›æ”¶å™¨ã€‚</p><ul><li>å¹¶å‘å¼åƒåœ¾å›æ”¶å™¨ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿å·¥ä½œï¼Œä»¥å°½å¯èƒ½å‡å°‘åº”ç”¨ç¨‹åºçš„åœé¡¿æ—¶é—´ã€‚</li><li>ç‹¬å å¼åƒåœ¾å›æ”¶å™¨ï¼ˆStop the worldï¼‰ä¸€æ—¦è¿è¡Œï¼Œå°±åœæ­¢åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œç›´åˆ°åƒåœ¾å›æ”¶è¿‡ç¨‹å®Œå…¨ç»“æŸã€‚</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713083443486.png" alt="image-20200713083443486"></p><h4 id="æŒ‰ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†"><a href="#æŒ‰ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†" class="headerlink" title="æŒ‰ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†"></a>æŒ‰ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†</h4><p>æŒ‰ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†ï¼Œå¯åˆ†ä¸ºå‹ç¼©æ­¦åƒåœ¾å›æ”¶å™¨å’Œéå‹ç¼©å¼åƒåœ¾å›æ”¶å™¨ã€‚</p><ul><li>å‹ç¼©å¼åƒåœ¾å›æ”¶å™¨ä¼šåœ¨å›æ”¶å®Œæˆåï¼Œå¯¹å­˜æ´»å¯¹è±¡è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œæ¶ˆé™¤å›æ”¶åçš„ç¢ç‰‡ã€‚</li><li>éå‹ç¼©å¼çš„åƒåœ¾å›æ”¶å™¨ä¸è¿›è¡Œè¿™æ­¥æ“ä½œã€‚</li></ul><p>æŒ‰å·¥ä½œçš„å†…å­˜åŒºé—´åˆ†ï¼Œåˆå¯åˆ†ä¸ºå¹´è½»ä»£åƒåœ¾å›æ”¶å™¨å’Œè€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚</p><h3 id="1-2-è¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡"><a href="#1-2-è¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="1.2 è¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡"></a>1.2 è¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡</h3><ul><li><strong>ååé‡</strong>ï¼šè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹ï¼ˆæ€»è¿è¡Œæ—¶é—´ = ç¨‹åºçš„è¿è¡Œæ—¶é—´ + å†…å­˜å›æ”¶çš„æ—¶é—´ï¼‰</li><li><strong>åƒåœ¾æ”¶é›†å¼€é”€</strong>ï¼šååé‡çš„è¡¥æ•°ï¼Œåƒåœ¾æ”¶é›†æ‰€ç”¨æ—¶é—´ä¸æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹ã€‚</li><li><strong>æš‚åœæ—¶é—´</strong>ï¼šæ‰§è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹è¢«æš‚åœçš„æ—¶é—´ã€‚</li><li><strong>æ”¶é›†é¢‘ç‡</strong>ï¼šç›¸å¯¹äºåº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œæ”¶é›†æ“ä½œå‘ç”Ÿçš„é¢‘ç‡ã€‚</li><li><strong>å†…å­˜å ç”¨</strong>ï¼šJavaå †åŒºæ‰€å çš„å†…å­˜å¤§å°ã€‚</li><li><strong>å¿«é€Ÿ</strong>ï¼šä¸€ä¸ªå¯¹è±¡ä»è¯ç”Ÿåˆ°è¢«å›æ”¶æ‰€ç»å†çš„æ—¶é—´ã€‚</li></ul><p>ååé‡ã€æš‚åœæ—¶é—´ã€å†…å­˜å ç”¨ è¿™ä¸‰è€…å…±åŒæ„æˆä¸€ä¸ªâ€œä¸å¯èƒ½ä¸‰è§’â€ã€‚ä¸‰è€…æ€»ä½“çš„è¡¨ç°ä¼šéšç€æŠ€æœ¯è¿›æ­¥è€Œè¶Šæ¥è¶Šå¥½ã€‚ä¸€æ¬¾ä¼˜ç§€çš„æ”¶é›†å™¨é€šå¸¸æœ€å¤šåŒæ—¶æ»¡è¶³å…¶ä¸­çš„ä¸¤é¡¹ã€‚<br>è¿™ä¸‰é¡¹é‡Œï¼Œæš‚åœæ—¶é—´çš„é‡è¦æ€§æ—¥ç›Šå‡¸æ˜¾ã€‚å› ä¸ºéšç€ç¡¬ä»¶å‘å±•ï¼Œå†…å­˜å ç”¨å¤šäº›è¶Šæ¥è¶Šèƒ½å®¹å¿ï¼Œç¡¬ä»¶æ€§èƒ½çš„æå‡ä¹Ÿæœ‰åŠ©äºé™ä½æ”¶é›†å™¨è¿è¡Œæ—¶å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œå³æé«˜äº†ååé‡ã€‚è€Œå†…å­˜çš„æ‰©å¤§ï¼Œå¯¹å»¶è¿Ÿåè€Œå¸¦æ¥è´Ÿé¢æ•ˆæœã€‚<br>ç®€å•æ¥è¯´ï¼Œä¸»è¦æŠ“ä½ä¸¤ç‚¹ï¼š</p><p>è¿™ä¸‰é¡¹é‡Œï¼Œæš‚åœæ—¶é—´çš„é‡è¦æ€§æ—¥ç›Šå‡¸æ˜¾ã€‚å› ä¸ºéšç€ç¡¬ä»¶å‘å±•ï¼Œå†…å­˜å ç”¨å¤šäº›è¶Šæ¥è¶Šèƒ½å®¹å¿ï¼Œç¡¬ä»¶æ€§èƒ½çš„æå‡ä¹Ÿæœ‰åŠ©äºé™ä½æ”¶é›†å™¨è¿è¡Œæ—¶å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œå³æé«˜äº†ååé‡ã€‚è€Œå†…å­˜çš„æ‰©å¤§ï¼Œå¯¹å»¶è¿Ÿåè€Œå¸¦æ¥è´Ÿé¢æ•ˆæœã€‚<br>ç®€å•æ¥è¯´ï¼Œä¸»è¦æŠ“ä½ä¸¤ç‚¹ï¼š</p><ul><li>ååé‡</li><li>æš‚åœæ—¶é—´</li></ul><h3 id="1-3-æ€§èƒ½æŒ‡æ ‡ï¼šååé‡"><a href="#1-3-æ€§èƒ½æŒ‡æ ‡ï¼šååé‡" class="headerlink" title="1.3 æ€§èƒ½æŒ‡æ ‡ï¼šååé‡"></a>1.3 æ€§èƒ½æŒ‡æ ‡ï¼šååé‡</h3><p>ååé‡å°±æ˜¯CPUç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ï¼Œå³ååé‡=è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ /ï¼ˆè¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´+åƒåœ¾æ”¶é›†æ—¶é—´ï¼‰</p><blockquote><p>æ¯”å¦‚ï¼šè™šæ‹Ÿæœºæ€»å…±è¿è¡Œäº†100åˆ†é’Ÿï¼Œå…¶ä¸­åƒåœ¾æ”¶é›†èŠ±æ‰1åˆ†é’Ÿï¼Œé‚£ååé‡å°±æ˜¯99%ã€‚</p></blockquote><p>è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºèƒ½å®¹å¿è¾ƒé«˜çš„æš‚åœæ—¶é—´ï¼Œå› æ­¤ï¼Œé«˜ååé‡çš„åº”ç”¨ç¨‹åºæœ‰æ›´é•¿çš„æ—¶é—´åŸºå‡†ï¼Œå¿«é€Ÿå“åº”æ˜¯ä¸å¿…è€ƒè™‘çš„</p><p>ååé‡ä¼˜å…ˆï¼Œæ„å‘³ç€åœ¨å•ä½æ—¶é—´å†…ï¼ŒSTWçš„æ—¶é—´æœ€çŸ­ï¼š0.2+0.2=e.4</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713084726176.png" alt="image-20200713084726176"></p><h3 id="1-4-æ€§èƒ½æŒ‡æ ‡ï¼šæš‚åœæ—¶é—´"><a href="#1-4-æ€§èƒ½æŒ‡æ ‡ï¼šæš‚åœæ—¶é—´" class="headerlink" title="1.4 æ€§èƒ½æŒ‡æ ‡ï¼šæš‚åœæ—¶é—´"></a>1.4 æ€§èƒ½æŒ‡æ ‡ï¼šæš‚åœæ—¶é—´</h3><p>â€œæš‚åœæ—¶é—´â€æ˜¯æŒ‡ä¸€ä¸ªæ—¶é—´æ®µå†…åº”ç”¨ç¨‹åºçº¿ç¨‹æš‚åœï¼Œè®©Gcçº¿ç¨‹æ‰§è¡Œçš„çŠ¶æ€</p><p>ä¾‹å¦‚ï¼ŒGCæœŸé—´1eeæ¯«ç§’çš„æš‚åœæ—¶é—´æ„å‘³ç€åœ¨è¿™1e0æ¯«ç§’æœŸé—´å†…æ²¡æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹æ˜¯æ´»åŠ¨çš„ã€‚æš‚åœæ—¶é—´ä¼˜å…ˆï¼Œæ„å‘³ç€å°½å¯èƒ½è®©å•æ¬¡STWçš„æ—¶é—´æœ€çŸ­ï¼š0.1+0.1 + 0.1+ 0.1+ 0.1=0.5</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713085306400.png" alt="image-20200713085306400"></p><h3 id="1-5-ååé‡vsæš‚åœæ—¶é—´"><a href="#1-5-ååé‡vsæš‚åœæ—¶é—´" class="headerlink" title="1.5 ååé‡vsæš‚åœæ—¶é—´"></a>1.5 ååé‡vsæš‚åœæ—¶é—´</h3><p>é«˜ååé‡è¾ƒå¥½å› ä¸ºè¿™ä¼šè®©åº”ç”¨ç¨‹åºçš„æœ€ç»ˆç”¨æˆ·æ„Ÿè§‰åªæœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹åœ¨åšâ€œç”Ÿäº§æ€§â€å·¥ä½œã€‚ç›´è§‰ä¸Šï¼Œååé‡è¶Šé«˜ç¨‹åºè¿è¡Œè¶Šå¿«ã€‚</p><p>ä½æš‚åœæ—¶é—´ï¼ˆä½å»¶è¿Ÿï¼‰è¾ƒå¥½å› ä¸ºä»æœ€ç»ˆç”¨æˆ·çš„è§’åº¦æ¥çœ‹ä¸ç®¡æ˜¯GCè¿˜æ˜¯å…¶ä»–åŸå› å¯¼è‡´ä¸€ä¸ªåº”ç”¨è¢«æŒ‚èµ·å§‹ç»ˆæ˜¯ä¸å¥½çš„ã€‚è¿™å–å†³äºåº”ç”¨ç¨‹åºçš„ç±»å‹ï¼Œæœ‰æ—¶å€™ç”šè‡³çŸ­æš‚çš„200æ¯«ç§’æš‚åœéƒ½å¯èƒ½æ‰“æ–­ç»ˆç«¯ç”¨æˆ·ä½“éªŒã€‚å› æ­¤ï¼Œå…·æœ‰ä½çš„è¾ƒå¤§æš‚åœæ—¶é—´æ˜¯éå¸¸é‡è¦çš„ï¼Œç‰¹åˆ«æ˜¯å¯¹äºä¸€ä¸ªäº¤äº’å¼åº”ç”¨ç¨‹åºã€‚</p><p>ä¸å¹¸çš„æ˜¯â€é«˜ååé‡â€å’Œâ€ä½æš‚åœæ—¶é—´â€æ˜¯ä¸€å¯¹ç›¸äº’ç«äº‰çš„ç›®æ ‡ï¼ˆçŸ›ç›¾ï¼‰ã€‚</p><p>å› ä¸ºå¦‚æœé€‰æ‹©ä»¥ååé‡ä¼˜å…ˆï¼Œé‚£ä¹ˆå¿…ç„¶éœ€è¦é™ä½å†…å­˜å›æ”¶çš„æ‰§è¡Œé¢‘ç‡ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´GCéœ€è¦æ›´é•¿çš„æš‚åœæ—¶é—´æ¥æ‰§è¡Œå†…å­˜å›æ”¶ã€‚</p><p>ç›¸åçš„ï¼Œå¦‚æœé€‰æ‹©ä»¥ä½å»¶è¿Ÿä¼˜å…ˆä¸ºåŸåˆ™ï¼Œé‚£ä¹ˆä¸ºäº†é™ä½æ¯æ¬¡æ‰§è¡Œå†…å­˜å›æ”¶æ—¶çš„æš‚åœæ—¶é—´ï¼Œä¹Ÿåªèƒ½é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜å›æ”¶ï¼Œä½†è¿™åˆå¼•èµ·äº†å¹´è½»ä»£å†…å­˜çš„ç¼©å‡å’Œå¯¼è‡´ç¨‹åºååé‡çš„ä¸‹é™ã€‚</p><p>åœ¨è®¾è®¡ï¼ˆæˆ–ä½¿ç”¨ï¼‰GCç®—æ³•æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®å®šæˆ‘ä»¬çš„ç›®æ ‡ï¼šä¸€ä¸ªGCç®—æ³•åªå¯èƒ½é’ˆå¯¹ä¸¤ä¸ªç›®æ ‡ä¹‹ä¸€ï¼ˆå³åªä¸“æ³¨äºè¾ƒå¤§ååé‡æˆ–æœ€å°æš‚åœæ—¶é—´ï¼‰ï¼Œæˆ–å°è¯•æ‰¾åˆ°ä¸€ä¸ªäºŒè€…çš„æŠ˜è¡·ã€‚</p><p>ç°åœ¨æ ‡å‡†ï¼š<strong>åœ¨æœ€å¤§ååé‡ä¼˜å…ˆçš„æƒ…å†µä¸‹ï¼Œé™ä½åœé¡¿æ—¶é—´</strong></p><h2 id="2-ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°"><a href="#2-ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°" class="headerlink" title="2 ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°"></a>2 ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°</h2><p>åƒåœ¾æ”¶é›†æœºåˆ¶æ˜¯Javaçš„æ‹›ç‰Œèƒ½åŠ›ï¼Œæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ã€‚è¿™å½“ç„¶ä¹Ÿæ˜¯é¢è¯•çš„çƒ­ç‚¹ã€‚</p><p>é‚£ä¹ˆï¼ŒJavaå¸¸è§çš„åƒåœ¾æ”¶é›†å™¨æœ‰å“ªäº›ï¼Ÿ</p><blockquote><p>GCåƒåœ¾æ”¶é›†å™¨æ˜¯å’ŒJVMä¸€è„‰ç›¸æ‰¿çš„ï¼Œå®ƒæ˜¯å’ŒJVMè¿›è¡Œæ­é…ä½¿ç”¨ï¼Œåœ¨ä¸åŒçš„ä½¿ç”¨åœºæ™¯å¯¹åº”çš„æ”¶é›†å™¨ä¹Ÿæ˜¯æœ‰åŒºåˆ«</p></blockquote><h3 id="2-1-åƒåœ¾å›æ”¶å™¨å‘å±•å²"><a href="#2-1-åƒåœ¾å›æ”¶å™¨å‘å±•å²" class="headerlink" title="2.1 åƒåœ¾å›æ”¶å™¨å‘å±•å²"></a>2.1 åƒåœ¾å›æ”¶å™¨å‘å±•å²</h3><p>æœ‰äº†è™šæ‹Ÿæœºï¼Œå°±ä¸€å®šéœ€è¦æ”¶é›†åƒåœ¾çš„æœºåˆ¶ï¼Œè¿™å°±æ˜¯Garbage Collectionï¼Œå¯¹åº”çš„äº§å“æˆ‘ä»¬ç§°ä¸ºGarbage Collectorã€‚</p><ul><li>1999å¹´éšJDK1.3.1ä¸€èµ·æ¥çš„æ˜¯ä¸²è¡Œæ–¹å¼çš„serialGcï¼Œå®ƒæ˜¯ç¬¬ä¸€æ¬¾GCã€‚ParNewåƒåœ¾æ”¶é›†å™¨æ˜¯Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬</li><li>2002å¹´2æœˆ26æ—¥ï¼ŒParallel GCå’ŒConcurrent Mark Sweep GCè·ŸéšJDK1.4.2ä¸€èµ·å‘å¸ƒÂ·</li><li>Parallel GCåœ¨JDK6ä¹‹åæˆä¸ºHotSpoté»˜è®¤GCã€‚</li><li>2012å¹´ï¼Œåœ¨JDK1.7u4ç‰ˆæœ¬ä¸­ï¼ŒG1å¯ç”¨ã€‚</li><li>2017å¹´ï¼ŒJDK9ä¸­G1å˜æˆé»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä»¥æ›¿ä»£CMSã€‚</li><li>2018å¹´3æœˆï¼ŒJDK10ä¸­G1åƒåœ¾å›æ”¶å™¨çš„å¹¶è¡Œå®Œæ•´åƒåœ¾å›æ”¶ï¼Œå®ç°å¹¶è¡Œæ€§æ¥æ”¹å–„æœ€åæƒ…å†µä¸‹çš„å»¶è¿Ÿã€‚</li><li>2018å¹´9æœˆï¼ŒJDK11å‘å¸ƒã€‚å¼•å…¥Epsilon åƒåœ¾å›æ”¶å™¨ï¼Œåˆè¢«ç§°ä¸º â€œNo-Op(æ— æ“ä½œ)â€œ å›æ”¶å™¨ã€‚åŒæ—¶ï¼Œå¼•å…¥ZGCï¼šå¯ä¼¸ç¼©çš„ä½å»¶è¿Ÿåƒåœ¾å›æ”¶å™¨ï¼ˆExperimentalï¼‰</li><li>2019å¹´3æœˆï¼ŒJDK12å‘å¸ƒã€‚å¢å¼ºG1ï¼Œè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿã€‚åŒæ—¶ï¼Œå¼•å…¥Shenandoah GCï¼šä½åœé¡¿æ—¶é—´çš„GCï¼ˆExperimentalï¼‰ã€‚Â·2019å¹´9æœˆï¼ŒJDK13å‘å¸ƒã€‚å¢å¼ºzGCï¼Œè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿã€‚</li><li>2020å¹´3æœˆï¼ŒJDK14å‘å¸ƒã€‚åˆ é™¤cMsåƒåœ¾å›æ”¶å™¨ã€‚æ‰©å±•zGCåœ¨macoså’ŒWindowsä¸Šçš„åº”ç”¨</li></ul><h3 id="2-2-7ç§ç»å…¸çš„åƒåœ¾æ”¶é›†å™¨"><a href="#2-2-7ç§ç»å…¸çš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="2.2 7ç§ç»å…¸çš„åƒåœ¾æ”¶é›†å™¨"></a>2.2 7ç§ç»å…¸çš„åƒåœ¾æ”¶é›†å™¨</h3><ul><li>ä¸²è¡Œå›æ”¶å™¨ï¼šSerialã€Serial old</li><li>å¹¶è¡Œå›æ”¶å™¨ï¼šParNewã€Parallel Scavengeã€Parallel old</li><li>å¹¶å‘å›æ”¶å™¨ï¼šCMSã€G11</li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713093551365.png" alt="image-20200713093551365"></p><h3 id="2-3-7æ¬¾ç»å…¸æ”¶é›†å™¨ä¸åƒåœ¾åˆ†ä»£ä¹‹é—´çš„å…³ç³»"><a href="#2-3-7æ¬¾ç»å…¸æ”¶é›†å™¨ä¸åƒåœ¾åˆ†ä»£ä¹‹é—´çš„å…³ç³»" class="headerlink" title="2.3 7æ¬¾ç»å…¸æ”¶é›†å™¨ä¸åƒåœ¾åˆ†ä»£ä¹‹é—´çš„å…³ç³»"></a>2.3 7æ¬¾ç»å…¸æ”¶é›†å™¨ä¸åƒåœ¾åˆ†ä»£ä¹‹é—´çš„å…³ç³»</h3><p><img src="https://gitee.com/moxi159753/LearningNotes/raw/master/JVM/1_%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87/17_%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8/images/image-20200713093757644.png" alt="image-20200713093757644"></p><p>æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼šSerialã€ParNewã€Paralle1 Scavengeï¼›</p><p>è€å¹´ä»£æ”¶é›†å™¨ï¼šSerial oldã€Parallel oldã€CMSï¼›</p><p>æ•´å †æ”¶é›†å™¨ï¼šG1ï¼›</p><h3 id="2-4-åƒåœ¾æ”¶é›†å™¨çš„ç»„åˆå…³ç³»"><a href="#2-4-åƒåœ¾æ”¶é›†å™¨çš„ç»„åˆå…³ç³»" class="headerlink" title="2.4 åƒåœ¾æ”¶é›†å™¨çš„ç»„åˆå…³ç³»"></a>2.4 åƒåœ¾æ”¶é›†å™¨çš„ç»„åˆå…³ç³»</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713094745366.png" alt="image-20200713094745366"></p><ul><li>ä¸¤ä¸ªæ”¶é›†å™¨é—´æœ‰è¿çº¿ï¼Œè¡¨æ˜å®ƒä»¬å¯ä»¥æ­é…ä½¿ç”¨ï¼šSerial/Serial oldã€Serial/CMSã€ParNew/Serial oldã€ParNew/CMSã€Parallel Scavenge/Serial 0ldã€Parallel Scavenge/Parallel 01dã€G1ï¼›</li><li>å…¶ä¸­Serial o1dä½œä¸ºCMså‡ºç°â€Concurrent Mode Failureâ€å¤±è´¥çš„åå¤‡é¢„æ¡ˆã€‚</li><li>ï¼ˆçº¢è‰²è™šçº¿ï¼‰ç”±äºç»´æŠ¤å’Œå…¼å®¹æ€§æµ‹è¯•çš„æˆæœ¬ï¼Œåœ¨JDK 8æ—¶å°†Serial+CMSã€ParNew+Serial oldè¿™ä¸¤ä¸ªç»„åˆå£°æ˜ä¸ºåºŸå¼ƒï¼ˆJEP173ï¼‰ï¼Œå¹¶åœ¨JDK9ä¸­å®Œå…¨å–æ¶ˆäº†è¿™äº›ç»„åˆçš„æ”¯æŒï¼ˆJEP214ï¼‰ï¼Œå³ï¼šç§»é™¤ã€‚</li><li>ï¼ˆç»¿è‰²è™šçº¿ï¼‰JDK14ä¸­ï¼šå¼ƒç”¨Paralle1 Scavengeå’ŒSerialold GCç»„åˆï¼ˆJEP366ï¼‰</li><li>ï¼ˆé’è‰²è™šçº¿ï¼‰JDK14ä¸­ï¼šåˆ é™¤CMsåƒåœ¾å›æ”¶å™¨ï¼ˆJEP363ï¼‰</li></ul><p>ä¸ºä»€ä¹ˆè¦æœ‰å¾ˆå¤šæ”¶é›†å™¨ï¼Œä¸€ä¸ªä¸å¤Ÿå—ï¼Ÿå› ä¸ºJavaçš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œç§»åŠ¨ç«¯ï¼ŒæœåŠ¡å™¨ç­‰ã€‚æ‰€ä»¥å°±éœ€è¦é’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œæä¾›ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨ï¼Œæé«˜åƒåœ¾æ”¶é›†çš„æ€§èƒ½ã€‚</p><p>è™½ç„¶æˆ‘ä»¬ä¼šå¯¹å„ä¸ªæ”¶é›†å™¨è¿›è¡Œæ¯”è¾ƒï¼Œä½†å¹¶éä¸ºäº†æŒ‘é€‰ä¸€ä¸ªæœ€å¥½çš„æ”¶é›†å™¨å‡ºæ¥ã€‚æ²¡æœ‰ä¸€ç§æ”¾ä¹‹å››æµ·çš†å‡†ã€ä»»ä½•åœºæ™¯ä¸‹éƒ½é€‚ç”¨çš„å®Œç¾æ”¶é›†å™¨å­˜åœ¨ï¼Œæ›´åŠ æ²¡æœ‰ä¸‡èƒ½çš„æ”¶é›†å™¨ã€‚æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©çš„åªæ˜¯å¯¹å…·ä½“åº”ç”¨æœ€åˆé€‚çš„æ”¶é›†å™¨ã€‚</p><h3 id="2-5-å¦‚ä½•æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨"><a href="#2-5-å¦‚ä½•æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="2.5 å¦‚ä½•æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨"></a>2.5 å¦‚ä½•æŸ¥çœ‹é»˜è®¤åƒåœ¾æ”¶é›†å™¨</h3><p>-XX:+PrintcommandLineFlagsï¼šæŸ¥çœ‹å‘½ä»¤è¡Œç›¸å…³å‚æ•°ï¼ˆåŒ…å«ä½¿ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼‰</p><p>ä½¿ç”¨å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼šjinfo -flag  ç›¸å…³åƒåœ¾å›æ”¶å™¨å‚æ•°  è¿›ç¨‹ID</p><h2 id="3-Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶"><a href="#3-Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶" class="headerlink" title="3 Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶"></a>3 Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶</h2><p>Serialæ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚JDK1.3ä¹‹å‰å›æ”¶æ–°ç”Ÿä»£å”¯ä¸€çš„é€‰æ‹©ã€‚</p><p>Serialæ”¶é›†å™¨ä½œä¸ºHotSpotä¸­clientæ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨ã€‚</p><p>Serialæ”¶é›†å™¨é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€ä¸²è¡Œå›æ”¶å’Œâ€stop-the-Worldâ€æœºåˆ¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶ã€‚</p><p>é™¤äº†å¹´è½»ä»£ä¹‹å¤–ï¼ŒSerialæ”¶é›†å™¨è¿˜æä¾›ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†çš„Serial oldæ”¶é›†å™¨ã€‚Serial oldæ”¶é›†å™¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†ä¸²è¡Œå›æ”¶å’Œâ€stop the Worldâ€æœºåˆ¶ï¼Œåªä¸è¿‡å†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯æ ‡è®°-å‹ç¼©ç®—æ³•ã€‚</p><ul><li>Serial oldæ˜¯è¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£çš„åƒåœ¾å›æ”¶å™¨</li><li>Serial 0ldåœ¨Serveræ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼š<ul><li>ä¸æ–°ç”Ÿä»£çš„Parallel scavengeé…åˆä½¿ç”¨</li><li>ä½œä¸ºè€å¹´ä»£CMSæ”¶é›†å™¨çš„åå¤‡åƒåœ¾æ”¶é›†æ–¹æ¡ˆ</li></ul></li></ul><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713100703799.png" alt="image-20200713100703799"></p><p>è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œä½†å®ƒçš„â€œå•çº¿ç¨‹â€çš„æ„ä¹‰å¹¶ä¸ä»…ä»…è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸï¼ˆStop The Worldï¼‰</p><p>ä¼˜åŠ¿ï¼šç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹æ¯”ï¼‰ï¼Œå¯¹äºé™å®šå•ä¸ªcPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšåƒåœ¾æ”¶é›†è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚</p><p>è¿è¡Œåœ¨clientæ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p>åœ¨ç”¨æˆ·çš„æ¡Œé¢åº”ç”¨åœºæ™¯ä¸­ï¼Œå¯ç”¨å†…å­˜ä¸€èˆ¬ä¸å¤§ï¼ˆå‡ åMBè‡³ä¸€ä¸¤ç™¾MBï¼‰ï¼Œå¯ä»¥åœ¨è¾ƒçŸ­æ—¶é—´å†…å®Œæˆåƒåœ¾æ”¶é›†ï¼ˆå‡ åmsè‡³ä¸€ç™¾å¤šmsï¼‰ï¼Œåªè¦ä¸é¢‘ç¹å‘ç”Ÿï¼Œä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p><p>åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œä½¿ç”¨-XXï¼š+UseSerialGCå‚æ•°å¯ä»¥æŒ‡å®šå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ã€‚</p><p>ç­‰ä»·äºæ–°ç”Ÿä»£ç”¨Serial GCï¼Œä¸”è€å¹´ä»£ç”¨Serial old GC</p><h3 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™ç§åƒåœ¾æ”¶é›†å™¨å¤§å®¶äº†è§£ï¼Œç°åœ¨å·²ç»ä¸ç”¨ä¸²è¡Œçš„äº†ã€‚è€Œä¸”åœ¨é™å®šå•æ ¸cpuæ‰å¯ä»¥ç”¨ã€‚ç°åœ¨éƒ½ä¸æ˜¯å•æ ¸çš„äº†ã€‚</p><p>å¯¹äºäº¤äº’è¾ƒå¼ºçš„åº”ç”¨è€Œè¨€ï¼Œè¿™ç§åƒåœ¾æ”¶é›†å™¨æ˜¯ä¸èƒ½æ¥å—çš„ã€‚ä¸€èˆ¬åœ¨Java webåº”ç”¨ç¨‹åºä¸­æ˜¯ä¸ä¼šé‡‡ç”¨ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨çš„ã€‚</p><h2 id="4-ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶"><a href="#4-ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶" class="headerlink" title="4 ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶"></a>4 ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶</h2><p>å¦‚æœè¯´serialGCæ˜¯å¹´è½»ä»£ä¸­çš„å•çº¿ç¨‹åƒåœ¾æ”¶é›†å™¨ï¼Œé‚£ä¹ˆParNewæ”¶é›†å™¨åˆ™æ˜¯serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚</p><ul><li>Paræ˜¯Parallelçš„ç¼©å†™ï¼ŒNewï¼šåªèƒ½å¤„ç†çš„æ˜¯æ–°ç”Ÿä»£</li></ul><p>ParNew æ”¶é›†å™¨é™¤äº†é‡‡ç”¨å¹¶è¡Œå›æ”¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶å¤–ï¼Œä¸¤æ¬¾åƒåœ¾æ”¶é›†å™¨ä¹‹é—´å‡ ä¹æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ParNewæ”¶é›†å™¨åœ¨å¹´è½»ä»£ä¸­åŒæ ·ä¹Ÿæ˜¯é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€â€stop-the-Worldâ€æœºåˆ¶ã€‚</p><p>ParNew æ˜¯å¾ˆå¤šJVMè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹æ–°ç”Ÿä»£çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713102030127.png" alt="image-20200713102030127"></p><ul><li>å¯¹äºæ–°ç”Ÿä»£ï¼Œå›æ”¶æ¬¡æ•°é¢‘ç¹ï¼Œä½¿ç”¨å¹¶è¡Œæ–¹å¼é«˜æ•ˆã€‚</li><li>å¯¹äºè€å¹´ä»£ï¼Œå›æ”¶æ¬¡æ•°å°‘ï¼Œä½¿ç”¨ä¸²è¡Œæ–¹å¼èŠ‚çœèµ„æºã€‚ï¼ˆCPUå¹¶è¡Œéœ€è¦åˆ‡æ¢çº¿ç¨‹ï¼Œä¸²è¡Œå¯ä»¥çœå»åˆ‡æ¢çº¿ç¨‹çš„èµ„æºï¼‰</li></ul><p>ç”±äºParNewæ”¶é›†å™¨æ˜¯åŸºäºå¹¶è¡Œå›æ”¶ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥æ–­å®šParNewæ”¶é›†å™¨çš„å›æ”¶æ•ˆç‡åœ¨ä»»ä½•åœºæ™¯ä¸‹éƒ½ä¼šæ¯”serialæ”¶é›†å™¨æ›´é«˜æ•ˆï¼Ÿ</p><ul><li></li></ul><p>å› ä¸ºé™¤Serialå¤–ï¼Œç›®å‰åªæœ‰ParNew GCèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œ</p><p>åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹â€-XXï¼š+UseParNewGCâ€æ‰‹åŠ¨æŒ‡å®šä½¿ç”¨ParNewæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚å®ƒè¡¨ç¤ºå¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨ï¼Œä¸å½±å“è€å¹´ä»£ã€‚</p><p>-XX:ParallelGCThreadsé™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤å¼€å¯å’ŒCPUæ•°æ®ç›¸åŒçš„çº¿ç¨‹æ•°ã€‚</p><h2 id="5-Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ"><a href="#5-Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ" class="headerlink" title="5 Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ"></a>5 Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ</h2><p>HotSpotçš„å¹´è½»ä»£ä¸­é™¤äº†æ‹¥æœ‰ParNewæ”¶é›†å™¨æ˜¯åŸºäºå¹¶è¡Œå›æ”¶çš„ä»¥å¤–ï¼ŒParallel Scavengeæ”¶é›†å™¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†å¤åˆ¶ç®—æ³•ã€å¹¶è¡Œå›æ”¶å’Œâ€Stop the Worldâ€æœºåˆ¶ã€‚</p><p>é‚£ä¹ˆParallel æ”¶é›†å™¨çš„å‡ºç°æ˜¯å¦å¤šæ­¤ä¸€ä¸¾ï¼Ÿ</p><ul><li>å’ŒParNewæ”¶é›†å™¨ä¸åŒï¼ŒParallelScavengeæ”¶é›†å™¨çš„ç›®æ ‡åˆ™æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼ˆThroughputï¼‰ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸ºååé‡ä¼˜å…ˆçš„åƒåœ¾æ”¶é›†å™¨ã€‚</li><li>è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯Paralle1 Scavengeä¸ParNewä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚</li></ul><p>é«˜ååé‡åˆ™å¯ä»¥é«˜æ•ˆç‡åœ°åˆ©ç”¨CPUæ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œä¸»è¦é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œå¸¸è§åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œé‚£äº›æ‰§è¡Œæ‰¹é‡å¤„ç†ã€è®¢å•å¤„ç†ã€å·¥èµ„æ”¯ä»˜ã€ç§‘å­¦è®¡ç®—çš„åº”ç”¨ç¨‹åºã€‚</p><p>Paralle1æ”¶é›†å™¨åœ¨JDK1.6æ—¶æä¾›äº†ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†çš„Paralle1o1dæ”¶é›†å™¨ï¼Œç”¨æ¥ä»£æ›¿è€å¹´ä»£çš„serialoldæ”¶é›†å™¨ã€‚</p><p>Parallel oldæ”¶é›†å™¨é‡‡ç”¨äº†æ ‡è®°-å‹ç¼©ç®—æ³•ï¼Œä½†åŒæ ·ä¹Ÿæ˜¯åŸºäºå¹¶è¡Œå›æ”¶å’Œâ€stop-the-Worldâ€æœºåˆ¶ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713110359441.png" alt="image-20200713110359441"></p><p>åœ¨ç¨‹åºååé‡ä¼˜å…ˆçš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒIParalle1æ”¶é›†å™¨å’ŒParallel oldæ”¶é›†å™¨çš„ç»„åˆï¼Œåœ¨serveræ¨¡å¼ä¸‹çš„å†…å­˜å›æ”¶æ€§èƒ½å¾ˆä¸é”™ã€‚åœ¨Java8ä¸­ï¼Œé»˜è®¤æ˜¯æ­¤åƒåœ¾æ”¶é›†å™¨ã€‚</p><h3 id="å‚æ•°é…ç½®"><a href="#å‚æ•°é…ç½®" class="headerlink" title="å‚æ•°é…ç½®"></a>å‚æ•°é…ç½®</h3><p>-XXï¼š+UseParallelGC æ‰‹åŠ¨æŒ‡å®šå¹´è½»ä»£ä½¿ç”¨Paralle1å¹¶è¡Œæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚</p><p>-XXï¼š+UseParalleloldcc æ‰‹åŠ¨æŒ‡å®šè€å¹´ä»£éƒ½æ˜¯ä½¿ç”¨å¹¶è¡Œå›æ”¶æ”¶é›†å™¨ã€‚</p><ul><li>åˆ†åˆ«é€‚ç”¨äºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚é»˜è®¤jdk8æ˜¯å¼€å¯çš„ã€‚</li><li>ä¸Šé¢ä¸¤ä¸ªå‚æ•°ï¼Œé»˜è®¤å¼€å¯ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šè¢«å¼€å¯ã€‚ï¼ˆäº’ç›¸æ¿€æ´»ï¼‰</li></ul><p>-XX:ParallelGcrhreadsè®¾ç½®å¹´è½»ä»£å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ã€‚ä¸€èˆ¬åœ°ï¼Œæœ€å¥½ä¸CPUæ•°é‡ç›¸ç­‰ï¼Œä»¥é¿å…è¿‡å¤šçš„çº¿ç¨‹æ•°å½±å“åƒåœ¾æ”¶é›†æ€§èƒ½ã€‚</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“CPUæ•°é‡å°äº8ä¸ªï¼ŒParallelGcThreadsçš„å€¼ç­‰äºCPUæ•°é‡ã€‚</p><p>å½“CPUæ•°é‡å¤§äº8ä¸ªï¼ŒParallelGCThreadsçš„å€¼ç­‰äº3+[5*CPU Count]/8]</p><p>-XX:MaxGCPauseMillis è®¾ç½®åƒåœ¾æ”¶é›†å™¨æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆå³STwçš„æ—¶é—´ï¼‰ã€‚å•ä½æ˜¯æ¯«ç§’ã€‚</p><p>ä¸ºäº†å°½å¯èƒ½åœ°æŠŠåœé¡¿æ—¶é—´æ§åˆ¶åœ¨MaxGCPauseMi11sä»¥å†…ï¼Œæ”¶é›†å™¨åœ¨å·¥ä½œæ—¶ä¼šè°ƒæ•´Javaå †å¤§å°æˆ–è€…å…¶ä»–ä¸€äº›å‚æ•°ã€‚<br>å¯¹äºç”¨æˆ·æ¥è®²ï¼Œåœé¡¿æ—¶é—´è¶ŠçŸ­ä½“éªŒè¶Šå¥½ã€‚ä½†æ˜¯åœ¨æœåŠ¡å™¨ç«¯ï¼Œæˆ‘ä»¬æ³¨é‡é«˜å¹¶å‘ï¼Œæ•´ä½“çš„ååé‡ã€‚æ‰€ä»¥æœåŠ¡å™¨ç«¯é€‚åˆParallelï¼Œè¿›è¡Œæ§åˆ¶ã€‚è¯¥å‚æ•°ä½¿ç”¨éœ€è°¨æ…ã€‚</p><p>-XX:GCTimeRatioåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ä¾‹ï¼ˆ=1/ï¼ˆN+1ï¼‰ï¼‰ã€‚ç”¨äºè¡¡é‡ååé‡çš„å¤§å°ã€‚</p><p>å–å€¼èŒƒå›´ï¼ˆ0ï¼Œ100ï¼‰ã€‚é»˜è®¤å€¼99ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾å›æ”¶æ—¶é—´ä¸è¶…è¿‡1ã€‚</p><p>ä¸å‰ä¸€ä¸ª-xx:MaxGCPauseMilliså‚æ•°æœ‰ä¸€å®šçŸ›ç›¾æ€§ã€‚æš‚åœæ—¶é—´è¶Šé•¿ï¼ŒRadioå‚æ•°å°±å®¹æ˜“è¶…è¿‡è®¾å®šçš„æ¯”ä¾‹ã€‚</p><p>-XX:+UseAdaptivesizepplicy è®¾ç½®Parallel scavengeæ”¶é›†å™¨å…·æœ‰è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥</p><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¹´è½»ä»£çš„å¤§å°ã€Edenå’ŒSurvivorçš„æ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ç­‰å‚æ•°ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ï¼Œå·²è¾¾åˆ°åœ¨å †å¤§å°ã€ååé‡å’Œåœé¡¿æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ç‚¹ã€‚</p><p>åœ¨æ‰‹åŠ¨è°ƒä¼˜æ¯”è¾ƒå›°éš¾çš„åœºåˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ç§è‡ªé€‚åº”çš„æ–¹å¼ï¼Œä»…æŒ‡å®šè™šæ‹Ÿæœºçš„æœ€å¤§å †ã€ç›®æ ‡çš„ååé‡ï¼ˆGCTimeRatioï¼‰å’Œåœé¡¿æ—¶é—´ï¼ˆMaxGCPauseMil1sï¼‰ï¼Œè®©è™šæ‹Ÿæœºè‡ªå·±å®Œæˆè°ƒä¼˜å·¥ä½œã€‚</p><h2 id="6-CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"><a href="#6-CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ" class="headerlink" title="6 CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"></a>6 CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ</h2><p>åœ¨JDK1.5æ—¶æœŸï¼ŒHotspotæ¨å‡ºäº†ä¸€æ¬¾åœ¨å¼ºäº¤äº’åº”ç”¨ä¸­å‡ ä¹å¯è®¤ä¸ºæœ‰åˆ’æ—¶ä»£æ„ä¹‰çš„åƒåœ¾æ”¶é›†å™¨ï¼šcMSï¼ˆConcurrent-Mark-Sweepï¼‰æ”¶é›†å™¨ï¼Œè¿™æ¬¾æ”¶é›†å™¨æ˜¯HotSpotè™šæ‹Ÿæœºä¸­ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œ<strong>å®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œ</strong>ã€‚</p><p>CMSæ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ã€‚åœé¡¿æ—¶é—´è¶ŠçŸ­ï¼ˆä½å»¶è¿Ÿï¼‰å°±è¶Šé€‚åˆä¸ç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒã€‚</p><p>ç›®å‰å¾ˆå¤§ä¸€éƒ¨åˆ†çš„Javaåº”ç”¨é›†ä¸­åœ¨äº’è”ç½‘ç«™æˆ–è€…B/Sç³»ç»Ÿçš„æœåŠ¡ç«¯ä¸Šï¼Œè¿™ç±»åº”ç”¨å°¤å…¶é‡è§†æœåŠ¡çš„å“åº”é€Ÿåº¦ï¼Œå¸Œæœ›ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€çŸ­ï¼Œä»¥ç»™ç”¨æˆ·å¸¦æ¥è¾ƒå¥½çš„ä½“éªŒã€‚CMSæ”¶é›†å™¨å°±éå¸¸ç¬¦åˆè¿™ç±»åº”ç”¨çš„éœ€æ±‚ã€‚</p><p>CMSçš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå¹¶ä¸”ä¹Ÿä¼šâ€stop-the-worldâ€</p><p>ä¸å¹¸çš„æ˜¯ï¼ŒCMSä½œä¸ºè€å¹´ä»£çš„æ”¶é›†å™¨ï¼Œå´æ— æ³•ä¸JDK1.4.0ä¸­å·²ç»å­˜åœ¨çš„æ–°ç”Ÿä»£æ”¶é›†å™¨Parallel Scavengeé…åˆå·¥ä½œï¼Œæ‰€ä»¥åœ¨JDK1.5ä¸­ä½¿ç”¨CMSæ¥æ”¶é›†è€å¹´ä»£çš„æ—¶å€™ï¼Œæ–°ç”Ÿä»£åªèƒ½é€‰æ‹©ParNewæˆ–è€…Serialæ”¶é›†å™¨ä¸­çš„ä¸€ä¸ªã€‚</p><p>åœ¨G1å‡ºç°ä¹‹å‰ï¼ŒCMSä½¿ç”¨è¿˜æ˜¯éå¸¸å¹¿æ³›çš„ã€‚ä¸€ç›´åˆ°ä»Šå¤©ï¼Œä»ç„¶æœ‰å¾ˆå¤šç³»ç»Ÿä½¿ç”¨CMS GCã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713205154007.png" alt="image-20200713205154007"></p><p>CMSæ•´ä¸ªè¿‡ç¨‹æ¯”ä¹‹å‰çš„æ”¶é›†å™¨è¦å¤æ‚ï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸º4ä¸ªä¸»è¦é˜¶æ®µï¼Œå³åˆå§‹æ ‡è®°é˜¶æ®µã€å¹¶å‘æ ‡è®°é˜¶æ®µã€é‡æ–°æ ‡è®°é˜¶æ®µå’Œå¹¶å‘æ¸…é™¤é˜¶æ®µã€‚(æ¶‰åŠSTWçš„é˜¶æ®µä¸»è¦æ˜¯ï¼šåˆå§‹æ ‡è®° å’Œ é‡æ–°æ ‡è®°)</p><ul><li><strong>åˆå§‹æ ‡è®°</strong>ï¼ˆInitial-Markï¼‰é˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œç¨‹åºä¸­æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹éƒ½å°†ä¼šå› ä¸ºâ€œstop-the-worldâ€æœºåˆ¶è€Œå‡ºç°çŸ­æš‚çš„æš‚åœï¼Œè¿™ä¸ªé˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä»…ä»…åªæ˜¯<strong>æ ‡è®°å‡ºGCRootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡</strong>ã€‚ä¸€æ—¦æ ‡è®°å®Œæˆä¹‹åå°±ä¼šæ¢å¤ä¹‹å‰è¢«æš‚åœçš„æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚ç”±äºç›´æ¥å…³è”å¯¹è±¡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€Ÿåº¦éå¸¸å¿«ã€‚</li><li><strong>å¹¶å‘æ ‡è®°</strong>ï¼ˆConcurrent-Markï¼‰é˜¶æ®µï¼šä»Gc Rootsçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œã€‚</li><li><strong>é‡æ–°æ ‡è®°</strong>ï¼ˆRemarkï¼‰é˜¶æ®µï¼šç”±äºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹ä¼šå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œï¼Œå› æ­¤ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´é€šå¸¸ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µç¨é•¿ä¸€äº›ï¼Œä½†ä¹Ÿè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µçš„æ—¶é—´çŸ­ã€‚</li><li><strong>å¹¶å‘æ¸…é™¤</strong>ï¼ˆConcurrent-Sweepï¼‰é˜¶æ®µï¼šæ­¤é˜¶æ®µæ¸…ç†åˆ é™¤æ‰æ ‡è®°é˜¶æ®µåˆ¤æ–­çš„å·²ç»æ­»äº¡çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ç”±äºä¸éœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å¹¶å‘çš„</li></ul><p>å°½ç®¡CMSæ”¶é›†å™¨é‡‡ç”¨çš„æ˜¯å¹¶å‘å›æ”¶ï¼ˆéç‹¬å å¼ï¼‰ï¼Œä½†æ˜¯åœ¨å…¶åˆå§‹åŒ–æ ‡è®°å’Œå†æ¬¡æ ‡è®°è¿™ä¸¤ä¸ªé˜¶æ®µä¸­ä»ç„¶éœ€è¦æ‰§è¡Œâ€œStop-the-Worldâ€æœºåˆ¶æš‚åœç¨‹åºä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œä¸è¿‡æš‚åœæ—¶é—´å¹¶ä¸ä¼šå¤ªé•¿ï¼Œå› æ­¤å¯ä»¥è¯´æ˜ç›®å‰æ‰€æœ‰çš„åƒåœ¾æ”¶é›†å™¨éƒ½åšä¸åˆ°å®Œå…¨ä¸éœ€è¦â€œstop-the-Worldâ€ï¼Œåªæ˜¯å°½å¯èƒ½åœ°ç¼©çŸ­æš‚åœæ—¶é—´ã€‚</p><p>ç”±äºæœ€è€—è´¹æ—¶é—´çš„å¹¶å‘æ ‡è®°ä¸å¹¶å‘æ¸…é™¤é˜¶æ®µéƒ½ä¸éœ€è¦æš‚åœå·¥ä½œï¼Œæ‰€ä»¥æ•´ä½“çš„å›æ”¶æ˜¯ä½åœé¡¿çš„ã€‚</p><p>å¦å¤–ï¼Œç”±äºåœ¨åƒåœ¾æ”¶é›†é˜¶æ®µç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ä¸­æ–­ï¼Œæ‰€ä»¥åœ¨CMSå›æ”¶è¿‡ç¨‹ä¸­ï¼Œè¿˜åº”è¯¥ç¡®ä¿åº”ç”¨ç¨‹åºç”¨æˆ·çº¿ç¨‹æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ç”¨ã€‚å› æ­¤ï¼ŒCMSæ”¶é›†å™¨ä¸èƒ½åƒå…¶ä»–æ”¶é›†å™¨é‚£æ ·ç­‰åˆ°è€å¹´ä»£å‡ ä¹å®Œå…¨è¢«å¡«æ»¡äº†å†è¿›è¡Œæ”¶é›†ï¼Œè€Œæ˜¯å½“å †å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°æŸä¸€é˜ˆå€¼æ—¶ï¼Œä¾¿å¼€å§‹è¿›è¡Œå›æ”¶ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºåœ¨CMSå·¥ä½œè¿‡ç¨‹ä¸­ä¾ç„¶æœ‰è¶³å¤Ÿçš„ç©ºé—´æ”¯æŒåº”ç”¨ç¨‹åºè¿è¡Œã€‚è¦æ˜¯CMSè¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºéœ€è¦ï¼Œå°±ä¼šå‡ºç°ä¸€æ¬¡â€œConcurrent Mode Failureâ€<br>å¤±è´¥ï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†å¯åŠ¨åå¤‡é¢„æ¡ˆï¼šä¸´æ—¶å¯ç”¨Serial oldæ”¶é›†å™¨æ¥é‡æ–°è¿›è¡Œè€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œè¿™æ ·åœé¡¿æ—¶é—´å°±å¾ˆé•¿äº†ã€‚</p><p>CMSæ”¶é›†å™¨çš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨çš„æ˜¯<strong>æ ‡è®°æ¸…é™¤ç®—æ³•</strong>ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æ‰§è¡Œå®Œå†…å­˜å›æ”¶åï¼Œç”±äºè¢«æ‰§è¡Œå†…å­˜å›æ”¶çš„æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ææœ‰å¯èƒ½æ˜¯ä¸è¿ç»­çš„ä¸€äº›å†…å­˜å—ï¼Œä¸å¯é¿å…åœ°å°†ä¼šäº§ç”Ÿä¸€äº›å†…å­˜ç¢ç‰‡ã€‚é‚£ä¹ˆCMSåœ¨ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå°†æ— æ³•ä½¿ç”¨æŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰æŠ€æœ¯ï¼Œè€Œåªèƒ½å¤Ÿé€‰æ‹©ç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰æ‰§è¡Œå†…å­˜åˆ†é…ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713212230352.png" alt="image-20200713212230352"></p><h3 id="6-1-CMSä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼Ÿ"><a href="#6-1-CMSä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼Ÿ" class="headerlink" title="6.1 CMSä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼Ÿ"></a>6.1 CMSä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼Ÿ</h3><p>ç­”æ¡ˆå…¶å®å¾ˆç®€ç­”ï¼Œå› ä¸ºå½“å¹¶å‘æ¸…é™¤çš„æ—¶å€™ï¼Œç”¨Compactæ•´ç†å†…å­˜çš„è¯ï¼ŒåŸæ¥çš„ç”¨æˆ·çº¿ç¨‹ä½¿ç”¨çš„å†…å­˜è¿˜æ€ä¹ˆç”¨å‘¢ï¼Ÿè¦ä¿è¯ç”¨æˆ·çº¿ç¨‹èƒ½ç»§ç»­æ‰§è¡Œï¼Œå‰æçš„å®ƒè¿è¡Œçš„èµ„æºä¸å—å½±å“å˜›ã€‚Mark Compactæ›´é€‚åˆâ€œstop the worldâ€<br>è¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨</p><h3 id="6-2-ä¼˜ç‚¹"><a href="#6-2-ä¼˜ç‚¹" class="headerlink" title="6.2 ä¼˜ç‚¹"></a>6.2 ä¼˜ç‚¹</h3><ul><li>å¹¶å‘æ”¶é›†</li><li>ä½å»¶è¿Ÿ</li></ul><h3 id="6-3-ç¼ºç‚¹"><a href="#6-3-ç¼ºç‚¹" class="headerlink" title="6.3 ç¼ºç‚¹"></a>6.3 ç¼ºç‚¹</h3><ul><li><p>ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´å¹¶å‘æ¸…é™¤åï¼Œç”¨æˆ·çº¿ç¨‹å¯ç”¨çš„ç©ºé—´ä¸è¶³ã€‚åœ¨æ— æ³•åˆ†é…å¤§å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä¸å¾—ä¸æå‰è§¦å‘FullGCã€‚</p></li><li><p>CMSæ”¶é›†å™¨å¯¹CPUèµ„æºéå¸¸æ•æ„Ÿã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·åœé¡¿ï¼Œä½†æ˜¯ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½ã€‚</p></li><li><p>CMSæ”¶é›†å™¨æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ã€‚å¯èƒ½å‡ºç°â€œConcurrent Mode Failureâ€å¤±è´¥è€Œå¯¼è‡´å¦ä¸€æ¬¡Full GCçš„äº§ç”Ÿã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µç”±äºç¨‹åºçš„å·¥ä½œçº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹æ˜¯åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µå¦‚æœäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼ŒCMSå°†æ— æ³•å¯¹è¿™äº›åƒåœ¾å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿™äº›æ–°äº§ç”Ÿçš„åƒåœ¾å¯¹è±¡æ²¡æœ‰è¢«åŠæ—¶å›æ”¶ï¼Œä»è€Œåªèƒ½åœ¨ä¸‹ä¸€æ¬¡æ‰§è¡ŒGCæ—¶é‡Šæ”¾è¿™äº›ä¹‹å‰æœªè¢«å›æ”¶çš„å†…å­˜ç©ºé—´ã€‚</p></li></ul><h3 id="6-4-è®¾ç½®çš„å‚æ•°"><a href="#6-4-è®¾ç½®çš„å‚æ•°" class="headerlink" title="6.4 è®¾ç½®çš„å‚æ•°"></a>6.4 è®¾ç½®çš„å‚æ•°</h3><ul><li>-XXï¼š+UseConcMarkSweepGCæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨CMSæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚</li></ul><p>å¼€å¯è¯¥å‚æ•°åä¼šè‡ªåŠ¨å°†-xxï¼š+UseParNewGCæ‰“å¼€ã€‚å³ï¼šParNewï¼ˆYoungåŒºç”¨ï¼‰+CMSï¼ˆ01dåŒºç”¨ï¼‰+Serial oldçš„ç»„åˆã€‚</p><ul><li>-XX:CMSInitiatingoccupanyFraction è®¾ç½®å †å†…å­˜ä½¿ç”¨ç‡çš„é˜ˆå€¼ï¼Œä¸€æ—¦è¾¾åˆ°è¯¥é˜ˆå€¼ï¼Œä¾¿å¼€å§‹è¿›è¡Œå›æ”¶ã€‚</li></ul><p>JDK5åŠä»¥å‰ç‰ˆæœ¬çš„é»˜è®¤å€¼ä¸º68ï¼Œå³å½“è€å¹´ä»£çš„ç©ºé—´ä½¿ç”¨ç‡è¾¾åˆ°68%æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡cMså›æ”¶ã€‚JDK6åŠä»¥ä¸Šç‰ˆæœ¬é»˜è®¤å€¼ä¸º92%</p><p>å¦‚æœå†…å­˜å¢é•¿ç¼“æ…¢ï¼Œåˆ™å¯ä»¥è®¾ç½®ä¸€ä¸ªç¨å¤§çš„å€¼ï¼Œå¤§çš„é˜€å€¼å¯ä»¥æœ‰æ•ˆé™ä½CMSçš„è§¦å‘é¢‘ç‡ï¼Œå‡å°‘è€å¹´ä»£å›æ”¶çš„æ¬¡æ•°å¯ä»¥è¾ƒä¸ºæ˜æ˜¾åœ°æ”¹å–„åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚åä¹‹ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå†…å­˜ä½¿ç”¨ç‡å¢é•¿å¾ˆå¿«ï¼Œåˆ™åº”è¯¥é™ä½è¿™ä¸ªé˜ˆå€¼ï¼Œä»¥é¿å…é¢‘ç¹è§¦å‘è€å¹´ä»£ä¸²è¡Œæ”¶é›†å™¨ã€‚å› æ­¤é€šè¿‡è¯¥é€‰é¡¹ä¾¿å¯ä»¥æœ‰æ•ˆé™ä½Ful1Gcçš„æ‰§è¡Œæ¬¡æ•°ã€‚</p><ul><li>-XXï¼š+UseCMSCompactAtFullCollectionç”¨äºæŒ‡å®šåœ¨æ‰§è¡Œå®ŒFul1</li></ul><p>GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œä»¥æ­¤é¿å…å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿã€‚ä¸è¿‡ç”±äºå†…å­˜å‹ç¼©æ•´ç†è¿‡ç¨‹æ— æ³•å¹¶å‘æ‰§è¡Œï¼Œæ‰€å¸¦æ¥çš„é—®é¢˜å°±æ˜¯åœé¡¿æ—¶é—´å˜å¾—æ›´é•¿äº†ã€‚</p><ul><li><p>-XX:CMSFullGCsBeforecompaction è®¾ç½®åœ¨æ‰§è¡Œå¤šå°‘æ¬¡Ful1GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ã€‚</p></li><li><p>-XX:ParallelcMSThreads è®¾ç½®cMsçš„çº¿ç¨‹æ•°é‡ã€‚</p></li></ul><p>CMsé»˜è®¤å¯åŠ¨çš„çº¿ç¨‹æ•°æ˜¯ï¼ˆParalle1GCThreads+3ï¼‰/4ï¼ŒParallelGCThreadsæ˜¯å¹´è½»ä»£å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ã€‚å½“CPUèµ„æºæ¯”è¾ƒç´§å¼ æ—¶ï¼Œå—åˆ°CMSæ”¶é›†å™¨çº¿ç¨‹çš„å½±å“ï¼Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½åœ¨åƒåœ¾å›æ”¶é˜¶æ®µå¯èƒ½ä¼šéå¸¸ç³Ÿç³•ã€‚</p><h3 id="6-5-å°ç»“"><a href="#6-5-å°ç»“" class="headerlink" title="6.5 å°ç»“"></a>6.5 å°ç»“</h3><p>HotSpotæœ‰è¿™ä¹ˆå¤šçš„åƒåœ¾å›æ”¶å™¨ï¼Œé‚£ä¹ˆå¦‚æœæœ‰äººé—®ï¼ŒSerial GCã€Parallel GCã€Concurrent Mark Sweep GCè¿™ä¸‰ä¸ªGcæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ</p><p>è¯·è®°ä½ä»¥ä¸‹å£ä»¤ï¼š</p><ul><li>å¦‚æœä½ æƒ³è¦æœ€å°åŒ–åœ°ä½¿ç”¨å†…å­˜å’Œå¹¶è¡Œå¼€é”€ï¼Œè¯·é€‰Serial GCï¼›</li><li>å¦‚æœä½ æƒ³è¦æœ€å¤§åŒ–åº”ç”¨ç¨‹åºçš„ååé‡ï¼Œè¯·é€‰Parallel GCï¼›</li><li>å¦‚æœä½ æƒ³è¦æœ€å°åŒ–GCçš„ä¸­æ–­æˆ–åœé¡¿æ—¶é—´ï¼Œè¯·é€‰CMs GCã€‚</li></ul><h3 id="6-7-JDKåç»­ç‰ˆæœ¬ä¸­CMSçš„å˜åŒ–"><a href="#6-7-JDKåç»­ç‰ˆæœ¬ä¸­CMSçš„å˜åŒ–" class="headerlink" title="6.7 JDKåç»­ç‰ˆæœ¬ä¸­CMSçš„å˜åŒ–"></a>6.7 JDKåç»­ç‰ˆæœ¬ä¸­CMSçš„å˜åŒ–</h3><p><strong>JDK9æ–°ç‰¹æ€§</strong>ï¼šCMSè¢«æ ‡è®°ä¸ºeprecateäº†ï¼ˆJEP291ï¼‰&gt;å¦‚æœå¯¹JDK9åŠä»¥ä¸Šç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºä½¿ç”¨å‚æ•°-XXï¼š<br>+UseConcMarkSweepGCæ¥å¼€å¯CMSæ”¶é›†å™¨çš„è¯ï¼Œç”¨æˆ·ä¼šæ”¶åˆ°ä¸€ä¸ªè­¦å‘Šä¿¡æ¯ï¼Œæç¤ºCMSæœªæ¥å°†ä¼šè¢«åºŸå¼ƒã€‚</p><p>JDK14æ–°ç‰¹æ€§ï¼šåˆ é™¤CMsåƒåœ¾å›æ”¶å™¨ï¼ˆJEP363ï¼‰ç§»é™¤äº†CMSåƒåœ¾æ”¶é›†å™¨ï¼Œå¦‚æœåœ¨JDK14ä¸­ä½¿ç”¨<br>XXï¼š+UseConcMarkSweepGCçš„è¯ï¼ŒJVMä¸ä¼šæŠ¥é”™ï¼Œåªæ˜¯ç»™å‡ºä¸€ä¸ªwarningä¿¡æ¯ï¼Œä½†æ˜¯ä¸ä¼šexitã€‚JVMä¼šè‡ªåŠ¨å›é€€ä»¥é»˜è®¤GCæ–¹å¼å¯åŠ¨JVM</p><h2 id="7-G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼"><a href="#7-G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼" class="headerlink" title="7 G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼"></a>7 G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼</h2><h3 id="7-1-æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†å‰é¢å‡ ä¸ªå¼ºå¤§çš„GCï¼Œä¸ºä»€ä¹ˆè¿˜è¦å‘å¸ƒGarbage-Firstï¼ˆG1ï¼‰ï¼Ÿ"><a href="#7-1-æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†å‰é¢å‡ ä¸ªå¼ºå¤§çš„GCï¼Œä¸ºä»€ä¹ˆè¿˜è¦å‘å¸ƒGarbage-Firstï¼ˆG1ï¼‰ï¼Ÿ" class="headerlink" title="7.1 æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†å‰é¢å‡ ä¸ªå¼ºå¤§çš„GCï¼Œä¸ºä»€ä¹ˆè¿˜è¦å‘å¸ƒGarbage Firstï¼ˆG1ï¼‰ï¼Ÿ"></a>7.1 æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†å‰é¢å‡ ä¸ªå¼ºå¤§çš„GCï¼Œä¸ºä»€ä¹ˆè¿˜è¦å‘å¸ƒGarbage Firstï¼ˆG1ï¼‰ï¼Ÿ</h3><p>åŸå› å°±åœ¨äºåº”ç”¨ç¨‹åºæ‰€åº”å¯¹çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºæ­£å¸¸è¿›è¡Œï¼Œè€Œç»å¸¸é€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­åœ°å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚G1ï¼ˆGarbage-Firstï¼‰åƒåœ¾å›æ”¶å™¨æ˜¯åœ¨Java7 update4ä¹‹åå¼•å…¥çš„ä¸€ä¸ªæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œæ˜¯å½“ä»Šæ”¶é›†å™¨æŠ€æœ¯å‘å±•çš„æœ€å‰æ²¿æˆæœä¹‹ä¸€ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œä¸ºäº†é€‚åº”ç°åœ¨ä¸æ–­æ‰©å¤§çš„å†…å­˜å’Œä¸æ–­å¢åŠ çš„å¤„ç†å™¨æ•°é‡ï¼Œè¿›ä¸€æ­¥é™ä½æš‚åœæ—¶é—´ï¼ˆpause timeï¼‰ï¼ŒåŒæ—¶å…¼é¡¾è‰¯å¥½çš„ååé‡ã€‚</p><p><strong>å®˜æ–¹ç»™G1è®¾å®šçš„ç›®æ ‡æ˜¯åœ¨å»¶è¿Ÿå¯æ§çš„æƒ…å†µä¸‹è·å¾—å°½å¯èƒ½é«˜çš„ååé‡ï¼Œæ‰€ä»¥æ‰æ‹…å½“èµ·â€œå…¨åŠŸèƒ½æ”¶é›†å™¨â€çš„é‡ä»»ä¸æœŸæœ›</strong>ã€‚</p><h3 id="7-2-ä¸ºä»€ä¹ˆåå­—å«-Garbage-First-G1-å‘¢ï¼Ÿ"><a href="#7-2-ä¸ºä»€ä¹ˆåå­—å«-Garbage-First-G1-å‘¢ï¼Ÿ" class="headerlink" title="7.2 ä¸ºä»€ä¹ˆåå­—å« Garbage First(G1)å‘¢ï¼Ÿ"></a>7.2 ä¸ºä»€ä¹ˆåå­—å« Garbage First(G1)å‘¢ï¼Ÿ</h3><p>å› ä¸ºG1æ˜¯ä¸€ä¸ªå¹¶è¡Œå›æ”¶å™¨ï¼Œå®ƒæŠŠå †å†…å­˜åˆ†å‰²ä¸ºå¾ˆå¤šä¸ç›¸å…³çš„åŒºåŸŸï¼ˆRegionï¼‰ï¼ˆç‰©ç†ä¸Šä¸è¿ç»­çš„ï¼‰ã€‚ä½¿ç”¨ä¸åŒçš„Regionæ¥è¡¨ç¤ºEdenã€å¹¸å­˜è€…0åŒºï¼Œå¹¸å­˜è€…1åŒºï¼Œè€å¹´ä»£ç­‰ã€‚</p><p>G1 GCæœ‰è®¡åˆ’åœ°é¿å…åœ¨æ•´ä¸ªJavaå †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚G1è·Ÿè¸ªå„ä¸ªRegioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„Regionã€‚</p><p>ç”±äºè¿™ç§æ–¹å¼çš„ä¾§é‡ç‚¹åœ¨äºå›æ”¶åƒåœ¾æœ€å¤§é‡çš„åŒºé—´ï¼ˆRegionï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™G1ä¸€ä¸ªåå­—ï¼šåƒåœ¾ä¼˜å…ˆï¼ˆGarbage Firstï¼‰ã€‚</p><p>G1ï¼ˆGarbage-Firstï¼‰æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šæ ¸CPUåŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œä»¥æé«˜æ¦‚ç‡æ»¡è¶³GCåœé¡¿æ—¶é—´çš„åŒæ—¶ï¼Œè¿˜å…¼å…·é«˜ååé‡çš„æ€§èƒ½ç‰¹å¾ã€‚</p><p>åœ¨JDK1.7ç‰ˆæœ¬æ­£å¼å¯ç”¨ï¼Œç§»é™¤äº†Experimenta1çš„æ ‡è¯†ï¼Œæ˜¯JDK9ä»¥åçš„é»˜è®¤åƒåœ¾å›æ”¶å™¨ï¼Œå–ä»£äº†CMSå›æ”¶å™¨ä»¥åŠParalle1+Parallel oldç»„åˆã€‚è¢«orac1eå®˜æ–¹ç§°ä¸ºâ€œå…¨åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨â€ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼ŒCMSå·²ç»åœ¨JDK9ä¸­è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼ˆdeprecatedï¼‰ã€‚åœ¨jdk8ä¸­è¿˜ä¸æ˜¯é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨ï¼Œéœ€è¦ä½¿ç”¨-xxï¼š+UseG1GCæ¥å¯ç”¨ã€‚</p><h3 id="7-3-G1åƒåœ¾æ”¶é›†å™¨çš„ä¼˜ç‚¹"><a href="#7-3-G1åƒåœ¾æ”¶é›†å™¨çš„ä¼˜ç‚¹" class="headerlink" title="7.3 G1åƒåœ¾æ”¶é›†å™¨çš„ä¼˜ç‚¹"></a>7.3 G1åƒåœ¾æ”¶é›†å™¨çš„ä¼˜ç‚¹</h3><p>ä¸å…¶ä»–GCæ”¶é›†å™¨ç›¸æ¯”ï¼ŒG1ä½¿ç”¨äº†å…¨æ–°çš„åˆ†åŒºç®—æ³•ï¼Œå…¶ç‰¹ç‚¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><strong>å¹¶è¡Œä¸å¹¶å‘</strong></p><ul><li>å¹¶è¡Œæ€§ï¼šG1åœ¨å›æ”¶æœŸé—´ï¼Œå¯ä»¥æœ‰å¤šä¸ªGCçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸è®¡ç®—èƒ½åŠ›ã€‚æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹STW</li><li>å¹¶å‘æ€§ï¼šG1æ‹¥æœ‰ä¸åº”ç”¨ç¨‹åºäº¤æ›¿æ‰§è¡Œçš„èƒ½åŠ›ï¼Œéƒ¨åˆ†å·¥ä½œå¯ä»¥å’Œåº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œï¼Œå› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸ä¼šåœ¨æ•´ä¸ªå›æ”¶é˜¶æ®µå‘ç”Ÿå®Œå…¨é˜»å¡åº”ç”¨ç¨‹åºçš„æƒ…å†µ</li></ul><p><strong>åˆ†ä»£æ”¶é›†</strong></p><ul><li>ä»åˆ†ä»£ä¸Šçœ‹ï¼ŒG1ä¾ç„¶å±äºåˆ†ä»£å‹åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¼šåŒºåˆ†å¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œå¹´è½»ä»£ä¾ç„¶æœ‰EdenåŒºå’ŒSurvivoråŒºã€‚ä½†ä»å †çš„ç»“æ„ä¸Šçœ‹ï¼Œå®ƒä¸è¦æ±‚æ•´ä¸ªEdenåŒºã€å¹´è½»ä»£æˆ–è€…è€å¹´ä»£éƒ½æ˜¯è¿ç»­çš„ï¼Œä¹Ÿä¸å†åšæŒå›ºå®šå¤§å°å’Œå›ºå®šæ•°é‡ã€‚</li><li>å°†å †ç©ºé—´åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼ˆRegionï¼‰ï¼Œè¿™äº›åŒºåŸŸä¸­åŒ…å«äº†é€»è¾‘ä¸Šçš„å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚</li><li>å’Œä¹‹å‰çš„å„ç±»å›æ”¶å™¨ä¸åŒï¼Œå®ƒåŒæ—¶å…¼é¡¾å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚å¯¹æ¯”å…¶ä»–å›æ”¶å™¨ï¼Œæˆ–è€…å·¥ä½œåœ¨å¹´è½»ä»£ï¼Œæˆ–è€…å·¥ä½œåœ¨è€å¹´ä»£ï¼›</li></ul><p>G1æ‰€è°“çš„åˆ†ä»£ï¼Œå·²ç»ä¸æ˜¯ä¸‹é¢è¿™æ ·çš„äº†</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713215105293.png" alt="image-20200713215105293"></p><p>è€Œæ˜¯è¿™æ ·çš„ä¸€ä¸ªåŒºåŸŸ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713215133839.png" alt="image-20200713215133839"></p><p><strong>ç©ºé—´æ•´åˆ</strong></p><ul><li>CMSï¼šâ€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ã€å†…å­˜ç¢ç‰‡ã€è‹¥å¹²æ¬¡Gcåè¿›è¡Œä¸€æ¬¡ç¢ç‰‡æ•´ç†</li><li>G1å°†å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªçš„regionã€‚å†…å­˜çš„å›æ”¶æ˜¯ä»¥regionä½œä¸ºåŸºæœ¬å•ä½çš„ã€‚Regionä¹‹é—´æ˜¯å¤åˆ¶ç®—æ³•ï¼Œä½†æ•´ä½“ä¸Šå®é™…å¯çœ‹ä½œæ˜¯æ ‡è®°-å‹ç¼©ï¼ˆMark-Compactï¼‰ç®—æ³•ï¼Œä¸¤ç§ç®—æ³•éƒ½å¯ä»¥é¿å…å†…å­˜ç¢ç‰‡ã€‚è¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåˆ†é…å¤§å¯¹è±¡æ—¶ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡GCã€‚å°¤å…¶æ˜¯å½“Javaå †éå¸¸å¤§çš„æ—¶å€™ï¼ŒG1çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚</li></ul><p><strong>å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼ˆå³ï¼šè½¯å®æ—¶soft real-timeï¼‰</strong><br>è¿™æ˜¯G1ç›¸å¯¹äºCMSçš„å¦ä¸€å¤§ä¼˜åŠ¿ï¼ŒG1é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡Næ¯«ç§’ã€‚</p><ul><li>ç”±äºåˆ†åŒºçš„åŸå› ï¼ŒG1å¯ä»¥åªé€‰å–éƒ¨åˆ†åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶ï¼Œè¿™æ ·ç¼©å°äº†å›æ”¶çš„èŒƒå›´ï¼Œå› æ­¤å¯¹äºå…¨å±€åœé¡¿æƒ…å†µçš„å‘ç”Ÿä¹Ÿèƒ½å¾—åˆ°è¾ƒå¥½çš„æ§åˆ¶ã€‚</li><li>G1è·Ÿè¸ªå„ä¸ªRegioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„Regionã€‚ä¿è¯äº†G1æ”¶é›†å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚</li><li>ç›¸æ¯”äºCMSGCï¼ŒG1æœªå¿…èƒ½åšåˆ°CMSåœ¨æœ€å¥½æƒ…å†µä¸‹çš„å»¶æ—¶åœé¡¿ï¼Œä½†æ˜¯æœ€å·®æƒ…å†µè¦å¥½å¾ˆå¤šã€‚</li></ul><h3 id="7-4-G1åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹"><a href="#7-4-G1åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹" class="headerlink" title="7.4 G1åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹"></a>7.4 G1åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹</h3><p>ç›¸è¾ƒäºCMSï¼ŒG1è¿˜ä¸å…·å¤‡å…¨æ–¹ä½ã€å‹å€’æ€§ä¼˜åŠ¿ã€‚æ¯”å¦‚åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒG1æ— è®ºæ˜¯ä¸ºäº†åƒåœ¾æ”¶é›†äº§ç”Ÿçš„å†…å­˜å ç”¨ï¼ˆFootprintï¼‰è¿˜æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„é¢å¤–æ‰§è¡Œè´Ÿè½½ï¼ˆoverloadï¼‰éƒ½è¦æ¯”CMSè¦é«˜ã€‚</p><p>ä»ç»éªŒä¸Šæ¥è¯´ï¼Œåœ¨å°å†…å­˜åº”ç”¨ä¸ŠCMSçš„è¡¨ç°å¤§æ¦‚ç‡ä¼šä¼˜äºG1ï¼Œè€ŒG1åœ¨å¤§å†…å­˜åº”ç”¨ä¸Šåˆ™å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚å¹³è¡¡ç‚¹åœ¨6-8GBä¹‹é—´ã€‚</p><h3 id="7-5-G1å‚æ•°è®¾ç½®"><a href="#7-5-G1å‚æ•°è®¾ç½®" class="headerlink" title="7.5 G1å‚æ•°è®¾ç½®"></a>7.5 G1å‚æ•°è®¾ç½®</h3><ul><li>-XX:+UseG1GCï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡</li><li>-XX:G1HeapRegionSizeè®¾ç½®æ¯ä¸ªRegionçš„å¤§å°ã€‚å€¼æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´æ˜¯1MBåˆ°32MBä¹‹é—´ï¼Œç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„Javaå †å¤§å°åˆ’åˆ†å‡ºçº¦2048ä¸ªåŒºåŸŸã€‚é»˜è®¤æ˜¯å †å†…å­˜çš„1/2000ã€‚</li><li>-XX:MaxGCPauseMillis è®¾ç½®æœŸæœ›è¾¾åˆ°çš„æœ€å¤§Gcåœé¡¿æ—¶é—´æŒ‡æ ‡ï¼ˆJVMä¼šå°½åŠ›å®ç°ï¼Œä½†ä¸ä¿è¯è¾¾åˆ°ï¼‰ã€‚é»˜è®¤å€¼æ˜¯200ms</li><li>-XX:+ParallelGcThread è®¾ç½®STWå·¥ä½œçº¿ç¨‹æ•°çš„å€¼ã€‚æœ€å¤šè®¾ç½®ä¸º8</li><li>-XX:ConcGCThreads è®¾ç½®å¹¶å‘æ ‡è®°çš„çº¿ç¨‹æ•°ã€‚å°†nè®¾ç½®ä¸ºå¹¶è¡Œåƒåœ¾å›æ”¶çº¿ç¨‹æ•°ï¼ˆParallelGcThreadsï¼‰çš„1/4å·¦å³ã€‚</li><li>-XX:InitiatingHeapoccupancyPercent è®¾ç½®è§¦å‘å¹¶å‘Gcå‘¨æœŸçš„Javaå †å ç”¨ç‡é˜ˆå€¼ã€‚è¶…è¿‡æ­¤å€¼ï¼Œå°±è§¦å‘GCã€‚é»˜è®¤å€¼æ˜¯45ã€‚</li></ul><h3 id="7-6-G1æ”¶é›†å™¨çš„å¸¸è§æ“ä½œæ­¥éª¤"><a href="#7-6-G1æ”¶é›†å™¨çš„å¸¸è§æ“ä½œæ­¥éª¤" class="headerlink" title="7.6 G1æ”¶é›†å™¨çš„å¸¸è§æ“ä½œæ­¥éª¤"></a>7.6 G1æ”¶é›†å™¨çš„å¸¸è§æ“ä½œæ­¥éª¤</h3><p>G1çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€åŒ–JVMæ€§èƒ½è°ƒä¼˜ï¼Œå¼€å‘äººå‘˜åªéœ€è¦ç®€å•çš„ä¸‰æ­¥å³å¯å®Œæˆè°ƒä¼˜ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼šå¼€å¯G1åƒåœ¾æ”¶é›†å™¨</li><li>ç¬¬äºŒæ­¥ï¼šè®¾ç½®å †çš„æœ€å¤§å†…å­˜</li><li>ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®æœ€å¤§çš„åœé¡¿æ—¶é—´</li></ul><p>G1ä¸­æä¾›äº†ä¸‰ç§åƒåœ¾å›æ”¶æ¨¡å¼ï¼šYoungGCã€Mixed GCå’ŒFu11GCï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è§¦å‘ã€‚</p><h3 id="7-7-G1æ”¶é›†å™¨çš„é€‚ç”¨åœºæ™¯"><a href="#7-7-G1æ”¶é›†å™¨çš„é€‚ç”¨åœºæ™¯" class="headerlink" title="7.7 G1æ”¶é›†å™¨çš„é€‚ç”¨åœºæ™¯"></a>7.7 G1æ”¶é›†å™¨çš„é€‚ç”¨åœºæ™¯</h3><p>é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜ã€å¤šå¤„ç†å™¨çš„æœºå™¨ã€‚ï¼ˆåœ¨æ™®é€šå¤§å°çš„å †é‡Œè¡¨ç°å¹¶ä¸æƒŠå–œï¼‰</p><p>æœ€ä¸»è¦çš„åº”ç”¨æ˜¯éœ€è¦ä½GCå»¶è¿Ÿï¼Œå¹¶å…·æœ‰å¤§å †çš„åº”ç”¨ç¨‹åºæä¾›è§£å†³æ–¹æ¡ˆï¼›</p><p>å¦‚ï¼šåœ¨å †å¤§å°çº¦6GBæˆ–æ›´å¤§æ—¶ï¼Œå¯é¢„æµ‹çš„æš‚åœæ—¶é—´å¯ä»¥ä½äºe.5ç§’ï¼›ï¼ˆG1é€šè¿‡æ¯æ¬¡åªæ¸…ç†ä¸€éƒ¨åˆ†è€Œä¸æ˜¯å…¨éƒ¨çš„Regionçš„å¢é‡å¼æ¸…ç†æ¥ä¿è¯æ¯æ¬¡Gcåœé¡¿æ—¶é—´ä¸ä¼šè¿‡é•¿ï¼‰ã€‚<br>ç”¨æ¥æ›¿æ¢æ‰JDK1.5ä¸­çš„CMSæ”¶é›†å™¨ï¼›åœ¨ä¸‹é¢çš„æƒ…å†µæ—¶ï¼Œä½¿ç”¨61å¯èƒ½æ¯”CMSå¥½ï¼š</p><ul><li>è¶…è¿‡5e%çš„Javaå †è¢«æ´»åŠ¨æ•°æ®å ç”¨ï¼›</li><li>å¯¹è±¡åˆ†é…é¢‘ç‡æˆ–å¹´ä»£æå‡é¢‘ç‡å˜åŒ–å¾ˆå¤§ï¼›</li><li>GCåœé¡¿æ—¶é—´è¿‡é•¿ï¼ˆé•¿äºe.5è‡³1ç§’ï¼‰</li></ul><p>HotSpotåƒåœ¾æ”¶é›†å™¨é‡Œï¼Œé™¤äº†61ä»¥å¤–ï¼Œå…¶ä»–çš„åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨å†…ç½®çš„JVMçº¿ç¨‹æ‰§è¡ŒGcçš„å¤šçº¿ç¨‹æ“ä½œï¼Œè€ŒG1GCå¯ä»¥é‡‡ç”¨åº”ç”¨çº¿ç¨‹æ‰¿æ‹…åå°è¿è¡Œçš„GCå·¥ä½œï¼Œå³å½“JVMçš„GCçº¿ç¨‹å¤„ç†é€Ÿåº¦æ…¢æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨åº”ç”¨ç¨‹åºçº¿ç¨‹å¸®åŠ©åŠ é€Ÿåƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚</p><h3 id="7-8-åˆ†åŒºRegionï¼šåŒ–æ•´ä¸ºé›¶"><a href="#7-8-åˆ†åŒºRegionï¼šåŒ–æ•´ä¸ºé›¶" class="headerlink" title="7.8 åˆ†åŒºRegionï¼šåŒ–æ•´ä¸ºé›¶"></a>7.8 åˆ†åŒºRegionï¼šåŒ–æ•´ä¸ºé›¶</h3><p>ä½¿ç”¨G1æ”¶é›†å™¨æ—¶ï¼Œå®ƒå°†æ•´ä¸ªJavaå †åˆ’åˆ†æˆçº¦2048ä¸ªå¤§å°ç›¸åŒçš„ç‹¬ç«‹Regionå—ï¼Œæ¯ä¸ªRegionå—å¤§å°æ ¹æ®å †ç©ºé—´çš„å®é™…å¤§å°è€Œå®šï¼Œæ•´ä½“è¢«æ§åˆ¶åœ¨1MBåˆ°32MBä¹‹é—´ï¼Œä¸”ä¸º2çš„Næ¬¡å¹‚ï¼Œå³1MBï¼Œ2MBï¼Œ4MBï¼Œ8MBï¼Œ16MBï¼Œ32MBã€‚å¯ä»¥é€šè¿‡</p><p>XX:G1HeapRegionsizeè®¾å®šã€‚æ‰€æœ‰çš„Regionå¤§å°ç›¸åŒï¼Œä¸”åœ¨JVMç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«æ”¹å˜ã€‚</p><p>è™½ç„¶è¿˜ä¿ç•™æœ‰æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯ç‰©ç†éš”ç¦»çš„äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€éƒ¨åˆ†Regionï¼ˆä¸éœ€è¦è¿ç»­ï¼‰çš„é›†åˆã€‚é€šè¿‡Regionçš„åŠ¨æ€åˆ†é…æ–¹å¼å®ç°é€»è¾‘ä¸Šçš„è¿ç»­ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713223244886.png" alt="image-20200713223244886"></p><p>ä¸€ä¸ªregionæœ‰å¯èƒ½å±äºEdenï¼ŒSurvivoræˆ–è€…old/Tenuredå†…å­˜åŒºåŸŸã€‚ä½†æ˜¯ä¸€ä¸ªregionåªå¯èƒ½å±äºä¸€ä¸ªè§’è‰²ã€‚å›¾ä¸­çš„Eè¡¨ç¤ºè¯¥regionå±äºEdenå†…å­˜åŒºåŸŸï¼Œsè¡¨ç¤ºå±äºsurvivorå†…å­˜åŒºåŸŸï¼Œoè¡¨ç¤ºå±äº01då†…å­˜åŒºåŸŸã€‚å›¾ä¸­ç©ºç™½çš„è¡¨ç¤ºæœªä½¿ç”¨çš„å†…å­˜ç©ºé—´ã€‚</p><p>G1åƒåœ¾æ”¶é›†å™¨è¿˜å¢åŠ äº†ä¸€ç§æ–°çš„å†…å­˜åŒºåŸŸï¼Œå«åšHumongouså†…å­˜åŒºåŸŸï¼Œå¦‚å›¾ä¸­çš„Hå—ã€‚ä¸»è¦ç”¨äºå­˜å‚¨å¤§å¯¹è±¡ï¼Œå¦‚æœè¶…è¿‡1.5ä¸ªregionï¼Œå°±æ”¾åˆ°Hã€‚</p><p><strong>è®¾ç½®Hçš„åŸå› ï¼š</strong>å¯¹äºå †ä¸­çš„å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åˆ°è€å¹´ä»£ï¼Œä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å¤§å¯¹è±¡å°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å¤§å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„HåŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Fu11Gcã€‚G1çš„å¤§å¤šæ•°è¡Œä¸ºéƒ½æŠŠHåŒºä½œä¸ºè€å¹´ä»£çš„ä¸€éƒ¨åˆ†æ¥çœ‹å¾…ã€‚</p><p>æ¯ä¸ªRegionéƒ½æ˜¯é€šè¿‡æŒ‡é’ˆç¢°æ’æ¥åˆ†é…ç©ºé—´</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713223509993.png" alt="image-20200713223509993"></p><h3 id="7-9-G1åƒåœ¾å›æ”¶å™¨çš„å›æ”¶è¿‡ç¨‹"><a href="#7-9-G1åƒåœ¾å›æ”¶å™¨çš„å›æ”¶è¿‡ç¨‹" class="headerlink" title="7.9 G1åƒåœ¾å›æ”¶å™¨çš„å›æ”¶è¿‡ç¨‹"></a>7.9 G1åƒåœ¾å›æ”¶å™¨çš„å›æ”¶è¿‡ç¨‹</h3><p>G1GCçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªç¯èŠ‚ï¼š</p><ul><li>å¹´è½»ä»£GCï¼ˆYoung GCï¼‰</li><li>è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ï¼ˆConcurrent Markingï¼‰</li><li>æ··åˆå›æ”¶ï¼ˆMixed GCï¼‰</li></ul><p>ï¼ˆå¦‚æœéœ€è¦ï¼Œå•çº¿ç¨‹ã€ç‹¬å å¼ã€é«˜å¼ºåº¦çš„Fu11GCè¿˜æ˜¯ç»§ç»­å­˜åœ¨çš„ã€‚å®ƒé’ˆå¯¹GCçš„è¯„ä¼°å¤±è´¥æä¾›äº†ä¸€ç§å¤±è´¥ä¿æŠ¤æœºåˆ¶ï¼Œå³å¼ºåŠ›å›æ”¶ã€‚ï¼‰</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713224113996.png" alt="image-20200713224113996"></p><p>é¡ºæ—¶é’ˆï¼Œyoung gc-&gt;young gc+concurrent mark-&gt;Mixed GCé¡ºåºï¼Œè¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p><p>åº”ç”¨ç¨‹åºåˆ†é…å†…å­˜ï¼Œå½“å¹´è½»ä»£çš„EdenåŒºç”¨å°½æ—¶å¼€å§‹å¹´è½»ä»£å›æ”¶è¿‡ç¨‹ï¼›G1çš„å¹´è½»ä»£æ”¶é›†é˜¶æ®µæ˜¯ä¸€ä¸ªå¹¶è¡Œçš„ç‹¬å å¼æ”¶é›†å™¨ã€‚åœ¨å¹´è½»ä»£å›æ”¶æœŸï¼ŒG1GCæš‚åœæ‰€æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œå¯åŠ¨å¤šçº¿ç¨‹æ‰§è¡Œå¹´è½»ä»£å›æ”¶ã€‚ç„¶åä»å¹´è½»ä»£åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°SurvivoråŒºé—´æˆ–è€…è€å¹´åŒºé—´ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªåŒºé—´éƒ½ä¼šæ¶‰åŠã€‚</p><p>å½“å †å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸€å®šå€¼ï¼ˆé»˜è®¤45%ï¼‰æ—¶ï¼Œå¼€å§‹è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ã€‚</p><p>æ ‡è®°å®Œæˆé©¬ä¸Šå¼€å§‹æ··åˆå›æ”¶è¿‡ç¨‹ã€‚å¯¹äºä¸€ä¸ªæ··åˆå›æ”¶æœŸï¼ŒG1GCä»è€å¹´åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°ç©ºé—²åŒºé—´ï¼Œè¿™äº›ç©ºé—²åŒºé—´ä¹Ÿå°±æˆä¸ºäº†è€å¹´ä»£çš„ä¸€éƒ¨åˆ†ã€‚å’Œå¹´è½»ä»£ä¸åŒï¼Œè€å¹´ä»£çš„G1å›æ”¶å™¨å’Œå…¶ä»–GCä¸åŒï¼ŒG1çš„è€å¹´ä»£å›æ”¶å™¨ä¸éœ€è¦æ•´ä¸ªè€å¹´ä»£è¢«å›æ”¶ï¼Œä¸€æ¬¡åªéœ€è¦æ‰«æ/å›æ”¶ä¸€å°éƒ¨åˆ†è€å¹´ä»£çš„Regionå°±å¯ä»¥äº†ã€‚åŒæ—¶ï¼Œè¿™ä¸ªè€å¹´ä»£Regionæ˜¯å’Œå¹´è½»ä»£ä¸€èµ·è¢«å›æ”¶çš„ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªWebæœåŠ¡å™¨ï¼ŒJavaè¿›ç¨‹æœ€å¤§å †å†…å­˜ä¸º4Gï¼Œæ¯åˆ†é’Ÿå“åº”1500ä¸ªè¯·æ±‚ï¼Œæ¯45ç§’é’Ÿä¼šæ–°åˆ†é…å¤§çº¦2Gçš„å†…å­˜ã€‚G1ä¼šæ¯45ç§’é’Ÿè¿›è¡Œä¸€æ¬¡å¹´è½»ä»£å›æ”¶ï¼Œæ¯31ä¸ªå°æ—¶æ•´ä¸ªå †çš„ä½¿ç”¨ç‡ä¼šè¾¾åˆ°45%ï¼Œä¼šå¼€å§‹è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ï¼Œæ ‡è®°å®Œæˆåå¼€å§‹å››åˆ°äº”æ¬¡çš„æ··åˆå›æ”¶ã€‚</p><h3 id="7-10-Remembered-Setï¼ˆè®°å¿†é›†ï¼‰"><a href="#7-10-Remembered-Setï¼ˆè®°å¿†é›†ï¼‰" class="headerlink" title="7.10 Remembered Setï¼ˆè®°å¿†é›†ï¼‰"></a>7.10 Remembered Setï¼ˆè®°å¿†é›†ï¼‰</h3><p>ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜</p><p>ä¸€ä¸ªRegionä¸å¯èƒ½æ˜¯å­¤ç«‹çš„ï¼Œä¸€ä¸ªRegionä¸­çš„å¯¹è±¡å¯èƒ½è¢«å…¶ä»–ä»»æ„Regionä¸­å¯¹è±¡å¼•ç”¨ï¼Œåˆ¤æ–­å¯¹è±¡å­˜æ´»æ—¶ï¼Œæ˜¯å¦éœ€è¦æ‰«ææ•´ä¸ªJavaå †æ‰èƒ½ä¿è¯å‡†ç¡®ï¼Ÿ</p><p>åœ¨å…¶ä»–çš„åˆ†ä»£æ”¶é›†å™¨ï¼Œä¹Ÿå­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼ˆè€ŒG1æ›´çªå‡ºï¼‰å›æ”¶æ–°ç”Ÿä»£ä¹Ÿä¸å¾—ä¸åŒæ—¶æ‰«æè€å¹´ä»£ï¼Ÿè¿™æ ·çš„è¯ä¼šé™ä½MinorGCçš„æ•ˆç‡ï¼›</p><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><p>æ— è®ºG1è¿˜æ˜¯å…¶ä»–åˆ†ä»£æ”¶é›†å™¨ï¼ŒJVMéƒ½æ˜¯ä½¿ç”¨Remembered Setæ¥é¿å…å…¨å±€æ‰«æï¼š</p><p>æ¯ä¸ªRegionéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„Remembered Setï¼›æ¯æ¬¡Referenceç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªWrite Barrieræš‚æ—¶ä¸­æ–­æ“ä½œï¼›</p><p>ç„¶åæ£€æŸ¥å°†è¦å†™å…¥çš„å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å’Œè¯¥Referenceç±»å‹æ•°æ®åœ¨ä¸åŒçš„Regionï¼ˆå…¶ä»–æ”¶é›†å™¨ï¼šæ£€æŸ¥è€å¹´ä»£å¯¹è±¡æ˜¯å¦å¼•ç”¨äº†æ–°ç”Ÿä»£å¯¹è±¡ï¼‰ï¼›å¦‚æœä¸åŒï¼Œé€šè¿‡cardTableæŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ°å¼•ç”¨æŒ‡å‘å¯¹è±¡çš„æ‰€åœ¨Regionå¯¹åº”çš„Remembered Setä¸­ï¼›å½“è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œåœ¨GCæ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´åŠ å…¥Remembered Setï¼›å°±å¯ä»¥ä¿è¯ä¸è¿›è¡Œå…¨å±€æ‰«æï¼Œä¹Ÿä¸ä¼šæœ‰é—æ¼ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713224716715.png" alt="image-20200713224716715"></p><h3 id="7-11-G1å›æ”¶è¿‡ç¨‹-å¹´è½»ä»£GC"><a href="#7-11-G1å›æ”¶è¿‡ç¨‹-å¹´è½»ä»£GC" class="headerlink" title="7.11 G1å›æ”¶è¿‡ç¨‹-å¹´è½»ä»£GC"></a>7.11 G1å›æ”¶è¿‡ç¨‹-å¹´è½»ä»£GC</h3><p>JVMå¯åŠ¨æ—¶ï¼ŒG1å…ˆå‡†å¤‡å¥½EdenåŒºï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­åˆ›å»ºå¯¹è±¡åˆ°EdenåŒºï¼Œå½“Edenç©ºé—´è€—å°½æ—¶ï¼ŒG1ä¼šå¯åŠ¨ä¸€æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚</p><p>YGCæ—¶ï¼Œé¦–å…ˆG1åœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ˆstop-The-Wor1dï¼‰ï¼ŒG1åˆ›å»ºå›æ”¶é›†ï¼ˆCollection Setï¼‰ï¼Œå›æ”¶é›†æ˜¯æŒ‡éœ€è¦è¢«å›æ”¶çš„å†…å­˜åˆ†æ®µçš„é›†åˆï¼Œå¹´è½»ä»£å›æ”¶è¿‡ç¨‹çš„å›æ”¶é›†åŒ…å«å¹´è½»ä»£EdenåŒºå’ŒSurvivoråŒºæ‰€æœ‰çš„å†…å­˜åˆ†æ®µã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713225100632.png" alt="image-20200713225100632"></p><p>ç„¶åå¼€å§‹å¦‚ä¸‹å›æ”¶è¿‡ç¨‹ï¼š</p><ul><li>ç¬¬ä¸€é˜¶æ®µï¼Œæ‰«ææ ¹</li></ul><p>æ ¹æ˜¯æŒ‡staticå˜é‡æŒ‡å‘çš„å¯¹è±¡ï¼Œæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•è°ƒç”¨é“¾æ¡ä¸Šçš„å±€éƒ¨å˜é‡ç­‰ã€‚æ ¹å¼•ç”¨è¿åŒRSetè®°å½•çš„å¤–éƒ¨å¼•ç”¨ä½œä¸ºæ‰«æå­˜æ´»å¯¹è±¡çš„å…¥å£ã€‚</p><ul><li>ç¬¬äºŒé˜¶æ®µï¼Œæ›´æ–°RSet</li></ul><p>å¤„ç†dirty card queueï¼ˆè§å¤‡æ³¨ï¼‰ä¸­çš„cardï¼Œæ›´æ–°RSetã€‚æ­¤é˜¶æ®µå®Œæˆåï¼ŒRSetå¯ä»¥å‡†ç¡®çš„åæ˜ è€å¹´ä»£å¯¹æ‰€åœ¨çš„å†…å­˜åˆ†æ®µä¸­å¯¹è±¡çš„å¼•ç”¨ã€‚</p><ul><li>ç¬¬ä¸‰é˜¶æ®µï¼Œå¤„ç†RSet</li></ul><p>è¯†åˆ«è¢«è€å¹´ä»£å¯¹è±¡æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡ï¼Œè¿™äº›è¢«æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯å­˜æ´»çš„å¯¹è±¡ã€‚</p><ul><li>ç¬¬å››é˜¶æ®µï¼Œå¤åˆ¶å¯¹è±¡ã€‚</li></ul><p>æ­¤é˜¶æ®µï¼Œå¯¹è±¡æ ‘è¢«éå†ï¼ŒEdenåŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°SurvivoråŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡å¦‚æœå¹´é¾„æœªè¾¾é˜ˆå€¼ï¼Œå¹´é¾„ä¼šåŠ 1ï¼Œè¾¾åˆ°é˜€å€¼ä¼šè¢«ä¼šè¢«å¤åˆ¶åˆ°o1dåŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µã€‚å¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ã€‚</p><ul><li>ç¬¬äº”é˜¶æ®µï¼Œå¤„ç†å¼•ç”¨</li></ul><p>å¤„ç†Softï¼ŒWeakï¼ŒPhantomï¼ŒFinalï¼ŒJNI Weak ç­‰å¼•ç”¨ã€‚æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œè€Œç›®æ ‡å†…å­˜ä¸­çš„å¯¹è±¡éƒ½æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæ²¡æœ‰ç¢ç‰‡ï¼Œæ‰€ä»¥å¤åˆ¶è¿‡ç¨‹å¯ä»¥è¾¾åˆ°å†…å­˜æ•´ç†çš„æ•ˆæœï¼Œå‡å°‘ç¢ç‰‡ã€‚</p><h3 id="7-12-G1å›æ”¶è¿‡ç¨‹-å¹¶å‘æ ‡è®°è¿‡ç¨‹"><a href="#7-12-G1å›æ”¶è¿‡ç¨‹-å¹¶å‘æ ‡è®°è¿‡ç¨‹" class="headerlink" title="7.12 G1å›æ”¶è¿‡ç¨‹-å¹¶å‘æ ‡è®°è¿‡ç¨‹"></a>7.12 G1å›æ”¶è¿‡ç¨‹-å¹¶å‘æ ‡è®°è¿‡ç¨‹</h3><ul><li>åˆå§‹æ ‡è®°é˜¶æ®µï¼šæ ‡è®°ä»æ ¹èŠ‚ç‚¹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯sTwçš„ï¼Œå¹¶ä¸”ä¼šè§¦å‘ä¸€æ¬¡å¹´è½»ä»£GCã€‚</li><li>æ ¹åŒºåŸŸæ‰«æï¼ˆRoot Region Scanningï¼‰ï¼šG1 Gcæ‰«æsurvivoråŒºç›´æ¥å¯è¾¾çš„è€å¹´ä»£åŒºåŸŸå¯¹è±¡ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™ä¸€è¿‡ç¨‹å¿…é¡»åœ¨youngGCä¹‹å‰å®Œæˆã€‚</li><li>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰ï¼šåœ¨æ•´ä¸ªå †ä¸­è¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆå’Œåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼‰ï¼Œæ­¤è¿‡ç¨‹å¯èƒ½è¢«youngGCä¸­æ–­ã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œè‹¥å‘ç°åŒºåŸŸå¯¹è±¡ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯åƒåœ¾ï¼Œé‚£è¿™ä¸ªåŒºåŸŸä¼šè¢«ç«‹å³å›æ”¶ã€‚åŒæ—¶ï¼Œå¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œä¼šè®¡ç®—æ¯ä¸ªåŒºåŸŸçš„å¯¹è±¡æ´»æ€§ï¼ˆåŒºåŸŸä¸­å­˜æ´»å¯¹è±¡çš„æ¯”ä¾‹ï¼‰ã€‚</li><li>å†æ¬¡æ ‡è®°ï¼ˆRemarkï¼‰ï¼šç”±äºåº”ç”¨ç¨‹åºæŒç»­è¿›è¡Œï¼Œéœ€è¦ä¿®æ­£ä¸Šä¸€æ¬¡çš„æ ‡è®°ç»“æœã€‚æ˜¯STWçš„ã€‚G1ä¸­é‡‡ç”¨äº†æ¯”CMSæ›´å¿«çš„åˆå§‹å¿«ç…§ç®—æ³•ï¼šsnapshot-at-the-beginningï¼ˆSATBï¼‰ã€‚</li><li>ç‹¬å æ¸…ç†ï¼ˆcleanupï¼ŒSTWï¼‰ï¼šè®¡ç®—å„ä¸ªåŒºåŸŸçš„å­˜æ´»å¯¹è±¡å’ŒGCå›æ”¶æ¯”ä¾‹ï¼Œå¹¶è¿›è¡Œæ’åºï¼Œè¯†åˆ«å¯ä»¥æ··åˆå›æ”¶çš„åŒºåŸŸã€‚ä¸ºä¸‹é˜¶æ®µåšé“ºå«ã€‚æ˜¯sTwçš„ã€‚è¿™ä¸ªé˜¶æ®µå¹¶ä¸ä¼šå®é™…ä¸Šå»åšåƒåœ¾çš„æ”¶é›†</li><li>å¹¶å‘æ¸…ç†é˜¶æ®µï¼šè¯†åˆ«å¹¶æ¸…ç†å®Œå…¨ç©ºé—²çš„åŒºåŸŸã€‚</li></ul><h3 id="7-13-G1å›æ”¶è¿‡ç¨‹-æ··åˆå›æ”¶"><a href="#7-13-G1å›æ”¶è¿‡ç¨‹-æ··åˆå›æ”¶" class="headerlink" title="7.13 G1å›æ”¶è¿‡ç¨‹ - æ··åˆå›æ”¶"></a>7.13 G1å›æ”¶è¿‡ç¨‹ - æ··åˆå›æ”¶</h3><p>å½“è¶Šæ¥è¶Šå¤šçš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£o1d regionæ—¶ï¼Œä¸ºäº†é¿å…å †å†…å­˜è¢«è€—å°½ï¼Œè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€ä¸ªæ··åˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå³Mixed GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªold GCï¼Œé™¤äº†å›æ”¶æ•´ä¸ªYoung Regionï¼Œè¿˜ä¼šå›æ”¶ä¸€éƒ¨åˆ†çš„old Regionã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼š<strong>æ˜¯ä¸€éƒ¨åˆ†è€å¹´ä»£ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è€å¹´ä»£</strong>ã€‚å¯ä»¥é€‰æ‹©å“ªäº›o1d Regionè¿›è¡Œæ”¶é›†ï¼Œä»è€Œå¯ä»¥å¯¹åƒåœ¾å›æ”¶çš„è€—æ—¶æ—¶é—´è¿›è¡Œæ§åˆ¶ã€‚ä¹Ÿè¦æ³¨æ„çš„æ˜¯Mixed GCå¹¶ä¸æ˜¯Full GCã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200713225810871.png" alt="image-20200713225810871"></p><p>å¹¶å‘æ ‡è®°ç»“æŸä»¥åï¼Œè€å¹´ä»£ä¸­ç™¾åˆ†ç™¾ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«å›æ”¶äº†ï¼Œéƒ¨åˆ†ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«è®¡ç®—äº†å‡ºæ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›è€å¹´ä»£çš„å†…å­˜åˆ†æ®µä¼šåˆ†8æ¬¡ï¼ˆå¯ä»¥é€šè¿‡-XX:G1MixedGCCountTargetè®¾ç½®ï¼‰è¢«å›æ”¶</p><p>æ··åˆå›æ”¶çš„å›æ”¶é›†ï¼ˆCollection Setï¼‰åŒ…æ‹¬å…«åˆ†ä¹‹ä¸€çš„è€å¹´ä»£å†…å­˜åˆ†æ®µï¼ŒEdenåŒºå†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜åˆ†æ®µã€‚æ··åˆå›æ”¶çš„ç®—æ³•å’Œå¹´è½»ä»£å›æ”¶çš„ç®—æ³•å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯å›æ”¶é›†å¤šäº†è€å¹´ä»£çš„å†…å­˜åˆ†æ®µã€‚å…·ä½“è¿‡ç¨‹è¯·å‚è€ƒä¸Šé¢çš„å¹´è½»ä»£å›æ”¶è¿‡ç¨‹ã€‚</p><p>ç”±äºè€å¹´ä»£ä¸­çš„å†…å­˜åˆ†æ®µé»˜è®¤åˆ†8æ¬¡å›æ”¶ï¼ŒG1ä¼šä¼˜å…ˆå›æ”¶åƒåœ¾å¤šçš„å†…å­˜åˆ†æ®µã€‚åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¶Šé«˜çš„ï¼Œè¶Šä¼šè¢«å…ˆå›æ”¶ã€‚å¹¶ä¸”æœ‰ä¸€ä¸ªé˜ˆå€¼ä¼šå†³å®šå†…å­˜åˆ†æ®µæ˜¯å¦è¢«å›æ”¶ï¼Œ</p><p>XX:G1MixedGCLiveThresholdPercentï¼Œé»˜è®¤ä¸º65%ï¼Œæ„æ€æ˜¯åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¦è¾¾åˆ°65%æ‰ä¼šè¢«å›æ”¶ã€‚å¦‚æœåƒåœ¾å æ¯”å¤ªä½ï¼Œæ„å‘³ç€å­˜æ´»çš„å¯¹è±¡å æ¯”é«˜ï¼Œåœ¨å¤åˆ¶çš„æ—¶å€™ä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚</p><p>æ··åˆå›æ”¶å¹¶ä¸ä¸€å®šè¦è¿›è¡Œ8æ¬¡ã€‚æœ‰ä¸€ä¸ªé˜ˆå€¼-XX:G1HeapWastePercentï¼Œé»˜è®¤å€¼ä¸º1e%ï¼Œæ„æ€æ˜¯å…è®¸æ•´ä¸ªå †å†…å­˜ä¸­æœ‰10%çš„ç©ºé—´è¢«æµªè´¹ï¼Œæ„å‘³ç€å¦‚æœå‘ç°å¯ä»¥å›æ”¶çš„åƒåœ¾å å †å†…å­˜çš„æ¯”ä¾‹ä½äº1e%ï¼Œåˆ™ä¸å†è¿›è¡Œæ··åˆå›æ”¶ã€‚å› ä¸ºGCä¼šèŠ±è´¹å¾ˆå¤šçš„æ—¶é—´ä½†æ˜¯å›æ”¶åˆ°çš„å†…å­˜å´å¾ˆå°‘ã€‚</p><h3 id="7-14-G1å›æ”¶å¯é€‰çš„è¿‡ç¨‹4-Full-GC"><a href="#7-14-G1å›æ”¶å¯é€‰çš„è¿‡ç¨‹4-Full-GC" class="headerlink" title="7.14 G1å›æ”¶å¯é€‰çš„è¿‡ç¨‹4 - Full GC"></a>7.14 G1å›æ”¶å¯é€‰çš„è¿‡ç¨‹4 - Full GC</h3><p>G1çš„åˆè¡·å°±æ˜¯è¦é¿å…Fu11GCçš„å‡ºç°ã€‚ä½†æ˜¯å¦‚æœä¸Šè¿°æ–¹å¼ä¸èƒ½æ­£å¸¸å·¥ä½œï¼ŒG1ä¼šåœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ˆstop-The-worldï¼‰ï¼Œä½¿ç”¨å•çº¿ç¨‹çš„å†…å­˜å›æ”¶ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ€§èƒ½ä¼šéå¸¸å·®ï¼Œåº”ç”¨ç¨‹åºåœé¡¿æ—¶é—´ä¼šå¾ˆé•¿ã€‚</p><p>è¦é¿å…Fu11GCçš„å‘ç”Ÿï¼Œä¸€æ—¦å‘ç”Ÿéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”ŸFul1GCå‘¢ï¼Ÿæ¯”å¦‚å †å†…å­˜å¤ªå°ï¼Œå½“G1åœ¨å¤åˆ¶å­˜æ´»å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰ç©ºçš„å†…å­˜åˆ†æ®µå¯ç”¨ï¼Œåˆ™ä¼šå›é€€åˆ°ful1gcï¼Œè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡å¢å¤§å†…å­˜è§£å†³ã€‚<br>å¯¼è‡´61Fu11GCçš„åŸå› å¯èƒ½æœ‰ä¸¤ä¸ªï¼š</p><ul><li>EVacuationçš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„to-spaceæ¥å­˜æ”¾æ™‹å‡çš„å¯¹è±¡ï¼›</li><li>å¹¶å‘å¤„ç†è¿‡ç¨‹å®Œæˆä¹‹å‰ç©ºé—´è€—å°½ã€‚</li></ul><h3 id="7-15-G1å›æ”¶çš„ä¼˜åŒ–å»ºè®®"><a href="#7-15-G1å›æ”¶çš„ä¼˜åŒ–å»ºè®®" class="headerlink" title="7.15 G1å›æ”¶çš„ä¼˜åŒ–å»ºè®®"></a>7.15 G1å›æ”¶çš„ä¼˜åŒ–å»ºè®®</h3><p> ä»oracleå®˜æ–¹é€éœ²å‡ºæ¥çš„ä¿¡æ¯å¯è·çŸ¥ï¼Œå›æ”¶é˜¶æ®µï¼ˆEvacuationï¼‰å…¶å®æœ¬ä¹Ÿæœ‰æƒ³è¿‡è®¾è®¡æˆä¸ç”¨æˆ·ç¨‹åºä¸€èµ·å¹¶å‘æ‰§è¡Œï¼Œä½†è¿™ä»¶äº‹æƒ…åšèµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè€ƒè™‘åˆ°G1åªæ˜¯å›ä¸€éƒ¨åˆ†Regionï¼Œåœé¡¿æ—¶é—´æ˜¯ç”¨æˆ·å¯æ§åˆ¶çš„ï¼Œæ‰€ä»¥å¹¶ä¸è¿«åˆ‡å»å®ç°ï¼Œè€Œé€‰æ‹©æŠŠè¿™ä¸ªç‰¹æ€§æ”¾åˆ°äº†G1ä¹‹åå‡ºç°çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ˆå³ZGCï¼‰ä¸­ã€‚å¦å¤–ï¼Œè¿˜è€ƒè™‘åˆ°G1ä¸æ˜¯ä»…ä»…é¢å‘ä½å»¶è¿Ÿï¼Œåœé¡¿ç”¨æˆ·çº¿ç¨‹èƒ½å¤Ÿæœ€å¤§å¹…åº¦æé«˜åƒåœ¾æ”¶é›†æ•ˆç‡ï¼Œä¸ºäº†ä¿è¯ååé‡æ‰€ä»¥æ‰é€‰æ‹©äº†å®Œå…¨æš‚åœç”¨æˆ·çº¿ç¨‹çš„å®ç°æ–¹æ¡ˆã€‚</p><p>å¹´è½»ä»£å¤§å°</p><ul><li>é¿å…ä½¿ç”¨-Xmnæˆ–-XX:NewRatioç­‰ç›¸å…³é€‰é¡¹æ˜¾å¼è®¾ç½®å¹´è½»ä»£å¤§å°</li><li>å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–</li></ul><p>æš‚åœæ—¶é—´ç›®æ ‡æš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹›</p><ul><li>G1 GCçš„ååé‡ç›®æ ‡æ˜¯90%çš„åº”ç”¨ç¨‹åºæ—¶é—´å’Œ10%çš„åƒåœ¾å›æ”¶æ—¶é—´</li><li>è¯„ä¼°G1GCçš„ååé‡æ—¶ï¼Œæš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªä¸¥è‹›ã€‚ç›®æ ‡å¤ªè¿‡ä¸¥è‹›è¡¨ç¤ºä½ æ„¿æ„æ‰¿å—æ›´å¤šçš„åƒåœ¾å›æ”¶å¼€é”€ï¼Œè€Œè¿™äº›ä¼šç›´æ¥å½±å“åˆ°ååé‡ã€‚</li></ul><h2 id="8-åƒåœ¾å›æ”¶å™¨æ€»ç»“"><a href="#8-åƒåœ¾å›æ”¶å™¨æ€»ç»“" class="headerlink" title="8 åƒåœ¾å›æ”¶å™¨æ€»ç»“"></a>8 åƒåœ¾å›æ”¶å™¨æ€»ç»“</h2><p>æˆªæ­¢JDK1.8ï¼Œä¸€å…±æœ‰7æ¬¾ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨ã€‚æ¯ä¸€æ¬¾çš„åƒåœ¾æ”¶é›†å™¨éƒ½æœ‰ä¸åŒçš„ç‰¹ç‚¹ï¼Œåœ¨å…·ä½“ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„æƒ…å†µé€‰ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714075738203.png" alt="image-20200714075738203"></p><p>GCå‘å±•é˜¶æ®µï¼šSeria l=&gt; Parallelï¼ˆå¹¶è¡Œï¼‰=&gt; CMSï¼ˆå¹¶å‘ï¼‰=&gt; G1 =&gt; ZGC</p><p>ä¸åŒå‚å•†ã€ä¸åŒç‰ˆæœ¬çš„è™šæ‹Ÿæœºå®ç°å·®è·æ¯”è¾ƒå¤§ã€‚HotSpotè™šæ‹Ÿæœºåœ¨JDK7/8åæ‰€æœ‰æ”¶é›†å™¨åŠç»„åˆå¦‚ä¸‹å›¾</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714080151020.png" alt="image-20200714080151020"></p><h3 id="8-1-æ€ä¹ˆé€‰æ‹©åƒåœ¾å›æ”¶å™¨"><a href="#8-1-æ€ä¹ˆé€‰æ‹©åƒåœ¾å›æ”¶å™¨" class="headerlink" title="8.1 æ€ä¹ˆé€‰æ‹©åƒåœ¾å›æ”¶å™¨"></a>8.1 æ€ä¹ˆé€‰æ‹©åƒåœ¾å›æ”¶å™¨</h3><p>Javaåƒåœ¾æ”¶é›†å™¨çš„é…ç½®å¯¹äºJVMä¼˜åŒ–æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„é€‰æ‹©ï¼Œé€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†å™¨å¯ä»¥è®©JVMçš„æ€§èƒ½æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æå‡ã€‚æ€ä¹ˆé€‰æ‹©åƒåœ¾æ”¶é›†å™¨ï¼Ÿ</p><ul><li>ä¼˜å…ˆè°ƒæ•´å †çš„å¤§å°è®©JVMè‡ªé€‚åº”å®Œæˆã€‚</li><li>å¦‚æœå†…å­˜å°äº100Mï¼Œä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨</li><li>å¦‚æœæ˜¯å•æ ¸ã€å•æœºç¨‹åºï¼Œå¹¶ä¸”æ²¡æœ‰åœé¡¿æ—¶é—´çš„è¦æ±‚ï¼Œä¸²è¡Œæ”¶é›†å™¨</li><li>å¦‚æœæ˜¯å¤šCPUã€éœ€è¦é«˜ååé‡ã€å…è®¸åœé¡¿æ—¶é—´è¶…è¿‡1ç§’ï¼Œé€‰æ‹©å¹¶è¡Œæˆ–è€…JVMè‡ªå·±é€‰æ‹©</li><li>å¦‚æœæ˜¯å¤šCPUã€è¿½æ±‚ä½åœé¡¿æ—¶é—´ï¼Œéœ€å¿«é€Ÿå“åº”ï¼ˆæ¯”å¦‚å»¶è¿Ÿä¸èƒ½è¶…è¿‡1ç§’ï¼Œå¦‚äº’è”ç½‘åº”ç”¨ï¼‰ï¼Œä½¿ç”¨å¹¶å‘æ”¶é›†å™¨</li><li>å®˜æ–¹æ¨èG1ï¼Œæ€§èƒ½é«˜ã€‚ç°åœ¨äº’è”ç½‘çš„é¡¹ç›®ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨G1ã€‚</li></ul><p>æœ€åéœ€è¦æ˜ç¡®ä¸€ä¸ªè§‚ç‚¹ï¼š</p><ul><li>æ²¡æœ‰æœ€å¥½çš„æ”¶é›†å™¨ï¼Œæ›´æ²¡æœ‰ä¸‡èƒ½çš„æ”¶é›†</li><li>è°ƒä¼˜æ°¸è¿œæ˜¯é’ˆå¯¹ç‰¹å®šåœºæ™¯ã€ç‰¹å®šéœ€æ±‚ï¼Œä¸å­˜åœ¨ä¸€åŠ³æ°¸é€¸çš„æ”¶é›†å™¨</li></ul><h3 id="8-2-é¢è¯•"><a href="#8-2-é¢è¯•" class="headerlink" title="8.2 é¢è¯•"></a>8.2 é¢è¯•</h3><p>å¯¹äºåƒåœ¾æ”¶é›†ï¼Œé¢è¯•å®˜å¯ä»¥å¾ªåºæ¸è¿›ä»ç†è®ºã€å®è·µå„ç§è§’åº¦æ·±å…¥ï¼Œä¹Ÿæœªå¿…æ˜¯è¦æ±‚é¢è¯•è€…ä»€ä¹ˆéƒ½æ‡‚ã€‚ä½†å¦‚æœä½ æ‡‚å¾—åŸç†ï¼Œä¸€å®šä¼šæˆä¸ºé¢è¯•ä¸­çš„åŠ åˆ†é¡¹ã€‚<br>è¿™é‡Œè¾ƒé€šç”¨ã€åŸºç¡€æ€§çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><p>åƒåœ¾æ”¶é›†çš„ç®—æ³•æœ‰å“ªäº›ï¼Ÿå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ï¼Ÿ</p><p>åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„åŸºæœ¬æµç¨‹ã€‚</p><p>å¦å¤–ï¼Œå¤§å®¶éœ€è¦å¤šå…³æ³¨åƒåœ¾å›æ”¶å™¨è¿™ä¸€ç« çš„å„ç§å¸¸ç”¨çš„å‚æ•°</p><h2 id="9-GCæ—¥å¿—åˆ†æ"><a href="#9-GCæ—¥å¿—åˆ†æ" class="headerlink" title="9 GCæ—¥å¿—åˆ†æ"></a>9 GCæ—¥å¿—åˆ†æ</h2><p>é€šè¿‡é˜…è¯»Gcæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£Javaè™šæ‹Ÿæœºå†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥ã€‚<br>å†…å­˜åˆ†é…ä¸åƒåœ¾å›æ”¶çš„å‚æ•°åˆ—è¡¨</p><ul><li>-XX:+PrintGcè¾“å‡ºGCæ—¥å¿—ã€‚ç±»ä¼¼ï¼š-verbose:gc</li><li>-XX:+PrintGcDetailsè¾“å‡ºGcçš„è¯¦ç»†æ—¥å¿—</li><li>-XX:+PrintGcTimestamps è¾“å‡ºGcçš„æ—¶é—´æˆ³ï¼ˆä»¥åŸºå‡†æ—¶é—´çš„å½¢å¼ï¼‰</li><li>-XX:+PrintGCDatestamps è¾“å‡ºGcçš„æ—¶é—´æˆ³ï¼ˆä»¥æ—¥æœŸçš„å½¢å¼ï¼Œå¦‚2013-05-04T21ï¼š53ï¼š59.234+0800ï¼‰</li><li>-XX:+PrintHeapAtGCåœ¨è¿›è¡ŒGcçš„å‰åæ‰“å°å‡ºå †çš„ä¿¡æ¯</li><li>-Xloggc:../logs/gc.1ogæ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„</li></ul><h3 id="9-1-verbose-gc"><a href="#9-1-verbose-gc" class="headerlink" title="9.1 verbose:gc"></a>9.1 verbose:gc</h3><p>æ‰“å¼€GCæ—¥å¿—</p><div class="code-wrapper"><pre><code class="hljs bash">-verbose:gc</code></pre></div><p>è¿™ä¸ªåªä¼šæ˜¾ç¤ºæ€»çš„GCå †çš„å˜åŒ–ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714081610474.png" alt="image-20200714081610474"></p><p>å‚æ•°è§£æ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714081622526.png" alt="image-20200714081622526"></p><h3 id="9-2-PrintGCDetails"><a href="#9-2-PrintGCDetails" class="headerlink" title="9.2 PrintGCDetails"></a>9.2 PrintGCDetails</h3><p>æ‰“å¼€GCæ—¥å¿—</p><div class="code-wrapper"><pre><code class="hljs bash">-verbose:gc -XX:+PrintGCDetails</code></pre></div><p>è¾“å…¥ä¿¡æ¯å¦‚ä¸‹</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714081909309.png" alt="image-20200714081909309"></p><p>å‚æ•°è§£æ</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714081925767.png" alt="image-20200714081925767"></p><h3 id="9-3-è¡¥å……"><a href="#9-3-è¡¥å……" class="headerlink" title="9.3 è¡¥å……"></a>9.3 è¡¥å……</h3><ul><li>[GCâ€å’Œâ€[Fu11GCâ€è¯´æ˜äº†è¿™æ¬¡åƒåœ¾æ”¶é›†çš„åœé¡¿ç±»å‹ï¼Œå¦‚æœæœ‰â€Fu11â€åˆ™è¯´æ˜GCå‘ç”Ÿäº†â€stop The Worldâ€</li><li>ä½¿ç”¨Seria1æ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—æ˜¯Default New Generationï¼Œå› æ­¤æ˜¾ç¤ºçš„æ˜¯â€[DefNewâ€</li><li>ä½¿ç”¨ParNewæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—ä¼šå˜æˆâ€[ParNewâ€ï¼Œæ„æ€æ˜¯â€Parallel New Generationâ€</li><li>ä½¿ç”¨Paralle1 scavengeæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—æ˜¯â€[PSYoungGenâ€</li><li>è€å¹´ä»£çš„æ”¶é›†å’Œæ–°ç”Ÿä»£é“ç†ä¸€æ ·ï¼Œåå­—ä¹Ÿæ˜¯æ”¶é›†å™¨å†³å®šçš„</li><li>ä½¿ç”¨G1æ”¶é›†å™¨çš„è¯ï¼Œä¼šæ˜¾ç¤ºä¸ºâ€garbage-first heapâ€</li></ul><p>Allocation Failureè¡¨æ˜æœ¬æ¬¡å¼•èµ·GCçš„åŸå› æ˜¯å› ä¸ºåœ¨å¹´è½»ä»£ä¸­æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´èƒ½å¤Ÿå­˜å‚¨æ–°çš„æ•°æ®äº†ã€‚</p><p>[PSYoungGenï¼š5986K-&gt;696Kï¼ˆ8704Kï¼‰]5986K-&gt;704Kï¼ˆ9216Kï¼‰ä¸­æ‹¬å·å†…ï¼šGCå›æ”¶å‰å¹´è½»ä»£å¤§å°ï¼Œå›æ”¶åå¤§å°ï¼Œï¼ˆå¹´è½»ä»£æ€»å¤§å°ï¼‰æ‹¬å·å¤–ï¼šGCå›æ”¶å‰å¹´è½»ä»£å’Œè€å¹´ä»£å¤§å°ï¼Œå›æ”¶åå¤§å°ï¼Œï¼ˆå¹´è½»ä»£å’Œè€å¹´ä»£æ€»å¤§å°ï¼‰</p><p>userä»£è¡¨ç”¨æˆ·æ€å›æ”¶è€—æ—¶ï¼Œsyså†…æ ¸æ€å›æ”¶è€—æ—¶ï¼Œreaå®é™…è€—æ—¶ã€‚ç”±äºå¤šæ ¸çš„åŸå› ï¼Œæ—¶é—´æ€»å’Œå¯èƒ½ä¼šè¶…è¿‡rea1æ—¶é—´</p><h3 id="9-4-Young-GCå›¾ç‰‡"><a href="#9-4-Young-GCå›¾ç‰‡" class="headerlink" title="9.4 Young GCå›¾ç‰‡"></a>9.4 Young GCå›¾ç‰‡</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714082555688.png" alt="image-20200714082555688"></p><h3 id="9-5-FullGCå›¾ç‰‡"><a href="#9-5-FullGCå›¾ç‰‡" class="headerlink" title="9.5 FullGCå›¾ç‰‡"></a>9.5 FullGCå›¾ç‰‡</h3><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714082714690.png" alt="image-20200714082714690"></p><h3 id="9-6-GCå›æ”¶ä¸¾ä¾‹"><a href="#9-6-GCå›æ”¶ä¸¾ä¾‹" class="headerlink" title="9.6 GCå›æ”¶ä¸¾ä¾‹"></a>9.6 GCå›æ”¶ä¸¾ä¾‹</h3><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œç”¨æ¥è¯´æ˜GCæ”¶é›†çš„è¿‡ç¨‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * GCåƒåœ¾æ”¶é›†è¿‡ç¨‹</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GCUseTest</span> </span>&#123;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer _1MB = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">byte</span> [] allocation1, allocation2, allocation3, allocation4;        allocation1 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span> *_1MB];        allocation2 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span> *_1MB];        allocation3 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span> *_1MB];        allocation4 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">4</span> *_1MB];    &#125;&#125;</code></pre></div><p>æˆ‘ä»¬è®¾ç½®JVMå¯åŠ¨å‚æ•°</p><div class="code-wrapper"><pre><code class="hljs bash">-Xms10m -Xmx10m -XX:+PrintGCDetails</code></pre></div><p>é¦–å…ˆæˆ‘ä»¬ä¼šå°†3ä¸ª2Mçš„æ•°ç»„å­˜æ”¾åˆ°EdenåŒºï¼Œç„¶ååé¢4Mçš„æ•°ç»„æ¥äº†åï¼Œå°†æ— æ³•å­˜å‚¨ï¼Œå› ä¸ºEdenåŒºåªå‰©ä¸‹2Mçš„å‰©ä½™ç©ºé—´äº†ï¼Œé‚£ä¹ˆå°†ä¼šè¿›è¡Œä¸€æ¬¡Young GCæ“ä½œï¼Œå°†åŸæ¥EdenåŒºçš„å†…å®¹ï¼Œå­˜æ”¾åˆ°SurvivoråŒºï¼Œä½†æ˜¯SurvivoråŒºä¹Ÿå­˜æ”¾ä¸ä¸‹ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥æ™‹çº§å­˜å…¥Old åŒº</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714083332238.png" alt="image-20200714083332238"></p><p>ç„¶åæˆ‘ä»¬å°†4Må¯¹è±¡å­˜å…¥åˆ°EdenåŒºä¸­</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714083526790.png" alt="image-20200714083526790"></p><p>å¯ä»¥ç”¨ä¸€äº›å·¥å…·å»åˆ†æè¿™äº›GCæ—¥å¿—</p><p>å¸¸ç”¨çš„æ—¥å¿—åˆ†æå·¥å…·æœ‰ï¼šGCViewerã€GCEasyã€GCHistoã€GCLogViewerã€Hpjmeterã€garbagecatç­‰</p><p><strong>GCViewer</strong></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714084921184.png" alt="image-20200714084921184"></p><p><strong>GC easy</strong></p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714084726824.png" alt="image-20200714084726824"></p><h2 id="10-åƒåœ¾å›æ”¶å™¨çš„æ–°å‘å±•"><a href="#10-åƒåœ¾å›æ”¶å™¨çš„æ–°å‘å±•" class="headerlink" title="10 åƒåœ¾å›æ”¶å™¨çš„æ–°å‘å±•"></a>10 åƒåœ¾å›æ”¶å™¨çš„æ–°å‘å±•</h2><p>GCä»ç„¶å¤„äºé£é€Ÿå‘å±•ä¹‹ä¸­ï¼Œç›®å‰çš„é»˜è®¤é€‰é¡¹G1GCåœ¨ä¸æ–­çš„è¿›è¡Œæ”¹è¿›ï¼Œå¾ˆå¤šæˆ‘ä»¬åŸæ¥è®¤ä¸ºçš„ç¼ºç‚¹ï¼Œä¾‹å¦‚ä¸²è¡Œçš„Fu11GCã€Card Tableæ‰«æçš„ä½æ•ˆç­‰ï¼Œéƒ½å·²ç»è¢«å¤§å¹…æ”¹è¿›ï¼Œä¾‹å¦‚ï¼ŒJDK10ä»¥åï¼ŒFu11GCå·²ç»æ˜¯å¹¶è¡Œè¿è¡Œï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œå…¶è¡¨ç°è¿˜ç•¥ä¼˜äºParallelGCçš„å¹¶è¡ŒFul1GCå®ç°ã€‚</p><p>å³ä½¿æ˜¯SerialGCï¼Œè™½ç„¶æ¯”è¾ƒå¤è€ï¼Œä½†æ˜¯ç®€å•çš„è®¾è®¡å’Œå®ç°æœªå¿…å°±æ˜¯è¿‡æ—¶çš„ï¼Œå®ƒæœ¬èº«çš„å¼€é”€ï¼Œä¸ç®¡æ˜¯GCç›¸å…³æ•°æ®ç»“æ„çš„å¼€é”€ï¼Œè¿˜æ˜¯çº¿ç¨‹çš„å¼€é”€ï¼Œéƒ½æ˜¯éå¸¸å°çš„ï¼Œæ‰€ä»¥éšç€äº‘è®¡ç®—çš„å…´èµ·ï¼Œåœ¨serverlessç­‰æ–°çš„åº”ç”¨åœºæ™¯ä¸‹ï¼ŒSerial Gcæ‰¾åˆ°äº†æ–°çš„èˆå°ã€‚</p><p>æ¯”è¾ƒä¸å¹¸çš„æ˜¯CMSGCï¼Œå› ä¸ºå…¶ç®—æ³•çš„ç†è®ºç¼ºé™·ç­‰åŸå› ï¼Œè™½ç„¶ç°åœ¨è¿˜æœ‰éå¸¸å¤§çš„ç”¨æˆ·ç¾¤ä½“ï¼Œä½†åœ¨JDK9ä¸­å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼Œå¹¶åœ¨JDK14ç‰ˆæœ¬ä¸­ç§»é™¤</p><p>Epsilon:A No-Op GarbageCollectorï¼ˆEpsilonåƒåœ¾å›æ”¶å™¨ï¼Œâ€No-Opï¼ˆæ— æ“ä½œï¼‰â€å›æ”¶å™¨ï¼‰<a href="http://openidk.iava.net/iep">http://openidk.iava.net/iep</a> s/318</p><p>ZGC:A Scalable Low-Latency Garbage Collectorï¼ˆExperimentalï¼‰ï¼ˆZGCï¼šå¯ä¼¸ç¼©çš„ä½å»¶è¿Ÿåƒåœ¾å›æ”¶å™¨ï¼Œå¤„äºå®éªŒæ€§é˜¶æ®µï¼‰</p><p>ç°åœ¨G1å›æ”¶å™¨å·²æˆä¸ºé»˜è®¤å›æ”¶å™¨å¥½å‡ å¹´äº†ã€‚æˆ‘ä»¬è¿˜çœ‹åˆ°äº†å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„æ”¶é›†å™¨ï¼šZGCï¼ˆJDK11å‡ºç°ï¼‰å’ŒShenandoahï¼ˆOpen JDK12ï¼‰</p><blockquote><p>ä¸»æ‰“ç‰¹ç‚¹ï¼šä½åœé¡¿æ—¶é—´</p></blockquote><h3 id="10-1-Open-JDK12çš„Shenandoash-GC"><a href="#10-1-Open-JDK12çš„Shenandoash-GC" class="headerlink" title="10.1 Open JDK12çš„Shenandoash GC"></a>10.1 Open JDK12çš„Shenandoash GC</h3><p>Open JDK12çš„shenandoash GCï¼šä½åœé¡¿æ—¶é—´çš„GCï¼ˆå®éªŒæ€§ï¼‰</p><p>Shenandoahï¼Œæ— ç–‘æ˜¯ä¼—å¤šGCä¸­æœ€å­¤ç‹¬çš„ä¸€ä¸ªã€‚æ˜¯ç¬¬ä¸€æ¬¾ä¸ç”±oracleå…¬å¸å›¢é˜Ÿé¢†å¯¼å¼€å‘çš„Hotspotåƒåœ¾æ”¶é›†å™¨ã€‚ä¸å¯é¿å…çš„å—åˆ°å®˜æ–¹çš„æ’æŒ¤ã€‚æ¯”å¦‚å·ç§°openJDKå’ŒOracleJDkæ²¡æœ‰åŒºåˆ«çš„Oracleå…¬å¸ä»æ‹’ç»åœ¨oracleJDK12ä¸­æ”¯æŒShenandoahã€‚</p><p>Shenandoahåƒåœ¾å›æ”¶å™¨æœ€åˆç”±RedHatè¿›è¡Œçš„ä¸€é¡¹åƒåœ¾æ”¶é›†å™¨ç ”ç©¶é¡¹ç›®Pauseless GCçš„å®ç°ï¼Œæ—¨åœ¨é’ˆå¯¹JVMä¸Šçš„å†…å­˜å›æ”¶å®ç°ä½åœé¡¿çš„éœ€æ±‚ã€‚åœ¨2014å¹´è´¡çŒ®ç»™OpenJDKã€‚</p><p>Red Hatç ”å‘Shenandoahå›¢é˜Ÿå¯¹å¤–å®£ç§°ï¼ŒShenandoahåƒåœ¾å›æ”¶å™¨çš„æš‚åœæ—¶é—´ä¸å †å¤§å°æ— å…³ï¼Œè¿™æ„å‘³ç€æ— è®ºå°†å †è®¾ç½®ä¸º200MBè¿˜æ˜¯200GBï¼Œ99.9%çš„ç›®æ ‡éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨åæ¯«ç§’ä»¥å†…ã€‚ä¸è¿‡å®é™…ä½¿ç”¨æ€§èƒ½å°†å–å†³äºå®é™…å·¥ä½œå †çš„å¤§å°å’Œå·¥ä½œè´Ÿè½½ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714090608807.png" alt="image-20200714090608807"></p><p>è¿™æ˜¯RedHatåœ¨2016å¹´å‘è¡¨çš„è®ºæ–‡æ•°æ®ï¼Œæµ‹è¯•å†…å®¹æ˜¯ä½¿ç”¨Eså¯¹200GBçš„ç»´åŸºç™¾ç§‘æ•°æ®è¿›è¡Œç´¢å¼•ã€‚ä»ç»“æœçœ‹ï¼š</p><blockquote><p>åœé¡¿æ—¶é—´æ¯”å…¶ä»–å‡ æ¬¾æ”¶é›†å™¨ç¡®å®æœ‰äº†è´¨çš„é£è·ƒï¼Œä½†ä¹Ÿæœªå®ç°æœ€å¤§åœé¡¿æ—¶é—´æ§åˆ¶åœ¨åæ¯«ç§’ä»¥å†…çš„ç›®æ ‡ã€‚<br>è€Œååé‡æ–¹é¢å‡ºç°äº†æ˜æ˜¾çš„ä¸‹é™ï¼Œæ€»è¿è¡Œæ—¶é—´æ˜¯æ‰€æœ‰æµ‹è¯•æ”¶é›†å™¨é‡Œæœ€é•¿çš„ã€‚</p></blockquote><p>æ€»ç»“</p><ul><li>shenandoah Gcçš„å¼±é¡¹ï¼šé«˜è¿è¡Œè´Ÿæ‹…ä¸‹çš„ååé‡ä¸‹é™ã€‚</li><li>shenandoah GCçš„å¼ºé¡¹ï¼šä½å»¶è¿Ÿæ—¶é—´ã€‚</li></ul><h3 id="10-2-é©å‘½æ€§çš„ZGC"><a href="#10-2-é©å‘½æ€§çš„ZGC" class="headerlink" title="10.2 é©å‘½æ€§çš„ZGC"></a>10.2 é©å‘½æ€§çš„ZGC</h3><p>zGCä¸shenandoahç›®æ ‡é«˜åº¦ç›¸ä¼¼ï¼Œåœ¨å°½å¯èƒ½å¯¹ååé‡å½±å“ä¸å¤§çš„å‰æä¸‹ï¼Œå®ç°åœ¨ä»»æ„å †å†…å­˜å¤§å°ä¸‹éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¢‡æ—¶é—´é™åˆ¶åœ¨åæ¯«ç§’ä»¥å†…çš„ä½å»¶è¿Ÿã€‚</p><p>ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸€ä¹¦ä¸­è¿™æ ·å®šä¹‰zGCï¼š2GCæ”¶é›†å™¨æ˜¯ä¸€æ¬¾åŸºäºRegionå†…å­˜å¸ƒå±€çš„ï¼Œï¼ˆæš‚æ—¶ï¼‰ä¸è®¾åˆ†ä»£çš„ï¼Œä½¿ç”¨äº†è¯»å±éšœã€æŸ“è‰²æŒ‡é’ˆå’Œå†…å­˜å¤šé‡æ˜ å°„ç­‰æŠ€æœ¯æ¥å®ç°å¯å¹¶å‘çš„æ ‡è®°-å‹ç¼©ç®—æ³•çš„ï¼Œä»¥ä½å»¶è¿Ÿä¸ºé¦–è¦ç›®æ ‡çš„ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨ã€‚</p><p>ZGCçš„å·¥ä½œè¿‡ç¨‹å¯ä»¥åˆ†ä¸º4ä¸ªé˜¶æ®µï¼š<strong>å¹¶å‘æ ‡è®° - å¹¶å‘é¢„å¤‡é‡åˆ†é… - å¹¶å‘é‡åˆ†é… - å¹¶å‘é‡æ˜ å°„</strong> ç­‰ã€‚</p><p>ZGCå‡ ä¹åœ¨æ‰€æœ‰åœ°æ–¹å¹¶å‘æ‰§è¡Œçš„ï¼Œé™¤äº†åˆå§‹æ ‡è®°çš„æ˜¯STwçš„ã€‚æ‰€ä»¥åœé¡¿æ—¶é—´å‡ ä¹å°±è€—è´¹åœ¨åˆå§‹æ ‡è®°ä¸Šï¼Œè¿™éƒ¨åˆ†çš„å®é™…æ—¶é—´æ˜¯éå¸¸å°‘çš„ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714091201073.png" alt="image-20200714091201073"></p><p>åœé¡¿æ—¶é—´å¯¹æ¯”</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714091401511.png" alt="image-20200714091401511"></p><p>è™½ç„¶ZGCè¿˜åœ¨è¯•éªŒçŠ¶æ€ï¼Œæ²¡æœ‰å®Œæˆæ‰€æœ‰ç‰¹æ€§ï¼Œä½†æ­¤æ—¶æ€§èƒ½å·²ç»ç›¸å½“äº®çœ¼ï¼Œç”¨â€œä»¤äººéœ‡æƒŠã€é©å‘½æ€§â€æ¥å½¢å®¹ï¼Œä¸ä¸ºè¿‡ã€‚<br>æœªæ¥å°†åœ¨æœåŠ¡ç«¯ã€å¤§å†…å­˜ã€ä½å»¶è¿Ÿåº”ç”¨çš„é¦–é€‰åƒåœ¾æ”¶é›†å™¨ã€‚</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714093243028.png" alt="image-20200714093243028"></p><p>JDK14ä¹‹å‰ï¼Œ2GCä»…Linuxæ‰æ”¯æŒã€‚</p><p>å°½ç®¡è®¸å¤šä½¿ç”¨zGcçš„ç”¨æˆ·éƒ½ä½¿ç”¨ç±»Linuxçš„ç¯å¢ƒï¼Œä½†åœ¨Windowså’Œmacosä¸Šï¼Œäººä»¬ä¹Ÿéœ€è¦zGCè¿›è¡Œå¼€å‘éƒ¨ç½²å’Œæµ‹è¯•ã€‚è®¸å¤šæ¡Œé¢åº”ç”¨ä¹Ÿå¯ä»¥ä»ZGCä¸­å—ç›Šã€‚å› æ­¤ï¼Œ2GCç‰¹æ€§è¢«ç§»æ¤åˆ°äº†Windowså’Œmacosä¸Šã€‚</p><p>ç°åœ¨macæˆ–Windowsä¸Šä¹Ÿèƒ½ä½¿ç”¨zGCäº†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs bash">-XX:+UnlockExperimentalVMOptions-XXï¼š+UseZGC</code></pre></div><h3 id="10-3-AliGC"><a href="#10-3-AliGC" class="headerlink" title="10.3 AliGC"></a>10.3 AliGC</h3><p>AliGCæ˜¯é˜¿é‡Œå·´å·´JVMå›¢é˜ŸåŸºäºG1ç®—æ³•ï¼Œé¢å‘å¤§å †ï¼ˆLargeHeapï¼‰åº”ç”¨åœºæ™¯ã€‚æŒ‡å®šåœºæ™¯ä¸‹çš„å¯¹æ¯”ï¼š</p><p><img src="/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/image-20200714093604012.png" alt="image-20200714093604012"></p><p>å½“ç„¶ï¼Œå…¶å®ƒå‚å•†ä¹Ÿæä¾›äº†å„ç§åˆ«å…·ä¸€æ ¼çš„GCå®ç°ï¼Œä¾‹å¦‚æ¯”è¾ƒæœ‰åçš„ä½å»¶è¿ŸGC Zing</p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Java/">Java</category>
      
      <category domain="https://pncalbl.github.io/categories/Java/Tool/">Tool</category>
      
      
      
      <comments>https://pncalbl.github.io/2021/07/20/JVM%E5%AD%A6%E4%B9%A0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>åŸºäºç‰©è”ç½‘(IoT)çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨</title>
      <link>https://pncalbl.github.io/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/</link>
      <guid>https://pncalbl.github.io/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/</guid>
      <pubDate>Mon, 07 Jun 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;åŸºäºç‰©è”ç½‘-IoT-çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨&quot;&gt;&lt;a href=&quot;#åŸºäºç‰©è”ç½‘-IoT-çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨&quot; class=&quot;headerlink&quot; title=&quot;åŸºäºç‰©è”ç½‘(IoT)çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨&quot;&gt;&lt;/a&gt;åŸºäºç‰©è”ç½‘(IoT)çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨&lt;/h1&gt;&lt;h2 id=&quot;1-é¡¹ç›®æ¦‚</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="åŸºäºç‰©è”ç½‘-IoT-çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨"><a href="#åŸºäºç‰©è”ç½‘-IoT-çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨" class="headerlink" title="åŸºäºç‰©è”ç½‘(IoT)çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨"></a>åŸºäºç‰©è”ç½‘(IoT)çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨</h1><h2 id="1-é¡¹ç›®æ¦‚è¿°"><a href="#1-é¡¹ç›®æ¦‚è¿°" class="headerlink" title="1 é¡¹ç›®æ¦‚è¿°"></a>1 é¡¹ç›®æ¦‚è¿°</h2><ul><li><p>è¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªç®€å•å’Œä½æˆæœ¬çš„ IoT è§£å†³æ–¹æ¡ˆï¼Œç”¨äºç›‘æ§å’Œæ§åˆ¶æ™ºèƒ½åŒè½´å¤ªé˜³èƒ½è·Ÿè¸ªç³»ç»Ÿï¼Œç”¨äºæ€§èƒ½è¯„ä¼°ã€‚</p></li><li><p>é¡¹ç›®ä¸­çš„åŸºäº IoT çš„å¤ªé˜³èƒ½è·Ÿè¸ªç³»ç»Ÿåœ¨å›¾ 1 ä¸­è¿›è¡Œäº†æè¿°ã€‚å®ƒæ˜¯ä¸€ç§åŒè½´å¤ªé˜³èƒ½è·Ÿè¸ªå™¨ï¼Œå¯ä»¥è‡ªåŠ¨æ—‹è½¬ï¼Œä½¿ç”¨LDRä¼ æ„Ÿå™¨è·Ÿè¸ªå¤ªé˜³çš„ä½ç½®ï¼Œæˆ–è€…ç”¨æˆ·é€šè¿‡ç‰©ç†æ§åˆ¶çš„ä»ªè¡¨æ¿æ‰‹åŠ¨è·Ÿè¸ªå¤ªé˜³çš„ä½ç½®ã€‚ç³»ç»Ÿä» LDR ä¼ æ„Ÿå™¨æ£€æµ‹å¤ªé˜³ä½ç½®ï¼ˆå…‰çš„å¼ºåº¦ï¼‰å¼€å§‹ï¼Œå¹¶å°†æ•°æ®å‘é€åˆ°æ§åˆ¶å™¨ï¼ˆArduino Mega æ¿ï¼‰ã€‚åè€…ç„¶åå¤„ç†è¿™äº›æ•°æ®ä»¥å‘½ä»¤ä¿å­˜å™¨ ï¼ˆSM1 å’Œ SM2ï¼‰ï¼Œè¿™äº›å­˜å‚¨å™¨å°†å…‰ä¼é¢æ¿æ—‹è½¬åˆ°å¤ªé˜³ã€‚äº§ç”Ÿçš„å…‰ä¼ç”µå‹å€¼å’Œç”µæµã€æ¸©åº¦å’Œæ¹¿åº¦ä¹Ÿé€šè¿‡ç›¸å…³ä¼ æ„Ÿå™¨å‘é€åˆ° Arduinoã€‚</p></li><li><p>æ¥ä¸‹æ¥ï¼Œå®‰è£…åœ¨ Arduino å¹¶å…è®¸å…¶è¿æ¥åˆ° Internet çš„ä»¥å¤ªç½‘æ‰©å±•æ¨¡å—å°†æŠŠArduinoæ­£åœ¨è·å–æˆ–å¤„ç†çš„æ•°æ®å‘é€åˆ°äº‘ï¼ˆWebserverï¼‰ã€‚æœ€åï¼Œé€šè¿‡é¢„åˆ¶çš„å°éƒ¨ä»¶å®æ—¶æ˜¾ç¤ºå¤ªé˜³è·Ÿè¸ªå™¨æ•°æ®ï¼ŒåŒ…æ‹¬LDRä¼ æ„Ÿå™¨ã€å…‰ä¼åŠŸç‡ã€æ¸©åº¦å’Œæ¹¿åº¦ã€‚ç‰©è”ç½‘ç›‘æ§åº”ç”¨ç¨‹åºæ˜¯ä½¿ç”¨æˆ‘çš„è®¾å¤‡å¡å®´ã€‚ä¸€æ—¦ç”¨æˆ·ä»è®¡ç®—æœºæˆ–æ™ºèƒ½æ‰‹æœºè¿æ¥åˆ°äº’è”ç½‘ï¼Œä»–å¯ä»¥åœ¨ç‰©è”ç½‘åº”ç”¨ç¨‹åºçš„ä»ªè¡¨æ¿ä¸­åœ¨å…¶ç›¸å…³å°éƒ¨ä»¶ä¸­å¯è§†åŒ–æ‰€æœ‰å¤ªé˜³èƒ½è·Ÿè¸ªå™¨æ•°æ®ã€‚å› æ­¤ï¼Œç”¨æˆ·æ‹¥æœ‰ä¸å…‰ä¼é¢æ¿çš„ç¯å¢ƒå’Œæ€§èƒ½ç›¸å…³çš„å¿…è¦æ•°æ®ã€‚</p></li><li><p>æ­¤å¤–ï¼Œåœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼Œä¼ºæœè¿åŠ¨å™¨å°†ä»ä»ªè¡¨æ¿ä¸­çš„ç›¸å…³å°éƒ¨ä»¶ä¸­è·å–è§’åº¦æ–¹å‘ã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥æ§åˆ¶è‡ªå·±çš„ç³»ç»Ÿï¼Œä»¥å¯»æ±‚æœ€ä½³çš„ç¯å¢ƒæ¡ä»¶ï¼Œå¹¶ä»å…‰ä¼é¢æ¿ä¸­æå–æœ€å¤§èƒ½é‡ã€‚ç‰©è”ç½‘åº”ç”¨ç¨‹åºè¿˜è¢«ç¼–ç¨‹ä¸ºåœ¨senorè¾¾åˆ°é¢„å®šé˜ˆå€¼æ—¶å‘é€é€šçŸ¥è­¦æŠ¥ï¼ˆçŸ­ä¿¡æˆ–ç”µå­é‚®ä»¶ï¼‰ã€‚</p></li></ul><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/clip_image002.png" alt="å›¾1. é¡¹ç›®æ€»ä½“è®¾è®¡å›¾ã€‚"></p><p>â€‹                                            </p><h2 id="2-ç¡¬ä»¶è®¾è®¡"><a href="#2-ç¡¬ä»¶è®¾è®¡" class="headerlink" title="2 ç¡¬ä»¶è®¾è®¡"></a>2 ç¡¬ä»¶è®¾è®¡</h2><ul><li>å¦‚å›¾2æ‰€ç¤ºï¼Œç‰©è”ç½‘å¤ªé˜³èƒ½è·Ÿè¸ªç³»ç»Ÿç”±å…‰ä¼ç”µæ± æ¿ã€ä¸¤å°ä¼ºæœç”µæœºã€å››ä¸ªLDRä¼ æ„Ÿå™¨ã€ç”µå‹åˆ†é¢‘å™¨ç”µè·¯ã€æ¸©åº¦å’Œæ¹¿åº¦ä¼ æ„Ÿå™¨ã€Ledå’ŒArduino Mega æ¿ç»„æˆã€‚</li></ul><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/electronic_circuit_of_the_iot-based_solar_tracker_system_9ORL3xysVy.png" alt="å›¾2. åŸºäºç‰©è”ç½‘ï¼ˆIoTï¼‰çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨çš„ç¡¬ä»¶ç”µè·¯å›¾ã€‚"></p><ul><li><p>ä½¿ç”¨çš„å…‰ä¼é¢æ¿å°ºå¯¸ä¸º 115 mm ä¹˜ 85mmï¼Œè¾“å‡ºä¸º 1.6 Wï¼Œå¯äº§ç”Ÿé«˜è¾¾ 6 V çš„ç”µå‹ã€‚ä¸¤ä¸ª180åº¦çš„ä¼ºæœå™¨ç”¨äºä½¿å¤ªé˜³èƒ½è·Ÿè¸ªå™¨ç”µæœºåŒ–ï¼Œå®ƒä»¬ç”±é˜¿å°”æœä¼Šè¯ºæ¿é€šè¿‡PWMå¼•è„š5å’Œ6æ§åˆ¶ã€‚å·¦å³ ï¼ˆL-Rï¼‰ ä¼ºæœç”µæœº ï¼ˆMG996Rï¼‰ åœ¨å‚ç›´è½´ä¸Šï¼ˆä¸œ/è¥¿ï¼‰æ—‹è½¬å¤ªé˜³è·Ÿè¸ªå™¨ï¼Œè€Œä¸Šä¸‹ ï¼ˆU-Dï¼‰ ä¼ºæœç”µæœº ï¼ˆSG90ï¼‰ åœ¨æ°´å¹³è½´ ï¼ˆå—/åŒ—ï¼‰ ä¸Šæ—‹è½¬å¤ªé˜³è·Ÿè¸ªå™¨ã€‚</p></li><li><p>å››ä¸ªLDRï¼ˆCds GL5528ï¼‰ç”¨äºæ„Ÿåº”å¤ªé˜³çš„ä½ç½®ï¼Œè¿™äº›ä½ç½®å·²å›ºå®šåœ¨é¢æ¿çš„å››ä¸ªè§’è½ã€‚LDR ä¼ æ„Ÿå™¨é€šè¿‡ A0 åˆ° A3 çš„æ¨¡æ‹Ÿå¼•è„šè¿æ¥åˆ°é˜¿å°”æœä¼Šè¯ºã€‚LDR æ˜¯ä¸€ç§ç”µé˜»å™¨ï¼Œå…¶å€¼éšç€è¡¨é¢å…‰å¼ºåº¦äº‹ä»¶çš„å¢åŠ è€Œé™ä½ã€‚LDR ä¼ æ„Ÿå™¨è®¾è®¡ä¸ºç”µå‹åˆ†æµå™¨ç”µè·¯ï¼Œå¦‚å›¾ 2 æ‰€è§ã€‚åˆ†é¢‘å™¨è¾“å‡ºç”µå‹ç”± Arduino Mega çš„å¾®æ§åˆ¶å™¨ä»æ¨¡æ‹Ÿå€¼è½¬æ¢ä¸º 0 åˆ° 1023 ä¹‹é—´çš„æ•°å­—å€¼ã€‚å› ä¸ºå¾®æ§åˆ¶å™¨çš„æ¨¡æ‹Ÿæ•°å­—è½¬æ¢å™¨ ï¼ˆADCï¼‰ ç¼–ç ä¸º 10 ä½ã€‚LDR ä¼ æ„Ÿå™¨ç”µè·¯ä¸­çš„ç³»åˆ—ç”µé˜»å™¨å€¼ä¸º 330 Î©ã€‚</p></li><li><p>æ¸©åº¦å’Œæ¹¿åº¦é€šè¿‡ DHT22 ä¼ æ„Ÿå™¨æµ‹é‡ã€‚DHT22 å†…åµŒæœ‰ä¸€ä¸ªçƒ­ç”µå®¹å™¨å’Œç”µå®¹æ¹¿åº¦ä¼ æ„Ÿå™¨ï¼Œå¯æµ‹é‡æ¸©åº¦å’Œç›¸å¯¹æ¹¿åº¦ã€‚å…¶æ¸©åº¦èŒƒå›´ä¸º -40 è‡³ 80 Â°Cï¼Œå‡†ç¡®åº¦ä¸º &lt; Â±0.5Â°Cï¼Œæ¹¿åº¦èŒƒå›´ä¸º 0 è‡³ 100%ï¼ŒÂ±2%ï¼ˆæœ€å¤§Â±5%ï¼‰å‡†ç¡®æ€§ã€‚æ­¤ä¼ æ„Ÿå™¨ä½¿ç”¨ä¸€æ ¹ä¿¡å·çº¿å°†æ•°æ®ä¼ è¾“åˆ° Arduinoï¼ˆæ•°å­—å¼•è„š 2ï¼‰å’Œä¸¤æ ¹ç”¨äºç”µæºçš„ç”µçº¿ã€‚</p></li><li><p>å…‰ä¼ç”µå‹å’Œç”µæµé€šè¿‡ç”µå‹åˆ†éš”ç”µè·¯æµ‹é‡ï¼Œè¯¥åˆ†é¢‘å™¨ä¹Ÿä½œä¸ºè´Ÿè½½ï¼Œç”±ä¸¤ä¸ª 10 Ohms çš„ç³»åˆ—ç”µé˜»å™¨ç»„æˆã€‚åˆ†é¢‘å™¨ç”µè·¯è¾“å‡ºä¸é˜¿å°”æœä¼Šè¯ºçš„æ¨¡æ‹Ÿå¼•è„š A4 ç›¸è¿ã€‚æ­¤å¤–ï¼Œè¿æ¥åˆ°æ•°å­—å¼•è„š 3 çš„ LED åœ¨ç³»ç»Ÿç”µè·¯ä¸­åæ˜ äº†å¤ªé˜³èƒ½è·Ÿè¸ªå™¨ï¼ˆæ‰‹åŠ¨æˆ–è‡ªåŠ¨ï¼‰çš„æ¨¡å¼çŠ¶æ€ã€‚</p></li><li><p>Arduino Mega ä¸ATmega2560 å¾®æ§åˆ¶å™¨ç”¨ä½œåµŒå…¥å¼æ§åˆ¶å™¨ï¼Œä¸é˜¿å°”æœä¼Šè¯ºä»¥å¤ªç½‘å±è”½ä»¥åŠç›‘æ§å¹³å°äº¤äº’ã€‚å®‰è£…åœ¨ Arduino æ¿ä¸Šæ–¹çš„ä»¥å¤ªç½‘é˜²æŠ¤ç½©å¿…é¡»é€šè¿‡å›¾ 3 ä¸­æ˜¾ç¤ºçš„ RJ45 ç”µç¼†ä¸ Wi-Fi è·¯ç”±å™¨ ï¼ˆæˆ– PCï¼‰ è¿æ¥ã€‚ä»¥å¤ªç½‘ç›¾åŸºäº Wiznet W5100 ä»¥å¤ªç½‘èŠ¯ç‰‡ï¼Œè¯¥èŠ¯ç‰‡ä¸º TCP å’Œ UDP åè®®æä¾›äº†ç½‘ç»œ ï¼ˆIPï¼‰ å †æ ˆã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/image2_7PtCrbSgOy.png" alt="å›¾3. arduino å’Œä»¥å¤ªç½‘æ‰©å±•æ¨¡å—ä¹‹é—´çš„ç¡¬ä»¶è¿æ¥å›¾ã€‚"></p></li></ul><h2 id="3-è½¯ä»¶è®¾è®¡"><a href="#3-è½¯ä»¶è®¾è®¡" class="headerlink" title="3 è½¯ä»¶è®¾è®¡"></a>3 è½¯ä»¶è®¾è®¡</h2><h3 id="3-1-Arduino-IDE"><a href="#3-1-Arduino-IDE" class="headerlink" title="3.1 Arduino IDE"></a>3.1 Arduino IDE</h3><p>Arduino æ˜¯ä¸€ä¸ªå¼€æºç”µå­åŸå‹å¹³å°ï¼Œå…·æœ‰æ˜“äºä½¿ç”¨çš„ç¡¬ä»¶å’Œè½¯ä»¶ã€‚Arduino å¹³å°æä¾›é›†æˆå¼€å‘ç¯å¢ƒ ï¼ˆIDEï¼‰ï¼Œå…¶ä¸­åŒ…æ‹¬å¯¹ C å’ŒC++ç¼–ç¨‹è¯­è¨€çš„æ”¯æŒã€‚æœ¬ä½œå“ä¸­ä½¿ç”¨çš„ Arduino æ¿ç”± IDE ç¼–ç¨‹ï¼Œè¯¥ IDE å……å½“ä»£ç ç¼–è¾‘å™¨ï¼Œç¨‹åºä»£ç å¯ä»¥é€šè¿‡ USB ç”µç¼†ä¸Šä¼ åˆ°å¾®æ§åˆ¶å™¨ï¼Œå¦‚å›¾ 3 æ‰€ç¤ºã€‚Arduino å·¨å‹æ¿ç”¨äºå®ç°åŸºäºç‰©è”ç½‘çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨çš„æ‰€æœ‰è½¯ä»¶è¦æ±‚ã€‚</p><h3 id="3-2-myDevices-Cayenne-æˆ‘çš„è®¾å¤‡å¡å®´"><a href="#3-2-myDevices-Cayenne-æˆ‘çš„è®¾å¤‡å¡å®´" class="headerlink" title="3.2 myDevices Cayenne (æˆ‘çš„è®¾å¤‡å¡å®´)"></a>3.2 myDevices Cayenne (æˆ‘çš„è®¾å¤‡å¡å®´)</h3><ul><li>MyDevices æ˜¯ä¸€å®¶æä¾›å®Œç¾çš„ç‰©è”ç½‘è§£å†³æ–¹æ¡ˆçš„å…¬å¸ã€‚å®ƒä¸º IoT æä¾›äº†ç«¯åˆ°ç«¯å¹³å°ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºå¡å®´ï¼Œè¿™æ˜¯æ¥è‡ªæˆ‘çš„è®¾å¤‡çš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚æ­¤å·¥å…·å…è®¸å¼€å‘äººå‘˜ã€è®¾è®¡å¸ˆå’Œå·¥ç¨‹å¸ˆæ„å»ºç‰©æœºåŸå‹ã€‚å¡å®´ä½¿ç”¨æ¶ˆæ¯æ’é˜Ÿç”µä¿¡ä¼ è¾“ ï¼ˆMQTTï¼‰ åè®®å°†ä»»ä½•è®¾å¤‡ä¸å¡å»¶å†…å…‹äº‘è¿æ¥èµ·æ¥ã€‚è¿æ¥åï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡åˆ›å»ºçš„å°éƒ¨ä»¶å°†è®¾å¤‡ä¸­çš„æ•°æ®å‘é€å¹¶æ¥æ”¶åˆ° Cayenne ä»ªè¡¨æ¿ã€‚MQTT æ˜¯åŸºäº TCP/IP åè®®çš„å‘å¸ƒè®¢é˜…æ¶ˆæ¯åè®®ã€‚å‘å¸ƒè®¢é˜…æ–¹æ³•ä½¿ç”¨è´Ÿè´£å‘å®¢æˆ·ç«¯ä¼ é€’æ¶ˆæ¯çš„æ¶ˆæ¯ä»£ç†ã€‚MQTT æ˜¯ç”¨äºå‘å¡å®´äº‘æˆ–å¡å®´æ§åˆ¶çš„è®¾å¤‡å‘é€ä¿¡æ¯çš„ APIã€‚æ­¤è¿æ¥ä¸­çš„æ¶ˆæ¯ä»£ç†æ˜¯äº‘ï¼Œå®ƒç®¡ç†å‘é€å’Œæ¥æ”¶æ•°æ®çš„ä¸åŒå®¢æˆ·ç«¯ï¼ˆä¼ æ„Ÿå™¨å’Œæ‰§è¡Œå™¨ï¼‰ã€‚</li><li>è¦ä½¿ç”¨ MQTT ä¸å¡å®´ï¼Œ æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¡å®´åº“ã€‚å¯¹äºé˜¿å°”æœä¼Šè¯ºï¼Œå¯ä»¥ä» IDE çš„å›¾ä¹¦é¦†ç»ç†å®‰è£…å¡å»¶å†…MQTT åº“ã€‚è¦å¯¹åŸºäº Cayenne ç‰©è”ç½‘å¹³å°çš„ç‰©è”ç½‘åº”ç”¨è¿›è¡Œç¼–ç¨‹ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨é¢„å…ˆå®šä¹‰çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†å»ºç«‹ Cayenne äº‘å’Œé…å¤‡ä»¥å¤ªç½‘æ¨¡å—çš„ Arduino Mega ä¹‹é—´çš„è¿æ¥ï¼Œæˆ‘ä»¬è°ƒç”¨ CayenneMQTT ä»¥å¤ªç½‘åº“ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å£°æ˜æˆ‘ä»¬çš„èº«ä»½éªŒè¯ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç å’Œå®¢æˆ· IDï¼‰ï¼Œè¿™äº›ä¿¡æ¯åº”ä» Cayenne ä»ªè¡¨æ¿è·å¾—ã€‚ç„¶åï¼Œåœ¨ç¨‹åºçš„è®¾ç½®éƒ¨åˆ†ï¼Œæˆ‘ä»¬è°ƒç”¨ <em>Cayenne.å¼€å§‹ ï¼ˆï¼‰</em>åŠŸèƒ½æ¥å»ºç«‹ä¸ Cayenne ä»ªè¡¨æ¿çš„è¿æ¥ã€‚å¯¹äºæ¯ä¸ªæ‰§è¡Œå™¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŠŸèƒ½ï¼Œå…¶æ•´æ•°å‚æ•°åœ¨ 0 åˆ° 31 ä¹‹é—´ï¼Œç§°ä¸º <em>CAYENNE INï¼ˆè™šæ‹Ÿé€šé“ï¼‰ã€‚</em>å¯¹äºæ¯ä¸ªä¼ æ„Ÿå™¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŠŸèƒ½ï¼Œå…¶æ•´æ•°å‚æ•°åœ¨ 0 åˆ° 31 ä¹‹é—´ï¼Œç§°ä¸º<em>CAYENNE_OUT ï¼ˆVIRTUAL_CHANNELï¼‰</em>ã€‚åœ¨ç¨‹åºçš„å¾ªç¯éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç§°ä¸ºé¢„å…ˆå®šä¹‰çš„å‡½æ•° <em>Cayenne.loop ï¼ˆï¼‰ï¼Œ</em>è¯¥å‡½æ•°æœ¬èº«ç§°ä¸ºåŠŸèƒ½<em>CAYENNE_OUT</em>å’Œ<em>CAYENNE_INã€‚</em>è™šæ‹Ÿé€šé“ï¼Œå› ä¸ºå®ƒçš„åç§°å»ºè®®æ˜¯ä¸€ä¸ªé€šé“ï¼Œæ²¡æœ‰ç‰©ç†å­˜åœ¨ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å¯è§†åŒ–æˆ–å‘½ä»¤å°éƒ¨ä»¶ã€‚å®ƒå…è®¸å®ƒä»¬ä¸ç›¸åº”çš„ä¼ æ„Ÿå™¨æˆ–æ‰§è¡Œå™¨è¿æ¥ã€‚</li></ul><h3 id="3-3-The-embedded-software-design-åµŒå…¥å¼è½¯ä»¶è®¾è®¡"><a href="#3-3-The-embedded-software-design-åµŒå…¥å¼è½¯ä»¶è®¾è®¡" class="headerlink" title="3.3 The embedded software design(åµŒå…¥å¼è½¯ä»¶è®¾è®¡)"></a>3.3 The embedded software design(åµŒå…¥å¼è½¯ä»¶è®¾è®¡)</h3><p>åµŒå…¥å¼è½¯ä»¶å°†åµŒå…¥åˆ° Arduino Mega ä¸­ï¼Œä»¥ä¾¿åœ¨ä»¥å¤ªç½‘æ¨¡å—å’Œ Cayenne äº‘ä¹‹é—´è¿›è¡Œäº¤äº’ï¼ˆå‚è§é™„å½•ï¼‰ã€‚å…¶è®¾è®¡å¦‚ä¸‹ï¼š</p><h4 id="1-åŠŸèƒ½æ¨¡å¼"><a href="#1-åŠŸèƒ½æ¨¡å¼" class="headerlink" title="1 åŠŸèƒ½æ¨¡å¼"></a>1 åŠŸèƒ½æ¨¡å¼</h4><ul><li><p>åŸºäºç‰©è”ç½‘çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨å…·æœ‰ä¸¤ç§åŠŸèƒ½æ¨¡å¼ï¼šæ‰‹åŠ¨å’Œè‡ªåŠ¨ã€‚åœ¨ Cayenne ä»ªè¡¨æ¿ä¸­åˆ›å»ºçš„æŒ‰é’®å…·æœ‰åœ¨ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢çš„ä½œç”¨ã€‚éæ´»åŠ¨æ—¶ï¼Œé€‰æ‹©æ‰‹åŠ¨æ¨¡å¼ï¼Œå¦åˆ™è‡ªåŠ¨æ¨¡å¼ã€‚æ­¤å¤–ï¼Œåœ¨ Arduino ä»£ç ä¸­è¿˜å»ºç«‹äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸æ¢å¤æŒ‰é’®çš„çŠ¶æ€ã€‚ç³»ç»Ÿç”µè·¯ä¸­çš„ LED åæ˜ äº†æ­¤å¼€å…³çš„çŠ¶æ€ã€‚</p></li><li><p>å› æ­¤ï¼Œè¦ä½¿æ§åˆ¶å™¨äº†è§£æ‰€é€‰çš„æ“ä½œæ¨¡å¼ï¼Œæˆ‘ä»¬åªéœ€è¦æµ‹è¯• LED è¿æ¥çš„å¼•è„šçŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ LED çŠ¶æ€è¾ƒä½ï¼Œæ§åˆ¶å™¨å°†è°ƒç”¨æ‰‹åŠ¨æ¨¡å¼åŠŸèƒ½æ‰§è¡Œï¼Œå¦åˆ™å°†è°ƒç”¨è‡ªåŠ¨åŠŸèƒ½ã€‚</p></li></ul><h4 id="2-æ‰‹åŠ¨æ¨¡å¼"><a href="#2-æ‰‹åŠ¨æ¨¡å¼" class="headerlink" title="2 æ‰‹åŠ¨æ¨¡å¼"></a>2 æ‰‹åŠ¨æ¨¡å¼</h4><ul><li><p>å¦‚æœé€‰æ‹©æ‰‹åŠ¨æ¨¡å¼ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥æ§åˆ¶ä¼ºæœå™¨çš„ä½ç½®ï¼Œé€šè¿‡ L-R ä¼ºæœå™¨å°†å…‰ä¼æ¿ä»ä¸œå‘è¥¿å®šå‘ï¼Œæˆ–é€šè¿‡ U-D ä¼ºæœå™¨ä»å—å‘åŒ—å®šå‘ã€‚è¯¥æ§åˆ¶ç”±ç‰©è”ç½‘åº”ç”¨ç¨‹åºä»ªè¡¨æ¿ä¸­æœåŠ¡å™¨è¿åŠ¨å™¨çš„ç›¸å…³å°éƒ¨ä»¶ç»„æˆã€‚</p></li><li><p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œæ§åˆ¶å™¨è°ƒç”¨ <strong><em>Cayenne.loopï¼ˆï¼‰</em></strong>åŠŸèƒ½ï¼Œè¯¥å‡½æ•°æœ¬èº«è°ƒç”¨æ‰€æœ‰<strong><em>åŠŸèƒ½CAYENNE_INï¼ˆ</em></strong>åŒ…æ‹¬ä¸ä¼ºæœå™¨ç›¸å…³çš„åŠŸèƒ½ï¼‰æ‰§è¡Œã€‚ <strong>Cayenne.loopï¼ˆï¼‰</strong>åŠŸèƒ½è¿˜å°†è°ƒç”¨ä¸ä¼ æ„Ÿå™¨ç›¸è¿çš„æ‰€æœ‰åŠŸèƒ½CAYENNE_OUTæ‰§è¡Œã€‚å¦‚æœå°†ä¸ LDR ä¼ æ„Ÿå™¨ã€å…‰ä¼ç”µæµã€ç”µå‹å’ŒåŠŸç‡ã€æ¸©åº¦å’Œæ¹¿åº¦ç›¸å…³çš„æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ï¼Œä»¥ä¾¿åœ¨ç‰©è”ç½‘åº”ç”¨ç¨‹åºä¸­çš„ç›¸å…³å°éƒ¨ä»¶ä¸­å¯è§†åŒ–è¿™äº›æ•°æ®ã€‚</p></li></ul><h4 id="3-è‡ªåŠ¨æ¨¡å¼"><a href="#3-è‡ªåŠ¨æ¨¡å¼" class="headerlink" title="3 è‡ªåŠ¨æ¨¡å¼"></a>3 è‡ªåŠ¨æ¨¡å¼</h4><ul><li><p>å¦‚æœé€‰æ‹©è‡ªåŠ¨æ¨¡å¼ï¼Œå°†æ‰§è¡Œå›¾ 4 ä¸­æ˜¾ç¤ºçš„ç®—æ³•ã€‚è¯¥ç®—æ³•é¦–å…ˆé˜…è¯» LDR ä¼ æ„Ÿå™¨è¿”å›çš„æ¨¡æ‹Ÿå€¼ã€‚ç„¶åï¼Œå®ƒä¼šå¤„ç†è¿™äº›æ•°æ®ä»¥å‘½ä»¤å°†å…‰ä¼é¢æ¿ç§»å‘å¤ªé˜³ä½ç½®çš„ä¼ºæœè¿åŠ¨å™¨ã€‚è€ƒè™‘åˆ°åŸºäºå‚ç›´è½´çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨è¿åŠ¨ï¼Œæ¯”è¾ƒäº†å·¦ä¾§ä¸¤ä¸ªLDRå’Œå³ä¾§ä¸¤ä¸ªLDRçš„å¹³å‡å€¼ï¼Œå¦‚æœå·¦ä¾§æ¥æ”¶åˆ°æ›´å¤šçš„å…‰ï¼Œå…‰ä¼ç”µæ± æ¿å°†æœè¿™ä¸ªæ–¹å‘ï¼ˆé¡ºæ—¶é’ˆæ–¹å‘ï¼‰ç©¿è¿‡L-Rä¼ºæœå™¨ã€‚å½“å·®é¢ç»“æœåœ¨ -10 å’Œ 10 ä¹‹é—´æ—¶ï¼Œåè€…å°†åœæ­¢ã€‚æ­¤èŒƒå›´ç”¨äºç¨³å®šæ§åˆ¶å™¨å¹¶é™ä½ä¼ºæœå™¨çš„åŠŸè€—ã€‚å¦åˆ™ï¼Œå¦‚æœæ­£ç¡®çš„LDRé›†æ¥æ”¶æ›´å¤šçš„å…‰ï¼Œå…‰ä¼é¢æ¿å°†æœè¿™ä¸ªæ–¹å‘ç§»åŠ¨ï¼ˆé€†æ—¶é’ˆï¼‰é€šè¿‡L-Rä¼ºæœå™¨ï¼Œå¹¶å°†ç»§ç»­æ—‹è½¬ï¼Œç›´åˆ°å·®å¼‚ç»“æœåœ¨èŒƒå›´å†…[âˆ’10ï¼Œ10]ã€‚åŒä¸€æ–¹æ³•ç”¨äºåŸºäºæ°´å¹³è½´çš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨è¿åŠ¨ï¼Œæ¯”è¾ƒé¡¶éƒ¨ä¸¤ä¸ªLDRå’Œåº•éƒ¨ä¸¤ä¸ªLDRçš„å¹³å‡å€¼ã€‚</p></li><li><p>é™¤äº†åœ¨è‡ªåŠ¨æ¨¡å¼ä¸‹ï¼Œæ§åˆ¶å™¨è¿˜å°†è°ƒç”¨ <strong><em>Cayenne.loopï¼ˆï¼‰</em></strong>åŠŸèƒ½å°†å¤ªé˜³èƒ½è·Ÿè¸ªå™¨æ•°æ®å‘é€åˆ° IoT åº”ç”¨ç¨‹åºã€‚</p></li></ul><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/image_3_pZv5s80gr2.png" alt="å›¾4. å¤ªé˜³èƒ½è·Ÿè¸ªå™¨è‡ªåŠ¨æ¨¡å¼çš„æµç¨‹å›¾ã€‚"></p><h3 id="3-4-Development-of-the-IoT-monitoring-application-å¼€å‘-IoT-ç›‘æ§åº”ç”¨ç¨‹åº"><a href="#3-4-Development-of-the-IoT-monitoring-application-å¼€å‘-IoT-ç›‘æ§åº”ç”¨ç¨‹åº" class="headerlink" title="3.4 Development of the IoT monitoring application(å¼€å‘ IoT ç›‘æ§åº”ç”¨ç¨‹åº)"></a>3.4 Development of the IoT monitoring application(å¼€å‘ IoT ç›‘æ§åº”ç”¨ç¨‹åº)</h3><h4 id="1-ç¡¬ä»¶ä¸å¡å®´-IoT-å¹³å°çš„è¿æ¥"><a href="#1-ç¡¬ä»¶ä¸å¡å®´-IoT-å¹³å°çš„è¿æ¥" class="headerlink" title="1 ç¡¬ä»¶ä¸å¡å®´ IoT å¹³å°çš„è¿æ¥"></a>1 ç¡¬ä»¶ä¸å¡å®´ IoT å¹³å°çš„è¿æ¥</h4><p>è¦å°†ç¡¬ä»¶ï¼ˆåŒ…æ‹¬ä¼ æ„Ÿå™¨å’Œæ‰§è¡Œå™¨ï¼‰ä¸ç‰©è”ç½‘ç»œå¹³å°å¯¹æ¥ï¼Œæˆ‘ä»¬éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li><p>åˆ›å»ºå¸æˆ·åç™»å½•å¡å®´æˆ‘çš„Deviceç½‘ç«™ï¼ˆå›¾5ï¼ˆaï¼‰ï¼‰ã€‚</p></li><li><p>ç„¶åï¼Œå•å‡» Cayenne API ä¸­çš„â€è‡ªå¸¦ä¸œè¥¿â€ï¼ˆå›¾ 5ï¼ˆbï¼‰ï¼‰ã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fig5_jaSC4EBHxI.png" alt="å›¾5. å¡å®´IoTå¹³å°æ³¨å†Œï¼ˆaï¼‰ã€‚å¡å®´APIï¼ˆbï¼‰ã€‚"></p></li><li><p>ä»å…‹é‡Œç‰¹å²›åº”ç”¨ç¨‹åºï¼ˆå›¾6ï¼‰å¤åˆ¶ MQTT å‡­æ®ï¼ˆç”¨æˆ·åã€å¯†ç å’Œå®¢æˆ· IDï¼‰ï¼Œå¹¶å°†å…¶ç²˜è´´åˆ° Arduino æºä»£ç ä¸­ï¼Œå¦‚å‰æ‰€è¿°ã€‚åœ¨æˆåŠŸç¼–è¯‘å¹¶ä¸Šä¼ æ•´ä¸ªä»£ç åˆ° Arduino Mega åï¼Œåœ¨ Arduino IDE ä¸­æ‰“å¼€ä¸²è¡Œç›‘è§†å™¨ä»¥è·å– Cayenne æ—¥å¿—æ‰“å°ï¼ˆå›¾ 7ï¼‰ã€‚ä¸€æ—¦æˆ‘ä»¬çš„è®¾å¤‡ä¸Šçº¿å¹¶è¿æ¥åˆ° Cayenneï¼Œä¸Šä¸€é¡µï¼ˆå›¾ 6ï¼‰å°†è‡ªåŠ¨æ›´æ–°ï¼Œæˆ‘ä»¬å°†åœ¨åœ¨çº¿ä»ªè¡¨æ¿ä¸­çœ‹åˆ°æˆ‘ä»¬çš„è®¾å¤‡ï¼Œå¦‚å›¾ 8 æ‰€è§ã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fig6_qCu0wEtQwz.png" alt="å›¾6. MQTTå‡­æ®å’Œè®¾å¤‡è¿æ¥åˆ°å¡å®´ã€‚"></p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fige_yYB61wSOY4.png" alt="å›¾7. å¡å®´æ—¥å¿—æ‰“å°åœ¨ä¸²è¡Œç›‘è§†å™¨ä¸Šã€‚"></p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fig8_lQi9h5PnKM.png" alt="å›¾8. è®¾å¤‡è®¾ç½®ã€‚"></p></li><li><p>ç„¶åï¼Œè¦æ¥å£ä¼ æ„Ÿå™¨å’Œæ‰§è¡Œå™¨ï¼Œå³åˆ›å»ºå…¶å°éƒ¨ä»¶ï¼Œå•å‡»â€æ·»åŠ æ–°â€¦â€ï¼Œé€‰æ‹©â€è®¾å¤‡/å°éƒ¨ä»¶â€ï¼Œç„¶åå•å‡»â€è‡ªå®šä¹‰å°éƒ¨ä»¶â€ï¼ˆå›¾ 9ï¼‰ã€‚ç„¶åï¼Œé€‰æ‹©å°éƒ¨ä»¶å¹¶å¡«å……ç›¸å…³è®¾ç½®ï¼ˆé€šé“å·å¿…é¡»ä¸ä»£ç ç›¸åŒï¼‰ï¼Œæœ€åå•å‡»â€æ·»åŠ å°éƒ¨ä»¶â€å°†å…¶æ·»åŠ åˆ°è®¾å¤‡çš„ä»ªè¡¨æ¿ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸ºæ‰€æœ‰ä¼ æ„Ÿå™¨é€‰æ‹©äº†â€ä»·å€¼â€å°éƒ¨ä»¶ï¼Œä¸ºæ¨¡å¼åˆ‡æ¢é€‰æ‹©äº†â€æŒ‰é’®â€å°éƒ¨ä»¶ï¼Œä¸ºä¼ºæœå™¨é€‰æ‹©äº†â€æ»‘å—â€å°éƒ¨ä»¶ã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fig9_0KAhjvvj5M.png" alt="å›¾9. å¡å®´è‡ªå®šä¹‰å°éƒ¨ä»¶ã€‚"></p></li></ul><p>æœ€åï¼Œå›¾10è¯´æ˜äº†ç”¨äºç›‘æµ‹å¤ªé˜³èƒ½è·Ÿè¸ªå™¨æ•°æ®çš„è®¾è®¡ç‰©è”ç½‘åº”ç”¨ç¨‹åºã€‚ä¸å¤ªé˜³è·Ÿè¸ªå™¨ç³»ç»Ÿå»ºç«‹è¿æ¥åï¼Œä¼ æ„Ÿå™¨æ•°æ®å¯ä»¥åœ¨å…¶ç›¸å…³éƒ¨ä»¶ä¸Šå¯è§†åŒ–ï¼Œè·Ÿè¸ªæ¨¡å¼ï¼ˆè‡ªåŠ¨æˆ–æ‰‹åŠ¨ï¼‰å¯ä»¥ä»å¼€å…³æŒ‰é’®ä¸­é€‰æ‹©ï¼Œå¹¶é€šè¿‡å°éƒ¨ä»¶æ§åˆ¶ä¼ºæœè€…çš„è§’åº¦ã€‚è¿˜å¯ä»¥é€šè¿‡ä¿®æ”¹å…¶è®¾ç½®ä¸­çš„è¡¨ç¤ºç±»å‹æˆ–å•å‡»å°éƒ¨ä»¶ä¸Šæ–¹çš„å›¾å½¢å›¾æ ‡ä»¥å›¾å½¢å½¢å¼è·å–ä¼ æ„Ÿå™¨æ•°æ®ã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fig10_Om7yhhrJcO.png" alt="å›¾10. å¤ªé˜³èƒ½è·Ÿè¸ªç³»ç»Ÿçš„IoTç›‘æ§åº”ç”¨ã€‚"></p><h4 id="2-è­¦æŠ¥åˆ›å»º"><a href="#2-è­¦æŠ¥åˆ›å»º" class="headerlink" title="2 è­¦æŠ¥åˆ›å»º"></a>2 è­¦æŠ¥åˆ›å»º</h4><p>ç›‘æ§ç³»ç»Ÿä¸­æœ€é‡è¦çš„æ ‡å‡†ä¹‹ä¸€æ˜¯ï¼Œå½“å‘ç”Ÿä¸å…¶ç›‘æ§è®¾å¤‡ç›¸å…³çš„äº‹ä»¶æ—¶ï¼Œå®ƒèƒ½å¤Ÿå‘é€é€šçŸ¥è­¦æŠ¥é€šçŸ¥ç”¨æˆ·ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ©ç”¨ Cayenne çš„ä¸€ä¸ªåŠŸèƒ½ä¸ºæˆ‘ä»¬çš„ç‰©è”ç½‘åº”ç”¨ç¨‹åºæ·»åŠ è­¦æŠ¥ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆç¼–ç¨‹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»¥å‘é€é€šçŸ¥è­¦æŠ¥ï¼ˆçŸ­ä¿¡ã€ç”µå­é‚®ä»¶æˆ–ä¸¤è€…å…¼æœ‰ï¼‰æˆ–æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºæ¸©åº¦è­¦æŠ¥ï¼Œä»¥ä¾¿åœ¨ç›‘æ§æ¸©åº¦è¾¾åˆ°é˜ˆå€¼æ—¶å‘ç”¨æˆ·ï¼ˆæˆ–æ”¶ä»¶äººï¼‰å‘é€ç”µå­é‚®ä»¶é€šçŸ¥ï¼Œå¦‚å›¾ 11 æ‰€ç¤ºã€‚è¦åˆ›å»ºè­¦æŠ¥ï¼Œè¯·å•å‡»â€æ·»åŠ æ–°ã€‚â€ç„¶åé€‰æ‹©â€è§¦å‘â€ï¼Œç„¶åè®¾ç½®äº‹ä»¶åŠå…¶æ“ä½œï¼Œæœ€åå•å‡»â€ä¿å­˜â€å°†å…¶æ·»åŠ åˆ°ä»ªè¡¨æ¿ã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/fig11_HcTpIiwQOI.png" alt="å›¾11. æ¸©åº¦è­¦æŠ¥è®¾ç½®ã€‚"></p><h2 id="4-åŸå‹è®¾è®¡"><a href="#4-åŸå‹è®¾è®¡" class="headerlink" title="4 åŸå‹è®¾è®¡"></a>4 åŸå‹è®¾è®¡</h2><p>å›¾12å±•ç¤ºäº†å¤ªé˜³èƒ½è·Ÿè¸ªå™¨åŸå‹åœ¨å…¶åˆ†ç¦»å’Œç»„è£…çŠ¶æ€ã€‚å®ƒç”±å…‰ä¼é¢æ¿ã€R å’Œ U-D ä¼ºæœå™¨å’Œ LDR ä¼ æ„Ÿå™¨ç»„æˆã€‚è¯¥é¢æ¿ä¸€ä¾§è¿æ¥åˆ° U-Dservomotorï¼Œå¦ä¸€ä¾§æœ‰è½´æ‰¿ï¼Œä»¥ç¡®ä¿å½“å¤ªé˜³èƒ½è·Ÿè¸ªå™¨å›´ç»•æ°´å¹³è½´æ—‹è½¬æ—¶æ›´å¥½çš„çµæ´»æ€§ã€‚è£…é…è¿æ¥åˆ° L-R ä¼ºæœå™¨ã€‚LDR ä¼ æ„Ÿå™¨å›ºå®šåœ¨ç©ºå¿ƒæ°”ç¼¸å†…é¢æ¿çš„å››ä¸ªè§’è½ã€‚å¦‚æœé¢æ¿ä¸å‚ç›´äºå¤ªé˜³ï¼Œåˆ™è‡³å°‘æœ‰ä¸€ä¸ª LDR å°†è¢«å‘¨å›´åœ†æŸ±ä½“é€ æˆçš„é˜´å½±è¦†ç›–ã€‚å› æ­¤ï¼Œå…‰å¼ºåº¦ä¼šæœ‰å·®å¼‚ã€‚æœ€ä½³æ–¹å‘æ˜¯å½“å…‰çš„ç‰¹æ€§åœ¨æ‰€æœ‰LDRä¼ æ„Ÿå™¨ä¸­æ˜¯ç›¸ç­‰çš„ã€‚å›¾13æ˜¾ç¤ºäº†åŸºäº IoT çš„å¤ªé˜³èƒ½è·Ÿè¸ªç³»ç»Ÿçš„æ•´ä¸ªåŸå‹ï¼Œå¾ˆæ˜æ˜¾ï¼Œç¡¬ä»¶éƒ¨åˆ†ä¸­çš„æ‰€æœ‰æŠ¥å‘Šç»„ä»¶éƒ½å·²ç”¨äºæ„å»ºå®ƒã€‚</p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/solar_tracker_prototype_in_its_detached_and_assembled_state_zbScjRgUaK.png" alt="å›¾12. å¤ªé˜³èƒ½è·Ÿè¸ªå™¨åŸå‹å¤„äºç»„è£…å’Œåˆ†ç¦»çŠ¶æ€"></p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/iot_based_solar_tracker_prototype__PG9L9gMmwr.png" alt="å›¾13. åŸºäºIOTçš„å¤ªé˜³èƒ½è·Ÿè¸ªå™¨åŸå‹"></p><p>æœ‰å…³æ‰€è·ç»“æœçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æœ¬é“¾æ¥ä¸­çš„è®ºæ–‡ï¼š <a href="https://link.springer.com/chapter/10.1007%2F978-3-030-64565-6_4">https://link.springer.com/chapter/10.1007%2F978-3-030-64565-6_4</a></p><h2 id="5-ä»£ç "><a href="#5-ä»£ç " class="headerlink" title="5 ä»£ç "></a>5 ä»£ç </h2><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/***************************************************************</span><span class="hljs-comment"> PROJECT: IoT based solar tracker system / the embedded software</span><span class="hljs-comment"> Aboubakr El Hammoumi/ aboubakr.elhammoumi@usmba.ac.ma</span><span class="hljs-comment">***************************************************************/</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CAYENNE_PRINT Serial</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;CayenneMQTTEthernet.h&gt;</span>    <span class="hljs-comment">//CayenneMQTT library </span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Servo.h&gt;</span>                  <span class="hljs-comment">//Servo motor library </span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;DHT.h&gt;</span>                    <span class="hljs-comment">//DHT library </span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DHTTYPE DHT22</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DHTPIN 2</span><span class="hljs-function">DHT <span class="hljs-title">dht</span><span class="hljs-params">(DHTPIN,DHTTYPE)</span></span>;<span class="hljs-comment">//MQTT credentials   </span><span class="hljs-keyword">char</span> username[]=<span class="hljs-string">&quot;498d2d00-afe2-11ea-883c-638d8ce4c23d&quot;</span>;<span class="hljs-keyword">char</span> password[]=<span class="hljs-string">&quot;ab4a8f92d94033c01f6e18ce1d8a84d8c304c9c4&quot;</span>;<span class="hljs-keyword">char</span> clientID[]=<span class="hljs-string">&quot;17798a40-b968-11ea-93bf-d33a96695544&quot;</span>;Servo servo_x;                   <span class="hljs-comment">//up-down servomotor  </span><span class="hljs-keyword">int</span> servoh = <span class="hljs-number">0</span>;<span class="hljs-keyword">int</span> servohLimitHigh = <span class="hljs-number">170</span>;     <span class="hljs-keyword">int</span> servohLimitLow = <span class="hljs-number">10</span>;       Servo servo_z;                   <span class="hljs-comment">//left-right servomotor </span><span class="hljs-keyword">int</span> servov = <span class="hljs-number">0</span>; <span class="hljs-keyword">int</span> servovLimitHigh = <span class="hljs-number">170</span>;<span class="hljs-keyword">int</span> servovLimitLow = <span class="hljs-number">10</span>;<span class="hljs-keyword">int</span> topl,topr,botl,botr;<span class="hljs-keyword">int</span> threshold_value=<span class="hljs-number">10</span>;        <span class="hljs-keyword">float</span> Vout;<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123; Serial.begin(<span class="hljs-number">9600</span>);  Cayenne.begin(username, password, clientID);  servo_x.attach(<span class="hljs-number">5</span>);  servo_z.attach(<span class="hljs-number">6</span>);  dht.begin();  pinMode(<span class="hljs-number">3</span>,OUTPUT);  digitalWrite(<span class="hljs-number">3</span>,LOW); &#125;<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123; topr= analogRead(A2);         topl= analogRead(A3);           botl= analogRead(A4);           botr= analogRead(A5);          Vout=(analogRead(A1) * <span class="hljs-number">5.0</span>) / <span class="hljs-number">1023</span>;  Serial.println(<span class="hljs-string">&quot; Manual-mode&quot;</span>);  Cayenne.loop();    <span class="hljs-keyword">if</span> (digitalRead(<span class="hljs-number">3</span>)==HIGH)&#123;    Serial.println(<span class="hljs-string">&quot; Automatic-mode&quot;</span>);    servoh = servo_x.read();    servov = servo_z.read();    <span class="hljs-keyword">int</span> avgtop = (topr + topl) / <span class="hljs-number">2</span>;         <span class="hljs-keyword">int</span> avgbot = (botr + botl) / <span class="hljs-number">2</span>;       <span class="hljs-keyword">int</span> avgright = (topr + botr) / <span class="hljs-number">2</span>;       <span class="hljs-keyword">int</span> avgleft = (topl + botl) / <span class="hljs-number">2</span>;        <span class="hljs-keyword">int</span> diffhori= avgtop - avgbot;          <span class="hljs-keyword">int</span> diffverti= avgleft - avgright;            <span class="hljs-comment">/*tracking according to horizontal axis*/</span>     <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(diffhori) &lt;= threshold_value)    &#123;     servo_x.write(servoh);            <span class="hljs-comment">//stop the servo up-down</span>    &#125;<span class="hljs-keyword">else</span> &#123;       <span class="hljs-keyword">if</span> (diffhori &gt; threshold_value)          &#123; Serial.println(<span class="hljs-string">&quot; x - 2 &quot;</span>);          servo_x.write(servoh <span class="hljs-number">-2</span>);    <span class="hljs-comment">//Clockwise rotation CW</span>          <span class="hljs-keyword">if</span> (servoh &gt; servohLimitHigh)          &#123;           servoh = servohLimitHigh;          &#125;          delay(<span class="hljs-number">10</span>);          &#125;<span class="hljs-keyword">else</span> &#123;           servo_x.write(servoh +<span class="hljs-number">2</span>);   <span class="hljs-comment">//CCW</span>           <span class="hljs-keyword">if</span> (servoh &lt; servohLimitLow)           &#123;           servoh = servohLimitLow;           &#125;           delay(<span class="hljs-number">10</span>);           &#125;      &#125;          <span class="hljs-comment">/*tracking according to vertical axis*/</span>     <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(diffverti) &lt;= threshold_value)    &#123;          servo_z.write(servov);       <span class="hljs-comment">//stop the servo left-right</span>    &#125;<span class="hljs-keyword">else</span>&#123;       <span class="hljs-keyword">if</span> (diffverti &gt; threshold_value)       &#123;        servo_z.write(servov <span class="hljs-number">-2</span>);  <span class="hljs-comment">//CW</span>       <span class="hljs-keyword">if</span> (servov &gt; servovLimitHigh)        &#123;        servov = servovLimitHigh;       &#125;       delay(<span class="hljs-number">10</span>);       &#125;<span class="hljs-keyword">else</span>&#123;         servo_z.write(servov +<span class="hljs-number">2</span>);  <span class="hljs-comment">//CCW</span>        <span class="hljs-keyword">if</span> (servov &lt; servovLimitLow)         &#123;        servov = servovLimitLow;        &#125;        delay(<span class="hljs-number">10</span>);        &#125;     &#125;  &#125;&#125;<span class="hljs-comment">// Cayenne Functions</span>CAYENNE_IN(<span class="hljs-number">8</span>)&#123;  <span class="hljs-keyword">int</span> value = getValue.asInt();  CAYENNE_LOG(<span class="hljs-string">&quot;Channel %d, pin %d, value %d&quot;</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, value);  digitalWrite(<span class="hljs-number">3</span>,value);&#125;CAYENNE_IN(<span class="hljs-number">7</span>)&#123; <span class="hljs-comment">//up-down servo motor</span>  <span class="hljs-keyword">if</span> (digitalRead(<span class="hljs-number">3</span>)==HIGH)&#123; <span class="hljs-comment">//Automatic_mode</span>  &#125;  <span class="hljs-keyword">else</span>&#123; <span class="hljs-comment">//Manual_mode</span>  servo_x.write(getValue.asDouble() * <span class="hljs-number">180</span>);  &#125;&#125;CAYENNE_IN(<span class="hljs-number">6</span>)&#123; <span class="hljs-comment">//left-right servo motor</span>  <span class="hljs-keyword">if</span> (digitalRead(<span class="hljs-number">3</span>)==HIGH)&#123;  &#125;    <span class="hljs-keyword">else</span>&#123;  servo_z.write(getValue.asDouble() * <span class="hljs-number">180</span>);  &#125;&#125;CAYENNE_OUT(<span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//Current</span>  <span class="hljs-keyword">float</span> current = Vout/<span class="hljs-number">10</span>;  Cayenne.virtualWrite(<span class="hljs-number">0</span>, current);  Serial.print(<span class="hljs-string">&quot;Current: &quot;</span>);  Serial.println(current);&#125;CAYENNE_OUT(<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">//Voltage</span>  <span class="hljs-keyword">float</span> voltage = Vout * <span class="hljs-number">2</span>;  Cayenne.virtualWrite(<span class="hljs-number">1</span>, voltage);  Serial.print(<span class="hljs-string">&quot;Voltage: &quot;</span>);  Serial.println(voltage);&#125;CAYENNE_OUT(<span class="hljs-number">2</span>)&#123; <span class="hljs-comment">//LDR Top-right</span>  Cayenne.virtualWrite(<span class="hljs-number">2</span>, topr);&#125;CAYENNE_OUT(<span class="hljs-number">3</span>)&#123; <span class="hljs-comment">//LDR Top-left</span>  Cayenne.virtualWrite(<span class="hljs-number">3</span>,topl);&#125;CAYENNE_OUT(<span class="hljs-number">4</span>)&#123; <span class="hljs-comment">//LDR Bot-left</span>  Cayenne.virtualWrite(<span class="hljs-number">4</span>,botl);&#125;CAYENNE_OUT(<span class="hljs-number">5</span>)&#123; <span class="hljs-comment">//LDR Bot-right</span>  Cayenne.virtualWrite(<span class="hljs-number">5</span>,botr);&#125;CAYENNE_OUT(<span class="hljs-number">10</span>) &#123; <span class="hljs-comment">//Power</span>  <span class="hljs-keyword">float</span> power = (Vout * <span class="hljs-number">2</span> * Vout)/<span class="hljs-number">10</span> ;  Cayenne.virtualWrite(<span class="hljs-number">10</span>, power);  Serial.print(<span class="hljs-string">&quot;Power: &quot;</span>);  Serial.println(power);&#125;CAYENNE_OUT(<span class="hljs-number">11</span>)&#123; <span class="hljs-comment">//Temperature</span>  <span class="hljs-keyword">float</span> t = dht.readTemperature();  <span class="hljs-comment">//int chk = dht.read(DHT11PIN);</span>  Cayenne.virtualWrite(<span class="hljs-number">11</span>, t, TYPE_TEMPERATURE, UNIT_CELSIUS);  Serial.print(<span class="hljs-string">&quot;temperature: &quot;</span>);  Serial.println(t);&#125;CAYENNE_OUT(<span class="hljs-number">12</span>)&#123; <span class="hljs-comment">//Huidity</span>  <span class="hljs-keyword">float</span> h = dht.readHumidity();  <span class="hljs-comment">//int chk = dht.read(DHT11PIN);</span>  Cayenne.virtualWrite(<span class="hljs-number">12</span>, h);  Serial.print(<span class="hljs-string">&quot;  humidity: &quot;</span>);  Serial.println(h);&#125;</code></pre></div><h2 id="6-å‘å±•ç¤ºä¾‹"><a href="#6-å‘å±•ç¤ºä¾‹" class="headerlink" title="6 å‘å±•ç¤ºä¾‹"></a>6 å‘å±•ç¤ºä¾‹</h2><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/img_3581_XDaDENY3ax.JPG" alt="å¤ªé˜³èƒ½ç”µæ± æ¿å¤ªé˜³è·Ÿè¸ªå™¨ - æ‰‹æœºå……ç”µå™¨"></p><p><img src="/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/image-20210607020629991.png" alt="å·¨å‹å¤ªé˜³èƒ½è·Ÿè¸ªå™¨"></p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Hardware/">Hardware</category>
      
      
      <category domain="https://pncalbl.github.io/tags/IoT/">IoT</category>
      
      <category domain="https://pncalbl.github.io/tags/%E5%A4%AA%E9%98%B3%E8%83%BD/">å¤ªé˜³èƒ½</category>
      
      
      <comments>https://pncalbl.github.io/2021/06/08/%E5%9F%BA%E4%BA%8E%E7%89%A9%E8%81%94%E7%BD%91(IoT)%E7%9A%84%E5%A4%AA%E9%98%B3%E8%83%BD%E8%B7%9F%E8%B8%AA%E5%99%A8/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>ElasticSearch å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/</link>
      <guid>https://pncalbl.github.io/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/</guid>
      <pubDate>Mon, 24 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;ElasticSearch-å­¦ä¹ &quot;&gt;&lt;a href=&quot;#ElasticSearch-å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;ElasticSearch å­¦ä¹ &quot;&gt;&lt;/a&gt;ElasticSearch å­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;0-èŠèŠDougC</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="ElasticSearch-å­¦ä¹ "><a href="#ElasticSearch-å­¦ä¹ " class="headerlink" title="ElasticSearch å­¦ä¹ "></a>ElasticSearch å­¦ä¹ </h1><h2 id="0-èŠèŠDougCutting"><a href="#0-èŠèŠDougCutting" class="headerlink" title="0 èŠèŠDougCutting"></a>0 èŠèŠDougCutting</h2><p>ä¸ºä»€ä¹ˆè¦è®²è¿™ä¸ªäºº,åé¢è¦èŠå¤§æ•°æ®</p><blockquote><p>  æœ¬æ•…äº‹å†…å®¹æ¥è‡ªå…¬ä¼—å·ï¼šæ–°æ£è¯¾å ‚</p></blockquote><p>1998å¹´9æœˆ4å·,googleå…¬å¸åœ¨ç¾å›½ç¡…è°·æˆç«‹.æ­£å¦‚å¤§å®¶æ‰€çŸ¥,å®ƒæ˜¯ä¸€å®¶æœç´¢å¼•æ“èµ·å®¶çš„å…¬å¸</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610550313.png" alt></p><p>æ— ç‹¬æœ‰å¶,ä¸€ä½åå«DougCuttingçš„ç¾å›½å·¥ç¨‹å¸ˆ,ä¹Ÿè¿·ä¸Šäº†æœç´¢å¼•æ“.ä»–åšäº†ä¸€ä¸ªç”¨äºæ–‡æœ¬æœç´¢çš„å‡½æ•°åº“(å§‘ä¸”ç†è§£ä¸ºè½¯ä»¶çš„åŠŸèƒ½ç»„ä»¶),å‘½åä¸ºLucene.</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610568104.png" alt></p><p>Luceneä½¿ç”¨Javaå†™çš„,ç›®æ ‡æ˜¯ä¸ºå„ç§ä¸­å°å‹åº”ç”¨è½¯ä»¶åŠ å…¥å…¨æ–‡æ£€ç´¢åŠŸèƒ½.å› ä¸ºå¥½ç”¨è€Œä¸”å¼€æº(ä»£ç å…¬å¼€),éå¸¸å—ç¨‹åºå‘˜ä»¬ç¨€ç½•)</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­,googleç¡®å®æ‰¾åˆ°äº†ä¸å°‘å¥½çš„åŠæ³•,å¹¶ä¸”æ— ç§åœ°åˆ†äº«äº†å‡ºæ¥.</p><p>å¼€æºæ˜¯ä¸€ç§ç²¾ç¥!</p><p>2003å¹´,googleå‘è¡¨äº†ä¸€ç¯‡æŠ€æœ¯å­¦æœ¯è®ºæ–‡,å…¬å¼€ä»‹ç»äº†è‡ªå·±çš„è°·æ­Œæ–‡ä»¶ç³»ç»ŸGFS(google File System).è¿™æ˜¯googleå…¬å¸ä¸ºäº†å­˜å‚¨æµ·é‡æœç´ æ•°æ®è€Œè®¾è®¡çš„ä¸“ç”¨æ–‡ä»¶ç³»ç»Ÿ</p><p>ç¬¬äºŒå¹´,2004å¹´,Doug CuttingåŸºäºgoogleçš„GFSè®ºæ–‡,å®ç°äº†åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ,å¹¶å°†å®ƒå‘½åä¸ºNDFS(Nutch Distributed File System)</p><p>è¿˜æ˜¯2004å¹´,googleåˆå‘è¡¨äº†ä¸€ç¯‡æŠ€æœ¯å­¦æœ¯è®ºæ–‡,ä»‹ç»è‡ªå·±çš„MapReduceç¼–ç¨‹æ¨¡å‹.è¿™ä¸ªç¼–ç¨‹æ¨¡å‹,ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†(å¤§äº1TB)çš„å¹¶è¡Œåˆ†æè¿ç®—.</p><p>2005å¹´,Doug Cutting åˆåŸºäºMapReduce,åœ¨Nutchæœç´¢å¼•æ“å®ç°äº†è¯¥åŠŸèƒ½.</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610581999.png" alt></p><p>2006å¹´,å½“æ—¶ä¾ç„¶å¾ˆå‰å®³çš„Yahoo(é›…è™)å…¬å¸,æ‹›å®‰äº†Doug Cutting</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610607769.png" alt></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610720399.png" alt></p><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹è¯´.</p><p>è¿˜æ˜¯2006å¹´,googleæœ‰å‘è¡¨è®ºæ–‡äº†</p><p>è¿™æ¬¡,ä»–ä»¬ä»‹ç»è‡ªå·±çš„BigTable,è¿™æ˜¯ä¸€ç§åˆ†å¸ƒå¼çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿ,ä¸€ç§ç”¨æ¥å¤„ç†æµ·é‡æ•°æ®çš„éå…³ç³»å‹æ•°æ®åº“.</p><p>Doug Cutting å½“ç„¶æ²¡æœ‰æ”¾è¿‡,åœ¨è‡ªå·±çš„hadoopç³»ç»Ÿé‡Œé¢,å¼•å…¥äº†BigTable,å¹¶å‘½åä¸ºHBase.</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610829469.png" alt></p><p>å¥½å§,åæ­£å°±æ˜¯ç´§è·ŸGoogleæ—¶ä»£æ­¥ä¼,ä½ å‡ºä»€ä¹ˆ,æˆ‘å­¦ä»€ä¹ˆ</p><p>æ‰€æœ‰,Hadoopçš„æ ¸å¿ƒéƒ¨åˆ†,åŸºæœ¬ä¸Šéƒ½æœ‰Googleçš„å½±å­.</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596610891867.png" alt></p><p>2008å¹´1æœˆ,HadoopæˆåŠŸä¸Šä½,æˆä¸ºApacheåŸºé‡‘ä¼šçš„é¡¶çº§é¡¹ç›®.</p><p>åŒå¹´2æœˆ,Yahooå®£å¸ƒå»ºæˆäº†ä¸€ä¸ªæ‹¥æœ‰1Wä¸ªå†…æ ¸çš„Hadoopé›†ç¾¤,å¹¶å°†è‡ªå·±çš„æœç´¢å¼•æ“äº§å“éƒ¨ç½²åœ¨ä¸Šé¢.</p><p>7æœˆ,Hadoopæ‰“ç ´ä¸–ç•Œçºªå½•,æˆä¸ºæœ€å¿«æ’åº1TBæ•°æ®çš„ç³»ç»Ÿ,ç”¨æ—¶209ç§’.</p><h2 id="1-ä»€ä¹ˆæ˜¯Elasticsearchï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯Elasticsearchï¼Ÿ" class="headerlink" title="1 ä»€ä¹ˆæ˜¯Elasticsearchï¼Ÿ"></a>1 ä»€ä¹ˆæ˜¯Elasticsearchï¼Ÿ</h2><h3 id="1-1-Luceneç®€ä»‹"><a href="#1-1-Luceneç®€ä»‹" class="headerlink" title="1.1 Luceneç®€ä»‹"></a>1.1 Luceneç®€ä»‹</h3><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/lucene_logo_green_300.png" alt="Lucene Logo"></p><ul><li>Luceneæ˜¯ä¸€å¥—ç”¨äº<strong>å…¨æ–‡æ£€ç´¢</strong>å’Œ<strong>æœå¯»</strong>çš„<strong>å¼€æº</strong>ç¨‹åºåº“ï¼Œç”±Apacheè½¯ä»¶åŸºé‡‘ä¼šæ”¯æŒå’Œæä¾›</li><li>Luceneæä¾›äº†ä¸€ä¸ªç®€å•å´å¼ºå¤§çš„åº”ç”¨ç¨‹åºæ¥å£ï¼ˆAPIï¼‰ï¼Œèƒ½å¤Ÿåšå…¨æ–‡ç´¢å¼•å’Œæœå¯»ï¼Œåœ¨Javaå¼€å‘ç¯å¢ƒé‡ŒLuceneæ˜¯ä¸€ä¸ªæˆç†Ÿçš„å…è´¹å¼€æ”¾æºä»£ç å·¥å…·</li><li>Luceneå¹¶ä¸æ˜¯ç°æˆçš„æœç´¢å¼•æ“äº§å“ï¼Œä½†å¯ä»¥ç”¨æ¥åˆ¶ä½œæœç´¢å¼•æ“äº§å“</li><li>Luceneæ˜¯ä¸€å¥—ä¿¡æ¯æ£€ç´¢å·¥å…·åŒ…! jaråŒ…!ä¸åŒ…å«æœç´¢å¼•æ“ç³»ç»Ÿ!<ul><li>LuceneåŒ…å«:ç´¢å¼•ç»“æ„!è¯»å†™ç´¢å¼•çš„å·¥å…·!æ’åº,æœç´¢è§„åˆ™â€¦å·¥å…·ç±»!ç­‰</li></ul></li><li><strong>Luceneå’ŒElasticSearchå…³ç³»</strong>:<ul><li>ç®€å•æ¥è¯´ï¼ŒElasticSearchæ˜¯åŸºäºLuceneåšäº†ä¸€äº›<strong>å°è£…</strong>å’Œ*<em>å¢å¼º *</em></li></ul></li></ul><h3 id="1-2-ElasticSearchç®€ä»‹"><a href="#1-2-ElasticSearchç®€ä»‹" class="headerlink" title="1.2 ElasticSearchç®€ä»‹"></a>1.2 ElasticSearchç®€ä»‹</h3><ul><li><p>ElasticSearchæ˜¯ä¸€ä¸ª<strong>å®æ—¶åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“</strong>ã€‚å®ƒè®©ä½ ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å¤„ç†å¤§æ•°æ®æˆä¸ºå¯èƒ½ã€‚</p></li><li><p>å®ƒç”¨äº<strong>å…¨æ–‡æœç´¢ã€ç»“æ„åŒ–æœç´¢ã€åˆ†æ</strong>ä»¥åŠå°†è¿™ä¸‰è€…æ··åˆä½¿ç”¨:</p><ul><li>ç»´åŸºç™¾ç§‘ä½¿ç”¨Elasticsearchæä¾›<strong>å…¨æ–‡æœç´¢å¹¶é«˜äº®å…³é”®å­—</strong> ,ä»¥åŠ<strong>è¾“å…¥å®æ—¶æœç´¢(search-asyou-type)</strong>å’Œ<strong>æœç´¢çº é”™(did-you-mean)</strong>ç­‰æœç´¢å»ºè®®åŠŸèƒ½ã€‚</li><li>è‹±å›½å«æŠ¥ä½¿ç”¨Elasticsearchç»“åˆç”¨æˆ·æ—¥å¿—å’Œç¤¾äº¤ç½‘ç»œæ•°æ®æä¾›ç»™ä»–ä»¬çš„ç¼–è¾‘ä»¥<strong>å®æ—¶çš„åé¦ˆ</strong>,ä»¥ä¾¿åŠæ—¶äº†è§£å…¬ä¼—å¯¹æ–°å‘è¡¨çš„æ–‡ç« çš„å›åº”ã€‚</li><li>StackOverflowç»“åˆ<strong>å…¨æ–‡æœç´¢</strong>ä¸<strong>åœ°ç†ä½ç½®æŸ¥è¯¢</strong>,ä»¥åŠmore-like-thisåŠŸèƒ½æ¥æ‰¾åˆ°ç›¸å…³çš„é—®é¢˜å’Œç­”æ¡ˆã€‚</li><li>Githubä½¿ç”¨Elasticsearchæ£€ç´¢<strong>1300äº¿</strong>è¡Œçš„ä»£ç ã€‚</li></ul></li><li><p>å¹¶ä¸”Elasticsearchä¸ä»…ç”¨äºå¤§å‹ä¼ä¸š,å®ƒè¿˜è®©åƒDataDogä»¥åŠKloutè¿™æ ·çš„åˆ›ä¸šå…¬å¸å°†æœ€åˆçš„æƒ³æ³•å˜æˆå¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆã€‚</p></li><li><p>Elasticsearchå¯ä»¥åœ¨ä½ çš„ç¬”è®°æœ¬ã€‚ä¸Šè¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨æ•°ä»¥ç™¾è®¡çš„æœåŠ¡å™¨ä¸Š<strong>å¤„ç†PBçº§åˆ«çš„æ•°æ®</strong>ã€‚</p></li><li><p>Elasticsearchæ˜¯ä¸€ä¸ªåŸºäºApache Lucene(TM)çš„å¼€æºæœç´¢å¼•æ“ã€‚ æ— è®ºåœ¨å¼€æºè¿˜æ˜¯ä¸“æœ‰é¢†åŸŸ, Luceneå¯ä»¥è¢«è®¤ä¸ºæ˜¯è¿„ä»Šä¸ºæ­¢æœ€å…ˆè¿›ã€æ€§èƒ½æœ€å¥½çš„ã€åŠŸèƒ½æœ€å…¨çš„æœç´¢å¼•æ“åº“ã€‚</p></li><li><p>ä½†æ˜¯, Luceneåªæ˜¯ä¸€ä¸ªåº“ã€‚æƒ³è¦ä½¿ç”¨å®ƒ,ä½ å¿…é¡»ä½¿ç”¨Javaæ¥ä½œä¸ºå¼€å‘è¯­è¨€å¹¶å°†å…¶ç›´æ¥é›†æˆåˆ°ä½ çš„åº”ç”¨ä¸­,æ›´ç³Ÿç³•çš„æ˜¯, Luceneéå¸¸å¤æ‚,ä½ éœ€è¦æ·±å…¥äº†è§£æ£€ç´¢çš„ç›¸å…³çŸ¥è¯†æ¥ç†è§£å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p></li><li><p>Elasticsearchä¹Ÿä½¿ç”¨<strong>Java</strong>å¼€å‘å¹¶ä½¿ç”¨Luceneä½œä¸ºå…¶æ ¸å¿ƒæ¥å®ç°æ‰€æœ‰ç´¢å¼•å’Œæœç´¢çš„åŠŸèƒ½,å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ç®€å•çš„<strong>RESTful API</strong>ï¼ˆRESTé£æ ¼çš„ç½‘ç»œæ¥å£ï¼Œæ˜¯å½“ä¸‹ä¸»æµçš„APIï¼‰æ¥éšè—Luceneçš„å¤æ‚æ€§,ä»è€Œè®©å…¨æ–‡æœç´¢å˜å¾—ç®€å•ã€‚</p></li></ul><h3 id="1-3-ElasticSearchçš„åº”ç”¨åœºæ™¯"><a href="#1-3-ElasticSearchçš„åº”ç”¨åœºæ™¯" class="headerlink" title="1.3 ElasticSearchçš„åº”ç”¨åœºæ™¯"></a>1.3 ElasticSearchçš„åº”ç”¨åœºæ™¯</h3><ul><li><p>ç»´åŸºç™¾ç§‘,ç±»ä¼¼ç™¾åº¦ç™¾ç§‘,<strong>å…¨æ–‡æ£€ç´¢</strong>,<strong>é«˜äº®</strong>,<strong>æœç´¢æ¨è</strong></p></li><li><p>The Guardian (å›½å¤–æ–°é—»ç½‘ç«™) , ç±»ä¼¼æœç‹æ–°é—»,ç”¨æˆ·è¡Œä¸ºæ—¥å¿—(ç‚¹å‡»,æµè§ˆ,æ”¶è—,è¯„è®º) +ç¤¾äº¤ç½‘ç»œæ•°æ®(å¯¹æŸæŸæ–°é—»çš„ç›¸å…³çœ‹æ³•) ,æ•°æ®åˆ†æ,ç»™åˆ°æ¯ç¯‡æ–°é—»æ–‡ç« çš„ä½œè€…,è®©ä»–çŸ¥é“ä»–çš„æ–‡ç« çš„å…¬ä¼—åé¦ˆ</p></li><li><p>Stack Overflow (å›½å¤–çš„ç¨‹åºå¼‚å¸¸è®¨è®ºè®ºå›) , ITé—®é¢˜,ç¨‹åºçš„æŠ¥é”™, æäº¤ä¸Šå»,æœ‰äººä¼šè·Ÿä½ è®¨è®ºå’Œå›ç­”,å…¨æ–‡æ£€ç´¢,æœç´¢ç›¸å…³é—®é¢˜å’Œç­”æ¡ˆ,ç¨‹åºæŠ¥é”™äº†,å°±ä¼šå°†æŠ¥é”™ä¿¡æ¯ç²˜è´´åˆ°é‡Œé¢å»,æœç´¢æœ‰æ²¡æœ‰å¯¹åº”çš„ç­”æ¡ˆ</p></li><li><p>GitHub (å¼€æºä»£ç ç®¡ç†)</p></li><li><p>ç”µå•†ç½‘ç«™,<strong>æ£€ç´¢å•†å“</strong>.</p></li><li><p>æ—¥å¿—æ•°æ®åˆ†æ, logstashé‡‡é›†æ—¥å¿—, ESè¿›è¡Œå¤æ‚çš„æ•°æ®åˆ†æ, <strong>ELKæŠ€æœ¯, elasticsearchï¼ˆæœç´¢ï¼‰+logstashï¼ˆè¿‡æ»¤ï¼‰+kibanaï¼ˆå¯è§†åŒ–åˆ†æï¼‰</strong></p></li><li><p>å•†å“ä»·æ ¼ç›‘æ§ç½‘ç«™,ç”¨æˆ·è®¾å®šæŸå•†å“çš„ä»·æ ¼é˜ˆå€¼,å½“ä½äºè¯¥é˜ˆå€¼çš„æ—¶å€™,å‘é€é€šçŸ¥æ¶ˆæ¯ç»™ç”¨æˆ·,æ¯”å¦‚è¯´è®¢é˜…ç‰™è†çš„ç›‘æ§ï¼šå¦‚æœé«˜éœ²æ´ç‰™è†çš„å®¶åº­å¥—è£…ä½äº50å—é’±,å°±é€šçŸ¥æˆ‘,æˆ‘å°±å»ä¹°</p></li><li><p>BIç³»ç»Ÿ ,å•†ä¸šæ™ºèƒ½, Business Intelligence.æ¯”å¦‚è¯´æœ‰ä¸ªå¤§å‹å•†åœºé›†å›¢, BIåˆ†æä¸€ä¸‹æŸæŸåŒºåŸŸæœ€è¿‘3å¹´çš„ç”¨æˆ·æ¶ˆè´¹é‡‘é¢çš„è¶‹åŠ¿ä»¥åŠç”¨æˆ·ç¾¤ä½“çš„ç»„æˆæ„æˆ,äº§å‡ºç›¸å…³çš„æ•°å¼ æŠ¥è¡¨, æœ€è¿‘3å¹´,æ¯å¹´æ¶ˆè´¹é‡‘é¢å‘ˆç°100%çš„å¢é•¿,è€Œä¸”ç”¨æˆ·ç¾¤ä½“85%æ˜¯é«˜çº§ç™½é¢†ã€‚</p></li><li><p>å›½å†…:<strong>ç«™å†…æœç´¢</strong>(ç”µå•†ï¼Œæ‹›è˜ï¼Œé—¨æˆ·ï¼Œç­‰ç­‰)ï¼Œ<strong>ITç³»ç»Ÿæœç´¢</strong>(OA,CRM,ERPï¼Œç­‰ç­‰)ï¼Œ<strong>æ•°æ®åˆ†æ</strong>(ESçƒ­é—¨çš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯)</p></li></ul><p>æ€»è€Œè¨€ä¹‹ï¼ŒElasticsearchå°±æ˜¯æä¾›<strong>é«˜æ•ˆ</strong>ã€<strong>ä¸ªæ€§åŒ–æ£€ç´¢</strong>éœ€æ±‚çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ</p><h3 id="1-4-ELKç®€ä»‹"><a href="#1-4-ELKç®€ä»‹" class="headerlink" title="1.4 ELKç®€ä»‹"></a>1.4 ELKç®€ä»‹</h3><ul><li><p>ELKæ˜¯<strong>Elasticsearchã€Logstashã€Kibana</strong>ä¸‰å¤§å¼€æºæ¡†æ¶é¦–å­—æ¯å¤§å†™ç®€ç§°ã€‚å¸‚é¢ä¸Šä¹Ÿè¢«æˆä¸ºElastic Stackã€‚</p><ul><li>å…¶ä¸­ElasticSearchæ˜¯ä¸€ä¸ªåŸºäºLuceneã€åˆ†å¸ƒå¼ã€é€šè¿‡Restfulæ–¹å¼è¿›è¡Œäº¤äº’çš„è¿‘å®æ—¶æœç´¢å¹³å°æ¡†æ¶ã€‚åƒç±»ä¼¼ç™¾åº¦ã€è°·æ­Œè¿™ç§å¤§æ•°æ®å…¨æ–‡æœç´¢å¼•æ“çš„åœºæ™¯éƒ½å¯ä»¥ä½¿ç”¨Elasticsearchä½œä¸ºåº•å±‚æ”¯æŒæ¡†æ¶,å¯è§Elasticsearchæä¾›çš„æœç´¢èƒ½åŠ›ç¡®å®å¼ºå¤§,å¸‚é¢ä¸Šå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ç®€ç§°Elasticsearchä¸ºes.</li><li>Logstashæ˜¯ELKçš„<strong>ä¸­å¤®æ•°æ®æµå¼•æ“</strong>,ç”¨äº<strong>ä»ä¸åŒç›®æ ‡</strong>(æ–‡ä»¶/æ•°æ®å­˜å‚¨/MQ )<strong>æ”¶é›†çš„ä¸åŒæ ¼å¼æ•°æ®</strong>,ç»è¿‡è¿‡æ»¤åæ”¯æŒè¾“å‡ºä»¥åˆ°ä¸åŒç›®çš„åœ°(æ–‡ä»¶/MQ/redis/elasticsearch/kafkaç­‰)ã€‚</li><li>Kibanaå¯ä»¥å°†esçš„<strong>æ•°æ®</strong>é€šè¿‡å‹å¥½çš„é¡µé¢<strong>å±•ç¤º</strong>å‡ºæ¥ ,æä¾›å®æ—¶åˆ†æçš„åŠŸèƒ½ã€‚</li></ul></li><li><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š<strong>æ”¶é›†æ¸…æ´—æ•°æ®â€“&gt;å»ºç«‹ç´¢å¼•ï¼Œå‚¨å­˜â€“&gt;Kibanaåˆ†æ</strong></p></li><li><p>å¸‚é¢ä¸Šå¾ˆå¤šå¼€å‘åªè¦æåˆ°ELKèƒ½å¤Ÿä¸€è‡´è¯´å‡ºå®ƒæ˜¯ä¸€ ä¸ªæ—¥å¿—åˆ†ææ¶æ„æŠ€æœ¯æ ˆæ€»ç§°,ä½†å®é™…ä¸ŠELKä¸ä»…ä»…é€‚ç”¨äºæ—¥å¿—åˆ†æ,å®ƒè¿˜å¯ä»¥<strong>æ”¯æŒå…¶å®ƒä»»ä½•æ•°æ®åˆ†æå’Œæ”¶é›†çš„åœºæ™¯</strong>,æ—¥å¿—åˆ†æå’Œæ”¶é›†åªæ˜¯æ›´å…·æœ‰ä»£è¡¨æ€§ï¼Œå¹¶éå”¯ä¸€æ€§ã€‚</p></li></ul><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105031.png" alt></p><h2 id="2-å…¶ä»–æœç´¢å¼•æ“"><a href="#2-å…¶ä»–æœç´¢å¼•æ“" class="headerlink" title="2 å…¶ä»–æœç´¢å¼•æ“"></a>2 å…¶ä»–æœç´¢å¼•æ“</h2><h3 id="2-1-Solrç®€ä»‹"><a href="#2-1-Solrç®€ä»‹" class="headerlink" title="2.1 Solrç®€ä»‹"></a>2.1 Solrç®€ä»‹</h3><ul><li><p>Solræ˜¯Apacheä¸‹çš„ä¸€ä¸ªé¡¶çº§å¼€æºé¡¹ç›®,é‡‡ç”¨javaå¼€å‘,å®ƒæ˜¯åŸºäºLuceneçš„å…¨æ–‡æœç´¢æœåŠ¡å™¨ã€‚Solræä¾›äº†æ¯”Luceneæ›´ä¸ºä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€,åŒæ—¶å®ç°äº†å¯é…ç½®ã€å¯æ‰©å±•ï¼Œå¹¶å¯¹ç´¢å¼•ã€æœç´¢æ€§èƒ½è¿›è¡Œäº†ä¼˜åŒ–</p></li><li><p>Solrå¯ä»¥ç‹¬ç«‹è¿è¡Œåœ¨Jettyã€Tomcatç­‰è¿™äº›Servletå®¹å™¨ä¸­ , Solrç´¢å¼•çš„å®ç°æ–¹æ³•å¾ˆç®€å•,ç”¨POSTæ–¹æ³•å‘SolræœåŠ¡å™¨å‘é€ä¸€ä¸ªæè¿°FieldåŠå…¶å†…å®¹çš„XMLæ–‡æ¡£ï¼ŒSolræ ¹æ®xmlæ–‡æ¡£æ·»åŠ ã€åˆ é™¤ã€æ›´æ–°ç´¢å¼•ã€‚</p></li><li><p>åˆ—å¦‚ï¼šæœç´¢name==dayceng&lt;&gt;</p><ul><li>Solr æœç´¢åªéœ€è¦å‘é€HTTP GETè¯·æ±‚,ç„¶åå¯¹Solrè¿”å›xmlã€<strong>json</strong>ç­‰æ ¼å¼çš„æŸ¥è¯¢ç»“æœè¿›è¡Œè§£æ,ç»„ç»‡é¡µé¢å¸ƒå±€ã€‚Solrä¸æä¾›æ„å»ºUIçš„åŠŸèƒ½, Solræä¾›äº†ä¸€ä¸ªç®¡ç†ç•Œé¢,é€šè¿‡ç®¡ç†ç•Œé¢å¯ä»¥æŸ¥è¯¢Solrçš„é…ç½®å’Œè¿è¡Œæƒ…å†µã€‚</li></ul></li><li><p>solræ˜¯åŸºäºluceneå¼€å‘ä¼ä¸šçº§æœç´¢æœåŠ¡å™¨,å®é™…ä¸Šå°±æ˜¯å°è£…äº†lucene.</p></li><li><p>Solræ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä¼ä¸šçº§æœç´¢åº”ç”¨æœåŠ¡å™¨,å®ƒå¯¹å¤–æä¾›ç±»ä¼¼äºWeb-serviceçš„APIæ¥å£ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡httpè¯·æ±‚,å‘æœç´¢å¼•æ“æœåŠ¡å™¨æäº¤ä¸€å®šæ ¼å¼çš„æ–‡ä»¶,ç”Ÿæˆç´¢å¼•;ä¹Ÿå¯ä»¥é€šè¿‡æå‡ºæŸ¥æ‰¾è¯·æ±‚,å¹¶å¾—åˆ°è¿”å›ç»“æœã€‚</p></li></ul><h3 id="2-2-ESä¸Solrå¯¹æ¯”"><a href="#2-2-ESä¸Solrå¯¹æ¯”" class="headerlink" title="2.2 ESä¸Solrå¯¹æ¯”"></a>2.2 ESä¸Solrå¯¹æ¯”</h3><ul><li><p>å•çº¯åœ°å¯¹å·²æœ‰çš„æ•°æ®è¿›è¡Œæœç´¢ï¼ŒSolræ›´å¿«</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105035.png" alt></p></li><li><p>å½“å»ºç«‹<strong>å®æ—¶ç´¢å¼•</strong>æ—¶ï¼ŒSolrä¼šäº§ç”ŸIOé˜»å¡ï¼ŒæŸ¥è¯¢æ€§èƒ½è¾ƒå·®ï¼Œæ­¤æ—¶ESå…·æœ‰æ˜æ˜¾ä¼˜åŠ¿</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105045.png" alt></p></li><li><p>éšç€æœç´¢é‡çš„å¢åŠ ï¼ŒSolrçš„åŠ£åŠ¿æ„ˆå‘æ˜æ˜¾ï¼ŒESæ— æ˜æ˜¾å˜åŒ–</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105121.png" alt></p></li><li><p><strong>æ€»ç»“</strong></p><ul><li>ESåŸºæœ¬æ˜¯å¼€ç®±å³ç”¨ï¼Œéå¸¸ç®€å•ã€‚Solrå®‰è£…ç•¥å¾®å¤æ‚</li><li>Solr åˆ©ç”¨Zookeeperè¿›è¡Œåˆ†å¸ƒå¼ç®¡ç†ï¼Œè€ŒElasticsearch è‡ªèº«å¸¦æœ‰åˆ†å¸ƒå¼åè°ƒç®¡ç†åŠŸèƒ½ã€‚</li><li>Solr æ”¯æŒæ›´å¤šæ ¼å¼çš„æ•°æ®ï¼Œæ¯”å¦‚JSONã€XMLã€ CSV ï¼Œè€ŒElasticsearchä»…æ”¯æŒJSONæ–‡ä»¶æ ¼å¼ã€‚</li><li>Solr å®˜æ–¹æä¾›çš„åŠŸèƒ½æ›´å¤šï¼Œè€ŒElasticsearchæœ¬èº«æ›´æ³¨é‡äºæ ¸å¿ƒåŠŸèƒ½ï¼Œé«˜çº§åŠŸèƒ½å¤šæœ‰ç¬¬ä¸‰æ–¹æ’ä»¶æä¾›ï¼Œä¾‹å¦‚å›¾å½¢åŒ–ç•Œé¢éœ€è¦kibanaå‹å¥½æ”¯æ’‘</li><li>Solr æŸ¥è¯¢å¿«ï¼Œä½†æ›´æ–°ç´¢å¼•æ—¶æ…¢(å³æ’å…¥åˆ é™¤æ…¢) ï¼Œç”¨äºç”µå•†ç­‰æŸ¥è¯¢å¤šçš„åº”ç”¨;<ul><li>ESå»ºç«‹ç´¢å¼•å¿«(å³æŸ¥è¯¢æ…¢) ï¼Œå³<strong>å®æ—¶æ€§æŸ¥è¯¢å¿«</strong>ï¼Œç”¨äºfacebookæ–°æµªç­‰æœç´¢ã€‚</li><li>Solræ˜¯ä¼ ç»Ÿæœç´¢åº”ç”¨çš„æœ‰åŠ›è§£å†³æ–¹æ¡ˆï¼Œä½†Elasticsearch æ›´é€‚ç”¨äºæ–°å…´çš„å®æ—¶æœç´¢åº”ç”¨ã€‚</li></ul></li><li>Solræ¯”è¾ƒæˆç†Ÿï¼Œæœ‰ä¸€ä¸ªæ›´å¤§ï¼Œæ›´æˆç†Ÿçš„ç”¨æˆ·ã€å¼€å‘å’Œè´¡çŒ®è€…ç¤¾åŒº,è€ŒElasticsearchç›¸å¯¹å¼€å‘ç»´æŠ¤è€…è¾ƒå°‘ï¼Œæ›´æ–°å¤ªå¿«,<strong>å­¦ä¹ ä½¿ç”¨æˆæœ¬è¾ƒé«˜</strong></li></ul></li></ul><h2 id="3-Elasticsearchå®‰è£…"><a href="#3-Elasticsearchå®‰è£…" class="headerlink" title="3 Elasticsearchå®‰è£…"></a>3 Elasticsearchå®‰è£…</h2><p>æ³¨æ„ï¼šjavaç‰ˆæœ¬è‡³å°‘ä¸ºJDK1.8æˆ–ä»¥ä¸Š</p><p>Javaå¼€å‘,elasticsearchçš„ç‰ˆæœ¬å’Œæˆ‘ä»¬ä¹‹åå¯¹åº”çš„Javaçš„æ ¸å¿ƒjaråŒ…! ç‰ˆæœ¬å¯¹åº”! JDKç¯å¢ƒæ˜¯æ­£å¸¸çš„</p><p>è¿™é‡Œä¸€å®šè¦ä¿è¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/1596614089583.png" alt></p><h3 id="3-1-å®‰è£…"><a href="#3-1-å®‰è£…" class="headerlink" title="3.1 å®‰è£…"></a>3.1 å®‰è£…</h3><p>ä¸‹è½½ï¼š<a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p><p>windowsä¸‹è§£å‹å³å¯ä½¿ç”¨</p><h3 id="3-2-Elasticsearchç›®å½•ä»‹ç»"><a href="#3-2-Elasticsearchç›®å½•ä»‹ç»" class="headerlink" title="3.2 Elasticsearchç›®å½•ä»‹ç»"></a>3.2 Elasticsearchç›®å½•ä»‹ç»</h3><ul><li>bin ç›¸å…³å¯åŠ¨æ–‡ä»¶</li><li>config é…ç½®æ–‡ä»¶</li><li>log4j2.properties æ—¥å¿—é…ç½®æ–‡ä»¶</li><li>jvm.options javaè™šæ‹Ÿæœºé…ç½®æ–‡ä»¶</li><li>elasticsearch.yml ESé…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤ç«¯å£ï¼š9200ï¼Œè¿™é‡Œåœ¨tpotä¸­ï¼Œdockeré»˜è®¤åˆ†é…çš„æ˜¯1111ï¼Œéœ€è¦å†æ˜ å°„åˆ°9200æ‰è¡Œï¼‰</li><li>lib ç›¸å…³jaråŒ…</li><li>logs æ—¥å¿—</li><li>modules åŠŸèƒ½æ¨¡å—</li><li>plugins æ’ä»¶</li></ul><h3 id="3-3-å¯åŠ¨"><a href="#3-3-å¯åŠ¨" class="headerlink" title="3.3 å¯åŠ¨"></a>3.3 å¯åŠ¨</h3><p>åŒå‡»binä¸‹çš„<strong>elasticsearch.bat</strong>å³å¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105122.png" alt></p><h3 id="3-4-æµ‹è¯•è®¿é—®"><a href="#3-4-æµ‹è¯•è®¿é—®" class="headerlink" title="3.4 æµ‹è¯•è®¿é—®"></a>3.4 æµ‹è¯•è®¿é—®</h3><p>è®¿é—®å…¶æš´éœ²çš„ç«¯å£è¿›è¡ŒéªŒè¯ï¼ˆ<a href="http://127.0.0.1:9200/ï¼‰">http://127.0.0.1:9200/ï¼‰</a></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105123.png" alt></p><h3 id="3-5-å®‰è£…å¯è§†åŒ–ç•Œé¢Elasticsearch-head"><a href="#3-5-å®‰è£…å¯è§†åŒ–ç•Œé¢Elasticsearch-head" class="headerlink" title="3.5 å®‰è£…å¯è§†åŒ–ç•Œé¢Elasticsearch-head"></a>3.5 å®‰è£…å¯è§†åŒ–ç•Œé¢Elasticsearch-head</h3><p>1ã€è¯·ä¸‹è½½Node.jsï¼ˆ<a href="https://nodejs.org/en/ï¼‰ï¼Œå¹¶æ£€æŸ¥npmä¸ºè¾ƒæ–°çš„ç‰ˆæœ¬">https://nodejs.org/en/ï¼‰ï¼Œå¹¶æ£€æŸ¥npmä¸ºè¾ƒæ–°çš„ç‰ˆæœ¬</a></p><p>2ã€å®‰è£…npmæ·˜å®é•œåƒæºï¼ˆcnpmï¼‰</p><blockquote><p>  npm install -g cnpm <em>â€“registry=<a href="https://registry.npm.taobao.org">https://registry.npm.taobao.org</a></em></p></blockquote><p> æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</p><blockquote><p>  cnpm -v</p></blockquote><p> å‡ºç°ä»¥ä¸‹ä¿¡æ¯å³å¯</p><blockquote><p>  C:\Users\XXXX&gt; cnpm -v</p><p>  <a href="mailto:cnpm@5.1.1">cnpm@5.1.1</a> (F:\Live\NODE\node_global\node_modules\cnpm\lib\parse_argv.js)<br>  <a href="mailto:npm@5.6.0">npm@5.6.0</a> (F:\Live\NODE\node_global\node_modules\cnpm\node_modules\npm\lib\npm.js)<br>  <a href="mailto:node@8.9.1">node@8.9.1</a> (F:\Live\NODE\node.exe)<br>  <a href="mailto:npminstall@3.2.1">npminstall@3.2.1</a> (F:\Live\NODE\node_global\node_modules\cnpm\node_modules\npminstall\lib\index.js)<br>  prefix=F:\Live\NODE\node_global<br>  win32 x64 10.0.16299<br>  registry=<a href="http://registry.npm.taobao.org">http://registry.npm.taobao.org</a></p></blockquote><p><strong>åœ¨ElasticSearch\elasticsearch-head-masterå³ES headç›®å½•ä¸‹</strong></p><p> <strong>ä¸‹è½½ä¾èµ–</strong></p><blockquote><p>  cnpm install</p></blockquote><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105124.png" alt="image-20210131091020099"></p><p> <strong>è¿è¡Œ</strong></p><blockquote><p>  npm run start</p></blockquote><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/image-20210609005919167.png" alt></p><p> <strong>è®¿é—®<a href="http://localhost:9100/">http://localhost:9100/</a></strong></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105126.png" alt="image-20210131091312021"></p><p> <strong>æ­¤æ—¶å› ä¸ºè·¨åŸŸè®¿é—®ï¼ˆè·¨ç«¯å£ï¼‰å¯¼è‡´é›†ç¾¤æ— æ³•è¿æ¥ï¼Œè¦é€šè¿‡é…ç½®elasticsearch.ymlæ¥è§£å†³</strong></p><h3 id="3-6-è§£å†³è·¨åŸŸé—®é¢˜"><a href="#3-6-è§£å†³è·¨åŸŸé—®é¢˜" class="headerlink" title="3.6 è§£å†³è·¨åŸŸé—®é¢˜"></a>3.6 è§£å†³è·¨åŸŸé—®é¢˜</h3><p>é…ç½®esï¼Œæ‰“å¼€elasticsearch.ymlæ–‡ä»¶ï¼Œåœ¨æœ€åä¸€è¡ŒåŠ å…¥ï¼ˆæ³¨æ„yalmè¯­æ³•ï¼Œå†’å·åè¦åŠ ä¸€ä¸ªç©ºæ ¼ï¼‰</p><blockquote><p>  http.cors.enabled: true<br>  http.cors.allow-origin: â€œ*â€</p></blockquote><p>ä½¿ç”¨elasticsearch.baté‡å¯esï¼Œè¿æ¥æˆåŠŸ</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105127.png" alt="image-20210131092227531"></p><p>æ³¨1ï¼šLinuxä¸‹å¯èƒ½ä¼šå› ä¸ºè¿›ç¨‹é—®é¢˜å¯åŠ¨å¤±è´¥</p><p><em>#æŸ¥çœ‹elasticçš„è¿›ç¨‹å· å¹¶æ€æ­»</em></p><div class="code-wrapper"><pre><code class="hljs perl">ps aux | <span class="hljs-keyword">grep</span> elasticsearch <span class="hljs-keyword">kill</span> -<span class="hljs-number">9</span> è¿›ç¨‹å·</code></pre></div><p><em>#é‡å¯ -d åå°è¿è¡Œ</em></p><div class="code-wrapper"><pre><code class="hljs awk">.<span class="hljs-regexp">/bin/</span>elasticsearch -d</code></pre></div><p>æ³¨2ï¼šLinuxä¸‹esheadå¯åŠ¨å¤±è´¥ï¼Œæç¤º9100ç«¯å£å ç”¨</p><p><em>#æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹id</em></p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">lsof</span> -i:<span class="hljs-number">9100</span></code></pre></div><p><em>#æ€æ­»è¿›è¡Œ</em></p><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">kill</span> -<span class="hljs-number">9</span> <span class="hljs-number">4852</span></code></pre></div><h2 id="4-Kibanaå®‰è£…"><a href="#4-Kibanaå®‰è£…" class="headerlink" title="4 Kibanaå®‰è£…"></a>4 Kibanaå®‰è£…</h2><p>Kibanaæ˜¯ä¸€ä¸ªé’ˆå¯¹Elasticsearchçš„å¼€æºåˆ†æåŠå¯è§†åŒ–å¹³å° ï¼Œç”¨æ¥æœç´¢ã€æŸ¥çœ‹äº¤äº’å­˜å‚¨åœ¨Elasticsearchç´¢å¼•ä¸­çš„æ•°æ®ã€‚ ä½¿ç”¨Kibanaï¼Œå¯ä»¥é€šè¿‡å„ç§å›¾è¡¨è¿›è¡Œé«˜çº§æ•°æ®åˆ†æåŠå±•ç¤ºã€‚Kibanaè®©æµ·é‡æ•°æ®æ›´å®¹æ˜“ç†è§£ã€‚å®ƒæ“ä½œç®€å•ï¼ŒåŸºäºæµè§ˆå™¨çš„ç”¨æˆ·ç•Œé¢å¯ä»¥å¿«é€Ÿåˆ›å»ºä»ªè¡¨æ¿( dashboard )å®æ—¶æ˜¾ç¤ºElasticsearchæŸ¥è¯¢åŠ¨æ€ã€‚è®¾ç½®Kibanaéå¸¸ç®€å•ã€‚æ— éœ€ç¼–ç æˆ–è€…é¢å¤–çš„åŸºç¡€æ¶æ„ï¼Œå‡ åˆ†é’Ÿå†…å°±å¯ä»¥å®ŒæˆKibanaå®‰è£…å¹¶å¯åŠ¨Elasticsearchç´¢å¼•ç›‘æµ‹ã€‚</p><p>å®˜ç½‘ï¼š<a href="https://www.elastic.co/cn/kibana">https://www.elastic.co/cn/kibana</a></p><p>æ³¨æ„ï¼š<strong>ä½¿ç”¨çš„ESç‰ˆæœ¬è¦ä¸Kibanaçš„å¯¹åº”</strong></p><p>ä¸‹è½½å®Œæˆè§£å‹ï¼ŒåŒå‡»kibana.batå¯åŠ¨å³å¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105128.png" alt="image-20210131103309389"></p><p><strong>æ±‰åŒ–</strong></p><p>åœ¨Kibanaç›®å½•ä¸‹çš„configä¸­ä¿®æ”¹Kibana.ymlæ–‡ä»¶ï¼Œæœ€åä¸€è¡ŒåŠ ä¸Š</p><blockquote><p>  i18n.locale: â€œzh-CNâ€</p></blockquote><p>é‡å¯å³å¯</p><h2 id="5-ESæ ¸å¿ƒæ¦‚å¿µ"><a href="#5-ESæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="5 ESæ ¸å¿ƒæ¦‚å¿µ"></a>5 ESæ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="5-1-æ¦‚è¿°"><a href="#5-1-æ¦‚è¿°" class="headerlink" title="5.1 æ¦‚è¿°"></a>5.1 æ¦‚è¿°</h3><p>Elasticsearchæ˜¯é¢å‘æ–‡æ¡£çš„ä¸€ç§æ•°æ®åº“ï¼Œè¿™æ„å‘³ç€å…¶ä¸å†éœ€è¦è¡Œåˆ—å¼çš„è¡¨æ ¼å­—æ®µçº¦æŸã€‚</p><p>ESä¼šå­˜å‚¨æ•´ä¸ªæ„é€ å¥½çš„æ•°æ®æˆ–æ–‡æ¡£ï¼Œç„¶è€Œä¸ä»…ä»…æ˜¯å‚¨å­˜æ•°æ®ï¼Œè¿™ä½¿å¾—æ–‡æ¡£ä¸­æ¯ä¸ªæ•°æ®å¯ä»¥è¢«æ ‡è¯†ï¼Œè¿›è€Œå¯ä»¥è¢«æ£€ç´¢ã€‚åœ¨ESä¸­ï¼Œæ‰§è¡Œindexï¼Œsearchï¼Œsortæˆ–è¿‡æ»¤æ–‡æ¡£ç­‰æ“ä½œéƒ½ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„è¡Œåˆ—å¼çš„æ•°æ®ã€‚</p><p>ESä»æ ¹æœ¬ä¸Šå¯¹æ•°æ®çš„ä¸åŒæ€è€ƒæ–¹å¼ä¹Ÿæ­£æ˜¯ä»–èƒ½åº”å¯¹å¤æ‚æ•°æ®ç»“æ„çš„å…¨æ–‡æ£€ç´¢çš„åŸå› ä¹‹ä¸€ã€‚</p><p><strong>å…³ç³»å‹æ•°æ®åº“ä¸Elasticsearchçš„å¯¹æ¯”</strong></p><p>ä»¥ä¸‹æ•°æ®æ ¼å¼å‡ä¸ºJSON</p><table><thead><tr><th>Relational DB</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>æ•°æ®åº“ï¼ˆdatabaseï¼‰</td><td>ç´¢å¼•ï¼ˆindexï¼‰</td></tr><tr><td>è¡¨ï¼ˆtablesï¼‰</td><td>ç±»å‹ï¼ˆtypesï¼Œæ–°ç‰ˆæœ¬ä¸­é€æ­¥å¼ƒç”¨ï¼‰</td></tr><tr><td>è¡Œï¼ˆrowsï¼‰</td><td>æ–‡æ¡£ï¼ˆdocumentsï¼‰</td></tr><tr><td>å­—æ®µï¼ˆcolumnsï¼‰</td><td>å­—æ®µï¼ˆfileï¼‰</td></tr></tbody></table><p>Elasticsearch(ä¸€èˆ¬ä¸ºé›†ç¾¤)ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç´¢å¼•ï¼ˆå¯¹åº”æ•°æ®åº“) ï¼Œæ¯ä¸ªç´¢å¼•ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç±»å‹(å¯¹åº”è¡¨) ï¼Œæ¯ä¸ªç±»å‹ä¸‹åˆåŒ…å«å¤šä¸ªæ–‡æ¡£(å¯¹åº”è¡Œ)ï¼Œæ¯ä¸ªæ–‡æ¡£ä¸­åˆåŒ…å«å¤šä¸ªå­—æ®µ(å¯¹åº”åˆ—)ã€‚</p><p><strong>ç‰©ç†è®¾è®¡</strong>:<br>Elasticsearchåœ¨åå°<strong>æŠŠæ¯ä¸ªç´¢å¼•åˆ’åˆ†æˆå¤šä¸ªåˆ†ç‰‡</strong>,æ¯åˆ†åˆ†ç‰‡å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä¸åŒæœåŠ¡å™¨é—´è¿ç§»ï¼ˆæ–¹ä¾¿é›†ç¾¤çš„æ­å»ºï¼‰</p><p>å®é™…ä¸Šåªå»ºç«‹ä¸€ä¸ªç´¢å¼•å®ƒè‡ªå·±ä¹Ÿæ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œé»˜è®¤åç§°å°±æ˜¯elasticsearch</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105129.png" alt="image-20210202093954072"></p><p><strong>é€»è¾‘è®¾è®¡:</strong><br>ä¸€ä¸ªç´¢å¼•ç±»å‹ä¸­ï¼ŒåŒ…å«å¤šä¸ªæ–‡æ¡£ï¼Œå¦‚æ–‡æ¡£1 ,æ–‡æ¡£2ã€‚</p><p>å½“æˆ‘ä»¬ç´¢å¼•ä¸€ç¯‡æ–‡æ¡£æ—¶ï¼Œå¯ä»¥é€šè¿‡è¿™æ ·çš„ä¸€ä¸ªé¡ºåºæ‰¾åˆ°å®ƒ:</p><p> ç´¢å¼•â€“&gt;ç±»å‹â€“&gt;æ–‡æ¡£ID</p><p>é€šè¿‡è¿™ä¸ªç»„åˆæˆ‘ä»¬å°±èƒ½ç´¢å¼•åˆ°æŸä¸ªå…·ä½“çš„æ–‡æ¡£ã€‚</p><p>ï¼ˆæ³¨:IDä¸å¿…æ˜¯æ•´æ•°,å®é™…ä¸Šå®ƒæ˜¯ä¸ªå­—ç¬¦ä¸²ã€‚ï¼‰</p><h3 id="5-2-æ–‡æ¡£"><a href="#5-2-æ–‡æ¡£" class="headerlink" title="5.2 æ–‡æ¡£"></a>5.2 æ–‡æ¡£</h3><p>Elasticsearchæ˜¯é¢å‘æ–‡æ¡£çš„,é‚£ä¹ˆå°±æ„å‘³ç€ç´¢å¼•å’Œæœç´¢æ•°æ®çš„<strong>æœ€å°å•ä½æ˜¯æ–‡æ¡£</strong>, Elasticsearchä¸­,æ–‡æ¡£æœ‰å‡ ä¸ªé‡è¦å±æ€§:</p><ul><li><p>è‡ªæˆ‘åŒ…å«ï¼Œä¸€ç¯‡æ–‡æ¡£åŒæ—¶åŒ…å«å­—æ®µå’Œå¯¹åº”çš„å€¼,ä¹Ÿå°±æ˜¯åŒæ—¶åŒ…å«key:value</p></li><li><p>å¯ä»¥æ˜¯å±‚æ¬¡å‹çš„ï¼Œä¸€ä¸ªæ–‡æ¡£ä¸­åŒ…å«ç€æ–‡æ¡£ï¼Œå¤æ‚çš„é€»è¾‘å®ä½“å°±æ˜¯è¿™ä¹ˆæ¥çš„ï¼ˆå³æ–‡æ¡£å°±æ˜¯JSONæ ¼å¼çš„å¯¹è±¡ï¼Œå¯ç”¨fastjsonè¿›è¡Œè‡ªåŠ¨è½¬æ¢è‡ªåŠ¨ï¼‰</p></li><li><p>çµæ´»çš„ç»“æ„ï¼Œæ–‡æ¡£ä¸ä¾èµ–é¢„å…ˆå®šä¹‰çš„æ¨¡å¼ï¼Œæˆ‘ä»¬çŸ¥é“å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œè¦æå‰å®šä¹‰å­—æ®µæ‰èƒ½ä½¿ç”¨ï¼Œåœ¨Elasticsearchä¸­ï¼Œå¯¹äºå­—æ®µæ˜¯éå¸¸çµæ´»çš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¯¥å­—æ®µï¼Œæˆ–è€…åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µã€‚</p></li></ul><p>æˆ‘ä»¬å¯ä»¥éšæ„çš„æ–°å¢æˆ–è€…å¿½ç•¥æŸä¸ªå­—æ®µï¼Œä½†æ¯ä¸ªå­—æ®µçš„ç±»å‹éå¸¸é‡è¦ã€‚æ¯”å¦‚ä¸€ä¸ªå¹´é¾„å­—æ®µç±»å‹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯æ•´å½¢ã€‚å› ä¸ºelasticsearchä¼šä¿å­˜å­—æ®µå’Œç±»å‹ä¹‹é—´çš„æ˜ å°„åŠå…¶ä»–çš„è®¾ç½®ã€‚è¿™ç§æ˜ å°„å…·ä½“åˆ°æ¯ä¸ªæ˜ å°„çš„æ¯ç§ç±»å‹,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨elasticsearchä¸­ï¼Œç±»å‹æœ‰æ—¶å€™ä¹Ÿç§°ä¸º<strong>æ˜ å°„ç±»å‹</strong></p><p>æ–‡æ¡£å°±æ˜¯<strong>ä¸€æ¡æ¡æ‰“å¥½æ ‡ç­¾çš„æ•°æ®</strong></p><p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p><blockquote><p>  user</p><p>  1 xiaoming 22</p><p>  2 liming 19</p><p>  ã€‚ã€‚ã€‚</p></blockquote><p>è¿™æ˜¯ä¸€ä¸ªè¡¨ï¼Œåç§°ä¸ºuserï¼Œé‡Œé¢çš„æ¯ä¸€è¡Œå°±æ˜¯ä¸€ä¸ªæ–‡æ¡£ï¼Œæ–‡æ¡£ä¸­åŒ…å«ç€åºå·ã€åå­—ã€å¹´é¾„ç­‰ä¿¡æ¯ï¼ˆæœ‰ç‚¹åƒä¹‹å‰è¦ä½¿ç”¨TFIDFç®—æ³•æ—¶åšçš„é‚£ä¸ªè®¾å¤‡æ–‡æ¡£ï¼‰</p><h3 id="5-3-ç±»å‹"><a href="#5-3-ç±»å‹" class="headerlink" title="5.3 ç±»å‹"></a>5.3 ç±»å‹</h3><p>ç±»å‹æ˜¯æ–‡æ¡£çš„<strong>é€»è¾‘å®¹å™¨</strong>ï¼Œå°±åƒå…³ç³»å‹æ•°æ®åº“ä¸€æ ·ï¼Œè¡¨æ ¼æ˜¯è¡Œçš„å®¹å™¨ã€‚</p><p>ç±»å‹ä¸­å¯¹äºå­—æ®µçš„å®šä¹‰ç§°ä¸º<strong>æ˜ å°„</strong>ï¼Œæ¯”å¦‚nameå¯ä»¥æ˜ å°„ä¸ºå­—ç¬¦ä¸²ç±»å‹ã€‚</p><p>æˆ‘ä»¬è¯´æ–‡æ¡£æ˜¯æ— æ¨¡å¼çš„ï¼Œå®ƒä»¬ä¸éœ€è¦æ‹¥æœ‰æ˜ å°„ä¸­æ‰€å®šä¹‰çš„æ‰€æœ‰å­—æ®µï¼Œæ¯”å¦‚æ–°å¢ä¸€ä¸ªå­—æ®µã€‚é‚£ä¹ˆelasticsearchæ˜¯æ€ä¹ˆåšçš„å‘¢?elasticsearchä¼šè‡ªåŠ¨çš„å°†æ–°å­—æ®µåŠ å…¥æ˜ å°„ï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µçš„ä¸ç¡®å®šå®ƒæ˜¯ä»€ä¹ˆç±»å‹ï¼Œelasticsearchå°±å¼€å§‹çŒœï¼Œå¦‚æœè¿™ä¸ªå€¼æ˜¯18 ,é‚£ä¹ˆelasticsearchä¼šè®¤ä¸ºå®ƒæ˜¯æ•´å½¢ã€‚</p><p>ä½†æ˜¯elasticsearchä¹Ÿå¯èƒ½çŒœä¸å¯¹ ï¼Œæ‰€ä»¥æœ€å®‰å…¨çš„æ–¹å¼å°±æ˜¯æå‰å®šä¹‰å¥½æ‰€éœ€è¦çš„æ˜ å°„ï¼Œè¿™ç‚¹è·Ÿå…³ç³»å‹æ•°æ®åº“æ®Šé€”åŒå½’äº†ï¼Œå…ˆå®šä¹‰å¥½å­—æ®µï¼Œç„¶åå†ä½¿ç”¨</p><p>ç±»æ¯”MySQLä¸­ï¼Œå»ºç«‹ä¸€ä¸ªè¡¨çš„æ—¶å€™éœ€è¦è®¾å®šçš„æ•°æ®ç±»å‹</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105130.png" alt="image-20210202095941630"></p><h3 id="5-4-ç´¢å¼•"><a href="#5-4-ç´¢å¼•" class="headerlink" title="5.4 ç´¢å¼•"></a>5.4 ç´¢å¼•</h3><p>ç´¢å¼•æ˜¯<strong>æ˜ å°„ç±»å‹çš„å®¹å™¨</strong>ï¼Œ elasticsearchä¸­çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ–‡æ¡£é›†åˆï¼ˆå³æ•°æ®åº“ï¼‰ã€‚ç´¢å¼•å­˜å‚¨äº†æ˜ å°„ç±»å‹çš„å­—æ®µå’Œå…¶ä»–è®¾ç½®ã€‚ ç„¶åå®ƒä»¬è¢«å­˜å‚¨åˆ°äº†å„ä¸ªåˆ†ç‰‡ä¸Šäº†ã€‚æˆ‘ä»¬æ¥ç ”ç©¶ä¸‹åˆ†ç‰‡æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p><strong>ç‰©ç†è®¾è®¡: èŠ‚ç‚¹å’Œåˆ†ç‰‡å¦‚ä½•å·¥ä½œ</strong></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105131.png" alt="image-20210202100254208"></p><p>å­˜åœ¨æ•°æ®åº“çš„æ•°æ®å¯ä»¥é€šè¿‡ä¸åŒçš„åˆ†ç‰‡æ”¾åœ¨ä¸åŒçš„é›†ç¾¤ä¸Š</p><p>ä¸€ä¸ªé›†ç¾¤è‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªelasricsearchè¿›ç¨‹ï¼ŒèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªç´¢å¼•é»˜è®¤çš„ï¼Œå¦‚æœä½ åˆ›å»ºç´¢å¼•ï¼Œé‚£ä¹ˆç´¢å¼•å°†ä¼šæœ‰ä¸ª5ä¸ªåˆ†ç‰‡( primary shard ,åˆç§°<strong>ä¸»åˆ†ç‰‡</strong>)æ„æˆï¼Œæ¯ä¸€ä¸ªä¸»åˆ†ç‰‡ä¼šæœ‰ä¸€ä¸ªå‰¯æœ¬( replica shard ,åˆç§°<strong>å¤åˆ¶åˆ†ç‰‡</strong>)</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105132.png" alt="image-20210202100505894"></p><p>ä¸Šå›¾æ˜¯ä¸€ä¸ªæœ‰3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå¯ä»¥çœ‹åˆ°ä¸»åˆ†ç‰‡å’Œå¯¹åº”çš„å¤åˆ¶åˆ†ç‰‡éƒ½ä¸ä¼šåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹å†…ï¼ˆæ¯”å¦‚ä¸»åˆ†ç‰‡P0å’Œä¸»åˆ†ç‰‡çš„å¤åˆ¶åˆ†ç‰‡P1åˆ†åˆ«åœ¨èŠ‚ç‚¹1/3ï¼ŒåŒæ ·çš„åˆ†ç‰‡Pxåœ¨æ¯ä¸ªè‡³å°‘æœ‰ä¸€ä¸ªï¼‰ï¼Œå½“æŸä¸ªèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œæ•°æ®ä¹Ÿä¸è‡³äºä¸¢å¤±ã€‚</p><p>å®é™…ä¸Šï¼Œä¸€ä¸ªåˆ†ç‰‡æ˜¯ä¸€ä¸ªLuceneç´¢å¼•ï¼Œä¸€ä¸ªåŒ…å«<strong>å€’æ’ç´¢å¼•</strong>çš„æ–‡ä»¶ç›®å½•ï¼Œå€’æ’ç´¢å¼•çš„ç»“æ„ä½¿å¾—elasticsearchåœ¨ä¸æ‰«æå…¨éƒ¨æ–‡æ¡£çš„æƒ…å†µä¸‹ï¼Œå°±èƒ½å‘Šè¯‰ä½ å“ªäº›æ–‡æ¡£åŒ…å«ç‰¹å®šçš„å…³é”®å­—ã€‚ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ</p><h3 id="5-5-å€’æ’ç´¢å¼•"><a href="#5-5-å€’æ’ç´¢å¼•" class="headerlink" title="5.5 å€’æ’ç´¢å¼•"></a>5.5 å€’æ’ç´¢å¼•</h3><p>elasticsearchä½¿ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸ºå€’æ’ç´¢å¼•çš„ç»“æ„ ,é‡‡ç”¨<strong>Luceneå€’æ’ç´¢å¼•</strong>ä½œä¸ºåº•å±‚ã€‚è¿™ç§ç»“æ„é€‚ç”¨äºå¿«é€Ÿçš„å…¨æ–‡æœç´¢ï¼Œä¸€ä¸ªç´¢å¼•ç”±æ–‡æ¡£ä¸­æ‰€æœ‰ä¸é‡å¤çš„åˆ—è¡¨æ„æˆï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯ï¼Œéƒ½æœ‰ä¸€ä¸ªåŒ…å«å®ƒçš„æ–‡æ¡£åˆ—è¡¨ã€‚</p><p>ä¾‹å¦‚ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªæ–‡æ¡£ï¼Œæ¯ä¸ªæ–‡æ¡£åŒ…å«å¦‚ä¸‹å†…å®¹:</p><blockquote><p>  study every day, good good up to forever #æ–‡æ¡£1åŒ…å«çš„å†…å®¹<br>  To forever, study every dayï¼Œ good good up #æ–‡æ¡£2åŒ…å«çš„å†…å®¹</p></blockquote><p>ä¸ºäº†åˆ›å»ºå€’æ’ç´¢å¼•ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å°†æ¯ä¸ªæ–‡æ¡£æ‹†åˆ†æˆç‹¬ç«‹çš„è¯(æˆ–ç§°ä¸ºè¯æ¡æˆ–è€…tokens) ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸é‡å¤çš„è¯æ¡çš„æ’åºåˆ—è¡¨ï¼Œç„¶ååˆ—å‡ºæ¯ä¸ªè¯æ¡å‡ºç°åœ¨å“ªä¸ªæ–‡æ¡£:ï¼ˆå¤§å°å†™è¦åŒºåˆ†ï¼Œé‡å¤å•è¯ä¹Ÿè¦åŠ å…¥ï¼‰</p><table><thead><tr><th>term</th><th>doc_1</th><th>doc_2</th></tr></thead><tbody><tr><td>Study</td><td>ã€‡</td><td>X</td></tr><tr><td>To</td><td>X</td><td>X</td></tr><tr><td>forever</td><td>ã€‡</td><td>ã€‡</td></tr><tr><td>every</td><td>ã€‡</td><td>ã€‡</td></tr><tr><td>study</td><td>X</td><td>ã€‡</td></tr><tr><td>day</td><td>ã€‡</td><td>ã€‡</td></tr><tr><td>good</td><td>ã€‡</td><td>ã€‡</td></tr><tr><td>up</td><td>ã€‡</td><td>ã€‡</td></tr><tr><td>to</td><td>ã€‡</td><td>X</td></tr><tr><td>every</td><td>ã€‡</td><td>ã€‡</td></tr></tbody></table><p>ç°åœ¨ï¼Œæˆ‘ä»¬è¯•å›¾æœç´¢to foreverï¼Œåªéœ€è¦æŸ¥çœ‹æ¯ä¸ªè¯æ¡åœ¨å¯¹åº”æ–‡æ¡£æ˜¯å¦å‡ºç°å³å¯ã€‚è¿™é‡Œtoå’Œforeveråœ¨doc1é‡Œé¢éƒ½æœ‰ï¼Œè€Œdoc2ä¸­toæ²¡æœ‰ï¼Œæ‰€ä»¥æœç´¢ç»“æœä¸ºï¼šdoc1çš„<strong>æƒé‡</strong>æ›´å¤§ï¼Œå³â€œto foreverâ€æ›´å¯èƒ½å‡ºç°åœ¨doc1</p><table><thead><tr><th>term</th><th>doc_1</th><th>doc_2</th></tr></thead><tbody><tr><td>to</td><td>ã€‡</td><td>X</td></tr><tr><td>forever</td><td>ã€‡</td><td>ã€‡</td></tr><tr><td>SUM</td><td>2</td><td>1</td></tr></tbody></table><p>è¿™é‡Œçš„â€œæƒé‡â€ï¼Œå³ä¸ºæ–‡æ¡£çš„<strong>score</strong>ï¼Œesæœç´¢å®Œæˆä¼šå¯¹åˆ†æ•°è¿›è¡Œè‡ªåŠ¨ç»Ÿè®¡</p><p>ä¸¤ä¸ªæ–‡æ¡£éƒ½åŒ¹é…ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªæ–‡æ¡£æ¯”ç¬¬äºŒä¸ªåŒ¹é…ç¨‹åº¦æ›´é«˜ã€‚å¦‚æœæ²¡æœ‰åˆ«çš„æ¡ä»¶ï¼Œè¿™ä¸¤ä¸ªåŒ…å«å…³é”®å­—çš„æ–‡æ¡£éƒ½å°†è¿”å›ã€‚</p><p><strong>å†ä¸¾ä¸€ä¸ªä¾‹å­</strong></p><p>å†æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹æ¯”å¦‚æˆ‘ä»¬é€šè¿‡åšå®¢æ ‡ç­¾æ¥æœç´¢åšå®¢æ–‡ç« ã€‚ é‚£ä¹ˆå€’æ’ç´¢å¼•åˆ—è¡¨å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªç»“æ„:</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105133.png" alt="image-20210202111236177"></p><p>å¦‚æœè¦æœç´¢å«æœ‰pythonæ ‡ç­¾çš„æ–‡ç« ï¼Œé‚£ç›¸å¯¹äºæŸ¥æ‰¾æ‰€æœ‰åŸå§‹æ•°æ®è€Œè¨€ï¼ŒæŸ¥æ‰¾å€’æ’ç´¢å¼•åçš„æ•°æ®å°†ä¼šå¿«çš„å¤šã€‚åªéœ€è¦æŸ¥çœ‹æ ‡ç­¾è¿™ä¸€æ ,ç„¶åè·å–ç›¸å…³çš„æ–‡ç« IDå³å¯ã€‚æ¯”å¦‚è¿™é‡Œæœç´¢â€œLinuxâ€å°±ç»å¯¹ä¸ä¼šå‡ºç°1æˆ–è€…2</p><p><strong>elasticsearchçš„ç´¢å¼•å’ŒLuceneçš„ç´¢å¼•å¯¹æ¯”</strong></p><p>åœ¨elasticsearchä¸­ï¼Œç´¢å¼•ï¼ˆæ•°æ®åº“ï¼‰è¿™ä¸ªè¯è¢«é¢‘ç¹ä½¿ç”¨ã€‚åœ¨elasticsearchä¸­ ï¼Œç´¢å¼•è¢«åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä»½åˆ†ç‰‡æ˜¯ä¸€ä¸ªLuceneçš„ç´¢å¼•ã€‚<strong>æ‰€ä»¥ä¸€ä¸ªelasticsearchç´¢å¼•æ˜¯ç”±å¤šä¸ªLuceneå€’æ’ç´¢å¼•ç»„æˆçš„</strong>ã€‚ï¼ˆå› ä¸ºelasticsearchä½¿ç”¨Luceneä½œä¸ºåº•å±‚ï¼‰</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105134.png" alt="image-20210202112920334"></p><p>å¦‚æ— ç‰¹æŒ‡ï¼Œè¯´èµ·<strong>ç´¢å¼•éƒ½æ˜¯æŒ‡elasticsearchçš„ç´¢å¼•</strong>ã€‚</p><h2 id="6-IKåˆ†è¯å™¨"><a href="#6-IKåˆ†è¯å™¨" class="headerlink" title="6 IKåˆ†è¯å™¨"></a>6 IKåˆ†è¯å™¨</h2><h3 id="6-1-ä»€ä¹ˆæ˜¯IKåˆ†è¯å™¨"><a href="#6-1-ä»€ä¹ˆæ˜¯IKåˆ†è¯å™¨" class="headerlink" title="6.1 ä»€ä¹ˆæ˜¯IKåˆ†è¯å™¨?"></a>6.1 <strong>ä»€ä¹ˆæ˜¯IKåˆ†è¯å™¨?</strong></h3><p> <strong>åˆ†è¯</strong>:å³æŠŠä¸€æ®µä¸­æ–‡æˆ–è€…åˆ«çš„åˆ’åˆ†æˆä¸€ä¸ªä¸ªçš„å…³é”®å­—ï¼Œæˆ‘ä»¬åœ¨æœç´¢æ—¶å€™ä¼šæŠŠè‡ªå·±çš„ä¿¡æ¯è¿›è¡Œåˆ†è¯ï¼Œä¼šæŠŠæ•°æ®åº“ä¸­æˆ–è€…ç´¢å¼•åº“ä¸­çš„æ•°æ®è¿›è¡Œåˆ†è¯ï¼Œç„¶åè¿›è¡Œä¸€ä¸ªåŒ¹é…æ“ä½œï¼Œé»˜è®¤çš„ä¸­æ–‡åˆ†è¯æ˜¯å°†æ¯ä¸ªå­—çœ‹æˆä¸€ä¸ªè¯ï¼Œæ¯”å¦‚â€œæˆ‘çˆ±é»æ˜â€ä¼šè¢«åˆ†ä¸ºâ€æˆ‘â€,â€çˆ±â€,â€â€œé»â€,â€æ˜â€ ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸ç¬¦åˆè¦æ±‚çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£…ä¸­æ–‡åˆ†è¯å™¨IKæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>IKæä¾›äº†ä¸¤ä¸ªåˆ†è¯ç®—æ³•: ik. smartå’Œik_max_ word</p><p>å…¶ä¸­ik_smartä¸ºæœ€å°‘åˆ‡åˆ†ï¼Œ ik _max_wordä¸ºæœ€ç»†ç²’åº¦åˆ’åˆ†</p><h3 id="6-2-å®‰è£…-IKåˆ†è¯å™¨"><a href="#6-2-å®‰è£…-IKåˆ†è¯å™¨" class="headerlink" title="6.2 å®‰è£… IKåˆ†è¯å™¨"></a>6.2 å®‰è£… IKåˆ†è¯å™¨</h3><p><strong>1ã€ä¸‹è½½</strong></p><blockquote><p>  <a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p></blockquote><p><strong>2ã€å®‰è£…</strong></p><p>è§£å‹åæ”¾å…¥esçš„æ’ä»¶ç›®å½•pluginsä¸‹å³å¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105135.png" alt="image-20210202144827745"></p><p><strong>3ã€é‡å¯esåŠ è½½æ’ä»¶</strong></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105136.png" alt="image-20210202145019120"></p><p>å¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ’ä»¶åˆ—è¡¨</p><blockquote><p>  elasticsearch-plugin list</p></blockquote><p><strong>4ã€å¯åŠ¨Kibanaæµ‹è¯•</strong></p><p>æµ‹è¯•ik_smartï¼ˆä½¿ç”¨RESTfulé£æ ¼çš„è¯­å¥å‘èµ·GETè¯·æ±‚ï¼Œå¯¹æˆ‘ä»¬æä¾›çš„JSONæ•°æ®è¿›è¡Œåˆ†è¯ï¼‰</p><blockquote>  <div class="code-wrapper"><pre><code class="hljs json">GET _analyze&#123;<span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_smart&quot;</span>,<span class="hljs-attr">&quot;text&quot;</span>: [<span class="hljs-string">&quot;æ–°å‹å† çŠ¶ç—…æ¯’&quot;</span>]&#125;</code></pre></div></blockquote><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105137.png" alt="image-20210202150329532"></p><p>æµ‹è¯•ik _max _word</p><blockquote>  <div class="code-wrapper"><pre><code class="hljs json">GET _analyze&#123;<span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<span class="hljs-attr">&quot;text&quot;</span>: [<span class="hljs-string">&quot;æ–°å‹å† çŠ¶ç—…æ¯’&quot;</span>]&#125;</code></pre></div></blockquote><p>è¿è¡Œç»“æœï¼šæœ€ç»†ç²’åº¦åˆ’åˆ†ä¼šæŠŠæ‰€æœ‰å¯èƒ½çš„ç»„åˆéƒ½åˆ’åˆ†å‡ºæ¥ï¼ˆåˆ’åˆ†æ–¹å¼ç”±æŸä¸ªå­—å…¸è§„å®šï¼‰</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105138.png" alt="image-20210202150645756"></p><p>é—®é¢˜ï¼šå½“é‡åˆ°è‡ªé€ è¯æ—¶ï¼Œæ‹†åˆ†ç»“æœä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105139.png" alt="image-20210202151449769"></p><p>è¿™æ—¶éœ€è¦æŠŠå…³é”®è¯åŠ å…¥å­—å…¸</p><h3 id="6-3-é…ç½®IKåˆ†è¯å™¨"><a href="#6-3-é…ç½®IKåˆ†è¯å™¨" class="headerlink" title="6.3 é…ç½®IKåˆ†è¯å™¨"></a>6.3 é…ç½®IKåˆ†è¯å™¨</h3><p><strong>æ·»åŠ è‡ªå®šä¹‰å­—å…¸</strong></p><blockquote><p>  åœ¨ elasticsearch-7.12.1\plugins\ik\config</p></blockquote><p>ä¸­å¯ä»¥æ‰¾åˆ°é…ç½®æ–‡ä»¶<strong>IKAnalyzer.cfg.xml</strong></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105140.png" alt="image-20210202152120411"></p><p>åªéœ€è¦åœ¨configç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªè‡ªå·±çš„.dicå­—å…¸æ–‡ä»¶å¹¶å½•å…¥IKAnalyzer.cfg.xmlä¸­ç„¶å<strong>é‡å¯es</strong>å³å¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105141.png" alt="image-20210202152518579"></p><p>æµ‹è¯•èƒ½å¤Ÿè¯†åˆ«è‡ªå®šä¹‰è¯è¯­</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105142.png" alt="image-20210202153349063"></p><h2 id="7-RESTé£æ ¼"><a href="#7-RESTé£æ ¼" class="headerlink" title="7 RESTé£æ ¼"></a>7 RESTé£æ ¼</h2><h3 id="7-1-æ¦‚å¿µ"><a href="#7-1-æ¦‚å¿µ" class="headerlink" title="7.1 æ¦‚å¿µ"></a>7.1 <strong>æ¦‚å¿µ</strong></h3><p>ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œè€Œä¸æ˜¯æ ‡å‡†ï¼Œåªæ˜¯æä¾›äº†ä¸€ç»„è®¾è®¡åŸåˆ™å’Œçº¦æŸæ¡ä»¶ã€‚å®ƒä¸»è¦ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’ç±»çš„è½¯ä»¶ã€‚åŸºäºè¿™ä¸ªé£æ ¼è®¾è®¡çš„è½¯ä»¶å¯ä»¥æ›´ç®€æ´ï¼Œæ›´æœ‰å±‚æ¬¡ï¼Œæ›´æ˜“äºå®ç°ç¼“å­˜ç­‰æœºåˆ¶ã€‚</p><p>å³<strong>é€šè¿‡ä¸åŒçš„å‘½ä»¤å®ç°ä¸åŒçš„æ“ä½œ</strong></p><h3 id="7-2-åŸºæœ¬RESTå‘½ä»¤"><a href="#7-2-åŸºæœ¬RESTå‘½ä»¤" class="headerlink" title="7.2 åŸºæœ¬RESTå‘½ä»¤"></a>7.2 åŸºæœ¬RESTå‘½ä»¤</h3><table><thead><tr><th>method</th><th>urlåœ°å€</th><th>æè¿°</th></tr></thead><tbody><tr><td>PUT</td><td>localhost:9200/ç´¢å¼•åç§°/ç±»å‹åç§°/æ–‡æ¡£id</td><td>åˆ›å»ºæ–‡æ¡£(æŒ‡å®šæ–‡æ¡£id )</td></tr><tr><td>POST</td><td>localhost:9200/ç´¢å¼“|åç§°/ç±»å‹åç§°</td><td>åˆ›å»ºæ–‡æ¡£(éšæœºæ–‡æ¡£id )</td></tr><tr><td>POST</td><td>localhost:9200/ç´¢å¼•åç§°/ç±»å‹åç§°/æ–‡æ¡£id/_ update</td><td>ä¿®æ”¹æ–‡æ¡£</td></tr><tr><td>DELETE</td><td>localhost:9200/ç´¢å¼•åç§°/ç±»å‹åç§°/æ–‡æ¡£id</td><td>åˆ é™¤æ–‡æ¡£</td></tr><tr><td>GET</td><td>localhost:9200/ç´¢å¼•åç§°/ç±»å‹åç§°/æ–‡æ¡£id</td><td>æŸ¥è¯¢æ–‡æ¡£ï¼ˆé€šè¿‡æ–‡æ¡£idï¼‰</td></tr><tr><td>POST</td><td>localhost:9200/ç´¢å¼“|åç§°/ç±»å‹åç§°/_ search</td><td>æŸ¥è¯¢æ‰€æœ‰æ•°æ®</td></tr></tbody></table><h2 id="8-æµ‹è¯•"><a href="#8-æµ‹è¯•" class="headerlink" title="8 æµ‹è¯•"></a>8 æµ‹è¯•</h2><h3 id="8-1-å…³äºç´¢å¼•çš„æ“ä½œ"><a href="#8-1-å…³äºç´¢å¼•çš„æ“ä½œ" class="headerlink" title="8.1 å…³äºç´¢å¼•çš„æ“ä½œ"></a>8.1 å…³äºç´¢å¼•çš„æ“ä½œ</h3><h4 id="1ã€åˆ›å»ºä¸€ä¸ªç´¢å¼•"><a href="#1ã€åˆ›å»ºä¸€ä¸ªç´¢å¼•" class="headerlink" title="1ã€åˆ›å»ºä¸€ä¸ªç´¢å¼•"></a><strong>1ã€åˆ›å»ºä¸€ä¸ªç´¢å¼•</strong></h4><blockquote>  <div class="code-wrapper"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/ç´¢å¼•å/</span>ç±»å‹åï¼ˆæ–°ç‰ˆæœ¬é€æ­¥åºŸå¼ƒï¼‰/æ–‡æ¡£ID&#123;è¯·æ±‚ä½“&#125;</code></pre></div></blockquote><div class="code-wrapper"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/test1/</span>type/<span class="hljs-number">1</span>&#123;  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;xiaoming&quot;</span>,  <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">13</span>&#125;</code></pre></div><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105143.png" alt="image-20210203092727349"></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105144.png" alt="image-20210203110817742"></p><p><strong>æ³¨æ„ï¼š</strong></p><p> 1ã€åˆ›å»ºçš„ç´¢å¼•åè¦<strong>å°å†™</strong></p><p> 2ã€es headä¸­æ•°æ®æµè§ˆä¸æ˜¾ç¤ºå†…å®¹å°±æ¢ä¸ªæµè§ˆå™¨è¯•è¯•</p><h4 id="2ã€æ›´æ–°ä¸€ä¸ªç´¢å¼•"><a href="#2ã€æ›´æ–°ä¸€ä¸ªç´¢å¼•" class="headerlink" title="2ã€æ›´æ–°ä¸€ä¸ªç´¢å¼•"></a>2ã€æ›´æ–°ä¸€ä¸ªç´¢å¼•</h4><p>ä¿®æ”¹ç´¢å¼•ä¾æ—§å¯ä»¥ä½¿ç”¨PUTï¼Œæ­¤æ—¶è¿”å›çš„ç‰ˆæœ¬å·ä¼šå¢åŠ ï¼Œâ€resultâ€ä¼šæç¤ºupdateï¼Œä½†å¦‚æœæ¼äº†ä¸€äº›ä¿¡æ¯ï¼ŒåŸå§‹ä¿¡æ¯å°±ä¼šä¸¢å¤±ï¼Œæ•…ç°åœ¨ä¸€èˆ¬<strong>ä½¿ç”¨POSTæ¥æ›´æ–°ç´¢å¼•</strong></p><div class="code-wrapper"><pre><code class="hljs awk">POST <span class="hljs-regexp">/test1/</span>type1/<span class="hljs-number">1</span>&#123; <span class="hljs-string">&quot;doc&quot;</span>:&#123;   <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;å¼ ä¸‰&quot;</span> &#125;&#125;</code></pre></div><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105145.png" alt="image-20210203115556670"></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105146.png" alt="image-20210203115639183"></p><p>æ²¡æœ‰å†™ageï¼Œå®ƒå°±ä¼šä¿æŒåŸæ ·ï¼ˆå¦‚æœç”¨PUTçš„è¯ageå°±ç›´æ¥æ²¡äº†ï¼‰</p><h4 id="3ã€åˆ é™¤ä¸€ä¸ªç´¢å¼•"><a href="#3ã€åˆ é™¤ä¸€ä¸ªç´¢å¼•" class="headerlink" title="3ã€åˆ é™¤ä¸€ä¸ªç´¢å¼•"></a>3ã€åˆ é™¤ä¸€ä¸ªç´¢å¼•</h4><div class="code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">DELETE</span> test<span class="hljs-number">1</span>ï¼ˆç´¢å¼•åæˆ–æ–‡æ¡£è®°å½•IDï¼‰</code></pre></div><h4 id="4ã€æŒ‡å®šç±»å‹"><a href="#4ã€æŒ‡å®šç±»å‹" class="headerlink" title="4ã€æŒ‡å®šç±»å‹"></a>4ã€æŒ‡å®šç±»å‹</h4><p><strong>å¸¸ç”¨çš„å­—æ®µç±»å‹æœ‰ï¼š</strong></p><p>â—å­—ç¬¦ä¸²ç±»å‹<br>textã€keyword<br>â—æ•°å€¼ç±»å‹<br>long,. integer, short, byte, double, float, half float, scaled float<br>â—æ—¥æœŸç±»å‹<br>date<br>â—teå¸ƒå°”å€¼ç±»å‹<br>boolean<br>â—äºŒè¿›åˆ¶ç±»å‹<br>binary.</p><p>åˆ›å»ºä¸€ä¸ªt2ç´¢å¼•ï¼ˆæˆ–è€…è¯´ç´¢å¼•åº“ï¼‰ä½†ä¸åˆ›å»ºæ–‡æ¡£ï¼Œæ­¤æ—¶ç§°å…¶ä¸ºä¸€ä¸ªâ€œè§„åˆ™â€</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105147.png" alt="image-20210203111936090"></p><p>æŸ¥çœ‹t2ï¼Œé‡Œé¢æ²¡æœ‰å€¼ï¼Œåç»­å¯ä»¥å¾€é‡Œé¢æ”¾æ•°æ®</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105148.png" alt="image-20210203112007717"></p><p>é€šè¿‡GETå¯ä»¥æŸ¥çœ‹è§„åˆ™ä¿¡æ¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105149.png" alt="image-20210203112304214"></p><p>GETè¯·æ±‚å¾ˆå¥½ç”¨ï¼Œé™¤äº†è§„åˆ™ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹ç´¢å¼•ã€æ–‡æ¡£çš„ä¿¡æ¯</p><p><strong>æ³¨ï¼š</strong></p><p>1ã€æ–°ç‰ˆæœ¬esä¸­æ­£åœ¨é€æ­¥å¼ƒç”¨typeï¼Œæˆ‘ä»¬åˆ›å»ºç´¢å¼•åº“çš„æ—¶å€™å¯ä»¥å°†åŸæ¥çš„typeæ¢æˆ_docï¼Œè¿™æ ·eså°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬é…ç½®å­—æ®µç±»å‹</p><p>å¦‚ä¸‹é¢çš„æ–°å»ºçš„test3ï¼š</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105150.png" alt="image-20210203113420834"></p><p>2ã€æŸ¥çœ‹é»˜è®¤é…ç½®å‘½ä»¤ GET _cat/indices?v</p><p>å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€ç­‰ä¸€äº›ä¿¡æ¯</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105151.png" alt="image-20210203114043227"></p><h3 id="8-2-å…³äºæ–‡æ¡£çš„æ“ä½œ"><a href="#8-2-å…³äºæ–‡æ¡£çš„æ“ä½œ" class="headerlink" title="8.2 å…³äºæ–‡æ¡£çš„æ“ä½œ"></a>8.2 å…³äºæ–‡æ¡£çš„æ“ä½œ</h3><h4 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h4><p><strong>1ã€æ·»åŠ æ•°æ®</strong></p><div class="code-wrapper"><pre><code class="hljs json">PUT /dayceng/user/1&#123;  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;DAYceng&quot;</span>,  <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-string">&quot;22&quot;</span>,  <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;å¦‚æ­¤ç”Ÿæ´»ä¸‰åå¹´&quot;</span>,  <span class="hljs-attr">&quot;tags&quot;</span>: [<span class="hljs-string">&quot;ç©·&quot;</span>,<span class="hljs-string">&quot;é˜¿å®…&quot;</span>,<span class="hljs-string">&quot;è„šæœ¬å°å­&quot;</span>]&#125;</code></pre></div><p><strong>2ã€æŸ¥è¯¢ï¼ˆè·å–ï¼ŒGETï¼‰æ•°æ®</strong></p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105152.png" alt="image-20210205094004174"></p><p><strong>3ã€ç®€å•æœç´¢</strong>(GETæ¡ä»¶æŸ¥è¯¢)</p><div class="code-wrapper"><pre><code class="hljs json">GET /dayceng/user/_search?q=name:æ¡ä»¶</code></pre></div><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105153.png" alt="image-20210205095050550"></p><p>ç®€å•çš„æ¡ä»¶æŸ¥è¯¢å¯æ ¹æ®é»˜è®¤çš„æ˜ å°„è§„åˆ™äº§ç”ŸåŸºæœ¬æŸ¥è¯¢ç»“æœ</p><p>ï¼ˆè¿™é‡Œçš„â€_scoreâ€ä»£è¡¨åŒ¹é…åº¦ï¼Œåˆ†å€¼è¶Šé«˜ï¼ŒåŒ¹é…åº¦è¶Šé«˜ï¼‰</p><p>è¯´æ˜ï¼š</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105154.png" alt="image-20210205095252732"></p><p>å­—æ®µnameï¼Œå®ƒçš„ç±»å‹æ˜¯keywordï¼Œæ­¤æ—¶è¿›è¡Œæœç´¢ï¼Œåˆ†è¯å™¨ä¸ä¼šå¯¹ç±»å‹ä¸ºkeywordçš„nameè¿›è¡Œåˆ†è¯ï¼ˆå³å¦‚æœä½ æœâ€œä¸¹â€æ˜¯ä¸ä¼šè¿”å›â€œä¸¹éœâ€çš„ç»“æœçš„ï¼‰ï¼Œå¦‚æœç±»å‹æ˜¯textåˆ™å¯ä»¥æŸ¥åˆ°</p><h4 id="å¤æ‚æ“ä½œï¼ˆä¸»è¦æ˜¯æœç´¢ï¼‰"><a href="#å¤æ‚æ“ä½œï¼ˆä¸»è¦æ˜¯æœç´¢ï¼‰" class="headerlink" title="å¤æ‚æ“ä½œï¼ˆä¸»è¦æ˜¯æœç´¢ï¼‰"></a><strong>å¤æ‚æ“ä½œï¼ˆä¸»è¦æ˜¯æœç´¢ï¼‰</strong></h4><p><strong>å¤æ‚æœç´¢selectï¼ˆæ’åºã€åˆ†é¡µã€æ¨¡ç³Š/ç²¾å‡†æŸ¥è¯¢ã€é«˜äº®ï¼‰</strong></p><h5 id="1ã€ä½¿ç”¨è¯·æ±‚ä½“æŸ¥è¯¢"><a href="#1ã€ä½¿ç”¨è¯·æ±‚ä½“æŸ¥è¯¢" class="headerlink" title="1ã€ä½¿ç”¨è¯·æ±‚ä½“æŸ¥è¯¢"></a><strong>1ã€ä½¿ç”¨è¯·æ±‚ä½“æŸ¥è¯¢</strong></h5><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è¿›è¡Œæœç´¢ä¸æ˜¯ç›´æ¥å†™æ¡ä»¶æœç´¢ï¼Œè€Œæ˜¯éœ€è¦æ„å»ºä¸€ä¸ªJSONæ ¼å¼çš„è¯·æ±‚ä½“ï¼Œè¿™æ ·å¯ä»¥è®¾ç½®æ›´å¤šå‚æ•°ä»¥å®ç°å®šåˆ¶åŒ–çš„æœç´¢</p><div class="code-wrapper"><pre><code class="hljs json">GET /dayceng/user/_search&#123;  <span class="hljs-attr">&quot;query&quot;</span>: &#123;    <span class="hljs-attr">&quot;match&quot;</span>: &#123;      <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;ä¸¹éœ&quot;</span>    &#125;  &#125;&#125;</code></pre></div><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105155.png" alt="image-20210205105110638"></p><p>å¦‚æœæœ‰ç›¸ä¼¼å…³é”®å­—çš„å¤šä¸ªç»“æœï¼Œä»–ä»¬çš„åˆ†æ•°ä¼šæœ‰ä¸åŒ</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105156.png" alt="image-20210205110206156"></p><p>hitsæ˜¯æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…å«ï¼š</p><p> ç´¢å¼•å’Œæ–‡æ¡£çš„ä¿¡æ¯</p><p> æŸ¥è¯¢çš„ç»“æœæ€»æ•°</p><p> æŸ¥è¯¢å‡ºæ¥çš„å…·ä½“çš„æ–‡æ¡£</p><p> åˆ†æ•°ï¼šç”¨æ¥åˆ¤æ–­å“ªä¸ªç»“æœæ›´åŠ ç¬¦åˆé¢„æœŸ</p><p>é€šè¿‡hitsæˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®çš„ä¿¡æ¯éå†å‡ºæ¥ï¼Œè®©æˆ‘ä»¬æƒ³è¦çš„ç»“æœä¼˜å…ˆæ˜¾ç¤ºå‡ºæ¥</p><p>åé¢ä½¿ç”¨javaæ“æ§esï¼Œæ‰€æœ‰çš„æ–¹æ³•å’Œå¯¹è±¡å°±æ˜¯è¿™é‡Œçš„hitsã€sourceç­‰key</p><h5 id="2ã€è¯·æ±‚ä½“å‚æ•°"><a href="#2ã€è¯·æ±‚ä½“å‚æ•°" class="headerlink" title="2ã€è¯·æ±‚ä½“å‚æ•°"></a>2ã€è¯·æ±‚ä½“å‚æ•°</h5><p>æˆ‘ä»¬é€šè¿‡åœ¨è¯·æ±‚ä½“åæ·»åŠ å‚æ•°çš„æ–¹å¼å®ç°ä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œ</p><h6 id="ç­›é€‰ç»“æœ"><a href="#ç­›é€‰ç»“æœ" class="headerlink" title="ç­›é€‰ç»“æœ"></a><strong>ç­›é€‰ç»“æœ</strong></h6><p>åªè¿”å›ç‰¹å®šç»“æœ</p><div class="code-wrapper"><pre><code class="hljs awk">GET <span class="hljs-regexp">/dayceng/u</span>ser/_search&#123;  <span class="hljs-string">&quot;query&quot;</span>: &#123;    <span class="hljs-string">&quot;match&quot;</span>: &#123;      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;ä¸¹éœ&quot;</span>    &#125;  &#125;,   <span class="hljs-string">&quot;_source&quot;</span>:[<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;tags&quot;</span>]&#125;</code></pre></div><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105157.png" alt="image-20210205114109589"></p><h6 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a><strong>æ’åº</strong></h6><div class="code-wrapper"><pre><code class="hljs json">GET /dayceng/user/_search&#123;  <span class="hljs-attr">&quot;query&quot;</span>: &#123;    <span class="hljs-attr">&quot;match&quot;</span>: &#123;      <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;ä¸¹éœ&quot;</span>    &#125;  &#125;,  <span class="hljs-attr">&quot;sort&quot;</span>: [    &#123;      <span class="hljs-attr">&quot;age&quot;</span>: &#123;        <span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span>      &#125;    &#125;  ]&#125;</code></pre></div><p>æ³¨æ„ï¼šæ’åºåªèƒ½ç”¨äºæ•°å€¼ç±»å‹ï¼Œæˆ‘è¿™é‡Œçš„ageæ˜¯textç±»å‹ï¼Œè¿è¡Œå°±ä¼šæŠ¥é”™</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105158.png" alt="image-20210205115918067"></p><blockquote><p>  â€œText fields are not optimised for operations that require per-document field data like aggregations and sorting, so these operations are disabled by default. Please use a keyword field instead. Alternatively, set fielddata=true on [age] in order to load field data by uninverting the inverted index. Note that this can use significant memory.â€</p></blockquote><p>æŠŠâ€œageâ€æ¢æˆâ€œage.keywordâ€å³å¯æ­£å¸¸æ’åº</p><p><img src="/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/20210505105159.png" alt="image-20210205120324780"></p><h6 id="åˆ†é¡µ"><a href="#åˆ†é¡µ" class="headerlink" title="åˆ†é¡µ"></a><strong>åˆ†é¡µ</strong></h6><div class="code-wrapper"><pre><code class="hljs json">GET /dayceng/user/_search&#123;  <span class="hljs-attr">&quot;query&quot;</span>: &#123;    <span class="hljs-attr">&quot;match&quot;</span>: &#123;      <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;ä¸¹éœåœ¨&quot;</span>    &#125;  &#125;,  <span class="hljs-attr">&quot;sort&quot;</span>: [    &#123;      <span class="hljs-attr">&quot;age.keyword&quot;</span>: &#123;        <span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span>      &#125;    &#125;  ],   &quot;from&quot;: 0,---ä»ç¬¬å‡ ä¸ªæ•°æ®å¼€å§‹   &quot;size&quot;: 2 ---è¿”å›å‡ ä¸ªæ•°æ®&#125;</code></pre></div><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105200.png" alt="image-20210206093248369"></p><h6 id="è¿‡æ»¤"><a href="#è¿‡æ»¤" class="headerlink" title="è¿‡æ»¤"></a><strong>è¿‡æ»¤</strong></h6><p>ä½¿ç”¨filterå‚æ•°å³å¯</p><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105201.png" alt="image-20210206094548128"></p><p> gtï¼šå¤§äº</p><p> gteï¼šå¤§äºç­‰äº</p><p> ltï¼šå°äº</p><p> lteï¼šå°äºç­‰äº</p><p> ï¼ˆä»¥ä¸Šæ¡ä»¶å¯æ··åˆä½¿ç”¨ï¼‰</p><h5 id="3ã€å¸ƒå°”å€¼æŸ¥è¯¢"><a href="#3ã€å¸ƒå°”å€¼æŸ¥è¯¢" class="headerlink" title="3ã€å¸ƒå°”å€¼æŸ¥è¯¢"></a>3ã€å¸ƒå°”å€¼æŸ¥è¯¢</h5><p>ä½¿ç”¨å¸ƒå°”å€¼å¯è¿›è¡Œå¤šæ¡ä»¶æŸ¥è¯¢</p><p><strong>must</strong>ï¼šè®¾ç½®çš„æ‰€æœ‰matchéƒ½è¦åŒ¹é…æ‰ä¼šè¿”å›ç»“æœ</p><p><strong>must not</strong>ï¼šè¿”å›ä¸è®¾ç½®æ¡ä»¶ç›¸åçš„ç»“æœ</p><p><strong>should</strong>ï¼šæ»¡è¶³æ¡ä»¶ä¹‹ä¸€å³å¯è¿”å›ç»“æœ</p><div class="code-wrapper"><pre><code class="hljs json">GET /dayceng/user/_search&#123;  <span class="hljs-attr">&quot;query&quot;</span>: &#123;    <span class="hljs-attr">&quot;bool&quot;</span>: &#123;      <span class="hljs-attr">&quot;must&quot;</span>: [        &#123;          <span class="hljs-attr">&quot;match&quot;</span>: &#123;            <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;DAYceng&quot;</span>          &#125;        &#125;,        &#123;          <span class="hljs-attr">&quot;match&quot;</span>: &#123;            <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">22</span>          &#125;        &#125;      ]    &#125;  &#125;&#125;</code></pre></div><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105202.png" alt="image-20210206093144473"></p><h5 id="4ã€ç²¾ç¡®æŸ¥è¯¢"><a href="#4ã€ç²¾ç¡®æŸ¥è¯¢" class="headerlink" title="4ã€ç²¾ç¡®æŸ¥è¯¢"></a>4ã€ç²¾ç¡®æŸ¥è¯¢</h5><p>termæŸ¥è¯¢æ˜¯ç›´æ¥ä½¿ç”¨å€’æ’ç´¢å¼•è¿›è¡Œç²¾ç¡®æŸ¥è¯¢çš„</p><p><strong>termä¸matchçš„æ¯”è¾ƒ</strong></p><p> Â·termä½¿ç”¨å€’æ’ç´¢å¼•ç›´æ¥è¿›è¡Œç²¾ç¡®æŸ¥è¯¢</p><p> Â·matchåˆ™ä¼šä½¿ç”¨åˆ†è¯å™¨è¿›è¡Œè§£æåå†æŸ¥è¯¢ï¼ˆå…ˆåˆ†ææ–‡æ¡£ï¼Œåœ¨é€šè¿‡åˆ†æç»“æœè¿›è¡ŒæŸ¥è¯¢ï¼‰</p><p><strong>ç±»å‹textä¸keywordçš„æ¯”è¾ƒ</strong></p><p>textä¼šä½¿ç”¨åˆ†è¯å™¨è¿›è¡Œåˆ†è¯åå†æŸ¥è¯¢</p><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105203.png" alt="image-20210206102310427"></p><p>keywordä¸ä¼šæ‹†åˆ†ç‰¹å®šè¯è¯­</p><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105204.png" alt="image-20210206102247047"></p><h5 id="5ã€é«˜äº®æŸ¥è¯¢"><a href="#5ã€é«˜äº®æŸ¥è¯¢" class="headerlink" title="5ã€é«˜äº®æŸ¥è¯¢"></a>5ã€é«˜äº®æŸ¥è¯¢</h5><p>ä½¿ç”¨highlightå‚æ•°</p><div class="code-wrapper"><pre><code class="hljs awk">GET <span class="hljs-regexp">/dayceng/u</span>ser/_search&#123;  <span class="hljs-string">&quot;query&quot;</span>: &#123;    <span class="hljs-string">&quot;match&quot;</span>: &#123;      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;ä¸¹éœ&quot;</span>    &#125;  &#125;,  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;    <span class="hljs-string">&quot;fields&quot;</span>: &#123;      <span class="hljs-string">&quot;name&quot;</span>:&#123;&#125;    &#125;  &#125;&#125;</code></pre></div><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105205.png" alt="image-20210206104615060"></p><p>åœ¨highlightä¸­ä¹Ÿå¯ä»¥è‡ªå®šä¹‰é«˜äº®æ ‡ç­¾</p><div class="code-wrapper"><pre><code class="hljs awk">GET <span class="hljs-regexp">/dayceng/u</span>ser/_search&#123;  <span class="hljs-string">&quot;query&quot;</span>: &#123;    <span class="hljs-string">&quot;match&quot;</span>: &#123;      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;ä¸¹éœ&quot;</span>    &#125;  &#125;,  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;    <span class="hljs-string">&quot;pre_tags&quot;</span>: <span class="hljs-string">&quot;&lt;p class=key style=&#x27;color:red&#x27;&gt;&quot;</span>,     <span class="hljs-string">&quot;post_tags&quot;</span>: <span class="hljs-string">&quot;&lt;/p&gt;&quot;</span>,     <span class="hljs-string">&quot;fields&quot;</span>: &#123;      <span class="hljs-string">&quot;name&quot;</span>:&#123;&#125;    &#125;  &#125;&#125;</code></pre></div><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105206.png" alt="image-20210206105030939"></p><h2 id="9-Python-elasticsearchåŸºæœ¬ç”¨æ³•"><a href="#9-Python-elasticsearchåŸºæœ¬ç”¨æ³•" class="headerlink" title="9 Python-elasticsearchåŸºæœ¬ç”¨æ³•"></a>9 Python-elasticsearchåŸºæœ¬ç”¨æ³•</h2><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/connecting.html#_getting_a_document">https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/connecting.html#_getting_a_document</a></p><h3 id="9-1-å®‰è£…åŠåˆå§‹åŒ–"><a href="#9-1-å®‰è£…åŠåˆå§‹åŒ–" class="headerlink" title="9.1 å®‰è£…åŠåˆå§‹åŒ–"></a>9.1 å®‰è£…åŠåˆå§‹åŒ–</h3><p>ä½¿ç”¨pipå®‰è£…å³å¯</p><div class="code-wrapper"><pre><code class="hljs shell">pip install elasticsearchpip install elasticsearch[async]#æ”¯æŒå¼‚æ­¥ï¼Œå¯ä¸å®‰è£…</code></pre></div><h3 id="9-2-å®ä¾‹åŒ–eså®¢æˆ·ç«¯"><a href="#9-2-å®ä¾‹åŒ–eså®¢æˆ·ç«¯" class="headerlink" title="9.2 å®ä¾‹åŒ–eså®¢æˆ·ç«¯"></a>9.2 <strong>å®ä¾‹åŒ–eså®¢æˆ·ç«¯</strong></h3><p><img src="https://gitee.com/daycen/drawing-bed/raw/master/img/20210505105207.png" alt="image-20210219115247238"></p><p>å®é™…ä¸Šè¿™é‡Œæ–‡æ¡£ä¸­ç»™äº†ä¸‰ç§åˆ›å»ºå®¢æˆ·ç«¯çš„æ–¹å¼ï¼Œæˆ‘ä»¬é€‰æ‹©HTTP authenticationæ–¹å¼ï¼ˆçœ‹èµ·æ¥æ¸…æ™°ä¸€äº›ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨åˆ«çš„ï¼‰å®ä¾‹åŒ–eså¯¹è±¡</p><div class="code-wrapper"><pre><code class="hljs python">es = Elasticsearch(    [        &#123;<span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>: <span class="hljs-number">9200</span>&#125;,    ],    http_auth=(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;secret&quot;</span>),    timeout=<span class="hljs-number">3600</span>)</code></pre></div><p>ESæä¾›äº†ä¸¤ç§æœç´¢çš„æ–¹å¼ï¼šã€€ã€€</p><p>ã€€ è¯·æ±‚å‚æ•°æ–¹å¼</p><p>ã€€ è¯·æ±‚ä½“æ–¹å¼ï¼ˆå¸¦body çš„é‚£ç§æŸ¥è¯¢ï¼ŒæŠŠæŸ¥è¯¢çš„å†…å®¹æ”¾å…¥bodyä¸­ï¼Œä¼šé€ æˆä¸€å®šçš„å¼€é”€ï¼Œä½†æ˜¯æ˜“äºç†è§£ï¼‰</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è¯·æ±‚ä½“æ–¹å¼è¿›è¡Œæœç´¢</p><p>é…ç½®ä¸€ä¸ªbody</p><div class="code-wrapper"><pre><code class="hljs python">body = &#123;    <span class="hljs-string">&quot;settings&quot;</span>: &#123;        <span class="hljs-string">&quot;number_of_shards&quot;</span>: <span class="hljs-number">3</span>,        <span class="hljs-string">&quot;number_of_replicas&quot;</span>: <span class="hljs-number">2</span>    &#125;,    <span class="hljs-string">&quot;mappings&quot;</span>:&#123;        <span class="hljs-comment"># &quot;_doc&quot;:&#123;</span>        <span class="hljs-string">&quot;properties&quot;</span>:&#123;            <span class="hljs-string">&quot;id&quot;</span>:&#123;                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span>,            &#125;,            <span class="hljs-string">&quot;text&quot;</span>: &#123;                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,                <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,  <span class="hljs-comment">#æŒ‡å®šikåˆ†è¯å™¨ï¼Œé€‚ç”¨ä¸­æ–‡åˆ†è¯ã€‚</span>                <span class="hljs-string">&quot;index&quot;</span>:<span class="hljs-literal">False</span>            &#125;,            <span class="hljs-string">&quot;userId&quot;</span>: &#123;                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span>,            &#125;,            <span class="hljs-string">&quot;reprinted&quot;</span>: &#123;                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,            &#125;,        &#125;</code></pre></div><p>æ³¨ï¼šå¯ä»¥çœ‹åˆ°ï¼Œbodyä¸­å®é™…ä¸Šå°±æ˜¯ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨è¯·æ±‚ä½“å‚æ•°æœç´¢æ—¶è®¾ç½®çš„ä¸€äº›ä¸œè¥¿</p><h3 id="9-3-å•ä¸€æ“ä½œ"><a href="#9-3-å•ä¸€æ“ä½œ" class="headerlink" title="9.3 å•ä¸€æ“ä½œ"></a>9.3 å•ä¸€æ“ä½œ</h3><h4 id="å¢åŠ "><a href="#å¢åŠ " class="headerlink" title="å¢åŠ "></a>å¢åŠ </h4><p><strong>create</strong></p><p>å¿…é¡»æŒ‡å®šå¾…æŸ¥è¯¢çš„idnexã€typeã€idå’ŒæŸ¥è¯¢ä½“bodyï¼›ç¼ºä¸€ä¸å¯ï¼Œå¦åˆ™æŠ¥é”™</p><div class="code-wrapper"><pre><code class="hljs python">es.indices.create(index = <span class="hljs-string">&quot;testpy&quot;</span>, body = body)</code></pre></div><p><strong>index</strong>ã€€</p><p>ç›¸æ¯”äºcreateï¼Œindexçš„ç”¨æ³•å°±ç›¸å¯¹çµæ´»å¾ˆå¤šï¼›idå¹¶éæ˜¯ä¸€ä¸ªå¿…é€‰é¡¹ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™è¯¥æ–‡æ¡£çš„idå°±æ˜¯æŒ‡å®šå€¼ï¼Œè‹¥ä¸æŒ‡å®šï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„idèµ‹ç»™è¯¥æ–‡æ¡£ã€‚</p><div class="code-wrapper"><pre><code class="hljs python">es.index(index = <span class="hljs-string">&quot;testpy&quot;</span>, doc_type = <span class="hljs-string">&quot;_doc&quot;</span>, <span class="hljs-built_in">id</span> = <span class="hljs-number">1</span>, body = &#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-number">1</span>, <span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;å°æ˜&quot;</span>&#125;)</code></pre></div><h4 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h4><p>ã€€ã€€deleteï¼šåˆ é™¤æŒ‡å®šindexã€typeã€idçš„æ–‡æ¡£</p><div class="code-wrapper"><pre><code class="hljs python">es.indices.delete(index = <span class="hljs-string">&#x27;test&#x27;</span>)</code></pre></div><h4 id="æŸ¥æ‰¾"><a href="#æŸ¥æ‰¾" class="headerlink" title="æŸ¥æ‰¾"></a>æŸ¥æ‰¾</h4><p>ã€€ã€€getï¼šè·å–æŒ‡å®šindexã€typeã€idæ‰€å¯¹åº”çš„æ–‡æ¡£</p><div class="code-wrapper"><pre><code class="hljs python">es.get(index=<span class="hljs-string">&quot;testpy&quot;</span>, <span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>)</code></pre></div><h4 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h4><p>ã€€ã€€updateï¼šè·Ÿæ–°æŒ‡å®šindexã€typeã€idæ‰€å¯¹åº”çš„æ–‡æ¡£</p><div class="code-wrapper"><pre><code class="hljs python">es.update(index=<span class="hljs-string">&#x27;testpy&#x27;</span>, doc_type=<span class="hljs-string">&#x27;_doc&#x27;</span>, <span class="hljs-built_in">id</span>=<span class="hljs-string">&#x27;2&#x27;</span>, body=&#123;å¾…æ›´æ–°å­—æ®µ&#125;)</code></pre></div><h3 id="9-4-æ‰¹é‡æ“ä½œ"><a href="#9-4-æ‰¹é‡æ“ä½œ" class="headerlink" title="9.4 æ‰¹é‡æ“ä½œ"></a>9.4 æ‰¹é‡æ“ä½œ</h3><h4 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h4><p>searchï¼šæŸ¥è¯¢æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰æ–‡æ¡£ï¼Œæ²¡æœ‰idå±æ€§ï¼Œä¸”indexï¼Œtypeå’Œbodyå‡å¯ä¸ºNoneã€‚ bodyçš„è¯­æ³•æ ¼å¼å¿…é¡»ç¬¦åˆDSLæ ¼å¼</p><div class="code-wrapper"><pre><code class="hljs python">es.search(index = <span class="hljs-string">&quot;test&quot;</span>, doc_type = <span class="hljs-string">&quot;_doc&quot;</span>, body = query)</code></pre></div><p>å¤åˆæŸ¥è¯¢è¯­å¥</p><div class="code-wrapper"><pre><code class="hljs python">query = &#123;<span class="hljs-string">&#x27;query&#x27;</span>: &#123;<span class="hljs-string">&#x27;match_all&#x27;</span>: &#123;&#125;&#125;&#125;<span class="hljs-comment"># æŸ¥æ‰¾æ‰€æœ‰æ–‡æ¡£</span>query = &#123;<span class="hljs-string">&#x27;query&#x27;</span>: &#123;<span class="hljs-string">&#x27;term&#x27;</span>: &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;jack&#x27;</span>&#125;&#125;&#125;<span class="hljs-comment"># æŸ¥æ‰¾åå­—å«åšjackçš„æ‰€æœ‰æ–‡æ¡£</span>query = &#123;<span class="hljs-string">&#x27;query&#x27;</span>: &#123;<span class="hljs-string">&#x27;range&#x27;</span>: &#123;<span class="hljs-string">&#x27;age&#x27;</span>: &#123;<span class="hljs-string">&#x27;gt&#x27;</span>: <span class="hljs-number">11</span>&#125;&#125;&#125;&#125;<span class="hljs-comment"># æŸ¥æ‰¾å¹´é¾„å¤§äº11çš„æ‰€æœ‰æ–‡æ¡£</span>allDoc = es.search(index=<span class="hljs-string">&#x27;indexName&#x27;</span>, doc_type=<span class="hljs-string">&#x27;typeName&#x27;</span>, body=query)</code></pre></div><h4 id="åˆ é™¤-1"><a href="#åˆ é™¤-1" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h4><p>delete_by_query</p><div class="code-wrapper"><pre><code class="hljs python">query = &#123;<span class="hljs-string">&#x27;query&#x27;</span>: &#123;<span class="hljs-string">&#x27;match&#x27;</span>: &#123;<span class="hljs-string">&#x27;sex&#x27;</span>: <span class="hljs-string">&#x27;famale&#x27;</span>&#125;&#125;&#125;<span class="hljs-comment"># åˆ é™¤æ€§åˆ«ä¸ºå¥³æ€§çš„æ‰€æœ‰æ–‡æ¡£</span>query = &#123;<span class="hljs-string">&#x27;query&#x27;</span>: &#123;<span class="hljs-string">&#x27;range&#x27;</span>: &#123;<span class="hljs-string">&#x27;age&#x27;</span>: &#123;<span class="hljs-string">&#x27;lt&#x27;</span>: <span class="hljs-number">11</span>&#125;&#125;&#125;&#125;<span class="hljs-comment"># åˆ é™¤å¹´é¾„å°äº11çš„æ‰€æœ‰æ–‡æ¡£</span>es.delete_by_query(index=<span class="hljs-string">&#x27;indexName&#x27;</span>, body=query, doc_type=<span class="hljs-string">&#x27;typeName&#x27;</span>)</code></pre></div><h4 id="æ›´æ–°-1"><a href="#æ›´æ–°-1" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h4><p>update_by_query</p><div class="code-wrapper"><pre><code class="hljs python">query = &#123;            <span class="hljs-string">&quot;script&quot;</span>: &#123;            <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;painless&quot;</span>,            <span class="hljs-comment"># &quot;inline&quot;: &quot;if (ctx._source.test_code == null) &#123;ctx._source.test_code= &#x27;02&#x27;&#125;&quot;</span>            <span class="hljs-string">&quot;inline&quot;</span>: <span class="hljs-string">&quot;ctx._source.kw_sourceType= &#x27;trueTime&#x27;&quot;</span>   <span class="hljs-comment">#æ–°å¢å­—æ®µkw_sourceTypeå€¼ä¸ºtrueTime</span>              &#125;            &#125;res = es.update_by_query(index=<span class="hljs-string">&quot;hot_rank&quot;</span>, doc_type=<span class="hljs-string">&quot;baidu_hot_search_rank&quot;</span>, body=query)</code></pre></div><h3 id="9-5-å®Œæ•´æµ‹è¯•å·¥ç¨‹ä»£ç "><a href="#9-5-å®Œæ•´æµ‹è¯•å·¥ç¨‹ä»£ç " class="headerlink" title="9.5 å®Œæ•´æµ‹è¯•å·¥ç¨‹ä»£ç "></a>9.5 å®Œæ•´æµ‹è¯•å·¥ç¨‹ä»£ç </h3><div class="code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> elasticsearch <span class="hljs-keyword">import</span> Elasticsearch<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<span class="hljs-comment">#from elasticsearch import AsyncElasticsearch</span><span class="hljs-comment">#es = Elasticsearch(host=&quot;localhost&quot;, port=9200)</span>es = Elasticsearch(    [        &#123;<span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>: <span class="hljs-number">9200</span>&#125;,    ],    http_auth=(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;secret&quot;</span>),    timeout=<span class="hljs-number">3600</span>)body = &#123;    <span class="hljs-string">&quot;settings&quot;</span>: &#123;        <span class="hljs-string">&quot;number_of_shards&quot;</span>: <span class="hljs-number">3</span>,        <span class="hljs-string">&quot;number_of_replicas&quot;</span>: <span class="hljs-number">2</span>    &#125;,    <span class="hljs-string">&quot;mappings&quot;</span>:&#123;        <span class="hljs-comment"># &quot;_doc&quot;:&#123;</span>        <span class="hljs-string">&quot;properties&quot;</span>:&#123;            <span class="hljs-string">&quot;id&quot;</span>:&#123;                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span>,            &#125;,            <span class="hljs-string">&quot;text&quot;</span>: &#123;                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,                <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,  <span class="hljs-comment">#æŒ‡å®šikåˆ†è¯å™¨ï¼Œé€‚ç”¨ä¸­æ–‡åˆ†è¯ã€‚</span>                <span class="hljs-string">&quot;index&quot;</span>:<span class="hljs-literal">False</span>            &#125;,            <span class="hljs-string">&quot;userId&quot;</span>: &#123;                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span>,            &#125;,            <span class="hljs-string">&quot;reprinted&quot;</span>: &#123;                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,            &#125;,        &#125;        <span class="hljs-comment"># &#125;</span>    &#125;&#125;<span class="hljs-comment">#åˆ›å»º index</span><span class="hljs-comment">#es.indices.create(index = &quot;testpy&quot;, body = body)</span><span class="hljs-comment">#åˆ é™¤ index</span><span class="hljs-comment">#es.indices.delete(index = &#x27;test&#x27;)</span><span class="hljs-comment">#æ’å…¥æ•°æ®</span><span class="hljs-comment">#es.index(index = &quot;testpy&quot;, doc_type = &quot;_doc&quot;, id = 1, body = &#123;&quot;id&quot;:1, &quot;name&quot;:&quot;å°æ˜&quot;&#125;)</span><span class="hljs-comment">#å¯ä»¥ä¸ç”¨æŒ‡å®šidï¼Œcreateä¼šè‡ªåŠ¨æ·»åŠ idã€‚</span><span class="hljs-comment">#es.create(index=&quot;testpy&quot;, doc_type = &quot;_doc&quot;,id = 2, body = &#123;&quot;id&quot;:2, &quot;name&quot;:&quot;å°çº¢&quot;&#125;)</span><span class="hljs-string">&#x27;&#x27;&#x27;doc = &#123;</span><span class="hljs-string">    &#x27;author&#x27;: &#x27;author_name&#x27;,</span><span class="hljs-string">    &#x27;text&#x27;: &#x27;Interensting content...&#x27;,</span><span class="hljs-string">    &#x27;timestamp&#x27;: datetime.now(),</span><span class="hljs-string">&#125;&#x27;&#x27;&#x27;</span>res = es.get(index=<span class="hljs-string">&quot;testpy&quot;</span>, <span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>)<span class="hljs-comment">#es.search(index = &quot;test&quot;, doc_type = &quot;_doc&quot;, body = query)</span><span class="hljs-built_in">print</span>(res[<span class="hljs-string">&#x27;_source&#x27;</span>])</code></pre></div>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Distributed/">Distributed</category>
      
      
      <category domain="https://pncalbl.github.io/tags/ElasticSearch/">ElasticSearch</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/25/ElasticSearch%E5%AD%A6%E4%B9%A0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Kafka å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/</link>
      <guid>https://pncalbl.github.io/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/</guid>
      <pubDate>Mon, 24 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Kafka-å­¦ä¹ &quot;&gt;&lt;a href=&quot;#Kafka-å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;Kafka å­¦ä¹ &quot;&gt;&lt;/a&gt;Kafka å­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;1-Kafka-å…¥é—¨&quot;&gt;&lt;a href=&quot;#1-Kafka-å…¥é—¨&quot; class=&quot;</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Kafka-å­¦ä¹ "><a href="#Kafka-å­¦ä¹ " class="headerlink" title="Kafka å­¦ä¹ "></a>Kafka å­¦ä¹ </h1><h2 id="1-Kafka-å…¥é—¨"><a href="#1-Kafka-å…¥é—¨" class="headerlink" title="1 Kafka å…¥é—¨"></a>1 Kafka å…¥é—¨</h2><h3 id="1-1-æ–‡æ¡£"><a href="#1-1-æ–‡æ¡£" class="headerlink" title="1.1 æ–‡æ¡£"></a>1.1 æ–‡æ¡£</h3><ul><li><p><a href="http://kafka.apache.org/">Kafkaå®˜ç½‘ä¸»é¡µ</a></p></li><li><p><a href="http://kafka.apache.org/documentation/">Kafkaå®˜æ–¹æ–‡æ¡£</a></p></li></ul><h3 id="1-2-ä»€ä¹ˆæ˜¯-Kafka"><a href="#1-2-ä»€ä¹ˆæ˜¯-Kafka" class="headerlink" title="1.2 ä»€ä¹ˆæ˜¯ Kafka"></a>1.2 ä»€ä¹ˆæ˜¯ Kafka</h3><p>Kafka æ˜¯ä¸€ä¸ª<strong>åˆ†å¸ƒå¼</strong>çš„åŸºäº<strong>å‘å¸ƒ/è®¢é˜…æ¨¡å¼</strong>çš„<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼ˆMessage Queueï¼‰ï¼Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®å®æ—¶å¤„ç†é¢†åŸŸã€‚</p><h3 id="1-3-æ¶ˆæ¯é˜Ÿåˆ—"><a href="#1-3-æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="1.3 æ¶ˆæ¯é˜Ÿåˆ—"></a>1.3 æ¶ˆæ¯é˜Ÿåˆ—</h3><h4 id="ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯"><a href="#ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯" class="headerlink" title="ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯"></a>ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯</h4><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/01.png" alt></p><h4 id="ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å¥½å¤„"><a href="#ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å¥½å¤„" class="headerlink" title="ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å¥½å¤„"></a>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å¥½å¤„</h4><ol><li><p>è§£è€¦ï¼ˆç±»ä¼¼Springçš„IOCï¼‰</p><p>å…è®¸ä½ ç‹¬ç«‹çš„æ‰©å±•æˆ–ä¿®æ”¹ä¸¤è¾¹çš„å¤„ç†è¿‡ç¨‹ï¼Œåªè¦ç¡®ä¿å®ƒä»¬éµå®ˆåŒæ ·çš„æ¥å£çº¦æŸã€‚</p></li><li><p>å¯æ¢å¤æ€§</p><p>ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ç»„ä»¶å¤±æ•ˆæ—¶ï¼Œä¸ä¼šå½±å“åˆ°æ•´ä¸ªç³»ç»Ÿã€‚æ¶ˆæ¯é˜Ÿåˆ—é™ä½äº†è¿›ç¨‹é—´çš„è€¦åˆåº¦ï¼Œæ‰€ä»¥å³ä½¿ä¸€ä¸ªå¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹æŒ‚æ‰ï¼ŒåŠ å…¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä»ç„¶å¯ä»¥åœ¨ç³»ç»Ÿæ¢å¤åè¢«å¤„ç†ã€‚</p></li><li><p>ç¼“å†²</p><p>æœ‰åŠ©äºæ§åˆ¶å’Œä¼˜åŒ–æ•°æ®æµç»è¿‡ç³»ç»Ÿçš„é€Ÿåº¦ï¼Œ è§£å†³ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯çš„å¤„ç†é€Ÿåº¦ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p></li><li><p>çµæ´»æ€§ &amp; å³°å€¼å¤„ç†èƒ½åŠ›ï¼ˆå‰Šå³°ï¼‰</p><p>åœ¨è®¿é—®é‡å‰§å¢çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ä»ç„¶éœ€è¦ç»§ç»­å‘æŒ¥ä½œç”¨ï¼Œä½†æ˜¯è¿™æ ·çš„çªå‘æµé‡å¹¶ä¸å¸¸è§ã€‚å¦‚æœä¸ºä»¥èƒ½å¤„ç†è¿™ç±»å³°å€¼è®¿é—®ä¸ºæ ‡å‡†æ¥æŠ•å…¥èµ„æºéšæ—¶å¾…å‘½æ— ç–‘æ˜¯å·¨å¤§çš„æµªè´¹ã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¤Ÿä½¿å…³é”®ç»„ä»¶é¡¶ä½çªå‘çš„è®¿é—®å‹åŠ›ï¼Œè€Œä¸ä¼šå› ä¸ºçªå‘çš„è¶…è´Ÿè·çš„è¯·æ±‚è€Œå®Œå…¨å´©æºƒã€‚</p></li><li><p>å¼‚æ­¥é€šä¿¡</p><p>å¾ˆå¤šæ—¶å€™ï¼Œç”¨æˆ·ä¸æƒ³ä¹Ÿä¸éœ€è¦ç«‹å³å¤„ç†æ¶ˆæ¯ã€‚æ¶ˆæ¯é˜Ÿåˆ—æä¾›äº†å¼‚æ­¥å¤„ç†æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·æŠŠä¸€ä¸ªæ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ï¼Œä½†å¹¶ä¸ç«‹å³å¤„ç†å®ƒã€‚æƒ³å‘é˜Ÿåˆ—ä¸­æ”¾å…¥å¤šå°‘æ¶ˆæ¯å°±æ”¾å¤šå°‘ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™å†å»å¤„ç†å®ƒä»¬ã€‚</p></li></ol><h3 id="1-4-æ¶ˆè´¹æ¨¡å¼"><a href="#1-4-æ¶ˆè´¹æ¨¡å¼" class="headerlink" title="1.4 æ¶ˆè´¹æ¨¡å¼"></a>1.4 æ¶ˆè´¹æ¨¡å¼</h3><p>æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å¼</p><h4 id="1-4-1-ç‚¹å¯¹ç‚¹æ¨¡å¼"><a href="#1-4-1-ç‚¹å¯¹ç‚¹æ¨¡å¼" class="headerlink" title="1.4.1 ç‚¹å¯¹ç‚¹æ¨¡å¼"></a>1.4.1 ç‚¹å¯¹ç‚¹æ¨¡å¼</h4><p><strong>ä¸€å¯¹ä¸€ï¼Œæ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–æ•°æ®ï¼Œæ¶ˆæ¯æ”¶åˆ°åæ¶ˆæ¯æ¸…é™¤</strong></p><p>æ¶ˆæ¯ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å‘é€åˆ°Queueä¸­ï¼Œç„¶åæ¶ˆæ¯æ¶ˆè´¹è€…ä»Queueä¸­å–å‡ºå¹¶ä¸”æ¶ˆè´¹æ¶ˆæ¯ã€‚æ¶ˆæ¯è¢«æ¶ˆè´¹ä»¥åï¼Œ queue ä¸­ä¸å†æœ‰å­˜å‚¨ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¶ˆè´¹è€…ä¸å¯èƒ½æ¶ˆè´¹åˆ°å·²ç»è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚Queue æ”¯æŒå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œåªä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ã€‚</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/02.png" alt></p><h4 id="1-4-2-å‘å¸ƒ-è®¢é˜…æ¨¡å¼"><a href="#1-4-2-å‘å¸ƒ-è®¢é˜…æ¨¡å¼" class="headerlink" title="1.4.2 å‘å¸ƒ/è®¢é˜…æ¨¡å¼"></a>1.4.2 å‘å¸ƒ/è®¢é˜…æ¨¡å¼</h4><p><strong>ä¸€å¯¹å¤šï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ä¹‹åä¸ä¼šæ¸…é™¤æ¶ˆæ¯</strong></p><p>æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆå‘å¸ƒï¼‰å°†æ¶ˆæ¯å‘å¸ƒåˆ° topic ä¸­ï¼ŒåŒæ—¶æœ‰å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆè®¢é˜…ï¼‰æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚å’Œç‚¹å¯¹ç‚¹æ–¹å¼ä¸åŒï¼Œå‘å¸ƒåˆ° topic çš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…è€…æ¶ˆè´¹ã€‚</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/03.png" alt></p><h3 id="1-5-åŸºç¡€æ¶æ„"><a href="#1-5-åŸºç¡€æ¶æ„" class="headerlink" title="1.5 åŸºç¡€æ¶æ„"></a>1.5 åŸºç¡€æ¶æ„</h3><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/04.png" alt></p><ol><li><strong>Producer</strong> ï¼š æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯å‘ Kafka ï¼›</li><li><strong>Consumer</strong> ï¼š æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå‘ Kafka broker å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼›</li><li><strong>Consumer Group ï¼ˆCGï¼‰</strong>ï¼š æ¶ˆè´¹è€…ç»„ï¼Œç”±å¤šä¸ª consumer ç»„æˆã€‚ æ¶ˆè´¹è€…ç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹ä¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œä¸€ä¸ªåˆ†åŒºåªèƒ½ç”±ä¸€ä¸ªç»„å†…æ¶ˆè´¹è€…æ¶ˆè´¹ï¼›æ¶ˆè´¹è€…ç»„ä¹‹é—´äº’ä¸å½±å“ã€‚ æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å±äºæŸä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯é€»è¾‘ä¸Šçš„ä¸€ä¸ªè®¢é˜…è€…ã€‚</li><li><strong>Broker</strong> ï¼šç»çºªäºº ä¸€å° Kafka æœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ª brokerå¯ä»¥å®¹çº³å¤šä¸ª topicã€‚</li><li><strong>Topic</strong> ï¼š è¯é¢˜ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œ ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é¢å‘çš„éƒ½æ˜¯ä¸€ä¸ª topicï¼›</li><li><strong>Partition</strong>ï¼š ä¸ºäº†å®ç°æ‰©å±•æ€§ï¼Œä¸€ä¸ªéå¸¸å¤§çš„ topic å¯ä»¥åˆ†å¸ƒåˆ°å¤šä¸ª brokerï¼ˆå³æœåŠ¡å™¨ï¼‰ä¸Šï¼Œä¸€ä¸ª topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ï¼›</li><li><strong>Replica</strong>ï¼š å‰¯æœ¬ï¼ˆReplicationï¼‰ï¼Œä¸ºä¿è¯é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œ è¯¥èŠ‚ç‚¹ä¸Šçš„ partition æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸” Kafkaä»ç„¶èƒ½å¤Ÿç»§ç»­å·¥ä½œï¼Œ Kafka æä¾›äº†å‰¯æœ¬æœºåˆ¶ï¼Œä¸€ä¸ª topic çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ª leader å’Œè‹¥å¹²ä¸ª followerã€‚</li><li><strong>Leader</strong>ï¼š æ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬çš„â€œä¸»â€ï¼Œç”Ÿäº§è€…å‘é€æ•°æ®çš„å¯¹è±¡ï¼Œä»¥åŠæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„å¯¹è±¡éƒ½æ˜¯ leaderã€‚</li><li><strong>Follower</strong>ï¼š æ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„â€œä»â€ï¼Œå®æ—¶ä» leader ä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œ leader æ•°æ®çš„åŒæ­¥ã€‚ leader å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸä¸ª Follower ä¼šæˆä¸ºæ–°çš„ leaderã€‚</li></ol><blockquote><p>  replica è‹± [ËˆreplÉªkÉ™] ç¾ [ËˆreplÉªkÉ™] n.å¤åˆ¶å“;ä»¿åˆ¶å“</p></blockquote><blockquote><p>  topic è‹± [ËˆtÉ’pÉªk] ç¾ [ËˆtÉ‘ËpÉªk] n.è¯é¢˜;é¢˜ç›®;æ ‡é¢˜</p></blockquote><h3 id="1-6-å®‰è£…-amp-å¯åŠ¨-amp-å…³é—­"><a href="#1-6-å®‰è£…-amp-å¯åŠ¨-amp-å…³é—­" class="headerlink" title="1.6 å®‰è£…&amp;å¯åŠ¨&amp;å…³é—­"></a>1.6 å®‰è£…&amp;å¯åŠ¨&amp;å…³é—­</h3><h4 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h4><p>æœ¬æ¬¡å®‰è£…å­¦ä¹ åœ¨Windowsæ“ä½œç³»ç»Ÿè¿›è¡Œã€‚ï¼ˆLinuxç‰ˆæœ¬çš„å·®åˆ«ä¸å¤§ï¼Œè¿è¡Œè„šæœ¬æ–‡ä»¶åç¼€ä»<code>bat</code>æ”¹ä¸º<code>sh</code>ï¼Œé…ç½®è·¯å¾„æ”¹ç”¨Unixé£æ ¼çš„ï¼‰</p><p><a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23quickstart">æœ¬èŠ‚æ•™ç¨‹æ¥æº</a></p><h4 id="Step-1-Download-the-code"><a href="#Step-1-Download-the-code" class="headerlink" title="Step 1: Download the code"></a>Step 1: Download the code</h4><p><a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2Fdownloads">ä¸‹è½½ä»£ç </a>å¹¶è§£å‹</p><p>ä¸‹è½½<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Farchive.apache.org%2Fdist%2Fkafka%2F0.11.0.0%2Fkafka_2.11-0.11.0.0.tgz">kafka 0.11.0.0</a>ç‰ˆæœ¬ï¼Œè§£å‹åˆ°<code>C:\Kafka\</code>è·¯å¾„ä¸‹ï¼ŒKafkaä¸»ç›®å½•æ–‡ä»¶ä¸º<code>C:\Kafka\kafka_2.11-0.11.0.0</code>ï¼ˆä¸‹æ–‡ç”¨KAFKA_HOMEè¡¨ç¤ºï¼‰ã€‚</p><h4 id="Step-2-Start-the-server"><a href="#Step-2-Start-the-server" class="headerlink" title="Step 2: Start the server"></a>Step 2: Start the server</h4><p>Kafka ç”¨åˆ° ZooKeeper åŠŸèƒ½ï¼Œæ‰€ä»¥è¦é¢„å…ˆè¿è¡ŒZooKeeperã€‚äº†è§£æ›´å¤šZooKeeperä¿¡æ¯ï¼Œå¯ç‚¹å‡»é˜…è¯»<a href="https://my.oschina.net/jallenkwong/blog/4405741">ZooKeeperå­¦ä¹ ç¬”è®°</a>ã€‚</p><ul><li>é¦–å…ˆï¼Œä¿®æ”¹<code>%KAFKA_HOME%\conf\zookeeper.properties</code>ä¸­çš„<code>dataDir=/tmp/zookeeper</code>ï¼Œæ”¹ä¸º<code>dataDir=C:\\Kafka\\data\\zookeeper</code>ã€‚</li><li>åˆ›å»ºæ–°ç›®å½•<code>C:\\Kafka\\data\\zookeeper</code>ã€‚</li><li>å¯åŠ¨cmdï¼Œå·¥ä½œç›®å½•åˆ‡æ¢åˆ°<code>%KAFKA_HOME%</code>ï¼Œæ‰§è¡Œå‘½ä»¤è¡Œï¼š</li></ul><div class="code-wrapper"><pre><code class="hljs bat"><span class="hljs-built_in">start</span> bin\windows\zookeeper-server-<span class="hljs-built_in">start</span>.bat config\zookeeper.properties</code></pre></div><ul><li>ä¿®æ”¹<code>%KAFKA_HOME%\conf\server.properties</code>ä¸­çš„<code>log.dirs=/tmp/kafka-logs</code>ï¼Œæ”¹ä¸º<code>log.dirs=C:\\Kafka\\data\\kafka-logs</code>ã€‚</li><li>åˆ›å»ºæ–°ç›®å½•<code>C:\\Kafka\\data\\kafka-logs</code>ã€‚</li><li>å¦å¯åŠ¨cmdï¼Œå·¥ä½œç›®å½•åˆ‡æ¢åˆ°<code>%KAFKA_HOME%</code>ï¼Œæ‰§è¡Œå‘½ä»¤è¡Œï¼š</li></ul><div class="code-wrapper"><pre><code class="hljs bat"><span class="hljs-built_in">start</span> bin\windows\kafka-server-<span class="hljs-built_in">start</span>.bat config\server.properties</code></pre></div><ul><li><p>å¯å†™ä¸€è„šæœ¬ï¼Œä¸€é”®å¯åŠ¨</p></li><li><p>å…³é—­æœåŠ¡ï¼Œ<code>bin\windows\kafka-server-stop.bat</code>å’Œ<code>bin\windows\zookeeper-server-stop.bat</code></p></li></ul><p>TODO:<strong>ä¸€ä¸ªé—®é¢˜</strong>ï¼Œé€šè¿‡<code>kafka-server-stop.bat</code>æˆ–å³ä¸Šè§’å…³é—­æŒ‰é’®æ¥å…³é—­KafkaæœåŠ¡åï¼Œé©¬ä¸Šä¸‹æ¬¡å†å¯åŠ¨Kafkaï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè¯´æŸæ–‡ä»¶è¢«å ç”¨ï¼Œéœ€æ¸…ç©º<code>log.dirs</code>ç›®å½•ä¸‹æ–‡ä»¶ï¼Œæ‰èƒ½é‡å¯Kafkaã€‚</p><div class="code-wrapper"><pre><code class="hljs shell">[2020-07-21 21:43:26,755] ERROR There was an error in one of the threads during logs loading: java.nio.file.FileSystemException: C:\Kafka\data\kafka-logs-0\my-replicated-topic-0\00000000000000000000.timeindex: å¦ä¸€ä¸ªç¨‹åºæ­£åœ¨ä½¿ç”¨æ­¤æ–‡ä»¶ï¼Œè¿›ç¨‹æ— æ³•è®¿é—®ã€‚ (kafka.log.LogManager)...</code></pre></div><p>å‚é˜…ç½‘ç»œï¼Œè¿™å¯èƒ½æ˜¯åœ¨windowsä¸‹çš„ä¸€ä¸ªBugï¼Œæ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæš‚æ—¶å†™ä¸ªpyè„šæœ¬ç”¨æ¥å¯¹kafkaçš„logæ–‡ä»¶è¿›è¡Œåˆ é™¤ã€‚ä¸‹æ¬¡å¯åŠ¨kafkaï¼Œå…ˆè¿è¡Œè¿™ä¸ªåˆ é™¤è„šæœ¬å§ã€‚</p><p><strong>å¥½æ¶ˆæ¯</strong>ï¼Œå½“ä½ æˆåŠŸå¯åŠ¨kafkaï¼Œç„¶ååœ¨å¯¹åº”çš„å‘½ä»¤è¡Œçª—å£ç”¨<code>Ctrl + C</code>ç»“æŸKakfaï¼Œä¸‹æ¬¡ä¸ç”¨æ¸…ç†kafkaæ—¥å¿—ï¼Œä¹Ÿèƒ½æ­£å¸¸å¯åŠ¨ã€‚</p><h4 id="Step-3-Create-a-topic"><a href="#Step-3-Create-a-topic" class="headerlink" title="Step 3: Create a topic"></a>Step 3: Create a topic</h4><ul><li>ç”¨å•ä¸€partitionå’Œå•ä¸€replicaåˆ›å»ºä¸€ä¸ªåä¸º<code>test</code>çš„topic:</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --create --zookeeper localhost:<span class="hljs-number">2181</span> --replication-factor <span class="hljs-number">1</span> --partitions <span class="hljs-number">1</span> --topic test</code></pre></div><ul><li>æŸ¥çœ‹å·²åˆ›å»ºçš„topicï¼Œä¹Ÿå°±åˆšæ‰åˆ›å»ºçš„åä¸º<code>test</code>çš„topicï¼š</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --list --zookeeper localhost:<span class="hljs-number">2181</span></code></pre></div><p>æˆ–è€…ï¼Œä½ å¯é…ç½®ä½ çš„brokerå»è‡ªåŠ¨åˆ›å»ºæœªæ›¾å‘å¸ƒè¿‡çš„topicï¼Œä»£æ›¿æ‰‹åŠ¨åˆ›å»ºtopic</p><h4 id="Step-4-Send-some-messages"><a href="#Step-4-Send-some-messages" class="headerlink" title="Step 4: Send some messages"></a>Step 4: Send some messages</h4><p>è¿è¡Œproducerï¼Œç„¶åè¾“å…¥å‡ è¡Œæ–‡æœ¬ï¼Œå‘è‡³æœåŠ¡å™¨ï¼š</p><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-producer.bat --broker-list localhost:<span class="hljs-number">9092</span> --topic test&gt;hello, kafka.&gt;what a nice day!&gt;to be or <span class="hljs-keyword">not</span> to be. that&#x27; s a question.</code></pre></div><p>è¯·å‹¿å…³é—­çª—å£ï¼Œä¸‹é¢æ­¥éª¤éœ€è¦ç”¨åˆ°</p><h4 id="Step-5-Start-a-consumer"><a href="#Step-5-Start-a-consumer" class="headerlink" title="Step 5: Start a consumer"></a>Step 5: Start a consumer</h4><p>è¿è¡Œconsumerï¼Œå°†Step 4ä¸­è¾“å…¥çš„å‡ è¡Œå¥å­ï¼Œæ ‡å‡†è¾“å‡ºã€‚</p><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:<span class="hljs-number">9092</span> --topic test --from-beginninghello, kafka.what a nice day!to be or <span class="hljs-keyword">not</span> to be. that&#x27; s a question.</code></pre></div><p>è‹¥ä½ å¦å¯cmdï¼Œæ‰§è¡Œå‘½ä»¤è¡Œ<code>bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic test --from-beginning</code>æ¥è¿è¡Œconsumerï¼Œç„¶ååœ¨<a href="https://my.oschina.net/jallenkwong/blog/4449224#">Step 4</a>ä¸­producerçª—å£è¾“å…¥ä¸€è¡Œå¥å­ï¼Œå¦‚<code>I must admit, I can&#39;t help but feel a twinge of envy.</code>ï¼Œä¸¤ä¸ªconsumerä¹Ÿä¼šåŒæ—¶è¾“å‡º<code>I must admit, I can&#39;t help but feel a twinge of envy.</code>ã€‚</p><h4 id="Step-6-Setting-up-a-multi-broker-cluster"><a href="#Step-6-Setting-up-a-multi-broker-cluster" class="headerlink" title="Step 6: Setting up a multi-broker cluster"></a>Step 6: Setting up a multi-broker cluster</h4><p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»…ä½œä¸ºä¸€ä¸ªå•ä¸€brokerï¼Œè¿™ä¸å¥½ç©ã€‚è®©æˆ‘ä»¬å¼„ä¸ªæœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤æ¥ç©ç©ã€‚</p><ul><li>é¦–å…ˆï¼Œåœ¨<code>%KAFKA%\config\server.properties</code>çš„åŸºç¡€ä¸Šåˆ›å»ºä¸¤ä¸ªå‰¯æœ¬<code>server-1.properties</code>å’Œ<code>server-2.properties</code>ã€‚</li></ul><div class="code-wrapper"><pre><code class="hljs bat"><span class="hljs-built_in">copy</span> config\server.properties config\server-<span class="hljs-number">1</span>.properties<span class="hljs-built_in">copy</span> config\server.properties config\server-<span class="hljs-number">2</span>.properties</code></pre></div><ul><li>æ‰“å¼€å‰¯æœ¬ï¼Œç¼–è¾‘å¦‚ä¸‹å±æ€§</li></ul><div class="code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment">#config/server-1.properties:</span><span class="hljs-meta">broker.id</span>=<span class="hljs-string">1</span><span class="hljs-attr">listeners</span>=<span class="hljs-string">PLAINTEXT://127.0.0.1:9093</span><span class="hljs-meta">log.dir</span>=<span class="hljs-string">C:\\Kafka\\data\\kafka-logs-1</span> <span class="hljs-comment">#config/server-2.properties:</span><span class="hljs-meta">broker.id</span>=<span class="hljs-string">2</span><span class="hljs-attr">listeners</span>=<span class="hljs-string">PLAINTEXT://127.0.0.1:9094</span><span class="hljs-meta">log.dir</span>=<span class="hljs-string">C:\\Kafka\\data\\kafka-logs-2</span></code></pre></div><p>è¿™ä¸ª<code>broker.id</code>å±æ€§æ˜¯é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å”¯ä¸€æ°¸ä¹…çš„åç§°ã€‚</p><p>æˆ‘ä»¬å¿…é¡»é‡å†™ç«¯å£å’Œæ—¥å¿—ç›®å½•ï¼Œåªæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œå®ƒä»¬ï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›é˜»æ­¢brokersè¯•å›¾åœ¨åŒä¸€ä¸ªç«¯å£ä¸Šæ³¨å†Œæˆ–è¦†ç›–å½¼æ­¤çš„æ•°æ®ã€‚</p><ul><li>æˆ‘ä»¬å·²ç»å¯åŠ¨äº†Zookeeperå’Œæˆ‘ä»¬çš„å•ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å¯åŠ¨ä¸¤ä¸ªæ–°èŠ‚ç‚¹ï¼š</li></ul><div class="code-wrapper"><pre><code class="hljs bat"><span class="hljs-built_in">start</span> bin\windows\kafka-server-<span class="hljs-built_in">start</span>.bat config\server-<span class="hljs-number">1</span>.properties<span class="hljs-built_in">start</span> bin\windows\kafka-server-<span class="hljs-built_in">start</span>.bat config\server-<span class="hljs-number">2</span>.properties</code></pre></div><ul><li>åˆ›å»ºä¸€ä¸ªreplication-factorä¸º3çš„topic:</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --create --zookeeper localhost:<span class="hljs-number">2181</span> --replication-factor <span class="hljs-number">3</span> --partitions <span class="hljs-number">1</span> --topic my-replicated-topic</code></pre></div><ul><li>OKï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªé›†ç¾¤ï¼Œä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆçŸ¥é“å“ªä¸ªbrokeråœ¨åšä»€ä¹ˆå‘¢ï¼Ÿé‚£å°±è¿è¡Œ<code>describe topics</code>å‘½ä»¤ï¼š</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --describe --zookeeper localhost:<span class="hljs-number">2181</span> --topic my-replicated-topic<span class="hljs-function">Topic:<span class="hljs-title">my</span>-<span class="hljs-title">replicated</span>-<span class="hljs-title">topic</span>       <span class="hljs-title">PartitionCount</span>:1        <span class="hljs-title">ReplicationFactor</span>:3</span><span class="hljs-function"><span class="hljs-title">Configs</span>:</span><span class="hljs-function"><span class="hljs-title">Topic</span>: <span class="hljs-title">my</span>-<span class="hljs-title">replicated</span>-<span class="hljs-title">topic</span>      <span class="hljs-title">Partition</span>: 0    <span class="hljs-title">Leader</span>: 0       </span><span class="hljs-function"><span class="hljs-title">Replicas</span>: 0,1,2        <span class="hljs-title">Isr</span>: 0,1,2</span></code></pre></div><ul><li>ä»¥ä¸‹æ˜¯è¾“å‡ºçš„è¯´æ˜ã€‚ç¬¬ä¸€è¡Œç»™å‡ºæ‰€æœ‰Partitionçš„æ‘˜è¦ï¼Œæ¯ä¸€è¡Œæä¾›æœ‰å…³ä¸€ä¸ªPartitionçš„ä¿¡æ¯ã€‚å› ä¸ºè¿™ä¸ªTopicåªæœ‰ä¸€ä¸ªPartitionï¼Œæ‰€ä»¥åªæœ‰ä¸€è¡Œã€‚<ul><li>â€œleaderâ€æ˜¯è´Ÿè´£ç»™å®šPartitionçš„æ‰€æœ‰è¯»å†™çš„èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½æˆä¸ºPartitionéšæœºé€‰æ‹©çš„leaderã€‚</li><li>â€œreplicasâ€æ˜¯å¤åˆ¶æ­¤Partitionæ—¥å¿—çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ— è®ºå®ƒä»¬æ˜¯leaderè¿˜æ˜¯å½“å‰å¤„äºå­˜æ´»çŠ¶æ€ã€‚</li><li>â€œisrâ€æ˜¯ä¸€ç»„ â€œin-syncâ€ replicasã€‚è¿™æ˜¯replicasåˆ—è¡¨çš„ä¸€ä¸ªå­é›†ï¼Œå®ƒå½“å‰å¤„äºå­˜æ´»çŠ¶æ€ï¼Œå¹¶è¡¥å……leaderã€‚</li></ul></li></ul><p>æ³¨æ„ï¼Œ<strong>åœ¨æˆ‘çš„ç¤ºä¾‹ä¸­ï¼Œnode 0æ˜¯Topicå”¯ä¸€Partitionçš„leader</strong>ã€‚ï¼ˆä¸‹é¢æ“ä½œéœ€è¦ç”¨åˆ°ï¼‰</p><ul><li>è®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„æ–°Topicå‘å¸ƒä¸€äº›ä¿¡æ¯ï¼š</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-producer.bat --broker-list localhost:<span class="hljs-number">9092</span> --topic my-replicated-topic&gt;There&#x27;s sadness <span class="hljs-keyword">in</span> your eyes, I don&#x27;t want to say goodbye to you.&gt;Love is a big illusion, I should try to forget, but there&#x27;s something left <span class="hljs-keyword">in</span> my head.&gt;</code></pre></div><ul><li>è®©æˆ‘ä»¬æ¥æ”¶åˆšåˆšå‘å¸ƒçš„ä¿¡æ¯å§ï¼</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:<span class="hljs-number">9092</span> --from-beginning --topic my-replicated-topicThere&#x27;s sadness <span class="hljs-keyword">in</span> your eyes, I don&#x27;t want to say goodbye to you.Love is a big illusion, I should try to forget, but there&#x27;s something left <span class="hljs-keyword">in</span> my head.</code></pre></div><ul><li>è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹å®¹é”™æ€§ï¼Œç”±ä¸Šæ–‡å¯çŸ¥ï¼ŒBroker 0 èº«ä¸º leaderï¼Œå› æ­¤ï¼Œè®©æˆ‘ä»¬å¹²æ‰å®ƒå§ï¼š<ul><li>å…ˆæ‰¾å‡º Broker 0 çš„è¿›ç¨‹pidã€‚</li><li>æ€æ‰ Broker 0 çš„è¿›ç¨‹ã€‚</li></ul></li></ul><div class="code-wrapper"><pre><code class="hljs bat">wmic process where &quot;caption=&#x27;java.exe&#x27; and commandline like &#x27;<span class="hljs-variable">%server.properties%</span>&#x27;&quot; get processid,captionCaption   ProcessIdjava.exe  <span class="hljs-number">7528</span><span class="hljs-built_in">taskkill</span> /pid <span class="hljs-number">7528</span> /fæˆåŠŸ: å·²ç»ˆæ­¢ PID ä¸º <span class="hljs-number">7528</span> çš„è¿›ç¨‹ã€‚</code></pre></div><ul><li>åŸleaderå·²è¢«æ›¿æ¢æˆå®ƒçš„flowersä¸­çš„å…¶ä¸­ä¸€ä¸ªï¼Œå¹¶ä¸” node 0 ä¸åœ¨ in-sync replica é›†åˆå½“ä¸­ã€‚</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --describe --zookeeper localhost:<span class="hljs-number">2181</span> --topic my-replicated-topic<span class="hljs-function">Topic:<span class="hljs-title">my</span>-<span class="hljs-title">replicated</span>-<span class="hljs-title">topic</span>       <span class="hljs-title">PartitionCount</span>:1        <span class="hljs-title">ReplicationFactor</span>:3</span><span class="hljs-function"><span class="hljs-title">Configs</span>:</span><span class="hljs-function"><span class="hljs-title">Topic</span>: <span class="hljs-title">my</span>-<span class="hljs-title">replicated</span>-<span class="hljs-title">topic</span>      <span class="hljs-title">Partition</span>: 0    <span class="hljs-title">Leader</span>: 1       <span class="hljs-title">Replicas</span>: 0,1,2 <span class="hljs-title">Isr</span>: 1,2</span></code></pre></div><ul><li>å°½ç®¡åŸleaderå·²é€ï¼Œå½“åŸæ¥æ¶ˆæ¯ä¾ç„¶å¯ä»¥æ¥æ”¶ã€‚ï¼ˆæ³¨æ„ï¼Œå‚æ•°<code>--bootstrap-server localhost:9093</code>ï¼Œè€Œä¸æ˜¯<code>--bootstrap-server localhost:9092</code>ï¼‰</li></ul><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:<span class="hljs-number">9093</span> --from-beginning --topic my-replicated-topicThere&#x27;s sadness <span class="hljs-keyword">in</span> your eyes, I don&#x27;t want to say goodbye to you.Love is a big illusion, I should try to forget, but there&#x27;s something left <span class="hljs-keyword">in</span> my head.I don&#x27;t forget the way your kissing, the feeling &#x27;s so strong which is lasting <span class="hljs-keyword">for</span> so long.</code></pre></div><h4 id="server-propertiesä¸€ç¥"><a href="#server-propertiesä¸€ç¥" class="headerlink" title="server.propertiesä¸€ç¥"></a>server.propertiesä¸€ç¥</h4><div class="code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment">#broker çš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œä¸èƒ½é‡å¤</span><span class="hljs-meta">broker.id</span>=<span class="hljs-string">0</span><span class="hljs-comment">#åˆ é™¤ topic åŠŸèƒ½ä½¿èƒ½</span><span class="hljs-meta">delete.topic.enable</span>=<span class="hljs-string">true</span><span class="hljs-comment">#å¤„ç†ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹æ•°é‡</span><span class="hljs-meta">num.network.threads</span>=<span class="hljs-string">3</span><span class="hljs-comment">#ç”¨æ¥å¤„ç†ç£ç›˜ IO çš„ç°æˆæ•°é‡</span><span class="hljs-meta">num.io.threads</span>=<span class="hljs-string">8</span><span class="hljs-comment">#å‘é€å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span><span class="hljs-meta">socket.send.buffer.bytes</span>=<span class="hljs-string">102400</span><span class="hljs-comment">#æ¥æ”¶å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span><span class="hljs-meta">socket.receive.buffer.bytes</span>=<span class="hljs-string">102400</span><span class="hljs-comment">#è¯·æ±‚å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span><span class="hljs-meta">socket.request.max.bytes</span>=<span class="hljs-string">104857600</span><span class="hljs-comment">#kafka è¿è¡Œæ—¥å¿—å­˜æ”¾çš„è·¯å¾„</span><span class="hljs-meta">log.dirs</span>=<span class="hljs-string">/opt/module/kafka/logs</span><span class="hljs-comment">#topic åœ¨å½“å‰ broker ä¸Šçš„åˆ†åŒºä¸ªæ•°</span><span class="hljs-meta">num.partitions</span>=<span class="hljs-string">1</span><span class="hljs-comment">#ç”¨æ¥æ¢å¤å’Œæ¸…ç† data ä¸‹æ•°æ®çš„çº¿ç¨‹æ•°é‡</span><span class="hljs-meta">num.recovery.threads.per.data.dir</span>=<span class="hljs-string">1</span><span class="hljs-comment">#segment æ–‡ä»¶ä¿ç•™çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶å°†è¢«åˆ é™¤</span><span class="hljs-meta">log.retention.hours</span>=<span class="hljs-string">168</span><span class="hljs-comment">#é…ç½®è¿æ¥ Zookeeper é›†ç¾¤åœ°å€</span><span class="hljs-meta">zookeeper.connect</span>=<span class="hljs-string">hadoop102:2181,hadoop103:2181,hadoop104:2181</span></code></pre></div><h3 id="1-7-å‘½ä»¤è¡Œæ“ä½œTopicå¢åˆ æŸ¥"><a href="#1-7-å‘½ä»¤è¡Œæ“ä½œTopicå¢åˆ æŸ¥" class="headerlink" title="1.7 å‘½ä»¤è¡Œæ“ä½œTopicå¢åˆ æŸ¥"></a>1.7 å‘½ä»¤è¡Œæ“ä½œTopicå¢åˆ æŸ¥</h3><h4 id="æŸ¥çœ‹å½“å‰æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰-topic"><a href="#æŸ¥çœ‹å½“å‰æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰-topic" class="headerlink" title="æŸ¥çœ‹å½“å‰æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰ topic"></a>æŸ¥çœ‹å½“å‰æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰ topic</h4><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --list --zookeeper localhost:<span class="hljs-number">2181</span></code></pre></div><h4 id="åˆ›å»º-topic"><a href="#åˆ›å»º-topic" class="headerlink" title="åˆ›å»º topic"></a>åˆ›å»º topic</h4><div class="code-wrapper"><pre><code class="hljs brainfuck"><span class="hljs-comment">bin\windows\kafka</span><span class="hljs-literal">-</span><span class="hljs-comment">topics</span><span class="hljs-string">.</span><span class="hljs-comment">bat</span> --<span class="hljs-comment">create</span> --<span class="hljs-comment">zookeeper</span> <span class="hljs-comment">localhost:2181</span> --<span class="hljs-comment">replication</span><span class="hljs-literal">-</span><span class="hljs-comment">factor</span> <span class="hljs-comment">3</span> --<span class="hljs-comment">partitions</span> <span class="hljs-comment">1</span> --<span class="hljs-comment">topic</span> <span class="hljs-comment">my</span><span class="hljs-literal">-</span><span class="hljs-comment">replicated</span><span class="hljs-literal">-</span><span class="hljs-comment">topic</span></code></pre></div><p>é€‰é¡¹è¯´æ˜ï¼š</p><ul><li>â€“topic å®šä¹‰ topic å</li><li>â€“replication-factor å®šä¹‰å‰¯æœ¬æ•°</li><li>â€“partitions å®šä¹‰åˆ†åŒºæ•°</li></ul><blockquote><p>  ä¸ºäº†å®ç°æ‰©å±•æ€§ï¼Œä¸€ä¸ªéå¸¸å¤§çš„ topic å¯ä»¥åˆ†å¸ƒåˆ°å¤šä¸ª brokerï¼ˆå³æœåŠ¡å™¨ï¼‰ä¸Šï¼Œä¸€ä¸ª topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ï¼›</p><p>  a broker = a kafka server a broker can contain N topic a topic can contain N partition a broker can contain a part of a topic (a broker can contain M(N&gt;M) partition)</p></blockquote><h4 id="åˆ é™¤-topic"><a href="#åˆ é™¤-topic" class="headerlink" title="åˆ é™¤ topic"></a>åˆ é™¤ topic</h4><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --zookeeper localhost:<span class="hljs-number">2181</span> --delete --topic my-replicated-topic</code></pre></div><p>éœ€è¦ server.properties ä¸­è®¾ç½® <code>delete.topic.enable=true</code> å¦åˆ™åªæ˜¯æ ‡è®°åˆ é™¤ã€‚</p><h4 id="æŸ¥çœ‹æŸä¸ª-Topic-çš„è¯¦æƒ…"><a href="#æŸ¥çœ‹æŸä¸ª-Topic-çš„è¯¦æƒ…" class="headerlink" title="æŸ¥çœ‹æŸä¸ª Topic çš„è¯¦æƒ…"></a>æŸ¥çœ‹æŸä¸ª Topic çš„è¯¦æƒ…</h4><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --zookeeper localhost:<span class="hljs-number">2181</span> --describe --topic first</code></pre></div><h4 id="ä¿®æ”¹åˆ†åŒºæ•°"><a href="#ä¿®æ”¹åˆ†åŒºæ•°" class="headerlink" title="ä¿®æ”¹åˆ†åŒºæ•°"></a>ä¿®æ”¹åˆ†åŒºæ•°</h4><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-topics.bat --zookeeper localhost:<span class="hljs-number">2181</span> --alter --topic first --partitions <span class="hljs-number">6</span></code></pre></div><h3 id="1-8-å‘½ä»¤è¡Œæ§åˆ¶å°ç”Ÿäº§è€…æ¶ˆè´¹è€…æµ‹è¯•"><a href="#1-8-å‘½ä»¤è¡Œæ§åˆ¶å°ç”Ÿäº§è€…æ¶ˆè´¹è€…æµ‹è¯•" class="headerlink" title="1.8 å‘½ä»¤è¡Œæ§åˆ¶å°ç”Ÿäº§è€…æ¶ˆè´¹è€…æµ‹è¯•"></a>1.8 å‘½ä»¤è¡Œæ§åˆ¶å°ç”Ÿäº§è€…æ¶ˆè´¹è€…æµ‹è¯•</h3><h4 id="å‘é€æ¶ˆæ¯"><a href="#å‘é€æ¶ˆæ¯" class="headerlink" title="å‘é€æ¶ˆæ¯"></a>å‘é€æ¶ˆæ¯</h4><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-producer.bat --broker-list localhost:<span class="hljs-number">9092</span> --topic test&gt;hello, kafka.&gt;what a nice day!&gt;to be or <span class="hljs-keyword">not</span> to be. that&#x27; s a question.</code></pre></div><h4 id="æ¶ˆè´¹æ¶ˆæ¯"><a href="#æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="æ¶ˆè´¹æ¶ˆæ¯"></a>æ¶ˆè´¹æ¶ˆæ¯</h4><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:<span class="hljs-number">9092</span> --topic test --from-beginninghello, kafka.what a nice day!to be or <span class="hljs-keyword">not</span> to be. that&#x27; s a question.</code></pre></div><ul><li>â€“from-beginningï¼š ä¼šæŠŠä¸»é¢˜ä¸­ä»¥å¾€æ‰€æœ‰çš„æ•°æ®éƒ½è¯»å–å‡ºæ¥ã€‚</li></ul><h3 id="1-9-æ•°æ®æ—¥å¿—åˆ†ç¦»"><a href="#1-9-æ•°æ®æ—¥å¿—åˆ†ç¦»" class="headerlink" title="1.9 æ•°æ®æ—¥å¿—åˆ†ç¦»"></a>1.9 æ•°æ®æ—¥å¿—åˆ†ç¦»</h3><h3 id="1-10-å›é¡¾"><a href="#1-10-å›é¡¾" class="headerlink" title="1.10 å›é¡¾"></a>1.10 å›é¡¾</h3><h2 id="2-Kafkaé«˜çº§"><a href="#2-Kafkaé«˜çº§" class="headerlink" title="2 Kafkaé«˜çº§"></a>2 Kafkaé«˜çº§</h2><h3 id="2-1-å·¥ä½œæµç¨‹"><a href="#2-1-å·¥ä½œæµç¨‹" class="headerlink" title="2.1 å·¥ä½œæµç¨‹"></a>2.1 å·¥ä½œæµç¨‹</h3><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/05.png" alt></p><ul><li><p>Kafka ä¸­æ¶ˆæ¯æ˜¯ä»¥ topic è¿›è¡Œåˆ†ç±»çš„ï¼Œ producerç”Ÿäº§æ¶ˆæ¯ï¼Œconsumeræ¶ˆè´¹æ¶ˆæ¯ï¼Œéƒ½æ˜¯é¢å‘ topicçš„ã€‚(ä»å‘½ä»¤è¡Œæ“ä½œçœ‹å‡º)</p><div class="code-wrapper"><pre><code class="hljs shell">bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic testbin\windows\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic test --from-beginning</code></pre></div></li><li><p>topic æ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè€Œ partition æ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ª partition å¯¹åº”äºä¸€ä¸ª log æ–‡ä»¶ï¼Œè¯¥ log æ–‡ä»¶ä¸­å­˜å‚¨çš„å°±æ˜¯ producer ç”Ÿäº§çš„æ•°æ®ã€‚ï¼ˆtopic = N partitionï¼Œpartition = logï¼‰</p></li><li><p>Producer ç”Ÿäº§çš„æ•°æ®ä¼šè¢«ä¸æ–­è¿½åŠ åˆ°è¯¥log æ–‡ä»¶æœ«ç«¯ï¼Œä¸”æ¯æ¡æ•°æ®éƒ½æœ‰è‡ªå·±çš„ offsetã€‚ consumerç»„ä¸­çš„æ¯ä¸ªconsumerï¼Œ éƒ½ä¼šå®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ª offsetï¼Œä»¥ä¾¿å‡ºé”™æ¢å¤æ—¶ï¼Œä»ä¸Šæ¬¡çš„ä½ç½®ç»§ç»­æ¶ˆè´¹ã€‚ï¼ˆproducer -&gt; log with offset -&gt; consumer(s)ï¼‰</p></li></ul><h3 id="2-2-æ–‡ä»¶å­˜å‚¨"><a href="#2-2-æ–‡ä»¶å­˜å‚¨" class="headerlink" title="2.2 æ–‡ä»¶å­˜å‚¨"></a>2.2 æ–‡ä»¶å­˜å‚¨</h3><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/06.png" alt></p><ul><li><p>ç”±äºç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸æ–­è¿½åŠ åˆ° log æ–‡ä»¶æœ«å°¾ï¼Œ ä¸ºé˜²æ­¢ log æ–‡ä»¶è¿‡å¤§å¯¼è‡´æ•°æ®å®šä½æ•ˆç‡ä½ä¸‹ï¼Œ Kafka é‡‡å–äº†<strong>åˆ†ç‰‡</strong>å’Œ<strong>ç´¢å¼•</strong>æœºåˆ¶ï¼Œå°†æ¯ä¸ª partition åˆ†ä¸ºå¤šä¸ª segmentã€‚</p></li><li><p>æ¯ä¸ª segmentå¯¹åº”ä¸¤ä¸ªæ–‡ä»¶â€”â€”â€œ.indexâ€æ–‡ä»¶å’Œâ€œ.logâ€æ–‡ä»¶ã€‚ è¿™äº›æ–‡ä»¶ä½äºä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œ è¯¥æ–‡ä»¶å¤¹çš„å‘½åè§„åˆ™ä¸ºï¼š topic åç§°+åˆ†åŒºåºå·ã€‚ä¾‹å¦‚ï¼Œ first è¿™ä¸ª topic æœ‰ä¸‰ä¸ªåˆ†åŒºï¼Œåˆ™å…¶å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸º first-0,first-1,first-2ã€‚</p><div class="code-wrapper"><pre><code class="hljs shell">00000000000000000000.index00000000000000000000.log00000000000000170410.index00000000000000170410.log00000000000000239430.index00000000000000239430.log</code></pre></div></li><li><p>index å’Œ log æ–‡ä»¶ä»¥å½“å‰ segment çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ offset å‘½åã€‚ä¸‹å›¾ä¸º index æ–‡ä»¶å’Œ logæ–‡ä»¶çš„ç»“æ„ç¤ºæ„å›¾ã€‚</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/07.png" alt></p></li><li><p><strong>â€œ.indexâ€æ–‡ä»¶å­˜å‚¨å¤§é‡çš„ç´¢å¼•ä¿¡æ¯ï¼Œâ€œ.logâ€æ–‡ä»¶å­˜å‚¨å¤§é‡çš„æ•°æ®</strong>ï¼Œç´¢å¼•æ–‡ä»¶ä¸­çš„å…ƒæ•°æ®æŒ‡å‘å¯¹åº”æ•°æ®æ–‡ä»¶ä¸­ message çš„ç‰©ç†åç§»åœ°å€ã€‚</p><blockquote><p>  segment è‹± [ËˆseÉ¡mÉ™nt , seÉ¡Ëˆment] ç¾ [ËˆseÉ¡mÉ™nt , seÉ¡Ëˆment]<br>  n.éƒ¨åˆ†;ä»½;ç‰‡;æ®µ;(æŸ‘æ©˜ã€æŸ æª¬ç­‰çš„)ç“£;å¼“å½¢;åœ†ç¼º v.åˆ†å‰²;åˆ’åˆ†</p></blockquote></li></ul><h3 id="2-3-ç”Ÿäº§è€…åˆ†åŒºç­–ç•¥"><a href="#2-3-ç”Ÿäº§è€…åˆ†åŒºç­–ç•¥" class="headerlink" title="2.3 ç”Ÿäº§è€…åˆ†åŒºç­–ç•¥"></a>2.3 ç”Ÿäº§è€…åˆ†åŒºç­–ç•¥</h3><h4 id="1-åˆ†åŒºçš„åŸå› "><a href="#1-åˆ†åŒºçš„åŸå› " class="headerlink" title="1 åˆ†åŒºçš„åŸå› "></a>1 åˆ†åŒºçš„åŸå› </h4><ul><li><strong>æ–¹ä¾¿åœ¨é›†ç¾¤ä¸­æ‰©å±•</strong>ï¼Œæ¯ä¸ª Partition å¯ä»¥é€šè¿‡è°ƒæ•´ä»¥é€‚åº”å®ƒæ‰€åœ¨çš„æœºå™¨ï¼Œè€Œä¸€ä¸ª topicåˆå¯ä»¥æœ‰å¤šä¸ª Partition ç»„æˆï¼Œå› æ­¤æ•´ä¸ªé›†ç¾¤å°±å¯ä»¥é€‚åº”é€‚åˆçš„æ•°æ®äº†ï¼›</li><li><strong>å¯ä»¥æé«˜å¹¶å‘</strong>ï¼Œå› ä¸ºå¯ä»¥ä»¥ Partition ä¸ºå•ä½è¯»å†™äº†ã€‚ï¼ˆè”æƒ³åˆ°ConcurrentHashMapåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹è¯»å†™æ•ˆç‡æ¯”HashTableçš„é«˜æ•ˆï¼‰</li></ul><h4 id="2-åˆ†åŒºçš„åŸåˆ™"><a href="#2-åˆ†åŒºçš„åŸåˆ™" class="headerlink" title="2 åˆ†åŒºçš„åŸåˆ™"></a>2 åˆ†åŒºçš„åŸåˆ™</h4><p>æˆ‘ä»¬éœ€è¦å°† producer å‘é€çš„æ•°æ®å°è£…æˆä¸€ä¸ª <code>ProducerRecord</code> å¯¹è±¡ã€‚</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/08.png" alt></p><ol><li>æŒ‡æ˜ partition çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å°†æŒ‡æ˜çš„å€¼ç›´æ¥ä½œä¸º partiton å€¼ï¼›</li><li>æ²¡æœ‰æŒ‡æ˜ partition å€¼ä½†æœ‰ key çš„æƒ…å†µä¸‹ï¼Œå°† key çš„ hash å€¼ä¸ topic çš„ partition æ•°è¿›è¡Œå–ä½™å¾—åˆ° partition å€¼ï¼›</li><li>æ—¢æ²¡æœ‰ partition å€¼åˆæ²¡æœ‰ key å€¼çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ˆåé¢æ¯æ¬¡è°ƒç”¨åœ¨è¿™ä¸ªæ•´æ•°ä¸Šè‡ªå¢ï¼‰ï¼Œå°†è¿™ä¸ªå€¼ä¸ topic å¯ç”¨çš„ partition æ€»æ•°å–ä½™å¾—åˆ° partitionå€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ round-robin ç®—æ³•ã€‚</li></ol><h3 id="2-4-ç”Ÿäº§è€…ISR"><a href="#2-4-ç”Ÿäº§è€…ISR" class="headerlink" title="2.4 ç”Ÿäº§è€…ISR"></a>2.4 ç”Ÿäº§è€…ISR</h3><p>ä¸ºä¿è¯ producer å‘é€çš„æ•°æ®ï¼Œèƒ½å¯é çš„å‘é€åˆ°æŒ‡å®šçš„ topicï¼Œ topic çš„æ¯ä¸ª partition æ”¶åˆ°producer å‘é€çš„æ•°æ®åï¼Œéƒ½éœ€è¦å‘ producer å‘é€ ackï¼ˆacknowledgement ç¡®è®¤æ”¶åˆ°ï¼‰ï¼Œå¦‚æœproducer æ”¶åˆ° ackï¼Œ å°±ä¼šè¿›è¡Œä¸‹ä¸€è½®çš„å‘é€ï¼Œå¦åˆ™é‡æ–°å‘é€æ•°æ®ã€‚</p><blockquote><p>  acknowledgement è‹± [É™kËˆnÉ’lÉªdÊ’mÉ™nt] ç¾ [É™kËˆnÉ‘ËlÉªdÊ’mÉ™nt]<br>  n.(å¯¹äº‹å®ã€ç°å®ã€å­˜åœ¨çš„)æ‰¿è®¤;æ„Ÿè°¢;è°¢ç¤¼;<strong>æ”¶ä»¶å¤å‡½</strong></p></blockquote><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/09.png" alt></p><p><strong>ä½•æ—¶å‘é€ackï¼Ÿ</strong></p><p>ç¡®ä¿æœ‰followerä¸leaderåŒæ­¥å®Œæˆï¼Œleaderå†å‘é€ackï¼Œè¿™æ ·æ‰èƒ½ä¿è¯leaderæŒ‚æ‰ä¹‹åï¼Œèƒ½åœ¨followerä¸­é€‰ä¸¾å‡ºæ–°çš„leaderã€‚</p><p><strong>å¤šå°‘ä¸ªfolloweråŒæ­¥å®Œæˆä¹‹åå‘é€ackï¼Ÿ</strong></p><ol><li>åŠæ•°ä»¥ä¸Šçš„followeråŒæ­¥å®Œæˆï¼Œå³å¯å‘é€ackç»§ç»­å‘é€é‡æ–°å‘é€</li><li>å…¨éƒ¨çš„followeråŒæ­¥å®Œæˆï¼Œæ‰å¯ä»¥å‘é€ack</li></ol><h4 id="1-å‰¯æœ¬æ•°æ®åŒæ­¥ç­–ç•¥"><a href="#1-å‰¯æœ¬æ•°æ®åŒæ­¥ç­–ç•¥" class="headerlink" title="1 å‰¯æœ¬æ•°æ®åŒæ­¥ç­–ç•¥"></a>1 å‰¯æœ¬æ•°æ®åŒæ­¥ç­–ç•¥</h4><table><thead><tr><th>åºå·</th><th>æ–¹æ¡ˆ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>1</td><td>åŠæ•°ä»¥ä¸Šå®ŒæˆåŒæ­¥ï¼Œ å°±å‘é€ ack</td><td>å»¶è¿Ÿä½</td><td>é€‰ä¸¾æ–°çš„ leader æ—¶ï¼Œå®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œéœ€è¦ 2n+1 ä¸ªå‰¯æœ¬ã€‚ï¼ˆå¦‚æœé›†ç¾¤æœ‰2n+1å°æœºå™¨ï¼Œé€‰ä¸¾leaderçš„æ—¶å€™è‡³å°‘éœ€è¦åŠæ•°ä»¥ä¸Šå³n+1å°æœºå™¨æŠ•ç¥¨ï¼Œé‚£ä¹ˆèƒ½å®¹å¿çš„æ•…éšœï¼Œæœ€å¤šå°±æ˜¯nå°æœºå™¨å‘ç”Ÿæ•…éšœï¼‰å®¹é”™ç‡ï¼š1/2</td></tr><tr><td>2</td><td>å…¨éƒ¨å®ŒæˆåŒæ­¥ï¼Œæ‰å‘é€ack</td><td>é€‰ä¸¾æ–°çš„ leader æ—¶ï¼Œ å®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œéœ€è¦ n+1 ä¸ªå‰¯æœ¬ï¼ˆå¦‚æœé›†ç¾¤æœ‰n+1å°æœºå™¨ï¼Œé€‰ä¸¾leaderçš„æ—¶å€™åªè¦æœ‰ä¸€ä¸ªå‰¯æœ¬å°±å¯ä»¥äº†ï¼‰å®¹é”™ç‡ï¼š1</td><td>å»¶è¿Ÿé«˜</td></tr></tbody></table><p>Kafka é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ol><li>åŒæ ·ä¸ºäº†å®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆéœ€è¦ 2n+1 ä¸ªå‰¯æœ¬ï¼Œè€Œç¬¬äºŒç§æ–¹æ¡ˆåªéœ€è¦ n+1 ä¸ªå‰¯æœ¬ï¼Œè€Œ Kafka çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰å¤§é‡çš„æ•°æ®ï¼Œ ç¬¬ä¸€ç§æ–¹æ¡ˆä¼šé€ æˆå¤§é‡æ•°æ®çš„å†—ä½™ã€‚</li><li>è™½ç„¶ç¬¬äºŒç§æ–¹æ¡ˆçš„ç½‘ç»œå»¶è¿Ÿä¼šæ¯”è¾ƒé«˜ï¼Œä½†ç½‘ç»œå»¶è¿Ÿå¯¹ Kafka çš„å½±å“è¾ƒå°ã€‚</li></ol><h4 id="2-ISR"><a href="#2-ISR" class="headerlink" title="2 ISR"></a>2 ISR</h4><p>é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆä¹‹åï¼Œè®¾æƒ³ä»¥ä¸‹æƒ…æ™¯ï¼š leader æ”¶åˆ°æ•°æ®ï¼Œæ‰€æœ‰ follower éƒ½å¼€å§‹åŒæ­¥æ•°æ®ï¼Œä½†æœ‰ä¸€ä¸ª followerï¼Œå› ä¸ºæŸç§æ•…éšœï¼Œè¿Ÿè¿Ÿä¸èƒ½ä¸ leader è¿›è¡ŒåŒæ­¥ï¼Œé‚£ leader å°±è¦ä¸€ç›´ç­‰ä¸‹å»ï¼Œç›´åˆ°å®ƒå®ŒæˆåŒæ­¥ï¼Œæ‰èƒ½å‘é€ ackã€‚è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>Leader ç»´æŠ¤äº†ä¸€ä¸ªåŠ¨æ€çš„ <strong>in-sync replica set</strong> (ISR)ï¼Œæ„ä¸ºå’Œ leader ä¿æŒåŒæ­¥çš„ follower é›†åˆã€‚å½“ ISR ä¸­çš„ follower å®Œæˆæ•°æ®çš„åŒæ­¥ä¹‹åï¼Œå°±ä¼šç»™ leader å‘é€ ackã€‚å¦‚æœ followeré•¿æ—¶é—´æœªå‘leaderåŒæ­¥æ•°æ®ï¼Œåˆ™è¯¥followerå°†è¢«è¸¢å‡ºISRï¼Œè¯¥æ—¶é—´é˜ˆå€¼ç”±<code>replica.lag.time.max.ms</code>å‚æ•°è®¾å®šã€‚ Leader å‘ç”Ÿæ•…éšœä¹‹åï¼Œå°±ä¼šä» ISR ä¸­é€‰ä¸¾æ–°çš„ leaderã€‚</p><blockquote><p>  <strong>replica.lag.time.max.ms</strong></p><p>  <strong>DESCRIPTION</strong>: If a follower hasnâ€™t sent any fetch requests or hasnâ€™t consumed up to the leaders log end offset for at least this time, the leader will remove the follower from isr</p><p>  <strong>TYPE</strong>: long</p><p>  <strong>DEFAULT</strong>: 10000</p><p>  <a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23brokerconfigs">Source</a></p></blockquote><h3 id="2-5-ç”Ÿäº§è€…ACKæœºåˆ¶"><a href="#2-5-ç”Ÿäº§è€…ACKæœºåˆ¶" class="headerlink" title="2.5 ç”Ÿäº§è€…ACKæœºåˆ¶"></a>2.5 ç”Ÿäº§è€…ACKæœºåˆ¶</h3><p>å¯¹äºæŸäº›ä¸å¤ªé‡è¦çš„æ•°æ®ï¼Œå¯¹æ•°æ®çš„å¯é æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œèƒ½å¤Ÿå®¹å¿æ•°æ®çš„å°‘é‡ä¸¢å¤±ï¼Œæ‰€ä»¥æ²¡å¿…è¦ç­‰ ISR ä¸­çš„ follower å…¨éƒ¨æ¥æ”¶æˆåŠŸã€‚</p><p>æ‰€ä»¥ Kafka ä¸ºç”¨æˆ·æä¾›äº†ä¸‰ç§å¯é æ€§çº§åˆ«ï¼Œç”¨æˆ·æ ¹æ®å¯¹å¯é æ€§å’Œå»¶è¿Ÿçš„è¦æ±‚è¿›è¡Œæƒè¡¡ï¼Œé€‰æ‹©ä»¥ä¸‹çš„é…ç½®ã€‚</p><h4 id="acks-å‚æ•°é…ç½®ï¼š"><a href="#acks-å‚æ•°é…ç½®ï¼š" class="headerlink" title="acks å‚æ•°é…ç½®ï¼š"></a><strong>acks å‚æ•°é…ç½®</strong>ï¼š</h4><ul><li>0ï¼š producer ä¸ç­‰å¾… broker çš„ ackï¼Œè¿™ä¸€æ“ä½œæä¾›äº†ä¸€ä¸ªæœ€ä½çš„å»¶è¿Ÿï¼Œ broker ä¸€æ¥æ”¶åˆ°è¿˜æ²¡æœ‰å†™å…¥ç£ç›˜å°±å·²ç»è¿”å›ï¼Œå½“ broker æ•…éšœæ—¶æœ‰å¯èƒ½<strong>ä¸¢å¤±æ•°æ®</strong>ï¼›</li><li>1ï¼š producer ç­‰å¾… broker çš„ ackï¼Œ partition çš„ leader è½ç›˜æˆåŠŸåè¿”å› ackï¼Œå¦‚æœåœ¨ followeråŒæ­¥æˆåŠŸä¹‹å‰ leader æ•…éšœï¼Œé‚£ä¹ˆå°†ä¼š<strong>ä¸¢å¤±æ•°æ®</strong>ï¼›</li></ul><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/10.png" alt></p><ul><li>-1ï¼ˆallï¼‰ ï¼š producer ç­‰å¾… broker çš„ ackï¼Œ partition çš„ leader å’Œ ISR çš„follower å…¨éƒ¨è½ç›˜æˆåŠŸåæ‰è¿”å› ackã€‚ä½†æ˜¯å¦‚æœåœ¨ follower åŒæ­¥å®Œæˆåï¼Œ broker å‘é€ ack ä¹‹å‰ï¼Œ leader å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆä¼šé€ æˆ<strong>æ•°æ®é‡å¤</strong>ã€‚</li></ul><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/11.png" alt></p><p><strong>åŠ©è®°ï¼šè¿”ACKå‰ï¼Œ0æ— è½ç›˜ï¼Œ1ä¸€è½ç›˜ï¼Œ-1å…¨è½ç›˜ï¼Œï¼ˆè½ç›˜ï¼šæ¶ˆæ¯å­˜åˆ°æœ¬åœ°ï¼‰</strong></p><blockquote><p>  <strong>acks</strong></p><p>  <strong>DESCRIPTION</strong>:</p><p>  The number of acknowledgments the producer requires the leader to have received before considering a request complete. This controls the durability of records that are sent. The following settings are allowed:</p><ul><li><code>acks=0</code> If set to zero then the producer will not wait for any acknowledgment from the server at all. The record will be immediately added to the socket buffer and considered sent. No guarantee can be made that the server has received the record in this case, and the retries configuration will not take effect (as the client wonâ€™t generally know of any failures). The offset given back for each record will always be set to -1.</li><li><code>acks=1</code> This will mean the leader will write the record to its local log but will respond without awaiting full acknowledgement from all followers. In this case should the leader fail immediately after acknowledging the record but before the followers have replicated it then the record will be lost.</li><li><code>acks=all</code> This means the leader will wait for the full set of in-sync replicas to acknowledge the record. This guarantees that the record will not be lost as long as at least one in-sync replica remains alive. This is the strongest available guarantee. This is equivalent to the acks=-1 setting.</li></ul><p>  <strong>TYPE</strong>:string</p><p>  <strong>DEFAULT</strong>:1</p><p>  <strong>VALID VALUES</strong>:[all, -1, 0, 1]</p><p>  <a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23producerconfigs">Source</a></p></blockquote><h3 id="2-6-æ•°æ®ä¸€è‡´æ€§é—®é¢˜"><a href="#2-6-æ•°æ®ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="2.6 æ•°æ®ä¸€è‡´æ€§é—®é¢˜"></a>2.6 æ•°æ®ä¸€è‡´æ€§é—®é¢˜</h3><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/12.png" alt></p><ul><li>LEOï¼šï¼ˆLog End Offsetï¼‰æ¯ä¸ªå‰¯æœ¬çš„æœ€åä¸€ä¸ªoffset</li><li>HWï¼šï¼ˆHigh Watermarkï¼‰é«˜æ°´ä½ï¼ŒæŒ‡çš„æ˜¯æ¶ˆè´¹è€…èƒ½è§åˆ°çš„æœ€å¤§çš„ offsetï¼Œ ISR é˜Ÿåˆ—ä¸­æœ€å°çš„ LEO</li></ul><h4 id="follower-æ•…éšœå’Œ-leader-æ•…éšœ"><a href="#follower-æ•…éšœå’Œ-leader-æ•…éšœ" class="headerlink" title="follower æ•…éšœå’Œ leader æ•…éšœ"></a>follower æ•…éšœå’Œ leader æ•…éšœ</h4><ul><li><strong>follower æ•…éšœ</strong>ï¼šfollower å‘ç”Ÿæ•…éšœåä¼šè¢«ä¸´æ—¶è¸¢å‡º ISRï¼Œå¾…è¯¥ follower æ¢å¤åï¼Œ follower ä¼šè¯»å–æœ¬åœ°ç£ç›˜è®°å½•çš„ä¸Šæ¬¡çš„ HWï¼Œå¹¶å°† log æ–‡ä»¶é«˜äº HW çš„éƒ¨åˆ†æˆªå–æ‰ï¼Œä» HW å¼€å§‹å‘ leader è¿›è¡ŒåŒæ­¥ã€‚ç­‰è¯¥ follower çš„ LEO å¤§äºç­‰äºè¯¥ Partition çš„ HWï¼Œå³ follower è¿½ä¸Š leader ä¹‹åï¼Œå°±å¯ä»¥é‡æ–°åŠ å…¥ ISR äº†ã€‚</li><li><strong>leader æ•…éšœ</strong>ï¼šleader å‘ç”Ÿæ•…éšœä¹‹åï¼Œä¼šä» ISR ä¸­é€‰å‡ºä¸€ä¸ªæ–°çš„ leaderï¼Œä¹‹åï¼Œä¸ºä¿è¯å¤šä¸ªå‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œ å…¶ä½™çš„ follower ä¼šå…ˆå°†å„è‡ªçš„ log æ–‡ä»¶é«˜äº HW çš„éƒ¨åˆ†æˆªæ‰ï¼Œç„¶åä»æ–°çš„ leaderåŒæ­¥æ•°æ®ã€‚</li></ul><p>æ³¨æ„ï¼š è¿™åªèƒ½ä¿è¯å‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±æˆ–è€…ä¸é‡å¤ã€‚</p><h3 id="2-7-ExactlyOnce"><a href="#2-7-ExactlyOnce" class="headerlink" title="2.7 ExactlyOnce"></a>2.7 ExactlyOnce</h3><p>å°†æœåŠ¡å™¨çš„ ACK çº§åˆ«è®¾ç½®ä¸º-1ï¼ˆallï¼‰ï¼Œå¯ä»¥ä¿è¯ Producer åˆ° Server ä¹‹é—´ä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œå³ <strong>At Least Once</strong> è¯­ä¹‰ã€‚</p><p>ç›¸å¯¹çš„ï¼Œå°†æœåŠ¡å™¨ ACK çº§åˆ«è®¾ç½®ä¸º 0ï¼Œå¯ä»¥ä¿è¯ç”Ÿäº§è€…æ¯æ¡æ¶ˆæ¯åªä¼šè¢«å‘é€ä¸€æ¬¡ï¼Œå³ <strong>At Most Once</strong> è¯­ä¹‰ã€‚</p><p>At Least Once å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸é‡å¤ï¼›ç›¸å¯¹çš„ï¼Œ At Most Onceå¯ä»¥ä¿è¯æ•°æ®ä¸é‡å¤ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚ ä½†æ˜¯ï¼Œå¯¹äºä¸€äº›éå¸¸é‡è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´<strong>äº¤æ˜“æ•°æ®</strong>ï¼Œä¸‹æ¸¸æ•°æ®æ¶ˆè´¹è€…è¦æ±‚æ•°æ®æ—¢ä¸é‡å¤ä¹Ÿä¸ä¸¢å¤±ï¼Œå³ <strong>Exactly Once</strong> è¯­ä¹‰ã€‚</p><blockquote><ul><li><p>At least onceâ€”Messages are <strong>never lost</strong> but may be redelivered.</p></li><li><p>At most onceâ€”Messages <strong>may be lost</strong> but are never redelivered.</p></li><li><p>Exactly onceâ€”this is what people actually want, each message is delivered once and only once.</p><p><a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23semantics">Source</a></p></li></ul></blockquote><p>åœ¨ 0.11 ç‰ˆæœ¬ä»¥å‰çš„ Kafkaï¼Œå¯¹æ­¤æ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œåªèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå†åœ¨ä¸‹æ¸¸æ¶ˆè´¹è€…å¯¹æ•°æ®åšå…¨å±€å»é‡ã€‚å¯¹äºå¤šä¸ªä¸‹æ¸¸åº”ç”¨çš„æƒ…å†µï¼Œæ¯ä¸ªéƒ½éœ€è¦å•ç‹¬åšå…¨å±€å»é‡ï¼Œè¿™å°±å¯¹æ€§èƒ½é€ æˆäº†å¾ˆå¤§å½±å“ã€‚</p><p>0.11 ç‰ˆæœ¬çš„ Kafkaï¼Œå¼•å…¥äº†ä¸€é¡¹é‡å¤§ç‰¹æ€§ï¼š<strong>å¹‚ç­‰æ€§</strong>ã€‚<strong>æ‰€è°“çš„å¹‚ç­‰æ€§å°±æ˜¯æŒ‡ Producer ä¸è®ºå‘ Server å‘é€å¤šå°‘æ¬¡é‡å¤æ•°æ®ï¼Œ Server ç«¯éƒ½åªä¼šæŒä¹…åŒ–ä¸€æ¡</strong>ã€‚å¹‚ç­‰æ€§ç»“åˆ At Least Once è¯­ä¹‰ï¼Œå°±æ„æˆäº† Kafka çš„ Exactly Once è¯­ä¹‰ã€‚å³ï¼š</p><div class="code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">At</span> <span class="hljs-variable">Least</span> <span class="hljs-built_in">Once</span> <span class="hljs-operator">+</span> å¹‚ç­‰æ€§ <span class="hljs-operator">=</span> <span class="hljs-variable">Exactly</span> <span class="hljs-built_in">Once</span></code></pre></div><p>è¦å¯ç”¨å¹‚ç­‰æ€§ï¼Œåªéœ€è¦å°† Producer çš„å‚æ•°ä¸­ <code>enable.idempotence</code> è®¾ç½®ä¸º true å³å¯ã€‚ Kafkaçš„å¹‚ç­‰æ€§å®ç°å…¶å®å°±æ˜¯å°†åŸæ¥ä¸‹æ¸¸éœ€è¦åšçš„å»é‡æ”¾åœ¨äº†æ•°æ®ä¸Šæ¸¸ã€‚å¼€å¯å¹‚ç­‰æ€§çš„ Producer åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆ†é…ä¸€ä¸ª PIDï¼Œå‘å¾€åŒä¸€ Partition çš„æ¶ˆæ¯ä¼šé™„å¸¦ Sequence Numberã€‚è€ŒBroker ç«¯ä¼šå¯¹<code>&lt;PID, Partition, SeqNumber&gt;</code>åšç¼“å­˜ï¼Œå½“å…·æœ‰ç›¸åŒä¸»é”®çš„æ¶ˆæ¯æäº¤æ—¶ï¼Œ Broker åªä¼šæŒä¹…åŒ–ä¸€æ¡ã€‚</p><p>ä½†æ˜¯ PID é‡å¯å°±ä¼šå˜åŒ–ï¼ŒåŒæ—¶ä¸åŒçš„ Partition ä¹Ÿå…·æœ‰ä¸åŒä¸»é”®ï¼Œæ‰€ä»¥å¹‚ç­‰æ€§æ— æ³•ä¿è¯è·¨åˆ†åŒºè·¨ä¼šè¯çš„ Exactly Onceã€‚</p><blockquote><p>  <strong>enable.idempotence</strong></p><p>  DESCRIPTION:When set to â€˜trueâ€™, the producer will ensure that exactly one copy of each message is written in the stream. If â€˜falseâ€™, producer retries due to broker failures, etc., may write duplicates of the retried message in the stream. This is set to â€˜falseâ€™ by default. Note that enabling idempotence requires <code>max.in.flight.requests.per.connection</code> to be set to 1 and <code>retries</code> cannot be zero. Additionally acks must be set to â€˜allâ€™. If these values are left at their defaults, we will override the default to be suitable. If the values are set to something incompatible with the idempotent producer, a ConfigException will be thrown.</p><p>  TYPE:boolean</p><p>  DEFAULT:false</p><p>  <a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23producerconfigs">Source</a></p></blockquote><h3 id="2-8-ç”Ÿäº§è€…æ€»ç»“"><a href="#2-8-ç”Ÿäº§è€…æ€»ç»“" class="headerlink" title="2.8 ç”Ÿäº§è€…æ€»ç»“"></a>2.8 ç”Ÿäº§è€…æ€»ç»“</h3><h3 id="2-9-æ¶ˆè´¹è€…åˆ†åŒºåˆ†é…ç­–ç•¥"><a href="#2-9-æ¶ˆè´¹è€…åˆ†åŒºåˆ†é…ç­–ç•¥" class="headerlink" title="2.9 æ¶ˆè´¹è€…åˆ†åŒºåˆ†é…ç­–ç•¥"></a>2.9 æ¶ˆè´¹è€…åˆ†åŒºåˆ†é…ç­–ç•¥</h3><h4 id="1-æ¶ˆè´¹æ–¹å¼"><a href="#1-æ¶ˆè´¹æ–¹å¼" class="headerlink" title="1 æ¶ˆè´¹æ–¹å¼"></a>1 æ¶ˆè´¹æ–¹å¼</h4><p><strong>consumer é‡‡ç”¨ pullï¼ˆæ‹‰ï¼‰ æ¨¡å¼ä» broker ä¸­è¯»å–æ•°æ®</strong>ã€‚</p><p><strong>pushï¼ˆæ¨ï¼‰æ¨¡å¼å¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å‘é€é€Ÿç‡æ˜¯ç”± broker å†³å®šçš„</strong>ã€‚å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦ä¼ é€’æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå®¹æ˜“é€ æˆ consumer æ¥ä¸åŠå¤„ç†æ¶ˆæ¯ï¼Œå…¸å‹çš„è¡¨ç°å°±æ˜¯æ‹’ç»æœåŠ¡ä»¥åŠç½‘ç»œæ‹¥å¡ã€‚è€Œ pull æ¨¡å¼åˆ™å¯ä»¥æ ¹æ® consumer çš„æ¶ˆè´¹èƒ½åŠ›ä»¥é€‚å½“çš„é€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p><strong>pull æ¨¡å¼ä¸è¶³ä¹‹å¤„</strong>æ˜¯ï¼Œå¦‚æœ kafka æ²¡æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¼šé™·å…¥å¾ªç¯ä¸­ï¼Œ ä¸€ç›´è¿”å›ç©ºæ•°æ®ã€‚ é’ˆå¯¹è¿™ä¸€ç‚¹ï¼Œ Kafka çš„æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ•°æ®æ—¶ä¼šä¼ å…¥ä¸€ä¸ªæ—¶é•¿å‚æ•° timeoutï¼Œå¦‚æœå½“å‰æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹ï¼Œ consumer ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åå†è¿”å›ï¼Œè¿™æ®µæ—¶é•¿å³ä¸º timeoutã€‚</p><p><a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23design_pull">Push vs. pull</a></p><h4 id="2-åˆ†åŒºåˆ†é…ç­–ç•¥"><a href="#2-åˆ†åŒºåˆ†é…ç­–ç•¥" class="headerlink" title="2 åˆ†åŒºåˆ†é…ç­–ç•¥"></a>2 åˆ†åŒºåˆ†é…ç­–ç•¥</h4><p>ä¸€ä¸ª consumer group ä¸­æœ‰å¤šä¸ª consumerï¼Œä¸€ä¸ª topic æœ‰å¤šä¸ª partitionï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæ¶‰åŠåˆ° partition çš„åˆ†é…é—®é¢˜ï¼Œå³ç¡®å®šé‚£ä¸ª partition ç”±å“ªä¸ª consumer æ¥æ¶ˆè´¹ã€‚</p><p>Kafka æœ‰ä¸¤ç§åˆ†é…ç­–ç•¥ï¼š</p><ul><li>round-robinå¾ªç¯</li><li>range</li></ul><blockquote><p>  <strong>partition.assignment.strategy</strong></p><p>  Select between the â€œrangeâ€ or â€œroundrobinâ€ strategy for assigningåˆ†é… partitions to consumer streams.</p><p>  The <strong>round-robin</strong> partition assignor lays outè§„åˆ’ all the available partitions and all the available consumer threads. It then proceeds to doæ¥ç€åš a round-robin assignment from partition to consumer thread. If the subscriptionsè®¢é˜… of all consumer instances are identicalå®Œå…¨åŒæ ·çš„, then the partitions will be uniformly å‡åŒ€åœ°distributed. (i.e.ä¹Ÿå°±æ˜¯è¯´, the partition ownership counts will be within a delta of exactly one across all consumer threads.) Round-robin assignment is permitted only if:</p><ol><li>Every topic has the same number of streams within a consumer instance</li><li>The set of subscribed topics is identical for every consumer instance within the group.</li></ol><p>  <strong>Range</strong> partitioning works on a per-<strong>topic</strong> basis. For each topic, we lay out the available partitions in numeric order and the consumer threads in lexicographicè¯å…¸å¼çš„ order. We then divide the number of partitions by the total number of consumer streams (threads) to determine the number of partitions to assign to each consumer. If it does not evenly divide, then the first few consumers will have one extra partition.</p><p>  <strong>DEFAULT</strong>:range</p><p>  <a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23oldconsumerconfigs">Source</a></p></blockquote><hr><p><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F86718818">Kafkaå†å¹³è¡¡æœºåˆ¶è¯¦è§£</a></p><h4 id="3-Round-Robin"><a href="#3-Round-Robin" class="headerlink" title="3 Round Robin"></a>3 Round Robin</h4><p>å…³äºRoudn Robiné‡åˆ†é…ç­–ç•¥ï¼Œå…¶ä¸»è¦é‡‡ç”¨çš„æ˜¯ä¸€ç§è½®è¯¢çš„æ–¹å¼åˆ†é…æ‰€æœ‰çš„åˆ†åŒºï¼Œè¯¥ç­–ç•¥ä¸»è¦å®ç°çš„æ­¥éª¤å¦‚ä¸‹ã€‚è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸‰ä¸ªtopicï¼št0ã€t1å’Œt2ï¼Œè¿™ä¸‰ä¸ªtopicæ‹¥æœ‰çš„åˆ†åŒºæ•°åˆ†åˆ«ä¸º1ã€2å’Œ3ï¼Œé‚£ä¹ˆæ€»å…±æœ‰å…­ä¸ªåˆ†åŒºï¼Œè¿™å…­ä¸ªåˆ†åŒºåˆ†åˆ«ä¸ºï¼št0-0ã€t1-0ã€t1-1ã€t2-0ã€t2-1å’Œt2-2ã€‚è¿™é‡Œå‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªconsumerï¼šC0ã€C1å’ŒC2ï¼Œå®ƒä»¬è®¢é˜…æƒ…å†µä¸ºï¼šC0è®¢é˜…t0ï¼ŒC1è®¢é˜…t0å’Œt1ï¼ŒC2è®¢é˜…t0ã€t1å’Œt2ã€‚é‚£ä¹ˆè¿™äº›åˆ†åŒºçš„åˆ†é…æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆå°†æ‰€æœ‰çš„partitionå’ŒconsumeræŒ‰ç…§å­—å…¸åºè¿›è¡Œæ’åºï¼Œæ‰€è°“çš„å­—å…¸åºï¼Œå°±æ˜¯æŒ‰ç…§å…¶åç§°çš„å­—ç¬¦ä¸²é¡ºåºï¼Œé‚£ä¹ˆä¸Šé¢çš„å…­ä¸ªåˆ†åŒºå’Œä¸‰ä¸ªconsumeræ’åºä¹‹ååˆ†åˆ«ä¸ºï¼š</li></ul><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/16.png" alt></p><ul><li>ç„¶åä¾æ¬¡ä»¥æŒ‰é¡ºåºè½®è¯¢çš„æ–¹å¼å°†è¿™å…­ä¸ªåˆ†åŒºåˆ†é…ç»™ä¸‰ä¸ªconsumerï¼Œå¦‚æœå½“å‰consumeræ²¡æœ‰è®¢é˜…å½“å‰åˆ†åŒºæ‰€åœ¨çš„topicï¼Œåˆ™è½®è¯¢çš„åˆ¤æ–­ä¸‹ä¸€ä¸ªconsumerï¼š</li><li>å°è¯•å°†t0-0åˆ†é…ç»™C0ï¼Œç”±äºC0è®¢é˜…äº†t0ï¼Œå› è€Œå¯ä»¥åˆ†é…æˆåŠŸï¼›</li><li>å°è¯•å°†t1-0åˆ†é…ç»™C1ï¼Œç”±äºC1è®¢é˜…äº†t1ï¼Œå› è€Œå¯ä»¥åˆ†é…æˆåŠŸï¼›</li><li>å°è¯•å°†t1-1åˆ†é…ç»™C2ï¼Œç”±äºC2è®¢é˜…äº†t1ï¼Œå› è€Œå¯ä»¥åˆ†é…æˆåŠŸï¼›</li><li>å°è¯•å°†t2-0åˆ†é…ç»™C0ï¼Œç”±äºC0æ²¡æœ‰è®¢é˜…t2ï¼Œå› è€Œä¼šè½®è¯¢ä¸‹ä¸€ä¸ªconsumerï¼›</li><li>å°è¯•å°†t2-0åˆ†é…ç»™C1ï¼Œç”±äºC1æ²¡æœ‰è®¢é˜…t2ï¼Œå› è€Œä¼šè½®è¯¢ä¸‹ä¸€ä¸ªconsumerï¼›</li><li>å°è¯•å°†t2-0åˆ†é…ç»™C2ï¼Œç”±äºC2è®¢é˜…äº†t2ï¼Œå› è€Œå¯ä»¥åˆ†é…æˆåŠŸï¼›</li><li>åŒç†ç”±äºt2-1å’Œt2-2æ‰€åœ¨çš„topicéƒ½æ²¡æœ‰è¢«C0å’ŒC1æ‰€è®¢é˜…ï¼Œå› è€Œéƒ½ä¸ä¼šåˆ†é…æˆåŠŸï¼Œæœ€ç»ˆéƒ½ä¼šåˆ†é…ç»™C2ã€‚</li><li>æŒ‰ç…§ä¸Šè¿°çš„æ­¥éª¤å°†æ‰€æœ‰çš„åˆ†åŒºéƒ½åˆ†é…å®Œæ¯•ä¹‹åï¼Œæœ€ç»ˆåˆ†åŒºçš„è®¢é˜…æƒ…å†µå¦‚ä¸‹ï¼š</li></ul><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/17.png" alt></p><p>ä»ä¸Šé¢çš„æ­¥éª¤åˆ†æå¯ä»¥çœ‹å‡ºï¼Œè½®è¯¢çš„ç­–ç•¥å°±æ˜¯ç®€å•çš„å°†æ‰€æœ‰çš„partitionå’ŒconsumeræŒ‰ç…§å­—å…¸åºè¿›è¡Œæ’åºä¹‹åï¼Œç„¶åä¾æ¬¡å°†partitionåˆ†é…ç»™å„ä¸ªconsumerï¼Œå¦‚æœå½“å‰çš„consumeræ²¡æœ‰è®¢é˜…å½“å‰çš„partitionï¼Œé‚£ä¹ˆå°±ä¼šè½®è¯¢ä¸‹ä¸€ä¸ªconsumerï¼Œç›´è‡³æœ€ç»ˆå°†æ‰€æœ‰çš„åˆ†åŒºéƒ½åˆ†é…å®Œæ¯•ã€‚ä½†æ˜¯ä»ä¸Šé¢çš„åˆ†é…ç»“æœå¯ä»¥çœ‹å‡ºï¼Œè½®è¯¢çš„æ–¹å¼ä¼šå¯¼è‡´æ¯ä¸ªconsumeræ‰€æ‰¿è½½çš„åˆ†åŒºæ•°é‡ä¸ä¸€è‡´ï¼Œä»è€Œå¯¼è‡´å„ä¸ªconsumerå‹åŠ›ä¸å‡ä¸€ã€‚</p><h4 id="4-Range"><a href="#4-Range" class="headerlink" title="4 Range"></a>4 Range</h4><p>æ‰€è°“çš„Rangeé‡åˆ†é…ç­–ç•¥ï¼Œå°±æ˜¯é¦–å…ˆä¼šè®¡ç®—å„ä¸ªconsumerå°†ä¼šæ‰¿è½½çš„åˆ†åŒºæ•°é‡ï¼Œç„¶åå°†æŒ‡å®šæ•°é‡çš„åˆ†åŒºåˆ†é…ç»™è¯¥consumerã€‚è¿™é‡Œæˆ‘ä»¬å‡è®¾æœ‰ä¸¤ä¸ªconsumerï¼šC0å’ŒC1ï¼Œä¸¤ä¸ªtopicï¼št0å’Œt1ï¼Œè¿™ä¸¤ä¸ªtopicåˆ†åˆ«éƒ½æœ‰ä¸‰ä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆæ€»å…±çš„åˆ†åŒºæœ‰å…­ä¸ªï¼št0-0ã€t0-1ã€t0-2ã€t1-0ã€t1-1å’Œt1-2ã€‚é‚£ä¹ˆRangeåˆ†é…ç­–ç•¥å°†ä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œåˆ†åŒºçš„åˆ†é…ï¼š</p><ul><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRangeç­–ç•¥æ˜¯æŒ‰ç…§topicä¾æ¬¡è¿›è¡Œåˆ†é…çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬ä»¥t0è¿›è¡Œè®²è§£ï¼Œå…¶é¦–å…ˆä¼šè·å–t0çš„æ‰€æœ‰åˆ†åŒºï¼št0-0ã€t0-1å’Œt0-2ï¼Œä»¥åŠæ‰€æœ‰è®¢é˜…äº†è¯¥topicçš„consumerï¼šC0å’ŒC1ï¼Œå¹¶ä¸”ä¼šå°†è¿™äº›åˆ†åŒºå’ŒconsumeræŒ‰ç…§å­—å…¸åºè¿›è¡Œæ’åºï¼›</li><li>ç„¶åæŒ‰ç…§å¹³å‡åˆ†é…çš„æ–¹å¼è®¡ç®—æ¯ä¸ªconsumerä¼šå¾—åˆ°å¤šå°‘ä¸ªåˆ†åŒºï¼Œå¦‚æœæ²¡æœ‰é™¤å°½ï¼Œåˆ™ä¼šå°†å¤šå‡ºæ¥çš„åˆ†åŒºä¾æ¬¡è®¡ç®—åˆ°å‰é¢å‡ ä¸ªconsumerã€‚æ¯”å¦‚è¿™é‡Œæ˜¯ä¸‰ä¸ªåˆ†åŒºå’Œä¸¤ä¸ªconsumerï¼Œé‚£ä¹ˆæ¯ä¸ªconsumerè‡³å°‘ä¼šå¾—åˆ°1ä¸ªåˆ†åŒºï¼Œè€Œ3é™¤ä»¥2åè¿˜ä½™1ï¼Œé‚£ä¹ˆå°±ä¼šå°†å¤šä½™çš„éƒ¨åˆ†ä¾æ¬¡ç®—åˆ°å‰é¢å‡ ä¸ªconsumerï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„1ä¼šåˆ†é…ç»™ç¬¬ä¸€ä¸ªconsumerï¼Œæ€»ç»“æ¥è¯´ï¼Œé‚£ä¹ˆC0å°†ä¼šä»ç¬¬0ä¸ªåˆ†åŒºå¼€å§‹ï¼Œåˆ†é…2ä¸ªåˆ†åŒºï¼Œè€ŒC1å°†ä¼šä»ç¬¬2ä¸ªåˆ†åŒºå¼€å§‹ï¼Œåˆ†é…1ä¸ªåˆ†åŒºï¼›</li><li>åŒç†ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ä¾æ¬¡è¿›è¡Œåé¢çš„topicçš„åˆ†é…ã€‚</li><li>æœ€ç»ˆä¸Šé¢å…­ä¸ªåˆ†åŒºçš„åˆ†é…æƒ…å†µå¦‚ä¸‹ï¼š</li></ul><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/18.png" alt></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæŒ‰ç…§<code>Range</code>åˆ†åŒºæ–¹å¼è¿›è¡Œåˆ†é…ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¾æ¬¡éå†æ¯ä¸ªtopicï¼Œç„¶åå°†è¿™äº›topicçš„åˆ†åŒºæŒ‰ç…§å…¶æ‰€è®¢é˜…çš„consumeræ•°é‡è¿›è¡Œå¹³å‡çš„èŒƒå›´åˆ†é…ã€‚è¿™ç§æ–¹å¼ä»è®¡ç®—åŸç†ä¸Šå°±ä¼šå¯¼è‡´æ’åºåœ¨å‰é¢çš„consumeråˆ†é…åˆ°æ›´å¤šçš„åˆ†åŒºï¼Œä»è€Œå¯¼è‡´å„ä¸ªconsumerçš„å‹åŠ›ä¸å‡è¡¡ã€‚</p><p>TODO:æˆ‘çš„é—®é¢˜ï¼štopicåˆ†å¤šä¸ªpartitionï¼Œæœ‰äº›customæ ¹æ®ä¸Šè¿°ç­–ç•¥ï¼Œåˆ†åˆ°topicçš„éƒ¨åˆ†partitionï¼Œéš¾é“ä¸æ˜¯è¦å…¨éƒ¨partitionå—ï¼Ÿæ˜¯ä¸æ˜¯è¿˜è¦æŒ‰ç…§ç›¸åŒç­–ç•¥å¤šåˆ†é…å¤šä¸€æ¬¡ï¼Ÿ</p><h3 id="2-10-æ¶ˆè´¹è€…offsetçš„å­˜å‚¨"><a href="#2-10-æ¶ˆè´¹è€…offsetçš„å­˜å‚¨" class="headerlink" title="2.10 æ¶ˆè´¹è€…offsetçš„å­˜å‚¨"></a>2.10 æ¶ˆè´¹è€…offsetçš„å­˜å‚¨</h3><p>ç”±äº consumer åœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ–­ç”µå®•æœºç­‰æ•…éšœï¼Œ consumer æ¢å¤åï¼Œéœ€è¦ä»æ•…éšœå‰çš„ä½ç½®çš„ç»§ç»­æ¶ˆè´¹ï¼Œæ‰€ä»¥ <strong>consumer éœ€è¦å®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ª offset</strong>ï¼Œä»¥ä¾¿æ•…éšœæ¢å¤åç»§ç»­æ¶ˆè´¹ã€‚</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/13.png" alt></p><p><strong>Kafka 0.9 ç‰ˆæœ¬ä¹‹å‰ï¼Œ consumer é»˜è®¤å°† offset ä¿å­˜åœ¨ Zookeeper ä¸­ï¼Œä» 0.9 ç‰ˆæœ¬å¼€å§‹ï¼Œconsumer é»˜è®¤å°† offset ä¿å­˜åœ¨ Kafka ä¸€ä¸ªå†…ç½®çš„ topic ä¸­ï¼Œè¯¥ topic ä¸º__consumer_offsets</strong>ã€‚</p><ol><li>ä¿®æ”¹é…ç½®æ–‡ä»¶ consumer.propertiesï¼Œ<code>exclude.internal.topics=false</code>ã€‚</li><li>è¯»å– offset<ul><li>0.11.0.0 ä¹‹å‰ç‰ˆæœ¬ - <code>bin/kafka-console-consumer.sh --topic __consumer_offsets --zookeeper hadoop102:2181 --formatter &quot;kafka.coordinator.GroupMetadataManager\$OffsetsMessageFormatter&quot; --consumer.config config/consumer.properties --from-beginning</code></li><li>0.11.0.0 åŠä¹‹åç‰ˆæœ¬ - <code>bin/kafka-console-consumer.sh --topic __consumer_offsets --zookeeper hadoop102:2181 --formatter &quot;kafka.coordinator.group.GroupMetadataManager\$OffsetsMessageFormatter&quot; --consumer.config config/consumer.properties --from-beginning</code></li></ul></li></ol><p>TODO:ä¸Šæœºå®éªŒ</p><h3 id="2-11-æ¶ˆè´¹è€…ç»„æ¡ˆä¾‹"><a href="#2-11-æ¶ˆè´¹è€…ç»„æ¡ˆä¾‹" class="headerlink" title="2.11 æ¶ˆè´¹è€…ç»„æ¡ˆä¾‹"></a>2.11 æ¶ˆè´¹è€…ç»„æ¡ˆä¾‹</h3><h4 id="1-éœ€æ±‚"><a href="#1-éœ€æ±‚" class="headerlink" title="1 éœ€æ±‚"></a>1 éœ€æ±‚</h4><p>æµ‹è¯•åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œ <strong>åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ª</strong>æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p><h4 id="2-æ“ä½œæ­¥éª¤"><a href="#2-æ“ä½œæ­¥éª¤" class="headerlink" title="2 æ“ä½œæ­¥éª¤"></a>2 æ“ä½œæ­¥éª¤</h4><p>1.ä¿®æ”¹<code>%KAFKA_HOME\config\consumer.properties%</code>æ–‡ä»¶ä¸­çš„<code>group.id</code>å±æ€§ã€‚</p><div class="code-wrapper"><pre><code class="hljs properties"><span class="hljs-meta">group.id</span>=<span class="hljs-string">shan-kou-zu</span></code></pre></div><p>2.æ‰“å¼€ä¸¤ä¸ªcmdï¼Œåˆ†åˆ«å¯åŠ¨ä¸¤ä¸ªæ¶ˆè´¹è€…ã€‚ï¼ˆä»¥<code>%KAFKA_HOME\config\consumer.properties%</code>ä½œé…ç½®å‚æ•°ï¼‰</p><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-consumer.bat --zookeeper <span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">2181</span> --topic test --consumer.config config\consumer.properties</code></pre></div><p>3.å†æ‰“å¼€ä¸€ä¸ªcmdï¼Œå¯åŠ¨ä¸€ä¸ªç”Ÿäº§è€…ã€‚</p><div class="code-wrapper"><pre><code class="hljs bat">bin\windows\kafka-console-producer.bat --broker-list <span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9092</span> --topic test</code></pre></div><p>4.åœ¨ç”Ÿäº§è€…çª—å£è¾“å…¥æ¶ˆæ¯ï¼Œè§‚å¯Ÿä¸¤ä¸ªæ¶ˆè´¹è€…çª—å£ã€‚<strong>ä¼šå‘ç°ä¸¤ä¸ªæ¶ˆè´¹è€…çª—å£ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ‰ä¼šå¼¹å‡ºæ¶ˆæ¯</strong>ã€‚</p><h3 id="2-12-é«˜æ•ˆè¯»å†™-amp-ZKä½œç”¨"><a href="#2-12-é«˜æ•ˆè¯»å†™-amp-ZKä½œç”¨" class="headerlink" title="2.12 é«˜æ•ˆè¯»å†™&amp;ZKä½œç”¨"></a>2.12 é«˜æ•ˆè¯»å†™&amp;ZKä½œç”¨</h3><h4 id="1-é¡ºåºå†™ç£ç›˜"><a href="#1-é¡ºåºå†™ç£ç›˜" class="headerlink" title="1 é¡ºåºå†™ç£ç›˜"></a>1 é¡ºåºå†™ç£ç›˜</h4><p>Kafka çš„ producer ç”Ÿäº§æ•°æ®ï¼Œè¦å†™å…¥åˆ° log æ–‡ä»¶ä¸­ï¼Œå†™çš„è¿‡ç¨‹æ˜¯ä¸€ç›´è¿½åŠ åˆ°æ–‡ä»¶æœ«ç«¯ï¼Œä¸ºé¡ºåºå†™ã€‚ å®˜ç½‘æœ‰æ•°æ®è¡¨æ˜ï¼ŒåŒæ ·çš„ç£ç›˜ï¼Œé¡ºåºå†™èƒ½åˆ° 600M/sï¼Œè€Œéšæœºå†™åªæœ‰ 100K/sã€‚è¿™ä¸ç£ç›˜çš„æœºæ¢°æœºæ„æœ‰å…³ï¼Œé¡ºåºå†™ä¹‹æ‰€ä»¥å¿«ï¼Œæ˜¯å› ä¸ºå…¶<strong>çœå»äº†å¤§é‡ç£å¤´å¯»å€çš„æ—¶é—´</strong>ã€‚</p><h4 id="2-é›¶å¤åˆ¶æŠ€æœ¯"><a href="#2-é›¶å¤åˆ¶æŠ€æœ¯" class="headerlink" title="2 é›¶å¤åˆ¶æŠ€æœ¯"></a>2 é›¶å¤åˆ¶æŠ€æœ¯</h4><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/14.png" alt></p><ul><li>NIC network interface controller ç½‘ç»œæ¥å£æ§åˆ¶å™¨</li></ul><h4 id="3-Zookeeper-åœ¨-Kafka-ä¸­çš„ä½œç”¨"><a href="#3-Zookeeper-åœ¨-Kafka-ä¸­çš„ä½œç”¨" class="headerlink" title="3 Zookeeper åœ¨ Kafka ä¸­çš„ä½œç”¨"></a>3 Zookeeper åœ¨ Kafka ä¸­çš„ä½œç”¨</h4><p>Kafka é›†ç¾¤ä¸­æœ‰ä¸€ä¸ª broker ä¼šè¢«é€‰ä¸¾ä¸º Controllerï¼Œè´Ÿè´£ç®¡ç†é›†ç¾¤ broker çš„ä¸Šä¸‹çº¿ï¼Œæ‰€æœ‰ topic çš„åˆ†åŒºå‰¯æœ¬åˆ†é…å’Œ leader é€‰ä¸¾ç­‰å·¥ä½œã€‚<a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fkafka.apache.org%2F0110%2Fdocumentation%2F%23design_replicamanagment">Reference</a></p><p>Controller çš„ç®¡ç†å·¥ä½œéƒ½æ˜¯ä¾èµ–äº Zookeeper çš„ã€‚</p><p>ä»¥ä¸‹ä¸º partition çš„ leader é€‰ä¸¾è¿‡ç¨‹ï¼š</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/15.png" alt></p><h3 id="2-13-Rangeråˆ†åŒºå†åˆ†æ"><a href="#2-13-Rangeråˆ†åŒºå†åˆ†æ" class="headerlink" title="2.13 Rangeråˆ†åŒºå†åˆ†æ"></a>2.13 Rangeråˆ†åŒºå†åˆ†æ</h3><h3 id="2-14-äº‹åŠ¡"><a href="#2-14-äº‹åŠ¡" class="headerlink" title="2.14 äº‹åŠ¡"></a>2.14 äº‹åŠ¡</h3><p>Kafka ä» 0.11 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†äº‹åŠ¡æ”¯æŒã€‚äº‹åŠ¡å¯ä»¥ä¿è¯ Kafka åœ¨ Exactly Once è¯­ä¹‰çš„åŸºç¡€ä¸Šï¼Œç”Ÿäº§å’Œæ¶ˆè´¹å¯ä»¥è·¨åˆ†åŒºå’Œä¼šè¯ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p><h4 id="1-Producer-äº‹åŠ¡"><a href="#1-Producer-äº‹åŠ¡" class="headerlink" title="1 Producer äº‹åŠ¡"></a>1 Producer äº‹åŠ¡</h4><p>ä¸ºäº†å®ç°è·¨åˆ†åŒºè·¨ä¼šè¯çš„äº‹åŠ¡ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ Transaction IDï¼Œå¹¶å°† Producer è·å¾—çš„PID å’ŒTransaction ID ç»‘å®šã€‚è¿™æ ·å½“Producer é‡å¯åå°±å¯ä»¥é€šè¿‡æ­£åœ¨è¿›è¡Œçš„ TransactionID è·å¾—åŸæ¥çš„ PIDã€‚</p><p>ä¸ºäº†ç®¡ç† Transactionï¼Œ Kafka å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç»„ä»¶ Transaction Coordinatorã€‚ Producer å°±æ˜¯é€šè¿‡å’Œ Transaction Coordinator äº¤äº’è·å¾— Transaction ID å¯¹åº”çš„ä»»åŠ¡çŠ¶æ€ã€‚ Transaction Coordinator è¿˜è´Ÿè´£å°†äº‹åŠ¡æ‰€æœ‰å†™å…¥ Kafka çš„ä¸€ä¸ªå†…éƒ¨ Topicï¼Œè¿™æ ·å³ä½¿æ•´ä¸ªæœåŠ¡é‡å¯ï¼Œç”±äºäº‹åŠ¡çŠ¶æ€å¾—åˆ°ä¿å­˜ï¼Œè¿›è¡Œä¸­çš„äº‹åŠ¡çŠ¶æ€å¯ä»¥å¾—åˆ°æ¢å¤ï¼Œä»è€Œç»§ç»­è¿›è¡Œã€‚</p><h4 id="2-Consumer-äº‹åŠ¡"><a href="#2-Consumer-äº‹åŠ¡" class="headerlink" title="2 Consumer äº‹åŠ¡"></a>2 Consumer äº‹åŠ¡</h4><p>ä¸Šè¿°äº‹åŠ¡æœºåˆ¶ä¸»è¦æ˜¯ä» Producer æ–¹é¢è€ƒè™‘ï¼Œå¯¹äº Consumer è€Œè¨€ï¼Œäº‹åŠ¡çš„ä¿è¯å°±ä¼šç›¸å¯¹è¾ƒå¼±ï¼Œå°¤å…¶æ—¶æ— æ³•ä¿è¯ Commit çš„ä¿¡æ¯è¢«ç²¾ç¡®æ¶ˆè´¹ã€‚è¿™æ˜¯ç”±äº Consumer å¯ä»¥é€šè¿‡ offset è®¿é—®ä»»æ„ä¿¡æ¯ï¼Œè€Œä¸”ä¸åŒçš„ Segment File ç”Ÿå‘½å‘¨æœŸä¸åŒï¼ŒåŒä¸€äº‹åŠ¡çš„æ¶ˆæ¯å¯èƒ½ä¼šå‡ºç°é‡å¯åè¢«åˆ é™¤çš„æƒ…å†µã€‚</p><h3 id="2-15-APIç”Ÿäº§è€…æµç¨‹"><a href="#2-15-APIç”Ÿäº§è€…æµç¨‹" class="headerlink" title="2.15 APIç”Ÿäº§è€…æµç¨‹"></a>2.15 APIç”Ÿäº§è€…æµç¨‹</h3><p>Kafka çš„ Producer å‘é€æ¶ˆæ¯é‡‡ç”¨çš„æ˜¯å¼‚æ­¥å‘é€çš„æ–¹å¼ã€‚åœ¨æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°äº†ä¸¤ä¸ªçº¿ç¨‹â€”â€”main çº¿ç¨‹å’Œ Sender çº¿ç¨‹ï¼Œä»¥åŠä¸€ä¸ªçº¿ç¨‹å…±äº«å˜é‡â€”â€”RecordAccumulatorã€‚ main çº¿ç¨‹å°†æ¶ˆæ¯å‘é€ç»™ RecordAccumulatorï¼Œ Sender çº¿ç¨‹ä¸æ–­ä» RecordAccumulator ä¸­æ‹‰å–æ¶ˆæ¯å‘é€åˆ° Kafka brokerã€‚</p><p><img src="/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/19.png" alt></p><p>ç›¸å…³å‚æ•°ï¼š</p><ul><li><strong>batch.size</strong>ï¼š åªæœ‰æ•°æ®ç§¯ç´¯åˆ° batch.size ä¹‹åï¼Œ sender æ‰ä¼šå‘é€æ•°æ®ã€‚</li><li><strong>linger.ms</strong>ï¼š å¦‚æœæ•°æ®è¿Ÿè¿Ÿæœªè¾¾åˆ° batch.sizeï¼Œ sender ç­‰å¾… linger.time ä¹‹åå°±ä¼šå‘é€æ•°æ®ã€‚</li></ul><h3 id="2-16å¼‚æ­¥å‘é€APIæ™®é€šç”Ÿäº§è€…"><a href="#2-16å¼‚æ­¥å‘é€APIæ™®é€šç”Ÿäº§è€…" class="headerlink" title="2.16å¼‚æ­¥å‘é€APIæ™®é€šç”Ÿäº§è€…"></a>2.16å¼‚æ­¥å‘é€APIæ™®é€šç”Ÿäº§è€…</h3><h4 id="1-å¯¼å…¥ä¾èµ–"><a href="#1-å¯¼å…¥ä¾èµ–" class="headerlink" title="1 å¯¼å…¥ä¾èµ–"></a>1 å¯¼å…¥ä¾èµ–</h4><p><a href="https://my.oschina.net/jallenkwong/blog/pom.xml">pom.xml</a></p><div class="code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div><h4 id="2-ç¼–å†™ä»£ç "><a href="#2-ç¼–å†™ä»£ç " class="headerlink" title="2 ç¼–å†™ä»£ç "></a>2 ç¼–å†™ä»£ç </h4><p>éœ€è¦ç”¨åˆ°çš„ç±»ï¼š</p><ul><li>KafkaProducerï¼šéœ€è¦åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…å¯¹è±¡ï¼Œç”¨æ¥å‘é€æ•°æ®</li><li>ProducerConfigï¼šè·å–æ‰€éœ€çš„ä¸€ç³»åˆ—é…ç½®å‚æ•°</li><li>ProducerRecordï¼šæ¯æ¡æ•°æ®éƒ½è¦å°è£…æˆä¸€ä¸ª ProducerRecord å¯¹è±¡</li></ul><p><a href="https://gitee.com/jallenkwong/LearnKafka/blob/master/src/main/java/com/lun/kafka/producer/CustomProducer.java">CustomProducer.java</a></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Properties;<span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;<span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.Producer;<span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomProducer</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;Properties props = <span class="hljs-keyword">new</span> Properties();<span class="hljs-comment">// kafka é›†ç¾¤ï¼Œ broker-list</span>props.put(<span class="hljs-string">&quot;bootstrap.servers&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:9092&quot;</span>);<span class="hljs-comment">//å¯ç”¨ProducerConfig.ACKS_CONFIG ä»£æ›¿ &quot;acks&quot;</span><span class="hljs-comment">//props.put(ProducerConfig.ACKS_CONFIG, &quot;all&quot;);</span>props.put(<span class="hljs-string">&quot;acks&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>);<span class="hljs-comment">// é‡è¯•æ¬¡æ•°</span>props.put(<span class="hljs-string">&quot;retries&quot;</span>, <span class="hljs-number">1</span>);<span class="hljs-comment">// æ‰¹æ¬¡å¤§å°</span>props.put(<span class="hljs-string">&quot;batch.size&quot;</span>, <span class="hljs-number">16384</span>);<span class="hljs-comment">// ç­‰å¾…æ—¶é—´</span>props.put(<span class="hljs-string">&quot;linger.ms&quot;</span>, <span class="hljs-number">1</span>);<span class="hljs-comment">// RecordAccumulator ç¼“å†²åŒºå¤§å°</span>props.put(<span class="hljs-string">&quot;buffer.memory&quot;</span>, <span class="hljs-number">33554432</span>);props.put(<span class="hljs-string">&quot;key.serializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);props.put(<span class="hljs-string">&quot;value.serializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);Producer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> KafkaProducer&lt;&gt;(props);<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;producer.send(<span class="hljs-keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test-&quot;</span> + Integer.toString(i),<span class="hljs-string">&quot;test-&quot;</span> + Integer.toString(i)));&#125;producer.close();&#125;&#125;</code></pre></div><h3 id="2-17-å›é¡¾"><a href="#2-17-å›é¡¾" class="headerlink" title="2.17 å›é¡¾"></a>2.17 å›é¡¾</h3>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Technical/">Technical</category>
      
      <category domain="https://pncalbl.github.io/categories/Technical/Distributed/">Distributed</category>
      
      
      <category domain="https://pncalbl.github.io/tags/Kafka/">Kafka</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/25/Kafka%E5%AD%A6%E4%B9%A0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶</title>
      <link>https://pncalbl.github.io/2021/05/22/Clion%E6%90%AD%E5%BB%BAGtest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/</link>
      <guid>https://pncalbl.github.io/2021/05/22/Clion%E6%90%AD%E5%BB%BAGtest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/</guid>
      <pubDate>Fri, 21 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶&quot;&gt;&lt;a href=&quot;#Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶&quot; class=&quot;headerlink&quot; title=&quot;Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶&quot;&gt;&lt;/a&gt;Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶&lt;/h1&gt;&lt;h2 id=&quot;1</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶"><a href="#Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶" class="headerlink" title="Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶"></a>Clionæ­å»ºGtestå•å…ƒæµ‹è¯•æ¡†æ¶</h1><h2 id="1-ä¸‹è½½GTestæºç "><a href="#1-ä¸‹è½½GTestæºç " class="headerlink" title="1 ä¸‹è½½GTestæºç "></a>1 ä¸‹è½½GTestæºç </h2><div class="code-wrapper"><pre><code class="hljs shell">git clone https://github.com/google/googletest.git</code></pre></div><p>ä¸‹è½½ä¸‹æ¥çš„google gtestæºç ç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œé‡Œé¢åŒ…å«äº†å¾ˆå¤šä¸œè¥¿ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ˜¯æƒ³åˆ©ç”¨gtestå¯¹è‡ªå·±çš„ä»£ç è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå› æ­¤åªéœ€è¦å…³æ³¨çº¢æ¡†æ‰€æ±‚çš„æ–‡ä»¶å¤¹å³å¯ï¼Œå…¶ä»–çš„æš‚æ—¶ä¸éœ€è¦å…³æ³¨</p><p><img src="/2021/05/22/Clion%E6%90%AD%E5%BB%BAGtest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/570699-20190715005207916-173277913.png" alt="img"></p><h2 id="2-å¯¼å…¥-Gtest"><a href="#2-å¯¼å…¥-Gtest" class="headerlink" title="2 å¯¼å…¥ Gtest"></a>2 å¯¼å…¥ Gtest</h2><p>ä½¿ç”¨CLionæ–°å»ºä¸€ä¸‹C++é¡¹ç›®ï¼ŒæŠŠgtestå¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼Œå°†ä¸Šé¢googletestç›®å½•æ”¾åœ¨externalä¸‹é¢äº†ï¼Œè¿™ä¸ªç›®å½•éšæ„ï¼Œçœ‹ä¸ªäººå–œå¥½äº†ã€‚</p><p><img src="/2021/05/22/Clion%E6%90%AD%E5%BB%BAGtest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/image-20210525000900512.png" alt="image-20210525000900512"></p><h2 id="3-é…ç½®-CMakeList-txt"><a href="#3-é…ç½®-CMakeList-txt" class="headerlink" title="3 é…ç½® CMakeList.txt"></a>3 é…ç½® CMakeList.txt</h2><ul><li>è®¾ç½®<strong>GOOGLETEST_VERSION</strong>å˜é‡ï¼Œè¿™ä¸ªå˜é‡ï¼Œå…¶å®æ˜¯åœ¨googletest-masterç›®å½•ä¸‹çš„CMakeLists.txtä¸­è®¾ç½®çš„ï¼Œåœ¨googlegtestç›®å½•ä¸‹çš„CMakeLists.txtä¸­ä½¿ç”¨ï¼Œå¦‚æœæˆ‘ä»¬ä¸åœ¨é¡¹ç›®çš„CMaksLists.txtä¸­è®¾ç½®è¿™ä¸ªå˜é‡ï¼Œåˆ™gtestçš„ç¼–è¯‘ä¼šå¤±è´¥ï¼Œè¿™ç‚¹éå¸¸é‡è¦ã€‚</li><li>æ·»åŠ googletestç›®å½•åˆ°é¡¹ç›®ä¸­ï¼Œè¿™ä¸ªå¾ˆç®€å•ã€‚</li><li>æ·»åŠ target linkï¼Œè¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘æ–°äº†ä¸€ä¸ªdemotest.cppï¼Œé‡Œé¢ç”¨æ¥æ”¾ç½®å•å…ƒæµ‹è¯•ç”¨ä¾‹ç›¸å…³çš„ä»£ç ï¼Œå°†å…¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ¥å¯¹æ­£å¼é¡¹ç›®ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œå› ä¸ºå®ƒä¾èµ–äºgtest_mainï¼Œå› æ­¤è¿™é‡Œå¿…é¡»æŠŠå®ƒä»¬linkèµ·æ¥ï¼Œå¦åˆ™ï¼Œtest_mainçš„ç¼–è¯‘ä¼šå¤±è´¥ã€‚</li></ul><div class="code-wrapper"><pre><code class="hljs cmake"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.17</span>)    <span class="hljs-comment"># cmakeæœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span><span class="hljs-keyword">project</span>(TestProject)    <span class="hljs-comment"># é¡¹ç›®å</span><span class="hljs-keyword">set</span>(GOOGLETEST_VERSION <span class="hljs-number">1.10</span>.<span class="hljs-number">0</span>)  <span class="hljs-comment"># è®¾ç½® Gtest çš„ç‰ˆæœ¬</span><span class="hljs-keyword">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">11</span>)      <span class="hljs-comment"># C++ ç‰ˆæœ¬</span><span class="hljs-keyword">set</span>(CMAKE_CXX_FLAGS <span class="hljs-string">&quot;-Wall&quot;</span>)    <span class="hljs-comment">#</span><span class="hljs-comment"># ç¼–è¯‘google testï¼Œä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆlibtest.aé™æ€åº“</span><span class="hljs-keyword">add_subdirectory</span>(        external/googletest)<span class="hljs-comment"># æ·»åŠ å¤´æ–‡ä»¶</span><span class="hljs-keyword">include_directories</span>(        <span class="hljs-keyword">include</span>        external/googletest/<span class="hljs-keyword">include</span>)<span class="hljs-comment">#éœ€è¦æ·»åŠ googletestè¿è¡Œéœ€è¦çš„pthread</span><span class="hljs-keyword">set</span>(LIBRARIES        gtest        pthread)<span class="hljs-keyword">set</span>(SOURCE_FLIES tests/demotest.cpp) <span class="hljs-comment"># å…¶ä½™æ–‡ä»¶</span><span class="hljs-keyword">add_executable</span>(main src/main.cpp)   <span class="hljs-comment"># main å‡½æ•°</span><span class="hljs-keyword">add_executable</span>(TestProject <span class="hljs-variable">$&#123;SOURCE_FLIES&#125;</span> external/googletest)<span class="hljs-keyword">target_link_libraries</span>(TestProject gtest_main)</code></pre></div><h2 id="4-æµ‹è¯•"><a href="#4-æµ‹è¯•" class="headerlink" title="4 æµ‹è¯•"></a>4 æµ‹è¯•</h2><p>demotest.cpp</p><div class="code-wrapper"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;gtest/gtest.h&quot;</span></span><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ::testing;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GTestDemo</span> :</span> <span class="hljs-keyword">public</span> Test &#123;<span class="hljs-keyword">public</span>:    <span class="hljs-built_in">GTestDemo</span>() : <span class="hljs-built_in">Test</span>() &#123;    &#125;    ~<span class="hljs-built_in">GTestDemo</span>() <span class="hljs-keyword">override</span> = <span class="hljs-keyword">default</span>;    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123;        Test::<span class="hljs-built_in">SetUp</span>();        std::cout &lt;&lt; <span class="hljs-string">&quot;I am setup&quot;</span> &lt;&lt; std::endl;    &#125;    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TearDown</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123;        Test::<span class="hljs-built_in">TearDown</span>();        std::cout &lt;&lt; <span class="hljs-string">&quot;I am teardown&quot;</span> &lt;&lt; std::endl;    &#125;&#125;;<span class="hljs-built_in">TEST_F</span>(GTestDemo, tc_example_01) &#123;    std::cout &lt;&lt; <span class="hljs-string">&quot;GTestDemo&quot;</span> &lt;&lt; std::endl;&#125;</code></pre></div><p><img src="/2021/05/22/Clion%E6%90%AD%E5%BB%BAGtest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/image-20210525001538855.png" alt="image-20210525001538855"></p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Help/">Help</category>
      
      <category domain="https://pncalbl.github.io/categories/Help/Win/">Win</category>
      
      
      <category domain="https://pncalbl.github.io/tags/Note/">Note</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/22/Clion%E6%90%AD%E5%BB%BAGtest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Netty å­¦ä¹ </title>
      <link>https://pncalbl.github.io/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/</link>
      <guid>https://pncalbl.github.io/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/</guid>
      <pubDate>Fri, 21 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Netty-å­¦ä¹ &quot;&gt;&lt;a href=&quot;#Netty-å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;Netty å­¦ä¹ &quot;&gt;&lt;/a&gt;Netty å­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;1-Netty-ä»‹ç»å’Œåº”ç”¨åœºæ™¯&quot;&gt;&lt;a href=&quot;#1-Netty-ä»‹ç»å’Œåº”ç”¨åœº</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Netty-å­¦ä¹ "><a href="#Netty-å­¦ä¹ " class="headerlink" title="Netty å­¦ä¹ "></a>Netty å­¦ä¹ </h1><h2 id="1-Netty-ä»‹ç»å’Œåº”ç”¨åœºæ™¯"><a href="#1-Netty-ä»‹ç»å’Œåº”ç”¨åœºæ™¯" class="headerlink" title="1 Netty ä»‹ç»å’Œåº”ç”¨åœºæ™¯"></a>1 Netty ä»‹ç»å’Œåº”ç”¨åœºæ™¯</h2><h3 id="1-1-æœ¬è¯¾ç¨‹çš„å­¦ä¹ è¦æ±‚"><a href="#1-1-æœ¬è¯¾ç¨‹çš„å­¦ä¹ è¦æ±‚" class="headerlink" title="1.1 æœ¬è¯¾ç¨‹çš„å­¦ä¹ è¦æ±‚"></a>1.1 æœ¬è¯¾ç¨‹çš„å­¦ä¹ è¦æ±‚</h3><ol><li>æœ¬è¯¾ç¨‹ä¸é€‚ç”¨äº <code>0</code> åŸºç¡€çš„å­¦å‘˜ã€‚</li><li>è¦æ±‚å·²ç»æŒæ¡äº† <code>Java</code> ç¼–ç¨‹ï¼Œä¸»è¦æŠ€æœ¯æ„æˆï¼š<code>Java OOP</code> ç¼–ç¨‹ã€<code>Java</code> å¤šçº¿ç¨‹ç¼–ç¨‹ã€<code>Java IO</code> ç¼–ç¨‹ã€<code>Java</code> ç½‘ç»œç¼–ç¨‹ã€å¸¸ç”¨çš„ <code>Java</code> è®¾è®¡æ¨¡å¼ï¼ˆæ¯”å¦‚è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå‘½ä»¤æ¨¡å¼ï¼ŒèŒè´£é“¾æ¨¡å¼ï¼‰ã€å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼ˆæ¯”å¦‚é“¾è¡¨ï¼‰ã€‚</li><li>æœ¬è¯¾ç¨‹çš„ã€Š<code>Netty</code> æ ¸å¿ƒæºç å‰–æç« èŠ‚ã€‹è¦æ±‚å­¦å‘˜æœ€å¥½æœ‰é¡¹ç›®å¼€å‘å’Œé˜…è¯»æºç çš„ç»å†ã€‚</li></ol><h3 id="1-2-Netty-çš„ä»‹ç»"><a href="#1-2-Netty-çš„ä»‹ç»" class="headerlink" title="1.2 Netty çš„ä»‹ç»"></a>1.2 Netty çš„ä»‹ç»</h3><ol><li><code>Netty</code> æ˜¯ç”± <code>JBOSS</code> æä¾›çš„ä¸€ä¸ª <code>Java</code> å¼€æºæ¡†æ¶ï¼Œç°ä¸º <code>Github</code> ä¸Šçš„ç‹¬ç«‹é¡¹ç›®ã€‚</li><li><code>Netty</code> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œ <code>IO</code> ç¨‹åºã€‚</li><li><code>Netty</code> ä¸»è¦é’ˆå¯¹åœ¨ <code>TCP</code> åè®®ä¸‹ï¼Œé¢å‘ <code>Client</code> ç«¯çš„é«˜å¹¶å‘åº”ç”¨ï¼Œæˆ–è€… <code>Peer-to-Peer</code> åœºæ™¯ä¸‹çš„å¤§é‡æ•°æ®æŒç»­ä¼ è¾“çš„åº”ç”¨ã€‚</li><li><code>Netty</code> æœ¬è´¨æ˜¯ä¸€ä¸ª <code>NIO</code> æ¡†æ¶ï¼Œé€‚ç”¨äºæœåŠ¡å™¨é€šè®¯ç›¸å…³çš„å¤šç§åº”ç”¨åœºæ™¯ã€‚</li><li>è¦é€å½»ç†è§£ <code>Netty</code>ï¼Œéœ€è¦å…ˆå­¦ä¹  <code>NIO</code>ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½é˜…è¯» <code>Netty</code> çš„æºç ã€‚</li></ol><h3 id="1-3-Netty-çš„åº”ç”¨åœºæ™¯"><a href="#1-3-Netty-çš„åº”ç”¨åœºæ™¯" class="headerlink" title="1.3 Netty çš„åº”ç”¨åœºæ™¯"></a>1.3 Netty çš„åº”ç”¨åœºæ™¯</h3><h4 id="1-3-1-äº’è”ç½‘è¡Œä¸š"><a href="#1-3-1-äº’è”ç½‘è¡Œä¸š" class="headerlink" title="1.3.1 äº’è”ç½‘è¡Œä¸š"></a>1.3.1 äº’è”ç½‘è¡Œä¸š</h4><ol><li><p>äº’è”ç½‘è¡Œä¸šï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éœ€è¦è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Œé«˜æ€§èƒ½çš„ <code>RPC</code> æ¡†æ¶å¿…ä¸å¯å°‘ï¼Œ<code>Netty</code> ä½œä¸ºå¼‚æ­¥é«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶ï¼Œå¾€å¾€ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶è¢«è¿™äº› <code>RPC</code> æ¡†æ¶ä½¿ç”¨ã€‚</p></li><li><p>å…¸å‹çš„åº”ç”¨æœ‰ï¼šé˜¿é‡Œåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ <code>Dubbo</code> çš„ <code>RPC</code> æ¡† æ¶ä½¿ç”¨ <code>Dubbo</code> åè®®è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡ï¼Œ<code>Dubbo</code> åè®®é»˜è®¤ä½¿ç”¨ <code>Netty</code> ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œç”¨äºå®ç°å„è¿›ç¨‹èŠ‚ç‚¹ä¹‹é—´çš„å†…éƒ¨é€šä¿¡ã€‚</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter01_01.png" alt></p></li></ol><h4 id="1-3-2-æ¸¸æˆè¡Œä¸š"><a href="#1-3-2-æ¸¸æˆè¡Œä¸š" class="headerlink" title="1.3.2 æ¸¸æˆè¡Œä¸š"></a>1.3.2 æ¸¸æˆè¡Œä¸š</h4><ol><li>æ— è®ºæ˜¯æ‰‹æ¸¸æœåŠ¡ç«¯è¿˜æ˜¯å¤§å‹çš„ç½‘ç»œæ¸¸æˆï¼Œ<code>Java</code> è¯­è¨€å¾—åˆ°äº†è¶Šæ¥è¶Šå¹¿æ³›çš„åº”ç”¨ã€‚</li><li><code>Netty</code> ä½œä¸ºé«˜æ€§èƒ½çš„åŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œæä¾›äº† <code>TCP/UDP</code> å’Œ <code>HTTP</code> åè®®æ ˆï¼Œæ–¹ä¾¿å®šåˆ¶å’Œå¼€å‘ç§æœ‰åè®®æ ˆï¼Œè´¦å·ç™»å½•æœåŠ¡å™¨ã€‚</li><li>åœ°å›¾æœåŠ¡å™¨ä¹‹é—´å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ <code>Netty</code> è¿›è¡Œé«˜æ€§èƒ½çš„é€šä¿¡ã€‚</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter01_02.png" alt></p><p>â€‹                    <img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter01_03.png" alt></p><h4 id="1-3-3-å¤§æ•°æ®é¢†åŸŸ"><a href="#1-3-3-å¤§æ•°æ®é¢†åŸŸ" class="headerlink" title="1.3.3 å¤§æ•°æ®é¢†åŸŸ"></a>1.3.3 å¤§æ•°æ®é¢†åŸŸ</h4><ol><li>ç»å…¸çš„ <code>Hadoop</code> çš„é«˜æ€§èƒ½é€šä¿¡å’Œåºåˆ—åŒ–ç»„ä»¶ <code>Avro</code> çš„ <code>RPC</code> æ¡†æ¶ï¼Œé»˜è®¤é‡‡ç”¨ <code>Netty</code> è¿›è¡Œè·¨ç•Œç‚¹é€šä¿¡ã€‚</li><li>å®ƒçš„ <code>NettyService</code> åŸºäº <code>Netty</code> æ¡†æ¶äºŒæ¬¡å°è£…å®ç°ã€‚</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter01_04.png" alt></p><h4 id="1-3-4-å…¶ä»–å¼€æºé¡¹ç›®ä½¿ç”¨åˆ°-Netty"><a href="#1-3-4-å…¶ä»–å¼€æºé¡¹ç›®ä½¿ç”¨åˆ°-Netty" class="headerlink" title="1.3.4 å…¶ä»–å¼€æºé¡¹ç›®ä½¿ç”¨åˆ° Netty"></a>1.3.4 å…¶ä»–å¼€æºé¡¹ç›®ä½¿ç”¨åˆ° Netty</h4><p>ç½‘å€ï¼š<a href="https://netty.io/wiki/related-projects.html">https://netty.io/wiki/related-projects.html</a></p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter01_05.png" alt></p><h3 id="1-4-Netty-çš„å­¦ä¹ èµ„æ–™çš„å‚è€ƒ"><a href="#1-4-Netty-çš„å­¦ä¹ èµ„æ–™çš„å‚è€ƒ" class="headerlink" title="1.4 Netty çš„å­¦ä¹ èµ„æ–™çš„å‚è€ƒ"></a>1.4 Netty çš„å­¦ä¹ èµ„æ–™çš„å‚è€ƒ</h3><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/59141c1dN7a93c127.jpg" alt></p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/555080b2Ne6cbf9e3.jpg" alt></p><h2 id="2-Java-BIO-ç¼–ç¨‹"><a href="#2-Java-BIO-ç¼–ç¨‹" class="headerlink" title="2 Java BIO ç¼–ç¨‹"></a>2 Java BIO ç¼–ç¨‹</h2><h3 id="2-1-I-O-æ¨¡å‹"><a href="#2-1-I-O-æ¨¡å‹" class="headerlink" title="2.1 I/O æ¨¡å‹"></a>2.1 I/O æ¨¡å‹</h3><h4 id="2-1-1-æ¨¡å‹åŸºæœ¬è¯´æ˜"><a href="#2-1-1-æ¨¡å‹åŸºæœ¬è¯´æ˜" class="headerlink" title="2.1.1 æ¨¡å‹åŸºæœ¬è¯´æ˜"></a>2.1.1 æ¨¡å‹åŸºæœ¬è¯´æ˜</h4><ol><li><code>I/O</code> æ¨¡å‹ç®€å•çš„ç†è§£ï¼šå°±æ˜¯ç”¨ä»€ä¹ˆæ ·çš„é€šé“è¿›è¡Œæ•°æ®çš„å‘é€å’Œæ¥æ”¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†ç¨‹åºé€šä¿¡çš„æ€§èƒ½ã€‚</li><li><code>Java</code> å…±æ”¯æŒ <code>3</code> ç§ç½‘ç»œç¼–ç¨‹æ¨¡å‹ <code>I/O</code> æ¨¡å¼ï¼š<code>BIO</code>ã€<code>NIO</code>ã€<code>AIO</code>ã€‚</li><li><code>Java BIO</code>ï¼šåŒæ­¥å¹¶é˜»å¡ï¼ˆä¼ ç»Ÿé˜»å¡å‹ï¼‰ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ã€‚ã€ç®€å•ç¤ºæ„å›¾ã€‘</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter02_01.png" alt></p><ol start="4"><li><code>Java NIO</code>ï¼šåŒæ­¥éé˜»å¡ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚ï¼ˆè¿æ¥ï¼‰ï¼Œå³å®¢æˆ·ç«¯å‘é€çš„è¿æ¥è¯·æ±‚éƒ½ä¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰ <code>I/O</code> è¯·æ±‚å°±è¿›è¡Œå¤„ç†ã€‚ã€ç®€å•ç¤ºæ„å›¾ã€‘</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter02_02.png" alt></p><ol start="5"><li><code>Java AIO(NIO.2)</code>ï¼šå¼‚æ­¥éé˜»å¡ï¼Œ<code>AIO</code> å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† <code>Proactor</code> æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å»å¤„ç†ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨ã€‚</li></ol><h3 id="2-2-BIOã€NIOã€AIO-ä½¿ç”¨åœºæ™¯åˆ†æ"><a href="#2-2-BIOã€NIOã€AIO-ä½¿ç”¨åœºæ™¯åˆ†æ" class="headerlink" title="2.2  BIOã€NIOã€AIO ä½¿ç”¨åœºæ™¯åˆ†æ"></a>2.2  BIOã€NIOã€AIO ä½¿ç”¨åœºæ™¯åˆ†æ</h3><ol><li><code>BIO</code> æ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œ<code>JDK1.4</code> ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ï¼Œä½†ç¨‹åºç®€å•æ˜“ç†è§£ã€‚</li><li><code>NIO</code> æ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¼¹å¹•ç³»ç»Ÿï¼ŒæœåŠ¡å™¨é—´é€šè®¯ç­‰ã€‚ç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œ<code>JDK1.4</code> å¼€å§‹æ”¯æŒã€‚</li><li><code>AIO</code> æ–¹å¼ä½¿ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ†è°ƒç”¨ <code>OS</code> å‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œ<code>JDK7</code> å¼€å§‹æ”¯æŒã€‚</li></ol><h3 id="2-3-Java-BIO-çš„åŸºæœ¬ä»‹ç»"><a href="#2-3-Java-BIO-çš„åŸºæœ¬ä»‹ç»" class="headerlink" title="2.3 Java BIO çš„åŸºæœ¬ä»‹ç»"></a>2.3 Java BIO çš„åŸºæœ¬ä»‹ç»</h3><ol><li><code>Java BIO</code>å°±æ˜¯ä¼ ç»Ÿçš„<code>Java I/O</code>ç¼–ç¨‹ï¼Œå…¶ç›¸å…³çš„ç±»å’Œæ¥å£åœ¨<code>java.io</code>ã€‚</li><li><code>BIO(BlockingI/O)</code>ï¼šåŒæ­¥é˜»å¡ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹æ± æœºåˆ¶æ”¹å–„ï¼ˆå®ç°å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨ï¼‰ã€‚</li><li><code>BIO</code>æ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œ<code>JDK1.4</code>ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ï¼Œç¨‹åºç®€æ˜“ç†è§£ã€‚</li></ol><h3 id="2-4-Java-BIO-çš„å·¥ä½œæœºåˆ¶"><a href="#2-4-Java-BIO-çš„å·¥ä½œæœºåˆ¶" class="headerlink" title="2.4 Java BIO çš„å·¥ä½œæœºåˆ¶"></a>2.4 Java BIO çš„å·¥ä½œæœºåˆ¶</h3><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter02_03.png" alt></p><p>å¯¹<code>BIO</code>ç¼–ç¨‹æµç¨‹çš„æ¢³ç†</p><ol><li>æœåŠ¡å™¨ç«¯å¯åŠ¨ä¸€ä¸ª<code>ServerSocket</code>ã€‚</li><li>å®¢æˆ·ç«¯å¯åŠ¨<code>Socket</code>å¯¹æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹æœåŠ¡å™¨ç«¯éœ€è¦å¯¹æ¯ä¸ªå®¢æˆ·å»ºç«‹ä¸€ä¸ªçº¿ç¨‹ä¸ä¹‹é€šä¿¡ã€‚</li><li>å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚åï¼Œå…ˆå’¨è¯¢æœåŠ¡å™¨æ˜¯å¦æœ‰çº¿ç¨‹å“åº”ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šç­‰å¾…ï¼Œæˆ–è€…è¢«æ‹’ç»ã€‚</li><li>å¦‚æœæœ‰å“åº”ï¼Œå®¢æˆ·ç«¯çº¿ç¨‹ä¼šç­‰å¾…è¯·æ±‚ç»“æŸåï¼Œå†ç»§ç»­æ‰§è¡Œã€‚</li></ol><h3 id="2-5-Java-BIO-åº”ç”¨å®ä¾‹"><a href="#2-5-Java-BIO-åº”ç”¨å®ä¾‹" class="headerlink" title="2.5 Java BIO åº”ç”¨å®ä¾‹"></a>2.5 Java BIO åº”ç”¨å®ä¾‹</h3><p>å®ä¾‹è¯´æ˜ï¼š</p><ol><li><p>ä½¿ç”¨ <code>BIO</code> æ¨¡å‹ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨ç«¯ï¼Œç›‘å¬ <code>6666</code> ç«¯å£ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå°±å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¸ä¹‹é€šè®¯ã€‚</p></li><li><p>è¦æ±‚ä½¿ç”¨çº¿ç¨‹æ± æœºåˆ¶æ”¹å–„ï¼Œå¯ä»¥è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ã€‚</p></li><li><p>æœåŠ¡å™¨ç«¯å¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼ˆ<code>telnet</code> æ–¹å¼å³å¯ï¼‰ã€‚</p></li><li><p>ä»£ç æ¼”ç¤º</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.bio;<span class="hljs-keyword">import</span> java.io.InputStream;<span class="hljs-keyword">import</span> java.net.ServerSocket;<span class="hljs-keyword">import</span> java.net.Socket;<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<span class="hljs-keyword">import</span> java.util.concurrent.Executors;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BIOServer</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">// çº¿ç¨‹æ± æœºåˆ¶</span>        <span class="hljs-comment">// æ€è·¯</span>        <span class="hljs-comment">// 1. åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± </span>        <span class="hljs-comment">// 2. å¦‚æœæœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯(å•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•)</span>        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();        <span class="hljs-comment">// åˆ›å»º ServerSocket</span>        ServerSocket serverSocket = <span class="hljs-keyword">new</span> ServerSocket(<span class="hljs-number">6666</span>);        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨å¯åŠ¨äº†&quot;</span>);        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;            System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹ä¿¡æ¯id = &quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;åå­— = &quot;</span> + Thread.currentThread().getName());            <span class="hljs-comment">// ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span>            System.out.println(<span class="hljs-string">&quot;ç­‰å¾…è¿æ¥....&quot;</span>);            <span class="hljs-keyword">final</span> Socket socket = serverSocket.accept();            System.out.println(<span class="hljs-string">&quot;è¿æ¥åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯&quot;</span>);            <span class="hljs-comment">// å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯(å•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•)</span>            newCachedThreadPool.execute(<span class="hljs-keyword">new</span> Runnable() &#123;                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-comment">// æˆ‘ä»¬é‡å†™</span>                    <span class="hljs-comment">// å¯ä»¥å’Œå®¢æˆ·ç«¯é€šè®¯</span>                    handler(socket);                &#125;            &#125;);        &#125;    &#125;    <span class="hljs-comment">// ç¼–å†™ä¸€ä¸ªhandleræ–¹æ³•ï¼Œå’Œå®¢æˆ·ç«¯é€šè®¯</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handler</span><span class="hljs-params">(Socket socket)</span> </span>&#123;        <span class="hljs-keyword">try</span> &#123;            System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹ä¿¡æ¯id = &quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;åå­— = &quot;</span> + Thread.currentThread().getName());            <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];            <span class="hljs-comment">// é€šè¿‡socketè·å–è¾“å…¥æµ</span>            InputStream inputStream = socket.getInputStream();            <span class="hljs-comment">// å¾ªç¯çš„è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;                System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹ä¿¡æ¯id = &quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;åå­— = &quot;</span> + Thread.currentThread().getName());                System.out.println(<span class="hljs-string">&quot;read....&quot;</span>);                <span class="hljs-keyword">int</span> read = inputStream.read(bytes);                <span class="hljs-keyword">if</span> (read != -<span class="hljs-number">1</span>) &#123;                    System.out.println(<span class="hljs-keyword">new</span> String(bytes, <span class="hljs-number">0</span>, read));<span class="hljs-comment">// è¾“å‡ºå®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span>                &#125; <span class="hljs-keyword">else</span> &#123;                    <span class="hljs-keyword">break</span>;                &#125;            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            System.out.println(<span class="hljs-string">&quot;å…³é—­å’Œclientçš„è¿æ¥&quot;</span>);            <span class="hljs-keyword">try</span> &#123;                socket.close();            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                e.printStackTrace();            &#125;        &#125;    &#125;&#125;</code></pre></div></li></ol><h3 id="2-6-Java-BIO-é—®é¢˜åˆ†æ"><a href="#2-6-Java-BIO-é—®é¢˜åˆ†æ" class="headerlink" title="2.6 Java BIO é—®é¢˜åˆ†æ"></a>2.6 Java BIO é—®é¢˜åˆ†æ</h3><ol><li>æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åˆ›å»ºç‹¬ç«‹çš„çº¿ç¨‹ï¼Œä¸å¯¹åº”çš„å®¢æˆ·ç«¯è¿›è¡Œæ•°æ® <code>Read</code>ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ® <code>Write</code>ã€‚</li><li>å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§ã€‚</li><li>è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨ <code>Read</code> æ“ä½œä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹ã€‚</li></ol><h2 id="3-Java-NIO-ç¼–ç¨‹"><a href="#3-Java-NIO-ç¼–ç¨‹" class="headerlink" title="3 Java NIO ç¼–ç¨‹"></a>3 Java NIO ç¼–ç¨‹</h2><h3 id="3-1-Java-NIO-åŸºæœ¬ä»‹ç»"><a href="#3-1-Java-NIO-åŸºæœ¬ä»‹ç»" class="headerlink" title="3.1 Java NIO åŸºæœ¬ä»‹ç»"></a>3.1 Java NIO åŸºæœ¬ä»‹ç»</h3><ol><li><code>Java NIO</code> å…¨ç§° <strong><code>Java non-blocking IO</code></strong>ï¼Œæ˜¯æŒ‡ <code>JDK</code> æä¾›çš„æ–° <code>API</code>ã€‚ä» <code>JDK1.4</code> å¼€å§‹ï¼Œ<code>Java</code> æä¾›äº†ä¸€ç³»åˆ—æ”¹è¿›çš„è¾“å…¥/è¾“å‡ºçš„æ–°ç‰¹æ€§ï¼Œè¢«ç»Ÿç§°ä¸º <code>NIO</code>ï¼ˆå³ <code>NewIO</code>ï¼‰ï¼Œæ˜¯åŒæ­¥éé˜»å¡çš„ã€‚</li><li><code>NIO</code> ç›¸å…³ç±»éƒ½è¢«æ”¾åœ¨ <strong><code>java.nio</code></strong> åŒ…åŠå­åŒ…ä¸‹ï¼Œå¹¶ä¸”å¯¹åŸ <code>java.io</code> åŒ…ä¸­çš„å¾ˆå¤šç±»è¿›è¡Œæ”¹å†™ã€‚ã€åŸºæœ¬æ¡ˆä¾‹ã€‘</li><li><code>NIO</code> æœ‰ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼š<strong><code>Channel</code>ï¼ˆé€šé“ï¼‰ã€<code>Buffer</code>ï¼ˆç¼“å†²åŒºï¼‰ã€<code>Selector</code>ï¼ˆé€‰æ‹©å™¨ï¼‰</strong> ã€‚</li><li><code>NIO</code> æ˜¯<strong>é¢å‘ç¼“å†²åŒºï¼Œæˆ–è€…é¢å‘å—ç¼–ç¨‹</strong>çš„ã€‚æ•°æ®è¯»å–åˆ°ä¸€ä¸ªå®ƒç¨åå¤„ç†çš„ç¼“å†²åŒºï¼Œéœ€è¦æ—¶å¯åœ¨ç¼“å†²åŒºä¸­å‰åç§»åŠ¨ï¼Œè¿™å°±å¢åŠ äº†å¤„ç†è¿‡ç¨‹ä¸­çš„çµæ´»æ€§ï¼Œä½¿ç”¨å®ƒå¯ä»¥æä¾›éé˜»å¡å¼çš„é«˜ä¼¸ç¼©æ€§ç½‘ç»œã€‚</li><li><code>Java NIO</code> çš„éé˜»å¡æ¨¡å¼ï¼Œä½¿ä¸€ä¸ªçº¿ç¨‹ä»æŸé€šé“å‘é€è¯·æ±‚æˆ–è€…è¯»å–æ•°æ®ï¼Œä½†æ˜¯å®ƒä»…èƒ½å¾—åˆ°ç›®å‰å¯ç”¨çš„æ•°æ®ï¼Œå¦‚æœç›®å‰æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œå°±ä»€ä¹ˆéƒ½ä¸ä¼šè·å–ï¼Œè€Œä¸æ˜¯ä¿æŒçº¿ç¨‹é˜»å¡ï¼Œæ‰€ä»¥ç›´è‡³æ•°æ®å˜çš„å¯ä»¥è¯»å–ä¹‹å‰ï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­åšå…¶ä»–çš„äº‹æƒ…ã€‚éé˜»å¡å†™ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™å…¥ä¸€äº›æ•°æ®åˆ°æŸé€šé“ï¼Œä½†ä¸éœ€è¦ç­‰å¾…å®ƒå®Œå…¨å†™å…¥ï¼Œè¿™ä¸ªçº¿ç¨‹åŒæ—¶å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚ã€åé¢æœ‰æ¡ˆä¾‹è¯´æ˜ã€‘</li><li>é€šä¿—ç†è§£ï¼š<code>NIO</code> æ˜¯å¯ä»¥åšåˆ°ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªæ“ä½œçš„ã€‚å‡è®¾æœ‰ <code>10000</code> ä¸ªè¯·æ±‚è¿‡æ¥,æ ¹æ®å®é™…æƒ…å†µï¼Œå¯ä»¥åˆ†é… <code>50</code> æˆ–è€… <code>100</code> ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚ä¸åƒä¹‹å‰çš„é˜»å¡ <code>IO</code> é‚£æ ·ï¼Œéå¾—åˆ†é… <code>10000</code> ä¸ªã€‚</li><li><code>HTTP 2.0</code> ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„æŠ€æœ¯ï¼Œåšåˆ°åŒä¸€ä¸ªè¿æ¥å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸”å¹¶å‘è¯·æ±‚çš„æ•°é‡æ¯” <code>HTTP 1.1</code> å¤§äº†å¥½å‡ ä¸ªæ•°é‡çº§ã€‚</li><li>æ¡ˆä¾‹è¯´æ˜ <code>NIO</code> çš„ <code>Buffer</code></li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.nio.IntBuffer;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicBuffer</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">//ä¸¾ä¾‹è¯´æ˜ Buffer çš„ä½¿ç”¨(ç®€å•è¯´æ˜)</span>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª Bufferï¼Œå¤§å°ä¸º 5ï¼Œå³å¯ä»¥å­˜æ”¾ 5 ä¸ª int</span>        IntBuffer intBuffer = IntBuffer.allocate(<span class="hljs-number">5</span>);        <span class="hljs-comment">//å‘bufferå­˜æ”¾æ•°æ®</span>        <span class="hljs-comment">//intBuffer.put(10);</span>        <span class="hljs-comment">//intBuffer.put(11);</span>        <span class="hljs-comment">//intBuffer.put(12);</span>        <span class="hljs-comment">//intBuffer.put(13);</span>        <span class="hljs-comment">//intBuffer.put(14);</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; intBuffer.capacity(); i++) &#123;            intBuffer.put(i * <span class="hljs-number">2</span>);        &#125;        <span class="hljs-comment">//å¦‚ä½•ä» buffer è¯»å–æ•°æ®</span>        <span class="hljs-comment">//å°† buffer è½¬æ¢ï¼Œè¯»å†™åˆ‡æ¢(!!!)</span>        intBuffer.flip();        <span class="hljs-keyword">while</span> (intBuffer.hasRemaining()) &#123;            System.out.println(intBuffer.get());        &#125;    &#125;&#125;</code></pre></div><h3 id="3-2-NIO-å’Œ-BIO-çš„æ¯”è¾ƒ"><a href="#3-2-NIO-å’Œ-BIO-çš„æ¯”è¾ƒ" class="headerlink" title="3.2 NIO å’Œ BIO çš„æ¯”è¾ƒ"></a>3.2 NIO å’Œ BIO çš„æ¯”è¾ƒ</h3><ol><li><code>BIO</code> ä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€Œ <code>NIO</code> ä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œå— <code>I/O</code> çš„æ•ˆç‡æ¯”æµ <code>I/O</code> é«˜å¾ˆå¤šã€‚</li><li><code>BIO</code> æ˜¯é˜»å¡çš„ï¼Œ<code>NIO</code> åˆ™æ˜¯éé˜»å¡çš„ã€‚</li><li><code>BIO</code> åŸºäºå­—èŠ‚æµå’Œå­—ç¬¦æµè¿›è¡Œæ“ä½œï¼Œè€Œ <code>NIO</code> åŸºäº <code>Channel</code>ï¼ˆé€šé“ï¼‰å’Œ <code>Buffer</code>ï¼ˆç¼“å†²åŒºï¼‰è¿›è¡Œæ“ä½œï¼Œæ•°æ®æ€»æ˜¯ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæˆ–è€…ä»ç¼“å†²åŒºå†™å…¥åˆ°é€šé“ä¸­ã€‚<code>Selector</code>ï¼ˆé€‰æ‹©å™¨ï¼‰ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šè¿æ¥è¯·æ±‚ï¼Œæ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œå› æ­¤ä½¿ç”¨å•ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯é€šé“ã€‚</li></ol><h3 id="3-3-NIO-ä¸‰å¤§æ ¸å¿ƒåŸç†ç¤ºæ„å›¾"><a href="#3-3-NIO-ä¸‰å¤§æ ¸å¿ƒåŸç†ç¤ºæ„å›¾" class="headerlink" title="3.3 NIO ä¸‰å¤§æ ¸å¿ƒåŸç†ç¤ºæ„å›¾"></a>3.3 NIO ä¸‰å¤§æ ¸å¿ƒåŸç†ç¤ºæ„å›¾</h3><p>ä¸€å¼ å›¾æè¿° <code>NIO</code> çš„ <code>Selector</code>ã€<code>Channel</code> å’Œ <code>Buffer</code> çš„å…³ç³»ã€‚</p><h4 id="3-3-1-Selectorã€Channel-å’Œ-Buffer-å…³ç³»å›¾ï¼ˆç®€å•ç‰ˆï¼‰"><a href="#3-3-1-Selectorã€Channel-å’Œ-Buffer-å…³ç³»å›¾ï¼ˆç®€å•ç‰ˆï¼‰" class="headerlink" title="3.3.1 Selectorã€Channel å’Œ Buffer å…³ç³»å›¾ï¼ˆç®€å•ç‰ˆï¼‰"></a>3.3.1 Selectorã€Channel å’Œ Buffer å…³ç³»å›¾ï¼ˆç®€å•ç‰ˆï¼‰</h4><p>å…³ç³»å›¾çš„è¯´æ˜:</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_01.png" alt="img"></p><ol><li>æ¯ä¸ª <code>Channel</code> éƒ½ä¼šå¯¹åº”ä¸€ä¸ª <code>Buffer</code>ã€‚</li><li><code>Selector</code> å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ª <code>Channel</code>ï¼ˆè¿æ¥ï¼‰ã€‚</li><li>è¯¥å›¾ååº”äº†æœ‰ä¸‰ä¸ª <code>Channel</code> æ³¨å†Œåˆ°è¯¥ <code>Selector</code> //ç¨‹åº</li><li>ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª <code>Channel</code> æ˜¯ç”±äº‹ä»¶å†³å®šçš„ï¼Œ<code>Event</code> å°±æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚</li><li><code>Selector</code> ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨å„ä¸ªé€šé“ä¸Šåˆ‡æ¢ã€‚</li><li><code>Buffer</code> å°±æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œåº•å±‚æ˜¯æœ‰ä¸€ä¸ªæ•°ç»„ã€‚</li><li>æ•°æ®çš„è¯»å–å†™å…¥æ˜¯é€šè¿‡ <code>Buffer</code>ï¼Œè¿™ä¸ªå’Œ <code>BIO</code>ï¼Œ<code>BIO</code> ä¸­è¦ä¹ˆæ˜¯è¾“å…¥æµï¼Œæˆ–è€…æ˜¯è¾“å‡ºæµï¼Œä¸èƒ½åŒå‘ï¼Œä½†æ˜¯ <code>NIO</code> çš„ <code>Buffer</code> æ˜¯å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œéœ€è¦ <code>flip</code> æ–¹æ³•åˆ‡æ¢ <code>Channel</code> æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¿”å›åº•å±‚æ“ä½œç³»ç»Ÿçš„æƒ…å†µï¼Œæ¯”å¦‚ <code>Linux</code>ï¼Œåº•å±‚çš„æ“ä½œç³»ç»Ÿé€šé“å°±æ˜¯åŒå‘çš„ã€‚</li></ol><h3 id="3-4-ç¼“å†²åŒºï¼ˆBufferï¼‰"><a href="#3-4-ç¼“å†²åŒºï¼ˆBufferï¼‰" class="headerlink" title="3.4 ç¼“å†²åŒºï¼ˆBufferï¼‰"></a>3.4 ç¼“å†²åŒºï¼ˆBufferï¼‰</h3><h4 id="3-4-1-åŸºæœ¬ä»‹ç»"><a href="#3-4-1-åŸºæœ¬ä»‹ç»" class="headerlink" title="3.4.1 åŸºæœ¬ä»‹ç»"></a>3.4.1 åŸºæœ¬ä»‹ç»</h4><p>ç¼“å†²åŒºï¼ˆ<code>Buffer</code>ï¼‰ï¼šç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å¯ä»¥è¯»å†™æ•°æ®çš„å†…å­˜å—</strong>ï¼Œå¯ä»¥ç†è§£æˆæ˜¯ä¸€ä¸ª<strong>å®¹å™¨å¯¹è±¡ï¼ˆå«æ•°ç»„ï¼‰</strong>ï¼Œè¯¥å¯¹è±¡æä¾›äº†ä¸€ç»„æ–¹æ³•ï¼Œå¯ä»¥æ›´è½»æ¾åœ°ä½¿ç”¨å†…å­˜å—ï¼Œï¼Œç¼“å†²åŒºå¯¹è±¡å†…ç½®äº†ä¸€äº›æœºåˆ¶ï¼Œèƒ½å¤Ÿè·Ÿè¸ªå’Œè®°å½•ç¼“å†²åŒºçš„çŠ¶æ€å˜åŒ–æƒ…å†µã€‚<code>Channel</code> æä¾›ä»æ–‡ä»¶ã€ç½‘ç»œè¯»å–æ•°æ®çš„æ¸ é“ï¼Œä½†æ˜¯è¯»å–æˆ–å†™å…¥çš„æ•°æ®éƒ½å¿…é¡»ç»ç”± <code>Buffer</code>ï¼Œå¦‚å›¾:ã€åé¢ä¸¾ä¾‹è¯´æ˜ã€‘</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_02.png" alt="img"></p><h4 id="3-4-2-Buffer-ç±»åŠå…¶å­ç±»"><a href="#3-4-2-Buffer-ç±»åŠå…¶å­ç±»" class="headerlink" title="3.4.2 Buffer ç±»åŠå…¶å­ç±»"></a>3.4.2 Buffer ç±»åŠå…¶å­ç±»</h4><ol><li>åœ¨ <code>NIO</code> ä¸­ï¼Œ<code>Buffer</code> æ˜¯ä¸€ä¸ªé¡¶å±‚çˆ¶ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç±»çš„å±‚çº§å…³ç³»å›¾ï¼š</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_03.png" alt="img"></p><ol><li><code>Buffer</code> ç±»å®šä¹‰äº†æ‰€æœ‰çš„ç¼“å†²åŒºéƒ½å…·æœ‰çš„å››ä¸ªå±æ€§æ¥æä¾›å…³äºå…¶æ‰€åŒ…å«çš„æ•°æ®å…ƒç´ çš„ä¿¡æ¯ï¼š</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_05.png" alt="img"></p><ol><li><code>Buffer</code> ç±»ç›¸å…³æ–¹æ³•ä¸€è§ˆ</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_06.png" alt="img"></p><h4 id="3-4-3-ByteBuffer"><a href="#3-4-3-ByteBuffer" class="headerlink" title="3.4.3 ByteBuffer"></a>3.4.3 ByteBuffer</h4><p>ä»å‰é¢å¯ä»¥çœ‹å‡ºå¯¹äº <code>Java</code> ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ<code>boolean</code> é™¤å¤–ï¼‰ï¼Œéƒ½æœ‰ä¸€ä¸ª <code>Buffer</code> ç±»å‹ä¸ä¹‹ç›¸å¯¹åº”ï¼Œæœ€å¸¸ç”¨çš„è‡ªç„¶æ˜¯ <code>ByteBuffer</code> ç±»ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œè¯¥ç±»çš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_07.png" alt="img"></p><h3 id="3-5-é€šé“ï¼ˆChannelï¼‰"><a href="#3-5-é€šé“ï¼ˆChannelï¼‰" class="headerlink" title="3.5 é€šé“ï¼ˆChannelï¼‰"></a>3.5 é€šé“ï¼ˆChannelï¼‰</h3><h4 id="3-5-0-åŸºæœ¬ä»‹ç»"><a href="#3-5-0-åŸºæœ¬ä»‹ç»" class="headerlink" title="3.5.0 åŸºæœ¬ä»‹ç»"></a>3.5.0 åŸºæœ¬ä»‹ç»</h4><ol><li><p><code>NIO</code> çš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™</li><li>é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ®</li><li>é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†²:</li></ul></li><li><p><code>BIO</code> ä¸­çš„ <code>Stream</code> æ˜¯å•å‘çš„ï¼Œä¾‹å¦‚ <code>FileInputStream</code> å¯¹è±¡åªèƒ½è¿›è¡Œè¯»å–æ•°æ®çš„æ“ä½œï¼Œè€Œ <code>NIO</code> ä¸­çš„é€šé“ï¼ˆ<code>Channel</code>ï¼‰æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¯»æ“ä½œï¼Œä¹Ÿå¯ä»¥å†™æ“ä½œã€‚</p></li><li><p><code>Channel</code> åœ¨ <code>NIO</code> ä¸­æ˜¯ä¸€ä¸ªæ¥å£ <code>public interface Channel extends Closeable&#123;&#125;</code></p></li><li><p>å¸¸ç”¨çš„ <code>Channel</code> ç±»æœ‰ï¼š<strong><code>FileChannel</code>ã€<code>DatagramChannel</code>ã€<code>ServerSocketChannel</code> å’Œ <code>SocketChannel</code></strong>ã€‚ã€<code>ServerSocketChanne</code> ç±»ä¼¼ <code>ServerSocket</code>ã€<code>SocketChannel</code> ç±»ä¼¼ <code>Socket</code>ã€‘</p></li><li><p><code>FileChannel</code> ç”¨äºæ–‡ä»¶çš„æ•°æ®è¯»å†™ï¼Œ<code>DatagramChannel</code> ç”¨äº <code>UDP</code> çš„æ•°æ®è¯»å†™ï¼Œ<code>ServerSocketChannel</code> å’Œ <code>SocketChannel</code> ç”¨äº <code>TCP</code> çš„æ•°æ®è¯»å†™ã€‚</p></li><li><p>å›¾ç¤º</p></li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_08.png" alt="img"></p><h4 id="3-5-1-FileChannel-ç±»"><a href="#3-5-1-FileChannel-ç±»" class="headerlink" title="3.5.1 FileChannel ç±»"></a>3.5.1 FileChannel ç±»</h4><p><code>FileChannel</code> ä¸»è¦ç”¨æ¥å¯¹æœ¬åœ°æ–‡ä»¶è¿›è¡Œ <code>IO</code> æ“ä½œï¼Œå¸¸è§çš„æ–¹æ³•æœ‰</p><ul><li><code>public int read(ByteBuffer dst)</code>ï¼Œä»é€šé“è¯»å–æ•°æ®å¹¶æ”¾åˆ°ç¼“å†²åŒºä¸­</li><li><code>public int write(ByteBuffer src)</code>ï¼ŒæŠŠç¼“å†²åŒºçš„æ•°æ®å†™åˆ°é€šé“ä¸­</li><li><code>public long transferFrom(ReadableByteChannel src, long position, long count)</code>ï¼Œä»ç›®æ ‡é€šé“ä¸­å¤åˆ¶æ•°æ®åˆ°å½“å‰é€šé“</li><li><code>public long transferTo(long position, long count, WritableByteChannel target)</code>ï¼ŒæŠŠæ•°æ®ä»å½“å‰é€šé“å¤åˆ¶ç»™ç›®æ ‡é€šé“</li></ul><h4 id="3-5-2-åº”ç”¨å®ä¾‹1-æœ¬åœ°æ–‡ä»¶å†™æ•°æ®"><a href="#3-5-2-åº”ç”¨å®ä¾‹1-æœ¬åœ°æ–‡ä»¶å†™æ•°æ®" class="headerlink" title="3.5.2 åº”ç”¨å®ä¾‹1 - æœ¬åœ°æ–‡ä»¶å†™æ•°æ®"></a>3.5.2 åº”ç”¨å®ä¾‹1 - æœ¬åœ°æ–‡ä»¶å†™æ•°æ®</h4><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li>ä½¿ç”¨å‰é¢å­¦ä¹ åçš„ <code>ByteBuffer</code>ï¼ˆç¼“å†²ï¼‰å’Œ <code>FileChannel</code>ï¼ˆé€šé“ï¼‰ï¼Œå°† â€œhello,å°šç¡…è°·â€ å†™å…¥åˆ° <code>file01.txt</code> ä¸­</li><li>æ–‡ä»¶ä¸å­˜åœ¨å°±åˆ›å»º</li><li>ä»£ç æ¼”ç¤º</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.io.FileOutputStream;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NIOFileChannel01</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        String str = <span class="hljs-string">&quot;hello,å°šç¡…è°·&quot;</span>;        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ -&gt; channel</span>        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;d:\\file01.txt&quot;</span>);        <span class="hljs-comment">//é€šè¿‡ fileOutputStream è·å–å¯¹åº”çš„ FileChannel</span>        <span class="hljs-comment">//è¿™ä¸ª fileChannel çœŸå®ç±»å‹æ˜¯ FileChannelImpl</span>        FileChannel fileChannel = fileOutputStream.getChannel();        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªç¼“å†²åŒº ByteBuffer</span>        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="hljs-number">1024</span>);        <span class="hljs-comment">//å°† str æ”¾å…¥ byteBuffer</span>        byteBuffer.put(str.getBytes());        <span class="hljs-comment">//å¯¹ byteBuffer è¿›è¡Œ flip</span>        byteBuffer.flip();        <span class="hljs-comment">//å°† byteBuffer æ•°æ®å†™å…¥åˆ° fileChannel</span>        fileChannel.write(byteBuffer);        fileOutputStream.close();    &#125;&#125;</code></pre></div><h4 id="3-5-3-åº”ç”¨å®ä¾‹2-æœ¬åœ°æ–‡ä»¶è¯»æ•°æ®"><a href="#3-5-3-åº”ç”¨å®ä¾‹2-æœ¬åœ°æ–‡ä»¶è¯»æ•°æ®" class="headerlink" title="3.5.3 åº”ç”¨å®ä¾‹2 - æœ¬åœ°æ–‡ä»¶è¯»æ•°æ®"></a>3.5.3 åº”ç”¨å®ä¾‹2 - æœ¬åœ°æ–‡ä»¶è¯»æ•°æ®</h4><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li>ä½¿ç”¨å‰é¢å­¦ä¹ åçš„ <code>ByteBuffer</code>ï¼ˆç¼“å†²ï¼‰å’Œ <code>FileChannel</code>ï¼ˆé€šé“ï¼‰ï¼Œå°† <code>file01.txt</code> ä¸­çš„æ•°æ®è¯»å…¥åˆ°ç¨‹åºï¼Œå¹¶æ˜¾ç¤ºåœ¨æ§åˆ¶å°å±å¹•</li><li>å‡å®šæ–‡ä»¶å·²ç»å­˜åœ¨</li><li>ä»£ç æ¼”ç¤º</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.io.File;<span class="hljs-keyword">import</span> java.io.FileInputStream;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NIOFileChannel02</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//åˆ›å»ºæ–‡ä»¶çš„è¾“å…¥æµ</span>        File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;d:\\file01.txt&quot;</span>);        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(file);                <span class="hljs-comment">//é€šè¿‡ fileInputStream è·å–å¯¹åº”çš„ FileChannel -&gt; å®é™…ç±»å‹ FileChannelImpl</span>        FileChannel fileChannel = fileInputStream.getChannel();                <span class="hljs-comment">//åˆ›å»ºç¼“å†²åŒº</span>        ByteBuffer byteBuffer = ByteBuffer.allocate((<span class="hljs-keyword">int</span>)file.length());                <span class="hljs-comment">//å°†é€šé“çš„æ•°æ®è¯»å…¥åˆ° Buffer</span>        fileChannel.read(byteBuffer);                <span class="hljs-comment">//å°† byteBuffer çš„å­—èŠ‚æ•°æ®è½¬æˆ String</span>        System.out.println(<span class="hljs-keyword">new</span> String(byteBuffer.array()));        fileInputStream.close();    &#125;&#125;</code></pre></div><h4 id="3-5-4-åº”ç”¨å®ä¾‹3-ä½¿ç”¨ä¸€ä¸ª-Buffer-å®Œæˆæ–‡ä»¶è¯»å–ã€å†™å…¥"><a href="#3-5-4-åº”ç”¨å®ä¾‹3-ä½¿ç”¨ä¸€ä¸ª-Buffer-å®Œæˆæ–‡ä»¶è¯»å–ã€å†™å…¥" class="headerlink" title="3.5.4 åº”ç”¨å®ä¾‹3 - ä½¿ç”¨ä¸€ä¸ª Buffer å®Œæˆæ–‡ä»¶è¯»å–ã€å†™å…¥"></a>3.5.4 åº”ç”¨å®ä¾‹3 - ä½¿ç”¨ä¸€ä¸ª Buffer å®Œæˆæ–‡ä»¶è¯»å–ã€å†™å…¥</h4><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li>ä½¿ç”¨ <code>FileChannel</code>ï¼ˆé€šé“ï¼‰å’Œæ–¹æ³• <code>readã€write</code>ï¼Œå®Œæˆæ–‡ä»¶çš„æ‹·è´</li><li>æ‹·è´ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ <code>1.txt</code>ï¼Œæ”¾åœ¨é¡¹ç›®ä¸‹å³å¯</li><li>ä»£ç æ¼”ç¤º</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_09.png" alt="img"></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.io.FileInputStream;<span class="hljs-keyword">import</span> java.io.FileOutputStream;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NIOFileChannel03</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;1.txt&quot;</span>);        FileChannel fileChannel01 = fileInputStream.getChannel();        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;2.txt&quot;</span>);        FileChannel fileChannel02 = fileOutputStream.getChannel();        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="hljs-number">512</span>);                <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123; <span class="hljs-comment">//å¾ªç¯è¯»å–</span>            <span class="hljs-comment">//è¿™é‡Œæœ‰ä¸€ä¸ªé‡è¦çš„æ“ä½œï¼Œä¸€å®šä¸è¦å¿˜äº†</span>            <span class="hljs-comment">/*</span><span class="hljs-comment">            public final Buffer clear() &#123;</span><span class="hljs-comment">                position = 0;</span><span class="hljs-comment">                limit = capacity;</span><span class="hljs-comment">                mark = -1;</span><span class="hljs-comment">                return this;</span><span class="hljs-comment">            &#125;</span><span class="hljs-comment">            */</span>            byteBuffer.clear(); <span class="hljs-comment">//æ¸…ç©º buffer</span>            <span class="hljs-keyword">int</span> read = fileChannel01.read(byteBuffer);            System.out.println(<span class="hljs-string">&quot;read = &quot;</span> + read);            <span class="hljs-keyword">if</span> (read == -<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">//è¡¨ç¤ºè¯»å®Œ</span>                <span class="hljs-keyword">break</span>;            &#125;            <span class="hljs-comment">//å°† buffer ä¸­çš„æ•°æ®å†™å…¥åˆ° fileChannel02--2.txt</span>            byteBuffer.flip();            fileChannel02.write(byteBuffer);        &#125;        <span class="hljs-comment">//å…³é—­ç›¸å…³çš„æµ</span>        fileInputStream.close();        fileOutputStream.close();    &#125;&#125;</code></pre></div><h4 id="3-5-5-åº”ç”¨å®ä¾‹4-æ‹·è´æ–‡ä»¶-transferFrom-æ–¹æ³•"><a href="#3-5-5-åº”ç”¨å®ä¾‹4-æ‹·è´æ–‡ä»¶-transferFrom-æ–¹æ³•" class="headerlink" title="3.5.5 åº”ç”¨å®ä¾‹4 - æ‹·è´æ–‡ä»¶ transferFrom æ–¹æ³•"></a>3.5.5 åº”ç”¨å®ä¾‹4 - æ‹·è´æ–‡ä»¶ transferFrom æ–¹æ³•</h4><ol><li>å®ä¾‹è¦æ±‚ï¼š</li><li>ä½¿ç”¨ <code>FileChannel</code>ï¼ˆé€šé“ï¼‰å’Œæ–¹æ³• <code>transferFrom</code>ï¼Œå®Œæˆæ–‡ä»¶çš„æ‹·è´</li><li>æ‹·è´ä¸€å¼ å›¾ç‰‡</li><li>ä»£ç æ¼”ç¤º</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.io.FileInputStream;<span class="hljs-keyword">import</span> java.io.FileOutputStream;<span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NIOFileChannel04</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//åˆ›å»ºç›¸å…³æµ</span>        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;d:\\a.jpg&quot;</span>);        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;d:\\a2.jpg&quot;</span>);                <span class="hljs-comment">//è·å–å„ä¸ªæµå¯¹åº”çš„ FileChannel</span>        FileChannel sourceCh = fileInputStream.getChannel();        FileChannel destCh = fileOutputStream.getChannel();        <span class="hljs-comment">//ä½¿ç”¨ transferForm å®Œæˆæ‹·è´</span>        destCh.transferFrom(sourceCh, <span class="hljs-number">0</span>, sourceCh.size());        <span class="hljs-comment">//å…³é—­ç›¸å…³é€šé“å’Œæµ</span>        sourceCh.close();        destCh.close();        fileInputStream.close();        fileOutputStream.close();    &#125;&#125;</code></pre></div><h4 id="3-5-6-å…³äº-Buffer-å’Œ-Channel-çš„æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚"><a href="#3-5-6-å…³äº-Buffer-å’Œ-Channel-çš„æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚" class="headerlink" title="3.5.6 å…³äº Buffer å’Œ Channel çš„æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚"></a>3.5.6 å…³äº Buffer å’Œ Channel çš„æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚</h4><ol><li><code>ByteBuffer</code> æ”¯æŒç±»å‹åŒ–çš„ <code>put</code> å’Œ <code>get</code>ï¼Œ<code>put</code> æ”¾å…¥çš„æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹ï¼Œ<code>get</code> å°±åº”è¯¥ä½¿ç”¨ç›¸åº”çš„æ•°æ®ç±»å‹æ¥å–å‡ºï¼Œå¦åˆ™å¯èƒ½æœ‰ <code>BufferUnderflowException</code> å¼‚å¸¸ã€‚ã€ä¸¾ä¾‹è¯´æ˜ã€‘</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NIOByteBufferPutGet</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;                <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª Buffer</span>        ByteBuffer buffer = ByteBuffer.allocate(<span class="hljs-number">64</span>);        <span class="hljs-comment">//ç±»å‹åŒ–æ–¹å¼æ”¾å…¥æ•°æ®</span>        buffer.putInt(<span class="hljs-number">100</span>);        buffer.putLong(<span class="hljs-number">9</span>);        buffer.putChar(<span class="hljs-string">&#x27;å°š&#x27;</span>);        buffer.putShort((<span class="hljs-keyword">short</span>) <span class="hljs-number">4</span>);        <span class="hljs-comment">//å–å‡º</span>        buffer.flip();                System.out.println();                System.out.println(buffer.getInt());        System.out.println(buffer.getLong());        System.out.println(buffer.getChar());        System.out.println(buffer.getShort());    &#125;&#125;</code></pre></div><ol start="2"><li>å¯ä»¥å°†ä¸€ä¸ªæ™®é€š <code>Buffer</code> è½¬æˆåªè¯» <code>Buffer</code>ã€ä¸¾ä¾‹è¯´æ˜ã€‘</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadOnlyBuffer</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª buffer</span>        ByteBuffer buffer = ByteBuffer.allocate(<span class="hljs-number">64</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; i++) &#123;            buffer.put((<span class="hljs-keyword">byte</span>) i);        &#125;        <span class="hljs-comment">//è¯»å–</span>        buffer.flip();        <span class="hljs-comment">//å¾—åˆ°ä¸€ä¸ªåªè¯»çš„ Buffer</span>        ByteBuffer readOnlyBuffer = buffer.asReadOnlyBuffer();        System.out.println(readOnlyBuffer.getClass());        <span class="hljs-comment">//è¯»å–</span>        <span class="hljs-keyword">while</span> (readOnlyBuffer.hasRemaining()) &#123;            System.out.println(readOnlyBuffer.get());        &#125;        readOnlyBuffer.put((<span class="hljs-keyword">byte</span>) <span class="hljs-number">100</span>); <span class="hljs-comment">//ReadOnlyBufferException</span>    &#125;&#125;</code></pre></div><ol start="3"><li><code>NIO</code> è¿˜æä¾›äº† <code>MappedByteBuffer</code>ï¼Œå¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ï¼ˆå †å¤–çš„å†…å­˜ï¼‰ä¸­è¿›è¡Œä¿®æ”¹ï¼Œè€Œå¦‚ä½•åŒæ­¥åˆ°æ–‡ä»¶ç”± <code>NIO</code> æ¥å®Œæˆã€‚ã€ä¸¾ä¾‹è¯´æ˜ã€‘</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.io.RandomAccessFile;<span class="hljs-keyword">import</span> java.nio.MappedByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯´æ˜ 1.MappedByteBuffer å¯è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ï¼ˆå †å¤–å†…å­˜ï¼‰ä¿®æ”¹,æ“ä½œç³»ç»Ÿä¸éœ€è¦æ‹·è´ä¸€æ¬¡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MappedByteBufferTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        RandomAccessFile randomAccessFile = <span class="hljs-keyword">new</span> RandomAccessFile(<span class="hljs-string">&quot;1.txt&quot;</span>, <span class="hljs-string">&quot;rw&quot;</span>);        <span class="hljs-comment">//è·å–å¯¹åº”çš„é€šé“</span>        FileChannel channel = randomAccessFile.getChannel();        <span class="hljs-comment">/**</span><span class="hljs-comment">         * å‚æ•° 1:FileChannel.MapMode.READ_WRITE ä½¿ç”¨çš„è¯»å†™æ¨¡å¼</span><span class="hljs-comment">         * å‚æ•° 2ï¼š0ï¼šå¯ä»¥ç›´æ¥ä¿®æ”¹çš„èµ·å§‹ä½ç½®</span><span class="hljs-comment">         * å‚æ•° 3:5: æ˜¯æ˜ å°„åˆ°å†…å­˜çš„å¤§å°ï¼ˆä¸æ˜¯ç´¢å¼•ä½ç½®ï¼‰ï¼Œå³å°† 1.txt çš„å¤šå°‘ä¸ªå­—èŠ‚æ˜ å°„åˆ°å†…å­˜</span><span class="hljs-comment">         * å¯ä»¥ç›´æ¥ä¿®æ”¹çš„èŒƒå›´å°±æ˜¯ 0-5</span><span class="hljs-comment">         * å®é™…ç±»å‹ DirectByteBuffer</span><span class="hljs-comment">         */</span>        MappedByteBuffer mappedByteBuffer = channel.map(FileChannel.MapMode.READ_WRITE, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);        mappedByteBuffer.put(<span class="hljs-number">0</span>, (<span class="hljs-keyword">byte</span>) <span class="hljs-string">&#x27;H&#x27;</span>);        mappedByteBuffer.put(<span class="hljs-number">3</span>, (<span class="hljs-keyword">byte</span>) <span class="hljs-string">&#x27;9&#x27;</span>);        mappedByteBuffer.put(<span class="hljs-number">5</span>, (<span class="hljs-keyword">byte</span>) <span class="hljs-string">&#x27;Y&#x27;</span>);<span class="hljs-comment">//IndexOutOfBoundsException</span>        randomAccessFile.close();        System.out.println(<span class="hljs-string">&quot;ä¿®æ”¹æˆåŠŸ~~&quot;</span>);    &#125;&#125;</code></pre></div><ol start="4"><li>å‰é¢æˆ‘ä»¬è®²çš„è¯»å†™æ“ä½œï¼Œéƒ½æ˜¯é€šè¿‡ä¸€ä¸ª <code>Buffer</code> å®Œæˆçš„ï¼Œ<code>NIO</code> è¿˜æ”¯æŒé€šè¿‡å¤šä¸ª <code>Buffer</code>ï¼ˆå³ <code>Buffer</code>æ•°ç»„ï¼‰å®Œæˆè¯»å†™æ“ä½œï¼Œå³ <code>Scattering</code> å’Œ <code>Gathering</code>ã€ä¸¾ä¾‹è¯´æ˜ã€‘</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.nio;<span class="hljs-keyword">import</span> java.net.InetSocketAddress;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.ServerSocketChannel;<span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<span class="hljs-keyword">import</span> java.util.Arrays;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Scatteringï¼šå°†æ•°æ®å†™å…¥åˆ° buffer æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ buffer æ•°ç»„ï¼Œä¾æ¬¡å†™å…¥ [åˆ†æ•£]</span><span class="hljs-comment"> * Gatheringï¼šä» buffer è¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ buffer æ•°ç»„ï¼Œä¾æ¬¡è¯»</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScatteringAndGatheringTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                <span class="hljs-comment">//ä½¿ç”¨ ServerSocketChannel å’Œ SocketChannel ç½‘ç»œ</span>        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();        InetSocketAddress inetSocketAddress = <span class="hljs-keyword">new</span> InetSocketAddress(<span class="hljs-number">7000</span>);        <span class="hljs-comment">//ç»‘å®šç«¯å£åˆ° socketï¼Œå¹¶å¯åŠ¨</span>        serverSocketChannel.socket().bind(inetSocketAddress);        <span class="hljs-comment">//åˆ›å»º buffer æ•°ç»„</span>        ByteBuffer[] byteBuffers = <span class="hljs-keyword">new</span> ByteBuffer[<span class="hljs-number">2</span>];        byteBuffers[<span class="hljs-number">0</span>] = ByteBuffer.allocate(<span class="hljs-number">5</span>);        byteBuffers[<span class="hljs-number">1</span>] = ByteBuffer.allocate(<span class="hljs-number">3</span>);        <span class="hljs-comment">//ç­‰å®¢æˆ·ç«¯è¿æ¥ (telnet)</span>        SocketChannel socketChannel = serverSocketChannel.accept();        <span class="hljs-keyword">int</span> messageLength = <span class="hljs-number">8</span>; <span class="hljs-comment">//å‡å®šä»å®¢æˆ·ç«¯æ¥æ”¶ 8 ä¸ªå­—èŠ‚</span>        <span class="hljs-comment">//å¾ªç¯çš„è¯»å–</span>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;            <span class="hljs-keyword">int</span> byteRead = <span class="hljs-number">0</span>;            <span class="hljs-keyword">while</span> (byteRead &lt; messageLength) &#123;                <span class="hljs-keyword">long</span> l = socketChannel.read(byteBuffers);                byteRead += l; <span class="hljs-comment">//ç´¯è®¡è¯»å–çš„å­—èŠ‚æ•°</span>                System.out.println(<span class="hljs-string">&quot;byteRead = &quot;</span> + byteRead);                <span class="hljs-comment">//ä½¿ç”¨æµæ‰“å°,çœ‹çœ‹å½“å‰çš„è¿™ä¸ª buffer çš„ position å’Œ limit</span>                Arrays.asList(byteBuffers).stream().map(buffer -&gt; <span class="hljs-string">&quot;position = &quot;</span> + buffer.position() + <span class="hljs-string">&quot;, limit = &quot;</span> + buffer.limit()).forEach(System.out::println);            &#125;            <span class="hljs-comment">//å°†æ‰€æœ‰çš„ buffer è¿›è¡Œ flip</span>            Arrays.asList(byteBuffers).forEach(buffer -&gt; buffer.flip());            <span class="hljs-comment">//å°†æ•°æ®è¯»å‡ºæ˜¾ç¤ºåˆ°å®¢æˆ·ç«¯</span>            <span class="hljs-keyword">long</span> byteWirte = <span class="hljs-number">0</span>;            <span class="hljs-keyword">while</span> (byteWirte &lt; messageLength) &#123;                <span class="hljs-keyword">long</span> l = socketChannel.write(byteBuffers);<span class="hljs-comment">//</span>                byteWirte += l;            &#125;                        <span class="hljs-comment">//å°†æ‰€æœ‰çš„bufferè¿›è¡Œclear</span>            Arrays.asList(byteBuffers).forEach(buffer -&gt; &#123;                buffer.clear();            &#125;);                        System.out.println(<span class="hljs-string">&quot;byteRead = &quot;</span> + byteRead + <span class="hljs-string">&quot;, byteWrite = &quot;</span> + byteWirte + <span class="hljs-string">&quot;, messagelength = &quot;</span> + messageLength);        &#125;    &#125;&#125;</code></pre></div><h3 id="3-6-Selectorï¼ˆé€‰æ‹©å™¨ï¼‰"><a href="#3-6-Selectorï¼ˆé€‰æ‹©å™¨ï¼‰" class="headerlink" title="3.6 Selectorï¼ˆé€‰æ‹©å™¨ï¼‰"></a>3.6 Selectorï¼ˆé€‰æ‹©å™¨ï¼‰</h3><h4 id="3-6-1-åŸºæœ¬ä»‹ç»"><a href="#3-6-1-åŸºæœ¬ä»‹ç»" class="headerlink" title="3.6.1 åŸºæœ¬ä»‹ç»"></a>3.6.1 åŸºæœ¬ä»‹ç»</h4><ol><li><code>Java</code> çš„ <code>NIO</code>ï¼Œç”¨éé˜»å¡çš„ <code>IO</code> æ–¹å¼ã€‚å¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±ä¼šä½¿ç”¨åˆ° <code>Selector</code>ï¼ˆé€‰æ‹©å™¨ï¼‰ã€‚</li><li><code>Selector</code> èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆæ³¨æ„ï¼šå¤šä¸ª <code>Channel</code> ä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ª <code>Selector</code>ï¼‰ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¾¿è·å–äº‹ä»¶ç„¶åé’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥å’Œè¯·æ±‚ã€‚ã€ç¤ºæ„å›¾ã€‘</li><li>åªæœ‰åœ¨è¿æ¥/é€šé“çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç”¨å»ç»´æŠ¤å¤šä¸ªçº¿ç¨‹ã€‚</li><li>é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€ã€‚</li></ol><h4 id="3-6-2-Selector-ç¤ºæ„å›¾å’Œç‰¹ç‚¹è¯´æ˜"><a href="#3-6-2-Selector-ç¤ºæ„å›¾å’Œç‰¹ç‚¹è¯´æ˜" class="headerlink" title="3.6.2 Selector ç¤ºæ„å›¾å’Œç‰¹ç‚¹è¯´æ˜"></a>3.6.2 Selector ç¤ºæ„å›¾å’Œç‰¹ç‚¹è¯´æ˜</h4><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_10.png" alt="img"></p><p>è¯´æ˜å¦‚ä¸‹ï¼š</p><ol><li><code>Netty</code> çš„ <code>IO</code> çº¿ç¨‹ <code>NioEventLoop</code> èšåˆäº† <code>Selector</code>ï¼ˆé€‰æ‹©å™¨ï¼Œä¹Ÿå«å¤šè·¯å¤ç”¨å™¨ï¼‰ï¼Œå¯ä»¥åŒæ—¶å¹¶å‘å¤„ç†æˆç™¾ä¸Šåƒä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚</li><li>å½“çº¿ç¨‹ä»æŸå®¢æˆ·ç«¯ <code>Socket</code> é€šé“è¿›è¡Œè¯»å†™æ•°æ®æ—¶ï¼Œè‹¥æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹å¯ä»¥è¿›è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li><li>çº¿ç¨‹é€šå¸¸å°†éé˜»å¡ <code>IO</code> çš„ç©ºé—²æ—¶é—´ç”¨äºåœ¨å…¶ä»–é€šé“ä¸Šæ‰§è¡Œ <code>IO</code> æ“ä½œï¼Œæ‰€ä»¥å•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºé€šé“ã€‚</li><li>ç”±äºè¯»å†™æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ï¼Œè¿™å°±å¯ä»¥å……åˆ†æå‡ <code>IO</code> çº¿ç¨‹çš„è¿è¡Œæ•ˆç‡ï¼Œé¿å…ç”±äºé¢‘ç¹ <code>I/O</code> é˜»å¡å¯¼è‡´çš„çº¿ç¨‹æŒ‚èµ·ã€‚</li><li>ä¸€ä¸ª <code>I/O</code> çº¿ç¨‹å¯ä»¥å¹¶å‘å¤„ç† <code>N</code> ä¸ªå®¢æˆ·ç«¯è¿æ¥å’Œè¯»å†™æ“ä½œï¼Œè¿™ä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¼ ç»ŸåŒæ­¥é˜»å¡ <code>I/O</code> ä¸€è¿æ¥ä¸€çº¿ç¨‹æ¨¡å‹ï¼Œæ¶æ„çš„æ€§èƒ½ã€å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›å’Œå¯é æ€§éƒ½å¾—åˆ°äº†æå¤§çš„æå‡ã€‚</li></ol><h4 id="3-6-3-Selector-ç±»ç›¸å…³æ–¹æ³•"><a href="#3-6-3-Selector-ç±»ç›¸å…³æ–¹æ³•" class="headerlink" title="3.6.3 Selector ç±»ç›¸å…³æ–¹æ³•"></a>3.6.3 Selector ç±»ç›¸å…³æ–¹æ³•</h4><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_11.png" alt="img"></p><h4 id="3-6-4-æ³¨æ„äº‹é¡¹"><a href="#3-6-4-æ³¨æ„äº‹é¡¹" class="headerlink" title="3.6.4 æ³¨æ„äº‹é¡¹"></a>3.6.4 æ³¨æ„äº‹é¡¹</h4><ol><li><p><code>NIO</code> ä¸­çš„ <code>ServerSocketChannel</code> åŠŸèƒ½ç±»ä¼¼ <code>ServerSocket</code>ã€<code>SocketChannel</code> åŠŸèƒ½ç±»ä¼¼ <code>Socket</code>ã€‚</p></li><li><p><code>Selector</code> ç›¸å…³æ–¹æ³•è¯´æ˜</p><ul><li><code>selector.select();</code> //é˜»å¡</li><li><code>selector.select(1000);</code> //é˜»å¡ 1000 æ¯«ç§’ï¼Œåœ¨ 1000 æ¯«ç§’åè¿”å›</li><li><code>selector.wakeup();</code> //å”¤é†’ selector</li><li><code>selector.selectNow();</code> //ä¸é˜»å¡ï¼Œç«‹é©¬è¿”è¿˜</li></ul></li></ol><h3 id="3-7-NIO-éé˜»å¡ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾"><a href="#3-7-NIO-éé˜»å¡ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾" class="headerlink" title="3.7 NIO éé˜»å¡ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾"></a>3.7 NIO éé˜»å¡ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾</h3><p><code>NIO</code> éé˜»å¡ç½‘ç»œç¼–ç¨‹ç›¸å…³çš„ï¼ˆ<code>Selector</code>ã€<code>SelectionKey</code>ã€<code>ServerScoketChannel</code> å’Œ <code>SocketChannel</code>ï¼‰å…³ç³»æ¢³ç†å›¾</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_22.png" alt="img"></p><p>å¯¹ä¸Šå›¾çš„è¯´æ˜ï¼š</p><ol><li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡ <code>ServerSocketChannel</code> å¾—åˆ° <code>SocketChannel</code>ã€‚</li><li><code>Selector</code> è¿›è¡Œç›‘å¬ <code>select</code> æ–¹æ³•ï¼Œè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°ã€‚</li><li>å°† <code>socketChannel</code> æ³¨å†Œåˆ° <code>Selector</code> ä¸Šï¼Œ<code>register(Selector sel, int ops)</code>ï¼Œä¸€ä¸ª <code>Selector</code> ä¸Šå¯ä»¥æ³¨å†Œå¤šä¸ª <code>SocketChannel</code>ã€‚</li><li>æ³¨å†Œåè¿”å›ä¸€ä¸ª <code>SelectionKey</code>ï¼Œä¼šå’Œè¯¥ <code>Selector</code> å…³è”ï¼ˆé›†åˆï¼‰ã€‚</li><li>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª <code>SelectionKey</code>ï¼ˆæœ‰äº‹ä»¶å‘ç”Ÿï¼‰ã€‚</li><li>åœ¨é€šè¿‡ <code>SelectionKey</code> åå‘è·å– <code>SocketChannel</code>ï¼Œæ–¹æ³• <code>channel()</code>ã€‚</li><li>å¯ä»¥é€šè¿‡å¾—åˆ°çš„ <code>channel</code>ï¼Œå®Œæˆä¸šåŠ¡å¤„ç†ã€‚</li><li>ä»£ç æ’‘è…°ã€‚ã€‚ã€‚</li></ol><h3 id="3-8-NIO-éé˜»å¡ç½‘ç»œç¼–ç¨‹å¿«é€Ÿå…¥é—¨"><a href="#3-8-NIO-éé˜»å¡ç½‘ç»œç¼–ç¨‹å¿«é€Ÿå…¥é—¨" class="headerlink" title="3.8 NIO éé˜»å¡ç½‘ç»œç¼–ç¨‹å¿«é€Ÿå…¥é—¨"></a>3.8 NIO éé˜»å¡ç½‘ç»œç¼–ç¨‹å¿«é€Ÿå…¥é—¨</h3><p>æ¡ˆä¾‹è¦æ±‚ï¼š</p><ol><li>ç¼–å†™ä¸€ä¸ª <code>NIO</code> å…¥é—¨æ¡ˆä¾‹ï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰</li><li>ç›®çš„ï¼šç†è§£ <code>NIO</code> éé˜»å¡ç½‘ç»œç¼–ç¨‹æœºåˆ¶</li><li>çœ‹è€å¸ˆä»£ç æ¼”ç¤º</li></ol><h3 id="3-9-SelectionKey"><a href="#3-9-SelectionKey" class="headerlink" title="3.9 SelectionKey"></a>3.9 SelectionKey</h3><ol><li><code>SelectionKey</code>ï¼Œè¡¨ç¤º <code>Selector</code> å’Œç½‘ç»œé€šé“çš„æ³¨å†Œå…³ç³»ï¼Œå…±å››ç§ï¼š<ul><li><code>int OP_ACCEPT</code>ï¼šæœ‰æ–°çš„ç½‘ç»œè¿æ¥å¯ä»¥ <code>accept</code>ï¼Œå€¼ä¸º <code>16</code></li><li><code>int OP_CONNECT</code>ï¼šä»£è¡¨è¿æ¥å·²ç»å»ºç«‹ï¼Œå€¼ä¸º <code>8</code></li><li><code>int OP_READ</code>ï¼šä»£è¡¨è¯»æ“ä½œï¼Œå€¼ä¸º <code>1</code></li><li><code>int OP_WRITE</code>ï¼šä»£è¡¨å†™æ“ä½œï¼Œå€¼ä¸º <code>4</code></li></ul></li></ol><p>æºç ä¸­ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> OP_READ = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>;<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> OP_WRITE = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>;<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> OP_CONNECT = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>;<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> OP_ACCEPT = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>;</code></pre></div><ol start="2"><li><code>SelectionKey</code> ç›¸å…³æ–¹æ³•</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_12.png" alt="img"></p><h3 id="3-10-ServerSocketChannel"><a href="#3-10-ServerSocketChannel" class="headerlink" title="3.10 ServerSocketChannel"></a>3.10 ServerSocketChannel</h3><ol><li><code>ServerSocketChannel</code> åœ¨æœåŠ¡å™¨ç«¯ç›‘å¬æ–°çš„å®¢æˆ·ç«¯ <code>Socket</code> è¿æ¥</li><li>ç›¸å…³æ–¹æ³•å¦‚ä¸‹</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_13.png" alt="img"></p><h3 id="3-11-SocketChannel"><a href="#3-11-SocketChannel" class="headerlink" title="3.11 SocketChannel"></a>3.11 SocketChannel</h3><ol><li><code>SocketChannel</code>ï¼Œç½‘ç»œ <code>IO</code> é€šé“ï¼Œå…·ä½“è´Ÿè´£è¿›è¡Œè¯»å†™æ“ä½œã€‚<code>NIO</code> æŠŠç¼“å†²åŒºçš„æ•°æ®å†™å…¥é€šé“ï¼Œæˆ–è€…æŠŠé€šé“é‡Œçš„æ•°æ®è¯»åˆ°ç¼“å†²åŒºã€‚</li><li>ç›¸å…³æ–¹æ³•å¦‚ä¸‹</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_14.png" alt="img"></p><h3 id="3-12-NIO-ç½‘ç»œç¼–ç¨‹åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ"><a href="#3-12-NIO-ç½‘ç»œç¼–ç¨‹åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ" class="headerlink" title="3.12 NIO ç½‘ç»œç¼–ç¨‹åº”ç”¨å®ä¾‹ - ç¾¤èŠç³»ç»Ÿ"></a>3.12 NIO ç½‘ç»œç¼–ç¨‹åº”ç”¨å®ä¾‹ - ç¾¤èŠç³»ç»Ÿ</h3><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li>ç¼–å†™ä¸€ä¸ª <code>NIO</code> ç¾¤èŠç³»ç»Ÿï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰</li><li>å®ç°å¤šäººç¾¤èŠ</li><li>æœåŠ¡å™¨ç«¯ï¼šå¯ä»¥ç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œå¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½</li><li>å®¢æˆ·ç«¯ï¼šé€šè¿‡ <code>Channel</code> å¯ä»¥æ— é˜»å¡å‘é€æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å—å…¶å®ƒç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼ˆæœ‰æœåŠ¡å™¨è½¬å‘å¾—åˆ°ï¼‰</li><li>ç›®çš„ï¼šè¿›ä¸€æ­¥ç†è§£ <code>NIO</code> éé˜»å¡ç½‘ç»œç¼–ç¨‹æœºåˆ¶</li><li>ç¤ºæ„å›¾åˆ†æå’Œä»£ç </li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_15.png" alt="img"></p><p>ä»£ç ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æœåŠ¡ç«¯ï¼š</span><span class="hljs-keyword">package</span> com.atguigu.nio.groupchat;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">import</span> java.net.InetSocketAddress;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.Channel;<span class="hljs-keyword">import</span> java.nio.channels.SelectionKey;<span class="hljs-keyword">import</span> java.nio.channels.Selector;<span class="hljs-keyword">import</span> java.nio.channels.ServerSocketChannel;<span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<span class="hljs-keyword">import</span> java.util.Iterator;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupChatServer</span> </span>&#123;    <span class="hljs-comment">//å®šä¹‰å±æ€§</span>    <span class="hljs-keyword">private</span> Selector selector;    <span class="hljs-keyword">private</span> ServerSocketChannel listenChannel;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PORT = <span class="hljs-number">6667</span>;    <span class="hljs-comment">//æ„é€ å™¨</span>    <span class="hljs-comment">//åˆå§‹åŒ–å·¥ä½œ</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GroupChatServer</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">//å¾—åˆ°é€‰æ‹©å™¨</span>            selector = Selector.open();            <span class="hljs-comment">//ServerSocketChannel</span>            listenChannel = ServerSocketChannel.open();            <span class="hljs-comment">//ç»‘å®šç«¯å£</span>            listenChannel.socket().bind(<span class="hljs-keyword">new</span> InetSocketAddress(PORT));            <span class="hljs-comment">//è®¾ç½®éé˜»å¡æ¨¡å¼</span>            listenChannel.configureBlocking(<span class="hljs-keyword">false</span>);            <span class="hljs-comment">//å°†è¯¥ listenChannel æ³¨å†Œåˆ° selector</span>            listenChannel.register(selector, SelectionKey.OP_ACCEPT);        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;            e.printStackTrace();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">listen</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">//å¾ªç¯å¤„ç†</span>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;                <span class="hljs-keyword">int</span> count = selector.select();                <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//æœ‰äº‹ä»¶å¤„ç†</span>                    <span class="hljs-comment">// éå†å¾—åˆ° selectionKey é›†åˆ</span>                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();                    <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;                        <span class="hljs-comment">//å–å‡º selectionkey</span>                        SelectionKey key = iterator.next();                        <span class="hljs-comment">//ç›‘å¬åˆ° accept</span>                        <span class="hljs-keyword">if</span> (key.isAcceptable()) &#123;                            SocketChannel sc = listenChannel.accept();                            sc.configureBlocking(<span class="hljs-keyword">false</span>);                            <span class="hljs-comment">//å°†è¯¥ sc æ³¨å†Œåˆ° seletor</span>                            sc.register(selector, SelectionKey.OP_READ);                            <span class="hljs-comment">//æç¤º</span>                            System.out.println(sc.getRemoteAddress() + <span class="hljs-string">&quot; ä¸Šçº¿ &quot;</span>);                        &#125;                        <span class="hljs-keyword">if</span> (key.isReadable()) &#123;<span class="hljs-comment">//é€šé“å‘é€readäº‹ä»¶ï¼Œå³é€šé“æ˜¯å¯è¯»çš„çŠ¶æ€</span>                            <span class="hljs-comment">// å¤„ç†è¯»(ä¸“é—¨å†™æ–¹æ³•..)</span>                            readData(key);                        &#125;                        <span class="hljs-comment">//å½“å‰çš„ key åˆ é™¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†</span>                        iterator.remove();                    &#125;                &#125; <span class="hljs-keyword">else</span> &#123;                    System.out.println(<span class="hljs-string">&quot;ç­‰å¾…....&quot;</span>);                &#125;            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            <span class="hljs-comment">//å‘ç”Ÿå¼‚å¸¸å¤„ç†....</span>        &#125;    &#125;    <span class="hljs-comment">//è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readData</span><span class="hljs-params">(SelectionKey key)</span> </span>&#123;        SocketChannel channel = <span class="hljs-keyword">null</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">//å¾—åˆ° channel</span>            channel = (SocketChannel) key.channel();            <span class="hljs-comment">//åˆ›å»º buffer</span>            ByteBuffer buffer = ByteBuffer.allocate(<span class="hljs-number">1024</span>);            <span class="hljs-keyword">int</span> count = channel.read(buffer);            <span class="hljs-comment">//æ ¹æ® count çš„å€¼åšå¤„ç†</span>            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;                <span class="hljs-comment">//æŠŠç¼“å­˜åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span>                String msg = <span class="hljs-keyword">new</span> String(buffer.array());                <span class="hljs-comment">//è¾“å‡ºè¯¥æ¶ˆæ¯</span>                System.out.println(<span class="hljs-string">&quot;formå®¢æˆ·ç«¯:&quot;</span> + msg);                <span class="hljs-comment">//å‘å…¶å®ƒçš„å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯(å»æ‰è‡ªå·±),ä¸“é—¨å†™ä¸€ä¸ªæ–¹æ³•æ¥å¤„ç†</span>                sendInfoToOtherClients(msg, channel);            &#125;        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;            <span class="hljs-keyword">try</span> &#123;                System.out.println(channel.getRemoteAddress() + <span class="hljs-string">&quot;ç¦»çº¿äº†..&quot;</span>);                <span class="hljs-comment">//å–æ¶ˆæ³¨å†Œ</span>                key.cancel();                <span class="hljs-comment">//å…³é—­é€šé“</span>                channel.close();            &#125; <span class="hljs-keyword">catch</span> (IOException e2) &#123;                e2.printStackTrace();            &#125;        &#125;    &#125;    <span class="hljs-comment">//è½¬å‘æ¶ˆæ¯ç»™å…¶å®ƒå®¢æˆ·(é€šé“)</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendInfoToOtherClients</span><span class="hljs-params">(String msg, SocketChannel self)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯ä¸­...&quot;</span>);        <span class="hljs-comment">//éå†æ‰€æœ‰æ³¨å†Œåˆ° selector ä¸Šçš„ SocketChannel,å¹¶æ’é™¤ self</span>        <span class="hljs-keyword">for</span> (SelectionKey key : selector.keys()) &#123;            <span class="hljs-comment">//é€šè¿‡ key å–å‡ºå¯¹åº”çš„ SocketChannel</span>            Channel targetChannel = key.channel();            <span class="hljs-comment">//æ’é™¤è‡ªå·±</span>            <span class="hljs-keyword">if</span> (targetChannel <span class="hljs-keyword">instanceof</span> SocketChannel &amp;&amp; targetChannel != self) &#123;                <span class="hljs-comment">//è½¬å‹</span>                SocketChannel dest = (SocketChannel) targetChannel;                <span class="hljs-comment">//å°† msg å­˜å‚¨åˆ° buffer</span>                ByteBuffer buffer = ByteBuffer.wrap(msg.getBytes());                <span class="hljs-comment">//å°† buffer çš„æ•°æ®å†™å…¥é€šé“</span>                dest.write(buffer);            &#125;        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">//åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡</span>        GroupChatServer groupChatServer = <span class="hljs-keyword">new</span> GroupChatServer();        groupChatServer.listen();    &#125;&#125;<span class="hljs-comment">// å®¢æˆ·ç«¯ï¼š</span><span class="hljs-keyword">package</span> com.atguigu.nio.groupchat;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">import</span> java.net.InetSocketAddress;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.SelectionKey;<span class="hljs-keyword">import</span> java.nio.channels.Selector;<span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<span class="hljs-keyword">import</span> java.util.Iterator;<span class="hljs-keyword">import</span> java.util.Scanner;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupChatClient</span> </span>&#123;    <span class="hljs-comment">//å®šä¹‰ç›¸å…³çš„å±æ€§</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String HOST = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<span class="hljs-comment">//æœåŠ¡å™¨çš„ip</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PORT = <span class="hljs-number">6667</span>;<span class="hljs-comment">//æœåŠ¡å™¨ç«¯å£</span>    <span class="hljs-keyword">private</span> Selector selector;    <span class="hljs-keyword">private</span> SocketChannel socketChannel;    <span class="hljs-keyword">private</span> String username;    <span class="hljs-comment">//æ„é€ å™¨,å®Œæˆåˆå§‹åŒ–å·¥ä½œ</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GroupChatClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;                selector = Selector.open();        <span class="hljs-comment">//è¿æ¥æœåŠ¡å™¨</span>        socketChannel = SocketChannel.open(<span class="hljs-keyword">new</span> InetSocketAddress(HOST, PORT));        <span class="hljs-comment">//è®¾ç½®éé˜»å¡</span>        socketChannel.configureBlocking(<span class="hljs-keyword">false</span>);        <span class="hljs-comment">//å°† channel æ³¨å†Œåˆ°selector</span>        socketChannel.register(selector, SelectionKey.OP_READ);        <span class="hljs-comment">//å¾—åˆ° username</span>        username = socketChannel.getLocalAddress().toString().substring(<span class="hljs-number">1</span>);        System.out.println(username + <span class="hljs-string">&quot; is ok...&quot;</span>);    &#125;    <span class="hljs-comment">//å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendInfo</span><span class="hljs-params">(String info)</span> </span>&#123;        info = username + <span class="hljs-string">&quot; è¯´ï¼š&quot;</span> + info;        <span class="hljs-keyword">try</span> &#123;            socketChannel.write(ByteBuffer.wrap(info.getBytes()));        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;            e.printStackTrace();        &#125;    &#125;    <span class="hljs-comment">//è¯»å–ä»æœåŠ¡å™¨ç«¯å›å¤çš„æ¶ˆæ¯</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readInfo</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">int</span> readChannels = selector.select();            <span class="hljs-keyword">if</span> (readChannels &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//æœ‰å¯ä»¥ç”¨çš„é€šé“</span>                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();                <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;                    SelectionKey key = iterator.next();                    <span class="hljs-keyword">if</span> (key.isReadable()) &#123;                        <span class="hljs-comment">//å¾—åˆ°ç›¸å…³çš„é€šé“</span>                        SocketChannel sc = (SocketChannel) key.channel();                        <span class="hljs-comment">//å¾—åˆ°ä¸€ä¸ª Buffer</span>                        ByteBuffer buffer = ByteBuffer.allocate(<span class="hljs-number">1024</span>);                        <span class="hljs-comment">//è¯»å–</span>                        sc.read(buffer);                        <span class="hljs-comment">//æŠŠè¯»åˆ°çš„ç¼“å†²åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span>                        String msg = <span class="hljs-keyword">new</span> String(buffer.array());                        System.out.println(msg.trim());                    &#125;                &#125;                iterator.remove(); <span class="hljs-comment">//åˆ é™¤å½“å‰çš„ selectionKey,é˜²æ­¢é‡å¤æ“ä½œ</span>            &#125; <span class="hljs-keyword">else</span> &#123;                <span class="hljs-comment">//System.out.println(&quot;æ²¡æœ‰å¯ä»¥ç”¨çš„é€šé“...&quot;);</span>            &#125;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//å¯åŠ¨æˆ‘ä»¬å®¢æˆ·ç«¯</span>        GroupChatClient chatClient = <span class="hljs-keyword">new</span> GroupChatClient();        <span class="hljs-comment">//å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹,æ¯ä¸ª 3 ç§’ï¼Œè¯»å–ä»æœåŠ¡å™¨å‘é€æ•°æ®</span>        <span class="hljs-keyword">new</span> Thread() &#123;            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;                <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;                    chatClient.readInfo();                    <span class="hljs-keyword">try</span> &#123;                        Thread.currentThread().sleep(<span class="hljs-number">3000</span>);                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                &#125;            &#125;        &#125;.start();        <span class="hljs-comment">//å‘é€æ•°æ®ç»™æœåŠ¡å™¨ç«¯</span>        Scanner scanner = <span class="hljs-keyword">new</span> Scanner(System.in);        <span class="hljs-keyword">while</span> (scanner.hasNextLine()) &#123;            String s = scanner.nextLine();            chatClient.sendInfo(s);        &#125;    &#125;&#125;</code></pre></div><h3 id="3-13-NIO-ä¸é›¶æ‹·è´"><a href="#3-13-NIO-ä¸é›¶æ‹·è´" class="headerlink" title="3.13 NIO ä¸é›¶æ‹·è´"></a>3.13 NIO ä¸é›¶æ‹·è´</h3><h4 id="3-13-1-é›¶æ‹·è´åŸºæœ¬ä»‹ç»"><a href="#3-13-1-é›¶æ‹·è´åŸºæœ¬ä»‹ç»" class="headerlink" title="3.13.1 é›¶æ‹·è´åŸºæœ¬ä»‹ç»"></a>3.13.1 é›¶æ‹·è´åŸºæœ¬ä»‹ç»</h4><ol><li>é›¶æ‹·è´æ˜¯ç½‘ç»œç¼–ç¨‹çš„å…³é”®ï¼Œå¾ˆå¤šæ€§èƒ½ä¼˜åŒ–éƒ½ç¦»ä¸å¼€ã€‚</li><li>åœ¨ <code>Java</code> ç¨‹åºä¸­ï¼Œå¸¸ç”¨çš„é›¶æ‹·è´æœ‰ <code>mmap</code>ï¼ˆå†…å­˜æ˜ å°„ï¼‰å’Œ <code>sendFile</code>ã€‚é‚£ä¹ˆï¼Œä»–ä»¬åœ¨ <code>OS</code> é‡Œï¼Œåˆ°åº•æ˜¯æ€ä¹ˆæ ·çš„ä¸€ä¸ªçš„è®¾è®¡ï¼Ÿæˆ‘ä»¬åˆ†æ <code>mmap</code> å’Œ <code>sendFile</code> è¿™ä¸¤ä¸ªé›¶æ‹·è´</li><li>å¦å¤–æˆ‘ä»¬çœ‹ä¸‹ <code>NIO</code> ä¸­å¦‚ä½•ä½¿ç”¨é›¶æ‹·è´</li></ol><h4 id="3-13-2-ä¼ ç»Ÿ-IO-æ•°æ®è¯»å†™"><a href="#3-13-2-ä¼ ç»Ÿ-IO-æ•°æ®è¯»å†™" class="headerlink" title="3.13.2 ä¼ ç»Ÿ IO æ•°æ®è¯»å†™"></a>3.13.2 ä¼ ç»Ÿ IO æ•°æ®è¯»å†™</h4><p><code>Java</code> ä¼ ç»Ÿ <code>IO</code> å’Œç½‘ç»œç¼–ç¨‹çš„ä¸€æ®µä»£ç </p><div class="code-wrapper"><pre><code class="hljs java">File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;test.txt&quot;</span>);RandomAccessFile raf = <span class="hljs-keyword">new</span> RandomAccessFile(file, <span class="hljs-string">&quot;rw&quot;</span>);<span class="hljs-keyword">byte</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[(<span class="hljs-keyword">int</span>) file.length()];raf.read(arr);Socket socket = <span class="hljs-keyword">new</span> ServerSocket(<span class="hljs-number">8080</span>).accept();socket.getOutputStream().write(arr);</code></pre></div><h4 id="3-13-3-ä¼ ç»Ÿ-IO-æ¨¡å‹"><a href="#3-13-3-ä¼ ç»Ÿ-IO-æ¨¡å‹" class="headerlink" title="3.13.3 ä¼ ç»Ÿ IO æ¨¡å‹"></a>3.13.3 ä¼ ç»Ÿ IO æ¨¡å‹</h4><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_17.png" alt="img"></p><p><strong>DMA</strong>ï¼š<code>direct memory access</code> ç›´æ¥å†…å­˜æ‹·è´ï¼ˆä¸ä½¿ç”¨ <code>CPU</code>ï¼‰</p><h4 id="3-13-4-mmap-ä¼˜åŒ–"><a href="#3-13-4-mmap-ä¼˜åŒ–" class="headerlink" title="3.13.4 mmap ä¼˜åŒ–"></a>3.13.4 mmap ä¼˜åŒ–</h4><ol><li><code>mmap</code> é€šè¿‡å†…å­˜æ˜ å°„ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…æ ¸ç¼“å†²åŒºï¼ŒåŒæ—¶ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥å…±äº«å†…æ ¸ç©ºé—´çš„æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶ï¼Œå°±å¯ä»¥å‡å°‘å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´æ¬¡æ•°ã€‚å¦‚ä¸‹å›¾</li><li><code>mmap</code> ç¤ºæ„å›¾</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_18.png" alt="img"></p><h4 id="3-13-5-sendFile-ä¼˜åŒ–"><a href="#3-13-5-sendFile-ä¼˜åŒ–" class="headerlink" title="3.13.5 sendFile ä¼˜åŒ–"></a>3.13.5 sendFile ä¼˜åŒ–</h4><ol><li><code>Linux2.1</code> ç‰ˆæœ¬æä¾›äº† <code>sendFile</code> å‡½æ•°ï¼Œå…¶åŸºæœ¬åŸç†å¦‚ä¸‹ï¼šæ•°æ®æ ¹æœ¬ä¸ç»è¿‡ç”¨æˆ·æ€ï¼Œç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºè¿›å…¥åˆ° <code>SocketBuffer</code>ï¼ŒåŒæ—¶ï¼Œç”±äºå’Œç”¨æˆ·æ€å®Œå…¨æ— å…³ï¼Œå°±å‡å°‘äº†ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</li><li>ç¤ºæ„å›¾å’Œå°ç»“</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_19.png" alt="img"></p><ol start="3"><li><p>æç¤ºï¼šé›¶æ‹·è´ä»æ“ä½œç³»ç»Ÿè§’åº¦ï¼Œæ˜¯æ²¡æœ‰ <code>cpu</code> æ‹·è´</p></li><li><p><code>Linuxåœ¨2.4</code> ç‰ˆæœ¬ä¸­ï¼Œåšäº†ä¸€äº›ä¿®æ”¹ï¼Œé¿å…äº†ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° <code>Socketbuffer</code> çš„æ“ä½œï¼Œç›´æ¥æ‹·è´åˆ°åè®®æ ˆï¼Œä»è€Œå†ä¸€æ¬¡å‡å°‘äº†æ•°æ®æ‹·è´ã€‚å…·ä½“å¦‚ä¸‹å›¾å’Œå°ç»“ï¼š</p></li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter03_20.png" alt="img"></p><ol start="5"><li>è¿™é‡Œå…¶å®æœ‰ä¸€æ¬¡ <code>cpu</code> æ‹·è´ <code>kernel buffer</code> -&gt; <code>socket buffer</code> ä½†æ˜¯ï¼Œæ‹·è´çš„ä¿¡æ¯å¾ˆå°‘ï¼Œæ¯”å¦‚ <code>lenght</code>ã€<code>offset</code> æ¶ˆè€—ä½ï¼Œå¯ä»¥å¿½ç•¥</li></ol><h4 id="3-13-6-é›¶æ‹·è´çš„å†æ¬¡ç†è§£"><a href="#3-13-6-é›¶æ‹·è´çš„å†æ¬¡ç†è§£" class="headerlink" title="3.13.6 é›¶æ‹·è´çš„å†æ¬¡ç†è§£"></a>3.13.6 é›¶æ‹·è´çš„å†æ¬¡ç†è§£</h4><ol><li>æˆ‘ä»¬è¯´é›¶æ‹·è´ï¼Œæ˜¯ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦æ¥è¯´çš„ã€‚å› ä¸ºå†…æ ¸ç¼“å†²åŒºä¹‹é—´ï¼Œæ²¡æœ‰æ•°æ®æ˜¯é‡å¤çš„ï¼ˆåªæœ‰ <code>kernel buffer</code> æœ‰ä¸€ä»½æ•°æ®ï¼‰ã€‚</li><li>é›¶æ‹·è´ä¸ä»…ä»…å¸¦æ¥æ›´å°‘çš„æ•°æ®å¤åˆ¶ï¼Œè¿˜èƒ½å¸¦æ¥å…¶ä»–çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä¾‹å¦‚æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ›´å°‘çš„ <code>CPU</code> ç¼“å­˜ä¼ªå…±äº«ä»¥åŠæ—  <code>CPU</code> æ ¡éªŒå’Œè®¡ç®—ã€‚</li></ol><h4 id="3-13-7-mmap-å’Œ-sendFile-çš„åŒºåˆ«"><a href="#3-13-7-mmap-å’Œ-sendFile-çš„åŒºåˆ«" class="headerlink" title="3.13.7 mmap å’Œ sendFile çš„åŒºåˆ«"></a>3.13.7 mmap å’Œ sendFile çš„åŒºåˆ«</h4><ol><li><code>mmap</code> é€‚åˆå°æ•°æ®é‡è¯»å†™ï¼Œ<code>sendFile</code> é€‚åˆå¤§æ–‡ä»¶ä¼ è¾“ã€‚</li><li><code>mmap</code> éœ€è¦ <code>4</code> æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ<code>3</code> æ¬¡æ•°æ®æ‹·è´ï¼›<code>sendFile</code> éœ€è¦ <code>3</code> æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ€å°‘ <code>2</code> æ¬¡æ•°æ®æ‹·è´ã€‚</li><li><code>sendFile</code> å¯ä»¥åˆ©ç”¨ <code>DMA</code> æ–¹å¼ï¼Œå‡å°‘ <code>CPU</code> æ‹·è´ï¼Œ<code>mmap</code> åˆ™ä¸èƒ½ï¼ˆå¿…é¡»ä»å†…æ ¸æ‹·è´åˆ° <code>Socket</code>ç¼“å†²åŒºï¼‰ã€‚</li></ol><h4 id="3-13-8-NIO-é›¶æ‹·è´æ¡ˆä¾‹"><a href="#3-13-8-NIO-é›¶æ‹·è´æ¡ˆä¾‹" class="headerlink" title="3.13.8 NIO é›¶æ‹·è´æ¡ˆä¾‹"></a>3.13.8 NIO é›¶æ‹·è´æ¡ˆä¾‹</h4><p>æ¡ˆä¾‹è¦æ±‚ï¼š</p><ol><li>ä½¿ç”¨ä¼ ç»Ÿçš„ <code>IO</code> æ–¹æ³•ä¼ é€’ä¸€ä¸ªå¤§æ–‡ä»¶</li><li>ä½¿ç”¨ <code>NIO</code> é›¶æ‹·è´æ–¹å¼ä¼ é€’ï¼ˆ<code>transferTo</code>ï¼‰ä¸€ä¸ªå¤§æ–‡ä»¶</li><li>çœ‹çœ‹ä¸¤ç§ä¼ é€’æ–¹å¼è€—æ—¶æ—¶é—´åˆ†åˆ«æ˜¯å¤šå°‘</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.nio.zerocopy;<span class="hljs-keyword">import</span> java.net.InetSocketAddress;<span class="hljs-keyword">import</span> java.net.ServerSocket;<span class="hljs-keyword">import</span> java.nio.ByteBuffer;<span class="hljs-keyword">import</span> java.nio.channels.ServerSocketChannel;<span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<span class="hljs-comment">//æœåŠ¡å™¨</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewIOServer</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        InetSocketAddress address = <span class="hljs-keyword">new</span> InetSocketAddress(<span class="hljs-number">7001</span>);        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();        ServerSocket serverSocket = serverSocketChannel.socket();        serverSocket.bind(address);        <span class="hljs-comment">//åˆ›å»ºbuffer</span>        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="hljs-number">4096</span>);        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;            SocketChannel socketChannel = serverSocketChannel.accept();            <span class="hljs-keyword">int</span> readcount = <span class="hljs-number">0</span>;            <span class="hljs-keyword">while</span> (-<span class="hljs-number">1</span> != readcount) &#123;                <span class="hljs-keyword">try</span> &#123;                    readcount = socketChannel.read(byteBuffer);                &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;                    <span class="hljs-comment">// ex.printStackTrace();</span>                    <span class="hljs-keyword">break</span>;                &#125;                <span class="hljs-comment">//</span>                byteBuffer.rewind(); <span class="hljs-comment">//å€’å¸¦ position = 0 mark ä½œåºŸ</span>            &#125;        &#125;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.nio.zerocopy;<span class="hljs-keyword">import</span> java.io.FileInputStream;<span class="hljs-keyword">import</span> java.net.InetSocketAddress;<span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewIOClient</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        SocketChannel socketChannel = SocketChannel.open();        socketChannel.connect(<span class="hljs-keyword">new</span> InetSocketAddress(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">7001</span>));        String filename = <span class="hljs-string">&quot;protoc-3.6.1-win32.zip&quot;</span>;        <span class="hljs-comment">//å¾—åˆ°ä¸€ä¸ªæ–‡ä»¶channel</span>        FileChannel fileChannel = <span class="hljs-keyword">new</span> FileInputStream(filename).getChannel();        <span class="hljs-comment">//å‡†å¤‡å‘é€</span>        <span class="hljs-keyword">long</span> startTime = System.currentTimeMillis();        <span class="hljs-comment">//åœ¨ linux ä¸‹ä¸€ä¸ª transferTo æ–¹æ³•å°±å¯ä»¥å®Œæˆä¼ è¾“</span>        <span class="hljs-comment">//åœ¨ windows ä¸‹ä¸€æ¬¡è°ƒç”¨ transferTo åªèƒ½å‘é€ 8m, å°±éœ€è¦åˆ†æ®µä¼ è¾“æ–‡ä»¶,è€Œä¸”è¦ä¸»è¦</span>        <span class="hljs-comment">//ä¼ è¾“æ—¶çš„ä½ç½®=ã€‹è¯¾åæ€è€ƒ...</span>        <span class="hljs-comment">//transferTo åº•å±‚ä½¿ç”¨åˆ°é›¶æ‹·è´</span>        <span class="hljs-keyword">long</span> transferCount = fileChannel.transferTo(<span class="hljs-number">0</span>, fileChannel.size(), socketChannel);        System.out.println(<span class="hljs-string">&quot;å‘é€çš„æ€»çš„å­—èŠ‚æ•° = &quot;</span> + transferCount + <span class="hljs-string">&quot; è€—æ—¶: &quot;</span> + (System.currentTimeMillis() - startTime));        <span class="hljs-comment">//å…³é—­</span>        fileChannel.close();    &#125;&#125;</code></pre></div><h3 id="3-14-Java-AIO-åŸºæœ¬ä»‹ç»"><a href="#3-14-Java-AIO-åŸºæœ¬ä»‹ç»" class="headerlink" title="3.14 Java AIO åŸºæœ¬ä»‹ç»"></a>3.14 Java AIO åŸºæœ¬ä»‹ç»</h3><ol><li><code>JDK7</code> å¼•å…¥äº† <code>AsynchronousI/O</code>ï¼Œå³ <code>AIO</code>ã€‚åœ¨è¿›è¡Œ <code>I/O</code> ç¼–ç¨‹ä¸­ï¼Œå¸¸ç”¨åˆ°ä¸¤ç§æ¨¡å¼ï¼š<code>Reactor</code> å’Œ <code>Proactor</code>ã€‚<code>Java</code> çš„ <code>NIO</code> å°±æ˜¯ <code>Reactor</code>ï¼Œå½“æœ‰äº‹ä»¶è§¦å‘æ—¶ï¼ŒæœåŠ¡å™¨ç«¯å¾—åˆ°é€šçŸ¥ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†</li><li><code>AIO</code> å³ <code>NIO2.0</code>ï¼Œå«åšå¼‚æ­¥ä¸é˜»å¡çš„ <code>IO</code>ã€‚<code>AIO</code> å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† <code>Proactor</code> æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å»å¤„ç†ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨</li><li>ç›®å‰ <code>AIO</code> è¿˜æ²¡æœ‰å¹¿æ³›åº”ç”¨ï¼Œ<code>Netty</code> ä¹Ÿæ˜¯åŸºäº <code>NIO</code>ï¼Œè€Œä¸æ˜¯ <code>AIO</code>ï¼Œå› æ­¤æˆ‘ä»¬å°±ä¸è¯¦è§£ <code>AIO</code> äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒ<a href="http://www.52im.net/thread-306-1-1.html">ã€ŠJavaæ–°ä¸€ä»£ç½‘ç»œç¼–ç¨‹æ¨¡å‹AIOåŸç†åŠLinuxç³»ç»ŸAIOä»‹ç»ã€‹</a></li></ol><h3 id="3-15-BIOã€NIOã€AIO-å¯¹æ¯”è¡¨"><a href="#3-15-BIOã€NIOã€AIO-å¯¹æ¯”è¡¨" class="headerlink" title="3.15 BIOã€NIOã€AIO å¯¹æ¯”è¡¨"></a>3.15 BIOã€NIOã€AIO å¯¹æ¯”è¡¨</h3><table><thead><tr><th></th><th>BIO</th><th>NIO</th><th>AIO</th></tr></thead><tbody><tr><td>IOæ¨¡å‹</td><td>åŒæ­¥é˜»å¡</td><td>åŒæ­¥éé˜»å¡ï¼ˆå¤šè·¯å¤ç”¨ï¼‰</td><td>å¼‚æ­¥éé˜»å¡</td></tr><tr><td>ç¼–ç¨‹éš¾åº¦</td><td>ç®€å•</td><td>å¤æ‚</td><td>å¤æ‚</td></tr><tr><td>å¯é æ€§</td><td>å·®</td><td>å¥½</td><td>å¥½</td></tr><tr><td>ååé‡</td><td>ä½</td><td>é«˜</td><td>é«˜</td></tr></tbody></table><p><strong>ä¸¾ä¾‹è¯´æ˜</strong></p><ol><li>åŒæ­¥é˜»å¡ï¼šåˆ°ç†å‘åº—ç†å‘ï¼Œå°±ä¸€ç›´ç­‰ç†å‘å¸ˆï¼Œç›´åˆ°è½®åˆ°è‡ªå·±ç†å‘ã€‚</li><li>åŒæ­¥éé˜»å¡ï¼šåˆ°ç†å‘åº—ç†å‘ï¼Œå‘ç°å‰é¢æœ‰å…¶å®ƒäººç†å‘ï¼Œç»™ç†å‘å¸ˆè¯´ä¸‹ï¼Œå…ˆå¹²å…¶ä»–äº‹æƒ…ï¼Œä¸€ä¼šè¿‡æ¥çœ‹æ˜¯å¦è½®åˆ°è‡ªå·±.</li><li>å¼‚æ­¥éé˜»å¡ï¼šç»™ç†å‘å¸ˆæ‰“ç”µè¯ï¼Œè®©ç†å‘å¸ˆä¸Šé—¨æœåŠ¡ï¼Œè‡ªå·±å¹²å…¶å®ƒäº‹æƒ…ï¼Œç†å‘å¸ˆè‡ªå·±æ¥å®¶ç»™ä½ ç†å‘</li></ol><h2 id="4-Netty-æ¦‚è¿°"><a href="#4-Netty-æ¦‚è¿°" class="headerlink" title="4 Netty æ¦‚è¿°"></a>4 Netty æ¦‚è¿°</h2><h3 id="4-1-åŸç”Ÿ-NIO-å­˜åœ¨çš„é—®é¢˜"><a href="#4-1-åŸç”Ÿ-NIO-å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="4.1 åŸç”Ÿ NIO å­˜åœ¨çš„é—®é¢˜"></a>4.1 åŸç”Ÿ NIO å­˜åœ¨çš„é—®é¢˜</h3><ol><li><code>NIO</code> çš„ç±»åº“å’Œ <code>API</code> ç¹æ‚ï¼Œä½¿ç”¨éº»çƒ¦ï¼šéœ€è¦ç†Ÿç»ƒæŒæ¡ <code>Selector</code>ã€<code>ServerSocketChannel</code>ã€<code>SocketChannel</code>ã€<code>ByteBuffer</code>ç­‰ã€‚</li><li>éœ€è¦å…·å¤‡å…¶ä»–çš„é¢å¤–æŠ€èƒ½ï¼šè¦ç†Ÿæ‚‰ <code>Java</code> å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå› ä¸º <code>NIO</code> ç¼–ç¨‹æ¶‰åŠåˆ° <code>Reactor</code> æ¨¡å¼ï¼Œä½ å¿…é¡»å¯¹å¤šçº¿ç¨‹å’Œç½‘ç»œç¼–ç¨‹éå¸¸ç†Ÿæ‚‰ï¼Œæ‰èƒ½ç¼–å†™å‡ºé«˜è´¨é‡çš„ <code>NIO</code> ç¨‹åºã€‚</li><li>å¼€å‘å·¥ä½œé‡å’Œéš¾åº¦éƒ½éå¸¸å¤§ï¼šä¾‹å¦‚å®¢æˆ·ç«¯é¢ä¸´æ–­è¿é‡è¿ã€ç½‘ç»œé—ªæ–­ã€åŠåŒ…è¯»å†™ã€å¤±è´¥ç¼“å­˜ã€ç½‘ç»œæ‹¥å¡å’Œå¼‚å¸¸æµçš„å¤„ç†ç­‰ç­‰ã€‚4. <code>JDK NIO</code> çš„ <code>Bug</code>ï¼šä¾‹å¦‚è‡­åæ˜­è‘—çš„ <code>Epoll Bug</code>ï¼Œå®ƒä¼šå¯¼è‡´ <code>Selector</code> ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´ <code>CPU100%</code>ã€‚ç›´åˆ° <code>JDK1.7</code> ç‰ˆæœ¬è¯¥é—®é¢˜ä»æ—§å­˜åœ¨ï¼Œæ²¡æœ‰è¢«æ ¹æœ¬è§£å†³ã€‚</li></ol><h3 id="4-2-Netty-å®˜ç½‘è¯´æ˜"><a href="#4-2-Netty-å®˜ç½‘è¯´æ˜" class="headerlink" title="4.2 Netty å®˜ç½‘è¯´æ˜"></a>4.2 Netty å®˜ç½‘è¯´æ˜</h3><p>å®˜ç½‘ï¼š<a href="https://netty.io/">https://netty.io/</a></p><p>Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers &amp; clients.</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter04_01.png" alt="img"></p><h3 id="4-3-Netty-çš„ä¼˜ç‚¹"><a href="#4-3-Netty-çš„ä¼˜ç‚¹" class="headerlink" title="4.3 Netty çš„ä¼˜ç‚¹"></a>4.3 Netty çš„ä¼˜ç‚¹</h3><p><code>Netty</code> å¯¹ <code>JDK</code> è‡ªå¸¦çš„ <code>NIO</code> çš„ <code>API</code> è¿›è¡Œäº†å°è£…ï¼Œè§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚</p><ol><li>è®¾è®¡ä¼˜é›…ï¼šé€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ <code>API</code> é˜»å¡å’Œéé˜»å¡ <code>Socket</code>ï¼›åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ï¼Œå¯ä»¥æ¸…æ™°åœ°åˆ†ç¦»å…³æ³¨ç‚¹ï¼›é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹-å•çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ± ã€‚</li><li>ä½¿ç”¨æ–¹ä¾¿ï¼šè¯¦ç»†è®°å½•çš„ <code>Javadoc</code>ï¼Œç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ï¼›æ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹ï¼Œ<code>JDK5ï¼ˆNetty3.xï¼‰</code>æˆ– <code>6ï¼ˆNetty4.xï¼‰</code>å°±è¶³å¤Ÿäº†ã€‚</li><li>é«˜æ€§èƒ½ã€ååé‡æ›´é«˜ï¼šå»¶è¿Ÿæ›´ä½ï¼›å‡å°‘èµ„æºæ¶ˆè€—ï¼›æœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ã€‚</li><li>å®‰å…¨ï¼šå®Œæ•´çš„ <code>SSL/TLS</code> å’Œ <code>StartTLS</code> æ”¯æŒã€‚</li><li>ç¤¾åŒºæ´»è·ƒã€ä¸æ–­æ›´æ–°ï¼šç¤¾åŒºæ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œå‘ç°çš„ <code>Bug</code> å¯ä»¥è¢«åŠæ—¶ä¿®å¤ï¼ŒåŒæ—¶ï¼Œæ›´å¤šçš„æ–°åŠŸèƒ½ä¼šè¢«åŠ å…¥ã€‚</li></ol><h3 id="4-4-Netty-ç‰ˆæœ¬è¯´æ˜"><a href="#4-4-Netty-ç‰ˆæœ¬è¯´æ˜" class="headerlink" title="4.4 Netty ç‰ˆæœ¬è¯´æ˜"></a>4.4 Netty ç‰ˆæœ¬è¯´æ˜</h3><ol><li><p><code>Netty</code> ç‰ˆæœ¬åˆ†ä¸º <code>Netty 3.x</code> å’Œ <code>Netty 4.x</code>ã€<code>Netty 5.x</code></p></li><li><p>å› ä¸º <code>Netty 5</code> å‡ºç°é‡å¤§ <code>bug</code>ï¼Œå·²ç»è¢«å®˜ç½‘åºŸå¼ƒäº†ï¼Œç›®å‰æ¨èä½¿ç”¨çš„æ˜¯ <code>Netty 4.x</code>çš„ç¨³å®šç‰ˆæœ¬</p></li><li><p>ç›®å‰åœ¨å®˜ç½‘å¯ä¸‹è½½çš„ç‰ˆæœ¬ <code>Netty 3.x</code>ã€<code>Netty 4.0.x</code> å’Œ <code>Netty 4.1.x</code></p></li><li><p>åœ¨æœ¬å¥—è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è®²è§£ <code>Netty4.1.x</code> ç‰ˆæœ¬</p></li><li><p><code>Netty</code> ä¸‹è½½åœ°å€ï¼š<a href="https://bintray.com/netty/downloads/netty/">https://bintray.com/netty/downloads/netty/</a></p></li><li><p>maven</p><div class="code-wrapper"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/io.netty/netty-all --&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.netty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>netty-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.42.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div></li></ol><h2 id="5-Netty-é«˜æ€§èƒ½æ¶æ„è®¾è®¡"><a href="#5-Netty-é«˜æ€§èƒ½æ¶æ„è®¾è®¡" class="headerlink" title="5  Netty é«˜æ€§èƒ½æ¶æ„è®¾è®¡"></a>5  Netty é«˜æ€§èƒ½æ¶æ„è®¾è®¡</h2><h3 id="5-1-çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»"><a href="#5-1-çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»" class="headerlink" title="5.1 çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»"></a>5.1 çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»</h3><ol><li>ä¸åŒçš„çº¿ç¨‹æ¨¡å¼ï¼Œå¯¹ç¨‹åºçš„æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Œä¸ºäº†ææ¸… <code>Netty</code> çº¿ç¨‹æ¨¡å¼ï¼Œæˆ‘ä»¬æ¥ç³»ç»Ÿçš„è®²è§£ä¸‹å„ä¸ªçº¿ç¨‹æ¨¡å¼ï¼Œæœ€åçœ‹çœ‹ <code>Netty</code> çº¿ç¨‹æ¨¡å‹æœ‰ä»€ä¹ˆä¼˜è¶Šæ€§ã€‚</li><li>ç›®å‰å­˜åœ¨çš„çº¿ç¨‹æ¨¡å‹æœ‰ï¼šä¼ ç»Ÿé˜»å¡ <code>I/O</code> æœåŠ¡æ¨¡å‹ <code>Reactor</code> æ¨¡å¼</li><li>æ ¹æ® <code>Reactor</code> çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ <code>3</code> ç§å…¸å‹çš„å®ç°å• <code>Reactor</code> å•çº¿ç¨‹ï¼›å• <code>Reactor</code>å¤šçº¿ç¨‹ï¼›ä¸»ä» <code>Reactor</code>å¤šçº¿ç¨‹</li><li><code>Netty</code> çº¿ç¨‹æ¨¡å¼ï¼ˆ<code>Netty</code> ä¸»è¦åŸºäºä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹æ¨¡å‹åšäº†ä¸€å®šçš„æ”¹è¿›ï¼Œå…¶ä¸­ä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª <code>Reactor</code>ï¼‰</li></ol><h3 id="5-2-ä¼ ç»Ÿé˜»å¡-I-O-æœåŠ¡æ¨¡å‹"><a href="#5-2-ä¼ ç»Ÿé˜»å¡-I-O-æœåŠ¡æ¨¡å‹" class="headerlink" title="5.2 ä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹"></a>5.2 ä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹</h3><h4 id="5-2-1-å·¥ä½œåŸç†å›¾"><a href="#5-2-1-å·¥ä½œåŸç†å›¾" class="headerlink" title="5.2.1 å·¥ä½œåŸç†å›¾"></a>5.2.1 å·¥ä½œåŸç†å›¾</h4><ol><li>é»„è‰²çš„æ¡†è¡¨ç¤ºå¯¹è±¡ï¼Œè“è‰²çš„æ¡†è¡¨ç¤ºçº¿ç¨‹</li><li>ç™½è‰²çš„æ¡†è¡¨ç¤ºæ–¹æ³•ï¼ˆ<code>API</code>ï¼‰</li></ol><h4 id="5-2-2-æ¨¡å‹ç‰¹ç‚¹"><a href="#5-2-2-æ¨¡å‹ç‰¹ç‚¹" class="headerlink" title="5.2.2 æ¨¡å‹ç‰¹ç‚¹"></a>5.2.2 æ¨¡å‹ç‰¹ç‚¹</h4><ol><li>é‡‡ç”¨é˜»å¡ <code>IO</code> æ¨¡å¼è·å–è¾“å…¥çš„æ•°æ®</li><li>æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®è¿”å›</li></ol><h4 id="5-2-3-é—®é¢˜åˆ†æ"><a href="#5-2-3-é—®é¢˜åˆ†æ" class="headerlink" title="5.2.3 é—®é¢˜åˆ†æ"></a>5.2.3 é—®é¢˜åˆ†æ</h4><ol><li>å½“å¹¶å‘æ•°å¾ˆå¤§ï¼Œå°±ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå ç”¨å¾ˆå¤§ç³»ç»Ÿèµ„æº</li><li>è¿æ¥åˆ›å»ºåï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œè¯¥çº¿ç¨‹ä¼šé˜»å¡åœ¨ <code>read</code> æ“ä½œï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter05_01.png" alt="img"></p><h3 id="5-3-Reactor-æ¨¡å¼"><a href="#5-3-Reactor-æ¨¡å¼" class="headerlink" title="5.3 Reactor æ¨¡å¼"></a>5.3 Reactor æ¨¡å¼</h3><h4 id="5-3-1-é’ˆå¯¹ä¼ ç»Ÿé˜»å¡-I-O-æœåŠ¡æ¨¡å‹çš„-2-ä¸ªç¼ºç‚¹ï¼Œè§£å†³æ–¹æ¡ˆï¼š"><a href="#5-3-1-é’ˆå¯¹ä¼ ç»Ÿé˜»å¡-I-O-æœåŠ¡æ¨¡å‹çš„-2-ä¸ªç¼ºç‚¹ï¼Œè§£å†³æ–¹æ¡ˆï¼š" class="headerlink" title="5.3.1 é’ˆå¯¹ä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹çš„ 2 ä¸ªç¼ºç‚¹ï¼Œè§£å†³æ–¹æ¡ˆï¼š"></a>5.3.1 é’ˆå¯¹ä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹çš„ 2 ä¸ªç¼ºç‚¹ï¼Œè§£å†³æ–¹æ¡ˆï¼š</h4><ol><li>åŸºäº <code>I/O</code> å¤ç”¨æ¨¡å‹ï¼šå¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ã€‚å½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç† <code>Reactor</code> å¯¹åº”çš„å«æ³•ï¼š<ol><li>ååº”å™¨æ¨¡å¼</li><li>åˆ†å‘è€…æ¨¡å¼ï¼ˆDispatcherï¼‰</li><li>é€šçŸ¥è€…æ¨¡å¼ï¼ˆnotifierï¼‰</li></ol></li><li>åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æºï¼šä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå°†è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter05_02.png" alt="img"></p><h4 id="5-3-2-I-O-å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå°±æ˜¯-Reactor-æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼Œå¦‚å›¾"><a href="#5-3-2-I-O-å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå°±æ˜¯-Reactor-æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼Œå¦‚å›¾" class="headerlink" title="5.3.2 I/O å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå°±æ˜¯ Reactor æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼Œå¦‚å›¾"></a>5.3.2 I/O å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå°±æ˜¯ Reactor æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼Œå¦‚å›¾</h4><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter05_03.png" alt="img"></p><p>å¯¹ä¸Šå›¾è¯´æ˜ï¼š</p><ol><li><code>Reactor</code> æ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„æ¨¡å¼ï¼ˆåŸºäºäº‹ä»¶é©±åŠ¨ï¼‰</li><li>æœåŠ¡å™¨ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šä¸ªè¯·æ±‚,å¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾åˆ°ç›¸åº”çš„å¤„ç†çº¿ç¨‹ï¼Œå› æ­¤ <code>Reactor</code> æ¨¡å¼ä¹Ÿå« <code>Dispatcher</code> æ¨¡å¼</li><li><code>Reactor</code> æ¨¡å¼ä½¿ç”¨ <code>IO</code> å¤ç”¨ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œåˆ†å‘ç»™æŸä¸ªçº¿ç¨‹ï¼ˆè¿›ç¨‹ï¼‰ï¼Œè¿™ç‚¹å°±æ˜¯ç½‘ç»œæœåŠ¡å™¨é«˜å¹¶å‘å¤„ç†å…³é”®</li></ol><h4 id="5-3-3-Reactor-æ¨¡å¼ä¸­æ ¸å¿ƒç»„æˆ"><a href="#5-3-3-Reactor-æ¨¡å¼ä¸­æ ¸å¿ƒç»„æˆ" class="headerlink" title="5.3.3 Reactor æ¨¡å¼ä¸­æ ¸å¿ƒç»„æˆ"></a>5.3.3 Reactor æ¨¡å¼ä¸­æ ¸å¿ƒç»„æˆ</h4><ol><li><code>Reactor</code>ï¼š<code>Reactor</code> åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ <code>IO</code> äº‹ä»¶åšå‡ºååº”ã€‚å®ƒå°±åƒå…¬å¸çš„ç”µè¯æ¥çº¿å‘˜ï¼Œå®ƒæ¥å¬æ¥è‡ªå®¢æˆ·çš„ç”µè¯å¹¶å°†çº¿è·¯è½¬ç§»åˆ°é€‚å½“çš„è”ç³»äººï¼›</li><li><code>Handlers</code>ï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ <code>I/O</code> äº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼Œç±»ä¼¼äºå®¢æˆ·æƒ³è¦ä¸ä¹‹äº¤è°ˆçš„å…¬å¸ä¸­çš„å®é™…å®˜å‘˜ã€‚<code>Reactor</code> é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” <code>I/O</code> äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œã€‚</li></ol><h4 id="5-3-4-Reactor-æ¨¡å¼åˆ†ç±»"><a href="#5-3-4-Reactor-æ¨¡å¼åˆ†ç±»" class="headerlink" title="5.3.4 Reactor æ¨¡å¼åˆ†ç±»"></a>5.3.4 Reactor æ¨¡å¼åˆ†ç±»</h4><p>æ ¹æ® <code>Reactor</code> çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ <code>3</code> ç§å…¸å‹çš„å®ç°</p><ol><li>å• <code>Reactor</code> å•çº¿ç¨‹</li><li>å• <code>Reactor</code> å¤šçº¿ç¨‹</li><li>ä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹</li></ol><h3 id="5-4-å•-Reactor-å•çº¿ç¨‹"><a href="#5-4-å•-Reactor-å•çº¿ç¨‹" class="headerlink" title="5.4 å• Reactor å•çº¿ç¨‹"></a>5.4 å• Reactor å•çº¿ç¨‹</h3><p>åŸç†å›¾ï¼Œå¹¶ä½¿ç”¨ <code>NIO</code> ç¾¤èŠç³»ç»ŸéªŒè¯</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter05_04.png" alt="img"></p><h4 id="5-4-1-æ–¹æ¡ˆè¯´æ˜"><a href="#5-4-1-æ–¹æ¡ˆè¯´æ˜" class="headerlink" title="5.4.1 æ–¹æ¡ˆè¯´æ˜"></a>5.4.1 æ–¹æ¡ˆè¯´æ˜</h4><ol><li><code>Select</code> æ˜¯å‰é¢ <code>I/O</code> å¤ç”¨æ¨¡å‹ä»‹ç»çš„æ ‡å‡†ç½‘ç»œç¼–ç¨‹ <code>API</code>ï¼Œå¯ä»¥å®ç°åº”ç”¨ç¨‹åºé€šè¿‡ä¸€ä¸ªé˜»å¡å¯¹è±¡ç›‘å¬å¤šè·¯è¿æ¥è¯·æ±‚</li><li><code>Reactor</code> å¯¹è±¡é€šè¿‡ <code>Select</code> ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ <code>Dispatch</code> è¿›è¡Œåˆ†å‘</li><li>å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± <code>Acceptor</code> é€šè¿‡ <code>Accept</code> å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª <code>Handler</code> å¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç†</li><li>å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™ <code>Reactor</code> ä¼šåˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ <code>Handler</code> æ¥å“åº”</li><li><code>Handler</code> ä¼šå®Œæˆ <code>Read</code> â†’ ä¸šåŠ¡å¤„ç† â†’ <code>Send</code> çš„å®Œæ•´ä¸šåŠ¡æµç¨‹</li></ol><p>ç»“åˆå®ä¾‹ï¼šæœåŠ¡å™¨ç«¯ç”¨ä¸€ä¸ªçº¿ç¨‹é€šè¿‡å¤šè·¯å¤ç”¨æå®šæ‰€æœ‰çš„ <code>IO</code> æ“ä½œï¼ˆåŒ…æ‹¬è¿æ¥ï¼Œè¯»ã€å†™ç­‰ï¼‰ï¼Œç¼–ç ç®€å•ï¼Œæ¸…æ™°æ˜äº†ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯è¿æ¥æ•°é‡è¾ƒå¤šï¼Œå°†æ— æ³•æ”¯æ’‘ï¼Œå‰é¢çš„ <code>NIO</code> æ¡ˆä¾‹å°±å±äºè¿™ç§æ¨¡å‹ã€‚</p><h4 id="5-4-2-æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ"><a href="#5-4-2-æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ" class="headerlink" title="5.4.2 æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ"></a>5.4.2 æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ</h4><ol><li>ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ</li><li>ç¼ºç‚¹ï¼šæ€§èƒ½é—®é¢˜ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å®Œå…¨å‘æŒ¥å¤šæ ¸ <code>CPU</code> çš„æ€§èƒ½ã€‚<code>Handler</code>åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ</li><li>ç¼ºç‚¹ï¼šå¯é æ€§é—®é¢˜ï¼Œçº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ</li><li>ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿï¼Œæ¯”å¦‚ <code>Redis</code> åœ¨ä¸šåŠ¡å¤„ç†çš„æ—¶é—´å¤æ‚åº¦ <code>O(1)</code> çš„æƒ…å†µ</li></ol><h3 id="5-5-å•-Reactor-å¤šçº¿ç¨‹"><a href="#5-5-å•-Reactor-å¤šçº¿ç¨‹" class="headerlink" title="5.5 å• Reactor å¤šçº¿ç¨‹"></a>5.5 å• Reactor å¤šçº¿ç¨‹</h3><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_05.png" alt="img"></p><h4 id="5-5-1-åŸç†å›¾"><a href="#5-5-1-åŸç†å›¾" class="headerlink" title="5.5.1 åŸç†å›¾"></a>5.5.1 åŸç†å›¾</h4><h4 id="5-5-2-å¯¹ä¸Šå›¾çš„å°ç»“"><a href="#5-5-2-å¯¹ä¸Šå›¾çš„å°ç»“" class="headerlink" title="5.5.2 å¯¹ä¸Šå›¾çš„å°ç»“"></a>5.5.2 å¯¹ä¸Šå›¾çš„å°ç»“</h4><ol><li><code>Reactor</code> å¯¹è±¡é€šè¿‡ <code>Select</code> ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡ <code>Dispatch</code> è¿›è¡Œåˆ†å‘</li><li>å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚ï¼Œåˆ™å³ <code>Acceptor</code> é€šè¿‡ <code>accept</code> å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª <code>Handler</code> å¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ç§äº‹ä»¶</li><li>å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”± <code>Reactor</code> åˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ <code>handler</code> æ¥å¤„ç†</li><li><code>handler</code> åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡ <code>read</code> è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„ <code>worker</code> çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡</li><li><code>worker</code> çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ <code>handler</code></li><li><code>handler</code> æ”¶åˆ°å“åº”åï¼Œé€šè¿‡ <code>send</code> å°†ç»“æœè¿”å›ç»™ <code>client</code></li></ol><h4 id="5-5-3-æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ"><a href="#5-5-3-æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ" class="headerlink" title="5.5.3 æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ"></a>5.5.3 æ–¹æ¡ˆä¼˜ç¼ºç‚¹åˆ†æ</h4><ol><li>ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸ <code>cpu</code> çš„å¤„ç†èƒ½åŠ›</li><li>ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ï¼Œ<code>Reactor</code> å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹è¿è¡Œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚</li></ol><h3 id="5-6-ä¸»ä»-Reactor-å¤šçº¿ç¨‹"><a href="#5-6-ä¸»ä»-Reactor-å¤šçº¿ç¨‹" class="headerlink" title="5.6 ä¸»ä» Reactor å¤šçº¿ç¨‹"></a>5.6 ä¸»ä» Reactor å¤šçº¿ç¨‹</h3><h4 id="5-6-1-å·¥ä½œåŸç†å›¾"><a href="#5-6-1-å·¥ä½œåŸç†å›¾" class="headerlink" title="5.6.1 å·¥ä½œåŸç†å›¾"></a>5.6.1 å·¥ä½œåŸç†å›¾</h4><p>é’ˆå¯¹å• <code>Reactor</code> å¤šçº¿ç¨‹æ¨¡å‹ä¸­ï¼Œ<code>Reactor</code> åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œå¯ä»¥è®© <code>Reactor</code> åœ¨å¤šçº¿ç¨‹ä¸­è¿è¡Œ</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_06.png" alt="img"></p><h4 id="5-6-2-ä¸Šå›¾çš„æ–¹æ¡ˆè¯´æ˜"><a href="#5-6-2-ä¸Šå›¾çš„æ–¹æ¡ˆè¯´æ˜" class="headerlink" title="5.6.2 ä¸Šå›¾çš„æ–¹æ¡ˆè¯´æ˜"></a>5.6.2 ä¸Šå›¾çš„æ–¹æ¡ˆè¯´æ˜</h4><ol><li><code>Reactor</code> ä¸»çº¿ç¨‹ <code>MainReactor</code> å¯¹è±¡é€šè¿‡ <code>select</code> ç›‘å¬è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡ <code>Acceptor</code> å¤„ç†è¿æ¥äº‹ä»¶</li><li>å½“ <code>Acceptor</code> å¤„ç†è¿æ¥äº‹ä»¶åï¼Œ<code>MainReactor</code> å°†è¿æ¥åˆ†é…ç»™ <code>SubReactor</code></li><li><code>subreactor</code> å°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»º <code>handler</code> è¿›è¡Œå„ç§äº‹ä»¶å¤„ç†</li><li>å½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>subreactor</code> å°±ä¼šè°ƒç”¨å¯¹åº”çš„ <code>handler</code> å¤„ç†</li><li><code>handler</code> é€šè¿‡ <code>read</code> è¯»å–æ•°æ®ï¼Œåˆ†å‘ç»™åé¢çš„ <code>worker</code> çº¿ç¨‹å¤„ç†</li><li><code>worker</code> çº¿ç¨‹æ± åˆ†é…ç‹¬ç«‹çš„ <code>worker</code> çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿”å›ç»“æœ</li><li><code>handler</code> æ”¶åˆ°å“åº”çš„ç»“æœåï¼Œå†é€šè¿‡ <code>send</code> å°†ç»“æœè¿”å›ç»™ <code>client</code></li><li><code>Reactor</code> ä¸»çº¿ç¨‹å¯ä»¥å¯¹åº”å¤šä¸ª <code>Reactor</code> å­çº¿ç¨‹ï¼Œå³ <code>MainRecator</code> å¯ä»¥å…³è”å¤šä¸ª <code>SubReactor</code></li></ol><h4 id="5-6-3-Scalable-IO-in-Java-å¯¹-Multiple-Reactors-çš„åŸç†å›¾è§£ï¼š"><a href="#5-6-3-Scalable-IO-in-Java-å¯¹-Multiple-Reactors-çš„åŸç†å›¾è§£ï¼š" class="headerlink" title="5.6.3 Scalable IO in Java å¯¹ Multiple Reactors çš„åŸç†å›¾è§£ï¼š"></a>5.6.3 Scalable IO in Java å¯¹ Multiple Reactors çš„åŸç†å›¾è§£ï¼š</h4><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_07.png" alt="img"></p><h4 id="5-6-4-æ–¹æ¡ˆä¼˜ç¼ºç‚¹è¯´æ˜"><a href="#5-6-4-æ–¹æ¡ˆä¼˜ç¼ºç‚¹è¯´æ˜" class="headerlink" title="5.6.4 æ–¹æ¡ˆä¼˜ç¼ºç‚¹è¯´æ˜"></a>5.6.4 æ–¹æ¡ˆä¼˜ç¼ºç‚¹è¯´æ˜</h4><ol><li>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ã€‚</li><li>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼Œ<code>Reactor</code> ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®ã€‚</li><li>ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜</li><li>ç»“åˆå®ä¾‹ï¼šè¿™ç§æ¨¡å‹åœ¨è®¸å¤šé¡¹ç›®ä¸­å¹¿æ³›ä½¿ç”¨ï¼ŒåŒ…æ‹¬ <code>Nginx</code> ä¸»ä» <code>Reactor</code> å¤šè¿›ç¨‹æ¨¡å‹ï¼Œ<code>Memcached</code> ä¸»ä»å¤šçº¿ç¨‹ï¼Œ<code>Netty</code> ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒ</li></ol><h3 id="5-7-Reactor-æ¨¡å¼å°ç»“"><a href="#5-7-Reactor-æ¨¡å¼å°ç»“" class="headerlink" title="5.7 Reactor æ¨¡å¼å°ç»“"></a>5.7 Reactor æ¨¡å¼å°ç»“</h3><h4 id="5-7-1-3-ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£"><a href="#5-7-1-3-ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£" class="headerlink" title="5.7.1 3 ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£"></a>5.7.1 3 ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£</h4><ol><li>å• <code>Reactor</code> å•çº¿ç¨‹ï¼Œå‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœåŠ¡</li><li>å• <code>Reactor</code> å¤šçº¿ç¨‹ï¼Œ<code>1</code> ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾…</li><li>ä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹ï¼Œå¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡ç”Ÿ</li></ol><h4 id="5-7-2-Reactor-æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹"><a href="#5-7-2-Reactor-æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹" class="headerlink" title="5.7.2 Reactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹"></a>5.7.2 Reactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹</h4><ol><li>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶ <code>Reactor</code> æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„</li><li>å¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€</li><li>æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ  <code>Reactor</code> å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ <code>CPU</code> èµ„æº</li><li>å¤ç”¨æ€§å¥½ï¼Œ<code>Reactor</code> æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§</li></ol><h3 id="5-8-Netty-æ¨¡å‹"><a href="#5-8-Netty-æ¨¡å‹" class="headerlink" title="5.8 Netty æ¨¡å‹"></a>5.8 Netty æ¨¡å‹</h3><h4 id="5-8-1-å·¥ä½œåŸç†ç¤ºæ„å›¾-ç®€å•ç‰ˆ"><a href="#5-8-1-å·¥ä½œåŸç†ç¤ºæ„å›¾-ç®€å•ç‰ˆ" class="headerlink" title="5.8.1 å·¥ä½œåŸç†ç¤ºæ„å›¾ - ç®€å•ç‰ˆ"></a>5.8.1 å·¥ä½œåŸç†ç¤ºæ„å›¾ - ç®€å•ç‰ˆ</h4><p>Nettyä¸»è¦åŸºäº<code>ä¸»ä» Reactors</code> å¤šçº¿ç¨‹æ¨¡å‹ï¼ˆå¦‚å›¾ï¼‰åšäº†ä¸€å®šçš„æ”¹è¿›ï¼Œå…¶ä¸­ä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª `Reactor</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_08.png" alt="img"></p><h4 id="5-8-2-å¯¹ä¸Šå›¾è¯´æ˜"><a href="#5-8-2-å¯¹ä¸Šå›¾è¯´æ˜" class="headerlink" title="5.8.2 å¯¹ä¸Šå›¾è¯´æ˜"></a>5.8.2 å¯¹ä¸Šå›¾è¯´æ˜</h4><ol><li><code>BossGroup</code> çº¿ç¨‹ç»´æŠ¤ <code>Selector</code>ï¼Œåªå…³æ³¨ <code>Accecpt</code></li><li>å½“æ¥æ”¶åˆ° <code>Accept</code> äº‹ä»¶ï¼Œè·å–åˆ°å¯¹åº”çš„ <code>SocketChannel</code>ï¼Œå°è£…æˆ <code>NIOScoketChannel</code> å¹¶æ³¨å†Œåˆ° <code>Worker</code> çº¿ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ï¼Œå¹¶è¿›è¡Œç»´æŠ¤</li><li>å½“ <code>Worker</code> çº¿ç¨‹ç›‘å¬åˆ° <code>Selector</code> ä¸­é€šé“å‘ç”Ÿè‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶åï¼Œå°±è¿›è¡Œå¤„ç†ï¼ˆå°±ç”± <code>handler</code>ï¼‰ï¼Œæ³¨æ„ <code>handler</code> å·²ç»åŠ å…¥åˆ°é€šé“</li></ol><h4 id="5-8-3-å·¥ä½œåŸç†ç¤ºæ„å›¾-è¿›é˜¶ç‰ˆ"><a href="#5-8-3-å·¥ä½œåŸç†ç¤ºæ„å›¾-è¿›é˜¶ç‰ˆ" class="headerlink" title="5.8.3 å·¥ä½œåŸç†ç¤ºæ„å›¾ - è¿›é˜¶ç‰ˆ"></a>5.8.3 å·¥ä½œåŸç†ç¤ºæ„å›¾ - è¿›é˜¶ç‰ˆ</h4><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_09.png" alt="img"></p><h4 id="5-8-4-å·¥ä½œåŸç†ç¤ºæ„å›¾-è¯¦ç»†ç‰ˆ"><a href="#5-8-4-å·¥ä½œåŸç†ç¤ºæ„å›¾-è¯¦ç»†ç‰ˆ" class="headerlink" title="5.8.4 å·¥ä½œåŸç†ç¤ºæ„å›¾ - è¯¦ç»†ç‰ˆ"></a>5.8.4 å·¥ä½œåŸç†ç¤ºæ„å›¾ - è¯¦ç»†ç‰ˆ</h4><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_10.png" alt="img"></p><h4 id="5-8-5-å¯¹ä¸Šå›¾çš„è¯´æ˜å°ç»“"><a href="#5-8-5-å¯¹ä¸Šå›¾çš„è¯´æ˜å°ç»“" class="headerlink" title="5.8.5 å¯¹ä¸Šå›¾çš„è¯´æ˜å°ç»“"></a>5.8.5 å¯¹ä¸Šå›¾çš„è¯´æ˜å°ç»“</h4><ol><li><p><code>Netty</code> æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ±  <code>BossGroup</code> ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œ<code>WorkerGroup</code> ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™</p></li><li><p><code>BossGroup</code> å’Œ <code>WorkerGroup</code> ç±»å‹éƒ½æ˜¯ <code>NioEventLoopGroup</code></p></li><li><p><code>NioEventLoopGroup</code> ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œè¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ <code>NioEventLoop</code></p></li><li><p><code>NioEventLoop</code> è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª <code>NioEventLoop</code> éƒ½æœ‰ä¸€ä¸ª <code>Selector</code>ï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ <code>socket</code> çš„ç½‘ç»œé€šè®¯</p></li><li><p><code>NioEventLoopGroup</code> å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå³å¯ä»¥å«æœ‰å¤šä¸ª <code>NioEventLoop</code></p></li><li><p>æ¯ä¸ª å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰ <code>BossNioEventLoop``3</code></p><ul><li>è½®è¯¢ <code>accept</code> äº‹ä»¶</li><li>å¤„ç† <code>accept</code> äº‹ä»¶ï¼Œä¸ <code>client</code> å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ <code>NioScocketChannel</code>ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ª <code>worker</code> <code>NIOEventLoop</code> ä¸Šçš„ <code>Selector</code></li><li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ <code>runAllTasks</code></li></ul></li><li><p>æ¯ä¸ª å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤<code>Worker``NIOEventLoo</code></p><ul><li>è½®è¯¢ <code>read</code>ï¼Œ<code>write</code> äº‹ä»¶</li><li>å¤„ç† <code>I/O</code> äº‹ä»¶ï¼Œå³ <code>read</code>ï¼Œ<code>write</code> äº‹ä»¶ï¼Œåœ¨å¯¹åº” <code>NioScocketChannel</code> å¤„ç†</li><li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ <code>runAllTasks</code></li></ul></li><li><p>æ¯ä¸ª <code>Worker</code> <code>NIOEventLoop</code> å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ <code>pipeline</code>ï¼ˆç®¡é“ï¼‰ï¼Œ<code>pipeline</code> ä¸­åŒ…å«äº† <code>channel</code>ï¼Œå³é€šè¿‡ <code>pipeline</code> å¯ä»¥è·å–åˆ°å¯¹åº”é€šé“ï¼Œç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨</p></li></ol><h4 id="5-8-6-Netty-å¿«é€Ÿå…¥é—¨å®ä¾‹-TCP-æœåŠ¡"><a href="#5-8-6-Netty-å¿«é€Ÿå…¥é—¨å®ä¾‹-TCP-æœåŠ¡" class="headerlink" title="5.8.6 Netty å¿«é€Ÿå…¥é—¨å®ä¾‹ - TCP æœåŠ¡"></a>5.8.6 Netty å¿«é€Ÿå…¥é—¨å®ä¾‹ - TCP æœåŠ¡</h4><p>å®ä¾‹è¦æ±‚ï¼šä½¿ç”¨ <code>IDEA</code> åˆ›å»º <code>Netty</code> é¡¹ç›®</p><ol><li><code>Netty</code> æœåŠ¡å™¨åœ¨ <code>6668</code> ç«¯å£ç›‘å¬ï¼Œå®¢æˆ·ç«¯èƒ½å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨â€hello,æœåŠ¡å™¨~â€</li><li>æœåŠ¡å™¨å¯ä»¥å›å¤æ¶ˆæ¯ç»™å®¢æˆ·ç«¯â€hello,å®¢æˆ·ç«¯~â€</li><li>ç›®çš„ï¼šå¯¹ <code>Netty</code> çº¿ç¨‹æ¨¡å‹æœ‰ä¸€ä¸ªåˆæ­¥è®¤è¯†ï¼Œä¾¿äºç†è§£ <code>Netty</code> æ¨¡å‹ç†è®º</li><li>çœ‹è€å¸ˆä»£ç æ¼”ç¤º 5.1 ç¼–å†™æœåŠ¡ç«¯ 5.2 ç¼–å†™å®¢æˆ·ç«¯ 5.3 å¯¹ <code>netty</code> ç¨‹åºè¿›è¡Œåˆ†æï¼Œçœ‹çœ‹ <code>netty</code> æ¨¡å‹ç‰¹ç‚¹ è¯´æ˜ï¼šåˆ›å»º <code>Maven</code> é¡¹ç›®ï¼Œå¹¶å¼•å…¥ <code>Netty</code> åŒ…</li><li>ä»£ç å¦‚ä¸‹</li></ol><div class="code-wrapper"><pre><code class="hljs java">NettyServer.java<span class="hljs-keyword">package</span> com.atguigu.netty.simple;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFutureListener;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServer</span> </span>&#123;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                <span class="hljs-comment">//åˆ›å»ºBossGroup å’Œ WorkerGroup</span>        <span class="hljs-comment">//è¯´æ˜</span>        <span class="hljs-comment">//1. åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ bossGroup å’Œ workerGroup</span>        <span class="hljs-comment">//2. bossGroup åªæ˜¯å¤„ç†è¿æ¥è¯·æ±‚ , çœŸæ­£çš„å’Œå®¢æˆ·ç«¯ä¸šåŠ¡å¤„ç†ï¼Œä¼šäº¤ç»™ workerGroupå®Œæˆ</span>        <span class="hljs-comment">//3. ä¸¤ä¸ªéƒ½æ˜¯æ— é™å¾ªç¯</span>        <span class="hljs-comment">//4. bossGroup å’Œ workerGroup å«æœ‰çš„å­çº¿ç¨‹(NioEventLoop)çš„ä¸ªæ•°</span>        <span class="hljs-comment">//   é»˜è®¤å®é™… cpuæ ¸æ•° * 2</span>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(); <span class="hljs-comment">//8</span>                <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">//åˆ›å»ºæœåŠ¡å™¨ç«¯çš„å¯åŠ¨å¯¹è±¡ï¼Œé…ç½®å‚æ•°</span>            ServerBootstrap bootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();            <span class="hljs-comment">//ä½¿ç”¨é“¾å¼ç¼–ç¨‹æ¥è¿›è¡Œè®¾ç½®</span>            bootstrap.group(bossGroup, workerGroup) <span class="hljs-comment">//è®¾ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„</span>                    .channel(NioServerSocketChannel.class) <span class="hljs-comment">//ä½¿ç”¨NioSocketChannel ä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span>                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">128</span>) <span class="hljs-comment">// è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—å¾—åˆ°è¿æ¥ä¸ªæ•°</span>                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword">true</span>) <span class="hljs-comment">//è®¾ç½®ä¿æŒæ´»åŠ¨è¿æ¥çŠ¶æ€</span>            <span class="hljs-comment">//          .handler(null) // è¯¥ handlerå¯¹åº” bossGroup , childHandler å¯¹åº” workerGroup</span>                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;<span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªé€šé“åˆå§‹åŒ–å¯¹è±¡(åŒ¿åå¯¹è±¡)</span>                        <span class="hljs-comment">//ç»™pipeline è®¾ç½®å¤„ç†å™¨</span>                        <span class="hljs-meta">@Override</span>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·socketchannel hashcode=&quot;</span> + ch.hashCode()); <span class="hljs-comment">//å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé›†åˆç®¡ç† SocketChannelï¼Œ å†æ¨é€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å°†ä¸šåŠ¡åŠ å…¥åˆ°å„ä¸ªchannel å¯¹åº”çš„ NIOEventLoop çš„ taskQueue æˆ–è€… scheduleTaskQueue</span>                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> NettyServerHandler());                        &#125;                    &#125;); <span class="hljs-comment">// ç»™æˆ‘ä»¬çš„workerGroup çš„ EventLoop å¯¹åº”çš„ç®¡é“è®¾ç½®å¤„ç†å™¨</span>            System.out.println(<span class="hljs-string">&quot;.....æœåŠ¡å™¨ is ready...&quot;</span>);            <span class="hljs-comment">//ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥, ç”Ÿæˆäº†ä¸€ä¸ª ChannelFuture å¯¹è±¡</span>            <span class="hljs-comment">//å¯åŠ¨æœåŠ¡å™¨(å¹¶ç»‘å®šç«¯å£)</span>            ChannelFuture cf = bootstrap.bind(<span class="hljs-number">6668</span>).sync();            <span class="hljs-comment">//ç»™cf æ³¨å†Œç›‘å¬å™¨ï¼Œç›‘æ§æˆ‘ä»¬å…³å¿ƒçš„äº‹ä»¶</span>            cf.addListener(<span class="hljs-keyword">new</span> ChannelFutureListener() &#123;                <span class="hljs-meta">@Override</span>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                    <span class="hljs-keyword">if</span> (cf.isSuccess()) &#123;                        System.out.println(<span class="hljs-string">&quot;ç›‘å¬ç«¯å£ 6668 æˆåŠŸ&quot;</span>);                    &#125; <span class="hljs-keyword">else</span> &#123;                        System.out.println(<span class="hljs-string">&quot;ç›‘å¬ç«¯å£ 6668 å¤±è´¥&quot;</span>);                    &#125;                &#125;            &#125;);            <span class="hljs-comment">//å¯¹å…³é—­é€šé“è¿›è¡Œç›‘å¬</span>            cf.channel().closeFuture().sync();        &#125;<span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;NettyServerHandler.java<span class="hljs-keyword">package</span> com.atguigu.netty.simple;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> io.netty.channel.Channel;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.util.CharsetUtil;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯´æ˜</span><span class="hljs-comment"> * 1. æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªHandler éœ€è¦ç»§ç»­netty è§„å®šå¥½çš„æŸä¸ªHandlerAdapter(è§„èŒƒ)</span><span class="hljs-comment"> * 2. è¿™æ—¶æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªHandler , æ‰èƒ½ç§°ä¸ºä¸€ä¸ªhandler</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="hljs-comment">//è¯»å–æ•°æ®å®é™…(è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯)</span>    <span class="hljs-comment">/**</span><span class="hljs-comment">     * 1. ChannelHandlerContext ctx:ä¸Šä¸‹æ–‡å¯¹è±¡, å«æœ‰ ç®¡é“pipeline , é€šé“channel, åœ°å€</span><span class="hljs-comment">     * 2. Object msg: å°±æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ•°æ® é»˜è®¤Object</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨è¯»å–çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot; channle =&quot;</span> + ctx.channel());        System.out.println(<span class="hljs-string">&quot;server ctx =&quot;</span> + ctx);        System.out.println(<span class="hljs-string">&quot;çœ‹çœ‹channel å’Œ pipelineçš„å…³ç³»&quot;</span>);        Channel channel = ctx.channel();        ChannelPipeline pipeline = ctx.pipeline(); <span class="hljs-comment">//æœ¬è´¨æ˜¯ä¸€ä¸ªåŒå‘é“¾æ¥, å‡ºç«™å…¥ç«™</span>                <span class="hljs-comment">//å°† msg è½¬æˆä¸€ä¸ª ByteBuf</span>        <span class="hljs-comment">//ByteBuf æ˜¯ Netty æä¾›çš„ï¼Œä¸æ˜¯ NIO çš„ ByteBuffer.</span>        ByteBuf buf = (ByteBuf) msg;        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ˜¯:&quot;</span> + buf.toString(CharsetUtil.UTF_8));        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯åœ°å€:&quot;</span> + channel.remoteAddress());    &#125;    <span class="hljs-comment">//æ•°æ®è¯»å–å®Œæ¯•</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//writeAndFlush æ˜¯ write + flush</span>        <span class="hljs-comment">//å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°</span>        <span class="hljs-comment">//ä¸€èˆ¬è®²ï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªå‘é€çš„æ•°æ®è¿›è¡Œç¼–ç </span>        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, å®¢æˆ·ç«¯~(&gt;^Ï‰^&lt;)å–µ1&quot;</span>, CharsetUtil.UTF_8));    &#125;        <span class="hljs-comment">//å¤„ç†å¼‚å¸¸, ä¸€èˆ¬æ˜¯éœ€è¦å…³é—­é€šé“</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ctx.close();    &#125;&#125;NettyClient.java<span class="hljs-keyword">package</span> com.atguigu.netty.simple;<span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyClient</span> </span>&#123;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//å®¢æˆ·ç«¯éœ€è¦ä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„</span>        EventLoopGroup group = <span class="hljs-keyword">new</span> NioEventLoopGroup();        <span class="hljs-keyword">try</span> &#123;                        <span class="hljs-comment">//åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¯¹è±¡</span>            <span class="hljs-comment">//æ³¨æ„å®¢æˆ·ç«¯ä½¿ç”¨çš„ä¸æ˜¯ ServerBootstrap è€Œæ˜¯ Bootstrap</span>            Bootstrap bootstrap = <span class="hljs-keyword">new</span> Bootstrap();            <span class="hljs-comment">//è®¾ç½®ç›¸å…³å‚æ•°</span>            bootstrap.group(group) <span class="hljs-comment">//è®¾ç½®çº¿ç¨‹ç»„</span>                    .channel(NioSocketChannel.class) <span class="hljs-comment">// è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„å®ç°ç±»(åå°„)</span>                    .handler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                        <span class="hljs-meta">@Override</span>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> NettyClientHandler()); <span class="hljs-comment">//åŠ å…¥è‡ªå·±çš„å¤„ç†å™¨</span>                        &#125;                    &#125;);                        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯ ok..&quot;</span>);            <span class="hljs-comment">//å¯åŠ¨å®¢æˆ·ç«¯å»è¿æ¥æœåŠ¡å™¨ç«¯</span>            <span class="hljs-comment">//å…³äº ChannelFuture è¦åˆ†æï¼Œæ¶‰åŠåˆ°nettyçš„å¼‚æ­¥æ¨¡å‹</span>            ChannelFuture channelFuture = bootstrap.connect(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6668</span>).sync();            <span class="hljs-comment">//ç»™å…³é—­é€šé“è¿›è¡Œç›‘å¬</span>            channelFuture.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            group.shutdownGracefully();        &#125;    &#125;&#125;NettyClientHandler.java<span class="hljs-keyword">package</span> com.atguigu.netty.simple;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-keyword">import</span> io.netty.util.CharsetUtil;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;        <span class="hljs-comment">//å½“é€šé“å°±ç»ªå°±ä¼šè§¦å‘è¯¥æ–¹æ³•</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;client &quot;</span> + ctx);        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, server: (&gt;^Ï‰^&lt;)å–µ&quot;</span>, CharsetUtil.UTF_8));    &#125;    <span class="hljs-comment">//å½“é€šé“æœ‰è¯»å–äº‹ä»¶æ—¶ï¼Œä¼šè§¦å‘</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ByteBuf buf = (ByteBuf) msg;        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨å›å¤çš„æ¶ˆæ¯:&quot;</span> + buf.toString(CharsetUtil.UTF_8));        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨çš„åœ°å€ï¼š &quot;</span> + ctx.channel().remoteAddress());    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        cause.printStackTrace();        ctx.close();    &#125;&#125;</code></pre></div><h4 id="5-8-7-ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„-Task-æœ‰-3-ç§å…¸å‹ä½¿ç”¨åœºæ™¯"><a href="#5-8-7-ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„-Task-æœ‰-3-ç§å…¸å‹ä½¿ç”¨åœºæ™¯" class="headerlink" title="5.8.7 ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ Task æœ‰ 3 ç§å…¸å‹ä½¿ç”¨åœºæ™¯"></a>5.8.7 ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ Task æœ‰ 3 ç§å…¸å‹ä½¿ç”¨åœºæ™¯</h4><ol><li>ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡ã€ä¸¾ä¾‹è¯´æ˜ã€‘</li><li>ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡</li><li>éå½“å‰ <code>Reactor</code> çº¿ç¨‹è°ƒç”¨ <code>Channel</code> çš„å„ç§æ–¹æ³• ä¾‹å¦‚åœ¨æ¨é€ç³»ç»Ÿçš„ä¸šåŠ¡çº¿ç¨‹é‡Œé¢ï¼Œæ ¹æ®ç”¨æˆ·çš„æ ‡è¯†ï¼Œæ‰¾åˆ°å¯¹åº”çš„ <code>Channel</code> å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ <code>Write</code> ç±»æ–¹æ³•å‘è¯¥ç”¨æˆ·æ¨é€æ¶ˆæ¯ï¼Œå°±ä¼šè¿›å…¥åˆ°è¿™ç§åœºæ™¯ã€‚æœ€ç»ˆçš„ <code>Write</code> ä¼šæäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­åè¢«å¼‚æ­¥æ¶ˆè´¹</li><li>ä»£ç æ¼”ç¤º</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.simple;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-keyword">import</span> io.netty.util.CharsetUtil;<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯´æ˜</span><span class="hljs-comment"> * 1. æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªHandler éœ€è¦ç»§ç»­netty è§„å®šå¥½çš„æŸä¸ªHandlerAdapter(è§„èŒƒ)</span><span class="hljs-comment"> * 2. è¿™æ—¶æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªHandler , æ‰èƒ½ç§°ä¸ºä¸€ä¸ªhandler</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="hljs-comment">//è¯»å–æ•°æ®å®é™…(è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯)</span>    <span class="hljs-comment">/**</span><span class="hljs-comment">     * 1. ChannelHandlerContext ctx:ä¸Šä¸‹æ–‡å¯¹è±¡, å«æœ‰ ç®¡é“pipeline , é€šé“channel, åœ°å€</span><span class="hljs-comment">     * 2. Object msg: å°±æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ•°æ® é»˜è®¤Object</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">// æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€ä¸ªéå¸¸è€—æ—¶é•¿çš„ä¸šåŠ¡-&gt; å¼‚æ­¥æ‰§è¡Œ -&gt; æäº¤è¯¥channel å¯¹åº”çš„</span>        <span class="hljs-comment">// NIOEventLoop çš„ taskQueueä¸­,</span>        <span class="hljs-comment">// è§£å†³æ–¹æ¡ˆ1 ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡</span>        ctx.channel().eventLoop().execute(<span class="hljs-keyword">new</span> Runnable() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;                <span class="hljs-keyword">try</span> &#123;                    Thread.sleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);                    ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, å®¢æˆ·ç«¯~(&gt;^Ï‰^&lt;)å–µ2&quot;</span>, CharsetUtil.UTF_8));                    System.out.println(<span class="hljs-string">&quot;channel code=&quot;</span> + ctx.channel().hashCode());                &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;                    System.out.println(<span class="hljs-string">&quot;å‘ç”Ÿå¼‚å¸¸&quot;</span> + ex.getMessage());                &#125;            &#125;        &#125;);        ctx.channel().eventLoop().execute(<span class="hljs-keyword">new</span> Runnable() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;                <span class="hljs-keyword">try</span> &#123;                    Thread.sleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);                    ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, å®¢æˆ·ç«¯~(&gt;^Ï‰^&lt;)å–µ3&quot;</span>, CharsetUtil.UTF_8));                    System.out.println(<span class="hljs-string">&quot;channel code=&quot;</span> + ctx.channel().hashCode());                &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;                    System.out.println(<span class="hljs-string">&quot;å‘ç”Ÿå¼‚å¸¸&quot;</span> + ex.getMessage());                &#125;            &#125;        &#125;);        <span class="hljs-comment">//è§£å†³æ–¹æ¡ˆ2 : ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡ -ã€‹ è¯¥ä»»åŠ¡æ˜¯æäº¤åˆ° scheduleTaskQueueä¸­</span>        ctx.channel().eventLoop().schedule(<span class="hljs-keyword">new</span> Runnable() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;                <span class="hljs-keyword">try</span> &#123;                    Thread.sleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);                    ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, å®¢æˆ·ç«¯~(&gt;^Ï‰^&lt;)å–µ4&quot;</span>, CharsetUtil.UTF_8));                    System.out.println(<span class="hljs-string">&quot;channel code=&quot;</span> + ctx.channel().hashCode());                &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;                    System.out.println(<span class="hljs-string">&quot;å‘ç”Ÿå¼‚å¸¸&quot;</span> + ex.getMessage());                &#125;            &#125;        &#125;, <span class="hljs-number">5</span>, TimeUnit.SECONDS);        System.out.println(<span class="hljs-string">&quot;go on ...&quot;</span>);<span class="hljs-comment">//        System.out.println(&quot;æœåŠ¡å™¨è¯»å–çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot; channle =&quot; + ctx.channel());</span><span class="hljs-comment">//        System.out.println(&quot;server ctx =&quot; + ctx);</span><span class="hljs-comment">//        System.out.println(&quot;çœ‹çœ‹channel å’Œ pipelineçš„å…³ç³»&quot;);</span><span class="hljs-comment">//        Channel channel = ctx.channel();</span><span class="hljs-comment">//        ChannelPipeline pipeline = ctx.pipeline(); //æœ¬è´¨æ˜¯ä¸€ä¸ªåŒå‘é“¾æ¥, å‡ºç«™å…¥ç«™</span><span class="hljs-comment">//        </span><span class="hljs-comment">//        //å°† msg è½¬æˆä¸€ä¸ª ByteBuf</span><span class="hljs-comment">//        //ByteBuf æ˜¯ Netty æä¾›çš„ï¼Œä¸æ˜¯ NIO çš„ ByteBuffer.</span><span class="hljs-comment">//        ByteBuf buf = (ByteBuf) msg;</span><span class="hljs-comment">//        System.out.println(&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ˜¯:&quot; + buf.toString(CharsetUtil.UTF_8));</span><span class="hljs-comment">//        System.out.println(&quot;å®¢æˆ·ç«¯åœ°å€:&quot; + channel.remoteAddress());</span>    &#125;    <span class="hljs-comment">//æ•°æ®è¯»å–å®Œæ¯•</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//writeAndFlush æ˜¯ write + flush</span>        <span class="hljs-comment">//å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°</span>        <span class="hljs-comment">//ä¸€èˆ¬è®²ï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªå‘é€çš„æ•°æ®è¿›è¡Œç¼–ç </span>        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, å®¢æˆ·ç«¯~(&gt;^Ï‰^&lt;)å–µ1&quot;</span>, CharsetUtil.UTF_8));    &#125;    <span class="hljs-comment">//å¤„ç†å¼‚å¸¸, ä¸€èˆ¬æ˜¯éœ€è¦å…³é—­é€šé“</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ctx.close();    &#125;&#125;</code></pre></div><h4 id="5-8-8-æ–¹æ¡ˆå†è¯´æ˜"><a href="#5-8-8-æ–¹æ¡ˆå†è¯´æ˜" class="headerlink" title="5.8.8 æ–¹æ¡ˆå†è¯´æ˜"></a>5.8.8 æ–¹æ¡ˆå†è¯´æ˜</h4><ol><li><code>Netty</code> æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± ï¼Œ<code>BossGroup</code> ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œ<code>WorkerGroup</code> ä¸“é—¨è´Ÿè´£ç½‘ç»œè¯»å†™æ“ä½œã€‚</li><li><code>NioEventLoop</code> è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª <code>NioEventLoop</code> éƒ½æœ‰ä¸€ä¸ª <code>Selector</code>ï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ <code>socket</code>ç½‘ç»œé€šé“ã€‚</li><li><code>NioEventLoop</code> å†…éƒ¨é‡‡ç”¨ä¸²è¡ŒåŒ–è®¾è®¡ï¼Œä»æ¶ˆæ¯çš„ <strong>è¯»å–-&gt;è§£ç -&gt;å¤„ç†-&gt;ç¼–ç -&gt;å‘é€</strong>ï¼Œå§‹ç»ˆç”± <code>IO</code> çº¿ç¨‹ <code>NioEventLoop</code> è´Ÿè´£<code>NioEventLoopGroup</code>ä¸‹åŒ…å«å¤šä¸ª <code>NioEventLoop</code></li></ol><ul><li>æ¯ä¸ª <code>NioEventLoop</code> ä¸­åŒ…å«æœ‰ä¸€ä¸ª <code>Selector</code>ï¼Œä¸€ä¸ª <code>taskQueue</code></li><li>æ¯ä¸ª <code>NioEventLoop</code> çš„ <code>Selector</code> ä¸Šå¯ä»¥æ³¨å†Œç›‘å¬å¤šä¸ª <code>NioChannel</code></li><li>æ¯ä¸ª <code>NioChannel</code> åªä¼šç»‘å®šåœ¨å”¯ä¸€çš„ <code>NioEventLoop</code> ä¸Š</li><li>æ¯ä¸ª <code>NioChannel</code> éƒ½ç»‘å®šæœ‰ä¸€ä¸ªè‡ªå·±çš„ <code>ChannelPipeline</code></li></ul><h3 id="5-9-å¼‚æ­¥æ¨¡å‹"><a href="#5-9-å¼‚æ­¥æ¨¡å‹" class="headerlink" title="5.9 å¼‚æ­¥æ¨¡å‹"></a>5.9 å¼‚æ­¥æ¨¡å‹</h3><h4 id="5-9-1-åŸºæœ¬ä»‹ç»"><a href="#5-9-1-åŸºæœ¬ä»‹ç»" class="headerlink" title="5.9.1 åŸºæœ¬ä»‹ç»"></a>5.9.1 åŸºæœ¬ä»‹ç»</h4><ol><li>å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„ç»„ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…ã€‚</li><li><code>Netty</code> ä¸­çš„ <code>I/O</code> æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼ŒåŒ…æ‹¬ <code>Bindã€Writeã€Connect</code> ç­‰æ“ä½œä¼šç®€å•çš„è¿”å›ä¸€ä¸ª <code>ChannelFuture</code>ã€‚</li><li>è°ƒç”¨è€…å¹¶ä¸èƒ½ç«‹åˆ»è·å¾—ç»“æœï¼Œè€Œæ˜¯é€šè¿‡ <code>Future-Listener</code> æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾— <code>IO</code> æ“ä½œç»“æœã€‚</li><li><code>Netty</code> çš„å¼‚æ­¥æ¨¡å‹æ˜¯å»ºç«‹åœ¨ <code>future</code> å’Œ <code>callback</code> çš„ä¹‹ä¸Šçš„ã€‚<code>callback</code> å°±æ˜¯å›è°ƒã€‚é‡ç‚¹è¯´ <code>Future</code>ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå‡è®¾ä¸€ä¸ªæ–¹æ³• <code>fun</code>ï¼Œè®¡ç®—è¿‡ç¨‹å¯èƒ½éå¸¸è€—æ—¶ï¼Œç­‰å¾… <code>fun</code> è¿”å›æ˜¾ç„¶ä¸åˆé€‚ã€‚é‚£ä¹ˆå¯ä»¥åœ¨è°ƒç”¨ <code>fun</code> çš„æ—¶å€™ï¼Œç«‹é©¬è¿”å›ä¸€ä¸ª <code>Future</code>ï¼Œåç»­å¯ä»¥é€šè¿‡ <code>Future</code> å»ç›‘æ§æ–¹æ³• <code>fun</code> çš„å¤„ç†è¿‡ç¨‹ï¼ˆå³ï¼š<code>Future-Listener</code> æœºåˆ¶ï¼‰</li></ol><h4 id="5-9-2-Future-è¯´æ˜"><a href="#5-9-2-Future-è¯´æ˜" class="headerlink" title="5.9.2 Future è¯´æ˜"></a>5.9.2 Future è¯´æ˜</h4><ol><li>è¡¨ç¤ºå¼‚æ­¥çš„æ‰§è¡Œç»“æœ,å¯ä»¥é€šè¿‡å®ƒæä¾›çš„æ–¹æ³•æ¥æ£€æµ‹æ‰§è¡Œæ˜¯å¦å®Œæˆï¼Œæ¯”å¦‚æ£€ç´¢è®¡ç®—ç­‰ç­‰ã€‚</li><li><code>ChannelFuture</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼š<code>public interface ChannelFuture extends Future&lt;Void&gt;</code> æˆ‘ä»¬å¯ä»¥æ·»åŠ ç›‘å¬å™¨ï¼Œå½“ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šé€šçŸ¥åˆ°ç›‘å¬å™¨ã€‚æ¡ˆä¾‹è¯´æ˜</li></ol><h4 id="5-9-3-å·¥ä½œåŸç†ç¤ºæ„å›¾"><a href="#5-9-3-å·¥ä½œåŸç†ç¤ºæ„å›¾" class="headerlink" title="5.9.3 å·¥ä½œåŸç†ç¤ºæ„å›¾"></a>5.9.3 å·¥ä½œåŸç†ç¤ºæ„å›¾</h4><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_11.png" alt="img"></p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_12.png" alt="img"></p><p>è¯´æ˜ï¼š</p><ol><li>åœ¨ä½¿ç”¨ <code>Netty</code> è¿›è¡Œç¼–ç¨‹æ—¶ï¼Œæ‹¦æˆªæ“ä½œå’Œè½¬æ¢å‡ºå…¥ç«™æ•°æ®åªéœ€è¦æ‚¨æä¾› <code>callback</code> æˆ–åˆ©ç”¨ <code>future</code> å³å¯ã€‚è¿™ä½¿å¾—é“¾å¼æ“ä½œç®€å•ã€é«˜æ•ˆï¼Œå¹¶æœ‰åˆ©äºç¼–å†™å¯é‡ç”¨çš„ã€é€šç”¨çš„ä»£ç ã€‚</li><li><code>Netty</code> æ¡†æ¶çš„ç›®æ ‡å°±æ˜¯è®©ä½ çš„ä¸šåŠ¡é€»è¾‘ä»ç½‘ç»œåŸºç¡€åº”ç”¨ç¼–ç ä¸­åˆ†ç¦»å‡ºæ¥ã€è§£è„±å‡ºæ¥ã€‚</li></ol><h4 id="5-9-4-Future-Listener-æœºåˆ¶"><a href="#5-9-4-Future-Listener-æœºåˆ¶" class="headerlink" title="5.9.4 Future-Listener æœºåˆ¶"></a>5.9.4 Future-Listener æœºåˆ¶</h4><ol><li>å½“ <code>Future</code> å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶ï¼Œå¤„äºéå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„ <code>ChannelFuture</code> æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ä½œã€‚</li><li>å¸¸è§æœ‰å¦‚ä¸‹æ“ä½œ<ul><li>é€šè¿‡ <code>isDone</code> æ–¹æ³•æ¥åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å®Œæˆï¼›</li><li>é€šè¿‡ <code>isSuccess</code> æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸï¼›</li><li>é€šè¿‡ <code>getCause</code> æ–¹æ³•æ¥è·å–å·²å®Œæˆçš„å½“å‰æ“ä½œå¤±è´¥çš„åŸå› ï¼›</li><li>é€šè¿‡ <code>isCancelled</code> æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆï¼›</li><li>é€šè¿‡ <code>addListener</code> æ–¹æ³•æ¥æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆï¼ˆ<code>isDone</code>æ–¹æ³•è¿”å›å®Œæˆï¼‰ï¼Œå°†ä¼šé€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ï¼›å¦‚æœ <code>Future</code> å¯¹è±¡å·²å®Œæˆï¼Œåˆ™é€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨</li></ul></li></ol><p>ä¸¾ä¾‹è¯´æ˜ æ¼”ç¤ºï¼šç»‘å®šç«¯å£æ˜¯å¼‚æ­¥æ“ä½œï¼Œå½“ç»‘å®šæ“ä½œå¤„ç†å®Œï¼Œå°†ä¼šè°ƒç”¨ç›¸åº”çš„ç›‘å¬å™¨å¤„ç†é€»è¾‘</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥,ç”Ÿæˆäº†ä¸€ä¸ªChannelFutureå¯¹è±¡</span><span class="hljs-comment">//å¯åŠ¨æœåŠ¡å™¨(å¹¶ç»‘å®šç«¯å£)</span>ChannelFuture cf = bootstrap.bind(<span class="hljs-number">6668</span>).sync();<span class="hljs-comment">//ç»™cf æ³¨å†Œç›‘å¬å™¨ï¼Œç›‘æ§æˆ‘ä»¬å…³å¿ƒçš„äº‹ä»¶</span>cf.addListener((ChannelFutureListener) future -&gt; &#123;    <span class="hljs-keyword">if</span> (cf.isSuccess()) &#123;        System.out.println(<span class="hljs-string">&quot;ç›‘å¬ç«¯å£ 6668 æˆåŠŸ&quot;</span>);    &#125; <span class="hljs-keyword">else</span> &#123;        System.out.println(<span class="hljs-string">&quot;ç›‘å¬ç«¯å£ 6668 å¤±è´¥&quot;</span>);    &#125;&#125;);</code></pre></div><h3 id="5-10-å¿«é€Ÿå…¥é—¨å®ä¾‹-HTTPæœåŠ¡"><a href="#5-10-å¿«é€Ÿå…¥é—¨å®ä¾‹-HTTPæœåŠ¡" class="headerlink" title="5.10 å¿«é€Ÿå…¥é—¨å®ä¾‹ - HTTPæœåŠ¡"></a>5.10 å¿«é€Ÿå…¥é—¨å®ä¾‹ - HTTPæœåŠ¡</h3><ol><li>å®ä¾‹è¦æ±‚ï¼šä½¿ç”¨ <code>IDEA</code> åˆ›å»º <code>Netty</code> é¡¹ç›®</li><li><code>Netty</code> æœåŠ¡å™¨åœ¨ <code>6668</code> ç«¯å£ç›‘å¬ï¼Œæµè§ˆå™¨å‘å‡ºè¯·æ±‚ <code>http://localhost:6668/</code></li><li>æœåŠ¡å™¨å¯ä»¥å›å¤æ¶ˆæ¯ç»™å®¢æˆ·ç«¯â€Hello!æˆ‘æ˜¯æœåŠ¡å™¨5â€,å¹¶å¯¹ç‰¹å®šè¯·æ±‚èµ„æºè¿›è¡Œè¿‡æ»¤ã€‚</li><li>ç›®çš„ï¼š<code>Netty</code> å¯ä»¥åš <code>Http</code> æœåŠ¡å¼€å‘ï¼Œå¹¶ä¸”ç†è§£ <code>Handler</code> å®ä¾‹å’Œå®¢æˆ·ç«¯åŠå…¶è¯·æ±‚çš„å…³ç³»ã€‚</li><li>çœ‹è€å¸ˆä»£ç æ¼”ç¤º</li></ol><div class="code-wrapper"><pre><code class="hljs java">TestServer.java<span class="hljs-keyword">package</span> com.atguigu.netty.http;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestServer</span> </span>&#123;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();            serverBootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class).childHandler(<span class="hljs-keyword">new</span> TestServerInitializer());            ChannelFuture channelFuture = serverBootstrap.bind(<span class="hljs-number">6668</span>).sync();            channelFuture.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;TestServerInitializer.java<span class="hljs-keyword">package</span> com.atguigu.netty.http;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInitializer</span>&lt;<span class="hljs-title">SocketChannel</span>&gt; </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//å‘ç®¡é“åŠ å…¥å¤„ç†å™¨</span>        <span class="hljs-comment">//å¾—åˆ°ç®¡é“</span>        ChannelPipeline pipeline = ch.pipeline();        <span class="hljs-comment">//åŠ å…¥ä¸€ä¸ªnetty æä¾›çš„httpServerCodec codec =&gt;[coder - decoder]</span>        <span class="hljs-comment">//HttpServerCodec è¯´æ˜</span>        <span class="hljs-comment">//1. HttpServerCodec æ˜¯netty æä¾›çš„å¤„ç†httpçš„ ç¼–-è§£ç å™¨</span>        pipeline.addLast(<span class="hljs-string">&quot;MyHttpServerCodec&quot;</span>, <span class="hljs-keyword">new</span> HttpServerCodec());        <span class="hljs-comment">//2. å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„handler</span>        pipeline.addLast(<span class="hljs-string">&quot;MyTestHttpServerHandler&quot;</span>, <span class="hljs-keyword">new</span> TestHttpServerHandler());        System.out.println(<span class="hljs-string">&quot;ok~~~~&quot;</span>);    &#125;&#125;TestHttpServerHandler.java<span class="hljs-keyword">package</span> com.atguigu.netty.http;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> io.netty.handler.codec.http.*;<span class="hljs-keyword">import</span> io.netty.util.CharsetUtil;<span class="hljs-keyword">import</span> java.net.URI;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯´æ˜</span><span class="hljs-comment"> * 1. SimpleChannelInboundHandler æ˜¯ ChannelInboundHandlerAdapter</span><span class="hljs-comment"> * 2. HttpObject å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ç›¸äº’é€šè®¯çš„æ•°æ®è¢«å°è£…æˆ HttpObject</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestHttpServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">HttpObject</span>&gt; </span>&#123;    <span class="hljs-comment">//channelRead0 è¯»å–å®¢æˆ·ç«¯æ•°æ®</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, HttpObject msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;å¯¹åº”çš„channel=&quot;</span> + ctx.channel() + <span class="hljs-string">&quot; pipeline=&quot;</span> + ctx                .pipeline() + <span class="hljs-string">&quot; é€šè¿‡pipelineè·å–channel&quot;</span> + ctx.pipeline().channel());        System.out.println(<span class="hljs-string">&quot;å½“å‰ctxçš„handler=&quot;</span> + ctx.handler());        <span class="hljs-comment">//åˆ¤æ–­ msg æ˜¯ä¸æ˜¯ httprequestè¯·æ±‚</span>        <span class="hljs-keyword">if</span> (msg <span class="hljs-keyword">instanceof</span> HttpRequest) &#123;            System.out.println(<span class="hljs-string">&quot;ctx ç±»å‹=&quot;</span> + ctx.getClass());            System.out.println(<span class="hljs-string">&quot;pipeline hashcode&quot;</span> + ctx.pipeline().hashCode() + <span class="hljs-string">&quot; TestHttpServerHandler hash=&quot;</span> + <span class="hljs-keyword">this</span>.hashCode());            System.out.println(<span class="hljs-string">&quot;msg ç±»å‹=&quot;</span> + msg.getClass());            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯åœ°å€&quot;</span> + ctx.channel().remoteAddress());            <span class="hljs-comment">//è·å–åˆ°</span>            HttpRequest httpRequest = (HttpRequest) msg;            <span class="hljs-comment">//è·å–uri, è¿‡æ»¤æŒ‡å®šçš„èµ„æº</span>            URI uri = <span class="hljs-keyword">new</span> URI(httpRequest.uri());            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/favicon.ico&quot;</span>.equals(uri.getPath())) &#123;                System.out.println(<span class="hljs-string">&quot;è¯·æ±‚äº† favicon.ico, ä¸åšå“åº”&quot;</span>);                <span class="hljs-keyword">return</span>;            &#125;            <span class="hljs-comment">//å›å¤ä¿¡æ¯ç»™æµè§ˆå™¨ [httpåè®®]</span>            ByteBuf content = Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello, æˆ‘æ˜¯æœåŠ¡å™¨&quot;</span>, CharsetUtil.UTF_8);            <span class="hljs-comment">//æ„é€ ä¸€ä¸ªhttpçš„ç›¸åº”ï¼Œå³ httpresponse</span>            FullHttpResponse response = <span class="hljs-keyword">new</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK, content);            response.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="hljs-string">&quot;text/plain&quot;</span>);            response.headers().set(HttpHeaderNames.CONTENT_LENGTH, content.readableBytes());            <span class="hljs-comment">//å°†æ„å»ºå¥½ responseè¿”å›</span>            ctx.writeAndFlush(response);        &#125;    &#125;&#125;</code></pre></div><h2 id="6-Netty-æ ¸å¿ƒæ¨¡å—ç»„ä»¶"><a href="#6-Netty-æ ¸å¿ƒæ¨¡å—ç»„ä»¶" class="headerlink" title="6 Netty æ ¸å¿ƒæ¨¡å—ç»„ä»¶"></a>6 Netty æ ¸å¿ƒæ¨¡å—ç»„ä»¶</h2><h3 id="6-1-Bootstrapã€ServerBootstrap"><a href="#6-1-Bootstrapã€ServerBootstrap" class="headerlink" title="6.1 Bootstrapã€ServerBootstrap"></a>6.1 Bootstrapã€ServerBootstrap</h3><ol><li><code>Bootstrap</code> æ„æ€æ˜¯å¼•å¯¼ï¼Œä¸€ä¸ª <code>Netty</code> åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª <code>Bootstrap</code> å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª <code>Netty</code> ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼Œ<code>Netty</code> ä¸­ <code>Bootstrap</code> ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼Œ<code>ServerBootstrap</code> æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»ã€‚</li><li>å¸¸è§çš„æ–¹æ³•æœ‰<ul><li><code>public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup)</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸¤ä¸ª <code>EventLoop</code></li><li><code>public B group(EventLoopGroup group)</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ª <code>EventLoop</code></li><li><code>public B channel(Class&lt;? extends C&gt; channelClass)</code>ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„é€šé“å®ç°</li><li><code>public &lt;T&gt; B option(ChannelOption&lt;T&gt; option, T value)</code>ï¼Œç”¨æ¥ç»™ <code>ServerChannel</code> æ·»åŠ é…ç½®</li><li><code>public &lt;T&gt; ServerBootstrap childOption(ChannelOption&lt;T&gt; childOption, T value)</code>ï¼Œç”¨æ¥ç»™æ¥æ”¶åˆ°çš„é€šé“æ·»åŠ é…ç½®</li><li><code>public ServerBootstrap childHandler(ChannelHandler childHandler)</code>ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸šåŠ¡å¤„ç†ç±»ï¼ˆè‡ªå®šä¹‰çš„<code>handler</code>ï¼‰</li><li><code>public ChannelFuture bind(int inetPort)</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®å ç”¨çš„ç«¯å£å·</li><li><code>public ChannelFuture connect(String inetHost, int inetPort)</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è¿æ¥æœåŠ¡å™¨ç«¯</li></ul></li></ol><h3 id="6-2-Futureã€ChannelFuture"><a href="#6-2-Futureã€ChannelFuture" class="headerlink" title="6.2 Futureã€ChannelFuture"></a>6.2 Futureã€ChannelFuture</h3><p><code>Netty</code> ä¸­æ‰€æœ‰çš„ <code>IO</code> æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ <code>Future</code> å’Œ <code>ChannelFutures</code>ï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶</p><p>å¸¸è§çš„æ–¹æ³•æœ‰</p><ul><li><code>Channel channel()</code>ï¼Œè¿”å›å½“å‰æ­£åœ¨è¿›è¡Œ <code>IO</code> æ“ä½œçš„é€šé“</li><li><code>ChannelFuture sync()</code>ï¼Œç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•</li></ul><h3 id="6-3-Channel"><a href="#6-3-Channel" class="headerlink" title="6.3 Channel"></a>6.3 Channel</h3><ol><li><p><code>Netty</code> ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ <code>I/O</code> æ“ä½œã€‚</p></li><li><p>é€šè¿‡ <code>Channel</code> å¯è·å¾—å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€</p></li><li><p>é€šè¿‡ <code>Channel</code> å¯è·å¾—ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•°ï¼ˆä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼‰</p></li><li><p><code>Channel</code> æä¾›å¼‚æ­¥çš„ç½‘ç»œ <code>I/O</code> æ“ä½œ(å¦‚å»ºç«‹è¿æ¥ï¼Œè¯»å†™ï¼Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• <code>I/O</code> è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ <code>I/O</code> æ“ä½œå·²å®Œæˆ</p></li><li><p>è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª <code>ChannelFuture</code> å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° <code>ChannelFuture</code> ä¸Šï¼Œå¯ä»¥ <code>I/O</code> æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹</p></li><li><p>æ”¯æŒå…³è” <code>I/O</code> æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åº</p></li><li><p>ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ <code>Channel</code>ç±»å‹ä¸ä¹‹å¯¹åº”ï¼Œå¸¸ç”¨çš„<code>Channel</code>ç±»å‹ï¼š</p><ul><li><code>NioSocketChannel</code>ï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ <code>TCP</code> <code>Socket</code> è¿æ¥ã€‚</li><li><code>NioServerSocketChannel</code>ï¼Œå¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ <code>TCP</code> <code>Socket</code> è¿æ¥ã€‚</li><li><code>NioDatagramChannel</code>ï¼Œå¼‚æ­¥çš„ <code>UDP</code> è¿æ¥ã€‚</li><li><code>NioSctpChannel</code>ï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ <code>Sctp</code> è¿æ¥ã€‚</li><li><code>NioSctpServerChannel</code>ï¼Œå¼‚æ­¥çš„ <code>Sctp</code> æœåŠ¡å™¨ç«¯è¿æ¥ï¼Œè¿™äº›é€šé“æ¶µç›–äº† <code>UDP</code> å’Œ <code>TCP</code> ç½‘ç»œ <code>IO</code> ä»¥åŠæ–‡ä»¶ <code>IO</code>ã€‚</li></ul></li></ol><h3 id="6-4-Selector"><a href="#6-4-Selector" class="headerlink" title="6.4 Selector"></a>6.4 Selector</h3><ol><li><code>Netty</code> åŸºäº <code>Selector</code> å¯¹è±¡å®ç° <code>I/O</code> å¤šè·¯å¤ç”¨ï¼Œé€šè¿‡ <code>Selector</code> ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ <code>Channel</code> äº‹ä»¶ã€‚</li><li>å½“å‘ä¸€ä¸ª <code>Selector</code> ä¸­æ³¨å†Œ <code>Channel</code> åï¼Œ<code>Selector</code> å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢ï¼ˆ<code>Select</code>ï¼‰è¿™äº›æ³¨å†Œçš„ <code>Channel</code> æ˜¯å¦æœ‰å·²å°±ç»ªçš„ <code>I/O</code> äº‹ä»¶ï¼ˆä¾‹å¦‚å¯è¯»ï¼Œå¯å†™ï¼Œç½‘ç»œè¿æ¥å®Œæˆç­‰ï¼‰ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª <code>Channel</code></li></ol><h3 id="6-5-ChannelHandler-åŠå…¶å®ç°ç±»"><a href="#6-5-ChannelHandler-åŠå…¶å®ç°ç±»" class="headerlink" title="6.5 ChannelHandler åŠå…¶å®ç°ç±»"></a>6.5 ChannelHandler åŠå…¶å®ç°ç±»</h3><ol><li><code>ChannelHandler</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç† <code>I/O</code> äº‹ä»¶æˆ–æ‹¦æˆª <code>I/O</code> æ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ <code>ChannelPipeline</code>ï¼ˆä¸šåŠ¡å¤„ç†é“¾ï¼‰ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚</li><li><code>ChannelHandler</code> æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£æœ‰è®¸å¤šçš„æ–¹æ³•éœ€è¦å®ç°ï¼Œæ–¹ä¾¿ä½¿ç”¨æœŸé—´ï¼Œå¯ä»¥ç»§æ‰¿å®ƒçš„å­ç±»</li><li><code>ChannelHandler</code> åŠå…¶å®ç°ç±»ä¸€è§ˆå›¾ï¼ˆåï¼‰</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_01.png" alt="img"></p><ol><li>æˆ‘ä»¬ç»å¸¸éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª <code>Handler</code> ç±»å»ç»§æ‰¿ <code>ChannelInboundHandlerAdapter</code>ï¼Œç„¶åé€šè¿‡é‡å†™ç›¸åº”æ–¹æ³•å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ä¸€èˆ¬éƒ½éœ€è¦é‡å†™å“ªäº›æ–¹æ³•</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_02.png" alt="img"></p><h3 id="6-6-Pipeline-å’Œ-ChannelPipelin"><a href="#6-6-Pipeline-å’Œ-ChannelPipelin" class="headerlink" title="6.6 Pipeline å’Œ ChannelPipelin"></a>6.6 Pipeline å’Œ ChannelPipelin</h3><p><code>ChannelPipeline</code> æ˜¯ä¸€ä¸ªé‡ç‚¹ï¼š</p><ol><li><code>ChannelPipeline</code> æ˜¯ä¸€ä¸ª <code>Handler</code> çš„é›†åˆï¼Œå®ƒè´Ÿè´£å¤„ç†å’Œæ‹¦æˆª <code>inbound</code> æˆ–è€… <code>outbound</code> çš„äº‹ä»¶å’Œæ“ä½œï¼Œç›¸å½“äºä¸€ä¸ªè´¯ç©¿ <code>Netty</code> çš„é“¾ã€‚ï¼ˆä¹Ÿå¯ä»¥è¿™æ ·ç†è§£ï¼š<code>ChannelPipeline</code> æ˜¯ä¿å­˜ <code>ChannelHandler</code> çš„ <code>List</code>ï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª <code>Channel</code> çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œï¼‰</li><li><code>ChannelPipeline</code> å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ <code>Channel</code> ä¸­å„ä¸ªçš„ <code>ChannelHandler</code> å¦‚ä½•ç›¸äº’äº¤äº’</li><li>åœ¨ <code>Netty</code> ä¸­æ¯ä¸ª <code>Channel</code> éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª <code>ChannelPipeline</code> ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_03.png" alt="img"></p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_04.png" alt="img"></p><ol><li>å¸¸ç”¨æ–¹æ³• <code>ChannelPipeline addFirst(ChannelHandler... handlers)</code>ï¼ŒæŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆ<code>handler</code>ï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®<code>ChannelPipeline addLast(ChannelHandler... handlers)</code>ï¼ŒæŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆ<code>handler</code>ï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„æœ€åä¸€ä¸ªä½ç½®</li></ol><h3 id="6-7-ChannelHandlerContext"><a href="#6-7-ChannelHandlerContext" class="headerlink" title="6.7 ChannelHandlerContext"></a>6.7 ChannelHandlerContext</h3><ol><li>ä¿å­˜ <code>Channel</code> ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ª <code>ChannelHandler</code> å¯¹è±¡</li><li>å³ <code>ChannelHandlerContext</code> ä¸­åŒ…å«ä¸€ä¸ªå…·ä½“çš„äº‹ä»¶å¤„ç†å™¨ <code>ChannelHandler</code>ï¼ŒåŒæ—¶ <code>ChannelHandlerContext</code> ä¸­ä¹Ÿç»‘å®šäº†å¯¹åº”çš„ <code>pipeline</code> å’Œ <code>Channel</code> çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿å¯¹ <code>ChannelHandler</code> è¿›è¡Œè°ƒç”¨ã€‚</li><li>å¸¸ç”¨æ–¹æ³•<ul><li><code>ChannelFuture close()</code>ï¼Œå…³é—­é€šé“</li><li><code>ChannelOutboundInvoker flush()</code>ï¼Œåˆ·æ–°</li><li><code>ChannelFuture writeAndFlush(Object msg)</code>ï¼Œå°†æ•°æ®å†™åˆ°</li><li><code>ChannelPipeline</code> ä¸­å½“å‰ <code>ChannelHandler</code> çš„ä¸‹ä¸€ä¸ª <code>ChannelHandler</code> å¼€å§‹å¤„ç†ï¼ˆå‡ºç«™ï¼‰</li></ul></li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_05.png" alt="img"></p><h3 id="6-8-ChannelOption"><a href="#6-8-ChannelOption" class="headerlink" title="6.8 ChannelOption"></a>6.8 ChannelOption</h3><ol><li><code>Netty</code> åœ¨åˆ›å»º <code>Channel</code> å®ä¾‹åï¼Œä¸€èˆ¬éƒ½éœ€è¦è®¾ç½® <code>ChannelOption</code> å‚æ•°ã€‚</li><li><code>ChannelOption</code> å‚æ•°å¦‚ä¸‹ï¼š</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_06.png" alt="img"></p><h3 id="6-9-EventLoopGroup-å’Œå…¶å®ç°ç±»-NioEventLoopGroup"><a href="#6-9-EventLoopGroup-å’Œå…¶å®ç°ç±»-NioEventLoopGroup" class="headerlink" title="6.9 EventLoopGroup å’Œå…¶å®ç°ç±» NioEventLoopGroup"></a>6.9 EventLoopGroup å’Œå…¶å®ç°ç±» NioEventLoopGroup</h3><ol><li><code>EventLoopGroup</code> æ˜¯ä¸€ç»„ <code>EventLoop</code> çš„æŠ½è±¡ï¼Œ<code>Netty</code> ä¸ºäº†æ›´å¥½çš„åˆ©ç”¨å¤šæ ¸ <code>CPU</code> èµ„æºï¼Œä¸€èˆ¬ä¼šæœ‰å¤šä¸ª <code>EventLoop</code> åŒæ—¶å·¥ä½œï¼Œæ¯ä¸ª <code>EventLoop</code> ç»´æŠ¤ç€ä¸€ä¸ª <code>Selector</code> å®ä¾‹ã€‚</li><li><code>EventLoopGroup</code> æä¾› <code>next</code> æ¥å£ï¼Œå¯ä»¥ä»ç»„é‡Œé¢æŒ‰ç…§ä¸€å®šè§„åˆ™è·å–å…¶ä¸­ä¸€ä¸ª <code>EventLoop</code> æ¥å¤„ç†ä»»åŠ¡ã€‚åœ¨ <code>Netty</code> æœåŠ¡å™¨ç«¯ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½éœ€è¦æä¾›ä¸¤ä¸ª <code>EventLoopGroup</code>ï¼Œä¾‹å¦‚ï¼š<code>BossEventLoopGroup</code> å’Œ <code>WorkerEventLoopGroup</code>ã€‚</li><li>é€šå¸¸ä¸€ä¸ªæœåŠ¡ç«¯å£å³ä¸€ä¸ª <code>ServerSocketChannel</code> å¯¹åº”ä¸€ä¸ª <code>Selector</code> å’Œä¸€ä¸ª <code>EventLoop</code> çº¿ç¨‹ã€‚<code>BossEventLoop</code> è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥å¹¶å°† <code>SocketChannel</code> äº¤ç»™ <code>WorkerEventLoopGroup</code> æ¥è¿›è¡Œ <code>IO</code> å¤„ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_07.png" alt="img"></p><ol><li>å¸¸ç”¨æ–¹æ³• <code>public NioEventLoopGroup()</code>ï¼Œæ„é€ æ–¹æ³• <code>public Future&lt;?&gt; shutdownGracefully()</code>ï¼Œæ–­å¼€è¿æ¥ï¼Œå…³é—­çº¿ç¨‹</li></ol><h3 id="6-10-Unpooled-ç±»"><a href="#6-10-Unpooled-ç±»" class="headerlink" title="6.10 Unpooled ç±»"></a>6.10 Unpooled ç±»</h3><ol><li><code>Netty</code> æä¾›ä¸€ä¸ªä¸“é—¨ç”¨æ¥æ“ä½œç¼“å†²åŒºï¼ˆå³ <code>Netty</code> çš„æ•°æ®å®¹å™¨ï¼‰çš„å·¥å…·ç±»</li><li>å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤º</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_08.png" alt="img"></p><ol><li>ä¸¾ä¾‹è¯´æ˜ <code>Unpooled</code> è·å– <code>Netty</code> çš„æ•°æ®å®¹å™¨ <code>ByteBuf</code> çš„åŸºæœ¬ä½¿ç”¨ã€æ¡ˆä¾‹æ¼”ç¤ºã€‘</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_09.png" alt="img"></p><p>æ¡ˆä¾‹ 1</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.buf;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyByteBuf01</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;                <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªByteBuf</span>        <span class="hljs-comment">//è¯´æ˜</span>        <span class="hljs-comment">//1. åˆ›å»º å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«ä¸€ä¸ªæ•°ç»„arr , æ˜¯ä¸€ä¸ªbyte[10]</span>        <span class="hljs-comment">//2. åœ¨netty çš„bufferä¸­ï¼Œä¸éœ€è¦ä½¿ç”¨flip è¿›è¡Œåè½¬</span>        <span class="hljs-comment">//   åº•å±‚ç»´æŠ¤äº† readerindex å’Œ writerIndex</span>        <span class="hljs-comment">//3. é€šè¿‡ readerindex å’Œ  writerIndex å’Œ  capacityï¼Œ å°†bufferåˆ†æˆä¸‰ä¸ªåŒºåŸŸ</span>        <span class="hljs-comment">// 0---readerindex å·²ç»è¯»å–çš„åŒºåŸŸ</span>        <span class="hljs-comment">// readerindex---writerIndex ï¼Œ å¯è¯»çš„åŒºåŸŸ</span>        <span class="hljs-comment">// writerIndex -- capacity, å¯å†™çš„åŒºåŸŸ</span>        ByteBuf buffer = Unpooled.buffer(<span class="hljs-number">10</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;            buffer.writeByte(i);        &#125;        System.out.println(<span class="hljs-string">&quot;capacity=&quot;</span> + buffer.capacity());<span class="hljs-comment">//10</span>        <span class="hljs-comment">//è¾“å‡º</span><span class="hljs-comment">//        for(int i = 0; i&lt;buffer.capacity(); i++) &#123;</span><span class="hljs-comment">//            System.out.println(buffer.getByte(i));</span><span class="hljs-comment">//        &#125;</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; buffer.capacity(); i++) &#123;            System.out.println(buffer.readByte());        &#125;        System.out.println(<span class="hljs-string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);    &#125;&#125;</code></pre></div><p>æ¡ˆä¾‹ 2</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.buf;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyByteBuf02</span> </span>&#123;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">//åˆ›å»ºByteBuf</span>        ByteBuf byteBuf = Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello,world!&quot;</span>, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>));        <span class="hljs-comment">//ä½¿ç”¨ç›¸å…³çš„æ–¹æ³•</span>        <span class="hljs-keyword">if</span> (byteBuf.hasArray()) &#123; <span class="hljs-comment">// true</span>            <span class="hljs-keyword">byte</span>[] content = byteBuf.array();            <span class="hljs-comment">//å°† content è½¬æˆå­—ç¬¦ä¸²</span>            System.out.println(<span class="hljs-keyword">new</span> String(content, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>)));            System.out.println(<span class="hljs-string">&quot;byteBuf=&quot;</span> + byteBuf);            System.out.println(byteBuf.arrayOffset()); <span class="hljs-comment">// 0</span>            System.out.println(byteBuf.readerIndex()); <span class="hljs-comment">// 0</span>            System.out.println(byteBuf.writerIndex()); <span class="hljs-comment">// 12</span>            System.out.println(byteBuf.capacity()); <span class="hljs-comment">// 36</span>            <span class="hljs-comment">//System.out.println(byteBuf.readByte()); //</span>            System.out.println(byteBuf.getByte(<span class="hljs-number">0</span>)); <span class="hljs-comment">// 104</span>            <span class="hljs-keyword">int</span> len = byteBuf.readableBytes(); <span class="hljs-comment">//å¯è¯»çš„å­—èŠ‚æ•°  12</span>            System.out.println(<span class="hljs-string">&quot;len=&quot;</span> + len);            <span class="hljs-comment">//ä½¿ç”¨forå–å‡ºå„ä¸ªå­—èŠ‚</span>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;                System.out.println((<span class="hljs-keyword">char</span>) byteBuf.getByte(i));            &#125;            <span class="hljs-comment">//æŒ‰ç…§æŸä¸ªèŒƒå›´è¯»å–</span>            System.out.println(byteBuf.getCharSequence(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>)));            System.out.println(byteBuf.getCharSequence(<span class="hljs-number">4</span>, <span class="hljs-number">6</span>, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>)));        &#125;    &#125;&#125;</code></pre></div><h3 id="6-11-Netty-åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ"><a href="#6-11-Netty-åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ" class="headerlink" title="6.11 Netty åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ"></a>6.11 Netty åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ</h3><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li>ç¼–å†™ä¸€ä¸ª <code>Netty</code> ç¾¤èŠç³»ç»Ÿï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰</li><li>å®ç°å¤šäººç¾¤èŠ</li><li>æœåŠ¡å™¨ç«¯ï¼šå¯ä»¥ç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œå¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½</li><li>å®¢æˆ·ç«¯ï¼šé€šè¿‡ <code>channel</code> å¯ä»¥æ— é˜»å¡å‘é€æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å—å…¶å®ƒç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼ˆæœ‰æœåŠ¡å™¨è½¬å‘å¾—åˆ°ï¼‰</li><li>ç›®çš„ï¼šè¿›ä¸€æ­¥ç†è§£ <code>Netty</code> éé˜»å¡ç½‘ç»œç¼–ç¨‹æœºåˆ¶</li><li>çœ‹è€å¸ˆä»£ç æ¼”ç¤º</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_10.png" alt="img"></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.groupchat;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.*;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupChatServer</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port; <span class="hljs-comment">//ç›‘å¬ç«¯å£</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GroupChatServer</span><span class="hljs-params">(<span class="hljs-keyword">int</span> port)</span> </span>&#123;        <span class="hljs-keyword">this</span>.port = port;    &#125;    <span class="hljs-comment">//ç¼–å†™runæ–¹æ³•ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„</span>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(); <span class="hljs-comment">//8ä¸ªNioEventLoop</span>        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap b = <span class="hljs-keyword">new</span> ServerBootstrap();            b.group(bossGroup, workerGroup)                    .channel(NioServerSocketChannel.class)                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">128</span>)                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword">true</span>)                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                        <span class="hljs-meta">@Override</span>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                            <span class="hljs-comment">//è·å–åˆ°pipeline</span>                            ChannelPipeline pipeline = ch.pipeline();                            <span class="hljs-comment">//å‘pipelineåŠ å…¥è§£ç å™¨</span>                            pipeline.addLast(<span class="hljs-string">&quot;decoder&quot;</span>, <span class="hljs-keyword">new</span> StringDecoder());                            <span class="hljs-comment">//å‘pipelineåŠ å…¥ç¼–ç å™¨</span>                            pipeline.addLast(<span class="hljs-string">&quot;encoder&quot;</span>, <span class="hljs-keyword">new</span> StringEncoder());                            <span class="hljs-comment">//åŠ å…¥è‡ªå·±çš„ä¸šåŠ¡å¤„ç†handler</span>                            pipeline.addLast(<span class="hljs-keyword">new</span> GroupChatServerHandler());                        &#125;                    &#125;);            System.out.println(<span class="hljs-string">&quot;netty æœåŠ¡å™¨å¯åŠ¨&quot;</span>);            ChannelFuture channelFuture = b.bind(port).sync();            <span class="hljs-comment">//ç›‘å¬å…³é—­</span>            channelFuture.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">new</span> GroupChatServer(<span class="hljs-number">7000</span>).run();    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.groupchat;<span class="hljs-keyword">import</span> io.netty.channel.Channel;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;<span class="hljs-keyword">import</span> io.netty.channel.group.DefaultChannelGroup;<span class="hljs-keyword">import</span> io.netty.util.concurrent.GlobalEventExecutor;<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<span class="hljs-keyword">import</span> java.util.ArrayList;<span class="hljs-keyword">import</span> java.util.HashMap;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupChatServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">String</span>&gt; </span>&#123;    <span class="hljs-comment">//public static List&lt;Channel&gt; channels = new ArrayList&lt;Channel&gt;();</span>    <span class="hljs-comment">//ä½¿ç”¨ä¸€ä¸ªhashmap ç®¡ç†</span>    <span class="hljs-comment">//public static Map&lt;String, Channel&gt; channels = new HashMap&lt;String,Channel&gt;();</span>    <span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªchannle ç»„ï¼Œç®¡ç†æ‰€æœ‰çš„channel</span>    <span class="hljs-comment">//GlobalEventExecutor.INSTANCE) æ˜¯å…¨å±€çš„äº‹ä»¶æ‰§è¡Œå™¨ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ChannelGroup channelGroup = <span class="hljs-keyword">new</span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE);    SimpleDateFormat sdf = <span class="hljs-keyword">new</span> SimpleDateFormat(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);    <span class="hljs-comment">//handlerAdded è¡¨ç¤ºè¿æ¥å»ºç«‹ï¼Œä¸€æ—¦è¿æ¥ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œ</span>    <span class="hljs-comment">//å°†å½“å‰channel åŠ å…¥åˆ°  channelGroup</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handlerAdded</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        Channel channel = ctx.channel();        <span class="hljs-comment">//å°†è¯¥å®¢æˆ·åŠ å…¥èŠå¤©çš„ä¿¡æ¯æ¨é€ç»™å…¶å®ƒåœ¨çº¿çš„å®¢æˆ·ç«¯</span>        <span class="hljs-comment">/*</span><span class="hljs-comment">        è¯¥æ–¹æ³•ä¼šå°† channelGroup ä¸­æ‰€æœ‰çš„channel éå†ï¼Œå¹¶å‘é€ æ¶ˆæ¯ï¼Œ</span><span class="hljs-comment">        æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±éå†</span><span class="hljs-comment">         */</span>        channelGroup.writeAndFlush(<span class="hljs-string">&quot;[å®¢æˆ·ç«¯]&quot;</span> + channel.remoteAddress() + <span class="hljs-string">&quot; åŠ å…¥èŠå¤©&quot;</span> + sdf.format(<span class="hljs-keyword">new</span> java.util.Date()) + <span class="hljs-string">&quot; \n&quot;</span>);        channelGroup.add(channel);    &#125;    <span class="hljs-comment">//æ–­å¼€è¿æ¥, å°†xxå®¢æˆ·ç¦»å¼€ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿çš„å®¢æˆ·</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handlerRemoved</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        Channel channel = ctx.channel();        channelGroup.writeAndFlush(<span class="hljs-string">&quot;[å®¢æˆ·ç«¯]&quot;</span> + channel.remoteAddress() + <span class="hljs-string">&quot; ç¦»å¼€äº†\n&quot;</span>);        System.out.println(<span class="hljs-string">&quot;channelGroup size&quot;</span> + channelGroup.size());    &#125;    <span class="hljs-comment">//è¡¨ç¤ºchannel å¤„äºæ´»åŠ¨çŠ¶æ€, æç¤º xxä¸Šçº¿</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(ctx.channel().remoteAddress() + <span class="hljs-string">&quot; ä¸Šçº¿äº†~&quot;</span>);    &#125;    <span class="hljs-comment">//è¡¨ç¤ºchannel å¤„äºä¸æ´»åŠ¨çŠ¶æ€, æç¤º xxç¦»çº¿äº†</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelInactive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(ctx.channel().remoteAddress() + <span class="hljs-string">&quot; ç¦»çº¿äº†~&quot;</span>);    &#125;    <span class="hljs-comment">//è¯»å–æ•°æ®</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//è·å–åˆ°å½“å‰channel</span>        Channel channel = ctx.channel();        <span class="hljs-comment">//è¿™æ—¶æˆ‘ä»¬éå†channelGroup, æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œå›é€ä¸åŒçš„æ¶ˆæ¯</span>        channelGroup.forEach(ch -&gt; &#123;            <span class="hljs-keyword">if</span> (channel != ch) &#123; <span class="hljs-comment">//ä¸æ˜¯å½“å‰çš„channel,è½¬å‘æ¶ˆæ¯</span>                ch.writeAndFlush(<span class="hljs-string">&quot;[å®¢æˆ·]&quot;</span> + channel.remoteAddress() + <span class="hljs-string">&quot; å‘é€äº†æ¶ˆæ¯&quot;</span> + msg + <span class="hljs-string">&quot;\n&quot;</span>);            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å›æ˜¾è‡ªå·±å‘é€çš„æ¶ˆæ¯ç»™è‡ªå·±</span>                ch.writeAndFlush(<span class="hljs-string">&quot;[è‡ªå·±]å‘é€äº†æ¶ˆæ¯&quot;</span> + msg + <span class="hljs-string">&quot;\n&quot;</span>);            &#125;        &#125;);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//å…³é—­é€šé“</span>        ctx.close();    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.groupchat;<span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;<span class="hljs-keyword">import</span> io.netty.channel.*;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;<span class="hljs-keyword">import</span> java.util.Scanner;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupChatClient</span> </span>&#123;        <span class="hljs-comment">//å±æ€§</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String host;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> port;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GroupChatClient</span><span class="hljs-params">(String host, <span class="hljs-keyword">int</span> port)</span> </span>&#123;        <span class="hljs-keyword">this</span>.host = host;        <span class="hljs-keyword">this</span>.port = port;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        EventLoopGroup group = <span class="hljs-keyword">new</span> NioEventLoopGroup();        <span class="hljs-keyword">try</span> &#123;                        Bootstrap bootstrap = <span class="hljs-keyword">new</span> Bootstrap()                    .group(group)                    .channel(NioSocketChannel.class)                    .handler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                        <span class="hljs-meta">@Override</span>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                            <span class="hljs-comment">//å¾—åˆ°pipeline</span>                            ChannelPipeline pipeline = ch.pipeline();                            <span class="hljs-comment">//åŠ å…¥ç›¸å…³handler</span>                            pipeline.addLast(<span class="hljs-string">&quot;decoder&quot;</span>, <span class="hljs-keyword">new</span> StringDecoder());                            pipeline.addLast(<span class="hljs-string">&quot;encoder&quot;</span>, <span class="hljs-keyword">new</span> StringEncoder());                            <span class="hljs-comment">//åŠ å…¥è‡ªå®šä¹‰çš„handler</span>                            pipeline.addLast(<span class="hljs-keyword">new</span> GroupChatClientHandler());                        &#125;                    &#125;);            ChannelFuture channelFuture = bootstrap.connect(host, port).sync();            <span class="hljs-comment">//å¾—åˆ°channel</span>            Channel channel = channelFuture.channel();            System.out.println(<span class="hljs-string">&quot;-------&quot;</span> + channel.localAddress() + <span class="hljs-string">&quot;--------&quot;</span>);            <span class="hljs-comment">//å®¢æˆ·ç«¯éœ€è¦è¾“å…¥ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªæ‰«æå™¨</span>            Scanner scanner = <span class="hljs-keyword">new</span> Scanner(System.in);            <span class="hljs-keyword">while</span> (scanner.hasNextLine()) &#123;                String msg = scanner.nextLine();                <span class="hljs-comment">//é€šè¿‡channel å‘é€åˆ°æœåŠ¡å™¨ç«¯</span>                channel.writeAndFlush(msg + <span class="hljs-string">&quot;\r\n&quot;</span>);            &#125;        &#125; <span class="hljs-keyword">finally</span> &#123;            group.shutdownGracefully();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">new</span> GroupChatClient(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">7000</span>).run();    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.groupchat;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupChatClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">String</span>&gt; </span>&#123;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(msg.trim());    &#125;&#125;</code></pre></div><h3 id="6-12-Netty-å¿ƒè·³æ£€æµ‹æœºåˆ¶æ¡ˆä¾‹"><a href="#6-12-Netty-å¿ƒè·³æ£€æµ‹æœºåˆ¶æ¡ˆä¾‹" class="headerlink" title="6.12 Netty å¿ƒè·³æ£€æµ‹æœºåˆ¶æ¡ˆä¾‹"></a>6.12 Netty å¿ƒè·³æ£€æµ‹æœºåˆ¶æ¡ˆä¾‹</h3><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li>ç¼–å†™ä¸€ä¸ª <code>Netty</code> å¿ƒè·³æ£€æµ‹æœºåˆ¶æ¡ˆä¾‹,å½“æœåŠ¡å™¨è¶…è¿‡ <code>3</code> ç§’æ²¡æœ‰è¯»æ—¶ï¼Œå°±æç¤ºè¯»ç©ºé—²</li><li>å½“æœåŠ¡å™¨è¶…è¿‡ <code>5</code> ç§’æ²¡æœ‰å†™æ“ä½œæ—¶ï¼Œå°±æç¤ºå†™ç©ºé—²</li><li>å®ç°å½“æœåŠ¡å™¨è¶…è¿‡ <code>7</code> ç§’æ²¡æœ‰è¯»æˆ–è€…å†™æ“ä½œæ—¶ï¼Œå°±æç¤ºè¯»å†™ç©ºé—²</li><li>ä»£ç å¦‚ä¸‹ï¼š</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.heartbeat;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;<span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateHandler;<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyServer</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                <span class="hljs-comment">//åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„</span>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(); <span class="hljs-comment">//8ä¸ªNioEventLoop</span>        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();            serverBootstrap.group(bossGroup, workerGroup);            serverBootstrap.channel(NioServerSocketChannel.class);            serverBootstrap.handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO));            serverBootstrap.childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                <span class="hljs-meta">@Override</span>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                    ChannelPipeline pipeline = ch.pipeline();                    <span class="hljs-comment">//åŠ å…¥ä¸€ä¸ªnetty æä¾› IdleStateHandler</span>                    <span class="hljs-comment">/*</span><span class="hljs-comment">                    è¯´æ˜</span><span class="hljs-comment">                    1. IdleStateHandler æ˜¯netty æä¾›çš„å¤„ç†ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨</span><span class="hljs-comment">                    2. long readerIdleTime : è¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯», å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥</span><span class="hljs-comment">                    3. long writerIdleTime : è¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™, å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥</span><span class="hljs-comment">                    4. long allIdleTime : è¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™, å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥</span><span class="hljs-comment"></span><span class="hljs-comment">                    5. æ–‡æ¡£è¯´æ˜</span><span class="hljs-comment">                    triggers an &#123;@link IdleStateEvent&#125; when a &#123;@link Channel&#125; has not performed</span><span class="hljs-comment"> * read, write, or both operation for a while.</span><span class="hljs-comment"> *                  6. å½“ IdleStateEvent è§¦å‘å , å°±ä¼šä¼ é€’ç»™ç®¡é“ çš„ä¸‹ä¸€ä¸ªhandlerå»å¤„ç†</span><span class="hljs-comment"> *                  é€šè¿‡è°ƒç”¨(è§¦å‘)ä¸‹ä¸€ä¸ªhandler çš„ userEventTiggered , åœ¨è¯¥æ–¹æ³•ä¸­å»å¤„ç† IdleStateEvent(è¯»ç©ºé—²ï¼Œå†™ç©ºé—²ï¼Œè¯»å†™ç©ºé—²)</span><span class="hljs-comment">                     */</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> IdleStateHandler(<span class="hljs-number">7000</span>, <span class="hljs-number">7000</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS));                    <span class="hljs-comment">//åŠ å…¥ä¸€ä¸ªå¯¹ç©ºé—²æ£€æµ‹è¿›ä¸€æ­¥å¤„ç†çš„handler(è‡ªå®šä¹‰)</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> MyServerHandler());                &#125;            &#125;);            <span class="hljs-comment">//å¯åŠ¨æœåŠ¡å™¨</span>            ChannelFuture channelFuture = serverBootstrap.bind(<span class="hljs-number">7000</span>).sync();            channelFuture.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.heartbeat;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateEvent;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> evt äº‹ä»¶</span><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">userEventTriggered</span><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">instanceof</span> IdleStateEvent) &#123;            <span class="hljs-comment">//å°†  evt å‘ä¸‹è½¬å‹ IdleStateEvent</span>            IdleStateEvent event = (IdleStateEvent) evt;            String eventType = <span class="hljs-keyword">null</span>;            <span class="hljs-keyword">switch</span> (event.state()) &#123;                <span class="hljs-keyword">case</span> READER_IDLE:                    eventType = <span class="hljs-string">&quot;è¯»ç©ºé—²&quot;</span>;                    <span class="hljs-keyword">break</span>;                <span class="hljs-keyword">case</span> WRITER_IDLE:                    eventType = <span class="hljs-string">&quot;å†™ç©ºé—²&quot;</span>;                    <span class="hljs-keyword">break</span>;                <span class="hljs-keyword">case</span> ALL_IDLE:                    eventType = <span class="hljs-string">&quot;è¯»å†™ç©ºé—²&quot;</span>;                    <span class="hljs-keyword">break</span>;            &#125;            System.out.println(ctx.channel().remoteAddress() + <span class="hljs-string">&quot;--è¶…æ—¶æ—¶é—´--&quot;</span> + eventType);            System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨åšç›¸åº”å¤„ç†..&quot;</span>);            <span class="hljs-comment">//å¦‚æœå‘ç”Ÿç©ºé—²ï¼Œæˆ‘ä»¬å…³é—­é€šé“</span>            <span class="hljs-comment">// ctx.channel().close();</span>        &#125;    &#125;&#125;</code></pre></div><h3 id="6-13-Netty-é€šè¿‡-WebSocket-ç¼–ç¨‹å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é•¿è¿æ¥"><a href="#6-13-Netty-é€šè¿‡-WebSocket-ç¼–ç¨‹å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é•¿è¿æ¥" class="headerlink" title="6.13 Netty é€šè¿‡ WebSocket ç¼–ç¨‹å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é•¿è¿æ¥"></a>6.13 Netty é€šè¿‡ WebSocket ç¼–ç¨‹å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é•¿è¿æ¥</h3><p>å®ä¾‹è¦æ±‚ï¼š</p><ol><li><code>Http</code> åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨é—´çš„è¯·æ±‚å“åº”ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä¼šé‡æ–°åˆ›å»ºè¿æ¥ã€‚</li><li>è¦æ±‚ï¼šå®ç°åŸºäº <code>WebSocket</code> çš„é•¿è¿æ¥çš„å…¨åŒå·¥çš„äº¤äº’</li><li>æ”¹å˜ <code>Http</code> åè®®å¤šæ¬¡è¯·æ±‚çš„çº¦æŸï¼Œå®ç°é•¿è¿æ¥äº†ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€æ¶ˆæ¯ç»™æµè§ˆå™¨</li><li>å®¢æˆ·ç«¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ä¼šç›¸äº’æ„ŸçŸ¥ï¼Œæ¯”å¦‚æœåŠ¡å™¨å…³é—­äº†ï¼Œæµè§ˆå™¨ä¼šæ„ŸçŸ¥ï¼ŒåŒæ ·æµè§ˆå™¨å…³é—­äº†ï¼ŒæœåŠ¡å™¨ä¼šæ„ŸçŸ¥</li><li>è¿è¡Œç•Œé¢</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter06_11.png" alt="img"></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.websocket;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;<span class="hljs-keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;<span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;<span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;<span class="hljs-keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyServer</span> </span>&#123;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„</span>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(); <span class="hljs-comment">//8ä¸ªNioEventLoop</span>        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();            serverBootstrap.group(bossGroup, workerGroup);            serverBootstrap.channel(NioServerSocketChannel.class);            serverBootstrap.handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO));            serverBootstrap.childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                <span class="hljs-meta">@Override</span>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                    ChannelPipeline pipeline = ch.pipeline();                    <span class="hljs-comment">//å› ä¸ºåŸºäºhttpåè®®ï¼Œä½¿ç”¨httpçš„ç¼–ç å’Œè§£ç å™¨</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> HttpServerCodec());                    <span class="hljs-comment">//æ˜¯ä»¥å—æ–¹å¼å†™ï¼Œæ·»åŠ ChunkedWriteHandlerå¤„ç†å™¨</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> ChunkedWriteHandler());                    <span class="hljs-comment">/*</span><span class="hljs-comment">                    è¯´æ˜</span><span class="hljs-comment">                    1. httpæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯åˆ†æ®µ, HttpObjectAggregator ï¼Œå°±æ˜¯å¯ä»¥å°†å¤šä¸ªæ®µèšåˆ</span><span class="hljs-comment">                    2. è¿™å°±å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œå½“æµè§ˆå™¨å‘é€å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå‘å‡ºå¤šæ¬¡httpè¯·æ±‚</span><span class="hljs-comment">                     */</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> HttpObjectAggregator(<span class="hljs-number">8192</span>));                    <span class="hljs-comment">/*</span><span class="hljs-comment">                    è¯´æ˜</span><span class="hljs-comment">                    1. å¯¹åº”websocket ï¼Œå®ƒçš„æ•°æ®æ˜¯ä»¥ å¸§(frame) å½¢å¼ä¼ é€’</span><span class="hljs-comment">                    2. å¯ä»¥çœ‹åˆ°WebSocketFrame ä¸‹é¢æœ‰å…­ä¸ªå­ç±»</span><span class="hljs-comment">                    3. æµè§ˆå™¨è¯·æ±‚æ—¶ ws://localhost:7000/hello è¡¨ç¤ºè¯·æ±‚çš„uri</span><span class="hljs-comment">                    4. WebSocketServerProtocolHandler æ ¸å¿ƒåŠŸèƒ½æ˜¯å°† httpåè®®å‡çº§ä¸º wsåè®® , ä¿æŒé•¿è¿æ¥</span><span class="hljs-comment">                    5. æ˜¯é€šè¿‡ä¸€ä¸ª çŠ¶æ€ç  101</span><span class="hljs-comment">                     */</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> WebSocketServerProtocolHandler(<span class="hljs-string">&quot;/hello2&quot;</span>));                    <span class="hljs-comment">//è‡ªå®šä¹‰çš„handler ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘</span>                    pipeline.addLast(<span class="hljs-keyword">new</span> MyTextWebSocketFrameHandler());                &#125;            &#125;);            <span class="hljs-comment">//å¯åŠ¨æœåŠ¡å™¨</span>            ChannelFuture channelFuture = serverBootstrap.bind(<span class="hljs-number">7000</span>).sync();            channelFuture.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.websocket;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;<span class="hljs-keyword">import</span> java.time.LocalDateTime;<span class="hljs-comment">//è¿™é‡Œ TextWebSocketFrame ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬å¸§(frame)</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTextWebSocketFrameHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">TextWebSocketFrame</span>&gt; </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ &quot;</span> + msg.text());        <span class="hljs-comment">//å›å¤æ¶ˆæ¯</span>        ctx.channel().writeAndFlush(<span class="hljs-keyword">new</span> TextWebSocketFrame(<span class="hljs-string">&quot;æœåŠ¡å™¨æ—¶é—´&quot;</span> + LocalDateTime.now() + <span class="hljs-string">&quot; &quot;</span> + msg.text()));    &#125;    <span class="hljs-comment">//å½“webå®¢æˆ·ç«¯è¿æ¥åï¼Œ è§¦å‘æ–¹æ³•</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handlerAdded</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//id è¡¨ç¤ºå”¯ä¸€çš„å€¼ï¼ŒLongText æ˜¯å”¯ä¸€çš„ ShortText ä¸æ˜¯å”¯ä¸€</span>        System.out.println(<span class="hljs-string">&quot;handlerAdded è¢«è°ƒç”¨&quot;</span> + ctx.channel().id().asLongText());        System.out.println(<span class="hljs-string">&quot;handlerAdded è¢«è°ƒç”¨&quot;</span> + ctx.channel().id().asShortText());    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handlerRemoved</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;handlerRemoved è¢«è°ƒç”¨&quot;</span> + ctx.channel().id().asLongText());    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;å¼‚å¸¸å‘ç”Ÿ &quot;</span> + cause.getMessage());        ctx.close(); <span class="hljs-comment">//å…³é—­è¿æ¥</span>    &#125;&#125;</code></pre></div><p>hello.html</p><div class="code-wrapper"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">    <span class="hljs-keyword">var</span> socket;</span><span class="javascript">    <span class="hljs-comment">//åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒwebsocket</span></span><span class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.WebSocket) &#123;</span><span class="javascript">        <span class="hljs-comment">//go on</span></span><span class="javascript">        socket = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-string">&quot;ws://localhost:7000/hello2&quot;</span>);</span><span class="javascript">        <span class="hljs-comment">//ç›¸å½“äºchannelRead, ev æ”¶åˆ°æœåŠ¡å™¨ç«¯å›é€çš„æ¶ˆæ¯</span></span><span class="javascript">        socket.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>&#123;</span><span class="javascript">            <span class="hljs-keyword">const</span> rt = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;responseText&quot;</span>);</span><span class="javascript">            rt.value = rt.value + <span class="hljs-string">&quot;\n&quot;</span> + ev.data;</span>        &#125;<span class="javascript">        <span class="hljs-comment">//ç›¸å½“äºè¿æ¥å¼€å¯(æ„ŸçŸ¥åˆ°è¿æ¥å¼€å¯)</span></span><span class="javascript">        socket.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>&#123;</span><span class="javascript">            <span class="hljs-keyword">const</span> rt = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;responseText&quot;</span>);</span><span class="javascript">            rt.value = <span class="hljs-string">&quot;è¿æ¥å¼€å¯äº†..&quot;</span></span>        &#125;<span class="javascript">        <span class="hljs-comment">//ç›¸å½“äºè¿æ¥å…³é—­(æ„ŸçŸ¥åˆ°è¿æ¥å…³é—­)</span></span><span class="javascript">        socket.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>&#123;</span><span class="javascript">            <span class="hljs-keyword">const</span> rt = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;responseText&quot;</span>);</span><span class="javascript">            rt.value = rt.value + <span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;è¿æ¥å…³é—­äº†..&quot;</span></span>        &#125;<span class="javascript">    &#125; <span class="hljs-keyword">else</span> &#123;</span><span class="javascript">        alert(<span class="hljs-string">&quot;å½“å‰æµè§ˆå™¨ä¸æ”¯æŒwebsocket&quot;</span>)</span>    &#125;<span class="javascript">    <span class="hljs-comment">//å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨</span></span><span class="javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params">message</span>) </span>&#123;</span><span class="javascript">        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.socket) &#123; <span class="hljs-comment">//å…ˆåˆ¤æ–­socketæ˜¯å¦åˆ›å»ºå¥½</span></span><span class="javascript">            <span class="hljs-keyword">return</span>;</span>        &#125;        if (socket.readyState === WebSocket.OPEN) &#123;<span class="javascript">            <span class="hljs-comment">//é€šè¿‡socket å‘é€æ¶ˆæ¯</span></span>            socket.send(message)<span class="javascript">        &#125; <span class="hljs-keyword">else</span> &#123;</span><span class="javascript">            alert(<span class="hljs-string">&quot;è¿æ¥æ²¡æœ‰å¼€å¯&quot;</span>);</span>        &#125;    &#125;<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onsubmit</span>=<span class="hljs-string">&quot;return false&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 300px; width: 300px&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;å‘ç”Ÿæ¶ˆæ¯&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;send(this.form.message.value)&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;responseText&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;responseText&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 300px; width: 300px&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;æ¸…ç©ºå†…å®¹&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;document.getElementById(&#x27;responseText&#x27;).value=&#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre></div><h2 id="7-Google-Protobuf"><a href="#7-Google-Protobuf" class="headerlink" title="7 Google Protobuf"></a>7 Google Protobuf</h2><h3 id="7-1-ç¼–ç å’Œè§£ç çš„åŸºæœ¬ä»‹ç»"><a href="#7-1-ç¼–ç å’Œè§£ç çš„åŸºæœ¬ä»‹ç»" class="headerlink" title="7.1 ç¼–ç å’Œè§£ç çš„åŸºæœ¬ä»‹ç»"></a>7.1 ç¼–ç å’Œè§£ç çš„åŸºæœ¬ä»‹ç»</h3><ol><li>ç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºæ—¶ï¼Œå› ä¸ºæ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„éƒ½æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç æ•°æ®ï¼Œåœ¨å‘é€æ•°æ®æ—¶å°±éœ€è¦ç¼–ç ï¼Œæ¥æ”¶æ•°æ®æ—¶å°±éœ€è¦è§£ç [ç¤ºæ„å›¾]</li><li><code>codec</code>ï¼ˆç¼–è§£ç å™¨ï¼‰çš„ç»„æˆéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼š<code>decoder</code>ï¼ˆè§£ç å™¨ï¼‰å’Œ <code>encoder</code>ï¼ˆç¼–ç å™¨ï¼‰ã€‚<code>encoder</code> è´Ÿè´£æŠŠä¸šåŠ¡æ•°æ®è½¬æ¢æˆå­—èŠ‚ç æ•°æ®ï¼Œ<code>decoder</code> è´Ÿè´£æŠŠå­—èŠ‚ç æ•°æ®è½¬æ¢æˆä¸šåŠ¡æ•°æ®</li></ol><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter07/chapter07_01.png" alt="img"></p><h3 id="7-2-Netty-æœ¬èº«çš„ç¼–ç è§£ç çš„æœºåˆ¶å’Œé—®é¢˜åˆ†æ"><a href="#7-2-Netty-æœ¬èº«çš„ç¼–ç è§£ç çš„æœºåˆ¶å’Œé—®é¢˜åˆ†æ" class="headerlink" title="7.2 Netty æœ¬èº«çš„ç¼–ç è§£ç çš„æœºåˆ¶å’Œé—®é¢˜åˆ†æ"></a>7.2 Netty æœ¬èº«çš„ç¼–ç è§£ç çš„æœºåˆ¶å’Œé—®é¢˜åˆ†æ</h3><ol><li><code>Netty</code> è‡ªèº«æä¾›äº†ä¸€äº› <code>codec</code>(ç¼–è§£ç å™¨)</li><li><code>Netty</code> æä¾›çš„ç¼–ç å™¨ <code>StringEncoder</code>ï¼Œå¯¹å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œç¼–ç  <code>ObjectEncoder</code>ï¼Œå¯¹Javaå¯¹è±¡è¿›è¡Œç¼–ç â€¦</li><li><code>Netty</code> æä¾›çš„è§£ç å™¨ <code>StringDecoder</code>,å¯¹å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œè§£ç  <code>ObjectDecoder</code>ï¼Œå¯¹ <code>Java</code> å¯¹è±¡è¿›è¡Œè§£ç â€¦</li><li><code>Netty</code> æœ¬èº«è‡ªå¸¦çš„ <code>ObjectDecoder</code> å’Œ <code>ObjectEncoder</code> å¯ä»¥ç”¨æ¥å®ç° <code>POJO</code> å¯¹è±¡æˆ–å„ç§ä¸šåŠ¡å¯¹è±¡çš„ç¼–ç å’Œè§£ç ï¼Œåº•å±‚ä½¿ç”¨çš„ä»æ˜¯Javaåºåˆ—åŒ–æŠ€æœ¯,è€ŒJavaåºåˆ—åŒ–æŠ€æœ¯æœ¬èº«æ•ˆç‡å°±ä¸é«˜ï¼Œå­˜åœ¨å¦‚ä¸‹é—®é¢˜<ul><li>æ— æ³•è·¨è¯­è¨€</li><li>åºåˆ—åŒ–åçš„ä½“ç§¯å¤ªå¤§ï¼Œæ˜¯äºŒè¿›åˆ¶ç¼–ç çš„5å€å¤šã€‚</li><li>åºåˆ—åŒ–æ€§èƒ½å¤ªä½</li></ul></li><li>=&gt;å¼•å‡ºæ–°çš„è§£å†³æ–¹æ¡ˆ[<code>Google</code> çš„ <code>Protobuf</code>]</li></ol><h3 id="7-3-Protobuf"><a href="#7-3-Protobuf" class="headerlink" title="7.3 Protobuf"></a>7.3 Protobuf</h3><ol><li><code>Protobuf</code> åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨ç¤ºæ„å›¾</li><li><code>Protobuf</code> æ˜¯ <code>Google</code> å‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œå…¨ç§° <code>Google Protocol Buffers</code>ï¼Œæ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼Œæˆ–è€…è¯´åºåˆ—åŒ–ã€‚å®ƒå¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ– <code>RPC</code> [è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ <code>remote procedure call</code> ]æ•°æ®äº¤æ¢æ ¼å¼ã€‚ç›®å‰å¾ˆå¤šå…¬å¸ <code>http + json tcp + protobuf</code></li><li>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://developers.google.com/protocol-buffers/docs/proto">https://developers.google.com/protocol-buffers/docs/proto</a> è¯­è¨€æŒ‡å—</li><li><code>Protobuf</code> æ˜¯ä»¥ <code>message</code> çš„æ–¹å¼æ¥ç®¡ç†æ•°æ®çš„.</li><li>æ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ï¼Œå³[å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¯ä»¥æ˜¯ä¸åŒçš„è¯­è¨€ç¼–å†™çš„]ï¼ˆæ”¯æŒç›®å‰ç»å¤§å¤šæ•°è¯­è¨€ï¼Œä¾‹å¦‚ <code>C++</code>ã€<code>C#</code>ã€<code>Java</code>ã€<code>python</code> ç­‰ï¼‰</li><li>é«˜æ€§èƒ½ï¼Œé«˜å¯é æ€§</li><li>ä½¿ç”¨ <code>protobuf</code> ç¼–è¯‘å™¨èƒ½è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œ<code>Protobuf</code> æ˜¯å°†ç±»çš„å®šä¹‰ä½¿ç”¨ <code>.proto</code> æ–‡ä»¶è¿›è¡Œæè¿°ã€‚è¯´æ˜ï¼Œåœ¨ <code>idea</code> ä¸­ç¼–å†™ <code>.proto</code> æ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨æç¤ºæ˜¯å¦ä¸‹è½½ <code>.ptoto</code> ç¼–å†™æ’ä»¶.å¯ä»¥è®©è¯­æ³•é«˜äº®ã€‚</li><li>ç„¶åé€šè¿‡ <code>protoc.exe</code> ç¼–è¯‘å™¨æ ¹æ® <code>.proto</code> è‡ªåŠ¨ç”Ÿæˆ <code>.java</code> æ–‡ä»¶</li><li><code>protobuf</code> ä½¿ç”¨ç¤ºæ„å›¾</li></ol><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter07/chapter07_02.png" alt="img"></p><h3 id="7-4-Protobuf-å¿«é€Ÿå…¥é—¨å®ä¾‹"><a href="#7-4-Protobuf-å¿«é€Ÿå…¥é—¨å®ä¾‹" class="headerlink" title="7.4 Protobuf å¿«é€Ÿå…¥é—¨å®ä¾‹"></a>7.4 Protobuf å¿«é€Ÿå…¥é—¨å®ä¾‹</h3><p>ç¼–å†™ç¨‹åºï¼Œä½¿ç”¨ <code>Protobuf</code> å®Œæˆå¦‚ä¸‹åŠŸèƒ½</p><ol><li>å®¢æˆ·ç«¯å¯ä»¥å‘é€ä¸€ä¸ª <code>StudentPoJo</code> å¯¹è±¡åˆ°æœåŠ¡å™¨(é€šè¿‡ <code>Protobuf</code> ç¼–ç )</li><li>æœåŠ¡ç«¯èƒ½æ¥æ”¶ <code>StudentPoJo</code> å¯¹è±¡ï¼Œå¹¶æ˜¾ç¤ºä¿¡æ¯(é€šè¿‡ <code>Protobuf</code> è§£ç )</li><li>å…·ä½“çœ‹è€å¸ˆæ¼”ç¤ºæ­¥éª¤</li></ol><div class="code-wrapper"><pre><code class="hljs java">Student.protosyntax = <span class="hljs-string">&quot;proto3&quot;</span>; <span class="hljs-comment">//ç‰ˆæœ¬</span>option java_outer_classname = <span class="hljs-string">&quot;StudentPOJO&quot;</span>;<span class="hljs-comment">//ç”Ÿæˆçš„å¤–éƒ¨ç±»åï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶å</span><span class="hljs-comment">//protobuf ä½¿ç”¨message ç®¡ç†æ•°æ®</span>message Student &#123; <span class="hljs-comment">//ä¼šåœ¨ StudentPOJO å¤–éƒ¨ç±»ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±» Studentï¼Œ ä»–æ˜¯çœŸæ­£å‘é€çš„POJOå¯¹è±¡</span>    int32 id = <span class="hljs-number">1</span>; <span class="hljs-comment">// Student ç±»ä¸­æœ‰ ä¸€ä¸ªå±æ€§ åå­—ä¸º id ç±»å‹ä¸ºint32(protobufç±»å‹) 1è¡¨ç¤ºå±æ€§åºå·ï¼Œä¸æ˜¯å€¼</span>    string name = <span class="hljs-number">2</span>;&#125;ç¼–è¯‘protoc.exe--java_out=.Student.protoå°†ç”Ÿæˆçš„ StudentPOJO æ”¾å…¥åˆ°é¡¹ç›®ä½¿ç”¨</code></pre></div><h3 id="7-5-Protobuf-å¿«é€Ÿå…¥é—¨å®ä¾‹-2"><a href="#7-5-Protobuf-å¿«é€Ÿå…¥é—¨å®ä¾‹-2" class="headerlink" title="7.5 Protobuf å¿«é€Ÿå…¥é—¨å®ä¾‹ 2"></a>7.5 Protobuf å¿«é€Ÿå…¥é—¨å®ä¾‹ 2</h3><ol><li>ç¼–å†™ç¨‹åºï¼Œä½¿ç”¨ <code>Protobuf</code> å®Œæˆå¦‚ä¸‹åŠŸèƒ½</li><li>å®¢æˆ·ç«¯å¯ä»¥éšæœºå‘é€ <code>StudentPoJo</code> / <code>WorkerPoJo</code> å¯¹è±¡åˆ°æœåŠ¡å™¨(é€šè¿‡ <code>Protobuf</code> ç¼–ç )</li><li>æœåŠ¡ç«¯èƒ½æ¥æ”¶ <code>StudentPoJo</code> / <code>WorkerPoJo</code> å¯¹è±¡(éœ€è¦åˆ¤æ–­æ˜¯å“ªç§ç±»å‹)ï¼Œå¹¶æ˜¾ç¤ºä¿¡æ¯(é€šè¿‡ <code>Protobuf</code> è§£ç )</li><li>å…·ä½“çœ‹è€å¸ˆæ¼”ç¤ºæ­¥éª¤</li></ol><div class="code-wrapper"><pre><code class="hljs java">Student.protosyntax = <span class="hljs-string">&quot;proto3&quot;</span>;option optimize_for = SPEED; <span class="hljs-comment">// åŠ å¿«è§£æ</span>option java_package=<span class="hljs-string">&quot;com.atguigu.netty.codec2&quot;</span>;   <span class="hljs-comment">//æŒ‡å®šç”Ÿæˆåˆ°å“ªä¸ªåŒ…ä¸‹</span>option java_outer_classname=<span class="hljs-string">&quot;MyDataInfo&quot;</span>; <span class="hljs-comment">// å¤–éƒ¨ç±»å, æ–‡ä»¶å</span><span class="hljs-comment">//protobuf å¯ä»¥ä½¿ç”¨message ç®¡ç†å…¶ä»–çš„message</span>message MyMessage &#123;    <span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹</span>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">DataType</span> </span>&#123;        StudentType = <span class="hljs-number">0</span>; <span class="hljs-comment">//åœ¨proto3 è¦æ±‚enumçš„ç¼–å·ä»0å¼€å§‹</span>        WorkerType = <span class="hljs-number">1</span>;    &#125;    <span class="hljs-comment">//ç”¨data_type æ¥æ ‡è¯†ä¼ çš„æ˜¯å“ªä¸€ä¸ªæšä¸¾ç±»å‹</span>    DataType data_type = <span class="hljs-number">1</span>;    <span class="hljs-comment">//è¡¨ç¤ºæ¯æ¬¡æšä¸¾ç±»å‹æœ€å¤šåªèƒ½å‡ºç°å…¶ä¸­çš„ä¸€ä¸ª, èŠ‚çœç©ºé—´</span>    oneof dataBody &#123;        Student student = <span class="hljs-number">2</span>;        Worker worker = <span class="hljs-number">3</span>;    &#125;&#125;message Student &#123;    int32 id = <span class="hljs-number">1</span>;<span class="hljs-comment">//Studentç±»çš„å±æ€§</span>    string name = <span class="hljs-number">2</span>; <span class="hljs-comment">//</span>&#125;message Worker &#123;    string name=<span class="hljs-number">1</span>;    int32 age=<span class="hljs-number">2</span>;&#125;</code></pre></div><h2 id="8-Netty-ç¼–è§£ç å™¨å’Œ-Handler-è°ƒç”¨æœºåˆ¶"><a href="#8-Netty-ç¼–è§£ç å™¨å’Œ-Handler-è°ƒç”¨æœºåˆ¶" class="headerlink" title="8 Netty ç¼–è§£ç å™¨å’Œ Handler è°ƒç”¨æœºåˆ¶"></a>8 Netty ç¼–è§£ç å™¨å’Œ Handler è°ƒç”¨æœºåˆ¶</h2><h3 id="8-1-åŸºæœ¬è¯´æ˜"><a href="#8-1-åŸºæœ¬è¯´æ˜" class="headerlink" title="8.1 åŸºæœ¬è¯´æ˜"></a>8.1 åŸºæœ¬è¯´æ˜</h3><ol><li><code>Netty</code> çš„ç»„ä»¶è®¾è®¡ï¼š<code>Netty</code> çš„ä¸»è¦ç»„ä»¶æœ‰ <code>Channel</code>ã€<code>EventLoop</code>ã€<code>ChannelFuture</code>ã€<code>ChannelHandler</code>ã€<code>ChannelPipe</code> ç­‰</li><li><code>ChannelHandler</code> å……å½“äº†å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå®ç° <code>ChannelInboundHandler</code> æ¥å£ï¼ˆæˆ– <code>ChannelInboundHandlerAdapter</code>ï¼‰ï¼Œä½ å°±å¯ä»¥æ¥æ”¶å…¥ç«™äº‹ä»¶å’Œæ•°æ®ï¼Œè¿™äº›æ•°æ®ä¼šè¢«ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚å½“è¦ç»™å®¢æˆ·ç«¯å‘é€å“åº”æ—¶ï¼Œä¹Ÿå¯ä»¥ä» <code>ChannelInboundHandler</code> å†²åˆ·æ•°æ®ã€‚ä¸šåŠ¡é€»è¾‘é€šå¸¸å†™åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ª <code>ChannelInboundHandler</code> ä¸­ã€‚<code>ChannelOutboundHandler</code> åŸç†ä¸€æ ·ï¼Œåªä¸è¿‡å®ƒæ˜¯ç”¨æ¥å¤„ç†å‡ºç«™æ•°æ®çš„</li><li><code>ChannelPipeline</code> æä¾›äº† <code>ChannelHandler</code> é“¾çš„å®¹å™¨ã€‚ä»¥å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸ºä¾‹ï¼Œå¦‚æœäº‹ä»¶çš„è¿åŠ¨æ–¹å‘æ˜¯ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°è¿™äº›äº‹ä»¶ä¸ºå‡ºç«™çš„ï¼Œå³å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„æ•°æ®ä¼šé€šè¿‡ <code>pipeline</code> ä¸­çš„ä¸€ç³»åˆ— <code>ChannelOutboundHandler</code>ï¼Œå¹¶è¢«è¿™äº› <code>Handler</code> å¤„ç†ï¼Œåä¹‹åˆ™ç§°ä¸ºå…¥ç«™çš„</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter08_01.png" alt="img"></p><h3 id="8-2ç¼–ç è§£ç å™¨"><a href="#8-2ç¼–ç è§£ç å™¨" class="headerlink" title="8.2ç¼–ç è§£ç å™¨"></a>8.2ç¼–ç è§£ç å™¨</h3><ol><li>å½“ <code>Netty</code> å‘é€æˆ–è€…æ¥å—ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±å°†ä¼šå‘ç”Ÿä¸€æ¬¡æ•°æ®è½¬æ¢ã€‚å…¥ç«™æ¶ˆæ¯ä¼šè¢«è§£ç ï¼šä»å­—èŠ‚è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼ˆæ¯”å¦‚ <code>java</code> å¯¹è±¡ï¼‰ï¼›å¦‚æœæ˜¯å‡ºç«™æ¶ˆæ¯ï¼Œå®ƒä¼šè¢«ç¼–ç æˆå­—èŠ‚ã€‚</li><li><code>Netty</code> æä¾›ä¸€ç³»åˆ—å®ç”¨çš„ç¼–è§£ç å™¨ï¼Œä»–ä»¬éƒ½å®ç°äº† <code>ChannelInboundHadnler</code> æˆ–è€… <code>ChannelOutboundHandler</code> æ¥å£ã€‚åœ¨è¿™äº›ç±»ä¸­ï¼Œ<code>channelRead</code> æ–¹æ³•å·²ç»è¢«é‡å†™äº†ã€‚ä»¥å…¥ç«™ä¸ºä¾‹ï¼Œå¯¹äºæ¯ä¸ªä»å…¥ç«™ <code>Channel</code> è¯»å–çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚éšåï¼Œå®ƒå°†è°ƒç”¨ç”±è§£ç å™¨æ‰€æä¾›çš„ <code>decode()</code> æ–¹æ³•è¿›è¡Œè§£ç ï¼Œå¹¶å°†å·²ç»è§£ç çš„å­—èŠ‚è½¬å‘ç»™ <code>ChannelPipeline</code> ä¸­çš„ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code>ã€‚</li></ol><h3 id="8-3-è§£ç å™¨-ByteToMessageDecoder"><a href="#8-3-è§£ç å™¨-ByteToMessageDecoder" class="headerlink" title="8.3 è§£ç å™¨ - ByteToMessageDecoder"></a>8.3 è§£ç å™¨ - ByteToMessageDecoder</h3><ol><li>å…³ç³»ç»§æ‰¿å›¾</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter08_02.png" alt="img"></p><ol><li>ç”±äºä¸å¯èƒ½çŸ¥é“è¿œç¨‹èŠ‚ç‚¹æ˜¯å¦ä¼šä¸€æ¬¡æ€§å‘é€ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯ï¼Œ<code>tcp</code> æœ‰å¯èƒ½å‡ºç°ç²˜åŒ…æ‹†åŒ…çš„é—®é¢˜ï¼Œè¿™ä¸ªç±»ä¼šå¯¹å…¥ç«™æ•°æ®è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°å®ƒå‡†å¤‡å¥½è¢«å¤„ç†.</li><li>ä¸€ä¸ªå…³äº <code>ByteToMessageDecoder</code> å®ä¾‹åˆ†æ</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter08_03.png" alt="img"></p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter08_04.png" alt="img"></p><h3 id="8-4-Netty-çš„-handler-é“¾çš„è°ƒç”¨æœºåˆ¶"><a href="#8-4-Netty-çš„-handler-é“¾çš„è°ƒç”¨æœºåˆ¶" class="headerlink" title="8.4 Netty çš„ handler é“¾çš„è°ƒç”¨æœºåˆ¶"></a>8.4 Netty çš„ handler é“¾çš„è°ƒç”¨æœºåˆ¶</h3><p>å®ä¾‹è¦æ±‚:</p><ol><li>ä½¿ç”¨è‡ªå®šä¹‰çš„ç¼–ç å™¨å’Œè§£ç å™¨æ¥è¯´æ˜ <code>Netty</code> çš„ <code>handler</code> è°ƒç”¨æœºåˆ¶ å®¢æˆ·ç«¯å‘é€ <code>long</code> -&gt; æœåŠ¡å™¨ æœåŠ¡ç«¯å‘é€ <code>long</code> -&gt; å®¢æˆ·ç«¯</li><li>æ¡ˆä¾‹æ¼”ç¤º</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter08_05.png" alt="img"></p><ol><li>ç»“è®º<ul><li>ä¸è®ºè§£ç å™¨ <code>handler</code> è¿˜æ˜¯ç¼–ç å™¨ <code>handler</code> å³æ¥æ”¶çš„æ¶ˆæ¯ç±»å‹å¿…é¡»ä¸å¾…å¤„ç†çš„æ¶ˆæ¯ç±»å‹ä¸€è‡´ï¼Œå¦åˆ™è¯¥ <code>handler</code> ä¸ä¼šè¢«æ‰§è¡Œ</li><li>åœ¨è§£ç å™¨è¿›è¡Œæ•°æ®è§£ç æ—¶ï¼Œéœ€è¦åˆ¤æ–­ç¼“å­˜åŒºï¼ˆ<code>ByteBuf</code>ï¼‰çš„æ•°æ®æ˜¯å¦è¶³å¤Ÿï¼Œå¦åˆ™æ¥æ”¶åˆ°çš„ç»“æœä¼šæœŸæœ›ç»“æœå¯èƒ½ä¸ä¸€è‡´</li></ul></li></ol><h3 id="8-5-è§£ç å™¨-ReplayingDecoder"><a href="#8-5-è§£ç å™¨-ReplayingDecoder" class="headerlink" title="8.5 è§£ç å™¨ - ReplayingDecoder"></a>8.5 è§£ç å™¨ - ReplayingDecoder</h3><ol><li><code>public abstract class ReplayingDecoder&lt;S&gt; extends ByteToMessageDecoder</code></li><li><code>ReplayingDecoder</code> æ‰©å±•äº† <code>ByteToMessageDecoder</code> ç±»ï¼Œä½¿ç”¨è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬ä¸å¿…è°ƒç”¨ <code>readableBytes()</code> æ–¹æ³•ã€‚å‚æ•° <code>S</code> æŒ‡å®šäº†ç”¨æˆ·çŠ¶æ€ç®¡ç†çš„ç±»å‹ï¼Œå…¶ä¸­ <code>Void</code> ä»£è¡¨ä¸éœ€è¦çŠ¶æ€ç®¡ç†</li><li>åº”ç”¨å®ä¾‹ï¼šä½¿ç”¨ <code>ReplayingDecoder</code> ç¼–å†™è§£ç å™¨ï¼Œå¯¹å‰é¢çš„æ¡ˆä¾‹è¿›è¡Œç®€åŒ–[æ¡ˆä¾‹æ¼”ç¤º]</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.inboundhandlerandoutboundhandler;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.handler.codec.ReplayingDecoder;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyByteToLongDecoder2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ReplayingDecoder</span>&lt;<span class="hljs-title">Void</span>&gt; </span>&#123;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;MyByteToLongDecoder2 è¢«è°ƒç”¨&quot;</span>);        <span class="hljs-comment">//åœ¨ ReplayingDecoder ä¸éœ€è¦åˆ¤æ–­æ•°æ®æ˜¯å¦è¶³å¤Ÿè¯»å–ï¼Œå†…éƒ¨ä¼šè¿›è¡Œå¤„ç†åˆ¤æ–­</span>        out.add(in.readLong());    &#125;&#125;</code></pre></div><ol start="4"><li><code>ReplayingDecoder</code>ä½¿ç”¨æ–¹ä¾¿ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼š<ul><li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„ <code>ByteBuf</code> æ“ä½œéƒ½è¢«æ”¯æŒï¼Œå¦‚æœè°ƒç”¨äº†ä¸€ä¸ªä¸è¢«æ”¯æŒçš„æ–¹æ³•ï¼Œå°†ä¼šæŠ›å‡ºä¸€ä¸ª <code>UnsupportedOperationException</code>ã€‚</li><li><code>ReplayingDecoder</code> åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ç¨æ…¢äº <code>ByteToMessageDecoder</code>ï¼Œä¾‹å¦‚ç½‘ç»œç¼“æ…¢å¹¶ä¸”æ¶ˆæ¯æ ¼å¼å¤æ‚æ—¶ï¼Œæ¶ˆæ¯ä¼šè¢«æ‹†æˆäº†å¤šä¸ªç¢ç‰‡ï¼Œé€Ÿåº¦å˜æ…¢</li></ul></li></ol><h3 id="8-6-å…¶å®ƒç¼–è§£ç å™¨"><a href="#8-6-å…¶å®ƒç¼–è§£ç å™¨" class="headerlink" title="8.6 å…¶å®ƒç¼–è§£ç å™¨"></a>8.6 å…¶å®ƒç¼–è§£ç å™¨</h3><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter08_06.png" alt="img"></p><h4 id="8-6-1-å…¶å®ƒè§£ç å™¨"><a href="#8-6-1-å…¶å®ƒè§£ç å™¨" class="headerlink" title="8.6.1 å…¶å®ƒè§£ç å™¨"></a>8.6.1 å…¶å®ƒè§£ç å™¨</h4><ol><li><code>LineBasedFrameDecoder</code>ï¼šè¿™ä¸ªç±»åœ¨ <code>Netty</code> å†…éƒ¨ä¹Ÿæœ‰ä½¿ç”¨ï¼Œå®ƒä½¿ç”¨è¡Œå°¾æ§åˆ¶å­—ç¬¦ï¼ˆ\næˆ–è€…\r\nï¼‰ä½œä¸ºåˆ†éš”ç¬¦æ¥è§£ææ•°æ®ã€‚</li><li><code>DelimiterBasedFrameDecoder</code>ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„ç‰¹æ®Šå­—ç¬¦ä½œä¸ºæ¶ˆæ¯çš„åˆ†éš”ç¬¦ã€‚</li><li><code>HttpObjectDecoder</code>ï¼šä¸€ä¸ª <code>HTTP</code> æ•°æ®çš„è§£ç å™¨</li><li><code>LengthFieldBasedFrameDecoder</code>ï¼šé€šè¿‡æŒ‡å®šé•¿åº¦æ¥æ ‡è¯†æ•´åŒ…æ¶ˆæ¯ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨çš„å¤„ç†é»åŒ…å’ŒåŠåŒ…æ¶ˆæ¯ã€‚</li></ol><h4 id="8-6-2-å…¶å®ƒç¼–ç å™¨"><a href="#8-6-2-å…¶å®ƒç¼–ç å™¨" class="headerlink" title="8.6.2 å…¶å®ƒç¼–ç å™¨"></a>8.6.2 å…¶å®ƒç¼–ç å™¨</h4><h3 id="8-7-Log4j-æ•´åˆåˆ°-Netty"><a href="#8-7-Log4j-æ•´åˆåˆ°-Netty" class="headerlink" title="8.7 Log4j æ•´åˆåˆ° Netty"></a>8.7 Log4j æ•´åˆåˆ° Netty</h3><ol><li>åœ¨ <code>Maven</code> ä¸­æ·»åŠ å¯¹ <code>Log4j</code> çš„ä¾èµ–åœ¨ <code>pom.xml</code></li></ol><div class="code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.25<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-log4j12<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.25<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-simple<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.25<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div><ol><li>é…ç½® <code>Log4j</code>ï¼Œåœ¨ <code>resources/log4j.properties</code></li></ol><div class="code-wrapper"><pre><code class="hljs xml">log4j.rootLogger=DEBUG,stdoutlog4j.appender.stdout=org.apache.log4j.ConsoleAppenderlog4j.appender.stdout.layout=org.apache.log4j.PatternLayoutlog4j.appender.stdout.layout.ConversionPattern=[%p]%C&#123;1&#125;-%m%n</code></pre></div><ol><li>æ¼”ç¤ºæ•´åˆ</li></ol><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter08/chapter08_07.png" alt="img"></p><h2 id="9-TCP-ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ"><a href="#9-TCP-ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="9 TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ"></a>9 TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ</h2><h3 id="9-1-TCP-ç²˜åŒ…å’Œæ‹†åŒ…åŸºæœ¬ä»‹ç»"><a href="#9-1-TCP-ç²˜åŒ…å’Œæ‹†åŒ…åŸºæœ¬ä»‹ç»" class="headerlink" title="9.1 TCP ç²˜åŒ…å’Œæ‹†åŒ…åŸºæœ¬ä»‹ç»"></a>9.1 TCP ç²˜åŒ…å’Œæ‹†åŒ…åŸºæœ¬ä»‹ç»</h3><ol><li><code>TCP</code> æ˜¯é¢å‘è¿æ¥çš„ï¼Œé¢å‘æµçš„ï¼Œæä¾›é«˜å¯é æ€§æœåŠ¡ã€‚æ”¶å‘ä¸¤ç«¯ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ï¼‰éƒ½è¦æœ‰ä¸€ä¸€æˆå¯¹çš„ <code>socket</code>ï¼Œå› æ­¤ï¼Œå‘é€ç«¯ä¸ºäº†å°†å¤šä¸ªå‘ç»™æ¥æ”¶ç«¯çš„åŒ…ï¼Œæ›´æœ‰æ•ˆçš„å‘ç»™å¯¹æ–¹ï¼Œä½¿ç”¨äº†ä¼˜åŒ–æ–¹æ³•ï¼ˆ<code>Nagle</code> ç®—æ³•ï¼‰ï¼Œå°†å¤šæ¬¡é—´éš”è¾ƒå°ä¸”æ•°æ®é‡å°çš„æ•°æ®ï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°æ®å—ï¼Œç„¶åè¿›è¡Œå°åŒ…ã€‚è¿™æ ·åšè™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†æ˜¯æ¥æ”¶ç«¯å°±éš¾äºåˆ†è¾¨å‡ºå®Œæ•´çš„æ•°æ®åŒ…äº†ï¼Œå› ä¸ºé¢å‘æµçš„é€šä¿¡æ˜¯æ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œçš„</li><li>ç”±äº <code>TCP</code> æ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œ,éœ€è¦åœ¨æ¥æ”¶ç«¯å¤„ç†æ¶ˆæ¯è¾¹ç•Œé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç²˜åŒ…ã€æ‹†åŒ…é—®é¢˜,çœ‹ä¸€å¼ å›¾</li><li>ç¤ºæ„å›¾ <code>TCP</code> ç²˜åŒ…ã€æ‹†åŒ…å›¾è§£</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter09_01.png" alt="img"></p><p>å¯¹å›¾çš„è¯´æ˜: å‡è®¾å®¢æˆ·ç«¯åˆ†åˆ«å‘é€äº†ä¸¤ä¸ªæ•°æ®åŒ… <code>D1</code> å’Œ <code>D2</code> ç»™æœåŠ¡ç«¯ï¼Œç”±äºæœåŠ¡ç«¯ä¸€æ¬¡è¯»å–åˆ°å­—èŠ‚æ•°æ˜¯ä¸ç¡®å®šçš„ï¼Œæ•…å¯èƒ½å­˜åœ¨ä»¥ä¸‹å››ç§æƒ…å†µï¼š</p><ol><li>æœåŠ¡ç«¯åˆ†ä¸¤æ¬¡è¯»å–åˆ°äº†ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®åŒ…ï¼Œåˆ†åˆ«æ˜¯ <code>D1</code> å’Œ <code>D2</code>ï¼Œæ²¡æœ‰ç²˜åŒ…å’Œæ‹†åŒ…</li><li>æœåŠ¡ç«¯ä¸€æ¬¡æ¥å—åˆ°äº†ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œ<code>D1</code> å’Œ <code>D2</code> ç²˜åˆåœ¨ä¸€èµ·ï¼Œç§°ä¹‹ä¸º <code>TCP</code> ç²˜åŒ…</li><li>æœåŠ¡ç«¯åˆ†ä¸¤æ¬¡è¯»å–åˆ°äº†æ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡è¯»å–åˆ°äº†å®Œæ•´çš„ <code>D1</code> åŒ…å’Œ <code>D2</code> åŒ…çš„éƒ¨åˆ†å†…å®¹ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº† <code>D2</code> åŒ…çš„å‰©ä½™å†…å®¹ï¼Œè¿™ç§°ä¹‹ä¸º <code>TCP</code> æ‹†åŒ…</li><li>æœåŠ¡ç«¯åˆ†ä¸¤æ¬¡è¯»å–åˆ°äº†æ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡è¯»å–åˆ°äº† <code>D1</code> åŒ…çš„éƒ¨åˆ†å†…å®¹ <code>D1_1</code>ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº† <code>D1</code> åŒ…çš„å‰©ä½™éƒ¨åˆ†å†…å®¹ <code>D1_2</code> å’Œå®Œæ•´çš„ <code>D2</code> åŒ…ã€‚</li></ol><h3 id="9-2-TCP-ç²˜åŒ…å’Œæ‹†åŒ…ç°è±¡å®ä¾‹"><a href="#9-2-TCP-ç²˜åŒ…å’Œæ‹†åŒ…ç°è±¡å®ä¾‹" class="headerlink" title="9.2 TCP ç²˜åŒ…å’Œæ‹†åŒ…ç°è±¡å®ä¾‹"></a>9.2 TCP ç²˜åŒ…å’Œæ‹†åŒ…ç°è±¡å®ä¾‹</h3><p>åœ¨ç¼–å†™ <code>Netty</code> ç¨‹åºæ—¶ï¼Œå¦‚æœæ²¡æœ‰åšå¤„ç†ï¼Œå°±ä¼šå‘ç”Ÿç²˜åŒ…å’Œæ‹†åŒ…çš„é—®é¢˜</p><p>çœ‹ä¸€ä¸ªå…·ä½“çš„å®ä¾‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ ¸å¿ƒä»£ç </span>MyClientHandler.java<span class="hljs-keyword">package</span> com.atguigu.netty.tcp;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">ByteBuf</span>&gt; </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//ä½¿ç”¨å®¢æˆ·ç«¯å‘é€10æ¡æ•°æ® hello,server ç¼–å·</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;            ByteBuf buffer = Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello,server &quot;</span> + i, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>));            ctx.writeAndFlush(buffer);        &#125;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[msg.readableBytes()];        msg.readBytes(buffer);        String message = <span class="hljs-keyword">new</span> String(buffer, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>));        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯=&quot;</span> + message);        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯æ•°é‡=&quot;</span> + (++<span class="hljs-keyword">this</span>.count));    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        cause.printStackTrace();        ctx.close();    &#125;&#125;MyServerHandler.java<span class="hljs-keyword">package</span> com.atguigu.netty.tcp;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-keyword">import</span> java.util.UUID;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">ByteBuf</span>&gt; </span>&#123;        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//cause.printStackTrace();</span>        ctx.close();    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[msg.readableBytes()];        msg.readBytes(buffer);        <span class="hljs-comment">//å°†bufferè½¬æˆå­—ç¬¦ä¸²</span>        String message = <span class="hljs-keyword">new</span> String(buffer, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>));        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ•°æ® &quot;</span> + message);        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯é‡=&quot;</span> + (++<span class="hljs-keyword">this</span>.count));        <span class="hljs-comment">//æœåŠ¡å™¨å›é€æ•°æ®ç»™å®¢æˆ·ç«¯, å›é€ä¸€ä¸ªéšæœºid ,</span>        ByteBuf responseByteBuf = Unpooled.copiedBuffer(UUID.randomUUID().toString() + <span class="hljs-string">&quot; &quot;</span>, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>));        ctx.writeAndFlush(responseByteBuf);    &#125;&#125;</code></pre></div><h3 id="9-3-TCP-ç²˜åŒ…å’Œæ‹†åŒ…è§£å†³æ–¹æ¡ˆ"><a href="#9-3-TCP-ç²˜åŒ…å’Œæ‹†åŒ…è§£å†³æ–¹æ¡ˆ" class="headerlink" title="9.3 TCP ç²˜åŒ…å’Œæ‹†åŒ…è§£å†³æ–¹æ¡ˆ"></a>9.3 TCP ç²˜åŒ…å’Œæ‹†åŒ…è§£å†³æ–¹æ¡ˆ</h3><ol><li>ä½¿ç”¨è‡ªå®šä¹‰åè®®+ç¼–è§£ç å™¨æ¥è§£å†³</li><li>å…³é”®å°±æ˜¯è¦è§£å†³æœåŠ¡å™¨ç«¯æ¯æ¬¡è¯»å–æ•°æ®é•¿åº¦çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜è§£å†³ï¼Œå°±ä¸ä¼šå‡ºç°æœåŠ¡å™¨å¤šè¯»æˆ–å°‘è¯»æ•°æ®çš„é—®é¢˜ï¼Œä»è€Œé¿å…çš„ <code>TCP</code> ç²˜åŒ…ã€æ‹†åŒ…ã€‚</li></ol><h3 id="9-4-çœ‹ä¸€ä¸ªå…·ä½“çš„å®ä¾‹"><a href="#9-4-çœ‹ä¸€ä¸ªå…·ä½“çš„å®ä¾‹" class="headerlink" title="9.4 çœ‹ä¸€ä¸ªå…·ä½“çš„å®ä¾‹"></a>9.4 çœ‹ä¸€ä¸ªå…·ä½“çš„å®ä¾‹</h3><ol><li>è¦æ±‚å®¢æˆ·ç«¯å‘é€ <code>5</code> ä¸ª <code>Message</code> å¯¹è±¡ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡å‘é€ä¸€ä¸ª <code>Message</code> å¯¹è±¡</li><li>æœåŠ¡å™¨ç«¯æ¯æ¬¡æ¥æ”¶ä¸€ä¸ª <code>Message</code>ï¼Œåˆ† <code>5</code> æ¬¡è¿›è¡Œè§£ç ï¼Œæ¯è¯»å–åˆ°ä¸€ä¸ª <code>Message</code>ï¼Œä¼šå›å¤ä¸€ä¸ª <code>Message</code> å¯¹è±¡ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter09_02.png" alt="img"></p><ol><li>ä»£ç æ¼”ç¤ºï¼Œå…¨éƒ¨ä»£ç æ ¸å¿ƒ</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æ ¸å¿ƒ</span><span class="hljs-keyword">package</span> com.atguigu.netty.protocoltcp;<span class="hljs-comment">//åè®®åŒ…</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageProtocol</span> </span>&#123;        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> len; <span class="hljs-comment">//å…³é”®</span>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] content;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getLen</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> len;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLen</span><span class="hljs-params">(<span class="hljs-keyword">int</span> len)</span> </span>&#123;        <span class="hljs-keyword">this</span>.len = len;    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getContent() &#123;        <span class="hljs-keyword">return</span> content;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContent</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] content)</span> </span>&#123;        <span class="hljs-keyword">this</span>.content = content;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.protocoltcp;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">MessageProtocol</span>&gt; </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//ä½¿ç”¨å®¢æˆ·ç«¯å‘é€10æ¡æ•°æ® &quot;ä»Šå¤©å¤©æ°”å†·ï¼Œåƒç«é”…&quot; ç¼–å·</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;            String mes = <span class="hljs-string">&quot;ä»Šå¤©å¤©æ°”å†·ï¼Œåƒç«é”…&quot;</span>;            <span class="hljs-keyword">byte</span>[] content = mes.getBytes(Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>));            <span class="hljs-keyword">int</span> length = mes.getBytes(Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>)).length;            <span class="hljs-comment">//åˆ›å»ºåè®®åŒ…å¯¹è±¡</span>            MessageProtocol messageProtocol = <span class="hljs-keyword">new</span> MessageProtocol();            messageProtocol.setLen(length);            messageProtocol.setContent(content);            ctx.writeAndFlush(messageProtocol);        &#125;    &#125;    <span class="hljs-comment">//    @Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">int</span> len = msg.getLen();        <span class="hljs-keyword">byte</span>[] content = msg.getContent();        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯å¦‚ä¸‹&quot;</span>);        System.out.println(<span class="hljs-string">&quot;é•¿åº¦=&quot;</span> + len);        System.out.println(<span class="hljs-string">&quot;å†…å®¹=&quot;</span> + <span class="hljs-keyword">new</span> String(content, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>)));        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯æ•°é‡=&quot;</span> + (++<span class="hljs-keyword">this</span>.count));    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;å¼‚å¸¸æ¶ˆæ¯=&quot;</span> + cause.getMessage());        ctx.close();    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.protocoltcp;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.handler.codec.MessageToByteEncoder;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyMessageEncoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MessageToByteEncoder</span>&lt;<span class="hljs-title">MessageProtocol</span>&gt; </span>&#123;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">encode</span><span class="hljs-params">(ChannelHandlerContext ctx, MessageProtocol msg, ByteBuf out)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;MyMessageEncoder encode æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);        out.writeInt(msg.getLen());        out.writeBytes(msg.getContent());    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.protocoltcp;<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.handler.codec.ReplayingDecoder;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyMessageDecoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ReplayingDecoder</span>&lt;<span class="hljs-title">Void</span>&gt; </span>&#123;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot;MyMessageDecoder decode è¢«è°ƒç”¨&quot;</span>);        <span class="hljs-comment">//éœ€è¦å°†å¾—åˆ°äºŒè¿›åˆ¶å­—èŠ‚ç -&gt; MessageProtocol æ•°æ®åŒ…(å¯¹è±¡)</span>        <span class="hljs-keyword">int</span> length = in.readInt();        <span class="hljs-keyword">byte</span>[] content = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length];        in.readBytes(content);        <span class="hljs-comment">//å°è£…æˆ MessageProtocol å¯¹è±¡ï¼Œæ”¾å…¥ outï¼Œ ä¼ é€’ä¸‹ä¸€ä¸ªhandlerä¸šåŠ¡å¤„ç†</span>        MessageProtocol messageProtocol = <span class="hljs-keyword">new</span> MessageProtocol();        messageProtocol.setLen(length);        messageProtocol.setContent(content);        out.add(messageProtocol);    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.protocoltcp;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-keyword">import</span> java.util.UUID;<span class="hljs-comment">//å¤„ç†ä¸šåŠ¡çš„handler</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">MessageProtocol</span>&gt; </span>&#123;        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//cause.printStackTrace();</span>        ctx.close();    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//æ¥æ”¶åˆ°æ•°æ®ï¼Œå¹¶å¤„ç†</span>        <span class="hljs-keyword">int</span> len = msg.getLen();        <span class="hljs-keyword">byte</span>[] content = msg.getContent();        System.out.println();        System.out.println();        System.out.println();        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°ä¿¡æ¯å¦‚ä¸‹&quot;</span>);        System.out.println(<span class="hljs-string">&quot;é•¿åº¦=&quot;</span> + len);        System.out.println(<span class="hljs-string">&quot;å†…å®¹=&quot;</span> + <span class="hljs-keyword">new</span> String(content, Charset.forName(<span class="hljs-string">&quot;utf-8&quot;</span>)));        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯åŒ…æ•°é‡=&quot;</span> + (++<span class="hljs-keyword">this</span>.count));        <span class="hljs-comment">//å›å¤æ¶ˆæ¯</span>        String responseContent = UUID.randomUUID().toString();        <span class="hljs-keyword">int</span> responseLen = responseContent.getBytes(<span class="hljs-string">&quot;utf-8&quot;</span>).length;        <span class="hljs-keyword">byte</span>[] responseContent2 = responseContent.getBytes(<span class="hljs-string">&quot;utf-8&quot;</span>);        <span class="hljs-comment">//æ„å»ºä¸€ä¸ªåè®®åŒ…</span>        MessageProtocol messageProtocol = <span class="hljs-keyword">new</span> MessageProtocol();        messageProtocol.setLen(responseLen);        messageProtocol.setContent(responseContent2);        ctx.writeAndFlush(messageProtocol);    &#125;&#125;</code></pre></div><h2 id="10-Netty-æ ¸å¿ƒæºç å‰–æ"><a href="#10-Netty-æ ¸å¿ƒæºç å‰–æ" class="headerlink" title="10 Netty æ ¸å¿ƒæºç å‰–æ"></a>10 Netty æ ¸å¿ƒæºç å‰–æ</h2><h3 id="10-1-åŸºæœ¬è¯´æ˜"><a href="#10-1-åŸºæœ¬è¯´æ˜" class="headerlink" title="10.1 åŸºæœ¬è¯´æ˜"></a>10.1 åŸºæœ¬è¯´æ˜</h3><ol><li>åªæœ‰çœ‹è¿‡ <code>Netty</code> æºç ï¼Œæ‰èƒ½è¯´æ˜¯çœŸçš„æŒæ¡äº† <code>Netty</code> æ¡†æ¶ã€‚</li><li>åœ¨ <code>io.netty.example</code> åŒ…ä¸‹ï¼Œæœ‰å¾ˆå¤š <code>Netty</code> æºç æ¡ˆä¾‹ï¼Œå¯ä»¥ç”¨æ¥åˆ†æã€‚</li><li>æºç åˆ†æç« èŠ‚æ˜¯é’ˆå¯¹æœ‰ <code>Java</code> é¡¹ç›®ç»éªŒï¼Œå¹¶ä¸”ç©è¿‡æ¡†æ¶æºç çš„äººå‘˜è®²çš„ï¼Œå¦åˆ™ä½ å¬èµ·æ¥ä¼šæœ‰ç›¸å½“çš„éš¾åº¦ã€‚</li></ol><h3 id="10-2-Netty-å¯åŠ¨è¿‡ç¨‹æºç å‰–æ"><a href="#10-2-Netty-å¯åŠ¨è¿‡ç¨‹æºç å‰–æ" class="headerlink" title="10.2 Netty å¯åŠ¨è¿‡ç¨‹æºç å‰–æ"></a>10.2 Netty å¯åŠ¨è¿‡ç¨‹æºç å‰–æ</h3><h4 id="10-2-1-æºç å‰–æç›®çš„"><a href="#10-2-1-æºç å‰–æç›®çš„" class="headerlink" title="10.2.1 æºç å‰–æç›®çš„"></a>10.2.1 æºç å‰–æç›®çš„</h4><p>ç”¨æºç åˆ†æçš„æ–¹å¼èµ°ä¸€ä¸‹ <code>Netty</code>ï¼ˆæœåŠ¡å™¨ï¼‰çš„å¯åŠ¨è¿‡ç¨‹ï¼Œæ›´å¥½çš„ç†è§£ <code>Netty</code> çš„æ•´ä½“è®¾è®¡å’Œè¿è¡Œæœºåˆ¶ã€‚</p><h4 id="10-2-2-æºç å‰–æ"><a href="#10-2-2-æºç å‰–æ" class="headerlink" title="10.2.2 æºç å‰–æ"></a>10.2.2 æºç å‰–æ</h4><p>è¯´æ˜ï¼š</p><ol><li>æºç éœ€è¦å‰–æåˆ° <code>Netty</code> è°ƒç”¨ <code>doBind</code> æ–¹æ³•ï¼Œè¿½è¸ªåˆ° <code>NioServerSocketChannel</code> çš„ <code>doBind</code>ã€‚</li><li>å¹¶ä¸”è¦ <code>Debug</code> ç¨‹åºåˆ° <code>NioEventLoop</code> ç±»çš„ <code>run</code> ä»£ç ï¼Œæ— é™å¾ªç¯ï¼Œåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œã€‚</li></ol><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_01.png" alt="img"></p><h4 id="10-2-3-æºç å‰–æè¿‡ç¨‹"><a href="#10-2-3-æºç å‰–æè¿‡ç¨‹" class="headerlink" title="10.2.3 æºç å‰–æè¿‡ç¨‹"></a>10.2.3 æºç å‰–æè¿‡ç¨‹</h4><p><strong>1. <code>demo</code> æºç çš„åŸºæœ¬ç†è§£</strong></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// æœåŠ¡å™¨å¯åŠ¨ç±»æºç </span><span class="hljs-comment">/*</span><span class="hljs-comment"> * Copyright 2012 The Netty Project</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * The Netty Project licenses this file to you under the Apache License,</span><span class="hljs-comment"> * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance</span><span class="hljs-comment"> * with the License. You may obtain a copy of the License at:</span><span class="hljs-comment"> *</span><span class="hljs-comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><span class="hljs-comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span><span class="hljs-comment"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span><span class="hljs-comment"> * License for the specific language governing permissions and limitations</span><span class="hljs-comment"> * under the License.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">package</span> atguigu.netty.example.echo2;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;<span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;<span class="hljs-keyword">import</span> io.netty.handler.ssl.SslContext;<span class="hljs-keyword">import</span> io.netty.handler.ssl.SslContextBuilder;<span class="hljs-keyword">import</span> io.netty.handler.ssl.util.SelfSignedCertificate;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Echoes back any received data from a client.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoServer</span> </span>&#123;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> SSL = System.getProperty(<span class="hljs-string">&quot;ssl&quot;</span>) != <span class="hljs-keyword">null</span>;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PORT = Integer.parseInt(System.getProperty(<span class="hljs-string">&quot;port&quot;</span>, <span class="hljs-string">&quot;8007&quot;</span>));    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">// Configure SSL.</span>        <span class="hljs-keyword">final</span> SslContext sslCtx;        <span class="hljs-keyword">if</span> (SSL) &#123;            SelfSignedCertificate ssc = <span class="hljs-keyword">new</span> SelfSignedCertificate();            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();        &#125; <span class="hljs-keyword">else</span> &#123;            sslCtx = <span class="hljs-keyword">null</span>;        &#125;        <span class="hljs-comment">// Configure the server.</span>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap b = <span class="hljs-keyword">new</span> ServerBootstrap();            b.group(bossGroup, workerGroup)                    .channel(NioServerSocketChannel.class)                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">100</span>)                    .handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO))                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                        <span class="hljs-meta">@Override</span>                        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                            ChannelPipeline p = ch.pipeline();                            <span class="hljs-keyword">if</span> (sslCtx != <span class="hljs-keyword">null</span>) &#123;                                p.addLast(sslCtx.newHandler(ch.alloc()));                            &#125;                            <span class="hljs-comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>                            p.addLast(<span class="hljs-keyword">new</span> EchoServerHandler());                        &#125;                    &#125;);            <span class="hljs-comment">// Start the server.</span>            ChannelFuture f = b.bind(PORT).sync();            <span class="hljs-comment">// Wait until the server socket is closed.</span>            f.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            <span class="hljs-comment">// Shut down all event loops to terminate all threads.</span>            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><ol><li>å…ˆçœ‹å¯åŠ¨ç±»ï¼š<code>main</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†å…³äº SSL çš„é…ç½®ç±»ã€‚</li><li>é‡ç‚¹åˆ†æä¸‹åˆ›å»ºäº†ä¸¤ä¸ª <code>EventLoopGroup</code> å¯¹è±¡ï¼š</li></ol><div class="code-wrapper"><pre><code class="hljs java">EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();</code></pre></div><p>(1) è¿™ä¸¤ä¸ªå¯¹è±¡æ˜¯æ•´ä¸ª <code>Netty</code> çš„æ ¸å¿ƒå¯¹è±¡ï¼Œå¯ä»¥è¯´ï¼Œæ•´ä¸ª <code>Netty</code> çš„è¿ä½œéƒ½ä¾èµ–äºä»–ä»¬ã€‚<code>bossGroup</code> ç”¨äºæ¥å— <code>TCP</code> è¯·æ±‚ï¼Œä»–ä¼šå°†è¯·æ±‚äº¤ç»™ <code>workerGroup</code>ï¼Œ<code>workerGroup</code> ä¼šè·å–åˆ°çœŸæ­£çš„è¿æ¥ï¼Œç„¶åå’Œè¿æ¥è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚è¯»å†™è§£ç ç¼–ç ç­‰æ“ä½œã€‚</p><p>(2) <code>EventLoopGroup</code> æ˜¯äº‹ä»¶å¾ªç¯ç»„ï¼ˆçº¿ç¨‹ç»„ï¼‰å«æœ‰å¤šä¸ª <code>EventLoop</code>ï¼Œå¯ä»¥æ³¨å†Œ <code>channel</code>ï¼Œç”¨äºåœ¨äº‹ä»¶å¾ªç¯ä¸­å»è¿›è¡Œé€‰æ‹©ï¼ˆå’Œé€‰æ‹©å™¨ç›¸å…³ï¼‰ã€‚ã€debugçœ‹ã€‘</p><p>(3) <code>new NioEventLoopGroup(1);</code> è¿™ä¸ª <code>1</code> è¡¨ç¤º <code>bossGroup</code> äº‹ä»¶ç»„æœ‰ <code>1</code> ä¸ªçº¿ç¨‹ä½ å¯ä»¥æŒ‡å®šï¼Œå¦‚æœ <code>new NioEventLoopGroup()</code> ä¼šå«æœ‰é»˜è®¤ä¸ªçº¿ç¨‹ <code>cpuæ ¸æ•° * 2</code>ï¼Œå³å¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿ï¼Œã€å¯ä»¥dubugä¸€æŠŠã€‘</p><div class="code-wrapper"><pre><code class="hljs java">DEFAULT_EVENT_LOOP_THREADS = Math.max(<span class="hljs-number">1</span>, SystemPropertyUtil.getInt(<span class="hljs-string">&quot;io.netty.eventLoopThreads&quot;</span>, NettyRuntime.availableProcessors() * <span class="hljs-number">2</span>));</code></pre></div><p>ä¼šåˆ›å»º <code>EventExecutor</code> æ•°ç»„ <code>children = new EventExecutor[nThreads];</code> // <code>debug</code> ä¸€ä¸‹æ¯ä¸ªå…ƒç´ çš„ç±»å‹å°±æ˜¯ <code>NIOEventLoop</code>ï¼Œ<code>NIOEventLoop</code> å®ç°äº† <code>EventLoop</code> æ¥å£å’Œ <code>Executor</code> æ¥å£ <code>try</code> å—ä¸­åˆ›å»ºäº†ä¸€ä¸ª <code>ServerBootstrap</code> å¯¹è±¡ï¼Œä»–æ˜¯ä¸€ä¸ªå¼•å¯¼ç±»ï¼Œç”¨äºå¯åŠ¨æœåŠ¡å™¨å’Œå¼•å¯¼æ•´ä¸ªç¨‹åºçš„åˆå§‹åŒ–ï¼ˆçœ‹ä¸‹æºç  <code>allowseasybootstrapof&#123;@linkServerChannel&#125;</code>ï¼‰ã€‚å®ƒå’Œ <code>ServerChannel</code> å…³è”ï¼Œè€Œ <code>ServerChannel</code> ç»§æ‰¿äº† <code>Channel</code>ï¼Œæœ‰ä¸€äº›æ–¹æ³• <code>remoteAddress</code> ç­‰[å¯ä»¥Debugä¸‹]éšåï¼Œå˜é‡ <code>b</code> è°ƒç”¨äº† <code>group</code> æ–¹æ³•å°†ä¸¤ä¸ª <code>group</code> æ”¾å…¥äº†è‡ªå·±çš„å­—æ®µä¸­ï¼Œç”¨äºåæœŸå¼•å¯¼ä½¿ç”¨ã€<code>debug</code> ä¸‹ <code>group</code> æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> *Set the &#123;<span class="hljs-doctag">@link</span> EventLoopGroup&#125; for the parent (acceptor) and the child (client) . These</span><span class="hljs-comment"> *&#123;<span class="hljs-doctag">@link</span> EventLoopGroup&#125;&#x27;s are used to handle all the events and IO for &#123;<span class="hljs-doctag">@link</span> ServerChannel&#125; and </span><span class="hljs-comment"> *&#123;<span class="hljs-doctag">@link</span> Channel&#125;&#x27;s.</span><span class="hljs-comment"> */</span></code></pre></div><p>ã€‘ã€‚</p><p>(4) ç„¶åæ·»åŠ äº†ä¸€ä¸ª <code>channel</code>ï¼Œå…¶ä¸­å‚æ•°ä¸€ä¸ª <code>Class</code> å¯¹è±¡ï¼Œå¼•å¯¼ç±»å°†é€šè¿‡è¿™ä¸ª <code>Class</code> å¯¹è±¡åå°„åˆ›å»º <code>ChannelFactory</code>ã€‚ç„¶åæ·»åŠ äº†ä¸€äº› <code>TCP</code> çš„å‚æ•°ã€‚ã€è¯´æ˜ï¼š<code>Channel</code> çš„åˆ›å»ºåœ¨ <code>bind</code> æ–¹æ³•ï¼Œå¯ä»¥ <code>Debug</code> ä¸‹ <code>bind</code>ï¼Œä¼šæ‰¾åˆ° <code>channel = channelFactory.newChannel();</code> ã€‘</p><p>(5) å†æ·»åŠ äº†ä¸€ä¸ªæœåŠ¡å™¨ä¸“å±çš„æ—¥å¿—å¤„ç†å™¨ <code>handler</code> ã€‚</p><p>(6) å†æ·»åŠ ä¸€ä¸ª <code>SocketChannel</code>ï¼ˆä¸æ˜¯ <code>ServerSocketChannel</code>ï¼‰çš„ <code>handler</code>ã€‚</p><p>(7) ç„¶åç»‘å®šç«¯å£å¹¶é˜»å¡è‡³è¿æ¥æˆåŠŸã€‚</p><p>(8) æœ€å <code>main</code> çº¿ç¨‹é˜»å¡ç­‰å¾…å…³é—­ã€‚</p><p>(9) <code>finally</code> å—ä¸­çš„ä»£ç å°†åœ¨æœåŠ¡å™¨å…³é—­æ—¶ä¼˜é›…å…³é—­æ‰€æœ‰èµ„æºã€‚</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/*</span><span class="hljs-comment"> * Copyright 2012 The Netty Project</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * The Netty Project licenses this file to you under the Apache License,</span><span class="hljs-comment"> * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance</span><span class="hljs-comment"> * with the License. You may obtain a copy of the License at:</span><span class="hljs-comment"> *</span><span class="hljs-comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><span class="hljs-comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span><span class="hljs-comment"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span><span class="hljs-comment"> * License for the specific language governing permissions and limitations</span><span class="hljs-comment"> * under the License.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">package</span> atguigu.netty.example.echo2;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandler.Sharable;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Handler implementation for the echo server.</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Sharable</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;        ctx.write(msg);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> </span>&#123;        ctx.flush();    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;        <span class="hljs-comment">// Close the connection when an exception is raised.</span>        cause.printStackTrace();        ctx.close();    &#125;&#125;</code></pre></div><p>è¯´æ˜:</p><ol><li>è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„å¤„ç†å™¨ç±»ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯å‘é€æ¥çš„æ¶ˆæ¯ï¼Œåœ¨æˆ‘ä»¬è¿™é‡Œï¼Œæˆ‘ä»¬ç®€å•çš„è§£æå‡ºå®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„å†…å®¹ï¼Œç„¶åæ‰“å°ï¼Œæœ€åå‘é€å­—ç¬¦ä¸²ç»™å®¢æˆ·ç«¯ã€‚</li><li>å¤§è‡´è®²è§£äº†æˆ‘ä»¬çš„ <code>demo</code> æºç çš„ä½œç”¨ã€‚åé¢çš„ <code>debug</code> çš„æ—¶å€™ä¼šè¯¦ç»†ã€‚</li></ol><p><strong>2. åˆ†æ EventLoopGroup çš„è¿‡ç¨‹</strong></p><p>2.1 æ„é€ å™¨æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NioEventLoopGroup</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads)</span> </span>&#123;     <span class="hljs-keyword">this</span>(nThreads, (Executor) <span class="hljs-keyword">null</span>);&#125;</code></pre></div><p>2.2 ä¸Šé¢çš„ <code>this(nThreads, (Executor) null);</code> è°ƒç”¨æ„é€ å™¨ï¼ˆé€šè¿‡ <code>alt + d</code> çœ‹å³å¯ï¼‰</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NioEventLoopGroup</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, Executor executor)</span> </span>&#123;    <span class="hljs-keyword">this</span>(nThreads, executor, SelectorProvider.provider());&#125;</code></pre></div><p>2.3 ä¸Šé¢çš„ <code>this(nThreads, executor, SelectorProvider.provider());</code> è°ƒç”¨ä¸‹é¢æ„é€ å™¨</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NioEventLoopGroup</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, Executor executor, <span class="hljs-keyword">final</span> SelectorProvider selectorProvider)</span> </span>&#123;    <span class="hljs-keyword">this</span>(nThreads, executor, selectorProvider,DefaultSelectStrategyFactory.INSTANCE);&#125;</code></pre></div><p>2.4 ä¸Šé¢çš„ <code>this()...</code> è°ƒç”¨æ„é€ å™¨ï¼ˆ<code>alt + d</code>ï¼‰</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NioEventLoopGroup</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, Executor executor, <span class="hljs-keyword">final</span> SelectorProvider selectorProvider,<span class="hljs-keyword">final</span> SelectStrategyFactory selectStrategyFactory)</span> </span>&#123;    <span class="hljs-keyword">super</span>(nThreads, executor, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());&#125;</code></pre></div><p>2.5 ä¸Šé¢çš„ <code>super()..</code> çš„æ–¹æ³•æ˜¯çˆ¶ç±»ï¼š<code>MultithreadEventLoopGroup</code></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">MultithreadEventLoopGroup</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, Executor executor, Object...args)</span> </span>&#123;    <span class="hljs-keyword">super</span>(nThreads == <span class="hljs-number">0</span> ? DEFAULT_EVENT_LOOP_THREADS : nThreads, executor, args);&#125;</code></pre></div><p>2.6 è¿½è¸ªåˆ°æºç æŠ½è±¡ç±» <code>MultithreadEventExecutorGroup</code> çš„æ„é€ å™¨æ–¹æ³• <code>MultithreadEventExecutorGroup</code> æ‰æ˜¯ <code>NioEventLoopGroup</code> çœŸæ­£çš„æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œä½¿ç”¨äº†è®¾è®¡æ¨¡å¼çš„æ¨¡æ¿æ¨¡å¼ï¼ˆå¯çœ‹æˆ‘å½•åˆ¶è§†é¢‘ï¼‰ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°±éœ€è¦å¥½å¥½åˆ†æ <code>MultithreadEventExecutorGroup</code> æ–¹æ³•äº†</p><p>2.7 åˆ†æ <code>MultithreadEventExecutorGroup</code></p><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>@param nThreads</code> ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º <code>core * 2</code>ã€å¯ä»¥è¿½è¸ªæºç ã€‘</li><li><code>@param executor</code> æ‰§è¡Œå™¨:å¦‚æœä¼ å…¥ <code>null</code>, åˆ™é‡‡ç”¨ <code>Netty</code> é»˜è®¤çš„çº¿ç¨‹å·¥å‚å’Œé»˜è®¤çš„æ‰§è¡Œå™¨ <code>ThreadPerTaskExecutor</code></li><li><code>@param chooserFactory</code> å•ä¾‹ <code>new DefaultEventExecutorChooserFactory()</code></li><li><code>@param args args</code> åœ¨åˆ›å»ºæ‰§è¡Œå™¨çš„æ—¶å€™ä¼ å…¥å›ºå®šå‚æ•°</li></ul><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">MultithreadEventExecutorGroup</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, Executor executor,</span></span><span class="hljs-function"><span class="hljs-params">                                        EventExecutorChooserFactory chooserFactory, Object... args)</span> </span>&#123;    <span class="hljs-keyword">if</span> (nThreads &lt;= <span class="hljs-number">0</span>) &#123;        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(String.format(<span class="hljs-string">&quot;nThreads: %d (expected: &gt; 0)&quot;</span>, nThreads));    &#125;    <span class="hljs-keyword">if</span> (executor == <span class="hljs-keyword">null</span>) &#123; <span class="hljs-comment">// å¦‚æœä¼ å…¥çš„æ‰§è¡Œå™¨æ˜¯ç©ºçš„åˆ™é‡‡ç”¨é»˜è®¤çš„çº¿ç¨‹å·¥å‚å’Œé»˜è®¤çš„æ‰§è¡Œå™¨</span>        executor = <span class="hljs-keyword">new</span> ThreadPerTaskExecutor(newDefaultThreadFactory());    &#125;    <span class="hljs-comment">// åˆ›å»ºæŒ‡å®šçº¿ç¨‹æ•°çš„æ‰§è¡Œå™¨æ•°ç»„</span>    children = <span class="hljs-keyword">new</span> EventExecutor[nThreads];    <span class="hljs-comment">// åˆå§‹åŒ–çº¿ç¨‹æ•°ç»„</span>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; nThreads; i ++) &#123;        <span class="hljs-keyword">boolean</span> success = <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// åˆ›å»º new NioEventLoop</span>            children[i] = newChild(executor, args);            success = <span class="hljs-keyword">true</span>;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Think about if this is a good exception type</span>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;failed to create a child event loop&quot;</span>, e);        &#125; <span class="hljs-keyword">finally</span> &#123;            <span class="hljs-comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼˜é›…å…³é—­</span>            <span class="hljs-keyword">if</span> (!success) &#123;                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; i; j ++) &#123;                    children[j].shutdownGracefully();                &#125;                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; i; j ++) &#123;                    EventExecutor e = children[j];                    <span class="hljs-keyword">try</span> &#123;                        <span class="hljs-keyword">while</span> (!e.isTerminated()) &#123;                            e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);                        &#125;                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException interrupted) &#123;                        <span class="hljs-comment">// Let the caller handle the interruption.</span>                        Thread.currentThread().interrupt();                        <span class="hljs-keyword">break</span>;                    &#125;                &#125;            &#125;        &#125;    &#125;    chooser = chooserFactory.newChooser(children);    <span class="hljs-keyword">final</span> FutureListener&lt;Object&gt; terminationListener = <span class="hljs-keyword">new</span> FutureListener&lt;Object&gt;() &#123;        <span class="hljs-meta">@Override</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">operationComplete</span><span class="hljs-params">(Future&lt;Object&gt; future)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;            <span class="hljs-keyword">if</span> (terminatedChildren.incrementAndGet() == children.length) &#123;                terminationFuture.setSuccess(<span class="hljs-keyword">null</span>);            &#125;        &#125;    &#125;;        <span class="hljs-comment">// ä¸ºæ¯ä¸€ä¸ªå•ä¾‹çº¿ç¨‹æ± æ·»åŠ ä¸€ä¸ªå…³é—­ç›‘å¬å™¨</span>    <span class="hljs-keyword">for</span> (EventExecutor e: children) &#123;        e.terminationFuture().addListener(terminationListener);    &#125;    Set&lt;EventExecutor&gt; childrenSet = <span class="hljs-keyword">new</span> LinkedHashSet&lt;EventExecutor&gt;(children.length);    <span class="hljs-comment">//å°†æ‰€æœ‰çš„å•ä¾‹çº¿ç¨‹æ± æ·»åŠ åˆ°ä¸€ä¸ª HashSet ä¸­ã€‚</span>    Collections.addAll(childrenSet, children);    readonlyChildren = Collections.unmodifiableSet(childrenSet);&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><ol><li>å¦‚æœ <code>executor</code> æ˜¯ <code>null</code>ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ <code>ThreadPerTaskExecutor</code>ï¼Œä½¿ç”¨ <code>Netty</code> é»˜è®¤çš„çº¿ç¨‹å·¥å‚ã€‚</li><li>æ ¹æ®ä¼ å…¥çš„çº¿ç¨‹æ•°ï¼ˆ<code>CPU * 2</code>ï¼‰åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆå•ä¾‹çº¿ç¨‹æ± ï¼‰æ•°ç»„ã€‚</li><li>å¾ªç¯å¡«å……æ•°ç»„ä¸­çš„å…ƒç´ ã€‚å¦‚æœå¼‚å¸¸ï¼Œåˆ™å…³é—­æ‰€æœ‰çš„å•ä¾‹çº¿ç¨‹æ± ã€‚</li><li>æ ¹æ®çº¿ç¨‹é€‰æ‹©å·¥å‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹é€‰æ‹©å™¨ã€‚</li><li>ä¸ºæ¯ä¸€ä¸ªå•ä¾‹çº¿ç¨‹æ± æ·»åŠ ä¸€ä¸ªå…³é—­ç›‘å¬å™¨ã€‚</li><li>å°†æ‰€æœ‰çš„å•ä¾‹çº¿ç¨‹æ± æ·»åŠ åˆ°ä¸€ä¸ª <code>HashSet</code> ä¸­ã€‚</li></ol><p><strong>3. ServerBootstrap åˆ›å»ºå’Œæ„é€ è¿‡ç¨‹</strong></p><p>3.1 <code>ServerBootstrap</code> æ˜¯ä¸ªç©ºæ„é€ ï¼Œä½†æ˜¯æœ‰é»˜è®¤çš„æˆå‘˜å˜é‡</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;ChannelOption&lt;?&gt;, Object&gt; childOptions = <span class="hljs-keyword">new</span> LinkedHashMap&lt;ChannelOption&lt;?&gt;, Object&gt;();<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;AttributeKey&lt;?&gt;, Object&gt; childAttrs = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;AttributeKey&lt;?&gt;, Object&gt;();<span class="hljs-comment">// config å¯¹è±¡ï¼Œä¼šåœ¨åé¢èµ·å¾ˆå¤§ä½œç”¨</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerBootstrapConfig config = <span class="hljs-keyword">new</span> ServerBootstrapConfig(<span class="hljs-keyword">this</span>);<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> EventLoopGroup childGroup;<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> ChannelHandler childHandler;</code></pre></div><p>3.2 åˆ†æä¸€ä¸‹ <code>ServerBootstrap</code> åŸºæœ¬ä½¿ç”¨æƒ…å†µ</p><div class="code-wrapper"><pre><code class="hljs java">ServerBootstrap b = <span class="hljs-keyword">new</span> ServerBootstrap();b.group(bossGroup, workerGroup)        .channel(NioServerSocketChannel.class)        .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">100</span>)        .handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO))        .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                ChannelPipeline p = ch.pipeline();                <span class="hljs-keyword">if</span> (sslCtx != <span class="hljs-keyword">null</span>) &#123;                    p.addLast(sslCtx.newHandler(ch.alloc()));                &#125;                <span class="hljs-comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>                p.addLast(<span class="hljs-keyword">new</span> EchoServerHandler());            &#125;        &#125;);</code></pre></div><p>è¯´æ˜:</p><ol><li>é“¾å¼è°ƒç”¨ï¼š<code>group</code> æ–¹æ³•ï¼Œå°† <code>boss</code> å’Œ <code>worker</code> ä¼ å…¥ï¼Œ<code>boss</code> èµ‹å€¼ç»™ <code>parentGroup</code> å±æ€§, <code>worker</code> èµ‹å€¼ç»™ <code>childGroup</code> å±æ€§ã€‚</li><li><code>channel</code> æ–¹æ³•ä¼ å…¥ <code>NioServerSocketChannelclass</code> å¯¹è±¡ã€‚ä¼šæ ¹æ®è¿™ä¸ª <code>class</code> åˆ›å»º <code>channel</code> å¯¹è±¡ã€‚</li><li><code>option</code> æ–¹æ³•ä¼ å…¥ <code>TCP</code> å‚æ•°ï¼Œæ”¾åœ¨ä¸€ä¸ª <code>LinkedHashMap</code> ä¸­ã€‚</li><li><code>handler</code> æ–¹æ³•ä¼ å…¥ä¸€ä¸ª <code>handler</code> ä¸­ï¼Œè¿™ä¸ª <code>hanlder</code> åªä¸“å±äº <code>ServerSocketChannel</code> è€Œä¸æ˜¯ <code>SocketChannel</code>ã€‚</li><li><code>childHandler</code> ä¼ å…¥ä¸€ä¸ª <code>hanlder</code>ï¼Œè¿™ä¸ª <code>handler</code> å°†ä¼šåœ¨æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™è°ƒç”¨ã€‚ä¾› <code>SocketChannel</code> ä½¿ç”¨ã€‚</li></ol><p><strong>4. ç»‘å®šç«¯å£çš„åˆ†æ</strong></p><p>4.1 æœåŠ¡å™¨å°±æ˜¯åœ¨è¿™ä¸ª <code>bind</code> æ–¹æ³•é‡Œå¯åŠ¨å®Œæˆçš„ 4.2 <code>bind</code> æ–¹æ³•ä»£ç ,è¿½è¸ªåˆ°åˆ›å»ºäº†ä¸€ä¸ªç«¯å£å¯¹è±¡ï¼Œå¹¶åšäº†ä¸€äº›ç©ºåˆ¤æ–­ï¼Œæ ¸å¿ƒä»£ç  <code>doBind</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ChannelFuture <span class="hljs-title">bind</span><span class="hljs-params">(SocketAddress localAddress)</span> </span>&#123;    validate();    <span class="hljs-keyword">if</span> (localAddress == <span class="hljs-keyword">null</span>) &#123;        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException(<span class="hljs-string">&quot;localAddress&quot;</span>);    &#125;    <span class="hljs-keyword">return</span> doBind(localAddress);&#125;</code></pre></div><p>4.3 <code>doBind</code> æºç å‰–æï¼Œæ ¸å¿ƒæ˜¯ä¸¤ä¸ªæ–¹æ³• <code>initAndRegister</code> å’Œ <code>doBind0</code></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> ChannelFuture <span class="hljs-title">doBind</span><span class="hljs-params">(<span class="hljs-keyword">final</span> SocketAddress localAddress)</span> </span>&#123;    <span class="hljs-keyword">final</span> ChannelFuture regFuture = initAndRegister();    <span class="hljs-keyword">final</span> Channel channel = regFuture.channel();    <span class="hljs-keyword">if</span> (regFuture.cause() != <span class="hljs-keyword">null</span>) &#123;        <span class="hljs-keyword">return</span> regFuture;    &#125;    <span class="hljs-keyword">if</span> (regFuture.isDone()) &#123;        <span class="hljs-comment">// At this point we know that the registration was complete and successful.</span>        ChannelPromise promise = channel.newPromise();        <span class="hljs-comment">//============================================</span>        <span class="hljs-comment">//è¯´æ˜:æ‰§è¡ŒdoBind0æ–¹æ³•ï¼Œå®Œæˆå¯¹ç«¯å£çš„ç»‘å®š</span>        <span class="hljs-comment">//============================================</span>        doBind0(regFuture, channel, localAddress, promise);        <span class="hljs-keyword">return</span> promise;    &#125; <span class="hljs-keyword">else</span> &#123;        <span class="hljs-comment">// Registration future is almost always fulfilled already, but just in case it&#x27;s not.</span>        <span class="hljs-keyword">final</span> PendingRegistrationPromise promise = <span class="hljs-keyword">new</span> PendingRegistrationPromise(channel);        regFuture.addListener(<span class="hljs-keyword">new</span> ChannelFutureListener() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                Throwable cause = future.cause();                <span class="hljs-keyword">if</span> (cause != <span class="hljs-keyword">null</span>) &#123;                    <span class="hljs-comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span>                    <span class="hljs-comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span>                    promise.setFailure(cause);                &#125; <span class="hljs-keyword">else</span> &#123;                    <span class="hljs-comment">// Registration was successful, so set the correct executor to use.</span>                    <span class="hljs-comment">// See https://github.com/netty/netty/issues/2586</span>                    promise.registered();                    doBind0(regFuture, channel, localAddress, promise);                &#125;            &#125;        &#125;);        <span class="hljs-keyword">return</span> promise;    &#125;&#125;</code></pre></div><p>4.4 åˆ†æè¯´æ˜ <code>initAndRegister</code></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">initAndRegister</span><span class="hljs-params">()</span> </span>&#123;    Channel channel = <span class="hljs-keyword">null</span>;    <span class="hljs-keyword">try</span> &#123;        channel = channelFactory.newChannel();        <span class="hljs-comment">/**</span><span class="hljs-comment">         * è¯´æ˜ï¼šchannelFactory.newChannel() æ–¹æ³•çš„ä½œç”¨é€šè¿‡ ServerBootstrap çš„é€šé“å·¥å‚åå°„åˆ›å»ºä¸€ä¸ª NioServerSocketChannel,å…·ä½“è¿½è¸ªæºç å¯ä»¥å¾—åˆ°ä¸‹é¢ç»“è®º</span><span class="hljs-comment">         * (1)é€šè¿‡ NIO çš„ SelectorProvider çš„ openServerSocketChannel æ–¹æ³•å¾—åˆ° JDK çš„ channelã€‚ç›®çš„æ˜¯è®© Netty åŒ…è£… JDK çš„ channelã€‚</span><span class="hljs-comment">         * (2)åˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€çš„ ChannelIdï¼Œåˆ›å»ºäº†ä¸€ä¸ª NioMessageUnsafeï¼Œç”¨äºæ“ä½œæ¶ˆæ¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ª DefaultChannelPipeline ç®¡é“ï¼Œæ˜¯ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”¨äºè¿‡æ»¤æ‰€æœ‰çš„è¿›å‡ºçš„æ¶ˆæ¯ã€‚</span><span class="hljs-comment">         * (3)åˆ›å»ºäº†ä¸€ä¸ª NioServerSocketChannelConfig å¯¹è±¡ï¼Œç”¨äºå¯¹å¤–å±•ç¤ºä¸€äº›é…ç½®ã€‚ </span><span class="hljs-comment">         </span><span class="hljs-comment">         * channel = channelFactory.newChannel();//NioServerSocketChannel</span><span class="hljs-comment"></span><span class="hljs-comment">         * è¯´æ˜ï¼šinit åˆå§‹åŒ–è¿™ä¸ª NioServerSocketChannelï¼Œå…·ä½“è¿½è¸ªæºç å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®º</span><span class="hljs-comment">         * (1) init æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ªæŠ½è±¡æ–¹æ³• (AbstractBootstrapç±»çš„ï¼‰ï¼Œç”±ServerBootstrapå®ç°ï¼ˆå¯ä»¥è¿½ä¸€ä¸‹æºç //setChannelOptions(channel,options,logger);ï¼‰ã€‚</span><span class="hljs-comment">         * (2)è®¾ç½® NioServerSocketChannel çš„ TCP å±æ€§ã€‚</span><span class="hljs-comment">         * (3)ç”±äº LinkedHashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä½¿ç”¨åŒæ­¥è¿›è¡Œå¤„ç†ã€‚</span><span class="hljs-comment">         * (4)å¯¹ NioServerSocketChannel çš„ ChannelPipeline æ·»åŠ  ChannelInitializer å¤„ç†å™¨ã€‚</span><span class="hljs-comment">         * (5)å¯ä»¥çœ‹å‡ºï¼Œinit çš„æ–¹æ³•çš„æ ¸å¿ƒä½œç”¨åœ¨å’Œ ChannelPipeline ç›¸å…³ã€‚</span><span class="hljs-comment">         * (6)ä» NioServerSocketChannel çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œpipeline æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”ï¼Œä»–æœ¬èº«å°±åˆå§‹åŒ–äº† head å’Œ tailï¼Œè¿™é‡Œè°ƒç”¨äº†ä»–çš„ addLast æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å°†æ•´ä¸ª handler æ’å…¥åˆ° tail çš„å‰é¢ï¼Œå› ä¸º tail æ°¸è¿œä¼šåœ¨åé¢ï¼Œéœ€è¦åšä¸€äº›ç³»ç»Ÿçš„å›ºå®šå·¥ä½œã€‚</span><span class="hljs-comment">         */</span>        init(channel);    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;        <span class="hljs-keyword">if</span> (channel != <span class="hljs-keyword">null</span>) &#123;            channel.unsafe().closeForcibly();            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultChannelPromise(<span class="hljs-keyword">new</span> FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);    &#125;    ChannelFuture regFuture = config().group().register(channel);    <span class="hljs-keyword">if</span> (regFuture.cause() != <span class="hljs-keyword">null</span>) &#123;        <span class="hljs-keyword">if</span> (channel.isRegistered()) &#123;            channel.close();        &#125; <span class="hljs-keyword">else</span> &#123;            channel.unsafe().closeForcibly();        &#125;    &#125;    <span class="hljs-keyword">return</span> regFuture;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><ol><li>åŸºæœ¬è¯´æ˜ï¼š<code>initAndRegister()</code> åˆå§‹åŒ– <code>NioServerSocketChannel</code> é€šé“å¹¶æ³¨å†Œå„ä¸ª <code>handler</code>ï¼Œè¿”å›ä¸€ä¸ª <code>future</code>ã€‚</li><li>é€šè¿‡ <code>ServerBootstrap</code> çš„é€šé“å·¥å‚åå°„åˆ›å»ºä¸€ä¸ª <code>NioServerSocketChannel</code>ã€‚</li><li><code>init</code> åˆå§‹åŒ–è¿™ä¸ª <code>NioServerSocketChannel</code>ã€‚</li><li><code>config().group().register(channel)</code> é€šè¿‡ <code>ServerBootstrap</code> çš„ <code>bossGroup</code> æ³¨å†Œ <code>NioServerSocketChannel</code>ã€‚</li><li>æœ€åï¼Œè¿”å›è¿™ä¸ªå¼‚æ­¥æ‰§è¡Œçš„å ä½ç¬¦å³ <code>regFuture</code>ã€‚</li></ol><p>4.5 <code>init</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>addLast</code>ï¼Œç°åœ¨è¿›å…¥åˆ° <code>addLast</code> æ–¹æ³•å†…æŸ¥çœ‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">addLast</span><span class="hljs-params">(EventExecutorGroup group, String name, ChannelHandler handler)</span> </span>&#123;    <span class="hljs-keyword">final</span> AbstractChannelHandlerContext newCtx;    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;        checkMultiplicity(handler);        newCtx = newContext(group, filterName(name, handler), handler);        addLast0(newCtx);        <span class="hljs-keyword">if</span> (!registered) &#123;            newCtx.setAddPending();            callHandlerCallbackLater(newCtx, <span class="hljs-keyword">true</span>);            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;        &#125;        EventExecutor executor = newCtx.executor();        <span class="hljs-keyword">if</span> (!executor.inEventLoop()) &#123;            callHandlerAddedInEventLoop(newCtx, executor);            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;        &#125;    &#125;    callHandlerAdded0(newCtx);    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><ol><li><code>addLast</code> æ–¹æ³•ï¼Œåœ¨ <code>DefaultChannelPipeline</code> ç±»ä¸­</li><li><code>addLast</code> æ–¹æ³•è¿™å°±æ˜¯ <code>pipeline</code> æ–¹æ³•çš„æ ¸å¿ƒ</li><li>æ£€æŸ¥è¯¥ <code>handler</code> æ˜¯å¦ç¬¦åˆæ ‡å‡†ã€‚</li><li>åˆ›å»ºä¸€ä¸ª <code>AbstractChannelHandlerContext</code> å¯¹è±¡ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹ï¼Œ<code>ChannelHandlerContext</code> å¯¹è±¡æ˜¯ <code>ChannelHandler</code> å’Œ <code>ChannelPipeline</code> ä¹‹é—´çš„å…³è”ï¼Œæ¯å½“æœ‰ <code>ChannelHandler</code> æ·»åŠ åˆ° <code>Pipeline</code> ä¸­æ—¶ï¼Œéƒ½ä¼šåˆ›å»º <code>Context</code>ã€‚<code>Context</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯ç®¡ç†ä»–æ‰€å…³è”çš„ <code>Handler</code> å’ŒåŒä¸€ä¸ª <code>Pipeline</code> ä¸­çš„å…¶ä»– <code>Handler</code> ä¹‹é—´çš„äº¤äº’ã€‚</li><li>å°† <code>Context</code> æ·»åŠ åˆ°é“¾è¡¨ä¸­ã€‚ä¹Ÿå°±æ˜¯è¿½åŠ åˆ° <code>tail</code> èŠ‚ç‚¹çš„å‰é¢ã€‚</li><li>æœ€åï¼ŒåŒæ­¥æˆ–è€…å¼‚æ­¥æˆ–è€…æ™šç‚¹å¼‚æ­¥çš„è°ƒç”¨ <code>callHandlerAdded0</code> æ–¹æ³•</li></ol><p>4.6 å‰é¢è¯´äº† <code>dobind</code> æ–¹æ³•æœ‰ <code>2</code> ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œ<code>initAndRegister</code> è¯´å®Œï¼Œæ¥ä¸‹æ¥çœ‹ <code>doBind0</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doBind0</span><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">final</span> ChannelFuture regFuture, <span class="hljs-keyword">final</span> Channel channel,</span></span><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">final</span> SocketAddress localAddress, <span class="hljs-keyword">final</span> ChannelPromise promise)</span> </span>&#123;    <span class="hljs-comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span>    <span class="hljs-comment">// the pipeline in its channelRegistered() implementation.</span>    channel.eventLoop().execute(<span class="hljs-keyword">new</span> Runnable() &#123;        <span class="hljs-meta">@Override</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;            <span class="hljs-keyword">if</span> (regFuture.isSuccess()) &#123;                <span class="hljs-comment">//bindæ–¹æ³•è¿™é‡Œä¸‹æ–­ç‚¹ï¼Œè¿™é‡Œä¸‹æ–­ç‚¹ï¼Œæ¥ç©!!</span>                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);            &#125; <span class="hljs-keyword">else</span> &#123;                promise.setFailure(regFuture.cause());            &#125;        &#125;    &#125;);&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><ol><li>è¯¥æ–¹æ³•çš„å‚æ•°ä¸º <code>initAndRegister</code> çš„ <code>future</code>ï¼Œ<code>NioServerSocketChannel</code>ï¼Œç«¯å£åœ°å€ï¼Œ<code>NioServerSocketChannel</code> çš„ <code>promise</code></li><li>è¿™é‡Œå°±å¯ä»¥æ ¹æ®å‰é¢ä¸‹çš„æ–­ç‚¹ï¼Œä¸€ç›´ <code>debug</code>ï¼š</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// å°†è°ƒç”¨ LoggingHandler çš„ invokeBind æ–¹æ³•,æœ€åä¼šè¿½åˆ°</span><span class="hljs-comment">// DefaultChannelPipeline ç±»çš„ bind</span><span class="hljs-comment">// ç„¶åè¿›å…¥åˆ° unsafe.bind æ–¹æ³• debugï¼Œæ³¨æ„è¦è¿½è¸ªåˆ°</span><span class="hljs-comment">// unsafe.bindï¼Œè¦ debug ç¬¬äºŒåœˆçš„æ—¶å€™ï¼Œæ‰èƒ½çœ‹åˆ°ã€‚</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bind</span> <span class="hljs-params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    unsafe.bind(localAddress,promise);&#125;<span class="hljs-comment">// ç»§ç»­è¿½è¸ª AbstractChannel çš„ </span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bind</span> <span class="hljs-params">(<span class="hljs-keyword">final</span> SocketAddress localAddress, <span class="hljs-keyword">final</span> ChannelPromise promise)</span> </span>&#123;    <span class="hljs-comment">//....</span>    <span class="hljs-keyword">try</span>&#123;        <span class="hljs-comment">//!!!! å°çº¢æ——å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ€ç»ˆçš„æ–¹æ³•å°±æ˜¯ doBind æ–¹æ³•ï¼Œæ‰§è¡ŒæˆåŠŸåï¼Œæ‰§è¡Œé€šé“çš„ fireChannelActive æ–¹æ³•ï¼Œå‘Šè¯‰æ‰€æœ‰çš„ handlerï¼Œå·²ç»æˆåŠŸç»‘å®šã€‚</span>        doBind(localAddress);<span class="hljs-comment">//</span>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;        safeSetFailure(promise, t);        closeIfClosed();        <span class="hljs-keyword">return</span>;    &#125;&#125;</code></pre></div><ol><li>æœ€ç»ˆ <code>doBind</code> å°±ä¼šè¿½è¸ªåˆ° <code>NioServerSocketChannel</code> çš„ <code>doBind</code>ï¼Œè¯´æ˜ <code>Netty</code> åº•å±‚ä½¿ç”¨çš„æ˜¯ <code>NIO</code></li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doBind</span> <span class="hljs-params">(SocketAddress localAddress)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    <span class="hljs-keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="hljs-number">7</span>) &#123;        javaChannel().bind(localAddress, config.getBacklog());    &#125; <span class="hljs-keyword">else</span> &#123;        javaChannel().socket().bind(localAddress, config.getBacklog());    &#125;&#125;</code></pre></div><ol><li>å›åˆ° <code>bind</code> æ–¹æ³•ï¼ˆ<code>alt + v</code>ï¼‰ï¼Œæœ€åä¸€æ­¥ï¼š<code>safeSetSuccess(promise)</code>ï¼Œå‘Šè¯‰ <code>promise</code> ä»»åŠ¡æˆåŠŸäº†ã€‚å…¶å¯ä»¥æ‰§è¡Œç›‘å¬å™¨çš„æ–¹æ³•äº†ã€‚åˆ°æ­¤æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹å·²ç»ç»“æŸäº†ï¼Œok äº†</li><li>ç»§ç»­ <code>atl + v</code> æœåŠ¡å™¨å°±å›è¿›å…¥åˆ°ï¼ˆ<code>NioEventLoop</code> ç±»ï¼‰ä¸€ä¸ªå¾ªç¯ä»£ç ï¼Œè¿›è¡Œç›‘å¬</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">for</span>(;;) &#123;        <span class="hljs-keyword">try</span>&#123;        &#125;    &#125;&#125;</code></pre></div><h4 id="10-2-4-Netty-å¯åŠ¨è¿‡ç¨‹æ¢³ç†"><a href="#10-2-4-Netty-å¯åŠ¨è¿‡ç¨‹æ¢³ç†" class="headerlink" title="10.2.4 Netty å¯åŠ¨è¿‡ç¨‹æ¢³ç†"></a>10.2.4 Netty å¯åŠ¨è¿‡ç¨‹æ¢³ç†</h4><ol><li>åˆ›å»º <code>2</code> ä¸ª <code>EventLoopGroup</code> çº¿ç¨‹æ± æ•°ç»„ã€‚æ•°ç»„é»˜è®¤å¤§å° <code>CPU * 2</code>ï¼Œæ–¹ä¾¿ <code>chooser</code> é€‰æ‹©çº¿ç¨‹æ± æ—¶æé«˜æ€§èƒ½</li><li><code>BootStrap</code> å°† <code>boss</code> è®¾ç½®ä¸º <code>group</code> å±æ€§ï¼Œå°† <code>worker</code> è®¾ç½®ä¸º <code>childer</code> å±æ€§</li><li>é€šè¿‡ <code>bind</code> æ–¹æ³•å¯åŠ¨ï¼Œå†…éƒ¨é‡è¦æ–¹æ³•ä¸º <code>initAndRegister</code> å’Œ <code>dobind</code> æ–¹æ³•</li><li><code>initAndRegister</code> æ–¹æ³•ä¼šåå°„åˆ›å»º <code>NioServerSocketChannel</code> åŠå…¶ç›¸å…³çš„ <code>NIO</code> çš„å¯¹è±¡ï¼Œ<code>pipeline</code>ï¼Œ<code>unsafe</code>ï¼ŒåŒæ—¶ä¹Ÿä¸º <code>pipeline</code> åˆå§‹äº† <code>head</code> èŠ‚ç‚¹å’Œ <code>tail</code> èŠ‚ç‚¹ã€‚</li><li>åœ¨ <code>register0</code> æ–¹æ³•æˆåŠŸä»¥åè°ƒç”¨åœ¨ <code>dobind</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>doBind0</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ <code>NioServerSocketChannel</code> çš„ <code>doBind</code> æ–¹æ³•å¯¹ <code>JDK</code> çš„ <code>channel</code> å’Œç«¯å£è¿›è¡Œç»‘å®šï¼Œå®Œæˆ <code>Netty</code> æœåŠ¡å™¨çš„æ‰€æœ‰å¯åŠ¨ï¼Œå¹¶å¼€å§‹ç›‘å¬è¿æ¥äº‹ä»¶ã€‚</li></ol><h3 id="10-3-Netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ"><a href="#10-3-Netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ" class="headerlink" title="10.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ"></a>10.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ</h3><h4 id="10-3-1-æºç å‰–æç›®çš„"><a href="#10-3-1-æºç å‰–æç›®çš„" class="headerlink" title="10.3.1 æºç å‰–æç›®çš„"></a>10.3.1 æºç å‰–æç›®çš„</h4><ol><li>æœåŠ¡å™¨å¯åŠ¨åè‚¯å®šæ˜¯è¦æ¥å—å®¢æˆ·ç«¯è¯·æ±‚å¹¶è¿”å›å®¢æˆ·ç«¯æƒ³è¦çš„ä¿¡æ¯çš„ï¼Œä¸‹é¢æºç åˆ†æ <code>Netty</code> åœ¨å¯åŠ¨ä¹‹åæ˜¯å¦‚ä½•æ¥å—å®¢æˆ·ç«¯è¯·æ±‚çš„</li><li>åœ¨ <code>io.netty.example</code> åŒ…ä¸‹</li></ol><h4 id="10-3-2-æºç å‰–æ"><a href="#10-3-2-æºç å‰–æ" class="headerlink" title="10.3.2 æºç å‰–æ"></a>10.3.2 æºç å‰–æ</h4><p>è¯´æ˜ï¼š</p><ol><li>ä»ä¹‹å‰æœåŠ¡å™¨å¯åŠ¨çš„æºç ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼ŒæœåŠ¡å™¨æœ€ç»ˆæ³¨å†Œäº†ä¸€ä¸ª <code>Accept</code> äº‹ä»¶ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œ<code>NioServerSocketChannel</code> å°†è‡ªå·±æ³¨å†Œåˆ°äº† <code>boss</code> å•ä¾‹çº¿ç¨‹æ± ï¼ˆ<code>reactor</code> çº¿ç¨‹ï¼‰ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>EventLoop</code>ã€‚</li><li>å…ˆç®€å•è¯´ä¸‹ <code>EventLoop</code> çš„é€»è¾‘(åé¢æˆ‘ä»¬è¯¦ç»†è®²è§£ <code>EventLoop</code>)</li></ol><p><code>EventLoop</code> çš„ä½œç”¨æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè€Œè¿™ä¸ªå¾ªç¯ä¸­åš 3 ä»¶äº‹æƒ…ï¼š</p><ol><li><p>æœ‰æ¡ä»¶çš„ç­‰å¾… <code>NIO</code> äº‹ä»¶ã€‚</p></li><li><p>å¤„ç† <code>NIO</code> äº‹ä»¶ã€‚</p></li><li><p>å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p></li><li><p>ä»ç”¨å‰é¢çš„é¡¹ç›®æ¥åˆ†æï¼šè¿›å…¥åˆ° <code>NioEventLoop</code> æºç ä¸­åï¼Œåœ¨ <code>private void processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•å¼€å§‹è°ƒè¯•æœ€ç»ˆæˆ‘ä»¬è¦åˆ†æåˆ° <code>AbstractNioChannel</code> çš„ <code>doBeginRead</code> æ–¹æ³•ï¼Œå½“åˆ°è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œé’ˆå¯¹äºè¿™ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›‘å¬è¯»äº‹ä»¶äº†</p><p>æºç åˆ†æè¿‡ç¨‹</p></li><li><p>æ–­ç‚¹ä½ç½® <code>NioEventLoop</code> çš„å¦‚ä¸‹æ–¹æ³• <code>processSelectedKey</code></p></li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">if</span>((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="hljs-number">0</span> || readyOps == <span class="hljs-number">0</span>) &#123;    unsafe.read();<span class="hljs-comment">//æ–­ç‚¹ä½ç½®</span>&#125;</code></pre></div><ol><li>æ‰§è¡Œæµè§ˆå™¨ <code>http://localhost:8007/</code> ï¼Œå®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚</li><li>ä»çš„æ–­ç‚¹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>readyOps</code> æ˜¯ <code>16</code>ï¼Œä¹Ÿå°±æ˜¯ <code>Accept</code> äº‹ä»¶ã€‚è¯´æ˜æµè§ˆå™¨çš„è¯·æ±‚å·²ç»è¿›æ¥äº†ã€‚</li><li>è¿™ä¸ª <code>unsafe</code> æ˜¯ <code>boss</code> çº¿ç¨‹ä¸­ <code>NioServerSocketChannel</code> çš„ <code>AbstractNioMessageChannel$NioMessageUnsafe</code> å¯¹è±¡ã€‚æˆ‘ä»¬è¿›å…¥åˆ° <code>AbstractNioMessageChannel$NioMessageUnsafe</code> çš„ <code>read</code> æ–¹æ³•ä¸­</li><li><code>read</code> æ–¹æ³•ä»£ç å¹¶åˆ†æ:</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;    asserteventLoop().inEventLoop();    <span class="hljs-keyword">final</span> ChannelConfig config = config();    <span class="hljs-keyword">final</span> ChannelPipeline pipeline = pipeline();    <span class="hljs-keyword">final</span> RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();    allocHandle.reset(config);    booleanclosed = <span class="hljs-keyword">false</span>;    Throwable exception = <span class="hljs-keyword">null</span>;    <span class="hljs-keyword">try</span> &#123;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">do</span> &#123;                <span class="hljs-keyword">int</span> localRead = doReadMessages(readBuf);                <span class="hljs-keyword">if</span> (localRead == <span class="hljs-number">0</span>) &#123;                    <span class="hljs-keyword">break</span>;                &#125;                <span class="hljs-keyword">if</span> (localRead &lt; <span class="hljs-number">0</span>) &#123;                    closed = <span class="hljs-keyword">true</span>;                    <span class="hljs-keyword">break</span>;                &#125;                                allocHandle.incMessagesRead(localRead);            &#125; <span class="hljs-keyword">while</span> (allocHandle.continueReading());        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;            exception = t;        &#125;                <span class="hljs-keyword">int</span> size = readBuf.size();        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) &#123;            readPending = <span class="hljs-keyword">false</span>;            pipeline.fireChannelRead(readBuf.get(i));        &#125;        readBuf.clear();        allocHandle.readComplete();        pipeline.fireChannelReadComplete();                <span class="hljs-keyword">if</span> (exception != <span class="hljs-keyword">null</span>) &#123;            closed = closeOnReadError(exception);            pipeline.fireExceptionCaught(exception);        &#125;                <span class="hljs-keyword">if</span> (closed) &#123;            inputShutdown = <span class="hljs-keyword">true</span>;            <span class="hljs-keyword">if</span>(isOpen()) &#123;                close(voidPromise());            &#125;        &#125;    &#125; <span class="hljs-keyword">finally</span> &#123;        <span class="hljs-comment">//Check if there is a readPending which was not processed yet.</span>        <span class="hljs-comment">//This could be for two reasons:</span>        <span class="hljs-comment">//* The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span>        <span class="hljs-comment">//* The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span>        <span class="hljs-comment">//</span>        <span class="hljs-comment">// See https://github.com/netty/netty/issues/2254</span>        <span class="hljs-keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) &#123;            removeReadOp();        &#125;    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š 1)æ£€æŸ¥è¯¥ <code>eventloop</code> çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ã€‚<code>asserteventLoop().inEventLoop()</code></p><p>2)æ‰§è¡Œ <code>doReadMessages</code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ª <code>readBuf</code> å˜é‡ï¼Œè¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ª <code>List</code>ï¼Œä¹Ÿå°±æ˜¯å®¹å™¨ã€‚</p><p>3)å¾ªç¯å®¹å™¨ï¼Œæ‰§è¡Œ <code>pipeline.fireChannelRead(readBuf.get(i));</code></p><p>4)<code>doReadMessages</code> æ˜¯è¯»å– <code>boss</code> çº¿ç¨‹ä¸­çš„ <code>NioServerSocketChannel</code> æ¥å—åˆ°çš„è¯·æ±‚ã€‚å¹¶æŠŠè¿™äº›è¯·æ±‚æ”¾è¿›å®¹å™¨ï¼Œä¸€ä¼šæˆ‘ä»¬ <code>debug</code> ä¸‹ <code>doReadMessages</code> æ–¹æ³•ã€‚</p><p>5)å¾ªç¯éå†å®¹å™¨ä¸­çš„æ‰€æœ‰è¯·æ±‚ï¼Œè°ƒç”¨ <code>pipeline</code> çš„ <code>fireChannelRead</code> æ–¹æ³•ï¼Œç”¨äºå¤„ç†è¿™äº›æ¥å—çš„è¯·æ±‚æˆ–è€…å…¶ä»–äº‹ä»¶ï¼Œåœ¨ <code>read</code> æ–¹æ³•ä¸­ï¼Œå¾ªç¯è°ƒç”¨ <code>ServerSocket</code> çš„ <code>pipeline</code> çš„ <code>fireChannelRead</code> æ–¹æ³•,å¼€å§‹æ‰§è¡Œç®¡é“ä¸­çš„ <code>handler</code> çš„ <code>ChannelRead</code> æ–¹æ³•ï¼ˆ<code>debug</code> è¿›å…¥ï¼‰</p><ol><li>è¿½è¸ªä¸€ä¸‹ <code>doReadMessages</code> æ–¹æ³•ï¼Œå°±å¯ä»¥çœ‹å¾—æ›´æ¸…æ™°</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doReadMessages</span> <span class="hljs-params">(List&lt;Object&gt; buf)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    SocketChannel ch = SocketUtils.accept(javaChannel());    buf.add(newNioSocketChannel(<span class="hljs-keyword">this</span>, ch));    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;&#125;</code></pre></div><p>è¯´æ˜ï¼š 1)é€šè¿‡å·¥å…·ç±»ï¼Œè°ƒç”¨ <code>NioServerSocketChannel</code> å†…éƒ¨å°è£…çš„ <code>serverSocketChannel</code> çš„ <code>accept</code> æ–¹æ³•ï¼Œè¿™æ˜¯ <code>NIO</code> åšæ³•ã€‚</p><p>2)è·å–åˆ°ä¸€ä¸ª <code>JDK</code> çš„ <code>SocketChannel</code>ï¼Œç„¶åï¼Œä½¿ç”¨ <code>NioSocketChannel</code> è¿›è¡Œå°è£…ã€‚æœ€åæ·»åŠ åˆ°å®¹å™¨ä¸­</p><p>3)è¿™æ ·å®¹å™¨ <code>buf</code> ä¸­å°±æœ‰äº† <code>NioSocketChannel</code> ã€å¦‚æœæœ‰å…´è¶£å¯ä»¥è¿½ä¸€ä¸‹ <code>NioSocketChannel</code> æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Œæˆ‘å°±ä¸è¿½äº†ã€‘</p><ol><li>å›åˆ° <code>read</code> æ–¹æ³•ï¼Œç»§ç»­åˆ†æå¾ªç¯æ‰§è¡Œ <code>pipeline.fireChannelRead</code> æ–¹æ³•</li></ol><p>1)å‰é¢åˆ†æ <code>doReadMessages</code> æ–¹æ³•çš„ä½œç”¨æ˜¯é€šè¿‡ <code>ServerSocket</code> çš„ <code>accept</code> æ–¹æ³•è·å–åˆ° <code>TCP</code> è¿æ¥ï¼Œç„¶åå°è£…æˆ <code>Netty</code> çš„ <code>NioSocketChannel</code> å¯¹è±¡ã€‚æœ€åæ·»åŠ åˆ°å®¹å™¨ä¸­</p><p>2)åœ¨ <code>read</code> æ–¹æ³•ä¸­ï¼Œå¾ªç¯è°ƒç”¨ <code>ServerSocket</code> çš„ <code>pipeline</code> çš„ <code>fireChannelRead</code> æ–¹æ³•,å¼€å§‹æ‰§è¡Œç®¡é“ä¸­çš„ <code>handler</code> çš„ <code>ChannelRead</code> æ–¹æ³•ï¼ˆ<code>debug</code> è¿›å…¥ï¼‰</p><p>3)ç»è¿‡ <code>dubug</code>ï¼ˆå¤šæ¬¡ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¼šåå¤æ‰§è¡Œå¤šä¸ª <code>handler</code> çš„ <code>ChannelRead</code>ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œ<code>pipeline</code> é‡Œé¢åˆ <code>4</code> ä¸ª <code>handler</code>ï¼Œåˆ†åˆ«æ˜¯ <code>Head</code>ï¼Œ<code>LoggingHandler</code>ï¼Œ<code>ServerBootstrapAcceptor</code>ï¼Œ<code>Tail</code>ã€‚</p><p>4)æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ <code>ServerBootstrapAcceptor</code>ã€‚<code>debug</code> ä¹‹åï¼Œæ–­ç‚¹ä¼šè¿›å…¥åˆ° <code>ServerBootstrapAcceptor</code> ä¸­æ¥ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ <code>ServerBootstrapAcceptor</code> çš„ <code>channelRead</code> æ–¹æ³•ï¼ˆè¦å¤šæ¬¡ <code>debug</code> æ‰å¯ä»¥ï¼‰</p><p>5)<code>channelRead</code> æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span> <span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;    <span class="hljs-keyword">final</span> Channelchild = (Channel)msg;    child.pipeline().addLast(childHandler);    setChannelOptions(child, childOptions, logger);    <span class="hljs-keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e : childAttrs) &#123;        child.attr((AttributeKey&lt;Object&gt;)e.getKey()).set(e.getValue());    &#125;    <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//å°†å®¢æˆ·ç«¯è¿æ¥æ³¨å†Œåˆ° worker çº¿ç¨‹æ± </span>        childGroup.register(child).addListener(<span class="hljs-keyword">new</span> ChannelFutureListener() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">operationComplete</span><span class="hljs-params">(ChannelFuturefuture)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                <span class="hljs-keyword">if</span> (!future.isSuccess()) &#123;                    forceClose(child, future.cause());                &#125;            &#125;        &#125;);    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;        forceClose(child, t);    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š 1)<code>msg</code> å¼ºè½¬æˆ <code>Channel</code>ï¼Œå®é™…ä¸Šå°±æ˜¯ <code>NioSocketChannel</code>ã€‚</p><p>2)æ·»åŠ  <code>NioSocketChannel</code> çš„ <code>pipeline</code> çš„ <code>handler</code>ï¼Œå°±æ˜¯æˆ‘ä»¬ <code>main</code> æ–¹æ³•é‡Œé¢è®¾ç½®çš„ <code>childHandler</code> æ–¹æ³•é‡Œçš„ã€‚</p><p>3)è®¾ç½® <code>NioSocketChannel</code> çš„å„ç§å±æ€§ã€‚</p><p>4)å°†è¯¥ <code>NioSocketChannel</code> æ³¨å†Œåˆ° <code>childGroup</code> ä¸­çš„ä¸€ä¸ª <code>EventLoop</code> ä¸Šï¼Œå¹¶æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ã€‚</p><p>5)è¿™ä¸ª <code>childGroup</code> å°±æ˜¯æˆ‘ä»¬ <code>main</code> æ–¹æ³•åˆ›å»ºçš„æ•°ç»„ <code>workerGroup</code>ã€‚</p><ol><li>è¿›å…¥ <code>register</code> æ–¹æ³•æŸ¥çœ‹(æ­¥æ­¥è¿½è¸ªä¼šåˆ°)</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span> <span class="hljs-params">(EventLoop eventLoop, <span class="hljs-keyword">final</span> ChannelPromise promise)</span> </span>&#123;    AbstractChannel.<span class="hljs-keyword">this</span>.eventLoop = eventLoop;    <span class="hljs-keyword">if</span> (eventLoop.inEventLoop()) &#123;        register0(promise);    &#125; <span class="hljs-keyword">else</span> &#123;        eventLoop.execute(<span class="hljs-keyword">new</span> Runnable()&#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;                register0(promise);<span class="hljs-comment">//è¿›å…¥åˆ°è¿™é‡Œ</span>            &#125;        &#125;);    &#125;&#125;<span class="hljs-comment">// ç»§ç»­è¿›å…¥åˆ°ä¸‹é¢æ–¹æ³•ï¼Œæ‰§è¡Œç®¡é“ä¸­å¯èƒ½å­˜åœ¨çš„ä»»åŠ¡,è¿™é‡Œæˆ‘ä»¬å°±ä¸è¿½äº†</span></code></pre></div><ol><li>æœ€ç»ˆä¼šè°ƒç”¨ <code>doBeginRead</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ <code>AbstractNioChannel</code> ç±»çš„æ–¹æ³•</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doBeginRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    <span class="hljs-comment">//Channel.read() or ChannelHandlerContext.read() was called</span>    <span class="hljs-keyword">final</span> SelectionKey selectionKey = <span class="hljs-keyword">this</span>.selectionKey;<span class="hljs-comment">//æ–­ç‚¹</span>    <span class="hljs-keyword">if</span> (!selectionKey.isValid()) &#123;        <span class="hljs-keyword">return</span>;    &#125;    readPending = <span class="hljs-keyword">true</span>;    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> interestOps = selectionKey.interestOps();    <span class="hljs-keyword">if</span> ((interestOps&amp;readInterestOp) == <span class="hljs-number">0</span>) &#123;        selectionKey.interestOps(interestOps | readInterestOp);    &#125;&#125;</code></pre></div><ol><li>è¿™ä¸ªåœ°æ–¹è°ƒè¯•æ—¶ï¼Œè¯·æŠŠå‰é¢çš„æ–­ç‚¹éƒ½å»æ‰ï¼Œç„¶åå¯åŠ¨æœåŠ¡å™¨å°±ä¼šåœæ­¢åœ¨ <code>doBeginRead</code>ï¼ˆéœ€è¦å…ˆæ”¾è¿‡è¯¥æ–­ç‚¹ï¼Œç„¶åæµè§ˆå™¨è¯·æ±‚ï¼Œæ‰èƒ½çœ‹åˆ°æ•ˆæœï¼‰</li><li>æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œé’ˆå¯¹äºè¿™ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›‘å¬è¯»äº‹ä»¶äº†</li></ol><h4 id="10-3-3-Netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†"><a href="#10-3-3-Netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†" class="headerlink" title="10.3.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†"></a>10.3.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†</h4><p>æ€»ä½“æµç¨‹ï¼šæ¥å—è¿æ¥ â€“&gt; åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>NioSocketChannel</code> â€“&gt; æ³¨å†Œåˆ°ä¸€ä¸ª <code>workerEventLoop</code> ä¸Š â€“&gt; æ³¨å†Œ <code>selecotRead</code> äº‹ä»¶ã€‚</p><ol><li>æœåŠ¡å™¨è½®è¯¢ <code>Accept</code> äº‹ä»¶ï¼Œè·å–äº‹ä»¶åè°ƒç”¨ <code>unsafe</code> çš„ <code>read</code> æ–¹æ³•ï¼Œè¿™ä¸ª <code>unsafe</code> æ˜¯ <code>ServerSocket</code> çš„å†…éƒ¨ç±»ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ç”± <code>2</code> éƒ¨åˆ†ç»„æˆ</li><li><code>doReadMessages</code> ç”¨äºåˆ›å»º <code>NioSocketChannel</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…è£… <code>JDK</code> çš„ <code>NioChannel</code> å®¢æˆ·ç«¯ã€‚è¯¥æ–¹æ³•ä¼šåƒåˆ›å»º <code>ServerSocketChanel</code> ç±»ä¼¼åˆ›å»ºç›¸å…³çš„ <code>pipeline</code>ï¼Œ<code>unsafe</code>ï¼Œ<code>config</code></li><li>éšåæ‰§è¡Œæ‰§è¡Œ <code>pipeline.fireChannelRead</code> æ–¹æ³•ï¼Œå¹¶å°†è‡ªå·±ç»‘å®šåˆ°ä¸€ä¸ª <code>chooser</code> é€‰æ‹©å™¨é€‰æ‹©çš„ <code>workerGroup</code> ä¸­çš„ä¸€ä¸ª <code>EventLoop</code>ã€‚å¹¶ä¸”æ³¨å†Œä¸€ä¸ª <code>0</code>ï¼Œè¡¨ç¤ºæ³¨å†ŒæˆåŠŸï¼Œä½†å¹¶æ²¡æœ‰æ³¨å†Œè¯»ï¼ˆ1ï¼‰äº‹ä»¶</li></ol><h3 id="10-4-Pipeline-Handler-HandlerContext-åˆ›å»ºæºç å‰–æ"><a href="#10-4-Pipeline-Handler-HandlerContext-åˆ›å»ºæºç å‰–æ" class="headerlink" title="10.4 Pipeline Handler HandlerContext åˆ›å»ºæºç å‰–æ"></a>10.4 Pipeline Handler HandlerContext åˆ›å»ºæºç å‰–æ</h3><h4 id="10-4-1-æºç å‰–æç›®çš„"><a href="#10-4-1-æºç å‰–æç›®çš„" class="headerlink" title="10.4.1 æºç å‰–æç›®çš„"></a>10.4.1 æºç å‰–æç›®çš„</h4><p><code>Netty</code> ä¸­çš„ <code>ChannelPipeline</code>ã€<code>ChannelHandler</code> å’Œ <code>ChannelHandlerContext</code> æ˜¯éå¸¸æ ¸å¿ƒçš„ç»„ä»¶ï¼Œæˆ‘ä»¬ä»æºç æ¥åˆ†æ <code>Netty</code> æ˜¯å¦‚ä½•è®¾è®¡è¿™ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶çš„ï¼Œå¹¶åˆ†ææ˜¯å¦‚ä½•åˆ›å»ºå’Œåè°ƒå·¥ä½œçš„.</p><h4 id="10-4-2-æºç å‰–æè¯´æ˜"><a href="#10-4-2-æºç å‰–æè¯´æ˜" class="headerlink" title="10.4.2 æºç å‰–æè¯´æ˜"></a>10.4.2 æºç å‰–æè¯´æ˜</h4><p>è¯´æ˜ åˆ†æè¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šçš„å›¾å½¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªæ–‡æ¡£ï¼Œåœ¨æ–‡æ¡£çš„åŸºç¡€ä¸Šæ¥åšæºç å‰–æ</p><h4 id="10-4-3-æºç å‰–æ"><a href="#10-4-3-æºç å‰–æ" class="headerlink" title="10.4.3 æºç å‰–æ"></a>10.4.3 æºç å‰–æ</h4><ol><li>ChannelPipeline | ChannelHandler | ChannelHandlerContextä»‹ç»</li><li>1 ä¸‰è€…å…³ç³»</li></ol><p>1)æ¯å½“ <code>ServerSocket</code> åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª <code>Socket</code>ï¼Œå¯¹åº”çš„å°±æ˜¯ç›®æ ‡å®¢æˆ·ç«¯ã€‚</p><p>2)æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ <code>Socket</code> éƒ½å°†ä¼šåˆ†é…ä¸€ä¸ªå…¨æ–°çš„ <code>ChannelPipeline</code>ï¼ˆä»¥ä¸‹ç®€ç§° <code>pipeline</code>ï¼‰</p><p>3)æ¯ä¸€ä¸ª <code>ChannelPipeline</code> å†…éƒ¨éƒ½å«æœ‰å¤šä¸ª <code>ChannelHandlerContext</code>ï¼ˆä»¥ä¸‹ç®€ç§° <code>Context</code>ï¼‰</p><p>4)ä»–ä»¬ä¸€èµ·ç»„æˆäº†åŒå‘é“¾è¡¨ï¼Œè¿™äº› <code>Context</code> ç”¨äºåŒ…è£…æˆ‘ä»¬è°ƒç”¨ <code>addLast</code> æ–¹æ³•æ—¶æ·»åŠ çš„ <code>ChannelHandler</code>ï¼ˆä»¥ä¸‹ç®€ç§° <code>handler</code>ï¼‰</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_02.png" alt="img"></p><p>1)ä¸Šå›¾ä¸­ï¼š<code>ChannelSocket</code> å’Œ <code>ChannelPipeline</code> æ˜¯ä¸€å¯¹ä¸€çš„å…³è”å…³ç³»ï¼Œè€Œ <code>pipeline</code> å†…éƒ¨çš„å¤šä¸ª <code>Context</code> å½¢æˆäº†é“¾è¡¨ï¼Œ<code>Context</code> åªæ˜¯å¯¹ <code>Handler</code> çš„å°è£…ã€‚ 2)å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ <code>Socket</code> å¯¹åº”çš„ <code>pipeline</code>ï¼Œå¹¶ç»è¿‡ <code>pipeline</code> æ‰€æœ‰çš„ <code>handler</code>ï¼Œå¯¹ï¼Œå°±æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„è¿‡æ»¤å™¨æ¨¡å¼ã€‚</p><p>1.2 ChannelPipeline ä½œç”¨åŠè®¾è®¡</p><p>1)<code>pipeline</code> çš„æ¥å£è®¾è®¡</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_03.png" alt="img"></p><p>éƒ¨åˆ†æºç </p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_04.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°è¯¥æ¥å£ç»§æ‰¿äº† <code>inBound</code>ï¼Œ<code>outBound</code>ï¼Œ<code>Iterable</code> æ¥å£ï¼Œè¡¨ç¤ºä»–å¯ä»¥è°ƒç”¨æ•°æ®å‡ºç«™çš„æ–¹æ³•å’Œå…¥ç«™çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿèƒ½éå†å†…éƒ¨çš„é“¾è¡¨ï¼Œçœ‹çœ‹ä»–çš„å‡ ä¸ªä»£è¡¨æ€§çš„æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é’ˆå¯¹ <code>handler</code> é“¾è¡¨çš„æ’å…¥ï¼Œè¿½åŠ ï¼Œåˆ é™¤ï¼Œæ›¿æ¢æ“ä½œï¼Œç±»ä¼¼æ˜¯ä¸€ä¸ª <code>LinkedList</code>ã€‚åŒæ—¶ï¼Œä¹Ÿèƒ½è¿”å› <code>channel</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>socket</code>ï¼‰</p><p>1)åœ¨ <code>pipeline</code> çš„æ¥å£æ–‡æ¡£ä¸Šï¼Œæä¾›äº†ä¸€å¹…å›¾</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_05.png" alt="img"></p><p>å¯¹ä¸Šå›¾çš„è§£é‡Šè¯´æ˜ï¼š *è¿™æ˜¯ä¸€ä¸ª <code>handler</code> çš„ <code>list</code>ï¼Œ<code>handler</code> ç”¨äºå¤„ç†æˆ–æ‹¦æˆªå…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶ï¼Œ<code>pipeline</code> å®ç°äº†è¿‡æ»¤å™¨çš„é«˜çº§å½¢å¼ï¼Œä»¥ä¾¿ç”¨æˆ·æ§åˆ¶äº‹ä»¶å¦‚ä½•å¤„ç†ä»¥åŠ <code>handler</code> åœ¨ <code>pipeline</code> ä¸­å¦‚ä½•äº¤äº’ã€‚</p><p>*ä¸Šå›¾æè¿°äº†ä¸€ä¸ªå…¸å‹çš„ <code>handler</code> åœ¨ <code>pipeline</code> ä¸­å¤„ç† <code>I/O</code> äº‹ä»¶çš„æ–¹å¼ï¼Œ<code>IO</code> äº‹ä»¶ç”± <code>inboundHandler</code> æˆ–è€… <code>outBoundHandler</code> å¤„ç†ï¼Œå¹¶é€šè¿‡è°ƒç”¨ <code>ChannelHandlerContext.fireChannelRead</code> æ–¹æ³•è½¬å‘ç»™å…¶æœ€è¿‘çš„å¤„ç†ç¨‹åºã€‚</p><p>*å…¥ç«™äº‹ä»¶ç”±å…¥ç«™å¤„ç†ç¨‹åºä»¥è‡ªä¸‹è€Œä¸Šçš„æ–¹å‘å¤„ç†ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚å…¥ç«™å¤„ç†ç¨‹åºé€šå¸¸å¤„ç†ç”±å›¾åº•éƒ¨çš„ <code>I/O</code> çº¿ç¨‹ç”Ÿæˆå…¥ç«™æ•°æ®ã€‚å…¥ç«™æ•°æ®é€šå¸¸ä»å¦‚ <code>SocketChannel.read(ByteBuffer)</code> è·å–ã€‚</p><p>*é€šå¸¸ä¸€ä¸ª <code>pipeline</code> æœ‰å¤šä¸ª <code>handler</code>ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå…¸å‹çš„æœåŠ¡å™¨åœ¨æ¯ä¸ªé€šé“çš„ç®¡é“ä¸­éƒ½ä¼šæœ‰ä»¥ä¸‹å¤„ç†ç¨‹åºåè®®è§£ç å™¨-å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸º <code>Java</code> å¯¹è±¡ã€‚åè®®ç¼–ç å™¨-å°† <code>Java</code> å¯¹è±¡è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®ã€‚ä¸šåŠ¡é€»è¾‘å¤„ç†ç¨‹åº-æ‰§è¡Œå®é™…ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚æ•°æ®åº“è®¿é—®ï¼‰</p><p>*ä½ çš„ä¸šåŠ¡ç¨‹åºä¸èƒ½å°†çº¿ç¨‹é˜»å¡ï¼Œä¼šå½±å“ <code>IO</code> çš„é€Ÿåº¦ï¼Œè¿›è€Œå½±å“æ•´ä¸ª <code>Netty</code> ç¨‹åºçš„æ€§èƒ½ã€‚å¦‚æœä½ çš„ä¸šåŠ¡ç¨‹åºå¾ˆå¿«ï¼Œå°±å¯ä»¥æ”¾åœ¨ <code>IO</code> çº¿ç¨‹ä¸­ï¼Œåä¹‹ï¼Œä½ éœ€è¦å¼‚æ­¥æ‰§è¡Œã€‚æˆ–è€…åœ¨æ·»åŠ  <code>handler</code> çš„æ—¶å€™æ·»åŠ ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¾‹å¦‚ï¼š</p><p>// ä¸‹é¢è¿™ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™ï¼Œå°†ä¸ä¼šé˜»å¡ <code>IO</code> çº¿ç¨‹ï¼Œæ‰§è¡Œçš„çº¿ç¨‹æ¥è‡ª <code>group</code> çº¿ç¨‹æ± </p><div class="code-wrapper"><pre><code class="hljs reasonml">pipeline.add<span class="hljs-constructor">Last(<span class="hljs-params">group</span>, <span class="hljs-string">&quot;handler&quot;</span>, <span class="hljs-params">new</span> MyBusinessLogicHandler()</span>);</code></pre></div><p>1.3 <code>ChannelHandler</code> ä½œç”¨åŠè®¾è®¡</p><p>1)æºç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ChannelHandler</span> </span>&#123;    <span class="hljs-comment">//å½“æŠŠ ChannelHandler æ·»åŠ åˆ° pipeline æ—¶è¢«è°ƒç”¨</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">handlerAdded</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception</span>;    <span class="hljs-comment">//å½“ä» pipeline ä¸­ç§»é™¤æ—¶è°ƒç”¨</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">handlerRemoved</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception</span>;    <span class="hljs-comment">//å½“å¤„ç†è¿‡ç¨‹ä¸­åœ¨ pipeline å‘ç”Ÿå¼‚å¸¸æ—¶è°ƒç”¨</span>    <span class="hljs-meta">@Deprecated</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception</span>;&#125;</code></pre></div><p>2)<code>ChannelHandler</code> çš„ä½œç”¨å°±æ˜¯å¤„ç† <code>IO</code> äº‹ä»¶æˆ–æ‹¦æˆª <code>IO</code> äº‹ä»¶ï¼Œå¹¶å°†å…¶è½¬å‘ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åº <code>ChannelHandler</code>ã€‚<code>Handler</code> å¤„ç†äº‹ä»¶æ—¶åˆ†å…¥ç«™å’Œå‡ºç«™çš„ï¼Œä¸¤ä¸ªæ–¹å‘çš„æ“ä½œéƒ½æ˜¯ä¸åŒçš„ï¼Œå› æ­¤ï¼Œ<code>Netty</code> å®šä¹‰äº†ä¸¤ä¸ªå­æ¥å£ç»§æ‰¿ <code>ChannelHandler</code></p><p>2)<code>ChannelInboundHandler</code> å…¥ç«™äº‹ä»¶æ¥å£</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_06.png" alt="img"></p><p>*<code>channelActive</code> ç”¨äºå½“ <code>Channel</code> å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶è¢«è°ƒç”¨ï¼›</p><p>*<code>channelRead</code> å½“ä» <code>Channel</code> è¯»å–æ•°æ®æ—¶è¢«è°ƒç”¨ç­‰ç­‰æ–¹æ³•ã€‚</p><p>*ç¨‹åºå‘˜éœ€è¦é‡å†™ä¸€äº›æ–¹æ³•ï¼Œå½“å‘ç”Ÿå…³æ³¨çš„äº‹ä»¶ï¼Œéœ€è¦åœ¨æ–¹æ³•ä¸­å®ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› ä¸ºå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>Netty</code> ä¼šå›è°ƒå¯¹åº”çš„æ–¹æ³•ã€‚</p><p>3)`ChannelOutboundHandler å‡ºç«™äº‹ä»¶æ¥å£</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_07.png" alt="img"></p><p>*<code>bind</code> æ–¹æ³•ï¼Œå½“è¯·æ±‚å°† <code>Channel</code> ç»‘å®šåˆ°æœ¬åœ°åœ°å€æ—¶è°ƒç”¨</p><p>*<code>close</code> æ–¹æ³•ï¼Œå½“è¯·æ±‚å…³é—­ <code>Channel</code> æ—¶è°ƒç”¨ç­‰ç­‰</p><p>*å‡ºç«™æ“ä½œéƒ½æ˜¯ä¸€äº›è¿æ¥å’Œå†™å‡ºæ•°æ®ç±»ä¼¼çš„æ–¹æ³•ã€‚</p><p>4)<code>ChannelDuplexHandler</code> å¤„ç†å‡ºç«™å’Œå…¥ç«™äº‹ä»¶</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_08.png" alt="img"></p><p>*<code>ChannelDuplexHandler</code> é—´æ¥å®ç°äº†å…¥ç«™æ¥å£å¹¶ç›´æ¥å®ç°äº†å‡ºç«™æ¥å£ã€‚</p><p>*æ˜¯ä¸€ä¸ªé€šç”¨çš„èƒ½å¤ŸåŒæ—¶å¤„ç†å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶çš„ç±»ã€‚</p><p>1.4 <code>ChannelHandlerContext</code> ä½œç”¨åŠè®¾è®¡</p><p>1)<code>ChannelHandlerContext</code> <code>UML</code> å›¾</p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_09.png" alt="img"></p><p><code>ChannelHandlerContext</code> ç»§æ‰¿äº†å‡ºç«™æ–¹æ³•è°ƒç”¨æ¥å£å’Œå…¥ç«™æ–¹æ³•è°ƒç”¨æ¥å£</p><p>1)<code>ChannelOutboundInvoker</code> å’Œ <code>ChannelInboundInvoker</code> éƒ¨åˆ†æºç </p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_10.png" alt="img"></p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_11.png" alt="img"></p><p>*è¿™ä¸¤ä¸ª <code>invoker</code> å°±æ˜¯é’ˆå¯¹å…¥ç«™æˆ–å‡ºç«™æ–¹æ³•æ¥çš„ï¼Œå°±æ˜¯åœ¨å…¥ç«™æˆ–å‡ºç«™ <code>handler</code> çš„å¤–å±‚å†åŒ…è£…ä¸€å±‚ï¼Œè¾¾åˆ°åœ¨æ–¹æ³•å‰åæ‹¦æˆªå¹¶åšä¸€äº›ç‰¹å®šæ“ä½œçš„ç›®çš„</p><p>2)<code>ChannelHandlerContext</code> éƒ¨åˆ†æºç </p><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter10_12.png" alt="img"></p><p>*<code>ChannelHandlerContext</code> ä¸ä»…ä»…æ—¶ç»§æ‰¿äº†ä»–ä»¬ä¸¤ä¸ªçš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿå®šä¹‰äº†ä¸€äº›è‡ªå·±çš„æ–¹æ³•</p><p>*è¿™äº›æ–¹æ³•èƒ½å¤Ÿè·å– <code>Context</code> ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯¹åº”çš„æ¯”å¦‚ <code>channel</code>ï¼Œ<code>executor</code>ï¼Œ<code>handler</code>ï¼Œ<code>pipeline</code>ï¼Œå†…å­˜åˆ†é…å™¨ï¼Œå…³è”çš„ <code>handler</code> æ˜¯å¦è¢«åˆ é™¤ã€‚</p><p>*<code>Context</code> å°±æ˜¯åŒ…è£…äº† <code>handler</code> ç›¸å…³çš„ä¸€åˆ‡ï¼Œä»¥æ–¹ä¾¿ <code>Context</code> å¯ä»¥åœ¨ <code>pipeline</code> æ–¹ä¾¿çš„æ“ä½œ <code>handler</code></p><p>2.ChannelPipeline | ChannelHandler | ChannelHandlerContext</p><p>åˆ›å»ºè¿‡ç¨‹åˆ†ä¸º <code>3</code> ä¸ªæ­¥éª¤æ¥çœ‹åˆ›å»ºçš„è¿‡ç¨‹ï¼š</p><p>*ä»»ä½•ä¸€ä¸ª <code>ChannelSocket</code> åˆ›å»ºçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>pipeline</code>ã€‚</p><p>*å½“ç”¨æˆ·æˆ–ç³»ç»Ÿå†…éƒ¨è°ƒç”¨ <code>pipeline</code> çš„ <code>add</code></p><p>*** æ–¹æ³•æ·»åŠ  <code>handler</code> æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªåŒ…è£…è¿™ <code>handler</code> çš„ <code>Context</code>ã€‚</p><p>*è¿™äº› <code>Context</code> åœ¨ <code>pipeline</code> ä¸­ç»„æˆäº†åŒå‘é“¾è¡¨ã€‚</p><p>2.1 <code>Socket</code> åˆ›å»ºçš„æ—¶å€™åˆ›å»º <code>pipeline</code> åœ¨ <code>SocketChannel</code> çš„æŠ½è±¡çˆ¶ç±» <code>AbstractChannel</code> çš„æ„é€ æ–¹æ³•ä¸­</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">AbstractChannel</span><span class="hljs-params">(Channel parent)</span> </span>&#123;    <span class="hljs-keyword">this</span>.parent=parent;<span class="hljs-comment">//æ–­ç‚¹æµ‹è¯•</span>    id = newId();    unsafe = <span class="hljs-keyword">new</span> Unsafe();    pipeline = <span class="hljs-keyword">new</span> ChannelPipeline();&#125;</code></pre></div><p><code>Debug</code> ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œç„¶åç»§ç»­è¿½è¸ªåˆ°</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">DefaultChannelPipeline</span><span class="hljs-params">(Channel channel)</span> </span>&#123;    <span class="hljs-keyword">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="hljs-string">&quot;channel&quot;</span>);    succeededFuture = <span class="hljs-keyword">new</span> SucceededChannelFuture(channel, <span class="hljs-keyword">null</span>);    voidPromise = <span class="hljs-keyword">new</span> VoidChannelPromise(channel, <span class="hljs-keyword">true</span>);    tail = <span class="hljs-keyword">new</span> TailContext(<span class="hljs-keyword">this</span>);    head = <span class="hljs-keyword">new</span> HeadContext(<span class="hljs-keyword">this</span>);    head.next = tail;    tail.prev = head;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><p>1ï¼‰å°† <code>channel</code> èµ‹å€¼ç»™ <code>channel</code> å­—æ®µï¼Œç”¨äº <code>pipeline</code> æ“ä½œ <code>channel</code>ã€‚</p><p>2ï¼‰åˆ›å»ºä¸€ä¸ª <code>future</code> å’Œ <code>promise</code>ï¼Œç”¨äºå¼‚æ­¥å›è°ƒä½¿ç”¨ã€‚</p><p>3ï¼‰åˆ›å»ºä¸€ä¸ª <code>inbound</code> çš„ <code>tailContext</code>ï¼Œåˆ›å»ºä¸€ä¸ªæ—¢æ˜¯ <code>inbound</code> ç±»å‹åˆæ˜¯ <code>outbound</code> ç±»å‹çš„ <code>headContext</code>ã€‚</p><p>4ï¼‰æœ€åï¼Œå°†ä¸¤ä¸ª <code>Context</code> äº’ç›¸è¿æ¥ï¼Œå½¢æˆåŒå‘é“¾è¡¨ã€‚</p><p>5ï¼‰<code>tailContext</code> å’Œ <code>HeadContext</code> éå¸¸çš„é‡è¦ï¼Œæ‰€æœ‰ <code>pipeline</code> ä¸­çš„äº‹ä»¶éƒ½ä¼šæµç»ä»–ä»¬ï¼Œ</p><p>2.2 åœ¨ add<strong>æ·»åŠ å¤„ç†å™¨çš„æ—¶å€™åˆ›å»ºContext</strong>çœ‹ä¸‹ <code>DefaultChannelPipeline</code> çš„ <code>addLast</code> æ–¹æ³•å¦‚ä½•åˆ›å»ºçš„ <code>Context</code>ï¼Œä»£ç å¦‚ä¸‹</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">addLast</span><span class="hljs-params">(EventExecutorGroup executor, ChannelHandler... handlers)</span> </span>&#123;    <span class="hljs-keyword">if</span> (handlers == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//æ–­ç‚¹</span>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException(<span class="hljs-string">&quot;handlers&quot;</span>);    &#125;    <span class="hljs-keyword">for</span> (ChannelHandler h : handlers) &#123;        <span class="hljs-keyword">if</span> (h == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">break</span>;        &#125;        addLast(executor, <span class="hljs-keyword">null</span>, h);    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;&#125;</code></pre></div><p>ç»§ç»­ Debug</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">addLast</span><span class="hljs-params">(EventExecutorGroup group, String name, ChannelHandler handler)</span> </span>&#123;    <span class="hljs-keyword">final</span> AbstractChannelHandlerContext newCtx;    <span class="hljs-keyword">synchronized</span>(<span class="hljs-keyword">this</span>) &#123;        checkMultiplicity(handler);        newCtx = newContext(group, filterName(name, handler), handler);        addLast0(newCtx);        <span class="hljs-comment">//If the registered is false it means that the channel was not registered on an eventloop yet.</span>        <span class="hljs-comment">//In this case we add the context to the pipeline and add a task that will call</span>        <span class="hljs-comment">//ChannelHandler.handlerAdded(...) once the channel is registered.</span>        <span class="hljs-keyword">if</span> (!registered) &#123;            newCtx.setAddPending();            callHandlerCallbackLater(newCtx, <span class="hljs-keyword">true</span>);            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;        &#125;        EventExecutor executor = newCtx.executor();        <span class="hljs-keyword">if</span> (!executor.inEventLoop()) &#123;            newCtx.setAddPending();            executor.execute(<span class="hljs-keyword">new</span> Runnable() &#123;                <span class="hljs-meta">@Override</span>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span> <span class="hljs-params">()</span> </span>&#123;                    callHandlerAdded0(newCtx);                &#125;            &#125;);            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;        &#125;    &#125;    callHandlerAdded0(newCtx);    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;&#125;</code></pre></div><p>è¯´æ˜ 1)<code>pipeline</code> æ·»åŠ  <code>handler</code>ï¼Œå‚æ•°æ˜¯çº¿ç¨‹æ± ï¼Œ<code>name</code> æ˜¯ <code>null</code>ï¼Œ<code>handler</code> æ˜¯æˆ‘ä»¬æˆ–è€…ç³»ç»Ÿä¼ å…¥çš„ <code>handler</code>ã€‚<code>Netty</code> ä¸ºäº†é˜²æ­¢å¤šä¸ªçº¿ç¨‹å¯¼è‡´å®‰å…¨é—®é¢˜ï¼ŒåŒæ­¥äº†è¿™æ®µä»£ç ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><p>2)æ£€æŸ¥è¿™ä¸ª <code>handler</code> å®ä¾‹æ˜¯å¦æ˜¯å…±äº«çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¹¶ä¸”å·²ç»è¢«åˆ«çš„ <code>pipeline</code> ä½¿ç”¨äº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>3)è°ƒç”¨ <code>new Context(group, filterName(name, handler), handler)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª <code>Context</code>ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œæ¯æ¬¡æ·»åŠ ä¸€ä¸ª <code>handler</code> éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…³è” <code>Context</code>ã€‚</p><p>4)è°ƒç”¨ <code>addLast</code> æ–¹æ³•ï¼Œå°† <code>Context</code> è¿½åŠ åˆ°é“¾è¡¨ä¸­ã€‚</p><p>5)å¦‚æœè¿™ä¸ªé€šé“è¿˜æ²¡æœ‰æ³¨å†Œåˆ° <code>selecor</code> ä¸Šï¼Œå°±å°†è¿™ä¸ª <code>Context</code> æ·»åŠ åˆ°è¿™ä¸ª <code>pipeline</code> çš„å¾…åŠä»»åŠ¡ä¸­ã€‚å½“æ³¨å†Œå¥½äº†ä»¥åï¼Œå°±ä¼šè°ƒç”¨ <code>callHandlerAdded0</code> æ–¹æ³•ï¼ˆé»˜è®¤æ˜¯ä»€ä¹ˆéƒ½ä¸åšï¼Œç”¨æˆ·å¯ä»¥å®ç°è¿™ä¸ªæ–¹æ³•ï¼‰ã€‚</p><p>6)åˆ°è¿™é‡Œï¼Œé’ˆå¯¹ä¸‰å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ï¼Œäº†è§£çš„å·®ä¸å¤šäº†ï¼Œå’Œæœ€åˆè¯´çš„ä¸€æ ·ï¼Œæ¯å½“åˆ›å»º <code>ChannelSocket</code> çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç»‘å®šçš„ <code>pipeline</code>ï¼Œä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œåˆ›å»º <code>pipeline</code> çš„æ—¶å€™ä¹Ÿä¼šåˆ›å»º <code>tail</code> èŠ‚ç‚¹å’Œ <code>head</code> èŠ‚ç‚¹ï¼Œå½¢æˆæœ€åˆçš„é“¾è¡¨ã€‚<code>tail</code> æ˜¯å…¥ç«™ <code>inbound</code> ç±»å‹çš„ <code>handler</code>ï¼Œ<code>head</code> æ—¢æ˜¯ <code>inbound</code> ä¹Ÿæ˜¯ <code>outbound</code> ç±»å‹çš„ <code>handler</code>ã€‚åœ¨è°ƒç”¨ <code>pipeline</code> çš„ <code>addLast</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç»™å®šçš„ <code>handler</code> åˆ›å»ºä¸€ä¸ª <code>Context</code>ï¼Œç„¶åï¼Œå°†è¿™ä¸ª <code>Context</code> æ’å…¥åˆ°é“¾è¡¨çš„å°¾ç«¯ï¼ˆ<code>tail</code> å‰é¢ï¼‰ã€‚åˆ°æ­¤å°± <code>OK</code> äº†ã€‚</p><h4 id="10-4-4-Pipeline-Handler-HandlerContext-åˆ›å»ºè¿‡ç¨‹æ¢³ç†"><a href="#10-4-4-Pipeline-Handler-HandlerContext-åˆ›å»ºè¿‡ç¨‹æ¢³ç†" class="headerlink" title="10.4.4 Pipeline Handler HandlerContext åˆ›å»ºè¿‡ç¨‹æ¢³ç†"></a>10.4.4 Pipeline Handler HandlerContext åˆ›å»ºè¿‡ç¨‹æ¢³ç†</h4><ol><li>æ¯å½“åˆ›å»º <code>ChannelSocket</code> çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç»‘å®šçš„ <code>pipeline</code>ï¼Œä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œåˆ›å»º <code>pipeline</code> çš„æ—¶å€™ä¹Ÿä¼šåˆ›å»º <code>tail</code> èŠ‚ç‚¹å’Œ <code>head</code> èŠ‚ç‚¹ï¼Œå½¢æˆæœ€åˆçš„é“¾è¡¨ã€‚</li><li>åœ¨è°ƒç”¨ <code>pipeline</code> çš„ <code>addLast</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç»™å®šçš„ <code>handler</code> åˆ›å»ºä¸€ä¸ª <code>Context</code>ï¼Œç„¶åï¼Œå°†è¿™ä¸ª <code>Context</code> æ’å…¥åˆ°é“¾è¡¨çš„å°¾ç«¯ï¼ˆ<code>tail</code> å‰é¢ï¼‰ã€‚</li><li><code>Context</code> åŒ…è£… <code>handler</code>ï¼Œå¤šä¸ª <code>Context</code> åœ¨ <code>pipeline</code> ä¸­å½¢æˆäº†åŒå‘é“¾è¡¨</li><li>å…¥ç«™æ–¹å‘å« <code>inbound</code>ï¼Œç”± <code>head</code> èŠ‚ç‚¹å¼€å§‹ï¼Œå‡ºç«™æ–¹æ³•å« <code>outbound</code>ï¼Œç”± <code>tail</code> èŠ‚ç‚¹å¼€å§‹</li></ol><h3 id="10-5-ChannelPipeline-è°ƒåº¦-handler-çš„æºç å‰–æ"><a href="#10-5-ChannelPipeline-è°ƒåº¦-handler-çš„æºç å‰–æ" class="headerlink" title="10.5 ChannelPipeline è°ƒåº¦ handler çš„æºç å‰–æ"></a>10.5 ChannelPipeline è°ƒåº¦ handler çš„æºç å‰–æ</h3><h4 id="10-5-1-æºç å‰–æç›®çš„"><a href="#10-5-1-æºç å‰–æç›®çš„" class="headerlink" title="10.5.1 æºç å‰–æç›®çš„"></a>10.5.1 æºç å‰–æç›®çš„</h4><ol><li>å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œ<code>ChannelPipeline</code> æ˜¯å¦‚ä½•è°ƒç”¨å†…éƒ¨çš„è¿™äº› <code>handler</code> çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥åˆ†æä¸‹ã€‚</li><li>é¦–å…ˆï¼Œå½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œä¼šç¬¬ä¸€ä¸ªè°ƒç”¨ <code>pipeline</code> çš„ç›¸å…³æ–¹æ³•ï¼Œå¦‚æœæ˜¯å…¥ç«™äº‹ä»¶ï¼Œè¿™äº›æ–¹æ³•ç”± <code>fire</code> å¼€å¤´ï¼Œè¡¨ç¤ºå¼€å§‹ç®¡é“çš„æµåŠ¨ã€‚è®©åé¢çš„ <code>handler</code> ç»§ç»­å¤„ç†</li></ol><h4 id="10-5-2-æºç å‰–æ"><a href="#10-5-2-æºç å‰–æ" class="headerlink" title="10.5.2 æºç å‰–æ"></a>10.5.2 æºç å‰–æ</h4><p>å½“æµè§ˆå™¨è¾“å…¥ <code>http://localhost:8007</code> ã€‚å¯ä»¥çœ‹åˆ°ä¼šæ‰§è¡Œ <code>handler</code> åœ¨ <code>Debug</code> æ—¶ï¼Œå¯ä»¥å°†æ–­ç‚¹ä¸‹åœ¨ <code>DefaultChannelPipeline</code> ç±»çš„</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireChannelActive</span><span class="hljs-params">()</span> </span>&#123;    AbstractChannelHandlerContext.invokeChannelActive(head);<span class="hljs-comment">//æ–­ç‚¹</span>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;&#125;</code></pre></div><p>æºç åˆ†æ</p><ol><li><code>DefaultChannelPipeline</code> æ˜¯å¦‚ä½•å®ç°è¿™äº› <code>fire</code> æ–¹æ³•çš„ 3.1 <code>DefaultChannelPipeline</code> æºç </li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultChannelPipeline</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelPipeline</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireChannelActive</span><span class="hljs-params">()</span> </span>&#123;        AbstractChannelHandlerContext.invokeChannelActive(head);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-title">ChannelPipelinefireChannelInactive</span><span class="hljs-params">()</span> </span>&#123;        AbstractChannelHandlerContext.invokeChannelInactive(head);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireExceptionCaught</span><span class="hljs-params">(Throwable cause)</span> </span>&#123;        AbstractChannelHandlerContext.invokeExceptionCaught(head, cause);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireUserEventTriggered</span><span class="hljs-params">(Object event)</span> </span>&#123;        AbstractChannelHandlerContext.invokeUserEventTriggered(head, event);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireChannelRead</span><span class="hljs-params">(Objectmsg)</span> </span>&#123;        AbstractChannelHandlerContext.invokeChannelRead(head, msg);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireChannelReadComplete</span><span class="hljs-params">()</span> </span>&#123;        AbstractChannelHandlerContext.invokeChannelReadComplete(head);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">fireChannelWritabilityChanged</span><span class="hljs-params">()</span> </span>&#123;        AbstractChannelHandlerContext.invokeChannelWritabilityChanged(head);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ <code>inbound</code> çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å…¥ç«™äº‹ä»¶ï¼Œè°ƒç”¨é™æ€æ–¹æ³•ä¼ å…¥çš„ä¹Ÿæ˜¯ <code>inbound</code> çš„ç±»å‹ <code>head</code> <code>handler</code>ã€‚è¿™äº›é™æ€æ–¹æ³•åˆ™ä¼šè°ƒç”¨ <code>head</code> çš„ <code>ChannelInboundInvoker</code> æ¥å£çš„æ–¹æ³•ï¼Œå†ç„¶åè°ƒç”¨ <code>handler</code> çš„çœŸæ­£æ–¹æ³•</p><p>3.2å†çœ‹ä¸‹ <code>piepline</code> çš„ <code>outbound</code> çš„ <code>fire</code> æ–¹æ³•å®ç°æºç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultChannelPipeline</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelPipeline</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">bind</span><span class="hljs-params">(SocketAddress localAddress)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.bind(localAddress);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">connect</span><span class="hljs-params">(SocketAddress remoteAddress)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.connect(remoteAddress);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">connect</span><span class="hljs-params">(SocketAddress remoteAddress, SocketAddress localAddress)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.connect(remoteAddress, localAddress);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">disconnect</span><span class="hljs-params">()</span></span>&#123;        <span class="hljs-keyword">return</span> tail.disconnect();    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.close();    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">deregister</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.deregister();    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelPipeline <span class="hljs-title">flush</span><span class="hljs-params">()</span> </span>&#123;        tail.flush();        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">bind</span><span class="hljs-params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.bind(localAddress, promise);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">connect</span><span class="hljs-params">(SocketAddress remoteAddress, ChannelPromise promise)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.connect(remoteAddress, promise);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">connect</span><span class="hljs-params">(SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.connect(remoteAddress, localAddress, promise);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ChannelFuture <span class="hljs-title">disconnect</span><span class="hljs-params">(ChannelPromise promise)</span> </span>&#123;        <span class="hljs-keyword">return</span> tail.disconnect(promise);    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><p>1)è¿™äº›éƒ½æ˜¯å‡ºç«™çš„å®ç°ï¼Œä½†æ˜¯è°ƒç”¨çš„æ˜¯ <code>outbound</code> ç±»å‹çš„ <code>tailhandler</code> æ¥è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯ <code>outbound</code> äº‹ä»¶ã€‚</p><p>2)å‡ºç«™æ˜¯ <code>tail</code> å¼€å§‹ï¼Œå…¥ç«™ä» <code>head</code> å¼€å§‹ã€‚å› ä¸ºå‡ºç«™æ˜¯ä»å†…éƒ¨å‘å¤–é¢å†™ï¼Œä» <code>tail</code> å¼€å§‹ï¼Œèƒ½å¤Ÿè®©å‰é¢çš„ <code>handler</code> è¿›è¡Œå¤„ç†ï¼Œé˜²æ­¢ <code>handler</code> è¢«é—æ¼ï¼Œæ¯”å¦‚ç¼–ç ã€‚åä¹‹ï¼Œå…¥ç«™å½“ç„¶æ˜¯ä» <code>head</code> å¾€å†…éƒ¨è¾“å…¥ï¼Œè®©åé¢çš„ <code>handler</code> èƒ½å¤Ÿå¤„ç†è¿™äº›è¾“å…¥çš„æ•°æ®ã€‚æ¯”å¦‚è§£ç ã€‚å› æ­¤è™½ç„¶ <code>head</code> ä¹Ÿå®ç°äº† <code>outbound</code> æ¥å£ï¼Œä½†ä¸æ˜¯ä» head å¼€å§‹æ‰§è¡Œå‡ºç«™ä»»åŠ¡</p><p>4.å…³äºå¦‚ä½•è°ƒåº¦ï¼Œç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤º:</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_13.png" alt="img"></p><p>è¯´æ˜ï¼š 1)<code>pipeline</code> é¦–å…ˆä¼šè°ƒç”¨ <code>Context</code> çš„é™æ€æ–¹æ³• <code>fireXXX</code>ï¼Œå¹¶ä¼ å…¥ <code>Context</code></p><p>2)ç„¶åï¼Œé™æ€æ–¹æ³•è°ƒç”¨ <code>Context</code> çš„ <code>invoker</code> æ–¹æ³•ï¼Œè€Œ <code>invoker</code> æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨è¯¥ <code>Context</code> æ‰€åŒ…å«çš„ <code>Handler</code> çš„çœŸæ­£çš„ <code>XXX</code> æ–¹æ³•ï¼Œè°ƒç”¨ç»“æŸåï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­å‘åä¼ é€’ï¼Œå°±è°ƒç”¨ <code>Context</code> çš„ <code>fireXXX2</code> æ–¹æ³•ï¼Œå¾ªç¯å¾€å¤ã€‚</p><h4 id="10-5-3-ChannelPipeline-è°ƒåº¦-handler-æ¢³ç†"><a href="#10-5-3-ChannelPipeline-è°ƒåº¦-handler-æ¢³ç†" class="headerlink" title="10.5.3 ChannelPipeline è°ƒåº¦ handler æ¢³ç†"></a>10.5.3 ChannelPipeline è°ƒåº¦ handler æ¢³ç†</h4><ol><li><code>Context</code> åŒ…è£… <code>handler</code>ï¼Œå¤šä¸ª <code>Context</code> åœ¨ <code>pipeline</code> ä¸­å½¢æˆäº†åŒå‘é“¾è¡¨ï¼Œå…¥ç«™æ–¹å‘å« <code>inbound</code>ï¼Œç”± <code>head</code> èŠ‚ç‚¹å¼€å§‹ï¼Œå‡ºç«™æ–¹æ³•å« <code>outbound</code>ï¼Œç”± <code>tail</code> èŠ‚ç‚¹å¼€å§‹ã€‚</li><li>è€ŒèŠ‚ç‚¹ä¸­é—´çš„ä¼ é€’é€šè¿‡ <code>Abstract ChannelHandlerContext</code> ç±»å†…éƒ¨çš„ <code>fire</code> ç³»åˆ—æ–¹æ³•ï¼Œæ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ–­çš„å¾ªç¯ä¼ æ’­ã€‚æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨å½¢å¼å®Œæˆå¯¹ <code>handler</code> çš„è°ƒåº¦</li></ol><h3 id="10-6-Netty-å¿ƒè·³-heartbeat-æœåŠ¡æºç å‰–æ"><a href="#10-6-Netty-å¿ƒè·³-heartbeat-æœåŠ¡æºç å‰–æ" class="headerlink" title="10.6 Netty å¿ƒè·³(heartbeat)æœåŠ¡æºç å‰–æ"></a>10.6 Netty å¿ƒè·³(heartbeat)æœåŠ¡æºç å‰–æ</h3><h4 id="10-6-1-æºç å‰–æç›®çš„"><a href="#10-6-1-æºç å‰–æç›®çš„" class="headerlink" title="10.6.1 æºç å‰–æç›®çš„"></a>10.6.1 æºç å‰–æç›®çš„</h4><p><code>Netty</code> ä½œä¸ºä¸€ä¸ªç½‘ç»œæ¡†æ¶ï¼Œæä¾›äº†è¯¸å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ç¼–ç è§£ç ç­‰ï¼Œ<code>Netty</code> è¿˜æä¾›äº†éå¸¸é‡è¦çš„ä¸€ä¸ªæœåŠ¡ â€“ å¿ƒè·³æœºåˆ¶ <code>heartbeat</code>ã€‚é€šè¿‡å¿ƒè·³æ£€æŸ¥å¯¹æ–¹æ˜¯å¦æœ‰æ•ˆï¼Œè¿™æ˜¯ <code>RPC</code> æ¡†æ¶ä¸­æ˜¯å¿…ä¸å¯å°‘çš„åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹ <code>Netty</code> å†…éƒ¨å¿ƒè·³æœåŠ¡æºç å®ç°ã€‚</p><h4 id="10-6-2-æºç å‰–æ"><a href="#10-6-2-æºç å‰–æ" class="headerlink" title="10.6.2 æºç å‰–æ"></a>10.6.2 æºç å‰–æ</h4><p><code>Netty</code> æä¾›äº† <code>IdleStateHandler</code>ï¼Œ<code>ReadTimeoutHandler</code>ï¼Œ<code>WriteTimeoutHandler</code> ä¸‰ä¸ª <code>Handler</code> æ£€æµ‹è¿æ¥çš„æœ‰æ•ˆæ€§ï¼Œé‡ç‚¹åˆ†æ <code>IdleStateHandler</code>ã€‚</p><p>å¦‚å›¾</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_14.png" alt="img"></p><p>æºç å‰–æï¼š</p><p>5.<code>Netty</code> æä¾›çš„å¿ƒè·³ä»‹ç»</p><p>1)<code>Netty</code> æä¾›äº† <code>IdleStateHandler</code>ï¼Œ<code>ReadTimeoutHandler</code>ï¼Œ<code>WriteTimeoutHandler</code> ä¸‰ä¸ª <code>Handler</code> æ£€æµ‹è¿æ¥çš„æœ‰æ•ˆæ€§ã€‚</p><p>2)å¦‚å›¾</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_15.png" alt="img"></p><p>3)<code>ReadTimeout</code> äº‹ä»¶å’Œ <code>WriteTimeout</code> äº‹ä»¶éƒ½ä¼šè‡ªåŠ¨å…³é—­è¿æ¥ï¼Œè€Œä¸”ï¼Œå±äºå¼‚å¸¸å¤„ç†ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œåªæ˜¯ä»‹ç»ä»¥ä¸‹ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ <code>IdleStateHandler</code>ã€‚</p><p>6.<code>IdleStateHandler</code> åˆ†æ</p><p>6.1 <code>4</code> ä¸ªå±æ€§</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> observeOutput; <span class="hljs-comment">//æ˜¯å¦è€ƒè™‘å‡ºç«™æ—¶è¾ƒæ…¢çš„æƒ…å†µã€‚é»˜è®¤å€¼æ˜¯ false</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> readerIdleTimeNanos; <span class="hljs-comment">//è¯»äº‹ä»¶ç©ºé—²æ—¶é—´ï¼Œ0 åˆ™ç¦ç”¨äº‹ä»¶</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> writerIdleTimeNanos;<span class="hljs-comment">//å†™äº‹ä»¶ç©ºé—²æ—¶é—´ï¼Œ0 åˆ™ç¦ç”¨äº‹ä»¶</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> allIdleTimeNanos;<span class="hljs-comment">//è¯»æˆ–å†™ç©ºé—²æ—¶é—´ï¼Œ0 åˆ™ç¦ç”¨äº‹ä»¶</span></code></pre></div><p>6.2<code>handlerAdded</code> æ–¹æ³•</p><p>å½“è¯¥ <code>handler</code> è¢«æ·»åŠ åˆ° <code>pipeline</code> ä¸­æ—¶ï¼Œåˆ™è°ƒç”¨ <code>initialize</code> æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> </span>&#123;    <span class="hljs-comment">//Avoid the case where destroy() is called before scheduling timeouts.</span>    <span class="hljs-comment">//See:https://github.com/netty/netty/issues/143</span>    <span class="hljs-keyword">switch</span>(state) &#123;        case1:        case2:            <span class="hljs-keyword">return</span>;    &#125;        state=<span class="hljs-number">1</span>;    initOutputChanged(ctx);        lastReadTime = lastWriteTime = ticksInNanos();        <span class="hljs-keyword">if</span>(readerIdleTimeNanos &gt; <span class="hljs-number">0</span>) &#123;        <span class="hljs-comment">//è¿™é‡Œçš„ schedule æ–¹æ³•ä¼šè°ƒç”¨ eventLoop çš„ schedule æ–¹æ³•ï¼Œå°†å®šæ—¶ä»»åŠ¡æ·»åŠ è¿›é˜Ÿåˆ—ä¸­</span>        readerIdleTimeout = schedule(ctx, <span class="hljs-keyword">new</span> ReaderIdleTimeoutTask(ctx), readerIdleTimeNanos, TimeUnit.NANOSECONDS);    &#125;        <span class="hljs-keyword">if</span>(writerIdleTimeNanos &gt; <span class="hljs-number">0</span>) &#123;        writerIdleTimeout = schedule(ctx, <span class="hljs-keyword">new</span> WriterIdleTimeoutTask(ctx), writerIdleTimeNanos, TimeUnit.NANOSECONDS);    &#125;        <span class="hljs-keyword">if</span>(allIdleTimeNanos &gt; <span class="hljs-number">0</span>) &#123;        allIdleTimeout = schedule(ctx, <span class="hljs-keyword">new</span> AllIdleTimeoutTask(ctx), allIdleTimeNanos, TimeUnit.NANOSECONDS);    &#125;&#125;</code></pre></div><p>åªè¦ç»™å®šçš„å‚æ•°å¤§äº <code>0</code>ï¼Œå°±åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸ªäº‹ä»¶éƒ½åˆ›å»ºã€‚åŒæ—¶ï¼Œå°† <code>state</code> çŠ¶æ€è®¾ç½®ä¸º <code>1</code>ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–ã€‚è°ƒç”¨ <code>initOutputChanged</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–â€œç›‘æ§å‡ºç«™æ•°æ®å±æ€§â€ã€‚</p><p>6.3è¯¥ç±»å†…éƒ¨çš„ <code>3</code> ä¸ªå®šæ—¶ä»»åŠ¡ç±»</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_16.png" alt="img"></p><p>1)è¿™ <code>3</code> ä¸ªå®šæ—¶ä»»åŠ¡åˆ†åˆ«å¯¹åº”è¯»ï¼Œå†™ï¼Œè¯»æˆ–è€…å†™äº‹ä»¶ã€‚å…±æœ‰ä¸€ä¸ªçˆ¶ç±»ï¼ˆ<code>AbstractIdleTask</code>ï¼‰ã€‚è¿™ä¸ªçˆ¶ç±»æä¾›äº†ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractIdleTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChannelHandlerContext ctx;        AbstractIdleTask(ChannelHandlerContext ctx) &#123;        <span class="hljs-keyword">this</span>.ctx = ctx;    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">if</span>(!ctx.channel().isOpen()) &#123;            <span class="hljs-keyword">return</span>;        &#125;        run(ctx);    &#125;        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(ChannelHandlerContext ctx)</span></span>;&#125;</code></pre></div><p>è¯´æ˜ï¼šå½“é€šé“å…³é—­äº†ï¼Œå°±ä¸æ‰§è¡Œä»»åŠ¡äº†ã€‚åä¹‹ï¼Œæ‰§è¡Œå­ç±»çš„ <code>run</code> æ–¹æ³•</p><p>7.è¯»äº‹ä»¶çš„ <code>run</code> æ–¹æ³•ï¼ˆå³ <code>ReaderIdleTimeoutTask</code> çš„ <code>run</code> æ–¹æ³•ï¼‰åˆ†æ</p><p>1)ä»£ç åŠå…¶è¯´æ˜</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> </span>&#123;    <span class="hljs-keyword">long</span> nextDelay = readerIdleTimeNanos;    <span class="hljs-keyword">if</span>(!reading) &#123;        nextDelay -= ticksInNanos() - lastReadTime;    &#125;        <span class="hljs-keyword">if</span>(nextDelay &lt;= <span class="hljs-number">0</span>) &#123;        <span class="hljs-comment">//Reader is idle-set a new timeout and notify the callback.</span>        <span class="hljs-comment">//ç”¨äºå–æ¶ˆä»»åŠ¡ promise</span>        readerIdleTimeout = schedule(ctx, <span class="hljs-keyword">this</span>, readerIdleTimeNanos, TimeUnit.NANOSECONDS);        <span class="hljs-keyword">boolean</span> first = firstReaderIdleEvent;        firstReaderIdleEvent = <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">//å†æ¬¡æäº¤ä»»åŠ¡</span>            IdleStateEvent event = <span class="hljs-keyword">new</span> IdleStateEvent(IdleState.READER_IDLE, first);            <span class="hljs-comment">//è§¦å‘ç”¨æˆ· handler use</span>            channelIdle(ctx, event);        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;            ctx.fireExceptionCaught(t);        &#125;    &#125; <span class="hljs-keyword">else</span> &#123;        <span class="hljs-comment">//Read occurred before the timeout - set a new timeout with shorter delay.</span>        readerIdleTimeout = schedule(ctx, <span class="hljs-keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><p>1)å¾—åˆ°ç”¨æˆ·è®¾ç½®çš„è¶…æ—¶æ—¶é—´ã€‚</p><p>2)å¦‚æœè¯»å–æ“ä½œç»“æŸäº†ï¼ˆæ‰§è¡Œäº† <code>channelReadComplete</code> æ–¹æ³•è®¾ç½®ï¼‰ï¼Œå°±ç”¨å½“å‰æ—¶é—´å‡å»ç»™å®šæ—¶é—´å’Œæœ€åä¸€æ¬¡è¯»ï¼ˆæ‰§æ“ä½œçš„æ—¶é—´è¡Œäº† <code>channelReadComplete</code> æ–¹æ³•è®¾ç½®ï¼‰ï¼Œå¦‚æœå°äº <code>0</code>ï¼Œå°±è§¦å‘äº‹ä»¶ã€‚åä¹‹ï¼Œç»§ç»­æ”¾å…¥é˜Ÿåˆ—ã€‚é—´éš”æ—¶é—´æ˜¯æ–°çš„è®¡ç®—æ—¶é—´ã€‚</p><p>3)è§¦å‘çš„é€»è¾‘æ˜¯ï¼šé¦–å…ˆå°†ä»»åŠ¡å†æ¬¡æ”¾åˆ°é˜Ÿåˆ—ï¼Œæ—¶é—´æ˜¯åˆšå¼€å§‹è®¾ç½®çš„æ—¶é—´ï¼Œè¿”å›ä¸€ä¸ª <code>promise</code> å¯¹è±¡ï¼Œç”¨äºåšå–æ¶ˆæ“ä½œã€‚ç„¶åï¼Œè®¾ç½® <code>first</code> å±æ€§ä¸º<code>false</code>ï¼Œè¡¨ç¤ºï¼Œä¸‹ä¸€æ¬¡è¯»å–ä¸å†æ˜¯ç¬¬ä¸€æ¬¡äº†ï¼Œè¿™ä¸ªå±æ€§åœ¨ <code>channelRead</code> æ–¹æ³•ä¼šè¢«æ”¹æˆ <code>true</code>ã€‚</p><p>4)åˆ›å»ºä¸€ä¸ª <code>IdleStateEvent</code> ç±»å‹çš„å†™äº‹ä»¶å¯¹è±¡ï¼Œå°†æ­¤å¯¹è±¡ä¼ é€’ç»™ç”¨æˆ·çš„ <code>UserEventTriggered</code> æ–¹æ³•ã€‚å®Œæˆè§¦å‘äº‹ä»¶çš„æ“ä½œã€‚</p><p>5)æ€»çš„æ¥è¯´ï¼Œæ¯æ¬¡è¯»å–æ“ä½œéƒ½ä¼šè®°å½•ä¸€ä¸ªæ—¶é—´ï¼Œå®šæ—¶ä»»åŠ¡æ—¶é—´åˆ°äº†ï¼Œä¼šè®¡ç®—å½“å‰æ—¶é—´å’Œæœ€åä¸€æ¬¡è¯»çš„æ—¶é—´çš„é—´éš”ï¼Œå¦‚æœé—´éš”è¶…è¿‡äº†è®¾ç½®çš„æ—¶é—´ï¼Œå°±è§¦å‘ <code>UserEventTriggered</code> æ–¹æ³•ã€‚//å‰é¢ä»‹ç» <code>IdleStateHandler</code> è¯´è¿‡,å¯ä»¥çœ‹ä¸€ä¸‹</p><p>8.å†™äº‹ä»¶çš„ <code>run</code> æ–¹æ³•ï¼ˆå³ <code>WriterIdleTimeoutTask</code> çš„ <code>run</code> æ–¹æ³•ï¼‰åˆ†æ</p><p>1)<code>run</code> ä»£ç å’Œåˆ†æ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> </span>&#123;    <span class="hljs-keyword">long</span> lastWriteTime = IdleStateHandler.<span class="hljs-keyword">this</span>.lastWriteTime;    <span class="hljs-keyword">long</span> nextDelay = writerIdleTimeNanos - (ticksInNanos()-lastWriteTime);    <span class="hljs-keyword">if</span> (nextDelay &lt;=<span class="hljs-number">0</span> ) &#123;        <span class="hljs-comment">//Writer is idle - set a new timeout and notify the callback.</span>        writerIdleTimeout = schedule(ctx, <span class="hljs-keyword">this</span>, writerIdleTimeNanos, TimeUnit.NANOSECONDS);        <span class="hljs-keyword">boolean</span> first = firstWriterIdleEvent;        firstWriterIdleEvent = <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">if</span>(hasOutputChanged(ctx, first)) &#123;                <span class="hljs-keyword">return</span>;            &#125;                        IdleStateEvent event = <span class="hljs-keyword">new</span> IdleStateEvent(IdleState.WRITER_IDLE, first);            channelIdle(ctx, event);        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;            ctx.fireExceptionCaught(t);        &#125;    &#125; <span class="hljs-keyword">else</span> &#123;        <span class="hljs-comment">//Write occurred before the timeout - set a new timeout with shorter delay.</span>        writerIdleTimeout = schedule(ctx, <span class="hljs-keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼šå†™ä»»åŠ¡çš„ <code>run</code> ä»£ç é€»è¾‘åŸºæœ¬å’Œè¯»ä»»åŠ¡çš„é€»è¾‘ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯æœ‰ä¸€ä¸ªé’ˆå¯¹å‡ºç«™è¾ƒæ…¢æ•°æ®çš„åˆ¤æ–­ <code>hasOutputChanged</code></p><p>9.æ‰€æœ‰äº‹ä»¶çš„ <code>run</code> æ–¹æ³•ï¼ˆå³ <code>AllIdleTimeoutTask</code> çš„ <code>run</code> æ–¹æ³•ï¼‰åˆ†æ</p><p>ä»£ç åˆ†æ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> </span>&#123;    <span class="hljs-keyword">long</span> nextDelay = allIdleTimeNanos;    <span class="hljs-keyword">if</span>(!reading) &#123;        nextDelay -= ticksInNanos() - Math.max(lastReadTime, lastWriteTime);    &#125;        <span class="hljs-keyword">if</span>(nextDelay &lt;= <span class="hljs-number">0</span>) &#123;        <span class="hljs-comment">//Both reader and writer are idle - set a new timeout and</span>        <span class="hljs-comment">//notify the callback.</span>        allIdleTimeout = schedule(ctx, <span class="hljs-keyword">this</span>, allIdleTimeNanos, TimeUnit.NANOSECONDS);        <span class="hljs-keyword">boolean</span> first = firstAllIdleEvent;        firstAllIdleEvent = <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">if</span>(hasOutputChanged(ctx, first)) &#123;                <span class="hljs-keyword">return</span>;            &#125;                        IdleStateEvent event = <span class="hljs-keyword">new</span> IdleStateEvent(IdleState.ALL_IDLE, first);            channelIdle(ctx, event);        &#125; <span class="hljs-keyword">catch</span>(Throwable t) &#123;            ctx.fireExceptionCaught(t);        &#125;    &#125; <span class="hljs-keyword">else</span> &#123;        <span class="hljs-comment">//Either read or write occurred before the timeout - set a new</span>        <span class="hljs-comment">//timeout with shorter delay.</span>        allIdleTimeout = schedule(ctx, <span class="hljs-keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š</p><p>1)è¡¨ç¤ºè¿™ä¸ªç›‘æ§ç€æ‰€æœ‰çš„äº‹ä»¶ã€‚å½“è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œéƒ½ä¼šè®°å½•ã€‚ä»£ç é€»è¾‘å’Œå†™äº‹ä»¶çš„çš„åŸºæœ¬ä¸€è‡´ï¼š</p><p>2)éœ€è¦å¤§å®¶æ³¨æ„çš„åœ°æ–¹æ˜¯</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">long</span> nextDelay = allIdleTimeNanos;<span class="hljs-keyword">if</span>(!reading) &#123;    <span class="hljs-comment">//å½“å‰æ—¶é—´å‡å»æœ€åä¸€æ¬¡å†™æˆ–è¯»çš„æ—¶é—´ï¼Œè‹¥å¤§äº 0ï¼Œè¯´æ˜è¶…æ—¶äº†</span>    nextDelay -= ticksInNanos() - Math.max(lastReadTime, lastWriteTime);&#125;</code></pre></div><p>3)è¿™é‡Œçš„æ—¶é—´è®¡ç®—æ˜¯å–è¯»å†™äº‹ä»¶ä¸­çš„æœ€å¤§å€¼æ¥çš„ã€‚ç„¶ååƒå†™äº‹ä»¶ä¸€æ ·ï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†å†™çš„æ…¢çš„æƒ…å†µã€‚</p><p>10.å°ç»“ <code>Netty</code> çš„å¿ƒè·³æœºåˆ¶</p><p>1)<code>IdleStateHandler</code> å¯ä»¥å®ç°å¿ƒè·³åŠŸèƒ½ï¼Œå½“æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•è¯»å†™äº¤äº’æ—¶ï¼Œå¹¶è¶…è¿‡äº†ç»™å®šçš„æ—¶é—´ï¼Œåˆ™ä¼šè§¦å‘ç”¨æˆ· <code>handler</code> çš„ <code>userEventTriggered</code> æ–¹æ³•ã€‚ç”¨æˆ·å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°è¯•å‘å¯¹æ–¹å‘é€ä¿¡æ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™å…³é—­è¿æ¥ã€‚</p><p>2)<code>IdleStateHandler</code> çš„å®ç°åŸºäº <code>EventLoop</code> çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯æ¬¡è¯»å†™éƒ½ä¼šè®°å½•ä¸€ä¸ªå€¼ï¼Œåœ¨å®šæ—¶ä»»åŠ¡è¿è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡è®¡ç®—å½“å‰æ—¶é—´å’Œè®¾ç½®æ—¶é—´å’Œä¸Šæ¬¡äº‹ä»¶å‘ç”Ÿæ—¶é—´çš„ç»“æœï¼Œæ¥åˆ¤æ–­æ˜¯å¦ç©ºé—²ã€‚</p><p>3)å†…éƒ¨æœ‰ <code>3</code> ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåˆ†åˆ«å¯¹åº”è¯»äº‹ä»¶ï¼Œå†™äº‹ä»¶ï¼Œè¯»å†™äº‹ä»¶ã€‚é€šå¸¸ç”¨æˆ·ç›‘å¬è¯»å†™äº‹ä»¶å°±è¶³å¤Ÿäº†ã€‚</p><p>4)åŒæ—¶ï¼Œ<code>IdleStateHandler</code> å†…éƒ¨ä¹Ÿè€ƒè™‘äº†ä¸€äº›æç«¯æƒ…å†µï¼šå®¢æˆ·ç«¯æ¥æ”¶ç¼“æ…¢ï¼Œä¸€æ¬¡æ¥æ”¶æ•°æ®çš„é€Ÿåº¦è¶…è¿‡äº†è®¾ç½®çš„ç©ºé—²æ—¶é—´ã€‚<code>Netty</code> é€šè¿‡æ„é€ æ–¹æ³•ä¸­çš„ <code>observeOutput</code> å±æ€§æ¥å†³å®šæ˜¯å¦å¯¹å‡ºç«™ç¼“å†²åŒºçš„æƒ…å†µè¿›è¡Œåˆ¤æ–­ã€‚</p><p>5)å¦‚æœå‡ºç«™ç¼“æ…¢ï¼Œ<code>Netty</code> ä¸è®¤ä¸ºè¿™æ˜¯ç©ºé—²ï¼Œä¹Ÿå°±ä¸è§¦å‘ç©ºé—²äº‹ä»¶ã€‚ä½†ç¬¬ä¸€æ¬¡æ— è®ºå¦‚ä½•ä¹Ÿæ˜¯è¦è§¦å‘çš„ã€‚å› ä¸ºç¬¬ä¸€æ¬¡æ— æ³•åˆ¤æ–­æ˜¯å‡ºç«™ç¼“æ…¢è¿˜æ˜¯ç©ºé—²ã€‚å½“ç„¶ï¼Œå‡ºç«™ç¼“æ…¢çš„è¯ï¼Œå¯èƒ½é€ æˆ <code>OOM</code>ï¼Œ<code>OOM</code> æ¯”ç©ºé—²çš„é—®é¢˜æ›´å¤§ã€‚</p><p>6)æ‰€ä»¥ï¼Œå½“ä½ çš„åº”ç”¨å‡ºç°äº†å†…å­˜æº¢å‡ºï¼Œ<code>OOM</code> ä¹‹ç±»ï¼Œå¹¶ä¸”å†™ç©ºé—²æå°‘å‘ç”Ÿï¼ˆä½¿ç”¨äº† <code>observeOutput</code> ä¸º <code>true</code>ï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦æ³¨æ„æ˜¯ä¸æ˜¯æ•°æ®å‡ºç«™é€Ÿåº¦è¿‡æ…¢ã€‚</p><p>7)è¿˜æœ‰ä¸€ä¸ªæ³¨æ„çš„åœ°æ–¹ï¼šå°±æ˜¯ <code>ReadTimeoutHandler</code>ï¼Œå®ƒç»§æ‰¿è‡ª <code>IdleStateHandler</code>ï¼Œå½“è§¦å‘è¯»ç©ºé—²äº‹ä»¶çš„æ—¶å€™ï¼Œå°±è§¦å‘ <code>ctx</code>. <code>fireExceptionCaught</code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ª <code>ReadTimeoutException</code>ï¼Œç„¶åå…³é—­ <code>Socket</code>ã€‚</p><p>8)è€Œ <code>WriteTimeoutHandler</code> çš„å®ç°ä¸æ˜¯åŸºäº <code>IdleStateHandler</code> çš„ï¼Œä»–çš„åŸç†æ˜¯ï¼Œå½“è°ƒç”¨ <code>write</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä»»åŠ¡å†…å®¹æ˜¯æ ¹æ®ä¼ å…¥çš„ <code>promise</code> çš„å®Œæˆæƒ…å†µæ¥åˆ¤æ–­æ˜¯å¦è¶…å‡ºäº†å†™çš„æ—¶é—´ã€‚å½“å®šæ—¶ä»»åŠ¡æ ¹æ®æŒ‡å®šæ—¶é—´å¼€å§‹è¿è¡Œï¼Œå‘ç° <code>promise</code> çš„ <code>isDone</code> æ–¹æ³•è¿”å› <code>false</code>ï¼Œè¡¨æ˜è¿˜æ²¡æœ‰å†™å®Œï¼Œè¯´æ˜è¶…æ—¶äº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚å½“ <code>write</code> æ–¹æ³•å®Œæˆåï¼Œä¼šæ‰“æ–­å®šæ—¶ä»»åŠ¡ã€‚</p><h3 id="10-7-Netty-æ ¸å¿ƒç»„ä»¶-EventLoop-æºç å‰–æ"><a href="#10-7-Netty-æ ¸å¿ƒç»„ä»¶-EventLoop-æºç å‰–æ" class="headerlink" title="10.7 Netty æ ¸å¿ƒç»„ä»¶ EventLoop æºç å‰–æ]"></a>10.7 Netty æ ¸å¿ƒç»„ä»¶ EventLoop æºç å‰–æ]</h3><h4 id="10-7-1-æºç å‰–æç›®çš„"><a href="#10-7-1-æºç å‰–æç›®çš„" class="headerlink" title="10.7.1 æºç å‰–æç›®çš„"></a>10.7.1 æºç å‰–æç›®çš„</h4><p><code>Echo</code> ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯ï¼š<code>EventLoopGroup bossGroup = new NioEventLoopGroup(1)</code>; ä¸‹é¢åˆ†æå…¶æœ€æ ¸å¿ƒçš„ç»„ä»¶ <code>EventLoop</code>ã€‚</p><h4 id="10-7-2-æºç å‰–æ"><a href="#10-7-2-æºç å‰–æ" class="headerlink" title="10.7.2 æºç å‰–æ"></a>10.7.2 æºç å‰–æ</h4><p>æºç å‰–æ</p><p>1.<code>EventLoop</code>ä»‹ç» 1.1é¦–å…ˆçœ‹çœ‹ <code>NioEventLoop</code> çš„ç»§æ‰¿å›¾</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_17.png" alt="img"></p><p>è¯´æ˜é‡ç‚¹ï¼š 1)<code>ScheduledExecutorService</code> æ¥å£è¡¨ç¤ºæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥å£ï¼Œ<code>EventLoop</code> å¯ä»¥æ¥å—å®šæ—¶ä»»åŠ¡ã€‚</p><p>2)<code>EventLoop</code> æ¥å£ï¼š<code>Netty</code> æ¥å£æ–‡æ¡£è¯´æ˜è¯¥æ¥å£ä½œç”¨ï¼šä¸€æ—¦ <code>Channel</code> æ³¨å†Œäº†ï¼Œå°±å¤„ç†è¯¥ <code>Channel</code> å¯¹åº”çš„æ‰€æœ‰ <code>I/O</code> æ“ä½œã€‚</p><p>3)<code>SingleThreadEventExecutor</code> è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p><p>4)<code>EventLoop</code> æ˜¯ä¸€ä¸ªå•ä¾‹çš„çº¿ç¨‹æ± ï¼Œé‡Œé¢å«æœ‰ä¸€ä¸ªæ­»å¾ªç¯çš„çº¿ç¨‹ä¸æ–­çš„åšç€ <code>3</code> ä»¶äº‹æƒ…ï¼šç›‘å¬ç«¯å£ï¼Œå¤„ç†ç«¯å£äº‹ä»¶ï¼Œå¤„ç†é˜Ÿåˆ—äº‹ä»¶ã€‚æ¯ä¸ª <code>EventLoop</code> éƒ½å¯ä»¥ç»‘å®šå¤šä¸ª <code>Channel</code>ï¼Œè€Œæ¯ä¸ª <code>Channel</code> å§‹ç»ˆåªèƒ½ç”±ä¸€ä¸ª <code>EventLoop</code> æ¥å¤„ç†</p><ol><li><code>NioEventLoop</code> çš„ä½¿ç”¨ - <code>execute</code> æ–¹æ³•</li></ol><p>2.1 <code>execute</code> æºç å‰–æ</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_18.png" alt="img"></p><p>åœ¨ <code>EventLoop</code> çš„ä½¿ç”¨ï¼Œä¸€èˆ¬å°±æ˜¯ <code>eventloop.execute(task);</code> çœ‹ä¸‹ <code>execute</code> æ–¹æ³•çš„å®ç°(åœ¨ <code>SingleThreadEventExecutor</code> ç±»ä¸­)</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable task)</span> </span>&#123;    <span class="hljs-keyword">if</span>(task == <span class="hljs-keyword">null</span>) &#123;        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException(<span class="hljs-string">&quot;task&quot;</span>);    &#125;    <span class="hljs-keyword">boolean</span> inEventLoop = inEventLoop();    <span class="hljs-keyword">if</span>(inEventLoop) &#123;        addTask(task);    &#125; <span class="hljs-keyword">else</span> &#123;        startThread();        addTask(task);        <span class="hljs-keyword">if</span>(isShutdown() &amp;&amp; removeTask(task)) &#123;            reject();        &#125;    &#125;        <span class="hljs-keyword">if</span>(!addTaskWakesUp&amp;&amp;wakesUpForTask(task)) &#123;        wakeup(inEventLoop);    &#125;&#125;</code></pre></div><p>è¯´æ˜: 1)é¦–å…ˆåˆ¤æ–­è¯¥ <code>EventLoop</code> çš„çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å°è¯•å¯åŠ¨çº¿ç¨‹ï¼ˆä½†ç”±äºçº¿ç¨‹æ˜¯å•ä¸ªçš„ï¼Œå› æ­¤åªèƒ½å¯åŠ¨ä¸€æ¬¡ï¼‰ï¼Œéšåå†å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å»ã€‚</p><p>2)å¦‚æœçº¿ç¨‹å·²ç»åœæ­¢ï¼Œå¹¶ä¸”åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>3)å¦‚æœ <code>addTaskWakesUp</code> æ˜¯ <code>false</code>ï¼Œå¹¶ä¸”ä»»åŠ¡ä¸æ˜¯ <code>NonWakeupRunnable</code> ç±»å‹çš„ï¼Œå°±å°è¯•å”¤é†’ <code>selector</code>ã€‚è¿™ä¸ªæ—¶å€™ï¼Œé˜»å¡åœ¨ <code>selecor</code>çš„çº¿ç¨‹å°±ä¼šç«‹å³è¿”å›</p><p>4)å¯ä»¥ä¸‹æ–­ç‚¹æ¥è¿½è¸ª</p><p>2.2æˆ‘ä»¬ <code>debugaddTask</code> å’Œ <code>offerTask</code> æ–¹æ³•æºç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addTask</span><span class="hljs-params">(Runnable task)</span> </span>&#123;    <span class="hljs-keyword">if</span>(task == <span class="hljs-keyword">null</span>) &#123;        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException(<span class="hljs-string">&quot;task&quot;</span>);    &#125;        <span class="hljs-keyword">if</span>(!offerTask(task)) &#123;        reject(task);    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">offerTask</span><span class="hljs-params">(Runnable task)</span> </span>&#123;    <span class="hljs-keyword">if</span>(isShutdown()) &#123;        reject();    &#125;    <span class="hljs-keyword">return</span> taskQueue.offer(task);&#125;</code></pre></div><p>3.<code>NioEventLoop</code> çš„çˆ¶ç±» <code>SingleThreadEventExecutor</code> çš„ <code>startThread</code> æ–¹æ³• 3.1å½“æ‰§è¡Œ <code>execute</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ <code>EventLoop</code> æ‰€å±çº¿ç¨‹ï¼Œåˆ™å°è¯•å¯åŠ¨çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ <code>startThread</code> æ–¹æ³•ï¼Œdubug ä»£ç å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startThread</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">if</span>(state == ST_NOT_STARTED) &#123;        <span class="hljs-keyword">if</span>(STATE_UPDATER.compareAndSet(<span class="hljs-keyword">this</span>, ST_NOT_STARTED, ST_STARTED)) &#123;            <span class="hljs-keyword">try</span>&#123;                doStartThread();            &#125; <span class="hljs-keyword">catch</span>(Throwable cause) &#123;                STATE_UPDATER.set(<span class="hljs-keyword">this</span>, ST_NOT_STARTED);                PlatformDependent.throwException(cause);            &#125;        &#125;    &#125;&#125;</code></pre></div><p>è¯´æ˜:è¯¥æ–¹æ³•é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯åŠ¨è¿‡äº†ï¼Œä¿è¯ <code>EventLoop</code> åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰å¯åŠ¨è¿‡ï¼Œåˆ™å°è¯•ä½¿ç”¨ <code>Cas</code> å°† <code>state</code> çŠ¶æ€æ”¹ä¸º <code>ST_STARTED</code>ï¼Œä¹Ÿå°±æ˜¯å·²å¯åŠ¨ã€‚ç„¶åè°ƒç”¨ <code>doStartThread</code> æ–¹æ³•ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è¿›è¡Œå›æ»š</p><p>çœ‹ä¸‹ <code>doStartThread</code> æ–¹æ³•</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doStartThread</span><span class="hljs-params">()</span> </span>&#123;    executor.execute(<span class="hljs-keyword">new</span> Runnable() &#123;        <span class="hljs-meta">@Override</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;            <span class="hljs-keyword">boolean</span> success = <span class="hljs-keyword">false</span>;            updateLastExecutionTime();            <span class="hljs-keyword">try</span>&#123;                SingleThreadEventExecutor.<span class="hljs-keyword">this</span>.run();                success=<span class="hljs-keyword">true</span>;            &#125; <span class="hljs-keyword">finally</span> &#123;                <span class="hljs-keyword">for</span>( ; ; ) &#123;                    intoldState = state;                    <span class="hljs-keyword">if</span>(oldState &gt;= ST_SHUTTING_DOWN || STATE_UPDATER.compareAndSet(SingleThreadEventExecutor.<span class="hljs-keyword">this</span>, oldState, ST_SHUTTING_DOWN)) &#123;                        <span class="hljs-keyword">break</span>;                    &#125;                &#125;                <span class="hljs-keyword">try</span> &#123;                    <span class="hljs-keyword">for</span>( ; ; ) &#123;                        <span class="hljs-keyword">if</span>(confirmShutdown()) &#123;                            <span class="hljs-keyword">break</span>;                        &#125;                    &#125;                &#125; <span class="hljs-keyword">finally</span> &#123;                    <span class="hljs-keyword">try</span> &#123;                        cleanup();                    &#125; <span class="hljs-keyword">finally</span> &#123;                        STATE_UPDATER.set(SingleThreadEventExecutor.<span class="hljs-keyword">this</span>,ST_TERMINATED);                        threadLock.release();                        terminationFuture.setSuccess(<span class="hljs-keyword">null</span>);                    &#125;                &#125;            &#125;        &#125;    &#125;);&#125;</code></pre></div><p>è¯´æ˜ï¼š 1)é¦–å…ˆè°ƒç”¨ <code>executor</code> çš„ <code>execute</code> æ–¹æ³•ï¼Œè¿™ä¸ª <code>executor</code> å°±æ˜¯åœ¨åˆ›å»º <code>EventLoopGroup</code> çš„æ—¶å€™åˆ›å»ºçš„ <code>ThreadPerTaskExecutor</code> ç±»ã€‚è¯¥ <code>execute</code> æ–¹æ³•ä¼šå°† <code>Runnable</code> åŒ…è£…æˆ <code>Netty</code> çš„ <code>FastThreadLocalThread</code>ã€‚</p><p>2)ä»»åŠ¡ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­çº¿ç¨‹ä¸­æ–­çŠ¶æ€ï¼Œç„¶åè®¾ç½®æœ€åä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´ã€‚</p><p>3)æ‰§è¡Œå½“å‰ <code>NioEventLoop</code> çš„ <code>run</code> æ–¹æ³•ï¼Œæ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œæ˜¯æ•´ä¸ª <code>EventLoop</code> çš„æ ¸å¿ƒ</p><p>4)åœ¨ <code>finally</code> å—ä¸­ï¼Œä½¿ç”¨ <code>CAS</code> ä¸æ–­ä¿®æ”¹ <code>state</code> çŠ¶æ€ï¼Œæ”¹æˆ <code>ST_SHUTTING_DOWN</code>ã€‚ä¹Ÿå°±æ˜¯å½“çº¿ç¨‹ <code>Loop</code> ç»“æŸçš„æ—¶å€™ã€‚å…³é—­çº¿ç¨‹ã€‚æœ€åè¿˜è¦æ­»å¾ªç¯ç¡®è®¤æ˜¯å¦å…³é—­ï¼Œå¦åˆ™ä¸ä¼š <code>break</code>ã€‚ç„¶åï¼Œæ‰§è¡Œ <code>cleanup</code> æ“ä½œï¼Œæ›´æ–°çŠ¶æ€ä¸º</p><p>5)<code>ST_TERMINATED</code>ï¼Œå¹¶é‡Šæ”¾å½“å‰çº¿ç¨‹é”ã€‚å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸æ˜¯ç©ºï¼Œåˆ™æ‰“å°é˜Ÿåˆ—ä¸­è¿˜æœ‰å¤šå°‘ä¸ªæœªå®Œæˆçš„ä»»åŠ¡ã€‚å¹¶å›è°ƒ <code>terminationFuture</code> æ–¹æ³•ã€‚</p><p>6)å…¶å®æœ€æ ¸å¿ƒçš„å°±æ˜¯ <code>EventLoop</code> è‡ªèº«çš„ <code>run</code> æ–¹æ³•ã€‚å†ç»§ç»­æ·±å…¥ <code>run</code> æ–¹æ³•</p><p>4.<code>EventLoop</code> ä¸­çš„ <code>Loop</code> æ˜¯é  <code>run</code> å®ç°çš„ï¼Œæˆ‘ä»¬åˆ†æä¸‹ <code>run</code> æ–¹æ³•(è¯¥æ–¹æ³•åœ¨ <code>NioEventLoop</code>)</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">for</span>( ; ; ) &#123;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">switch</span>(selectStrategy.calculateStrategy(selectNowSupplier,hasTasks())) &#123;                <span class="hljs-keyword">case</span> SelectStrategy.CONTINUE:                    <span class="hljs-keyword">continue</span>;                <span class="hljs-keyword">case</span> SelectStrategy.SELECT:                    select(wakenUp.getAndSet(<span class="hljs-keyword">false</span>));                    <span class="hljs-keyword">if</span>(wakenUp.get()) &#123;                        selector.wakeup();                    &#125;                    <span class="hljs-keyword">default</span>:            &#125;                        cancelledKeys = <span class="hljs-number">0</span>;            needsToSelectAgain = <span class="hljs-keyword">false</span>;            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ioRatio = <span class="hljs-keyword">this</span>.ioRatio;            <span class="hljs-keyword">if</span>(ioRatio == <span class="hljs-number">100</span>) &#123;                <span class="hljs-keyword">try</span> &#123;                    processSelectedKeys();                &#125; <span class="hljs-keyword">finally</span> &#123;                    <span class="hljs-comment">//Ensure we always run tasks.</span>                    runAllTasks();                &#125;            &#125; <span class="hljs-keyword">else</span> &#123;                <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> ioStartTime = System.nanoTime();                <span class="hljs-keyword">try</span> &#123;                    processSelectedKeys();                &#125; <span class="hljs-keyword">finally</span> &#123;                    <span class="hljs-comment">//Ensure we always runtasks.</span>                    <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> ioTime = System.nanoTime() - ioStartTime;                    runAllTasks(ioTime * (<span class="hljs-number">100</span> - ioRatio) / ioRatio);                &#125;            &#125;        &#125; <span class="hljs-keyword">catch</span>(Throwable t) &#123;            handleLoopException(t);        &#125;        <span class="hljs-comment">//Always handle shutdown even if the loop processing threw an exception.</span>        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">if</span>(isShuttingDown()) &#123;                closeAll();                <span class="hljs-keyword">if</span>(confirmShutdown()) &#123;                    <span class="hljs-keyword">return</span>;                &#125;            &#125;        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;            handleLoopException(t);        &#125;    &#125;&#125;</code></pre></div><p>è¯´æ˜: 1)ä»ä¸Šé¢çš„æ­¥éª¤å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ª <code>run</code> æ–¹æ³•åšäº† <code>3</code> ä»¶äº‹æƒ…ï¼š <code>select</code> è·å–æ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚ <code>processSelectedKeys</code> å¤„ç†äº‹ä»¶ã€‚ <code>runAllTasks</code> æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p><p>2)ä¸Šé¢çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å°±è¿½ä¸€ä¸‹ <code>select</code> æ–¹æ³•(ä½“ç°éé˜»å¡)æ ¸å¿ƒ <code>select</code> æ–¹æ³•è§£æ</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">select</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> oldWakenUp)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;    Selector selector = <span class="hljs-keyword">this</span>.selector;    <span class="hljs-keyword">try</span> &#123;        <span class="hljs-keyword">int</span> selectCnt = <span class="hljs-number">0</span>;        <span class="hljs-keyword">long</span> currentTimeNanos = System.nanoTime();        <span class="hljs-keyword">long</span> selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos);        <span class="hljs-keyword">for</span>( ; ; ) &#123;            <span class="hljs-keyword">long</span> timeoutMillis = (selectDeadLineNanos - currentTimeNanos + <span class="hljs-number">500000L</span>)/<span class="hljs-number">1000000L</span>;            <span class="hljs-keyword">if</span>(timeoutMillis &lt;= <span class="hljs-number">0</span>) &#123;                <span class="hljs-keyword">if</span>(selectCnt == <span class="hljs-number">0</span>) &#123;                    selector.selectNow();                    selectCnt=<span class="hljs-number">1</span>;                &#125;                <span class="hljs-keyword">break</span>;            &#125;            <span class="hljs-comment">//If a task was submitted when wakenUp value was true, the task didn&#x27;t get a chance to call</span>            <span class="hljs-comment">//Selector#wakeup. So we need to check task queue again before executing select operation.</span>            <span class="hljs-comment">//If wedon&#x27;t, the task might be pended until select operation was timedout.</span>            <span class="hljs-comment">//It might be pended until idle timeout if IdleStateHandler existed inpipeline.</span>            <span class="hljs-keyword">if</span>(hasTasks() &amp;&amp; wakenUp.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) &#123;                selector.selectNow();                selectCnt = <span class="hljs-number">1</span>;                <span class="hljs-keyword">break</span>;            &#125;                        <span class="hljs-keyword">int</span> selectedKeys = selector.select(timeoutMillis);<span class="hljs-comment">//å¦åˆ™é˜»å¡ç»™å®šæ—¶é—´ï¼Œé»˜è®¤ä¸€ç§’</span>            selectCnt++;            <span class="hljs-comment">//å¦‚æœ 1 ç§’åè¿”å›ï¼Œæœ‰è¿”å›å€¼||selectè¢«ç”¨æˆ·å”¤é†’||ä»»åŠ¡é˜Ÿåˆ—æœ‰ä»»åŠ¡||æœ‰å®šæ—¶ä»»åŠ¡å³å°†è¢«æ‰§è¡Œï¼›åˆ™è·³å‡ºå¾ªç¯</span>            <span class="hljs-keyword">if</span>(selectedKeys != <span class="hljs-number">0</span> || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) &#123;                <span class="hljs-comment">//-Selected something,</span>                <span class="hljs-comment">//-waken up by user,or</span>                <span class="hljs-comment">//-the task queue has apending task.</span>                <span class="hljs-comment">//-a scheduled task is ready for processing</span>                <span class="hljs-keyword">break</span>;            &#125;                        <span class="hljs-keyword">if</span>(Thread.interrupted()) &#123;                <span class="hljs-comment">//Thread was interrupted so reset selected keys and break so we not run into a busy loop.</span>                <span class="hljs-comment">//As this is most likely a bug in the handler of the user or it&#x27;s client library we will</span>                <span class="hljs-comment">//also log it.</span>                <span class="hljs-comment">//</span>                <span class="hljs-comment">//See https://github.com/netty/netty/issues/2426</span>                <span class="hljs-keyword">if</span>(logger.isDebugEnabled()) &#123;                    logger.debug(<span class="hljs-string">&quot;Selector.select() returned prematurely because &quot;</span> + <span class="hljs-string">&quot; Thread.currentThread().interrupt() was called. Use &quot;</span> + <span class="hljs-string">&quot; NioEventLoop.shutdownGracefully() to shutdowntheNioEventLoop.&quot;</span>);                &#125;                selectCnt = <span class="hljs-number">1</span>;                <span class="hljs-keyword">break</span>;            &#125;            <span class="hljs-keyword">long</span> time = System.nanoTime();            <span class="hljs-keyword">if</span>(time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) &#123;                <span class="hljs-comment">//timeoutMillis elapsed without any thing selected.</span>                selectCnt =<span class="hljs-number">1</span>;            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(SELECTOR_AUTO_REBUILD_THRESHOLD &gt; <span class="hljs-number">0</span> &amp;&amp; selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) &#123;                <span class="hljs-comment">//The selector returned prematurely many times in a row.</span>                <span class="hljs-comment">//Rebuild the selector to work around the problem.</span>                logger.warn(<span class="hljs-string">&quot;Selector.select() returned prematurely &#123;&#125; times in a row; rebuilding Selector &#123;&#125;.&quot;</span>, selectCnt, selector);                rebuildSelector();                selector = <span class="hljs-keyword">this</span>.selector;                <span class="hljs-comment">//Select again to populate selectedKeys.</span>                selector.selectNow();                selectCnt = <span class="hljs-number">1</span>;                <span class="hljs-keyword">break</span>;            &#125;                        currentTimeNanos = time;        &#125;                <span class="hljs-keyword">if</span>(selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) &#123;            <span class="hljs-keyword">if</span>(logger.isDebugEnabled()) &#123;                logger.debug(<span class="hljs-string">&quot;Selector.select()returned prematurely &#123;&#125; times in a row for Selector&#123;&#125;.&quot;</span>, selectCnt - <span class="hljs-number">1</span>, selector);            &#125;        &#125;    &#125; <span class="hljs-keyword">catch</span> (CancelledKeyException e) &#123;        <span class="hljs-keyword">if</span>(logger.isDebugEnabled()) &#123;            logger.debug(CancelledKeyException.class.getSimpleName() + <span class="hljs-string">&quot;raisedbyaSelector &#123;&#125; - JDKbug?&quot;</span>, selector, e);        &#125;        <span class="hljs-comment">//Harmless exception - log anyway</span>    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼šè°ƒç”¨ <code>selector</code> çš„ <code>select</code> æ–¹æ³•ï¼Œé»˜è®¤é˜»å¡ä¸€ç§’é’Ÿï¼Œå¦‚æœæœ‰å®šæ—¶ä»»åŠ¡ï¼Œåˆ™åœ¨å®šæ—¶ä»»åŠ¡å‰©ä½™æ—¶é—´çš„åŸºç¡€ä¸Šåœ¨åŠ ä¸Š <code>0.5</code> ç§’è¿›è¡Œé˜»å¡ã€‚å½“æ‰§è¡Œ <code>execute</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ ä»»åŠ¡çš„æ—¶å€™ï¼Œå”¤é†’ <code>selector</code>ï¼Œé˜²æ­¢ <code>selector</code> é˜»å¡æ—¶é—´è¿‡é•¿</p><p>5.<code>EventLoop</code> ä½œä¸º <code>Netty</code> çš„æ ¸å¿ƒçš„è¿è¡Œæœºåˆ¶å°ç»“</p><p>1)æ¯æ¬¡æ‰§è¡Œ <code>execute</code> æ–¹æ³•éƒ½æ˜¯å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ã€‚å½“ç¬¬ä¸€æ¬¡æ·»åŠ æ—¶å°±å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡Œ <code>run</code> æ–¹æ³•ï¼Œè€Œ <code>run</code> æ–¹æ³•æ˜¯æ•´ä¸ª <code>EventLoop</code> çš„æ ¸å¿ƒï¼Œå°±åƒ <code>EventLoop</code> çš„åå­—ä¸€æ ·ï¼Œ<code>LoopLoop</code>ï¼Œä¸åœçš„ <code>Loop</code>ï¼Œ<code>Loop</code> åšä»€ä¹ˆå‘¢ï¼Ÿåš <code>3</code> ä»¶äº‹æƒ…ã€‚</p><p>è°ƒç”¨ <code>selector</code> çš„ <code>select</code> æ–¹æ³•ï¼Œé»˜è®¤é˜»å¡ä¸€ç§’é’Ÿï¼Œå¦‚æœæœ‰å®šæ—¶ä»»åŠ¡ï¼Œåˆ™åœ¨å®šæ—¶ä»»åŠ¡å‰©ä½™æ—¶é—´çš„åŸºç¡€ä¸Šåœ¨åŠ ä¸Š <code>0.5</code> ç§’è¿›è¡Œé˜»å¡ã€‚å½“æ‰§è¡Œ <code>execute</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ ä»»åŠ¡çš„æ—¶å€™ï¼Œå”¤é†’ <code>selecor</code>ï¼Œé˜²æ­¢ <code>selector</code> é˜»å¡æ—¶é—´è¿‡é•¿ã€‚</p><p>å½“ <code>selector</code> è¿”å›çš„æ—¶å€™ï¼Œå›è°ƒç”¨ <code>processSelectedKeys</code> æ–¹æ³•å¯¹ <code>selectKey</code> è¿›è¡Œå¤„ç†ã€‚</p><p>å½“ <code>processSelectedKeys</code> æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œåˆ™æŒ‰ç…§ <code>ioRatio</code> çš„æ¯”ä¾‹æ‰§è¡Œ <code>runAllTasks</code> æ–¹æ³•ï¼Œé»˜è®¤æ˜¯ <code>IO</code> ä»»åŠ¡æ—¶é—´å’Œé <code>IO</code> ä»»åŠ¡æ—¶é—´æ˜¯ç›¸åŒçš„ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®ä½ çš„åº”ç”¨ç‰¹ç‚¹è¿›è¡Œè°ƒä¼˜ã€‚æ¯”å¦‚é <code>IO</code> ä»»åŠ¡æ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆä½ å°±å°†</p><p><code>ioRatio</code> è°ƒå°ä¸€ç‚¹ï¼Œè¿™æ ·é <code>IO</code> ä»»åŠ¡å°±èƒ½æ‰§è¡Œçš„é•¿ä¸€ç‚¹ã€‚é˜²æ­¢é˜Ÿåˆ—ç§¯æ”’è¿‡å¤šçš„ä»»åŠ¡ã€‚</p><h3 id="10-8-handler-ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ-Context-ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ"><a href="#10-8-handler-ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ-Context-ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ" class="headerlink" title="10.8 handler ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ Context ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ"></a>10.8 handler ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ Context ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ</h3><h4 id="10-8-1-æºç å‰–æç›®çš„"><a href="#10-8-1-æºç å‰–æç›®çš„" class="headerlink" title="10.8.1 æºç å‰–æç›®çš„"></a>10.8.1 æºç å‰–æç›®çš„</h4><ol><li>åœ¨ <code>Netty</code> ä¸­åšè€—æ—¶çš„ï¼Œä¸å¯é¢„æ–™çš„æ“ä½œï¼Œæ¯”å¦‚æ•°æ®åº“ï¼Œç½‘ç»œè¯·æ±‚ï¼Œä¼šä¸¥é‡å½±å“ <code>Netty</code> å¯¹ <code>Socket</code> çš„å¤„ç†é€Ÿåº¦ã€‚</li><li>è€Œè§£å†³æ–¹æ³•å°±æ˜¯å°†è€—æ—¶ä»»åŠ¡æ·»åŠ åˆ°å¼‚æ­¥çº¿ç¨‹æ± ä¸­ã€‚ä½†å°±æ·»åŠ çº¿ç¨‹æ± è¿™æ­¥æ“ä½œæ¥è®²ï¼Œå¯ä»¥æœ‰ <code>2</code> ç§æ–¹å¼ï¼Œè€Œä¸”è¿™ <code>2</code> ç§æ–¹å¼å®ç°çš„åŒºåˆ«ä¹Ÿè›®å¤§çš„ã€‚</li><li>å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬ä¸€ç§æ–¹å¼ â€“ <code>handler</code> ä¸­åŠ å…¥çº¿ç¨‹æ± </li><li>å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬äºŒç§æ–¹å¼ â€“ <code>Context</code> ä¸­æ·»åŠ çº¿ç¨‹æ± </li><li>æˆ‘ä»¬å°±æ¥åˆ†æä¸‹ä¸¤ç§æ–¹å¼</li></ol><h4 id="10-8-2-æºç å‰–æ"><a href="#10-8-2-æºç å‰–æ" class="headerlink" title="10.8.2 æºç å‰–æ"></a>10.8.2 æºç å‰–æ</h4><p>è¯´æ˜ æ¼”ç¤ºä¸¤ç§æ–¹å¼çš„å®ç°ï¼Œä»¥åŠä»æºç æ¥è¿½è¸ªä¸¤ç§æ–¹å¼æ‰§è¡Œæµç¨‹</p><ol><li>å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬ä¸€ç§æ–¹å¼ â€“ handlerç§åŠ å…¥çº¿ç¨‹æ± </li><li>1å¯¹å‰é¢çš„ <code>Netty</code> <code>demo</code>æºç è¿›è¡Œä¿®æ”¹ï¼Œåœ¨ <code>EchoServerHandler</code> çš„ <code>channelRead</code> æ–¹æ³•è¿›è¡Œå¼‚æ­¥</li></ol><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Sharable</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> EventExecutorGroup group = <span class="hljs-keyword">new</span> DefaultEventExecutorGroup(<span class="hljs-number">16</span>);    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException, InterruptedException </span>&#123;        <span class="hljs-keyword">final</span> Object msgCop = msg;        <span class="hljs-keyword">final</span> ChannelHandlerContext cxtCop = ctx;        group.submit(<span class="hljs-keyword">new</span> Callable&lt;Object&gt;() &#123;            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                ByteBuf buf = (ByteBuf)msgCop;                <span class="hljs-keyword">byte</span>[] req = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[buf.readableBytes()];                buf.readBytes(req);                String body = <span class="hljs-keyword">new</span> String(req, <span class="hljs-string">&quot;UTF-8&quot;</span>);                Thread.sleep(<span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);                System.err.println(body + <span class="hljs-string">&quot; &quot;</span> + Thread.currentThread().getName());                String reqString = <span class="hljs-string">&quot;Helloiamserver~~~&quot;</span>;                ByteBuf resp = Unpooled.copiedBuffer(reqString.getBytes());                cxtCop.writeAndFlush(resp);                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;            &#125;        &#125;);        System.out.println(<span class="hljs-string">&quot;goon..&quot;</span>);    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> </span>&#123;        ctx.flush();    &#125;        <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;        <span class="hljs-comment">// Close the connection when an exception is raised.</span>        cause.printStackTrace();        ctx.close();    &#125;&#125;</code></pre></div><p>è¯´æ˜ï¼š 1)åœ¨ <code>channelRead</code> æ–¹æ³•ï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸ªè€—æ—¶ <code>10</code> ç§’çš„æ“ä½œï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä»»åŠ¡æäº¤åˆ°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ä¸šåŠ¡çº¿ç¨‹æ± ä¸­ï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šé˜»å¡ <code>Netty</code> çš„ <code>IO</code> çº¿ç¨‹ã€‚</p><p>11.2è¿™æ ·å¤„ç†ä¹‹åï¼Œæ•´ä¸ªç¨‹åºçš„é€»è¾‘å¦‚å›¾</p><p><img src="https://dongzl.github.io/netty-handbook/_media/chapter10/chapter10_19.png" alt="img"></p><p>è¯´æ˜ï¼š</p><p>1)è§£é‡Šä¸€ä¸‹ä¸Šå›¾ï¼Œå½“ <code>IO</code> çº¿ç¨‹è½®è¯¢åˆ°ä¸€ä¸ª <code>socket</code> äº‹ä»¶ï¼Œç„¶åï¼Œ<code>IO</code> çº¿ç¨‹å¼€å§‹å¤„ç†ï¼Œå½“èµ°åˆ°è€—æ—¶ <code>handler</code> çš„æ—¶å€™ï¼Œå°†è€—æ—¶ä»»åŠ¡äº¤ç»™ä¸šåŠ¡çº¿ç¨‹æ± ã€‚</p><p>2)å½“è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œ <code>pipeline write</code> æ–¹æ³•çš„æ—¶å€™ï¼Œ(ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯ <code>context</code> çš„ <code>write</code> æ–¹æ³•ï¼Œä¸Šå›¾ç”»çš„æ˜¯æ‰§è¡Œ <code>pipeline</code> æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªæ„æ€)ä¼šå°†ä»»åŠ¡è¿™ä¸ªä»»åŠ¡äº¤ç»™ <code>IO</code> çº¿ç¨‹</p><p>11.3 <code>write</code> æ–¹æ³•çš„æºç (åœ¨ <code>AbstractChannelHandlerContext</code> ç±»)</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(Object msg, <span class="hljs-keyword">boolean</span> flush, ChannelPromise promise)</span> </span>&#123;    AbstractChannelHandlerContext next = findContextOutbound();    <span class="hljs-keyword">final</span> Object m = pipeline.touch(msg, next);    EventExecutor executor = next.executor();    <span class="hljs-keyword">if</span>(executor.inEventLoop()) &#123;        <span class="hljs-keyword">if</span>(flush) &#123;            next.invokeWriteAndFlush(m, promise);        &#125; <span class="hljs-keyword">else</span> &#123;            next.invokeWrite(m, promise);        &#125;    &#125; <span class="hljs-keyword">else</span> &#123;        AbstractWriteTask task;        <span class="hljs-keyword">if</span>(flush) &#123;            task = WriteAndFlushTask.newInstance(next, m, promise);        &#125; <span class="hljs-keyword">else</span> &#123;            task = WriteTask.newInstance(next, m, promise);        &#125;        safeExecute(executor, task, promise, m);    &#125;&#125;</code></pre></div><p>è¯´æ˜:</p><p>1)å½“åˆ¤å®šä¸‹ä¸ª <code>outbound</code> çš„ <code>executor</code> çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šå°†å½“å‰çš„å·¥ä½œå°è£…æˆ <code>task</code>ï¼Œç„¶åæ”¾å…¥ <code>mpsc</code> é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… <code>IO</code> ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p><p>2)è¿™é‡Œå¯ä»¥ Debug æ¥éªŒè¯(æé†’ï¼šDebug æ—¶ï¼ŒæœåŠ¡å™¨ç«¯ Debug, å®¢æˆ·ç«¯ <code>Run</code> çš„æ–¹å¼)ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨äº† <code>group.submit(new Callable&lt;Object&gt; ()&#123;&#125;</code> åœ¨ <code>handler</code> ä¸­åŠ å…¥çº¿ç¨‹æ± ï¼Œå°±ä¼šè¿›å…¥åˆ° <code>safeExecute(executor, task, promise, m);</code> å¦‚æœå»æ‰è¿™æ®µä»£ç ï¼Œè€Œä½¿ç”¨æ™®é€šæ–¹å¼æ¥æ‰§è¡Œè€—æ—¶çš„ä¸šåŠ¡ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¿›å…¥åˆ° <code>safeExecute(executor, task, promise, m);</code>ï¼ˆè¯´æ˜ï¼šæ™®é€šæ–¹å¼æ‰§è¡Œè€—æ—¶ä»£ç ï¼Œçœ‹æˆ‘å‡†å¤‡å¥½çš„æ¡ˆä¾‹å³å¯ï¼‰</p><p>12.å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬äºŒç§æ–¹å¼ -<code>Context</code> ä¸­æ·»åŠ çº¿ç¨‹æ±  1.1åœ¨æ·»åŠ  <code>pipeline</code> ä¸­çš„ <code>handler</code> æ—¶å€™ï¼Œæ·»åŠ ä¸€ä¸ªçº¿ç¨‹æ± </p><p>//å±æ€§</p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> EventExecutorGroup group = <span class="hljs-keyword">new</span> DefaultEventExecutorGroup(<span class="hljs-number">16</span>);ServerBootstrap b = <span class="hljs-keyword">new</span> ServerBootstrap();                b.group(bossGroup, workerGroup)                 .channel(NioServerSocketChannel.class)                 .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">100</span>)                 .handler(newLoggingHandler(LogLevel.INFO))                 .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                     <span class="hljs-meta">@Override</span>                     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                         ChannelPipeline p = ch.pipeline();                         <span class="hljs-keyword">if</span>(sslCtx != <span class="hljs-keyword">null</span>) &#123;                             p.addLast(sslCtx.newHandler(ch.alloc()));                         &#125;                         <span class="hljs-comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>                         <span class="hljs-comment">//p.addLast(new EchoServerHandler());</span>                         p.addLast(group, <span class="hljs-keyword">new</span> EchoServerHandler());                    &#125;                &#125;);</code></pre></div><p>è¯´æ˜ï¼š</p><p>1)<code>handler</code> ä¸­çš„ä»£ç å°±ä½¿ç”¨æ™®é€šçš„æ–¹å¼æ¥å¤„ç†è€—æ—¶ä¸šåŠ¡ã€‚</p><p>2)å½“æˆ‘ä»¬åœ¨è°ƒç”¨ <code>addLast</code> æ–¹æ³•æ·»åŠ çº¿ç¨‹æ± åï¼Œ<code>handler</code> å°†ä¼˜å…ˆä½¿ç”¨è¿™ä¸ªçº¿ç¨‹æ± ï¼Œå¦‚æœä¸æ·»åŠ ï¼Œå°†ä½¿ç”¨ <code>IO</code> çº¿ç¨‹</p><p>3)å½“èµ°åˆ° <code>AbstractChannelHandlerContext</code> çš„ <code>invokeChannelRead</code> æ–¹æ³•çš„æ—¶å€™ï¼Œ<code>executor.inEventLoop()</code> æ˜¯ä¸ä¼šé€šè¿‡çš„ï¼Œå› ä¸ºå½“å‰çº¿ç¨‹æ˜¯ <code>IO</code> çº¿ç¨‹ <code>Context</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>Handler</code>ï¼‰çš„ <code>executor</code> æ˜¯ä¸šåŠ¡çº¿ç¨‹ï¼Œæ‰€ä»¥ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œdebug ä¸‹æºç </p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeChannelRead</span><span class="hljs-params">(<span class="hljs-keyword">final</span> AbstractChannelHandlerContext next, Object msg)</span> </span>&#123;    <span class="hljs-keyword">final</span> Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, <span class="hljs-string">&quot;msg&quot;</span>), next);    EventExecutor executor = next.executor();    <span class="hljs-keyword">if</span>(executor.inEventLoop()) &#123;        next.invokeChannelRead(m);    &#125; <span class="hljs-keyword">else</span> &#123;        executor.execute(<span class="hljs-keyword">new</span> Runnable() &#123;<span class="hljs-comment">//æ‰§è¡Œrun</span>            <span class="hljs-meta">@Override</span>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;                next.invokeChannelRead(m);            &#125;        &#125;);    &#125;&#125;</code></pre></div><p>4)éªŒè¯æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå»æ‰ <code>p.addLast(group,newEchoServerHandler());</code> æ”¹æˆ <code>p.addLastnewEchoServerHandler());</code> ä½ ä¼šå‘ç°ä»£ç ä¸ä¼šè¿›è¡Œå¼‚æ­¥æ‰§è¡Œã€‚</p><p>5)åé¢çš„æ•´ä¸ªæµç¨‹å°±å˜æˆå’Œç¬¬ä¸€ä¸ªæ–¹å¼ä¸€æ ·äº†</p><p>13.ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ</p><p>1)ç¬¬ä¸€ç§æ–¹å¼åœ¨ <code>handler</code> ä¸­æ·»åŠ å¼‚æ­¥ï¼Œå¯èƒ½æ›´åŠ çš„è‡ªç”±ï¼Œæ¯”å¦‚å¦‚æœéœ€è¦è®¿é—®æ•°æ®åº“ï¼Œé‚£æˆ‘å°±å¼‚æ­¥ï¼Œå¦‚æœä¸éœ€è¦ï¼Œå°±ä¸å¼‚æ­¥ï¼Œå¼‚æ­¥ä¼šæ‹–é•¿æ¥å£å“åº”æ—¶é—´ã€‚å› ä¸ºéœ€è¦å°†ä»»åŠ¡æ”¾è¿› <code>mpscTask</code> ä¸­ã€‚å¦‚æœ <code>IO</code> æ—¶é—´å¾ˆçŸ­ï¼Œ<code>task</code> å¾ˆå¤šï¼Œå¯èƒ½ä¸€ä¸ªå¾ªç¯ä¸‹æ¥ï¼Œéƒ½æ²¡æ—¶é—´æ‰§è¡Œæ•´ä¸ª <code>task</code>ï¼Œå¯¼è‡´å“åº”æ—¶é—´è¾¾ä¸åˆ°æŒ‡æ ‡ã€‚</p><p>2)ç¬¬äºŒç§æ–¹å¼æ˜¯ <code>Netty</code> æ ‡å‡†æ–¹å¼(å³åŠ å…¥åˆ°é˜Ÿåˆ—)ï¼Œä½†æ˜¯ï¼Œè¿™ä¹ˆåšä¼šå°†æ•´ä¸ª <code>handler</code> éƒ½äº¤ç»™ä¸šåŠ¡çº¿ç¨‹æ± ã€‚ä¸è®ºè€—æ—¶ä¸è€—æ—¶ï¼Œéƒ½åŠ å…¥åˆ°é˜Ÿåˆ—é‡Œï¼Œä¸å¤Ÿçµæ´»ã€‚</p><p>3)å„æœ‰ä¼˜åŠ£ï¼Œä»çµæ´»æ€§è€ƒè™‘ï¼Œç¬¬ä¸€ç§è¾ƒå¥½ã€‚</p><h2 id="11-ç”¨-Netty-è‡ªå·±å®ç°-Dubbo-RPC"><a href="#11-ç”¨-Netty-è‡ªå·±å®ç°-Dubbo-RPC" class="headerlink" title="11 ç”¨ Netty è‡ªå·±å®ç° Dubbo RPC"></a>11 ç”¨ Netty è‡ªå·±å®ç° Dubbo RPC</h2><h3 id="11-1-RPC-åŸºæœ¬ä»‹ç»"><a href="#11-1-RPC-åŸºæœ¬ä»‹ç»" class="headerlink" title="11.1 RPC åŸºæœ¬ä»‹ç»"></a>11.1 RPC åŸºæœ¬ä»‹ç»</h3><ol><li><code>RPCï¼ˆRemote Procedure Callï¼‰</code>â€”è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªè®¡ç®—æœºé€šä¿¡åè®®ã€‚è¯¥åè®®å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€å°è®¡ç®—æœºçš„å­ç¨‹åºï¼Œè€Œç¨‹åºå‘˜æ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹</li><li>ä¸¤ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºéƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒä»¬ä¹‹é—´çš„è°ƒç”¨éƒ½åƒæ˜¯æœ¬åœ°æ–¹æ³•è°ƒç”¨ä¸€æ ·(å¦‚å›¾)</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter11_01.png" alt="img"></p><ol><li>å¸¸è§çš„ <code>RPC</code> æ¡†æ¶æœ‰ï¼šæ¯”è¾ƒçŸ¥åçš„å¦‚é˜¿é‡Œçš„ <code>Dubbo</code>ã€<code>Google</code> çš„ <code>gRPC</code>ã€<code>Go</code> è¯­è¨€çš„ <code>rpcx</code>ã€<code>Apache</code> çš„ <code>thrift</code>ï¼Œ<code>Spring</code> æ——ä¸‹çš„ <code>SpringCloud</code>ã€‚</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter11_02.png" alt="img"></p><h3 id="11-2-RPC-è°ƒç”¨æµç¨‹å›¾"><a href="#11-2-RPC-è°ƒç”¨æµç¨‹å›¾" class="headerlink" title="11.2 RPC è°ƒç”¨æµç¨‹å›¾"></a>11.2 RPC è°ƒç”¨æµç¨‹å›¾<img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter11_03.png" alt="img"></h3><h3 id="11-3-PRC-è°ƒç”¨æµç¨‹è¯´æ˜"><a href="#11-3-PRC-è°ƒç”¨æµç¨‹è¯´æ˜" class="headerlink" title="11.3 PRC è°ƒç”¨æµç¨‹è¯´æ˜"></a>11.3 PRC è°ƒç”¨æµç¨‹è¯´æ˜</h3><ol><li>æœåŠ¡æ¶ˆè´¹æ–¹ï¼ˆ<code>client</code>ï¼‰ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼è°ƒç”¨æœåŠ¡</li><li><code>client stub</code> æ¥æ”¶åˆ°è°ƒç”¨åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰å°è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“</li><li><code>client stub</code> å°†æ¶ˆæ¯è¿›è¡Œç¼–ç å¹¶å‘é€åˆ°æœåŠ¡ç«¯</li><li><code>server stub</code> æ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç </li><li><code>server stub</code> æ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡</li><li>æœ¬åœ°æœåŠ¡æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›ç»™ <code>server stub</code></li><li><code>server stub</code> å°†è¿”å›å¯¼å…¥ç»“æœè¿›è¡Œç¼–ç å¹¶å‘é€è‡³æ¶ˆè´¹æ–¹</li><li><code>client stub</code> æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶è¿›è¡Œè§£ç </li><li>æœåŠ¡æ¶ˆè´¹æ–¹ï¼ˆ<code>client</code>ï¼‰å¾—åˆ°ç»“æœ</li></ol><p>å°ç»“ï¼š<code>RPC</code> çš„ç›®æ ‡å°±æ˜¯å°† <code>2 - 8</code> è¿™äº›æ­¥éª¤éƒ½å°è£…èµ·æ¥ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒè¿™äº›ç»†èŠ‚ï¼Œå¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·å³å¯å®Œæˆè¿œç¨‹æœåŠ¡è°ƒç”¨</p><h3 id="11-4-è‡ªå·±å®ç°-Dubbo-RPCï¼ˆåŸºäº-Nettyï¼‰"><a href="#11-4-è‡ªå·±å®ç°-Dubbo-RPCï¼ˆåŸºäº-Nettyï¼‰" class="headerlink" title="11.4 è‡ªå·±å®ç° Dubbo RPCï¼ˆåŸºäº Nettyï¼‰"></a>11.4 è‡ªå·±å®ç° Dubbo RPCï¼ˆåŸºäº Nettyï¼‰</h3><h4 id="11-4-1-éœ€æ±‚è¯´æ˜"><a href="#11-4-1-éœ€æ±‚è¯´æ˜" class="headerlink" title="11.4.1 éœ€æ±‚è¯´æ˜"></a>11.4.1 éœ€æ±‚è¯´æ˜</h4><ol><li><code>Dubbo</code> åº•å±‚ä½¿ç”¨äº† <code>Netty</code> ä½œä¸ºç½‘ç»œé€šè®¯æ¡†æ¶ï¼Œè¦æ±‚ç”¨ <code>Netty</code> å®ç°ä¸€ä¸ªç®€å•çš„ <code>RPC</code> æ¡†æ¶</li><li>æ¨¡ä»¿ <code>Dubbo</code>ï¼Œæ¶ˆè´¹è€…å’Œæä¾›è€…çº¦å®šæ¥å£å’Œåè®®ï¼Œæ¶ˆè´¹è€…è¿œç¨‹è°ƒç”¨æä¾›è€…çš„æœåŠ¡ï¼Œæä¾›è€…è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¶ˆè´¹è€…æ‰“å°æä¾›è€…è¿”å›çš„æ•°æ®ã€‚åº•å±‚ç½‘ç»œé€šä¿¡ä½¿ç”¨ <code>Netty 4.1.20</code></li></ol><h4 id="11-4-2-è®¾è®¡è¯´æ˜"><a href="#11-4-2-è®¾è®¡è¯´æ˜" class="headerlink" title="11.4.2 è®¾è®¡è¯´æ˜"></a>11.4.2 è®¾è®¡è¯´æ˜</h4><ol><li>åˆ›å»ºä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰æŠ½è±¡æ–¹æ³•ã€‚ç”¨äºæ¶ˆè´¹è€…å’Œæä¾›è€…ä¹‹é—´çš„çº¦å®šã€‚</li><li>åˆ›å»ºä¸€ä¸ªæä¾›è€…ï¼Œè¯¥ç±»éœ€è¦ç›‘å¬æ¶ˆè´¹è€…çš„è¯·æ±‚ï¼Œå¹¶æŒ‰ç…§çº¦å®šè¿”å›æ•°æ®ã€‚</li><li>åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œè¯¥ç±»éœ€è¦é€æ˜çš„è°ƒç”¨è‡ªå·±ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œå†…éƒ¨éœ€è¦ä½¿ç”¨ <code>Netty</code> è¯·æ±‚æä¾›è€…è¿”å›æ•°æ®</li><li>å¼€å‘çš„åˆ†æå›¾</li></ol><p><img src="/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/chapter11_04.png" alt="img"></p><h4 id="11-4-3-ä»£ç å®ç°"><a href="#11-4-3-ä»£ç å®ç°" class="headerlink" title="11.4.3 ä»£ç å®ç°"></a>11.4.3 ä»£ç å®ç°</h4><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.publicinterface;<span class="hljs-comment">//è¿™ä¸ªæ˜¯æ¥å£ï¼Œæ˜¯æœåŠ¡æä¾›æ–¹å’Œ æœåŠ¡æ¶ˆè´¹æ–¹éƒ½éœ€è¦</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HelloService</span> </span>&#123;    <span class="hljs-function">String <span class="hljs-title">hello</span><span class="hljs-params">(String mes)</span></span>;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.provider;<span class="hljs-keyword">import</span> com.atguigu.netty.dubborpc.publicinterface.HelloService;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HelloService</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;    <span class="hljs-comment">//å½“æœ‰æ¶ˆè´¹æ–¹è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œ å°±è¿”å›ä¸€ä¸ªç»“æœ</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(String mes)</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot;æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯=&quot;</span> + mes);        <span class="hljs-comment">//æ ¹æ®mes è¿”å›ä¸åŒçš„ç»“æœ</span>        <span class="hljs-keyword">if</span> (mes != <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä½ å¥½å®¢æˆ·ç«¯, æˆ‘å·²ç»æ”¶åˆ°ä½ çš„æ¶ˆæ¯ [&quot;</span> + mes + <span class="hljs-string">&quot;] ç¬¬&quot;</span> + (++count) + <span class="hljs-string">&quot; æ¬¡&quot;</span>;        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä½ å¥½å®¢æˆ·ç«¯, æˆ‘å·²ç»æ”¶åˆ°ä½ çš„æ¶ˆæ¯ &quot;</span>;        &#125;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.provider;<span class="hljs-keyword">import</span> com.atguigu.netty.dubborpc.netty.NettyServer;<span class="hljs-comment">//ServerBootstrap ä¼šå¯åŠ¨ä¸€ä¸ªæœåŠ¡æä¾›è€…ï¼Œå°±æ˜¯ NettyServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerBootstrap</span> </span>&#123;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-comment">//ä»£ç ä»£å¡«..</span>        NettyServer.startServer(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">7000</span>);    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.netty;<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServer</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startServer</span><span class="hljs-params">(String hostName, <span class="hljs-keyword">int</span> port)</span> </span>&#123;        startServer0(hostName, port);    &#125;    <span class="hljs-comment">//ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œå®Œæˆå¯¹NettyServerçš„åˆå§‹åŒ–å’Œå¯åŠ¨</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startServer0</span><span class="hljs-params">(String hostname, <span class="hljs-keyword">int</span> port)</span> </span>&#123;        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();            serverBootstrap.group(bossGroup, workerGroup)                    .channel(NioServerSocketChannel.class)                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                                      <span class="hljs-meta">@Override</span>                                      <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                                          ChannelPipeline pipeline = ch.pipeline();                                          pipeline.addLast(<span class="hljs-keyword">new</span> StringDecoder());                                          pipeline.addLast(<span class="hljs-keyword">new</span> StringEncoder());                                          pipeline.addLast(<span class="hljs-keyword">new</span> NettyServerHandler()); <span class="hljs-comment">//ä¸šåŠ¡å¤„ç†å™¨</span>                                      &#125;                                  &#125;                    );            ChannelFuture channelFuture = serverBootstrap.bind(hostname, port).sync();            System.out.println(<span class="hljs-string">&quot;æœåŠ¡æä¾›æ–¹å¼€å§‹æä¾›æœåŠ¡~~&quot;</span>);            channelFuture.channel().closeFuture().sync();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125; <span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.netty;<span class="hljs-keyword">import</span> com.atguigu.netty.dubborpc.customer.ClientBootstrap;<span class="hljs-keyword">import</span> com.atguigu.netty.dubborpc.provider.HelloServiceImpl;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-comment">//æœåŠ¡å™¨è¿™è¾¹handleræ¯”è¾ƒç®€å•</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//è·å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶è°ƒç”¨æœåŠ¡</span>        System.out.println(<span class="hljs-string">&quot;msg=&quot;</span> + msg);        <span class="hljs-comment">//å®¢æˆ·ç«¯åœ¨è°ƒç”¨æœåŠ¡å™¨çš„api æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªåè®®</span>        <span class="hljs-comment">//æ¯”å¦‚æˆ‘ä»¬è¦æ±‚ æ¯æ¬¡å‘æ¶ˆæ¯æ˜¯éƒ½å¿…é¡»ä»¥æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´ &quot;HelloService#hello#ä½ å¥½&quot;</span>        <span class="hljs-keyword">if</span> (msg.toString().startsWith(ClientBootstrap.providerName)) &#123;            String result = <span class="hljs-keyword">new</span> HelloServiceImpl().hello(msg.toString().substring(msg.toString().lastIndexOf(<span class="hljs-string">&quot;#&quot;</span>) + <span class="hljs-number">1</span>));            ctx.writeAndFlush(result);        &#125;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ctx.close();    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.netty;<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;<span class="hljs-keyword">import</span> java.util.concurrent.Callable;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span> </span>&#123;    <span class="hljs-keyword">private</span> ChannelHandlerContext context;<span class="hljs-comment">//ä¸Šä¸‹æ–‡</span>    <span class="hljs-keyword">private</span> String result; <span class="hljs-comment">//è¿”å›çš„ç»“æœ</span>    <span class="hljs-keyword">private</span> String para; <span class="hljs-comment">//å®¢æˆ·ç«¯è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼ å…¥çš„å‚æ•°</span>        <span class="hljs-comment">//ä¸æœåŠ¡å™¨çš„è¿æ¥åˆ›å»ºåï¼Œå°±ä¼šè¢«è°ƒç”¨, è¿™ä¸ªæ–¹æ³•æ˜¯ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨(1)</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot; channelActive è¢«è°ƒç”¨  &quot;</span>);        context = ctx; <span class="hljs-comment">//å› ä¸ºæˆ‘ä»¬åœ¨å…¶å®ƒæ–¹æ³•ä¼šä½¿ç”¨åˆ° ctx</span>    &#125;    <span class="hljs-comment">//æ”¶åˆ°æœåŠ¡å™¨çš„æ•°æ®åï¼Œè°ƒç”¨æ–¹æ³• (4)</span>    <span class="hljs-comment">//</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot; channelRead è¢«è°ƒç”¨  &quot;</span>);        result = msg.toString();        notify(); <span class="hljs-comment">//å”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span>    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ctx.close();    &#125;    <span class="hljs-comment">//è¢«ä»£ç†å¯¹è±¡è°ƒç”¨, å‘é€æ•°æ®ç»™æœåŠ¡å™¨ï¼Œ-&gt; wait -&gt; ç­‰å¾…è¢«å”¤é†’(channelRead) -&gt; è¿”å›ç»“æœ (3)-ã€‹5</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Object <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        System.out.println(<span class="hljs-string">&quot; call1 è¢«è°ƒç”¨  &quot;</span>);        context.writeAndFlush(para);        <span class="hljs-comment">//è¿›è¡Œwait</span>        wait(); <span class="hljs-comment">//ç­‰å¾…channelRead æ–¹æ³•è·å–åˆ°æœåŠ¡å™¨çš„ç»“æœåï¼Œå”¤é†’</span>        System.out.println(<span class="hljs-string">&quot; call2 è¢«è°ƒç”¨  &quot;</span>);        <span class="hljs-keyword">return</span> result; <span class="hljs-comment">//æœåŠ¡æ–¹è¿”å›çš„ç»“æœ</span>    &#125;    <span class="hljs-comment">//(2)</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setPara</span><span class="hljs-params">(String para)</span> </span>&#123;        System.out.println(<span class="hljs-string">&quot; setPara  &quot;</span>);        <span class="hljs-keyword">this</span>.para = para;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.netty;<span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<span class="hljs-keyword">import</span> java.util.concurrent.Executor;<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<span class="hljs-keyword">import</span> java.util.concurrent.Executors;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyClient</span> </span>&#123;    <span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹æ± </span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExecutorService executor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NettyClientHandler client;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;    <span class="hljs-comment">//ç¼–å†™æ–¹æ³•ä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œè·å–ä¸€ä¸ªä»£ç†å¯¹è±¡</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; serivceClass, <span class="hljs-keyword">final</span> String providerName)</span> </span>&#123;        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),                <span class="hljs-keyword">new</span> Class&lt;?&gt;[]&#123;serivceClass&#125;, (proxy, method, args) -&gt; &#123;                    System.out.println(<span class="hljs-string">&quot;(proxy, method, args) è¿›å…¥....&quot;</span> + (++count) + <span class="hljs-string">&quot; æ¬¡&quot;</span>);                    <span class="hljs-comment">//&#123;&#125;  éƒ¨åˆ†çš„ä»£ç ï¼Œå®¢æˆ·ç«¯æ¯è°ƒç”¨ä¸€æ¬¡ hello, å°±ä¼šè¿›å…¥åˆ°è¯¥ä»£ç </span>                    <span class="hljs-keyword">if</span> (client == <span class="hljs-keyword">null</span>) &#123;                        initClient();                    &#125;                    <span class="hljs-comment">//è®¾ç½®è¦å‘ç»™æœåŠ¡å™¨ç«¯çš„ä¿¡æ¯</span>                    <span class="hljs-comment">//providerName åè®®å¤´ args[0] å°±æ˜¯å®¢æˆ·ç«¯è°ƒç”¨api hello(???), å‚æ•°</span>                    client.setPara(providerName + args[<span class="hljs-number">0</span>]);                    <span class="hljs-comment">//</span>                    <span class="hljs-keyword">return</span> executor.submit(client).get();                &#125;);    &#125;    <span class="hljs-comment">//åˆå§‹åŒ–å®¢æˆ·ç«¯</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initClient</span><span class="hljs-params">()</span> </span>&#123;        client = <span class="hljs-keyword">new</span> NettyClientHandler();        <span class="hljs-comment">//åˆ›å»ºEventLoopGroup</span>        NioEventLoopGroup group = <span class="hljs-keyword">new</span> NioEventLoopGroup();        Bootstrap bootstrap = <span class="hljs-keyword">new</span> Bootstrap();        bootstrap.group(group)                .channel(NioSocketChannel.class)                .option(ChannelOption.TCP_NODELAY, <span class="hljs-keyword">true</span>)                .handler(                        <span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;                            <span class="hljs-meta">@Override</span>                            <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;                                ChannelPipeline pipeline = ch.pipeline();                                pipeline.addLast(<span class="hljs-keyword">new</span> StringDecoder());                                pipeline.addLast(<span class="hljs-keyword">new</span> StringEncoder());                                pipeline.addLast(client);                            &#125;                        &#125;                );        <span class="hljs-keyword">try</span> &#123;            bootstrap.connect(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">7000</span>).sync();        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;<span class="hljs-keyword">package</span> com.atguigu.netty.dubborpc.customer;<span class="hljs-keyword">import</span> com.atguigu.netty.dubborpc.netty.NettyClient;<span class="hljs-keyword">import</span> com.atguigu.netty.dubborpc.publicinterface.HelloService;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientBootstrap</span> </span>&#123;        <span class="hljs-comment">//è¿™é‡Œå®šä¹‰åè®®å¤´</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String providerName = <span class="hljs-string">&quot;HelloService#hello#&quot;</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</span>        NettyClient customer = <span class="hljs-keyword">new</span> NettyClient();        <span class="hljs-comment">//åˆ›å»ºä»£ç†å¯¹è±¡</span>        HelloService service = (HelloService) customer.getBean(HelloService.class, providerName);        <span class="hljs-keyword">for</span> (; ; ) &#123;            Thread.sleep(<span class="hljs-number">2</span> * <span class="hljs-number">1000</span>);            <span class="hljs-comment">//é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æœåŠ¡æä¾›è€…çš„æ–¹æ³•(æœåŠ¡)</span>            String res = service.hello(<span class="hljs-string">&quot;ä½ å¥½ dubbo~&quot;</span>);            System.out.println(<span class="hljs-string">&quot;è°ƒç”¨çš„ç»“æœ res= &quot;</span> + res);        &#125;    &#125;&#125;</code></pre></div>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Java/">Java</category>
      
      <category domain="https://pncalbl.github.io/categories/Java/Network/">Network</category>
      
      
      <category domain="https://pncalbl.github.io/tags/network/">network</category>
      
      <category domain="https://pncalbl.github.io/tags/framework/">framework</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/22/Netty%E5%AD%A6%E4%B9%A0/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Win10 æ­å»º PyTorch ç¯å¢ƒ</title>
      <link>https://pncalbl.github.io/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/</link>
      <guid>https://pncalbl.github.io/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/</guid>
      <pubDate>Wed, 19 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Win10-æ­å»º-PyTorch-ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#Win10-æ­å»º-PyTorch-ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;Win10 æ­å»º PyTorch ç¯å¢ƒ&quot;&gt;&lt;/a&gt;Win10 æ­å»º PyTorch ç¯å¢ƒ&lt;/h1&gt;&lt;h2 i</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Win10-æ­å»º-PyTorch-ç¯å¢ƒ"><a href="#Win10-æ­å»º-PyTorch-ç¯å¢ƒ" class="headerlink" title="Win10 æ­å»º PyTorch ç¯å¢ƒ"></a>Win10 æ­å»º PyTorch ç¯å¢ƒ</h1><h2 id="0-è¯´æ˜"><a href="#0-è¯´æ˜" class="headerlink" title="0 è¯´æ˜"></a>0 è¯´æ˜</h2><p>ä¸ºäº†è¿›è¡Œæ·±åº¦å­¦ä¹ ï¼Œéœ€è¦ç”µè„‘ä¸Šå®‰è£…ç›¸åº”çš„è½¯ä»¶ï¼Œpytorch å°±æ˜¯å…¶ä¸­ä¸€ç§ã€‚è‡³äº pytorch æ˜¯ä»€ä¹ˆçš„ç§‘æ™®ï¼Œå»ºè®®å»ç½‘ä¸Šæœç´¢ã€‚</p><p>è€Œä¸ºäº†å®‰è£…å¥½ pytorchï¼Œéœ€è¦å®‰è£…ä¼—å¤šè½¯ä»¶ï¼Œç½‘ä¸Šä¸€æœä¸€å¤§æŠŠæµç¨‹ã€‚ä½†äº‹å®ä¸Šéšç€æŠ€æœ¯çš„æ›´æ–°ï¼Œå¾ˆå¤šæµç¨‹éƒ½ä¼šå˜å¾—è¿‡æ—¶ï¼Œå°±åƒæˆ‘ç°åœ¨è¿™ç¯‡ï¼Œå› æ­¤æˆ‘ä¹Ÿç‰¹æ„æ ‡æ³¨äº†æ—¶é—´ã€‚</p><p>æœ¬æµç¨‹çš„ç›®çš„æ˜¯ï¼šåœ¨ win 10 ä¸Šå®‰è£… pytorch ä¸”èƒ½è°ƒç”¨ GPUï¼ˆä½ éœ€è¦è‹±ä¼Ÿè¾¾çš„æ˜¾å¡ï¼‰ã€‚</p><p>æœ¬æµç¨‹æ¶‰åŠçš„ç¨‹åºæœ‰ï¼šcondaï¼ŒCUDAï¼ŒcuDNNï¼Œpytorchã€‚æ³¨æ„ä¸€å®šè¦æŒ‰æµç¨‹æ¥ï¼Œå¦‚æœè·³è¿‡äº† cuDNN å®‰è£… pytorchï¼Œæ˜¯ä¸ä¼šæˆåŠŸè°ƒç”¨ GPU çš„ã€‚</p><h2 id="1-Miniconda3"><a href="#1-Miniconda3" class="headerlink" title="1 Miniconda3"></a>1 Miniconda3</h2><p>æ¸…åæºé•œåƒå·²ç»æ²¡æœ‰ç»´æŠ¤ minicondaï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨åŒ—å¤–æºã€‚</p><ul><li><p><strong>ä¸‹è½½åœ°å€</strong></p><p><a href="https://mirrors.bfsu.edu.cn/anaconda/miniconda/">Index of /anaconda/miniconda</a></p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521111325301.png" alt="image-20210521111325301"></p></li><li><p><strong>é…ç½®ç¯å¢ƒå˜é‡</strong></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå®‰è£…ç¨‹åºä¼šè‡ªåŠ¨æŠŠå››ä¸ª path å˜é‡ï¼Œå†™å…¥ç³»ç»Ÿå˜é‡çš„pathå˜é‡ä¸­ï¼Œä½†æ˜¯ä¼šå†™å…¥ç¬¬ä¸€è¡Œï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ä¸‹ç§»ä½ç½®ã€‚</p><ul><li><p>æ‰“å¼€ cmdï¼ˆwin+Rï¼Œè¾“å…¥ cmd åå›è½¦ï¼‰ï¼Œè¾“å…¥ conda infoï¼Œå¦‚æœæ­£ç¡®æ— è¯¯çš„è¯ï¼Œä¼šæ˜¾ç¤º conda çš„ä¿¡æ¯ã€‚</p></li><li><p>ä¸ºäº† conda çš„ä¸‹è½½é€Ÿåº¦ï¼Œéœ€è¦æ·»åŠ å›½å†…çš„åŒ—å¤–æºï¼Œè¾“å…¥ï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">conda config --set show_channel_urls yes</code></pre></div><p>åˆ›å»ºé…ç½®æ–‡ä»¶ .condarcï¼Œè¯¥æ–‡ä»¶ä½äºï¼šC:\Users\ä½ çš„ç”¨æˆ·å\ ä¸‹ã€‚</p><p>ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å®ƒï¼Œç„¶åå¤åˆ¶ä»¥ä¸‹å†…å®¹å®Œå…¨è¦†ç›–å·²æœ‰å†…å®¹ï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">channels:  - defaultsshow_channel_urls: truedefault_channels:  - https://mirrors.bfsu.edu.cn/anaconda/pkgs/main  - https://mirrors.bfsu.edu.cn/anaconda/pkgs/r  - https://mirrors.bfsu.edu.cn/anaconda/pkgs/msys2custom_channels:  conda-forge: https://mirrors.bfsu.edu.cn/anaconda/cloud  msys2: https://mirrors.bfsu.edu.cn/anaconda/cloud  bioconda: https://mirrors.bfsu.edu.cn/anaconda/cloud  menpo: https://mirrors.bfsu.edu.cn/anaconda/cloud  pytorch: https://mirrors.bfsu.edu.cn/anaconda/cloud  simpleitk: https://mirrors.bfsu.edu.cn/anaconda/cloud</code></pre></div></li></ul></li><li><p><strong>ç”Ÿæˆå¹¶è¿›å…¥ç¯å¢ƒ</strong></p><ul><li><p>ä½¿ç”¨å‘½ä»¤åˆ›å»ºç¯å¢ƒï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">conda create --name py37 python=3.7</code></pre></div></li><li><p>å³åˆ›å»ºäº†åä¸º py37 çš„ç¯å¢ƒï¼Œä½ å¯ä»¥è‡ªå®šä¹‰åå­—ï¼Œpython è®¾å®šç”¨çš„ç‰ˆæœ¬ã€‚</p><p>éšåè¿›å…¥ç¯å¢ƒ</p><div class="code-wrapper"><pre><code class="hljs shell">conda activate py37</code></pre></div></li><li><p><strong>é¿å‘ï¼šæ“ä½œéœ€è¦åœ¨ cmd é‡Œåšï¼Œè€Œä¸æ˜¯ powershellï¼Œä¸çŸ¥é“åŸç†ï¼Œä½†ä¼šæŠ¥é”™ã€‚</strong></p><p>å¦‚æœåœ¨ powershell é‡Œè¿è¡Œçš„è¯ï¼Œä¼šæŠ¥é”™ï¼š</p><div class="code-wrapper"><pre><code class="hljs powershell">CommandNotFoundError: Your shell has not been properly configured to use <span class="hljs-string">&#x27;conda activate&#x27;</span>.</code></pre></div><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/v2-e641b91a6a360410b575d83c3030daf4_1440w.jpg" alt="img"></p></li></ul></li><li><p><strong>å®‰è£… ipython</strong></p><ul><li><p>ipython çš„æ“ä½œæ¯” python ç”¨èµ·æ¥èˆ’æœå¤šäº†ï¼Œå…·ä½“ä»‹ç»æœç´¢ç½‘ä¸Š</p><div class="code-wrapper"><pre><code class="hljs shell">conda install ipython</code></pre></div></li><li><p>ä¹‹åè¾“å…¥ ipython è¿›å…¥ pythonã€‚</p></li></ul></li></ul><h2 id="2-CUDA"><a href="#2-CUDA" class="headerlink" title="2 CUDA"></a>2 CUDA</h2><ul><li><p>ä¸‹è½½</p><p>é“¾æ¥ï¼š<a href="https://developer.nvidia.com/cuda-10.2-download-archive">https://developer.nvidia.com/cuda-downloads</a></p><p>ä¾æ¬¡é€‰æ‹©ï¼šWindows -&gt; x86_64 -&gt; 10 -&gt; exe(local)ï¼Œç‚¹å‡» Downloadã€‚ä¸‹è½½çš„ä¸ºé€‚åˆPyTorchçš„ <em>cuda_10.2.89_441.22_win10.exe</em></p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521112724889.png" alt="image-20210521112724889"></p><p><strong>é¿å‘ï¼šå¤åˆ¶ä¸‹è½½é“¾æ¥åç”¨è¿…é›·ä¸‹è½½ï¼Œæ¯”ç›´æ¥ä¸‹è½½å¿«æ•°å€ã€‚</strong></p></li><li><p>å®‰è£…</p><ul><li><p>æ³¨æ„ï¼Œä¸è¦ä¿®æ”¹å®‰è£…è·¯å¾„ï¼Œå› ä¸ºæ”¹äº†æ²¡æœ‰ç”¨ï¼Œå®‰è£…ç¨‹åºè¿˜æ˜¯ä¼šå®‰è£…åœ¨ Cç›˜ä¸‹çš„ C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA</p></li><li><p>å¿…é¡»æ‰‹åŠ¨æ·»åŠ ç¯å¢ƒå˜é‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒCUDA_PATHï¼Œå®‰è£…ç¨‹åºä¼šè‡ªåŠ¨å†™å…¥ã€‚</p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521113202277.png" alt="image-20210521113202277"></p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521113121745.png" alt="image-20210521113121745"></p></li></ul></li></ul><ul><li><p><strong>æµ‹è¯•</strong></p><ul><li><p>å¦‚æœå®‰è£…æˆåŠŸï¼Œåœ¨ cmd é‡Œè¾“å…¥ï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">nvcc -V</code></pre></div><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521113321717.png" alt="image-20210521113321717"></p></li></ul></li></ul><h2 id="3-cuDNN"><a href="#3-cuDNN" class="headerlink" title="3 cuDNN"></a>3 cuDNN</h2><ul><li><p><strong>ä¸‹è½½</strong></p><p><strong>é¿å‘ï¼šå»ºè®®åœ¨ç¿»å¢™çš„æƒ…å†µä¸‹æ“ä½œï¼Œæ³¨å†Œæ—¶çš„éªŒè¯ç æ˜¯è°·æ­Œçš„ã€‚</strong></p><p>ä½ éœ€è¦æ³¨å†Œè´¦å·åæ‰èƒ½ç»§ç»­ã€‚ç°åœ¨å¯ä»¥<strong>å¾®ä¿¡ç™»å½•</strong>ï¼Œæ–¹ä¾¿äº†ä¸å°‘ã€‚</p><p>é“¾æ¥ï¼š<a href="/compute/machine-learning/cudnn/secure/8.0.2.39/10.2_20200724/cudnn-10.2-windows10-x64-v8.0.2.39.zip">https://developer.nvidia.com</a></p></li><li><p><strong>å®‰è£…</strong></p><p>è¯´æ˜¯å®‰è£…ï¼Œå…¶å®æ˜¯å¤åˆ¶æ–‡ä»¶ã€‚</p><p>ä¸‹è½½åæ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶å¤¹ï¼Œè§£å‹æ–‡ä»¶å¤¹ï¼Œå°†é‡Œé¢çš„ 3 ä¸ªæ–‡ä»¶å¤¹ï¼šbinï¼Œincludeï¼Œlib é‡Œé¢çš„å†…å®¹åˆ†åˆ«æ”¾å…¥ CUDA å®‰è£…ä½ç½®çš„å¯¹åº”æ–‡ä»¶å¤¹ã€‚</p><p>CUDA å®‰è£…çš„ä½ç½®åœ¨ï¼š</p><p>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0</p><p>ä¸ä¼šå‡ºç°è¦†ç›–çš„è­¦å‘Šï¼Œå› ä¸ºæ˜¯æ–°å¢çš„æ–‡ä»¶ã€‚</p></li></ul><h2 id="4-PyTorch"><a href="#4-PyTorch" class="headerlink" title="4 PyTorch"></a>4 PyTorch</h2><ul><li><p><strong>1. ä¸‹è½½ä¸å®‰è£…</strong></p><p><strong>é¿å‘ï¼šåŠ¡å¿…åœ¨å®Œæˆä»¥ä¸Šæ­¥éª¤åæ‰è¿›è¡Œã€‚</strong></p><p>ç½‘å€ï¼š<a href="https://link.zhihu.com/?target=https%3A//pytorch.org/get-started/locally/">https://pytorch.org/get-started/locally/</a>ï¼Œæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ã€‚</p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521114119171.png" alt="image-20210521114119171"></p><p>å¾—åˆ°ä¸‹è½½å®‰è£…çš„å‘½ä»¤ï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">conda install pytorch torchvision torchaudio cudatoolkit=10.2 -c pytorch</code></pre></div><p>ä½¿ç”¨ cmd è¿›å…¥äº†æˆ‘ä»¬ä¹‹å‰è®¾ç½®çš„ç¯å¢ƒ py37 åï¼Œè¾“å…¥ä»¥ä¸Šå‘½ä»¤ï¼Œå¼€å§‹å®‰è£… pytorchï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/v2-58b3d7c11020aca95ab177253cf5d1b0_1440w.jpg" alt="img"></p><p><strong>é¿å‘ï¼šå¾ˆå¤šæ•™ç¨‹é‡Œè¯´ï¼Œå»æ‰ -c pytorch åï¼Œå¯ä»¥åŠ é€Ÿä¸‹è½½ã€‚å¯ä»¥åŠ é€Ÿæ²¡é”™ï¼Œä½†ä¸‹è½½çš„ä¸œè¥¿å´ä¸æ˜¯æˆ‘ä»¬è¦çš„ gpu ç‰ˆæœ¬ï¼Œè€Œæ˜¯ cpu ç‰ˆæœ¬ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šäººç…§ç€æ•™ç¨‹åšï¼Œæœ€ç»ˆéƒ½æ— æ³•ä½¿ç”¨ gpu çš„ï¼Œå´ç™¾æ€ä¸å¾—å…¶è§£ã€‚</strong></p></li><li><p><strong>2. æµ‹è¯•</strong></p><ul><li><p>ç­‰å¾…å®‰è£…å®Œæˆåï¼Œè¾“å…¥ ipython è¿›å…¥ pythonï¼Œè¾“å…¥ï¼š</p><div class="code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchtorch.cuda.is_available()</code></pre></div><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/v2-6acee085f9449a931afaee3cdd36336a_1440w.jpg" alt="img"></p></li><li><p>æ˜¾ç¤º True å³è¡¨æ˜å¯ç”¨äº† pytorch çš„ gpuï¼Œåˆ°æ­¤å®‰è£…ç»“æŸã€‚</p></li><li><p>å¦‚æœ torch.cuda.isavailable() æ˜¯ Falseï¼Œä½ å¯èƒ½éœ€è¦çœ‹çœ‹å‰é¢å“ªä¸ªæ­¥éª¤ä¸å¯¹ã€‚</p></li></ul></li></ul><h2 id="5-Pycharm"><a href="#5-Pycharm" class="headerlink" title="5 Pycharm"></a>5 Pycharm</h2><ul><li><p>åˆ›å»ºä¸€ä¸ªé¡¹ç›® PyTorchTest</p></li><li><p>æ‰“å¼€è®¾ç½® Ctrl + Alt + s</p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521114808829.png" alt="image-20210521114808829"></p></li><li><p>å¼•å…¥ py37 </p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521114859777.png" alt="image-20210521114859777"></p></li><li><p>åˆ‡æ¢ç¯å¢ƒä¸º py37</p><p><img src="/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/image-20210521114957218.png" alt="image-20210521114957218"></p></li><li><p>é‡å¯ Pycharm</p></li></ul>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Help/">Help</category>
      
      <category domain="https://pncalbl.github.io/categories/Help/Win/">Win</category>
      
      
      <category domain="https://pncalbl.github.io/tags/PyTorch/">PyTorch</category>
      
      <category domain="https://pncalbl.github.io/tags/Win10/">Win10</category>
      
      <category domain="https://pncalbl.github.io/tags/Deep-learning/">Deep learning</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/20/Win10%E6%90%AD%E5%BB%BAPyTorch%E7%8E%AF%E5%A2%83/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Liunx ä¸€èˆ¬é…ç½®ä¸å‘½ä»¤</title>
      <link>https://pncalbl.github.io/2021/05/10/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</link>
      <guid>https://pncalbl.github.io/2021/05/10/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</guid>
      <pubDate>Sun, 09 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;1-Liunx-å¸¸ç”¨å‘½ä»¤&quot;&gt;&lt;a href=&quot;#1-Liunx-å¸¸ç”¨å‘½ä»¤&quot; class=&quot;headerlink&quot; title=&quot;1 Liunx å¸¸ç”¨å‘½ä»¤&quot;&gt;&lt;/a&gt;1 Liunx å¸¸ç”¨å‘½ä»¤&lt;/h1&gt;&lt;h2 id=&quot;1-å‘½ä»¤è¡Œ&quot;&gt;&lt;a href=&quot;#1-å‘½ä»¤è¡Œ&quot; c</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="1-Liunx-å¸¸ç”¨å‘½ä»¤"><a href="#1-Liunx-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="1 Liunx å¸¸ç”¨å‘½ä»¤"></a>1 Liunx å¸¸ç”¨å‘½ä»¤</h1><h2 id="1-å‘½ä»¤è¡Œ"><a href="#1-å‘½ä»¤è¡Œ" class="headerlink" title="1 å‘½ä»¤è¡Œ"></a>1 å‘½ä»¤è¡Œ</h2><table><thead><tr><th>æè¿°</th><th>å‘½ä»¤</th></tr></thead><tbody><tr><td>ç¼–è¾‘ç¯å¢ƒå˜é‡</td><td>vim /etc/profile</td></tr><tr><td>ç”Ÿæ•ˆç¯å¢ƒå˜é‡</td><td>source /etc/profile</td></tr><tr><td>æ£€æŸ¥ç›®æ ‡æœåŠ¡çš„ç«¯å£ç›‘å¬çŠ¶æ€</td><td>netstat -ntlp | grep 3306</td></tr><tr><td>å¯åŠ¨ç›®æ ‡æœåŠ¡</td><td>systemctl start service</td></tr><tr><td>æ£€æŸ¥ç›®æ ‡æœåŠ¡çš„çŠ¶æ€</td><td>systemctl status service</td></tr><tr><td>åœæ­¢ç›®æ ‡æœåŠ¡</td><td>systemctl stop service</td></tr><tr><td>æŸ¥çœ‹å®‰è£…åŒ…</td><td>rpm -qa | grep Git</td></tr><tr><td>æ·»åŠ ç”¨æˆ·ç»„ docker</td><td>sudo groupadd docker</td></tr><tr><td>å°†ç™»é™†ç”¨æˆ·åŠ å…¥åˆ° docker ç”¨æˆ·ç»„ä¸­</td><td>sudo gpasswd -a $USER docker</td></tr><tr><td>æ›´æ–°ç”¨æˆ·ç»„</td><td>newgrp docker</td></tr><tr><td>å…³é—­é˜²ç«å¢™</td><td>systemctl stop firewalld.service</td></tr><tr><td>æ°¸ä¹…å…³é—­é˜²ç«å¢™</td><td>systemctl disable firewalld.service</td></tr><tr><td>è®¾ç½®ä¸»æœºå</td><td>hostnamectl set-hostname pncalbl-pc</td></tr></tbody></table><h2 id="2-Vim"><a href="#2-Vim" class="headerlink" title="2 Vim"></a>2 Vim</h2><table><thead><tr><th>æè¿°</th><th>å‘½ä»¤æ¨¡å¼</th><th>åº•çº¿å‘½ä»¤æ¨¡å¼</th></tr></thead><tbody><tr><td>ç§»åˆ°æœ€ç¬¬ä¸€è¡Œ</td><td>gg</td><td>:0æˆ–:1</td></tr><tr><td>ç§»åˆ°æœ€åä¸€è¡Œ</td><td>shift+g</td><td>:$</td></tr><tr><td>æœç´¢å­—ç¬¦ä¸²</td><td>æŸ¥çœ‹ä¸‹ä¸€ä¸ª  æŒ‰ä¸‹ n<br>è½¬åˆ°ä¸Šä¸€ä¸ª  æŒ‰ä¸‹ N</td><td>:/å­—ç¬¦ä¸²</td></tr></tbody></table><h2 id="3-Deepin-ç»ˆç«¯å‘½ä»¤"><a href="#3-Deepin-ç»ˆç«¯å‘½ä»¤" class="headerlink" title="3 Deepin ç»ˆç«¯å‘½ä»¤"></a>3 Deepin ç»ˆç«¯å‘½ä»¤</h2><table><thead><tr><th>æè¿°</th><th>å‘½ä»¤</th></tr></thead><tbody><tr><td>åœ¨ç»ˆç«¯ä½¿ç”¨é»˜è®¤æ–‡ä»¶ç®¡ç†å™¨æ‰“å¼€å½“å‰è·¯å¾„</td><td>xdg-open .</td></tr><tr><td>åœ¨ç»ˆç«¯ä½¿ç”¨é»˜è®¤æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å½“å‰è·¯å¾„</td><td>deepin-editor</td></tr></tbody></table><h1 id="2-è®¾ç½®å¿«æ·é”®"><a href="#2-è®¾ç½®å¿«æ·é”®" class="headerlink" title="2 è®¾ç½®å¿«æ·é”®"></a>2 è®¾ç½®å¿«æ·é”®</h1><ol><li>è¿›å…¥è®¾ç½® / <code>settings</code></li><li>è¿›å…¥ <code>Keyboard</code></li><li>ç‚¹å‡» æ·»åŠ æŒ‰é’® <code>+</code></li><li>å®šä¹‰åç§° <code>Open Terminal</code></li><li>è¾“å…¥å‘½ä»¤ <code>/usr/bin/gnome-terminal</code></li></ol><h1 id="3-æ›´æ¢-yum-æº"><a href="#3-æ›´æ¢-yum-æº" class="headerlink" title="3 æ›´æ¢ yum æº"></a>3 æ›´æ¢ yum æº</h1><h2 id="1-ä¸‹è½½wgetçš„rpmåŒ…"><a href="#1-ä¸‹è½½wgetçš„rpmåŒ…" class="headerlink" title="1.ä¸‹è½½wgetçš„rpmåŒ…"></a>1.ä¸‹è½½wgetçš„rpmåŒ…</h2><p>é¦–å…ˆå»<a href="http://mirrors.163.com/centos/7/os/x86_64/Packages/æ‰¾åˆ°wgetçš„rpmåŒ…ï¼Œå¤åˆ¶é“¾æ¥ï¼Œä½¿ç”¨curlå‘½ä»¤ä¸‹è½½">http://mirrors.163.com/centos/7/os/x86_64/Packages/æ‰¾åˆ°wgetçš„rpmåŒ…ï¼Œå¤åˆ¶é“¾æ¥ï¼Œä½¿ç”¨curlå‘½ä»¤ä¸‹è½½</a></p><p><img src="/2021/05/10/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/1089423-20191203231224175-577731216.png" alt="img"></p><p> ä½¿ç”¨curlä¸‹è½½ï¼ˆæ³¨æ„ç›¸å…³çš„åŒ…ç‰ˆæœ¬å¯èƒ½å·²ç»å˜ï¼Œè¯·ä»¥æœ€æ–°çš„ä¸‹è½½åœ°å€ä¸ºå‡†)ï¼‰</p><div class="code-wrapper"><pre><code class="hljs shell">curl http://mirrors.163.com/centos/7/os/x86_64/Packages/wget-1.14-18.el7_6.1.x86_64.rpm</code></pre></div><div class="code-wrapper"><pre><code class="hljs shell">rpm -ivh wget-1.14-18.el7_6.1.x86_64.rpm</code></pre></div><h2 id="2-å®‰è£…yum"><a href="#2-å®‰è£…yum" class="headerlink" title="2.å®‰è£…yum"></a>2.å®‰è£…yum</h2><p> 1.åˆ é™¤åŸæœ‰çš„yum</p><div class="code-wrapper"><pre><code class="hljs shell">rpm -aq|grep yum|xargs rpm -e --nodeps</code></pre></div><p> 2.ä¸‹è½½yum,æ³¨æ„è‡ªå·±çš„LINUXç³»ç»Ÿç‰ˆæœ¬ï¼Œæ˜¯ä»€ä¹ˆç‰ˆæœ¬å°±è¿›ç›¸å…³ç‰ˆæœ¬ç›®å½•å»ä¸‹è½½ã€‚ä½†å°ç‰ˆæœ¬çš„ç›®å½•å°±ä¸ç”¨è¿›äº†ã€‚å¦‚ç‰ˆæœ¬æ˜¯6.5ï¼Œå°±åªéœ€è¿›6 ç›®å½•ï¼Œç‰ˆæœ¬æ˜¯ 7.2ï¼Œåªéœ€è¿›7ç›®å½•</p><div class="code-wrapper"><pre><code class="hljs shell">1 yum-*.rpm2 yum-metadata-parser-*.rpm3 yum-plugin-fastestmirror-*.rpm4 python-iniparse-*.rpm</code></pre></div><p>3.ä½¿ç”¨wgetä¸‹è½½(æ³¨æ„ç›¸å…³çš„åŒ…ç‰ˆæœ¬å¯èƒ½å·²ç»å˜ï¼Œè¯·ä»¥æœ€æ–°çš„ä¸‹è½½åœ°å€ä¸ºå‡†)</p><div class="code-wrapper"><pre><code class="hljs shell">wget https://mirrors.163.com/centos/7/os/x86_64/Packages/yum-3.4.3-168.el7.centos.noarch.rpmwget https://mirrors.163.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpmwget https://mirrors.163.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-54.el7_8.noarch.rpmwget https://mirrors.163.com/centos/7/os/x86_64/Packages/python-iniparse-0.4-9.el7.noarch.rpm</code></pre></div><p>4.ä¸‹è½½åå®‰è½¬yumä¾èµ–çš„åŒ…</p><div class="code-wrapper"><pre><code class="hljs shell">rpm -ivh python-iniparse-*.rpmrpm -ivh yum-*.rpm  yum-metadata-parser-*.rpm  yum-plugin-fastestmirror-*.rpm</code></pre></div><h2 id="3-ä¿®æ”¹yumæº"><a href="#3-ä¿®æ”¹yumæº" class="headerlink" title="3.ä¿®æ”¹yumæº"></a>3.ä¿®æ”¹yumæº</h2><p> 1.è¿›å…¥åˆ°ç³»ç»Ÿyumæºçš„ç›®å½•ä¸‹ï¼š</p><div class="code-wrapper"><pre><code class="hljs shell">cd /etc/yum.repos.d</code></pre></div><p> 2.ä¸‹è½½yumæº</p><div class="code-wrapper"><pre><code class="hljs shell">wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</code></pre></div><p> 3.ä¿®æ”¹æºæ–‡ä»¶åï¼ˆæ³¨æ„éœ€è¦æŠŠä¹‹å‰çš„åˆ æ‰ï¼Œæˆ–è€…æ”¹ä¸º.bakæ–‡ä»¶ï¼‰</p><div class="code-wrapper"><pre><code class="hljs shell">mv CentOS7-Base-163.repo CentOS-Base.repo</code></pre></div><p>4.è¿è¡Œmakecache ç”Ÿæˆç¼“å­˜ ä½¿é…ç½®ç”Ÿæ•ˆ</p><div class="code-wrapper"><pre><code class="hljs shell">yum makecache</code></pre></div><p>5.éªŒè¯yumæº</p><div class="code-wrapper"><pre><code class="hljs shell">yum repolistæŸ¥çœ‹æ˜¯å¦æœ‰163çš„æ ‡è¯† æœ‰åˆ™è¯æ˜é…ç½®å›½å†…163é•œåƒæºæˆåŠŸ</code></pre></div><p>7.è¿è¡Œyum clean allï¼ˆç­‰åŒäº yum cleanheaders ; yum cleanpackagesï¼‰;</p><div class="code-wrapper"><pre><code class="hljs shell">yum clean allyum ä¼šæŠŠä¸‹è½½çš„è½¯ä»¶åŒ…å’Œheaderå­˜å‚¨åœ¨cacheä¸­ï¼Œè€Œä¸è‡ªåŠ¨åˆ é™¤ã€‚å¦‚æœè§‰å¾—å ç”¨ç£ç›˜ç©ºé—´ï¼Œå¯ä»¥ä½¿ç”¨yum cleanæŒ‡ä»¤è¿›è¡Œæ¸…é™¤ï¼Œæ›´ç²¾ç¡® çš„ç”¨æ³•æ˜¯yum clean headersæ¸…é™¤headerï¼Œyum clean packagesæ¸…é™¤ä¸‹è½½çš„rpmåŒ…ï¼Œyum clean allä¸€å…¨éƒ¨æ¸…é™¤ã€‚</code></pre></div><p>8.æ›´æ–°YUMæ–‡ä»¶ å…¨éƒ¨æ›´æ–°è½¯ä»¶åŒ…</p><div class="code-wrapper"><pre><code class="hljs shell">yum  update</code></pre></div><p>10.yumå¸¸ç”¨æ“ä½œ</p><div class="code-wrapper"><pre><code class="hljs shell">yum install XXXyum remove XXXyum listyum list installed</code></pre></div><h1 id="4-ç¾åŒ–ç•Œé¢"><a href="#4-ç¾åŒ–ç•Œé¢" class="headerlink" title="4 ç¾åŒ–ç•Œé¢"></a>4 ç¾åŒ–ç•Œé¢</h1><ol><li><p>å…ˆå®‰è£… gnome-tweak-tool</p><div class="code-wrapper"><pre><code class="hljs shell">yum install gnome-tweak-tool</code></pre></div></li><li><p>ä¸»é¢˜ï¼š<a href="mailto:git@gitzab.com">git@gitzab.com</a>:Anduin/GNOME-OSX-II-Theme.git </p><p>è§£å‹ GNOME-OSX-II-Theme-master.zip åˆ° /home/pncalbl/.themes </p><p>åœ¨ tweak ä¸­åˆ‡æ¢ä¸»é¢˜ GNOME-OSX-II-Theme</p></li><li><p>å›¾æ ‡ï¼š<a href="mailto:git@github.com">git@github.com</a>:keeferrourke/la-capitaine-icon-theme.git </p><p>è§£å‹ la-capitaine-icon-theme-master.zip åˆ° /home/pncalbl/.icons</p><p>åœ¨ tweak ä¸­åˆ‡æ¢ä¸»é¢˜ å›¾æ ‡</p></li><li><p>å¯åŠ¨å™¨ï¼š<a href="mailto:git@github.com">git@github.com</a>:micheleg/dash-to-dock.git</p></li></ol><h1 id="5-ç”Ÿæˆå¯†é’¥"><a href="#5-ç”Ÿæˆå¯†é’¥" class="headerlink" title="5 ç”Ÿæˆå¯†é’¥"></a>5 ç”Ÿæˆå¯†é’¥</h1><ol><li>ç”Ÿæˆç§˜é’¥</li></ol><div class="code-wrapper"><pre><code class="hljs shell">//æ¢æˆä½ è‡ªå·±çš„é‚®ç®±ssh-keygen -t rsa -C &quot;pncalbl@qq.com&quot;//ä¸€ç›´nextå¹¶è®°ä½ç”Ÿæˆçš„åœ°å€Generating public/private rsa key pair.Enter file in which to save the key (/root/.ssh/id_rsa):Created directory &#x27;/root/.ssh&#x27;.Enter passphrase (empty for no passphrase):Enter same passphrase again:Your identification has been saved in /root/.ssh/id_rsa.Your public key has been saved in /root/.ssh/id_rsa.pub.</code></pre></div><ol><li>è¿›å…¥.ssh ç›®å½•æå‡ºkey</li></ol><div class="code-wrapper"><pre><code class="hljs shell">[root@localhost ~]# cd .ssh[root@localhost .ssh]# lsid_rsa  id_rsa.pub//æŠŠæ˜¾ç¤ºçš„å†…å®¹å¤åˆ¶åˆ°GitHubçš„SSHkeyé…ç½®å³å¯[root@localhost .ssh]# cat id_rsa.pub</code></pre></div><ol><li>æµ‹è¯•</li></ol><div class="code-wrapper"><pre><code class="hljs shell">[root@localhost .ssh]# ssh -T git@github.comThe authenticity of host &#x27;github.com (192.30.255.113)&#x27; can&#x27;t be established.RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.Are you sure you want to continue connecting (yes/no)? yPlease type &#x27;yes&#x27; or &#x27;no&#x27;: yesWarning: Permanently added &#x27;github.com,192.30.255.113&#x27; (RSA) to the list of known hosts.Hi megoc! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</code></pre></div><h1 id="6-é‡è½½-VMware-tools"><a href="#6-é‡è½½-VMware-tools" class="headerlink" title="6 é‡è½½ VMware tools"></a>6 é‡è½½ VMware tools</h1><p>ä»¥ä¸‹å‘½ä»¤éƒ½åœ¨ root æƒé™ä¸‹è¿›è¡Œ</p><ol><li>å¸è½½   <code>yum remove open-vm-tools</code></li><li>ä½¿ç”¨ VM å®‰è£… <code>VMware Tools</code></li><li>ä»å…‰ç›˜å¤åˆ¶å‡º VMwareTools-10.3.21-14772444.tar.gz</li><li>è§£å‹ç¼© tar -zxvf  VMwareTools-10.3.21-14772444.tar.gz -C ./</li><li>æ‰§è¡Œ  <code>./vmware-install.pl</code></li><li><code>ç¬¬ä¸€æ­¥è¾“å…¥: y</code>, å‰©ä¸‹çš„æŒ‰å›è½¦é»˜è®¤å³å¯</li></ol><h1 id="7-è¿è¡Œ-java-ç¨‹åº"><a href="#7-è¿è¡Œ-java-ç¨‹åº" class="headerlink" title="7 è¿è¡Œ java ç¨‹åº"></a>7 è¿è¡Œ java ç¨‹åº</h1><p>åœ¨ <code>Linux</code>ç³»ç»Ÿä¸‹è¿è¡Œ <code>java</code>ç¨‹åº</p><p><code>Hello.java</code></p><p>å®Œæ•´ç›®å½•ä¸º ï¼š<code>/home/username/project/java/com/pnca/c17/Hello.java</code></p><div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pnca.c17;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);&#125;&#125;</code></pre></div><p>å¦‚æœå¸¦æœ‰åŒ…åï¼Œå¿…é¡»å­˜åœ¨å¯¹åº”çš„ç›®å½•ï¼Œå¹¶æŠŠå¯¹åº”çš„ <code>.java</code> æ–‡ä»¶å­˜æ”¾åˆ°å¯¹åº”çš„åŒ…ä¸­ã€‚</p><h2 id="ç¼–è¯‘-javac"><a href="#ç¼–è¯‘-javac" class="headerlink" title="ç¼–è¯‘ javac"></a>ç¼–è¯‘ javac</h2><div class="code-wrapper"><pre><code class="hljs shell">javac -encoding utf-8 -cp com/pnca/c17/Hello.java</code></pre></div><h2 id="è¿è¡Œ-java"><a href="#è¿è¡Œ-java" class="headerlink" title="è¿è¡Œ java"></a>è¿è¡Œ java</h2><div class="code-wrapper"><pre><code class="hljs shell">java  -classpath . com.pnca.c17.Hello</code></pre></div><p><code>.</code> æŒ‡çš„æ˜¯å½“å‰ç›®å½•ï¼Œå³ä¸º /home/username/project/java</p><p>å¦‚æœæœ‰åŒ…åï¼Œåˆ™å¿…é¡»ä½¿ç”¨ç±»çš„å…¨é™å®šåå³ï¼šcom.pnca.c17.Hello</p><h1 id="8-Linux-é…ç½®-vpn"><a href="#8-Linux-é…ç½®-vpn" class="headerlink" title="8 Linux é…ç½® vpn"></a>8 Linux é…ç½® vpn</h1><p><a href="https://xugaoxiang.com/2020/10/17/qv2ray/#ubuntuå¹³å°ä½¿ç”¨">Qv2rayåŸºæœ¬ä½¿ç”¨ - è¿·é€”å°ä¹¦ç«¥çš„Noteè¿·é€”å°ä¹¦ç«¥çš„Note (xugaoxiang.com)</a></p><h1 id="9-Linux-CapsLock-ä¸åœåˆ‡æ¢"><a href="#9-Linux-CapsLock-ä¸åœåˆ‡æ¢" class="headerlink" title="9 Linux CapsLock ä¸åœåˆ‡æ¢"></a>9 Linux CapsLock ä¸åœåˆ‡æ¢</h1><p>Vmvare 15.5.5 çš„ Bugï¼Œéœ€è¦ä¿®æ”¹è™šæ‹Ÿæœºé•œåƒçš„é…ç½®ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿæœºçš„é…ç½®</p><p><img src="http://rc6xl0rtp.hd-bkt.clouddn.com/typora/image-20220521232256903.png?imageslim" alt="image-20220521232256903"></p><div class="code-wrapper"><pre><code class="hljs txt">mks.win32.useInjectedMagic = &quot;FALSE&quot;</code></pre></div><p>é‡å¯è™šæ‹Ÿæœºå³å¯</p>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Help/">Help</category>
      
      <category domain="https://pncalbl.github.io/categories/Help/Linux/">Linux</category>
      
      
      <category domain="https://pncalbl.github.io/tags/Linux/">Linux</category>
      
      <category domain="https://pncalbl.github.io/tags/%E5%91%BD%E4%BB%A4/">å‘½ä»¤</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/10/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>åˆ†æå¼€æºé¡¹ç›®</title>
      <link>https://pncalbl.github.io/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/</link>
      <guid>https://pncalbl.github.io/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/</guid>
      <pubDate>Sat, 08 May 2021 16:00:00 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;åˆ†æå¼€æºé¡¹ç›®-EL-ADMIN&quot;&gt;&lt;a href=&quot;#åˆ†æå¼€æºé¡¹ç›®-EL-ADMIN&quot; class=&quot;headerlink&quot; title=&quot;åˆ†æå¼€æºé¡¹ç›® (EL-ADMIN)&quot;&gt;&lt;/a&gt;åˆ†æå¼€æºé¡¹ç›® (EL-ADMIN)&lt;/h1&gt;&lt;h2 id=&quot;1-è§‚å¯Ÿå¼€æºé¡¹ç›®&quot;</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="åˆ†æå¼€æºé¡¹ç›®-EL-ADMIN"><a href="#åˆ†æå¼€æºé¡¹ç›®-EL-ADMIN" class="headerlink" title="åˆ†æå¼€æºé¡¹ç›® (EL-ADMIN)"></a>åˆ†æå¼€æºé¡¹ç›® (EL-ADMIN)</h1><h2 id="1-è§‚å¯Ÿå¼€æºé¡¹ç›®"><a href="#1-è§‚å¯Ÿå¼€æºé¡¹ç›®" class="headerlink" title="1 è§‚å¯Ÿå¼€æºé¡¹ç›®"></a>1 è§‚å¯Ÿå¼€æºé¡¹ç›®</h2><ul><li>åç«¯</li></ul><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210509215359473.png" alt="image-20210509215359473"></p><ul><li>å‰ç«¯</li></ul><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210509215706676.png" alt="image-20210509215706676"></p><h2 id="2-å¼€æºé¡¹ç›®ä¸‹è½½"><a href="#2-å¼€æºé¡¹ç›®ä¸‹è½½" class="headerlink" title="2 å¼€æºé¡¹ç›®ä¸‹è½½"></a>2 å¼€æºé¡¹ç›®ä¸‹è½½</h2><p>ä¸‹è½½å®Œæ¯• ==&gt; è§£å‹ ==&gt; ä¸è¦ç€æ€¥è¿è¡Œ</p><p><strong>è§‚å¯Ÿ</strong></p><ul><li>ç”¨äº†é‚£äº›æŠ€æœ¯ (Spring Boot 2.1.0 ã€ Spring Boot Jpaã€ JWTã€Spring Securityã€Redisã€Vueã€Element-UI)</li><li>æ˜¯å¦æœ‰æ•°æ®åº“ (MySQL)</li><li>ä½ çš„ç¯å¢ƒæ˜¯å¦åŒ¹é… (javaï¼Œ mavenï¼Œnpmï¼Œnodejsï¼Œredis)</li></ul><p>é€šè¿‡äº†ï¼Œç„¶åæƒ³åŠæ³•è¿è¡Œ</p><h2 id="3-è·‘èµ·æ¥æ˜¯ç¬¬ä¸€æ­¥"><a href="#3-è·‘èµ·æ¥æ˜¯ç¬¬ä¸€æ­¥" class="headerlink" title="3 è·‘èµ·æ¥æ˜¯ç¬¬ä¸€æ­¥"></a>3 è·‘èµ·æ¥æ˜¯ç¬¬ä¸€æ­¥</h2><ol><li><p>å®‰è£…æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLï¼ˆæ³¨æ„ï¼šæœ‰æ²¡æœ‰å»ºåº“è¯­å¥ï¼‰</p></li><li><p>å‰ç«¯éœ€è¦è·‘èµ·æ¥(npm ç‰ˆæœ¬æœ€å¥½ 6.x.xx)</p></li><li><p>åç«¯é¡¹ç›®å¯¼å…¥</p></li><li><p>å¯åŠ¨åç«¯é¡¹ç›®</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210509231414116.png" alt="image-20210509231414116"></p><p>åªè¦å‘ç°äº† Swagger, é‚£ä¹ˆè·‘èµ·æ¥çš„ç¬¬ä¸€æ­¥å°±æ˜¯å…ˆè¿›å…¥ Swagger-ui ç•Œé¢! å› ä¸ºè¿™é‡Œé¢éƒ½æ˜¯æ¥å£! </p><p>è¿›è€ŒæŸ¥çœ‹é…ç½®æ–‡ä»¶! é»˜è®¤ç«¯å£â€¦.</p><p>å‰ç«¯å°±æ˜¯å®‰è£…ä¾èµ–, å¯åŠ¨æµ‹è¯•, çœ‹æ¥å£æ˜¯å¦æ­£å¸¸</p></li></ol><h2 id="4-å‰åç«¯åˆ†ç¦»é¡¹ç›®çš„å›ºå®šå¥—è·¯"><a href="#4-å‰åç«¯åˆ†ç¦»é¡¹ç›®çš„å›ºå®šå¥—è·¯" class="headerlink" title="4 å‰åç«¯åˆ†ç¦»é¡¹ç›®çš„å›ºå®šå¥—è·¯"></a>4 å‰åç«¯åˆ†ç¦»é¡¹ç›®çš„å›ºå®šå¥—è·¯</h2><ol><li><p>ä»å‰ç«¯å¼€å§‹åˆ†æã€‚æ‰“å¼€æ§åˆ¶å°ï¼Œç‚¹ä¸€ä¸ªæ¥å£ï¼Œåˆ†æä¸€æ³¢è°ƒç”¨å…³ç³»ï¼</p></li><li><p>å‰åç«¯ç«¯å£è°ƒç”¨ä¸ä¸€è‡´ 8013 - - 8000ï¼Œæ€ä¹ˆæ“ä½œçš„</p><ul><li><p>å°è£…äº†æ¥å£è¯·æ±‚    ajax    axios    request</p></li><li><p>æ‰¾åˆ°é…ç½®</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510005019305.png" alt="image-20210510005019305"></p></li><li><p>å‰åç«¯ åˆ†ç¦»é¡¹ç›®ï¼šæ‰¾åˆ°æ¥å£çš„è°ƒç”¨å…³ç³»</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510005313002.png" alt="image-20210510005313002"></p></li><li><p>SpringBootæä¾›æœåŠ¡ï¼å‰ç«¯è°ƒç”¨æ¥å£è·å–æ•°æ®ï¼Vueè´Ÿè´£æ¸²æŸ“é¡µé¢ï¼</p></li><li><p>å‰ç«¯é¡¹ç›®å›ºå®šå¥—è·¯</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510005527489.png" alt="image-20210510005527489"></p></li><li><p>é€šè¿‡æŠ“å–å‰ç«¯çš„è¯·æ±‚ï¼Œæ‰¾åˆ°åç«¯å¯¹åº”çš„æ¥å£</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510014254626.png" alt="image-20210510014254626"></p></li><li><p>åç«¯åˆ†æ</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510014559981.png" alt="image-20210510014559981"></p></li><li><p>Controller â€” Service â€” Dao/Mapper</p></li><li><p>ç°åœ¨ä»å‰åˆ°åå°±å¯ä»¥åˆ†æäº†ï¼ä½†æ˜¯å¦‚ä½•æ¸²æŸ“åˆ°è§†å›¾ä¸Šï¼Ÿçœ‹å‰ç«¯</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510014916833.png" alt="image-20210510014916833"></p></li><li><p>Vue æ ‡å‡†å¥—è·¯</p><p><img src="/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/image-20210510015129858.png" alt="image-20210510015129858"></p></li></ul></li></ol><h2 id="5-å¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªå¥½çš„å¼€æºé¡¹ç›®"><a href="#5-å¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªå¥½çš„å¼€æºé¡¹ç›®" class="headerlink" title="5 å¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªå¥½çš„å¼€æºé¡¹ç›®"></a>5 å¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªå¥½çš„å¼€æºé¡¹ç›®</h2><ol><li>æŒ‰åˆ†ç±»</li><li>çœ‹æ”¶è—</li><li>çœ‹å…·æœ‰ä»·å€¼</li></ol>]]></content:encoded>
      
      
      <category domain="https://pncalbl.github.io/categories/Help/">Help</category>
      
      <category domain="https://pncalbl.github.io/categories/Help/Win/">Win</category>
      
      
      <category domain="https://pncalbl.github.io/tags/%E5%BC%80%E6%BA%90/">å¼€æº</category>
      
      
      <comments>https://pncalbl.github.io/2021/05/09/%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
